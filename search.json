[{"title":"16.JUCé›†åˆ: ConcurrentLinkedQueueè¯¦è§£","path":"/2023/12/26/16-JUCé›†åˆ-ConcurrentLinkedQueueè¯¦è§£/","content":"ConcurerntLinkedQueueä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§ FIFO(å…ˆè¿›å…ˆå‡º)åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚é˜Ÿåˆ—çš„å¤´éƒ¨æ˜¯é˜Ÿåˆ—ä¸­æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚é˜Ÿåˆ—çš„å°¾éƒ¨ æ˜¯é˜Ÿåˆ—ä¸­æ—¶é—´æœ€çŸ­çš„å…ƒç´ ã€‚æ–°çš„å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œé˜Ÿåˆ—è·å–æ“ä½œä»é˜Ÿåˆ—å¤´éƒ¨è·å¾—å…ƒç´ ã€‚å½“å¤šä¸ªçº¿ç¨‹å…±äº«è®¿é—®ä¸€ä¸ªå…¬å…± collection æ—¶ï¼ŒConcurrentLinkedQueueæ˜¯ä¸€ä¸ªæ°å½“çš„é€‰æ‹©ã€‚æ­¤é˜Ÿåˆ—ä¸å…è®¸ä½¿ç”¨nullå…ƒç´ ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ è¦æƒ³ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—æœ‰å“ªäº›é€‰æ‹©? Vectorï¼ŒCollections.synchronizedList(List&lt;T&gt; list), ConcurrentLinkedQueueç­‰ ConcurrentLinkedQueueå®ç°çš„æ•°æ®ç»“æ„? ConcurrentLinkedQueueåº•å±‚åŸç†? å…¨ç¨‹æ— é”(CAS) ConcurrentLinkedQueueçš„æ ¸å¿ƒæ–¹æ³•æœ‰å“ªäº›? offer()ï¼Œpoll()ï¼Œpeek()ï¼ŒisEmpty()ç­‰é˜Ÿåˆ—å¸¸ç”¨æ–¹æ³• è¯´è¯´ConcurrentLinkedQueueçš„HOPS(å»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥)çš„è®¾è®¡? ConcurrentLinkedQueueé€‚åˆä»€ä¹ˆæ ·çš„ä½¿ç”¨åœºæ™¯? ConcurrentLinkedQueueæ•°æ®ç»“æ„é€šè¿‡æºç åˆ†æå¯çŸ¥ï¼ŒConcurrentLinkedQueueçš„æ•°æ®ç»“æ„ä¸LinkedBlockingQueueçš„æ•°æ®ç»“æ„ç›¸åŒï¼Œéƒ½æ˜¯ä½¿ç”¨çš„é“¾è¡¨ç»“æ„ã€‚ConcurrentLinkedQueueçš„æ•°æ®ç»“æ„å¦‚ä¸‹: è¯´æ˜: ConcurrentLinkedQueueé‡‡ç”¨çš„é“¾è¡¨ç»“æ„ï¼Œå¹¶ä¸”åŒ…å«æœ‰ä¸€ä¸ªå¤´èŠ‚ç‚¹å’Œä¸€ä¸ªå°¾ç»“ç‚¹ã€‚ ConcurrentLinkedQueueæºç åˆ†æç±»çš„ç»§æ‰¿å…³ç³»12public class ConcurrentLinkedQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements Queue&lt;E&gt;, java.io.Serializable &#123;&#125; è¯´æ˜: ConcurrentLinkedQueueç»§æ‰¿äº†æŠ½è±¡ç±»AbstractQueueï¼ŒAbstractQueueå®šä¹‰äº†å¯¹é˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œï¼›åŒæ—¶å®ç°äº†Queueæ¥å£ï¼ŒQueueå®šä¹‰äº†å¯¹é˜Ÿåˆ—çš„åŸºæœ¬æ“ä½œï¼ŒåŒæ—¶ï¼Œè¿˜å®ç°äº†Serializableæ¥å£ï¼Œè¡¨ç¤ºå¯ä»¥è¢«åºåˆ—åŒ–ã€‚ ç±»çš„å†…éƒ¨ç±»1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950private static class Node&lt;E&gt; &#123; // å…ƒç´  volatile E item; // nextåŸŸ volatile Node&lt;E&gt; next; /** * Constructs a new node. Uses relaxed write because item can * only be seen after publication via casNext. */ // æ„é€ å‡½æ•° Node(E item) &#123; // è®¾ç½®itemçš„å€¼ UNSAFE.putObject(this, itemOffset, item); &#125; // æ¯”è¾ƒå¹¶æ›¿æ¢itemå€¼ boolean casItem(E cmp, E val) &#123; return UNSAFE.compareAndSwapObject(this, itemOffset, cmp, val); &#125; void lazySetNext(Node&lt;E&gt; val) &#123; // è®¾ç½®nextåŸŸçš„å€¼ï¼Œå¹¶ä¸ä¼šä¿è¯ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§ UNSAFE.putOrderedObject(this, nextOffset, val); &#125; // æ¯”è¾ƒå¹¶æ›¿æ¢nextåŸŸçš„å€¼ boolean casNext(Node&lt;E&gt; cmp, Node&lt;E&gt; val) &#123; return UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val); &#125; // Unsafe mechanics // åå°„æœºåˆ¶ private static final sun.misc.Unsafe UNSAFE; // itemåŸŸçš„åç§»é‡ private static final long itemOffset; // nextåŸŸçš„åç§»é‡ private static final long nextOffset; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = Node.class; itemOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(&quot;item&quot;)); nextOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(&quot;next&quot;)); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125;&#125; è¯´æ˜: Nodeç±»è¡¨ç¤ºé“¾è¡¨ç»“ç‚¹ï¼Œç”¨äºå­˜æ”¾å…ƒç´ ï¼ŒåŒ…å«itemåŸŸå’ŒnextåŸŸï¼ŒitemåŸŸè¡¨ç¤ºå…ƒç´ ï¼ŒnextåŸŸè¡¨ç¤ºä¸‹ä¸€ä¸ªç»“ç‚¹ï¼Œå…¶åˆ©ç”¨åå°„æœºåˆ¶å’ŒCASæœºåˆ¶æ¥æ›´æ–°itemåŸŸå’ŒnextåŸŸï¼Œä¿è¯åŸå­æ€§ã€‚ ç±»çš„å±æ€§12345678910111213141516171819202122232425262728public class ConcurrentLinkedQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements Queue&lt;E&gt;, java.io.Serializable &#123; // ç‰ˆæœ¬åºåˆ—å· private static final long serialVersionUID = 196745693267521676L; // åå°„æœºåˆ¶ private static final sun.misc.Unsafe UNSAFE; // headåŸŸçš„åç§»é‡ private static final long headOffset; // tailåŸŸçš„åç§»é‡ private static final long tailOffset; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = ConcurrentLinkedQueue.class; headOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(&quot;head&quot;)); tailOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(&quot;tail&quot;)); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125; // å¤´èŠ‚ç‚¹ private transient volatile Node&lt;E&gt; head; // å°¾ç»“ç‚¹ private transient volatile Node&lt;E&gt; tail;&#125; è¯´æ˜: å±æ€§ä¸­åŒ…å«äº†headåŸŸå’ŒtailåŸŸï¼Œè¡¨ç¤ºé“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾ç»“ç‚¹ï¼ŒåŒæ—¶ï¼ŒConcurrentLinkedQueueä¹Ÿä½¿ç”¨äº†åå°„æœºåˆ¶å’ŒCASæœºåˆ¶æ¥æ›´æ–°å¤´èŠ‚ç‚¹å’Œå°¾ç»“ç‚¹ï¼Œä¿è¯åŸå­æ€§ã€‚ ç±»çš„æ„é€ å‡½æ•° ConcurrentLinkedQueue()å‹æ„é€ å‡½æ•° 1234public ConcurrentLinkedQueue() &#123; // åˆå§‹åŒ–å¤´èŠ‚ç‚¹ä¸å°¾ç»“ç‚¹ head = tail = new Node&lt;E&gt;(null);&#125; è¯´æ˜: è¯¥æ„é€ å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæœ€åˆä¸ºç©ºçš„ ConcurrentLinkedQueueï¼Œå¤´èŠ‚ç‚¹ä¸å°¾ç»“ç‚¹æŒ‡å‘åŒä¸€ä¸ªç»“ç‚¹ï¼Œè¯¥ç»“ç‚¹çš„itemåŸŸä¸ºnullï¼ŒnextåŸŸä¹Ÿä¸ºnullã€‚ ConcurrentLinkedQueue(Collection&lt;? extends E&gt;)å‹æ„é€ å‡½æ•° 12345678910111213141516171819202122232425public ConcurrentLinkedQueue(Collection&lt;? extends E&gt; c) &#123; Node&lt;E&gt; h = null, t = null; for (E e : c) &#123; // éå†cé›†åˆ // ä¿è¯å…ƒç´ ä¸ä¸ºç©º checkNotNull(e); // æ–°ç”Ÿä¸€ä¸ªç»“ç‚¹ Node&lt;E&gt; newNode = new Node&lt;E&gt;(e); if (h == null) // å¤´èŠ‚ç‚¹ä¸ºnull // èµ‹å€¼å¤´èŠ‚ç‚¹ä¸å°¾ç»“ç‚¹ h = t = newNode; else &#123; // ç›´æ¥å¤´èŠ‚ç‚¹çš„nextåŸŸ t.lazySetNext(newNode); // é‡æ–°èµ‹å€¼å¤´èŠ‚ç‚¹ t = newNode; &#125; &#125; if (h == null) // å¤´èŠ‚ç‚¹ä¸ºnull // æ–°ç”Ÿå¤´èŠ‚ç‚¹ä¸å°¾ç»“ç‚¹ h = t = new Node&lt;E&gt;(null); // èµ‹å€¼å¤´èŠ‚ç‚¹ head = h; // èµ‹å€¼å°¾ç»“ç‚¹ tail = t;&#125; è¯´æ˜: è¯¥æ„é€ å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæœ€åˆåŒ…å«ç»™å®š collection å…ƒç´ çš„ ConcurrentLinkedQueueï¼ŒæŒ‰ç…§æ­¤ collection è¿­ä»£å™¨çš„éå†é¡ºåºæ¥æ·»åŠ å…ƒç´ ã€‚ æ ¸å¿ƒå‡½æ•°åˆ†æofferå‡½æ•°123456789101112131415161718192021222324252627282930313233343536public boolean offer(E e) &#123; // å…ƒç´ ä¸ä¸ºnull checkNotNull(e); // æ–°ç”Ÿä¸€ä¸ªç»“ç‚¹ final Node&lt;E&gt; newNode = new Node&lt;E&gt;(e); for (Node&lt;E&gt; t = tail, p = t;;) &#123; // æ— é™å¾ªç¯ // qä¸ºpç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ Node&lt;E&gt; q = p.next; if (q == null) &#123; // qç»“ç‚¹ä¸ºnull // p is last node if (p.casNext(null, newNode)) &#123; // æ¯”è¾ƒå¹¶è¿›è¡Œæ›¿æ¢pç»“ç‚¹çš„nextåŸŸ // Successful CAS is the linearization point // for e to become an element of this queue, // and for newNode to become &quot;live&quot;. if (p != t) // pä¸ç­‰äºtç»“ç‚¹ï¼Œä¸ä¸€è‡´ // hop two nodes at a time // æ¯”è¾ƒå¹¶æ›¿æ¢å°¾ç»“ç‚¹ casTail(t, newNode); // Failure is OK. // è¿”å› return true; &#125; // Lost CAS race to another thread; re-read next &#125; else if (p == q) // pç»“ç‚¹ç­‰äºqç»“ç‚¹ // We have fallen off list. If tail is unchanged, it // will also be off-list, in which case we need to // jump to head, from which all live nodes are always // reachable. Else the new tail is a better bet. // åŸæ¥çš„å°¾ç»“ç‚¹ä¸ç°åœ¨çš„å°¾ç»“ç‚¹æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™pèµ‹å€¼ä¸ºheadï¼Œå¦åˆ™ï¼Œèµ‹å€¼ä¸ºç°åœ¨çš„å°¾ç»“ç‚¹ p = (t != (t = tail)) ? t : head; else // Check for tail updates after two hops. // é‡æ–°èµ‹å€¼pç»“ç‚¹ p = (p != t &amp;&amp; t != (t = tail)) ? t : q; &#125;&#125; è¯´æ˜: offerå‡½æ•°ç”¨äºå°†æŒ‡å®šå…ƒç´ æ’å…¥æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ä¸‹é¢æ¨¡æ‹Ÿofferå‡½æ•°çš„æ“ä½œï¼Œé˜Ÿåˆ—çŠ¶æ€çš„å˜åŒ–(å‡è®¾å•çº¿ç¨‹æ·»åŠ å…ƒç´ ï¼Œè¿ç»­æ·»åŠ 10ã€20ä¸¤ä¸ªå…ƒç´ )ã€‚ è‹¥ConcurrentLinkedQueueçš„åˆå§‹çŠ¶æ€å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå³é˜Ÿåˆ—ä¸ºç©ºã€‚å•çº¿ç¨‹æ·»åŠ å…ƒç´ ï¼Œæ­¤æ—¶ï¼Œæ·»åŠ å…ƒç´ 10ï¼Œåˆ™çŠ¶æ€å¦‚ä¸‹æ‰€ç¤º å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ·»åŠ å…ƒç´ 10åï¼Œtailæ²¡æœ‰å˜åŒ–ï¼Œè¿˜æ˜¯æŒ‡å‘ä¹‹å‰çš„ç»“ç‚¹ï¼Œç»§ç»­æ·»åŠ å…ƒç´ 20ï¼Œåˆ™çŠ¶æ€å¦‚ä¸‹æ‰€ç¤º å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ·»åŠ å…ƒç´ 20åï¼ŒtailæŒ‡å‘äº†æœ€æ–°æ·»åŠ çš„ç»“ç‚¹ã€‚ pollå‡½æ•°123456789101112131415161718192021222324252627282930public E poll() &#123; restartFromHead: for (;;) &#123; // æ— é™å¾ªç¯ for (Node&lt;E&gt; h = head, p = h, q;;) &#123; // ä¿å­˜å¤´èŠ‚ç‚¹ // itemé¡¹ E item = p.item; if (item != null &amp;&amp; p.casItem(item, null)) &#123; // itemä¸ä¸ºnullå¹¶ä¸”æ¯”è¾ƒå¹¶æ›¿æ¢itemæˆåŠŸ // Successful CAS is the linearization point // for item to be removed from this queue. if (p != h) // pä¸ç­‰äºh // hop two nodes at a time // æ›´æ–°å¤´èŠ‚ç‚¹ updateHead(h, ((q = p.next) != null) ? q : p); // è¿”å›item return item; &#125; else if ((q = p.next) == null) &#123; // qç»“ç‚¹ä¸ºnull // æ›´æ–°å¤´èŠ‚ç‚¹ updateHead(h, p); return null; &#125; else if (p == q) // pç­‰äºq // ç»§ç»­å¾ªç¯ continue restartFromHead; else // pèµ‹å€¼ä¸ºq p = q; &#125; &#125;&#125; è¯´æ˜: æ­¤å‡½æ•°ç”¨äºè·å–å¹¶ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›nullã€‚ä¸‹é¢æ¨¡æ‹Ÿpollå‡½æ•°çš„æ“ä½œï¼Œé˜Ÿåˆ—çŠ¶æ€çš„å˜åŒ–(å‡è®¾å•çº¿ç¨‹æ“ä½œï¼ŒçŠ¶æ€ä¸ºä¹‹å‰offer10ã€20åçš„çŠ¶æ€ï¼Œpollä¸¤æ¬¡)ã€‚ é˜Ÿåˆ—åˆå§‹çŠ¶æ€å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨pollæ“ä½œåï¼Œé˜Ÿåˆ—çš„çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤º å¦‚ä¸Šå›¾å¯çŸ¥ï¼Œpollæ“ä½œåï¼Œheadæ”¹å˜äº†ï¼Œå¹¶ä¸”headæ‰€æŒ‡å‘çš„ç»“ç‚¹çš„itemå˜ä¸ºäº†nullã€‚å†è¿›è¡Œä¸€æ¬¡pollæ“ä½œï¼Œé˜Ÿåˆ—çš„çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å¦‚ä¸Šå›¾å¯çŸ¥ï¼Œpollæ“ä½œåï¼Œheadç»“ç‚¹æ²¡æœ‰å˜åŒ–ï¼Œåªæ˜¯æŒ‡ç¤ºçš„ç»“ç‚¹çš„itemåŸŸå˜æˆäº†nullã€‚ removeå‡½æ•°12345678910111213141516171819202122public boolean remove(Object o) &#123; // å…ƒç´ ä¸ºnullï¼Œè¿”å› if (o == null) return false; Node&lt;E&gt; pred = null; for (Node&lt;E&gt; p = first(); p != null; p = succ(p)) &#123; // è·å–ç¬¬ä¸€ä¸ªå­˜æ´»çš„ç»“ç‚¹ // ç¬¬ä¸€ä¸ªå­˜æ´»ç»“ç‚¹çš„itemå€¼ E item = p.item; if (item != null &amp;&amp; o.equals(item) &amp;&amp; p.casItem(item, null)) &#123; // æ‰¾åˆ°itemç›¸ç­‰çš„ç»“ç‚¹ï¼Œå¹¶ä¸”å°†è¯¥ç»“ç‚¹çš„itemè®¾ç½®ä¸ºnull // pçš„åç»§ç»“ç‚¹ Node&lt;E&gt; next = succ(p); if (pred != null &amp;&amp; next != null) // predä¸ä¸ºnullå¹¶ä¸”nextä¸ä¸ºnull // æ¯”è¾ƒå¹¶æ›¿æ¢nextåŸŸ pred.casNext(p, next); return true; &#125; // predèµ‹å€¼ä¸ºp pred = p; &#125; return false;&#125; è¯´æ˜: æ­¤å‡½æ•°ç”¨äºä»é˜Ÿåˆ—ä¸­ç§»é™¤æŒ‡å®šå…ƒç´ çš„å•ä¸ªå®ä¾‹(å¦‚æœå­˜åœ¨)ã€‚å…¶ä¸­ï¼Œä¼šè°ƒç”¨åˆ°firstå‡½æ•°å’Œsuccå‡½æ•°ï¼Œfirstå‡½æ•°çš„æºç å¦‚ä¸‹ 123456789101112131415161718192021Node&lt;E&gt; first() &#123; restartFromHead: for (;;) &#123; // æ— é™å¾ªç¯ï¼Œç¡®ä¿æˆåŠŸ for (Node&lt;E&gt; h = head, p = h, q;;) &#123; // pç»“ç‚¹çš„itemåŸŸæ˜¯å¦ä¸ºnull boolean hasItem = (p.item != null); if (hasItem || (q = p.next) == null) &#123; // itemä¸ä¸ºnullæˆ–è€…nextåŸŸä¸ºnull // æ›´æ–°å¤´èŠ‚ç‚¹ updateHead(h, p); // è¿”å›ç»“ç‚¹ return hasItem ? p : null; &#125; else if (p == q) // pç­‰äºq // ç»§ç»­ä»å¤´èŠ‚ç‚¹å¼€å§‹ continue restartFromHead; else // pèµ‹å€¼ä¸ºq p = q; &#125; &#125;&#125; è¯´æ˜: firstå‡½æ•°ç”¨äºæ‰¾åˆ°é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªå­˜æ´»çš„ç»“ç‚¹ã€‚succå‡½æ•°æºç å¦‚ä¸‹ 123456final Node&lt;E&gt; succ(Node&lt;E&gt; p) &#123; // pç»“ç‚¹çš„nextåŸŸ Node&lt;E&gt; next = p.next; // å¦‚æœnextåŸŸä¸ºè‡ªèº«ï¼Œåˆ™è¿”å›å¤´èŠ‚ç‚¹ï¼Œå¦åˆ™ï¼Œè¿”å›next return (p == next) ? head : next;&#125; è¯´æ˜: succç”¨äºè·å–ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ã€‚å¦‚æœç»“ç‚¹çš„nextåŸŸæŒ‡å‘è‡ªèº«ï¼Œåˆ™è¿”å›headå¤´èŠ‚ç‚¹ï¼Œå¦åˆ™ï¼Œè¿”å›nextç»“ç‚¹ã€‚ä¸‹é¢æ¨¡æ‹Ÿremoveå‡½æ•°çš„æ“ä½œï¼Œé˜Ÿåˆ—çŠ¶æ€çš„å˜åŒ–(å‡è®¾å•çº¿ç¨‹æ“ä½œï¼ŒçŠ¶æ€ä¸ºä¹‹å‰offer10ã€20åçš„çŠ¶æ€ï¼Œæ‰§è¡Œremove(10)ã€remove(20)æ“ä½œ)ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸ºConcurrentLinkedQueueçš„åˆå§‹çŠ¶æ€ï¼Œremove(10)åçš„çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤º å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“æ‰§è¡Œremove(10)åï¼ŒheadæŒ‡å‘äº†headç»“ç‚¹ä¹‹å‰æŒ‡å‘çš„ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ï¼Œå¹¶ä¸”headç»“ç‚¹çš„itemåŸŸç½®ä¸ºnullã€‚ç»§ç»­æ‰§è¡Œremove(20)ï¼ŒçŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤º å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ‰§è¡Œremove(20)åï¼Œheadä¸tailæŒ‡å‘åŒä¸€ä¸ªç»“ç‚¹ï¼ŒitemåŸŸä¸ºnullã€‚ sizeå‡½æ•°1234567891011public int size() &#123; // è®¡æ•° int count = 0; for (Node&lt;E&gt; p = first(); p != null; p = succ(p)) // ä»ç¬¬ä¸€ä¸ªå­˜æ´»çš„ç»“ç‚¹å¼€å§‹å¾€åéå† if (p.item != null) // ç»“ç‚¹çš„itemåŸŸä¸ä¸ºnull // Collection.size() spec says to max out if (++count == Integer.MAX_VALUE) // å¢åŠ è®¡æ•°ï¼Œè‹¥è¾¾åˆ°æœ€å¤§å€¼ï¼Œåˆ™è·³å‡ºå¾ªç¯ break; // è¿”å›å¤§å° return count;&#125; è¯´æ˜: æ­¤å‡½æ•°ç”¨äºè¿”å›ConcurrenLinkedQueueçš„å¤§å°ï¼Œä»ç¬¬ä¸€ä¸ªå­˜æ´»çš„ç»“ç‚¹(first)å¼€å§‹ï¼Œå¾€åéå†é“¾è¡¨ï¼Œå½“ç»“ç‚¹çš„itemåŸŸä¸ä¸ºnullæ—¶ï¼Œå¢åŠ è®¡æ•°ï¼Œä¹‹åè¿”å›å¤§å°ã€‚ ConcurrentLinkedQueueç¤ºä¾‹ä¸‹é¢é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥äº†è§£ConcurrentLinkedQueueçš„ä½¿ç”¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950import java.util.concurrent.ConcurrentLinkedQueue;class PutThread extends Thread &#123; private ConcurrentLinkedQueue&lt;Integer&gt; clq; public PutThread(ConcurrentLinkedQueue&lt;Integer&gt; clq) &#123; this.clq = clq; &#125; public void run() &#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; System.out.println(&quot;add &quot; + i); clq.add(i); Thread.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125;class GetThread extends Thread &#123; private ConcurrentLinkedQueue&lt;Integer&gt; clq; public GetThread(ConcurrentLinkedQueue&lt;Integer&gt; clq) &#123; this.clq = clq; &#125; public void run() &#123; for (int i = 0; i &lt; 10; i++) &#123; try &#123; System.out.println(&quot;poll &quot; + clq.poll()); Thread.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125;public class ConcurrentLinkedQueueDemo &#123; public static void main(String[] args) &#123; ConcurrentLinkedQueue&lt;Integer&gt; clq = new ConcurrentLinkedQueue&lt;Integer&gt;(); PutThread p1 = new PutThread(clq); GetThread g1 = new GetThread(clq); p1.start(); g1.start(); &#125;&#125; è¿è¡Œç»“æœ(æŸä¸€æ¬¡): 1234567891011121314151617181920add 0poll nulladd 1poll 0add 2poll 1add 3poll 2add 4poll 3add 5poll 4poll 5add 6add 7poll 6poll 7add 8add 9poll 8 è¯´æ˜: GetThreadçº¿ç¨‹ä¸ä¼šå› ä¸ºConcurrentLinkedQueueé˜Ÿåˆ—ä¸ºç©ºè€Œç­‰å¾…ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›nullï¼Œæ‰€ä»¥å½“å®ç°é˜Ÿåˆ—ä¸ç©ºæ—¶ï¼Œç­‰å¾…æ—¶ï¼Œåˆ™éœ€è¦ç”¨æˆ·è‡ªå·±å®ç°ç­‰å¾…é€»è¾‘ã€‚ å†æ·±å…¥ç†è§£HOPS(å»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥)çš„è®¾è®¡é€šè¿‡ä¸Šé¢å¯¹offerå’Œpollæ–¹æ³•çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°tailå’Œheadæ˜¯å»¶è¿Ÿæ›´æ–°çš„ï¼Œä¸¤è€…æ›´æ–°è§¦å‘æ—¶æœºä¸ºï¼š tailæ›´æ–°è§¦å‘æ—¶æœºï¼šå½“tailæŒ‡å‘çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºnullçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£çš„é˜Ÿå°¾èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°é˜Ÿå°¾èŠ‚ç‚¹åå®Œæˆæ’å…¥ä¹‹åæ‰ä¼šé€šè¿‡casTailè¿›è¡Œtailæ›´æ–°ï¼›å½“tailæŒ‡å‘çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnullçš„æ—¶å€™ï¼Œåªæ’å…¥èŠ‚ç‚¹ä¸æ›´æ–°tailã€‚ headæ›´æ–°è§¦å‘æ—¶æœºï¼šå½“headæŒ‡å‘çš„èŠ‚ç‚¹çš„itemåŸŸä¸ºnullçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£çš„é˜Ÿå¤´èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°é˜Ÿå¤´èŠ‚ç‚¹åå®Œæˆåˆ é™¤ä¹‹åæ‰ä¼šé€šè¿‡updateHeadè¿›è¡Œheadæ›´æ–°ï¼›å½“headæŒ‡å‘çš„èŠ‚ç‚¹çš„itemåŸŸä¸ä¸ºnullçš„æ—¶å€™ï¼Œåªåˆ é™¤èŠ‚ç‚¹ä¸æ›´æ–°headã€‚ å¹¶ä¸”åœ¨æ›´æ–°æ“ä½œæ—¶ï¼Œæºç ä¸­ä¼šæœ‰æ³¨é‡Šä¸ºï¼šhop two nodes at a timeã€‚æ‰€ä»¥è¿™ç§å»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥å°±è¢«å«åšHOPSçš„å¤§æ¦‚åŸå› æ˜¯è¿™ä¸ª(çŒœçš„ ğŸ˜ƒ)ï¼Œä»ä¸Šé¢æ›´æ–°æ—¶çš„çŠ¶æ€å›¾å¯ä»¥çœ‹å‡ºï¼Œheadå’Œtailçš„æ›´æ–°æ˜¯â€œè·³ç€çš„â€å³ä¸­é—´æ€»æ˜¯é—´éš”äº†ä¸€ä¸ªã€‚é‚£ä¹ˆè¿™æ ·è®¾è®¡çš„æ„å›¾æ˜¯ä»€ä¹ˆå‘¢? å¦‚æœè®©tailæ°¸è¿œä½œä¸ºé˜Ÿåˆ—çš„é˜Ÿå°¾èŠ‚ç‚¹ï¼Œå®ç°çš„ä»£ç é‡ä¼šæ›´å°‘ï¼Œè€Œä¸”é€»è¾‘æ›´æ˜“æ‡‚ã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå¦‚æœå¤§é‡çš„å…¥é˜Ÿæ“ä½œï¼Œæ¯æ¬¡éƒ½è¦æ‰§è¡ŒCASè¿›è¡Œtailçš„æ›´æ–°ï¼Œæ±‡æ€»èµ·æ¥å¯¹æ€§èƒ½ä¹Ÿä¼šæ˜¯å¤§å¤§çš„æŸè€—ã€‚å¦‚æœèƒ½å‡å°‘CASæ›´æ–°çš„æ“ä½œï¼Œæ— ç–‘å¯ä»¥å¤§å¤§æå‡å…¥é˜Ÿçš„æ“ä½œæ•ˆç‡ï¼Œæ‰€ä»¥doug leaå¤§å¸ˆæ¯é—´éš”1æ¬¡(tailå’Œé˜Ÿå°¾èŠ‚ç‚¹çš„è·ç¦»ä¸º1)è¿›è¡Œæ‰åˆ©ç”¨CASæ›´æ–°tailã€‚å¯¹headçš„æ›´æ–°ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œè™½ç„¶ï¼Œè¿™æ ·è®¾è®¡ä¼šå¤šå‡ºåœ¨å¾ªç¯ä¸­å®šä½é˜Ÿå°¾èŠ‚ç‚¹ï¼Œä½†æ€»ä½“æ¥è¯´è¯»çš„æ“ä½œæ•ˆç‡è¦è¿œè¿œé«˜äºå†™çš„æ€§èƒ½ï¼Œå› æ­¤ï¼Œå¤šå‡ºæ¥çš„åœ¨å¾ªç¯ä¸­å®šä½å°¾èŠ‚ç‚¹çš„æ“ä½œçš„æ€§èƒ½æŸè€—ç›¸å¯¹è€Œè¨€æ˜¯å¾ˆå°çš„ã€‚ ConcurrentLinkedQueueé€‚åˆçš„åœºæ™¯ConcurrentLinkedQueueé€šè¿‡æ— é”æ¥åšåˆ°äº†æ›´é«˜çš„å¹¶å‘é‡ï¼Œæ˜¯ä¸ªé«˜æ€§èƒ½çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯ä½¿ç”¨åœºæ™¯ç›¸å¯¹ä¸å¦‚é˜»å¡é˜Ÿåˆ—å¸¸è§ï¼Œæ¯•ç«Ÿå–æ•°æ®ä¹Ÿè¦ä¸åœçš„å»å¾ªç¯ï¼Œä¸å¦‚é˜»å¡çš„é€»è¾‘å¥½è®¾è®¡ï¼Œä½†æ˜¯åœ¨å¹¶å‘é‡ç‰¹åˆ«å¤§çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ€§èƒ½ä¸Šå¥½å¾ˆå¤šï¼Œè€Œä¸”è¿™ä¸ªé˜Ÿåˆ—çš„è®¾è®¡ä¹Ÿæ˜¯ç‰¹åˆ«è´¹åŠ›ï¼Œå°¤å…¶çš„ä½¿ç”¨çš„æ”¹è‰¯ç®—æ³•å’Œå¯¹å“¨å…µçš„å¤„ç†ã€‚æ•´ä½“çš„æ€è·¯éƒ½æ˜¯æ¯”è¾ƒä¸¥è°¨çš„ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä½¿ç”¨äº†æ— é”é€ æˆçš„ï¼Œæˆ‘ä»¬è‡ªå·±ä½¿ç”¨æ— é”çš„æ¡ä»¶çš„è¯ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸ªä¸é”™çš„å‚è€ƒã€‚ å‚è€ƒæ–‡ç«  æ–‡ç« ä¸»è¦å‚è€ƒè‡ªleesfçš„https://www.cnblogs.com/leesf456/p/5539142.htmlï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšäº†å¢æ”¹ã€‚ https://blog.csdn.net/u011521203/article/details/80214968 https://blog.csdn.net/u014493323/article/details/81177194","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"15.JUCé›†åˆ: CopyOnWriteArrayListè¯¦è§£","path":"/2023/12/26/15-JUCé›†åˆ-CopyOnWriteArrayListè¯¦è§£/","content":"CopyOnWriteArrayListæ˜¯ArrayList çš„ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å˜ä½“ï¼Œå…¶ä¸­æ‰€æœ‰å¯å˜æ“ä½œ(addã€set ç­‰ç­‰)éƒ½æ˜¯é€šè¿‡å¯¹åº•å±‚æ•°ç»„è¿›è¡Œä¸€æ¬¡æ–°çš„æ‹·è´æ¥å®ç°çš„ã€‚COWæ¨¡å¼çš„ä½“ç°ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ è¯·å…ˆè¯´è¯´éå¹¶å‘é›†åˆä¸­Fail-fastæœºåˆ¶? å†ä¸ºä»€ä¹ˆè¯´ArrayListæŸ¥è¯¢å¿«è€Œå¢åˆ æ…¢? å¯¹æ¯”ArrayListè¯´è¯´CopyOnWriteArrayListçš„å¢åˆ æ”¹æŸ¥å®ç°åŸç†? COWåŸºäºæ‹·è´ å†è¯´ä¸‹å¼±ä¸€è‡´æ€§çš„è¿­ä»£å™¨åŸç†æ˜¯æ€ä¹ˆæ ·çš„? COWIterator&lt;E&gt; CopyOnWriteArrayListä¸ºä»€ä¹ˆå¹¶å‘å®‰å…¨ä¸”æ€§èƒ½æ¯”Vectorå¥½? CopyOnWriteArrayListæœ‰ä½•ç¼ºé™·ï¼Œè¯´è¯´å…¶åº”ç”¨åœºæ™¯? CopyOnWriteArrayListæºç åˆ†æç±»çš„ç»§æ‰¿å…³ç³»CopyOnWriteArrayListå®ç°äº†Listæ¥å£ï¼ŒListæ¥å£å®šä¹‰äº†å¯¹åˆ—è¡¨çš„åŸºæœ¬æ“ä½œï¼›åŒæ—¶å®ç°äº†RandomAccessæ¥å£ï¼Œè¡¨ç¤ºå¯ä»¥éšæœºè®¿é—®(æ•°ç»„å…·æœ‰éšæœºè®¿é—®çš„ç‰¹æ€§)ï¼›åŒæ—¶å®ç°äº†Cloneableæ¥å£ï¼Œè¡¨ç¤ºå¯å…‹éš†ï¼›åŒæ—¶ä¹Ÿå®ç°äº†Serializableæ¥å£ï¼Œè¡¨ç¤ºå¯è¢«åºåˆ—åŒ–ã€‚ 1public class CopyOnWriteArrayList&lt;E&gt; implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable &#123;&#125; ç±»çš„å†…éƒ¨ç±» COWIteratorç±» COWIteratorè¡¨ç¤ºè¿­ä»£å™¨ï¼Œå…¶ä¹Ÿæœ‰ä¸€ä¸ªObjectç±»å‹çš„æ•°ç»„ä½œä¸ºCopyOnWriteArrayListæ•°ç»„çš„å¿«ç…§ï¼Œè¿™ç§å¿«ç…§é£æ ¼çš„è¿­ä»£å™¨æ–¹æ³•åœ¨åˆ›å»ºè¿­ä»£å™¨æ—¶ä½¿ç”¨äº†å¯¹å½“æ—¶æ•°ç»„çŠ¶æ€çš„å¼•ç”¨ã€‚æ­¤æ•°ç»„åœ¨è¿­ä»£å™¨çš„ç”Ÿå­˜æœŸå†…ä¸ä¼šæ›´æ”¹ï¼Œå› æ­¤ä¸å¯èƒ½å‘ç”Ÿå†²çªï¼Œå¹¶ä¸”è¿­ä»£å™¨ä¿è¯ä¸ä¼šæŠ›å‡º ConcurrentModificationExceptionã€‚åˆ›å»ºè¿­ä»£å™¨ä»¥åï¼Œè¿­ä»£å™¨å°±ä¸ä¼šåæ˜ åˆ—è¡¨çš„æ·»åŠ ã€ç§»é™¤æˆ–è€…æ›´æ”¹ã€‚åœ¨è¿­ä»£å™¨ä¸Šè¿›è¡Œçš„å…ƒç´ æ›´æ”¹æ“ä½œ(removeã€set å’Œ add)ä¸å—æ”¯æŒã€‚è¿™äº›æ–¹æ³•å°†æŠ›å‡º UnsupportedOperationExceptionã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788static final class COWIterator&lt;E&gt; implements ListIterator&lt;E&gt; &#123; /** Snapshot of the array */ // å¿«ç…§ private final Object[] snapshot; /** Index of element to be returned by subsequent call to next. */ // æ¸¸æ ‡ private int cursor; // æ„é€ å‡½æ•° private COWIterator(Object[] elements, int initialCursor) &#123; cursor = initialCursor; snapshot = elements; &#125; // æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡¹ public boolean hasNext() &#123; return cursor &lt; snapshot.length; &#125; // æ˜¯å¦æœ‰ä¸Šä¸€é¡¹ public boolean hasPrevious() &#123; return cursor &gt; 0; &#125; // nexté¡¹ @SuppressWarnings(&quot;unchecked&quot;) public E next() &#123; if (! hasNext()) // ä¸å­˜åœ¨ä¸‹ä¸€é¡¹ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new NoSuchElementException(); // è¿”å›ä¸‹ä¸€é¡¹ return (E) snapshot[cursor++]; &#125; @SuppressWarnings(&quot;unchecked&quot;) public E previous() &#123; if (! hasPrevious()) throw new NoSuchElementException(); return (E) snapshot[--cursor]; &#125; // ä¸‹ä¸€é¡¹ç´¢å¼• public int nextIndex() &#123; return cursor; &#125; // ä¸Šä¸€é¡¹ç´¢å¼• public int previousIndex() &#123; return cursor-1; &#125; /** * Not supported. Always throws UnsupportedOperationException. * @throws UnsupportedOperationException always; &#123;@code remove&#125; * is not supported by this iterator. */ // ä¸æ”¯æŒremoveæ“ä½œ public void remove() &#123; throw new UnsupportedOperationException(); &#125; /** * Not supported. Always throws UnsupportedOperationException. * @throws UnsupportedOperationException always; &#123;@code set&#125; * is not supported by this iterator. */ // ä¸æ”¯æŒsetæ“ä½œ public void set(E e) &#123; throw new UnsupportedOperationException(); &#125; /** * Not supported. Always throws UnsupportedOperationException. * @throws UnsupportedOperationException always; &#123;@code add&#125; * is not supported by this iterator. */ // ä¸æ”¯æŒaddæ“ä½œ public void add(E e) &#123; throw new UnsupportedOperationException(); &#125; @Override public void forEachRemaining(Consumer&lt;? super E&gt; action) &#123; Objects.requireNonNull(action); Object[] elements = snapshot; final int size = elements.length; for (int i = cursor; i &lt; size; i++) &#123; @SuppressWarnings(&quot;unchecked&quot;) E e = (E) elements[i]; action.accept(e); &#125; cursor = size; &#125;&#125; ç±»çš„å±æ€§å±æ€§ä¸­æœ‰ä¸€ä¸ªå¯é‡å…¥é”ï¼Œç”¨æ¥ä¿è¯çº¿ç¨‹å®‰å…¨è®¿é—®ï¼Œè¿˜æœ‰ä¸€ä¸ªObjectç±»å‹çš„æ•°ç»„ï¼Œç”¨æ¥å­˜æ”¾å…·ä½“çš„å…ƒç´ ã€‚å½“ç„¶ï¼Œä¹Ÿä½¿ç”¨åˆ°äº†åå°„æœºåˆ¶å’ŒCASæ¥ä¿è¯åŸå­æ€§çš„ä¿®æ”¹lockåŸŸã€‚ 1234567891011121314151617181920212223public class CopyOnWriteArrayList&lt;E&gt; implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable &#123; // ç‰ˆæœ¬åºåˆ—å· private static final long serialVersionUID = 8673264195747942595L; // å¯é‡å…¥é” final transient ReentrantLock lock = new ReentrantLock(); // å¯¹è±¡æ•°ç»„ï¼Œç”¨äºå­˜æ”¾å…ƒç´  private transient volatile Object[] array; // åå°„æœºåˆ¶ private static final sun.misc.Unsafe UNSAFE; // lockåŸŸçš„å†…å­˜åç§»é‡ private static final long lockOffset; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = CopyOnWriteArrayList.class; lockOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(&quot;lock&quot;)); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125;&#125; ç±»çš„æ„é€ å‡½æ•° é»˜è®¤æ„é€ å‡½æ•° 1234public CopyOnWriteArrayList() &#123; // è®¾ç½®æ•°ç»„ setArray(new Object[0]);&#125; CopyOnWriteArrayList(Collection&lt;? extends E&gt;)å‹æ„é€ å‡½æ•° è¯¥æ„é€ å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæŒ‰ collection çš„è¿­ä»£å™¨è¿”å›å…ƒç´ çš„é¡ºåºåŒ…å«æŒ‡å®š collection å…ƒç´ çš„åˆ—è¡¨ã€‚ 12345678910111213141516public CopyOnWriteArrayList(Collection&lt;? extends E&gt; c) &#123; Object[] elements; if (c.getClass() == CopyOnWriteArrayList.class) // ç±»å‹ç›¸åŒ // è·å–cé›†åˆçš„æ•°ç»„ elements = ((CopyOnWriteArrayList&lt;?&gt;)c).getArray(); else &#123; // ç±»å‹ä¸ç›¸åŒ // å°†cé›†åˆè½¬åŒ–ä¸ºæ•°ç»„å¹¶èµ‹å€¼ç»™elements elements = c.toArray(); // c.toArray might (incorrectly) not return Object[] (see 6260652) if (elements.getClass() != Object[].class) // elementsç±»å‹ä¸ä¸ºObject[]ç±»å‹ // å°†elementsæ•°ç»„è½¬åŒ–ä¸ºObject[]ç±»å‹çš„æ•°ç»„ elements = Arrays.copyOf(elements, elements.length, Object[].class); &#125; // è®¾ç½®æ•°ç»„ setArray(elements);&#125; è¯¥æ„é€ å‡½æ•°çš„å¤„ç†æµç¨‹å¦‚ä¸‹ åˆ¤æ–­ä¼ å…¥çš„é›†åˆcçš„ç±»å‹æ˜¯å¦ä¸ºCopyOnWriteArrayListç±»å‹ï¼Œè‹¥æ˜¯ï¼Œåˆ™è·å–è¯¥é›†åˆç±»å‹çš„åº•å±‚æ•°ç»„(Object[])ï¼Œå¹¶ä¸”è®¾ç½®å½“å‰CopyOnWriteArrayListçš„æ•°ç»„(Object[]æ•°ç»„)ï¼Œè¿›å…¥æ­¥éª¤â‘¢ï¼›å¦åˆ™ï¼Œè¿›å…¥æ­¥éª¤â‘¡ å°†ä¼ å…¥çš„é›†åˆè½¬åŒ–ä¸ºæ•°ç»„elementsï¼Œåˆ¤æ–­elementsçš„ç±»å‹æ˜¯å¦ä¸ºObject[]ç±»å‹(toArrayæ–¹æ³•å¯èƒ½ä¸ä¼šè¿”å›Objectç±»å‹çš„æ•°ç»„)ï¼Œè‹¥ä¸æ˜¯ï¼Œåˆ™å°†elementsè½¬åŒ–ä¸ºObjectç±»å‹çš„æ•°ç»„ã€‚è¿›å…¥æ­¥éª¤â‘¢ è®¾ç½®å½“å‰CopyOnWriteArrayListçš„Object[]ä¸ºelementsã€‚ CopyOnWriteArrayList(E[])å‹æ„é€ å‡½æ•° è¯¥æ„é€ å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªä¿å­˜ç»™å®šæ•°ç»„çš„å‰¯æœ¬çš„åˆ—è¡¨ã€‚ 1234public CopyOnWriteArrayList(E[] toCopyIn) &#123; // å°†toCopyInè½¬åŒ–ä¸ºObject[]ç±»å‹æ•°ç»„ï¼Œç„¶åè®¾ç½®å½“å‰æ•°ç»„ setArray(Arrays.copyOf(toCopyIn, toCopyIn.length, Object[].class));&#125; æ ¸å¿ƒå‡½æ•°åˆ†æå¯¹äºCopyOnWriteArrayListçš„å‡½æ•°åˆ†æï¼Œä¸»è¦æ˜ç™½Arrays.copyOfæ–¹æ³•å³å¯ç†è§£CopyOnWriteArrayListå…¶ä»–å‡½æ•°çš„æ„ä¹‰ã€‚ copyOfå‡½æ•°è¯¥å‡½æ•°ç”¨äºå¤åˆ¶æŒ‡å®šçš„æ•°ç»„ï¼Œæˆªå–æˆ–ç”¨ null å¡«å……(å¦‚æœ‰å¿…è¦)ï¼Œä»¥ä½¿å‰¯æœ¬å…·æœ‰æŒ‡å®šçš„é•¿åº¦ã€‚ 123456789101112public static &lt;T,U&gt; T[] copyOf(U[] original, int newLength, Class&lt;? extends T[]&gt; newType) &#123; @SuppressWarnings(&quot;unchecked&quot;) // ç¡®å®šcopyçš„ç±»å‹(å°†newTypeè½¬åŒ–ä¸ºObjectç±»å‹ï¼Œå°†Object[].classè½¬åŒ–ä¸ºObjectç±»å‹ï¼Œåˆ¤æ–­ä¸¤è€…æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™ç”ŸæˆæŒ‡å®šé•¿åº¦çš„Objectæ•°ç»„ // å¦åˆ™,ç”ŸæˆæŒ‡å®šé•¿åº¦çš„æ–°ç±»å‹çš„æ•°ç»„) T[] copy = ((Object)newType == (Object)Object[].class) ? (T[]) new Object[newLength] : (T[]) Array.newInstance(newType.getComponentType(), newLength); // å°†originalæ•°ç»„ä»ä¸‹æ ‡0å¼€å§‹ï¼Œå¤åˆ¶é•¿åº¦ä¸º(original.lengthå’ŒnewLengthçš„è¾ƒå°è€…),å¤åˆ¶åˆ°copyæ•°ç»„ä¸­(ä¹Ÿä»ä¸‹æ ‡0å¼€å§‹) System.arraycopy(original, 0, copy, 0, Math.min(original.length, newLength)); return copy;&#125; addå‡½æ•°12345678910111213141516171819202122public boolean add(E e) &#123; // å¯é‡å…¥é” final ReentrantLock lock = this.lock; // è·å–é” lock.lock(); try &#123; // å…ƒç´ æ•°ç»„ Object[] elements = getArray(); // æ•°ç»„é•¿åº¦ int len = elements.length; // å¤åˆ¶æ•°ç»„ Object[] newElements = Arrays.copyOf(elements, len + 1); // å­˜æ”¾å…ƒç´ e newElements[len] = e; // è®¾ç½®æ•°ç»„ setArray(newElements); return true; &#125; finally &#123; // é‡Šæ”¾é” lock.unlock(); &#125;&#125; æ­¤å‡½æ•°ç”¨äºå°†æŒ‡å®šå…ƒç´ æ·»åŠ åˆ°æ­¤åˆ—è¡¨çš„å°¾éƒ¨ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ è·å–é”(ä¿è¯å¤šçº¿ç¨‹çš„å®‰å…¨è®¿é—®)ï¼Œè·å–å½“å‰çš„Objectæ•°ç»„ï¼Œè·å–Objectæ•°ç»„çš„é•¿åº¦ä¸ºlengthï¼Œè¿›å…¥æ­¥éª¤â‘¡ã€‚ æ ¹æ®Objectæ•°ç»„å¤åˆ¶ä¸€ä¸ªé•¿åº¦ä¸ºlength+1çš„Objectæ•°ç»„ä¸ºnewElements(æ­¤æ—¶ï¼ŒnewElements[length]ä¸ºnull)ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥éª¤ã€‚ å°†ä¸‹æ ‡ä¸ºlengthçš„æ•°ç»„å…ƒç´ newElements[length]è®¾ç½®ä¸ºå…ƒç´ eï¼Œå†è®¾ç½®å½“å‰Object[]ä¸ºnewElementsï¼Œé‡Šæ”¾é”ï¼Œè¿”å›ã€‚è¿™æ ·å°±å®Œæˆäº†å…ƒç´ çš„æ·»åŠ ã€‚ addIfAbsentæ–¹æ³•è¯¥å‡½æ•°ç”¨äºæ·»åŠ å…ƒç´ (å¦‚æœæ•°ç»„ä¸­ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ ï¼›å¦åˆ™ï¼Œä¸æ·»åŠ ï¼Œç›´æ¥è¿”å›)ï¼Œå¯ä»¥ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸ä¼šé‡å¤æ·»åŠ å…ƒç´ ã€‚ 1234567891011121314151617181920212223242526272829303132333435private boolean addIfAbsent(E e, Object[] snapshot) &#123; // é‡å…¥é” final ReentrantLock lock = this.lock; // è·å–é” lock.lock(); try &#123; // è·å–æ•°ç»„ Object[] current = getArray(); // æ•°ç»„é•¿åº¦ int len = current.length; if (snapshot != current) &#123; // å¿«ç…§ä¸ç­‰äºå½“å‰æ•°ç»„ï¼Œå¯¹æ•°ç»„è¿›è¡Œäº†ä¿®æ”¹ // Optimize for lost race to another addXXX operation // å–è¾ƒå°è€… int common = Math.min(snapshot.length, len); for (int i = 0; i &lt; common; i++) // éå† if (current[i] != snapshot[i] &amp;&amp; eq(e, current[i])) // å½“å‰æ•°ç»„çš„å…ƒç´ ä¸å¿«ç…§çš„å…ƒç´ ä¸ç›¸ç­‰å¹¶ä¸”eä¸å½“å‰å…ƒç´ ç›¸ç­‰ // è¡¨ç¤ºåœ¨snapshotä¸currentä¹‹é—´ä¿®æ”¹äº†æ•°ç»„ï¼Œå¹¶ä¸”è®¾ç½®äº†æ•°ç»„æŸä¸€å…ƒç´ ä¸ºeï¼Œå·²ç»å­˜åœ¨ // è¿”å› return false; if (indexOf(e, current, common, len) &gt;= 0) // åœ¨å½“å‰æ•°ç»„ä¸­æ‰¾åˆ°eå…ƒç´  // è¿”å› return false; &#125; // å¤åˆ¶æ•°ç»„ Object[] newElements = Arrays.copyOf(current, len + 1); // å¯¹æ•°ç»„lenç´¢å¼•çš„å…ƒç´ èµ‹å€¼ä¸ºe newElements[len] = e; // è®¾ç½®æ•°ç»„ setArray(newElements); return true; &#125; finally &#123; // é‡Šæ”¾é” lock.unlock(); &#125;&#125; è¯¥å‡½æ•°çš„æµç¨‹å¦‚ä¸‹: â‘  è·å–é”ï¼Œè·å–å½“å‰æ•°ç»„ä¸ºcurrentï¼Œcurrenté•¿åº¦ä¸ºlenï¼Œåˆ¤æ–­æ•°ç»„ä¹‹å‰çš„å¿«ç…§snapshotæ˜¯å¦ç­‰äºå½“å‰æ•°ç»„currentï¼Œè‹¥ä¸ç›¸ç­‰ï¼Œåˆ™è¿›å…¥æ­¥éª¤â‘¡ï¼›å¦åˆ™ï¼Œè¿›å…¥æ­¥éª¤â‘£ â‘¡ ä¸ç›¸ç­‰ï¼Œè¡¨ç¤ºåœ¨snapshotä¸currentä¹‹é—´ï¼Œå¯¹æ•°ç»„è¿›è¡Œäº†ä¿®æ”¹(å¦‚è¿›è¡Œäº†addã€setã€removeç­‰æ“ä½œ)ï¼Œè·å–é•¿åº¦(snapshotä¸currentä¹‹é—´çš„è¾ƒå°è€…)ï¼Œå¯¹currentè¿›è¡Œéå†æ“ä½œï¼Œè‹¥éå†è¿‡ç¨‹å‘ç°snapshotä¸currentçš„å…ƒç´ ä¸ç›¸ç­‰å¹¶ä¸”currentçš„å…ƒç´ ä¸æŒ‡å®šå…ƒç´ ç›¸ç­‰(å¯èƒ½è¿›è¡Œäº†setæ“ä½œ)ï¼Œè¿›å…¥æ­¥éª¤â‘¤ï¼Œå¦åˆ™ï¼Œè¿›å…¥æ­¥éª¤â‘¢ â‘¢ åœ¨å½“å‰æ•°ç»„ä¸­ç´¢å¼•æŒ‡å®šå…ƒç´ ï¼Œè‹¥èƒ½å¤Ÿæ‰¾åˆ°ï¼Œè¿›å…¥æ­¥éª¤â‘¤ï¼Œå¦åˆ™ï¼Œè¿›å…¥æ­¥éª¤â‘£ â‘£ å¤åˆ¶å½“å‰æ•°ç»„currentä¸ºnewElementsï¼Œé•¿åº¦ä¸ºlen+1ï¼Œæ­¤æ—¶newElements[len]ä¸ºnullã€‚å†è®¾ç½®newElements[len]ä¸ºæŒ‡å®šå…ƒç´ eï¼Œå†è®¾ç½®æ•°ç»„ï¼Œè¿›å…¥æ­¥éª¤â‘¤ â‘¤ é‡Šæ”¾é”ï¼Œè¿”å›ã€‚ setå‡½æ•°æ­¤å‡½æ•°ç”¨äºç”¨æŒ‡å®šçš„å…ƒç´ æ›¿ä»£æ­¤åˆ—è¡¨æŒ‡å®šä½ç½®ä¸Šçš„å…ƒç´ ï¼Œä¹Ÿæ˜¯åŸºäºæ•°ç»„çš„å¤åˆ¶æ¥å®ç°çš„ã€‚ 1234567891011121314151617181920212223242526272829303132public E set(int index, E element) &#123; // å¯é‡å…¥é” final ReentrantLock lock = this.lock; // è·å–é” lock.lock(); try &#123; // è·å–æ•°ç»„ Object[] elements = getArray(); // è·å–indexç´¢å¼•çš„å…ƒç´  E oldValue = get(elements, index); if (oldValue != element) &#123; // æ—§å€¼ç­‰äºelement // æ•°ç»„é•¿åº¦ int len = elements.length; // å¤åˆ¶æ•°ç»„ Object[] newElements = Arrays.copyOf(elements, len); // é‡æ–°èµ‹å€¼indexç´¢å¼•çš„å€¼ newElements[index] = element; // è®¾ç½®æ•°ç»„ setArray(newElements); &#125; else &#123; // Not quite a no-op; ensures volatile write semantics // è®¾ç½®æ•°ç»„ setArray(elements); &#125; // è¿”å›æ—§å€¼ return oldValue; &#125; finally &#123; // é‡Šæ”¾é” lock.unlock(); &#125;&#125; removeå‡½æ•°æ­¤å‡½æ•°ç”¨äºç§»é™¤æ­¤åˆ—è¡¨æŒ‡å®šä½ç½®ä¸Šçš„å…ƒç´ ã€‚ 1234567891011121314151617181920212223242526272829303132333435public E remove(int index) &#123; // å¯é‡å…¥é” final ReentrantLock lock = this.lock; // è·å–é” lock.lock(); try &#123; // è·å–æ•°ç»„ Object[] elements = getArray(); // æ•°ç»„é•¿åº¦ int len = elements.length; // è·å–æ—§å€¼ E oldValue = get(elements, index); // éœ€è¦ç§»åŠ¨çš„å…ƒç´ ä¸ªæ•° int numMoved = len - index - 1; if (numMoved == 0) // ç§»åŠ¨ä¸ªæ•°ä¸º0 // å¤åˆ¶åè®¾ç½®æ•°ç»„ setArray(Arrays.copyOf(elements, len - 1)); else &#123; // ç§»åŠ¨ä¸ªæ•°ä¸ä¸º0 // æ–°ç”Ÿæ•°ç»„ Object[] newElements = new Object[len - 1]; // å¤åˆ¶indexç´¢å¼•ä¹‹å‰çš„å…ƒç´  System.arraycopy(elements, 0, newElements, 0, index); // å¤åˆ¶indexç´¢å¼•ä¹‹åçš„å…ƒç´  System.arraycopy(elements, index + 1, newElements, index, numMoved); // è®¾ç½®ç´¢å¼• setArray(newElements); &#125; // è¿”å›æ—§å€¼ return oldValue; &#125; finally &#123; // é‡Šæ”¾é” lock.unlock(); &#125;&#125; å¤„ç†æµç¨‹å¦‚ä¸‹ â‘  è·å–é”ï¼Œè·å–æ•°ç»„elementsï¼Œæ•°ç»„é•¿åº¦ä¸ºlengthï¼Œè·å–ç´¢å¼•çš„å€¼elements[index]ï¼Œè®¡ç®—éœ€è¦ç§»åŠ¨çš„å…ƒç´ ä¸ªæ•°(length - index - 1),è‹¥ä¸ªæ•°ä¸º0ï¼Œåˆ™è¡¨ç¤ºç§»é™¤çš„æ˜¯æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¤åˆ¶elementsæ•°ç»„ï¼Œå¤åˆ¶é•¿åº¦ä¸ºlength-1ï¼Œç„¶åè®¾ç½®æ•°ç»„ï¼Œè¿›å…¥æ­¥éª¤â‘¢ï¼›å¦åˆ™ï¼Œè¿›å…¥æ­¥éª¤â‘¡ â‘¡ å…ˆå¤åˆ¶indexç´¢å¼•å‰çš„å…ƒç´ ï¼Œå†å¤åˆ¶indexç´¢å¼•åçš„å…ƒç´ ï¼Œç„¶åè®¾ç½®æ•°ç»„ã€‚ â‘¢ é‡Šæ”¾é”ï¼Œè¿”å›æ—§å€¼ã€‚ CopyOnWriteArrayListç¤ºä¾‹ä¸‹é¢é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥äº†è§£CopyOnWriteArrayListçš„ä½¿ç”¨: åœ¨ç¨‹åºä¸­ï¼Œæœ‰ä¸€ä¸ªPutThreadçº¿ç¨‹ä¼šæ¯éš”50mså°±å‘CopyOnWriteArrayListä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ä¸¤æ¬¡ä½¿ç”¨äº†è¿­ä»£å™¨ï¼Œè¿­ä»£å™¨è¾“å‡ºçš„å†…å®¹éƒ½æ˜¯ç”Ÿæˆè¿­ä»£å™¨æ—¶ï¼ŒCopyOnWriteArrayListçš„Objectæ•°ç»„çš„å¿«ç…§çš„å†…å®¹ï¼Œåœ¨è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œå¾€CopyOnWriteArrayListä¸­æ·»åŠ å…ƒç´ ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647import java.util.Iterator;import java.util.concurrent.CopyOnWriteArrayList;class PutThread extends Thread &#123; private CopyOnWriteArrayList&lt;Integer&gt; cowal; public PutThread(CopyOnWriteArrayList&lt;Integer&gt; cowal) &#123; this.cowal = cowal; &#125; public void run() &#123; try &#123; for (int i = 100; i &lt; 110; i++) &#123; cowal.add(i); Thread.sleep(50); &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125;public class CopyOnWriteArrayListDemo &#123; public static void main(String[] args) &#123; CopyOnWriteArrayList&lt;Integer&gt; cowal = new CopyOnWriteArrayList&lt;Integer&gt;(); for (int i = 0; i &lt; 10; i++) &#123; cowal.add(i); &#125; PutThread p1 = new PutThread(cowal); p1.start(); Iterator&lt;Integer&gt; iterator = cowal.iterator(); while (iterator.hasNext()) &#123; System.out.print(iterator.next() + &quot; &quot;); &#125; System.out.println(); try &#123; Thread.sleep(200); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; iterator = cowal.iterator(); while (iterator.hasNext()) &#123; System.out.print(iterator.next() + &quot; &quot;); &#125; &#125;&#125; è¿è¡Œç»“æœ(æŸä¸€æ¬¡) 120 1 2 3 4 5 6 7 8 9 100 0 1 2 3 4 5 6 7 8 9 100 101 102 103 æ›´æ·±å…¥ç†è§£CopyOnWriteArrayListçš„ç¼ºé™·å’Œä½¿ç”¨åœºæ™¯CopyOnWriteArrayList æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š ç”±äºå†™æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦æ‹·è´æ•°ç»„ï¼Œä¼šæ¶ˆè€—å†…å­˜ï¼Œå¦‚æœåŸæ•°ç»„çš„å†…å®¹æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´young gcæˆ–è€…full gc ä¸èƒ½ç”¨äºå®æ—¶è¯»çš„åœºæ™¯ï¼Œåƒæ‹·è´æ•°ç»„ã€æ–°å¢å…ƒç´ éƒ½éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥è°ƒç”¨ä¸€ä¸ªsetæ“ä½œåï¼Œè¯»å–åˆ°æ•°æ®å¯èƒ½è¿˜æ˜¯æ—§çš„,è™½ç„¶CopyOnWriteArrayList èƒ½åšåˆ°æœ€ç»ˆä¸€è‡´æ€§,ä½†æ˜¯è¿˜æ˜¯æ²¡æ³•æ»¡è¶³å®æ—¶æ€§è¦æ±‚ï¼› CopyOnWriteArrayList åˆé€‚è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œä¸è¿‡è¿™ç±»æ…ç”¨ å› ä¸ºè°ä¹Ÿæ²¡æ³•ä¿è¯CopyOnWriteArrayList åˆ°åº•è¦æ”¾ç½®å¤šå°‘æ•°æ®ï¼Œä¸‡ä¸€æ•°æ®ç¨å¾®æœ‰ç‚¹å¤šï¼Œæ¯æ¬¡add&#x2F;setéƒ½è¦é‡æ–°å¤åˆ¶æ•°ç»„ï¼Œè¿™ä¸ªä»£ä»·å®åœ¨å¤ªé«˜æ˜‚äº†ã€‚åœ¨é«˜æ€§èƒ½çš„äº’è”ç½‘åº”ç”¨ä¸­ï¼Œè¿™ç§æ“ä½œåˆ†åˆ†é’Ÿå¼•èµ·æ•…éšœã€‚ CopyOnWriteArrayListä¸ºä»€ä¹ˆå¹¶å‘å®‰å…¨ä¸”æ€§èƒ½æ¯”Vectorå¥½?Vectorå¯¹å•ç‹¬çš„addï¼Œremoveç­‰æ–¹æ³•éƒ½æ˜¯åœ¨æ–¹æ³•ä¸ŠåŠ äº†synchronized; å¹¶ä¸”å¦‚æœä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨sizeæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹B æ‰§è¡Œäº†removeï¼Œç„¶åsizeçš„å€¼å°±ä¸æ˜¯æœ€æ–°çš„ï¼Œç„¶åçº¿ç¨‹Aè°ƒç”¨removeå°±ä¼šè¶Šç•Œ(è¿™æ—¶å°±éœ€è¦å†åŠ ä¸€ä¸ªSynchronized)ã€‚è¿™æ ·å°±å¯¼è‡´æœ‰äº†åŒé‡é”ï¼Œæ•ˆç‡å¤§å¤§é™ä½ï¼Œä½•å¿…å‘¢ã€‚äºæ˜¯vectoråºŸå¼ƒäº†ï¼Œè¦ç”¨å°±ç”¨CopyOnWriteArrayList å§ã€‚ å‚è€ƒæ–‡ç«  æ–‡ç« ä¸»è¦å‚è€ƒè‡ªleesfçš„https://www.cnblogs.com/leesf456/p/5547853.htmlï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšäº†å¢æ”¹ã€‚ https://blog.csdn.net/LuoZheng4698729/article/details/102824923 https://blog.csdn.net/chuanyingcao2675/article/details/101048889","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"14.JUCé›†åˆ: ConcurrentHashMapè¯¦è§£","path":"/2023/12/25/14-JUCé›†åˆ-ConcurrentHashMapè¯¦è§£/","content":"JDK1.7ä¹‹å‰çš„ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”æœºåˆ¶å®ç°ï¼ŒJDK1.8åˆ™ä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘æ•°æ®ç»“æ„å’ŒCASåŸå­æ“ä½œå®ç°ConcurrentHashMapï¼›æœ¬æ–‡å°†åˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§æ–¹å¼çš„å®ç°æ–¹æ¡ˆåŠå…¶åŒºåˆ«ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ ä¸ºä»€ä¹ˆHashTableæ…¢? å®ƒçš„å¹¶å‘åº¦æ˜¯ä»€ä¹ˆ? é‚£ä¹ˆConcurrentHashMapå¹¶å‘åº¦æ˜¯ä»€ä¹ˆ? ConcurrentHashMapåœ¨JDK1.7å’ŒJDK1.8ä¸­å®ç°æœ‰ä»€ä¹ˆå·®åˆ«? JDK1.8è§£æ±ºäº†JDK1.7ä¸­ä»€ä¹ˆé—®é¢˜ ConcurrentHashMap JDK1.7å®ç°çš„åŸç†æ˜¯ä»€ä¹ˆ? åˆ†æ®µé”æœºåˆ¶ ConcurrentHashMap JDK1.8å®ç°çš„åŸç†æ˜¯ä»€ä¹ˆ? æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ï¼ŒCAS ConcurrentHashMap JDK1.7ä¸­Segmentæ•°(concurrencyLevel)é»˜è®¤å€¼æ˜¯å¤šå°‘? ä¸ºä½•ä¸€æ—¦åˆå§‹åŒ–å°±ä¸å¯å†æ‰©å®¹? ConcurrentHashMap JDK1.7è¯´è¯´å…¶putçš„æœºåˆ¶? ConcurrentHashMap JDK1.7æ˜¯å¦‚ä½•æ‰©å®¹çš„? rehash(æ³¨ï¼šsegment æ•°ç»„ä¸èƒ½æ‰©å®¹ï¼Œæ‰©å®¹æ˜¯ segment æ•°ç»„æŸä¸ªä½ç½®å†…éƒ¨çš„æ•°ç»„ HashEntry&lt;K,V&gt;[] è¿›è¡Œæ‰©å®¹) ConcurrentHashMap JDK1.8æ˜¯å¦‚ä½•æ‰©å®¹çš„? tryPresize ConcurrentHashMap JDK1.8é“¾è¡¨è½¬çº¢é»‘æ ‘çš„æ—¶æœºæ˜¯ä»€ä¹ˆ? ä¸´ç•Œå€¼ä¸ºä»€ä¹ˆæ˜¯8? ConcurrentHashMap JDK1.8æ˜¯å¦‚ä½•è¿›è¡Œæ•°æ®è¿ç§»çš„? transfer ä¸ºä»€ä¹ˆHashTableæ…¢Hashtableä¹‹æ‰€ä»¥æ•ˆç‡ä½ä¸‹ä¸»è¦æ˜¯å› ä¸ºå…¶å®ç°ä½¿ç”¨äº†synchronizedå…³é”®å­—å¯¹putç­‰æ“ä½œè¿›è¡ŒåŠ é”ï¼Œè€Œsynchronizedå…³é”®å­—åŠ é”æ˜¯å¯¹æ•´ä¸ªå¯¹è±¡è¿›è¡ŒåŠ é”ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿›è¡Œputç­‰ä¿®æ”¹Hashè¡¨çš„æ“ä½œæ—¶ï¼Œé”ä½äº†æ•´ä¸ªHashè¡¨ï¼Œä»è€Œä½¿å¾—å…¶è¡¨ç°çš„æ•ˆç‡ä½ä¸‹ã€‚ ConcurrentHashMap - JDK 1.7åœ¨JDK1.5~1.7ç‰ˆæœ¬ï¼ŒJavaä½¿ç”¨äº†åˆ†æ®µé”æœºåˆ¶å®ç°ConcurrentHashMap. ç®€è€Œè¨€ä¹‹ï¼ŒConcurrentHashMapåœ¨å¯¹è±¡ä¸­ä¿å­˜äº†ä¸€ä¸ªSegmentæ•°ç»„ï¼Œå³å°†æ•´ä¸ªHashè¡¨åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†æ®µï¼›è€Œæ¯ä¸ªSegmentå…ƒç´ ï¼Œå³æ¯ä¸ªåˆ†æ®µåˆ™ç±»ä¼¼äºä¸€ä¸ªHashtableï¼›è¿™æ ·ï¼Œåœ¨æ‰§è¡Œputæ“ä½œæ—¶é¦–å…ˆæ ¹æ®hashç®—æ³•å®šä½åˆ°å…ƒç´ å±äºå“ªä¸ªSegmentï¼Œç„¶åå¯¹è¯¥SegmentåŠ é”å³å¯ã€‚å› æ­¤ï¼ŒConcurrentHashMapåœ¨å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹ä¸­å¯æ˜¯å®ç°å¤šçº¿ç¨‹putæ“ä½œã€‚æ¥ä¸‹æ¥åˆ†æJDK1.7ç‰ˆæœ¬ä¸­ConcurrentHashMapçš„å®ç°åŸç†ã€‚ æ•°æ®ç»“æ„æ•´ä¸ª ConcurrentHashMap ç”±ä¸€ä¸ªä¸ª Segment ç»„æˆï¼ŒSegment ä»£è¡¨â€éƒ¨åˆ†â€œæˆ–â€ä¸€æ®µâ€œçš„æ„æ€ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹éƒ½ä¼šå°†å…¶æè¿°ä¸ºåˆ†æ®µé”ã€‚æ³¨æ„ï¼Œè¡Œæ–‡ä¸­ï¼Œæˆ‘å¾ˆå¤šåœ°æ–¹ç”¨äº†â€œæ§½â€æ¥ä»£è¡¨ä¸€ä¸ª segmentã€‚ ç®€å•ç†è§£å°±æ˜¯ï¼ŒConcurrentHashMap æ˜¯ä¸€ä¸ª Segment æ•°ç»„ï¼ŒSegment é€šè¿‡ç»§æ‰¿ ReentrantLock æ¥è¿›è¡ŒåŠ é”ï¼Œæ‰€ä»¥æ¯æ¬¡éœ€è¦åŠ é”çš„æ“ä½œé”ä½çš„æ˜¯ä¸€ä¸ª segmentï¼Œè¿™æ ·åªè¦ä¿è¯æ¯ä¸ª Segment æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¹Ÿå°±å®ç°äº†å…¨å±€çš„çº¿ç¨‹å®‰å…¨ã€‚ concurrencyLevel: å¹¶è¡Œçº§åˆ«ã€å¹¶å‘æ•°ã€Segment æ•°ï¼Œæ€ä¹ˆç¿»è¯‘ä¸é‡è¦ï¼Œç†è§£å®ƒã€‚é»˜è®¤æ˜¯ 16ï¼Œä¹Ÿå°±æ˜¯è¯´ ConcurrentHashMap æœ‰ 16 ä¸ª Segmentsï¼Œæ‰€ä»¥ç†è®ºä¸Šï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæœ€å¤šå¯ä»¥åŒæ—¶æ”¯æŒ 16 ä¸ªçº¿ç¨‹å¹¶å‘å†™ï¼Œåªè¦å®ƒä»¬çš„æ“ä½œåˆ†åˆ«åˆ†å¸ƒåœ¨ä¸åŒçš„ Segment ä¸Šã€‚è¿™ä¸ªå€¼å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®ä¸ºå…¶ä»–å€¼ï¼Œä½†æ˜¯ä¸€æ—¦åˆå§‹åŒ–ä»¥åï¼Œå®ƒæ˜¯ä¸å¯ä»¥æ‰©å®¹çš„ã€‚ å†å…·ä½“åˆ°æ¯ä¸ª Segment å†…éƒ¨ï¼Œå…¶å®æ¯ä¸ª Segment å¾ˆåƒä¹‹å‰ä»‹ç»çš„ HashMapï¼Œä¸è¿‡å®ƒè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥å¤„ç†èµ·æ¥è¦éº»çƒ¦äº›ã€‚ åˆå§‹åŒ– initialCapacity: åˆå§‹å®¹é‡ï¼Œè¿™ä¸ªå€¼æŒ‡çš„æ˜¯æ•´ä¸ª ConcurrentHashMap çš„åˆå§‹å®¹é‡ï¼Œå®é™…æ“ä½œçš„æ—¶å€™éœ€è¦å¹³å‡åˆ†ç»™æ¯ä¸ª Segmentã€‚ loadFactor: è´Ÿè½½å› å­ï¼Œä¹‹å‰æˆ‘ä»¬è¯´äº†ï¼ŒSegment æ•°ç»„ä¸å¯ä»¥æ‰©å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªè´Ÿè½½å› å­æ˜¯ç»™æ¯ä¸ª Segment å†…éƒ¨ä½¿ç”¨çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123; if (!(loadFactor &gt; 0) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0) throw new IllegalArgumentException(); if (concurrencyLevel &gt; MAX_SEGMENTS) concurrencyLevel = MAX_SEGMENTS; // Find power-of-two sizes best matching arguments int sshift = 0; int ssize = 1; // è®¡ç®—å¹¶è¡Œçº§åˆ« ssizeï¼Œå› ä¸ºè¦ä¿æŒå¹¶è¡Œçº§åˆ«æ˜¯ 2 çš„ n æ¬¡æ–¹ while (ssize &lt; concurrencyLevel) &#123; ++sshift; ssize &lt;&lt;= 1; &#125; // æˆ‘ä»¬è¿™é‡Œå…ˆä¸è¦é‚£ä¹ˆçƒ§è„‘ï¼Œç”¨é»˜è®¤å€¼ï¼ŒconcurrencyLevel ä¸º 16ï¼Œsshift ä¸º 4 // é‚£ä¹ˆè®¡ç®—å‡º segmentShift ä¸º 28ï¼ŒsegmentMask ä¸º 15ï¼Œåé¢ä¼šç”¨åˆ°è¿™ä¸¤ä¸ªå€¼ this.segmentShift = 32 - sshift; this.segmentMask = ssize - 1; if (initialCapacity &gt; MAXIMUM_CAPACITY) initialCapacity = MAXIMUM_CAPACITY; // initialCapacity æ˜¯è®¾ç½®æ•´ä¸ª map åˆå§‹çš„å¤§å°ï¼Œ // è¿™é‡Œæ ¹æ® initialCapacity è®¡ç®— Segment æ•°ç»„ä¸­æ¯ä¸ªä½ç½®å¯ä»¥åˆ†åˆ°çš„å¤§å° // å¦‚ initialCapacity ä¸º 64ï¼Œé‚£ä¹ˆæ¯ä¸ª Segment æˆ–ç§°ä¹‹ä¸º&quot;æ§½&quot;å¯ä»¥åˆ†åˆ° 4 ä¸ª int c = initialCapacity / ssize; if (c * ssize &lt; initialCapacity) ++c; // é»˜è®¤ MIN_SEGMENT_TABLE_CAPACITY æ˜¯ 2ï¼Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯æœ‰è®²ç©¶çš„ï¼Œå› ä¸ºè¿™æ ·çš„è¯ï¼Œå¯¹äºå…·ä½“çš„æ§½ä¸Šï¼Œ // æ’å…¥ä¸€ä¸ªå…ƒç´ ä¸è‡³äºæ‰©å®¹ï¼Œæ’å…¥ç¬¬äºŒä¸ªçš„æ—¶å€™æ‰ä¼šæ‰©å®¹ int cap = MIN_SEGMENT_TABLE_CAPACITY; while (cap &lt; c) cap &lt;&lt;= 1; // åˆ›å»º Segment æ•°ç»„ï¼Œ // å¹¶åˆ›å»ºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  segment[0] Segment&lt;K,V&gt; s0 = new Segment&lt;K,V&gt;(loadFactor, (int)(cap * loadFactor), (HashEntry&lt;K,V&gt;[])new HashEntry[cap]); Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])new Segment[ssize]; // å¾€æ•°ç»„å†™å…¥ segment[0] UNSAFE.putOrderedObject(ss, SBASE, s0); // ordered write of segments[0] this.segments = ss;&#125; åˆå§‹åŒ–å®Œæˆï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª Segment æ•°ç»„ã€‚ æˆ‘ä»¬å°±å½“æ˜¯ç”¨ new ConcurrentHashMap() æ— å‚æ„é€ å‡½æ•°è¿›è¡Œåˆå§‹åŒ–çš„ï¼Œé‚£ä¹ˆåˆå§‹åŒ–å®Œæˆå: Segment æ•°ç»„é•¿åº¦ä¸º 16ï¼Œä¸å¯ä»¥æ‰©å®¹ Segment[i] çš„é»˜è®¤å¤§å°ä¸º 2ï¼Œè´Ÿè½½å› å­æ˜¯ 0.75ï¼Œå¾—å‡ºåˆå§‹é˜ˆå€¼ä¸º 1.5ï¼Œä¹Ÿå°±æ˜¯ä»¥åæ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ä¼šè§¦å‘æ‰©å®¹ï¼Œæ’å…¥ç¬¬äºŒä¸ªä¼šè¿›è¡Œç¬¬ä¸€æ¬¡æ‰©å®¹ è¿™é‡Œåˆå§‹åŒ–äº† segment[0]ï¼Œå…¶ä»–ä½ç½®è¿˜æ˜¯ nullï¼Œè‡³äºä¸ºä»€ä¹ˆè¦åˆå§‹åŒ– segment[0]ï¼Œåé¢çš„ä»£ç ä¼šä»‹ç» å½“å‰ segmentShift çš„å€¼ä¸º 32 - 4 &#x3D; 28ï¼ŒsegmentMask ä¸º 16 - 1 &#x3D; 15ï¼Œå§‘ä¸”æŠŠå®ƒä»¬ç®€å•ç¿»è¯‘ä¸ºç§»ä½æ•°å’Œæ©ç ï¼Œè¿™ä¸¤ä¸ªå€¼é©¬ä¸Šå°±ä¼šç”¨åˆ° put è¿‡ç¨‹åˆ†ææˆ‘ä»¬å…ˆçœ‹ put çš„ä¸»æµç¨‹ï¼Œå¯¹äºå…¶ä¸­çš„ä¸€äº›å…³é”®ç»†èŠ‚æ“ä½œï¼Œåé¢ä¼šè¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚ 123456789101112131415161718public V put(K key, V value) &#123; Segment&lt;K,V&gt; s; if (value == null) throw new NullPointerException(); // 1. è®¡ç®— key çš„ hash å€¼ int hash = hash(key); // 2. æ ¹æ® hash å€¼æ‰¾åˆ° Segment æ•°ç»„ä¸­çš„ä½ç½® j // hash æ˜¯ 32 ä½ï¼Œæ— ç¬¦å·å³ç§» segmentShift(28) ä½ï¼Œå‰©ä¸‹é«˜ 4 ä½ï¼Œ // ç„¶åå’Œ segmentMask(15) åšä¸€æ¬¡ä¸æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ j æ˜¯ hash å€¼çš„é«˜ 4 ä½ï¼Œä¹Ÿå°±æ˜¯æ§½çš„æ•°ç»„ä¸‹æ ‡ int j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask; // åˆšåˆšè¯´äº†ï¼Œåˆå§‹åŒ–çš„æ—¶å€™åˆå§‹åŒ–äº† segment[0]ï¼Œä½†æ˜¯å…¶ä»–ä½ç½®è¿˜æ˜¯ nullï¼Œ // ensureSegment(j) å¯¹ segment[j] è¿›è¡Œåˆå§‹åŒ– if ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject // nonvolatile; recheck (segments, (j &lt;&lt; SSHIFT) + SBASE)) == null) // in ensureSegment s = ensureSegment(j); // 3. æ’å…¥æ–°å€¼åˆ° æ§½ s ä¸­ return s.put(key, hash, value, false);&#125; ç¬¬ä¸€å±‚çš®å¾ˆç®€å•ï¼Œæ ¹æ® hash å€¼å¾ˆå¿«å°±èƒ½æ‰¾åˆ°ç›¸åº”çš„ Segmentï¼Œä¹‹åå°±æ˜¯ Segment å†…éƒ¨çš„ put æ“ä½œäº†ã€‚ Segment å†…éƒ¨æ˜¯ç”± æ•°ç»„+é“¾è¡¨ ç»„æˆçš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859final V put(K key, int hash, V value, boolean onlyIfAbsent) &#123; // åœ¨å¾€è¯¥ segment å†™å…¥å‰ï¼Œéœ€è¦å…ˆè·å–è¯¥ segment çš„ç‹¬å é” // å…ˆçœ‹ä¸»æµç¨‹ï¼Œåé¢è¿˜ä¼šå…·ä½“ä»‹ç»è¿™éƒ¨åˆ†å†…å®¹ HashEntry&lt;K,V&gt; node = tryLock() ? null : scanAndLockForPut(key, hash, value); V oldValue; try &#123; // è¿™ä¸ªæ˜¯ segment å†…éƒ¨çš„æ•°ç»„ HashEntry&lt;K,V&gt;[] tab = table; // å†åˆ©ç”¨ hash å€¼ï¼Œæ±‚åº”è¯¥æ”¾ç½®çš„æ•°ç»„ä¸‹æ ‡ int index = (tab.length - 1) &amp; hash; // first æ˜¯æ•°ç»„è¯¥ä½ç½®å¤„çš„é“¾è¡¨çš„è¡¨å¤´ HashEntry&lt;K,V&gt; first = entryAt(tab, index); // ä¸‹é¢è¿™ä¸² for å¾ªç¯è™½ç„¶å¾ˆé•¿ï¼Œä¸è¿‡ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæƒ³æƒ³è¯¥ä½ç½®æ²¡æœ‰ä»»ä½•å…ƒç´ å’Œå·²ç»å­˜åœ¨ä¸€ä¸ªé“¾è¡¨è¿™ä¸¤ç§æƒ…å†µ for (HashEntry&lt;K,V&gt; e = first;;) &#123; if (e != null) &#123; K k; if ((k = e.key) == key || (e.hash == hash &amp;&amp; key.equals(k))) &#123; oldValue = e.value; if (!onlyIfAbsent) &#123; // è¦†ç›–æ—§å€¼ e.value = value; ++modCount; &#125; break; &#125; // ç»§ç»­é¡ºç€é“¾è¡¨èµ° e = e.next; &#125; else &#123; // node åˆ°åº•æ˜¯ä¸æ˜¯ nullï¼Œè¿™ä¸ªè¦çœ‹è·å–é”çš„è¿‡ç¨‹ï¼Œä¸è¿‡å’Œè¿™é‡Œéƒ½æ²¡æœ‰å…³ç³»ã€‚ // å¦‚æœä¸ä¸º nullï¼Œé‚£å°±ç›´æ¥å°†å®ƒè®¾ç½®ä¸ºé“¾è¡¨è¡¨å¤´ï¼›å¦‚æœæ˜¯nullï¼Œåˆå§‹åŒ–å¹¶è®¾ç½®ä¸ºé“¾è¡¨è¡¨å¤´ã€‚ if (node != null) node.setNext(first); else node = new HashEntry&lt;K,V&gt;(hash, key, value, first); int c = count + 1; // å¦‚æœè¶…è¿‡äº†è¯¥ segment çš„é˜ˆå€¼ï¼Œè¿™ä¸ª segment éœ€è¦æ‰©å®¹ if (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY) rehash(node); // æ‰©å®¹åé¢ä¹Ÿä¼šå…·ä½“åˆ†æ else // æ²¡æœ‰è¾¾åˆ°é˜ˆå€¼ï¼Œå°† node æ”¾åˆ°æ•°ç»„ tab çš„ index ä½ç½®ï¼Œ // å…¶å®å°±æ˜¯å°†æ–°çš„èŠ‚ç‚¹è®¾ç½®æˆåŸé“¾è¡¨çš„è¡¨å¤´ setEntryAt(tab, index, node); ++modCount; count = c; oldValue = null; break; &#125; &#125; &#125; finally &#123; // è§£é” unlock(); &#125; return oldValue;&#125; æ•´ä½“æµç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç”±äºæœ‰ç‹¬å é”çš„ä¿æŠ¤ï¼Œæ‰€ä»¥ segment å†…éƒ¨çš„æ“ä½œå¹¶ä¸å¤æ‚ã€‚è‡³äºè¿™é‡Œé¢çš„å¹¶å‘é—®é¢˜ï¼Œæˆ‘ä»¬ç¨åå†è¿›è¡Œä»‹ç»ã€‚ åˆ°è¿™é‡Œ put æ“ä½œå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¯´ä¸€è¯´å…¶ä¸­å‡ æ­¥å…³é”®çš„æ“ä½œã€‚ åˆå§‹åŒ–æ§½: ensureSegmentConcurrentHashMap åˆå§‹åŒ–çš„æ—¶å€™ä¼šåˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ§½ segment[0]ï¼Œå¯¹äºå…¶ä»–æ§½æ¥è¯´ï¼Œåœ¨æ’å…¥ç¬¬ä¸€ä¸ªå€¼çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–ã€‚ è¿™é‡Œéœ€è¦è€ƒè™‘å¹¶å‘ï¼Œå› ä¸ºå¾ˆå¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›æ¥åˆå§‹åŒ–åŒä¸€ä¸ªæ§½ segment[k]ï¼Œä¸è¿‡åªè¦æœ‰ä¸€ä¸ªæˆåŠŸäº†å°±å¯ä»¥ã€‚ 1234567891011121314151617181920212223242526272829private Segment&lt;K,V&gt; ensureSegment(int k) &#123; final Segment&lt;K,V&gt;[] ss = this.segments; long u = (k &lt;&lt; SSHIFT) + SBASE; // raw offset Segment&lt;K,V&gt; seg; if ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) &#123; // è¿™é‡Œçœ‹åˆ°ä¸ºä»€ä¹ˆä¹‹å‰è¦åˆå§‹åŒ– segment[0] äº†ï¼Œ // ä½¿ç”¨å½“å‰ segment[0] å¤„çš„æ•°ç»„é•¿åº¦å’Œè´Ÿè½½å› å­æ¥åˆå§‹åŒ– segment[k] // ä¸ºä»€ä¹ˆè¦ç”¨â€œå½“å‰â€ï¼Œå› ä¸º segment[0] å¯èƒ½æ—©å°±æ‰©å®¹è¿‡äº† Segment&lt;K,V&gt; proto = ss[0]; int cap = proto.table.length; float lf = proto.loadFactor; int threshold = (int)(cap * lf); // åˆå§‹åŒ– segment[k] å†…éƒ¨çš„æ•°ç»„ HashEntry&lt;K,V&gt;[] tab = (HashEntry&lt;K,V&gt;[])new HashEntry[cap]; if ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) &#123; // å†æ¬¡æ£€æŸ¥ä¸€éè¯¥æ§½æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–äº†ã€‚ Segment&lt;K,V&gt; s = new Segment&lt;K,V&gt;(lf, threshold, tab); // ä½¿ç”¨ while å¾ªç¯ï¼Œå†…éƒ¨ç”¨ CASï¼Œå½“å‰çº¿ç¨‹æˆåŠŸè®¾å€¼æˆ–å…¶ä»–çº¿ç¨‹æˆåŠŸè®¾å€¼åï¼Œé€€å‡º while ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) &#123; if (UNSAFE.compareAndSwapObject(ss, u, null, seg = s)) break; &#125; &#125; &#125; return seg;&#125; æ€»çš„æ¥è¯´ï¼ŒensureSegment(int k) æ¯”è¾ƒç®€å•ï¼Œå¯¹äºå¹¶å‘æ“ä½œä½¿ç”¨ CAS è¿›è¡Œæ§åˆ¶ã€‚ è·å–å†™å…¥é”: scanAndLockForPutå‰é¢æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å¾€æŸä¸ª segment ä¸­ put çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨ node &#x3D; tryLock() ? null : scanAndLockForPut(key, hash, value)ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆè¿›è¡Œä¸€æ¬¡ tryLock() å¿«é€Ÿè·å–è¯¥ segment çš„ç‹¬å é”ï¼Œå¦‚æœå¤±è´¥ï¼Œé‚£ä¹ˆè¿›å…¥åˆ° scanAndLockForPut è¿™ä¸ªæ–¹æ³•æ¥è·å–é”ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“åˆ†æè¿™ä¸ªæ–¹æ³•ä¸­æ˜¯æ€ä¹ˆæ§åˆ¶åŠ é”çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839private HashEntry&lt;K,V&gt; scanAndLockForPut(K key, int hash, V value) &#123; HashEntry&lt;K,V&gt; first = entryForHash(this, hash); HashEntry&lt;K,V&gt; e = first; HashEntry&lt;K,V&gt; node = null; int retries = -1; // negative while locating node // å¾ªç¯è·å–é” while (!tryLock()) &#123; HashEntry&lt;K,V&gt; f; // to recheck first below if (retries &lt; 0) &#123; if (e == null) &#123; if (node == null) // speculatively create node // è¿›åˆ°è¿™é‡Œè¯´æ˜æ•°ç»„è¯¥ä½ç½®çš„é“¾è¡¨æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰ä»»ä½•å…ƒç´  // å½“ç„¶ï¼Œè¿›åˆ°è¿™é‡Œçš„å¦ä¸€ä¸ªåŸå› æ˜¯ tryLock() å¤±è´¥ï¼Œæ‰€ä»¥è¯¥æ§½å­˜åœ¨å¹¶å‘ï¼Œä¸ä¸€å®šæ˜¯è¯¥ä½ç½® node = new HashEntry&lt;K,V&gt;(hash, key, value, null); retries = 0; &#125; else if (key.equals(e.key)) retries = 0; else // é¡ºç€é“¾è¡¨å¾€ä¸‹èµ° e = e.next; &#125; // é‡è¯•æ¬¡æ•°å¦‚æœè¶…è¿‡ MAX_SCAN_RETRIES(å•æ ¸1å¤šæ ¸64)ï¼Œé‚£ä¹ˆä¸æŠ¢äº†ï¼Œè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ç­‰å¾…é” // lock() æ˜¯é˜»å¡æ–¹æ³•ï¼Œç›´åˆ°è·å–é”åè¿”å› else if (++retries &gt; MAX_SCAN_RETRIES) &#123; lock(); break; &#125; else if ((retries &amp; 1) == 0 &amp;&amp; // è¿™ä¸ªæ—¶å€™æ˜¯æœ‰å¤§é—®é¢˜äº†ï¼Œé‚£å°±æ˜¯æœ‰æ–°çš„å…ƒç´ è¿›åˆ°äº†é“¾è¡¨ï¼Œæˆä¸ºäº†æ–°çš„è¡¨å¤´ // æ‰€ä»¥è¿™è¾¹çš„ç­–ç•¥æ˜¯ï¼Œç›¸å½“äºé‡æ–°èµ°ä¸€éè¿™ä¸ª scanAndLockForPut æ–¹æ³• (f = entryForHash(this, hash)) != first) &#123; e = first = f; // re-traverse if entry changed retries = -1; &#125; &#125; return node;&#125; è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªå‡ºå£ï¼Œä¸€ä¸ªæ˜¯ tryLock() æˆåŠŸäº†ï¼Œå¾ªç¯ç»ˆæ­¢ï¼Œå¦ä¸€ä¸ªå°±æ˜¯é‡è¯•æ¬¡æ•°è¶…è¿‡äº† MAX_SCAN_RETRIESï¼Œè¿›åˆ° lock() æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æˆåŠŸæ‹¿åˆ°ç‹¬å é”ã€‚ è¿™ä¸ªæ–¹æ³•å°±æ˜¯çœ‹ä¼¼å¤æ‚ï¼Œä½†æ˜¯å…¶å®å°±æ˜¯åšäº†ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯è·å–è¯¥ segment çš„ç‹¬å é”ï¼Œå¦‚æœéœ€è¦çš„è¯é¡ºä¾¿å®ä¾‹åŒ–äº†ä¸€ä¸‹ nodeã€‚ æ‰©å®¹: rehashé‡å¤ä¸€ä¸‹ï¼Œsegment æ•°ç»„ä¸èƒ½æ‰©å®¹ï¼Œæ‰©å®¹æ˜¯ segment æ•°ç»„æŸä¸ªä½ç½®å†…éƒ¨çš„æ•°ç»„ HashEntry&lt;K,V&gt;[] è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹åï¼Œå®¹é‡ä¸ºåŸæ¥çš„ 2 å€ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬è¦å›é¡¾ä¸€ä¸‹è§¦å‘æ‰©å®¹çš„åœ°æ–¹ï¼Œput çš„æ—¶å€™ï¼Œå¦‚æœåˆ¤æ–­è¯¥å€¼çš„æ’å…¥ä¼šå¯¼è‡´è¯¥ segment çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡é˜ˆå€¼ï¼Œé‚£ä¹ˆå…ˆè¿›è¡Œæ‰©å®¹ï¼Œå†æ’å€¼ï¼Œè¯»è€…è¿™ä¸ªæ—¶å€™å¯ä»¥å›å» put æ–¹æ³•çœ‹ä¸€çœ¼ã€‚ è¯¥æ–¹æ³•ä¸éœ€è¦è€ƒè™‘å¹¶å‘ï¼Œå› ä¸ºåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ˜¯æŒæœ‰è¯¥ segment çš„ç‹¬å é”çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960// æ–¹æ³•å‚æ•°ä¸Šçš„ node æ˜¯è¿™æ¬¡æ‰©å®¹åï¼Œéœ€è¦æ·»åŠ åˆ°æ–°çš„æ•°ç»„ä¸­çš„æ•°æ®ã€‚private void rehash(HashEntry&lt;K,V&gt; node) &#123; HashEntry&lt;K,V&gt;[] oldTable = table; int oldCapacity = oldTable.length; // 2 å€ int newCapacity = oldCapacity &lt;&lt; 1; threshold = (int)(newCapacity * loadFactor); // åˆ›å»ºæ–°æ•°ç»„ HashEntry&lt;K,V&gt;[] newTable = (HashEntry&lt;K,V&gt;[]) new HashEntry[newCapacity]; // æ–°çš„æ©ç ï¼Œå¦‚ä» 16 æ‰©å®¹åˆ° 32ï¼Œé‚£ä¹ˆ sizeMask ä¸º 31ï¼Œå¯¹åº”äºŒè¿›åˆ¶ â€˜000...00011111â€™ int sizeMask = newCapacity - 1; // éå†åŸæ•°ç»„ï¼Œè€å¥—è·¯ï¼Œå°†åŸæ•°ç»„ä½ç½® i å¤„çš„é“¾è¡¨æ‹†åˆ†åˆ° æ–°æ•°ç»„ä½ç½® i å’Œ i+oldCap ä¸¤ä¸ªä½ç½® for (int i = 0; i &lt; oldCapacity ; i++) &#123; // e æ˜¯é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´  HashEntry&lt;K,V&gt; e = oldTable[i]; if (e != null) &#123; HashEntry&lt;K,V&gt; next = e.next; // è®¡ç®—åº”è¯¥æ”¾ç½®åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®ï¼Œ // å‡è®¾åŸæ•°ç»„é•¿åº¦ä¸º 16ï¼Œe åœ¨ oldTable[3] å¤„ï¼Œé‚£ä¹ˆ idx åªå¯èƒ½æ˜¯ 3 æˆ–è€…æ˜¯ 3 + 16 = 19 int idx = e.hash &amp; sizeMask; if (next == null) // è¯¥ä½ç½®å¤„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œé‚£æ¯”è¾ƒå¥½åŠ newTable[idx] = e; else &#123; // Reuse consecutive sequence at same slot // e æ˜¯é“¾è¡¨è¡¨å¤´ HashEntry&lt;K,V&gt; lastRun = e; // idx æ˜¯å½“å‰é“¾è¡¨çš„å¤´èŠ‚ç‚¹ e çš„æ–°ä½ç½® int lastIdx = idx; // ä¸‹é¢è¿™ä¸ª for å¾ªç¯ä¼šæ‰¾åˆ°ä¸€ä¸ª lastRun èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¹‹åçš„æ‰€æœ‰å…ƒç´ æ˜¯å°†è¦æ”¾åˆ°ä¸€èµ·çš„ for (HashEntry&lt;K,V&gt; last = next; last != null; last = last.next) &#123; int k = last.hash &amp; sizeMask; if (k != lastIdx) &#123; lastIdx = k; lastRun = last; &#125; &#125; // å°† lastRun åŠå…¶ä¹‹åçš„æ‰€æœ‰èŠ‚ç‚¹ç»„æˆçš„è¿™ä¸ªé“¾è¡¨æ”¾åˆ° lastIdx è¿™ä¸ªä½ç½® newTable[lastIdx] = lastRun; // ä¸‹é¢çš„æ“ä½œæ˜¯å¤„ç† lastRun ä¹‹å‰çš„èŠ‚ç‚¹ï¼Œ // è¿™äº›èŠ‚ç‚¹å¯èƒ½åˆ†é…åœ¨å¦ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œä¹Ÿå¯èƒ½åˆ†é…åˆ°ä¸Šé¢çš„é‚£ä¸ªé“¾è¡¨ä¸­ for (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123; V v = p.value; int h = p.hash; int k = h &amp; sizeMask; HashEntry&lt;K,V&gt; n = newTable[k]; newTable[k] = new HashEntry&lt;K,V&gt;(h, p.key, v, n); &#125; &#125; &#125; &#125; // å°†æ–°æ¥çš„ node æ”¾åˆ°æ–°æ•°ç»„ä¸­åˆšåˆšçš„ ä¸¤ä¸ªé“¾è¡¨ä¹‹ä¸€ çš„ å¤´éƒ¨ int nodeIndex = node.hash &amp; sizeMask; // add the new node node.setNext(newTable[nodeIndex]); newTable[nodeIndex] = node; table = newTable;&#125; è¿™é‡Œçš„æ‰©å®¹æ¯”ä¹‹å‰çš„ HashMap è¦å¤æ‚ä¸€äº›ï¼Œä»£ç éš¾æ‡‚ä¸€ç‚¹ã€‚ä¸Šé¢æœ‰ä¸¤ä¸ªæŒ¨ç€çš„ for å¾ªç¯ï¼Œç¬¬ä¸€ä¸ª for æœ‰ä»€ä¹ˆç”¨å‘¢? ä»”ç»†ä¸€çœ‹å‘ç°ï¼Œå¦‚æœæ²¡æœ‰ç¬¬ä¸€ä¸ª for å¾ªç¯ï¼Œä¹Ÿæ˜¯å¯ä»¥å·¥ä½œçš„ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ª for å¾ªç¯ä¸‹æ¥ï¼Œå¦‚æœ lastRun çš„åé¢è¿˜æœ‰æ¯”è¾ƒå¤šçš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™æ¬¡å°±æ˜¯å€¼å¾—çš„ã€‚å› ä¸ºæˆ‘ä»¬åªéœ€è¦å…‹éš† lastRun å‰é¢çš„èŠ‚ç‚¹ï¼Œåé¢çš„ä¸€ä¸²èŠ‚ç‚¹è·Ÿç€ lastRun èµ°å°±æ˜¯äº†ï¼Œä¸éœ€è¦åšä»»ä½•æ“ä½œã€‚ æˆ‘è§‰å¾— Doug Lea çš„è¿™ä¸ªæƒ³æ³•ä¹Ÿæ˜¯æŒºæœ‰æ„æ€çš„ï¼Œä¸è¿‡æ¯”è¾ƒåçš„æƒ…å†µå°±æ˜¯æ¯æ¬¡ lastRun éƒ½æ˜¯é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ æˆ–è€…å¾ˆé åçš„å…ƒç´ ï¼Œé‚£ä¹ˆè¿™æ¬¡éå†å°±æœ‰ç‚¹æµªè´¹äº†ã€‚ä¸è¿‡ Doug Lea ä¹Ÿè¯´äº†ï¼Œæ ¹æ®ç»Ÿè®¡ï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„é˜ˆå€¼ï¼Œå¤§çº¦åªæœ‰ 1&#x2F;6 çš„èŠ‚ç‚¹éœ€è¦å…‹éš†ã€‚ get è¿‡ç¨‹åˆ†æç›¸å¯¹äº put æ¥è¯´ï¼Œget å°±å¾ˆç®€å•äº†ã€‚ è®¡ç®— hash å€¼ï¼Œæ‰¾åˆ° segment æ•°ç»„ä¸­çš„å…·ä½“ä½ç½®ï¼Œæˆ–æˆ‘ä»¬å‰é¢ç”¨çš„â€œæ§½â€ æ§½ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ ¹æ® hash æ‰¾åˆ°æ•°ç»„ä¸­å…·ä½“çš„ä½ç½® åˆ°è¿™é‡Œæ˜¯é“¾è¡¨äº†ï¼Œé¡ºç€é“¾è¡¨è¿›è¡ŒæŸ¥æ‰¾å³å¯ 1234567891011121314151617181920public V get(Object key) &#123; Segment&lt;K,V&gt; s; // manually integrate access methods to reduce overhead HashEntry&lt;K,V&gt;[] tab; // 1. hash å€¼ int h = hash(key); long u = (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE; // 2. æ ¹æ® hash æ‰¾åˆ°å¯¹åº”çš„ segment if ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != null &amp;&amp; (tab = s.table) != null) &#123; // 3. æ‰¾åˆ°segment å†…éƒ¨æ•°ç»„ç›¸åº”ä½ç½®çš„é“¾è¡¨ï¼Œéå† for (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile (tab, ((long)(((tab.length - 1) &amp; h)) &lt;&lt; TSHIFT) + TBASE); e != null; e = e.next) &#123; K k; if ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k))) return e.value; &#125; &#125; return null;&#125; å¹¶å‘é—®é¢˜åˆ†æç°åœ¨æˆ‘ä»¬å·²ç»è¯´å®Œäº† put è¿‡ç¨‹å’Œ get è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° get è¿‡ç¨‹ä¸­æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œé‚£è‡ªç„¶æˆ‘ä»¬å°±éœ€è¦å»è€ƒè™‘å¹¶å‘é—®é¢˜ã€‚ æ·»åŠ èŠ‚ç‚¹çš„æ“ä½œ put å’Œåˆ é™¤èŠ‚ç‚¹çš„æ“ä½œ remove éƒ½æ˜¯è¦åŠ  segment ä¸Šçš„ç‹¬å é”çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¹‹é—´è‡ªç„¶ä¸ä¼šæœ‰é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é—®é¢˜å°±æ˜¯ get çš„æ—¶å€™åœ¨åŒä¸€ä¸ª segment ä¸­å‘ç”Ÿäº† put æˆ– remove æ“ä½œã€‚ put æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚ åˆå§‹åŒ–æ§½ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰å°±è¯´è¿‡äº†ï¼Œä½¿ç”¨äº† CAS æ¥åˆå§‹åŒ– Segment ä¸­çš„æ•°ç»„ã€‚ æ·»åŠ èŠ‚ç‚¹åˆ°é“¾è¡¨çš„æ“ä½œæ˜¯æ’å…¥åˆ°è¡¨å¤´çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ get æ“ä½œåœ¨é“¾è¡¨éå†çš„è¿‡ç¨‹å·²ç»åˆ°äº†ä¸­é—´ï¼Œæ˜¯ä¸ä¼šå½±å“çš„ã€‚å½“ç„¶ï¼Œå¦ä¸€ä¸ªå¹¶å‘é—®é¢˜å°±æ˜¯ get æ“ä½œåœ¨ put ä¹‹åï¼Œéœ€è¦ä¿è¯åˆšåˆšæ’å…¥è¡¨å¤´çš„èŠ‚ç‚¹è¢«è¯»å–ï¼Œè¿™ä¸ªä¾èµ–äº setEntryAt æ–¹æ³•ä¸­ä½¿ç”¨çš„ UNSAFE.putOrderedObjectã€‚ æ‰©å®¹ã€‚æ‰©å®¹æ˜¯æ–°åˆ›å»ºäº†æ•°ç»„ï¼Œç„¶åè¿›è¡Œè¿ç§»æ•°æ®ï¼Œæœ€åé¢å°† newTable è®¾ç½®ç»™å±æ€§ tableã€‚æ‰€ä»¥ï¼Œå¦‚æœ get æ“ä½œæ­¤æ—¶ä¹Ÿåœ¨è¿›è¡Œï¼Œé‚£ä¹ˆä¹Ÿæ²¡å…³ç³»ï¼Œå¦‚æœ get å…ˆè¡Œï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨æ—§çš„ table ä¸ŠåšæŸ¥è¯¢æ“ä½œï¼›è€Œ put å…ˆè¡Œï¼Œé‚£ä¹ˆ put æ“ä½œçš„å¯è§æ€§ä¿è¯å°±æ˜¯ table ä½¿ç”¨äº† volatile å…³é”®å­—ã€‚ remove æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚ remove æ“ä½œæˆ‘ä»¬æ²¡æœ‰åˆ†ææºç ï¼Œæ‰€ä»¥è¿™é‡Œè¯´çš„è¯»è€…æ„Ÿå…´è¶£çš„è¯è¿˜æ˜¯éœ€è¦åˆ°æºç ä¸­å»æ±‚å®ä¸€ä¸‹çš„ã€‚ get æ“ä½œéœ€è¦éå†é“¾è¡¨ï¼Œä½†æ˜¯ remove æ“ä½œä¼šâ€ç ´åâ€é“¾è¡¨ã€‚ å¦‚æœ remove ç ´åçš„èŠ‚ç‚¹ get æ“ä½œå·²ç»è¿‡å»äº†ï¼Œé‚£ä¹ˆè¿™é‡Œä¸å­˜åœ¨ä»»ä½•é—®é¢˜ã€‚ å¦‚æœ remove å…ˆç ´åäº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ†ä¸¤ç§æƒ…å†µè€ƒè™‘ã€‚ 1ã€å¦‚æœæ­¤èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œé‚£ä¹ˆéœ€è¦å°†å¤´èŠ‚ç‚¹çš„ next è®¾ç½®ä¸ºæ•°ç»„è¯¥ä½ç½®çš„å…ƒç´ ï¼Œtable è™½ç„¶ä½¿ç”¨äº† volatile ä¿®é¥°ï¼Œä½†æ˜¯ volatile å¹¶ä¸èƒ½æä¾›æ•°ç»„å†…éƒ¨æ“ä½œçš„å¯è§æ€§ä¿è¯ï¼Œæ‰€ä»¥æºç ä¸­ä½¿ç”¨äº† UNSAFE æ¥æ“ä½œæ•°ç»„ï¼Œè¯·çœ‹æ–¹æ³• setEntryAtã€‚2ã€å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œå®ƒä¼šå°†è¦åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ¥åˆ°å‰é©±èŠ‚ç‚¹ä¸­ï¼Œè¿™é‡Œçš„å¹¶å‘ä¿è¯å°±æ˜¯ next å±æ€§æ˜¯ volatile çš„ã€‚ ConcurrentHashMap - JDK 1.8åœ¨JDK1.7ä¹‹å‰ï¼ŒConcurrentHashMapæ˜¯é€šè¿‡åˆ†æ®µé”æœºåˆ¶æ¥å®ç°çš„ï¼Œæ‰€ä»¥å…¶æœ€å¤§å¹¶å‘åº¦å—Segmentçš„ä¸ªæ•°é™åˆ¶ã€‚å› æ­¤ï¼Œåœ¨JDK1.8ä¸­ï¼ŒConcurrentHashMapçš„å®ç°åŸç†æ‘’å¼ƒäº†è¿™ç§è®¾è®¡ï¼Œè€Œæ˜¯é€‰æ‹©äº†ä¸HashMapç±»ä¼¼çš„æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ–¹å¼å®ç°ï¼Œè€ŒåŠ é”åˆ™é‡‡ç”¨CASå’Œsynchronizedå®ç°ã€‚ æ•°æ®ç»“æ„ ç»“æ„ä¸Šå’Œ Java8 çš„ HashMap åŸºæœ¬ä¸Šä¸€æ ·ï¼Œä¸è¿‡å®ƒè¦ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œæ‰€ä»¥åœ¨æºç ä¸Šç¡®å®è¦å¤æ‚ä¸€äº›ã€‚ åˆå§‹åŒ–1234567891011// è¿™æ„é€ å‡½æ•°é‡Œï¼Œä»€ä¹ˆéƒ½ä¸å¹²public ConcurrentHashMap() &#123;&#125;public ConcurrentHashMap(int initialCapacity) &#123; if (initialCapacity &lt; 0) throw new IllegalArgumentException(); int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)); this.sizeCtl = cap;&#125; è¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•æœ‰ç‚¹æ„æ€ï¼Œé€šè¿‡æä¾›åˆå§‹å®¹é‡ï¼Œè®¡ç®—äº† sizeCtlï¼ŒsizeCtl &#x3D; ã€ (1.5 * initialCapacity + 1)ï¼Œç„¶åå‘ä¸Šå–æœ€è¿‘çš„ 2 çš„ n æ¬¡æ–¹ã€‘ã€‚å¦‚ initialCapacity ä¸º 10ï¼Œé‚£ä¹ˆå¾—åˆ° sizeCtl ä¸º 16ï¼Œå¦‚æœ initialCapacity ä¸º 11ï¼Œå¾—åˆ° sizeCtl ä¸º 32ã€‚ sizeCtl è¿™ä¸ªå±æ€§ä½¿ç”¨çš„åœºæ™¯å¾ˆå¤šï¼Œä¸è¿‡åªè¦è·Ÿç€æ–‡ç« çš„æ€è·¯æ¥ï¼Œå°±ä¸ä¼šè¢«å®ƒææ™•äº†ã€‚ put è¿‡ç¨‹åˆ†æä»”ç»†åœ°ä¸€è¡Œä¸€è¡Œä»£ç çœ‹ä¸‹å»: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091public V put(K key, V value) &#123; return putVal(key, value, false);&#125;final V putVal(K key, V value, boolean onlyIfAbsent) &#123; if (key == null || value == null) throw new NullPointerException(); // å¾—åˆ° hash å€¼ int hash = spread(key.hashCode()); // ç”¨äºè®°å½•ç›¸åº”é“¾è¡¨çš„é•¿åº¦ int binCount = 0; for (Node&lt;K,V&gt;[] tab = table;;) &#123; Node&lt;K,V&gt; f; int n, i, fh; // å¦‚æœæ•°ç»„&quot;ç©º&quot;ï¼Œè¿›è¡Œæ•°ç»„åˆå§‹åŒ– if (tab == null || (n = tab.length) == 0) // åˆå§‹åŒ–æ•°ç»„ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç» tab = initTable(); // æ‰¾è¯¥ hash å€¼å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¾—åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ f else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123; // å¦‚æœæ•°ç»„è¯¥ä½ç½®ä¸ºç©ºï¼Œ // ç”¨ä¸€æ¬¡ CAS æ“ä½œå°†è¿™ä¸ªæ–°å€¼æ”¾å…¥å…¶ä¸­å³å¯ï¼Œè¿™ä¸ª put æ“ä½œå·®ä¸å¤šå°±ç»“æŸäº†ï¼Œå¯ä»¥æ‹‰åˆ°æœ€åé¢äº† // å¦‚æœ CAS å¤±è´¥ï¼Œé‚£å°±æ˜¯æœ‰å¹¶å‘æ“ä½œï¼Œè¿›åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯å°±å¥½äº† if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value, null))) break; // no lock when adding to empty bin &#125; // hash å±…ç„¶å¯ä»¥ç­‰äº MOVEDï¼Œè¿™ä¸ªéœ€è¦åˆ°åé¢æ‰èƒ½çœ‹æ˜ç™½ï¼Œä¸è¿‡ä»åå­—ä¸Šä¹Ÿèƒ½çŒœåˆ°ï¼Œè‚¯å®šæ˜¯å› ä¸ºåœ¨æ‰©å®¹ else if ((fh = f.hash) == MOVED) // å¸®åŠ©æ•°æ®è¿ç§»ï¼Œè¿™ä¸ªç­‰åˆ°çœ‹å®Œæ•°æ®è¿ç§»éƒ¨åˆ†çš„ä»‹ç»åï¼Œå†ç†è§£è¿™ä¸ªå°±å¾ˆç®€å•äº† tab = helpTransfer(tab, f); else &#123; // åˆ°è¿™é‡Œå°±æ˜¯è¯´ï¼Œf æ˜¯è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹ï¼Œè€Œä¸”ä¸ä¸ºç©º V oldVal = null; // è·å–æ•°ç»„è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹çš„ç›‘è§†å™¨é” synchronized (f) &#123; if (tabAt(tab, i) == f) &#123; if (fh &gt;= 0) &#123; // å¤´èŠ‚ç‚¹çš„ hash å€¼å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨ // ç”¨äºç´¯åŠ ï¼Œè®°å½•é“¾è¡¨çš„é•¿åº¦ binCount = 1; // éå†é“¾è¡¨ for (Node&lt;K,V&gt; e = f;; ++binCount) &#123; K ek; // å¦‚æœå‘ç°äº†&quot;ç›¸ç­‰&quot;çš„ keyï¼Œåˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œå€¼è¦†ç›–ï¼Œç„¶åä¹Ÿå°±å¯ä»¥ break äº† if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) &#123; oldVal = e.val; if (!onlyIfAbsent) e.val = value; break; &#125; // åˆ°äº†é“¾è¡¨çš„æœ€æœ«ç«¯ï¼Œå°†è¿™ä¸ªæ–°å€¼æ”¾åˆ°é“¾è¡¨çš„æœ€åé¢ Node&lt;K,V&gt; pred = e; if ((e = e.next) == null) &#123; pred.next = new Node&lt;K,V&gt;(hash, key, value, null); break; &#125; &#125; &#125; else if (f instanceof TreeBin) &#123; // çº¢é»‘æ ‘ Node&lt;K,V&gt; p; binCount = 2; // è°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•æ’å…¥æ–°èŠ‚ç‚¹ if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != null) &#123; oldVal = p.val; if (!onlyIfAbsent) p.val = value; &#125; &#125; &#125; &#125; if (binCount != 0) &#123; // åˆ¤æ–­æ˜¯å¦è¦å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œä¸´ç•Œå€¼å’Œ HashMap ä¸€æ ·ï¼Œä¹Ÿæ˜¯ 8 if (binCount &gt;= TREEIFY_THRESHOLD) // è¿™ä¸ªæ–¹æ³•å’Œ HashMap ä¸­ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ä¸åŒï¼Œé‚£å°±æ˜¯å®ƒä¸æ˜¯ä¸€å®šä¼šè¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œ // å¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©è¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ // å…·ä½“æºç æˆ‘ä»¬å°±ä¸çœ‹äº†ï¼Œæ‰©å®¹éƒ¨åˆ†åé¢è¯´ treeifyBin(tab, i); if (oldVal != null) return oldVal; break; &#125; &#125; &#125; // addCount(1L, binCount); return null;&#125; åˆå§‹åŒ–æ•°ç»„: initTableè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ï¼Œç„¶åä¼šè®¾ç½® sizeCtlã€‚ åˆå§‹åŒ–æ–¹æ³•ä¸­çš„å¹¶å‘é—®é¢˜æ˜¯é€šè¿‡å¯¹ sizeCtl è¿›è¡Œä¸€ä¸ª CAS æ“ä½œæ¥æ§åˆ¶çš„ã€‚ 1234567891011121314151617181920212223242526272829private final Node&lt;K,V&gt;[] initTable() &#123; Node&lt;K,V&gt;[] tab; int sc; while ((tab = table) == null || tab.length == 0) &#123; // åˆå§‹åŒ–çš„&quot;åŠŸåŠ³&quot;è¢«å…¶ä»–çº¿ç¨‹&quot;æŠ¢å»&quot;äº† if ((sc = sizeCtl) &lt; 0) Thread.yield(); // lost initialization race; just spin // CAS ä¸€ä¸‹ï¼Œå°† sizeCtl è®¾ç½®ä¸º -1ï¼Œä»£è¡¨æŠ¢åˆ°äº†é” else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; if ((tab = table) == null || tab.length == 0) &#123; // DEFAULT_CAPACITY é»˜è®¤åˆå§‹å®¹é‡æ˜¯ 16 int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY; // åˆå§‹åŒ–æ•°ç»„ï¼Œé•¿åº¦ä¸º 16 æˆ–åˆå§‹åŒ–æ—¶æä¾›çš„é•¿åº¦ Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; // å°†è¿™ä¸ªæ•°ç»„èµ‹å€¼ç»™ tableï¼Œtable æ˜¯ volatile çš„ table = tab = nt; // å¦‚æœ n ä¸º 16 çš„è¯ï¼Œé‚£ä¹ˆè¿™é‡Œ sc = 12 // å…¶å®å°±æ˜¯ 0.75 * n sc = n - (n &gt;&gt;&gt; 2); &#125; &#125; finally &#123; // è®¾ç½® sizeCtl ä¸º scï¼Œæˆ‘ä»¬å°±å½“æ˜¯ 12 å§ sizeCtl = sc; &#125; break; &#125; &#125; return tab;&#125; é“¾è¡¨è½¬çº¢é»‘æ ‘: treeifyBinå‰é¢æˆ‘ä»¬åœ¨ put æºç åˆ†æä¹Ÿè¯´è¿‡ï¼ŒtreeifyBin ä¸ä¸€å®šå°±ä¼šè¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»…ä»…åšæ•°ç»„æ‰©å®¹ã€‚æˆ‘ä»¬è¿˜æ˜¯è¿›è¡Œæºç åˆ†æå§ã€‚ 123456789101112131415161718192021222324252627282930313233private final void treeifyBin(Node&lt;K,V&gt;[] tab, int index) &#123; Node&lt;K,V&gt; b; int n, sc; if (tab != null) &#123; // MIN_TREEIFY_CAPACITY ä¸º 64 // æ‰€ä»¥ï¼Œå¦‚æœæ•°ç»„é•¿åº¦å°äº 64 çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ 32 æˆ–è€… 16 æˆ–è€…æ›´å°çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œæ•°ç»„æ‰©å®¹ if ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY) // åé¢æˆ‘ä»¬å†è¯¦ç»†åˆ†æè¿™ä¸ªæ–¹æ³• tryPresize(n &lt;&lt; 1); // b æ˜¯å¤´èŠ‚ç‚¹ else if ((b = tabAt(tab, index)) != null &amp;&amp; b.hash &gt;= 0) &#123; // åŠ é” synchronized (b) &#123; if (tabAt(tab, index) == b) &#123; // ä¸‹é¢å°±æ˜¯éå†é“¾è¡¨ï¼Œå»ºç«‹ä¸€é¢—çº¢é»‘æ ‘ TreeNode&lt;K,V&gt; hd = null, tl = null; for (Node&lt;K,V&gt; e = b; e != null; e = e.next) &#123; TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt;(e.hash, e.key, e.val, null, null); if ((p.prev = tl) == null) hd = p; else tl.next = p; tl = p; &#125; // å°†çº¢é»‘æ ‘è®¾ç½®åˆ°æ•°ç»„ç›¸åº”ä½ç½®ä¸­ setTabAt(tab, index, new TreeBin&lt;K,V&gt;(hd)); &#125; &#125; &#125; &#125;&#125; æ‰©å®¹: tryPresizeå¦‚æœè¯´ Java8 ConcurrentHashMap çš„æºç ä¸ç®€å•ï¼Œé‚£ä¹ˆè¯´çš„å°±æ˜¯æ‰©å®¹æ“ä½œå’Œè¿ç§»æ“ä½œã€‚ è¿™ä¸ªæ–¹æ³•è¦å®Œå®Œå…¨å…¨çœ‹æ‡‚è¿˜éœ€è¦çœ‹ä¹‹åçš„ transfer æ–¹æ³•ï¼Œè¯»è€…åº”è¯¥æå‰çŸ¥é“è¿™ç‚¹ã€‚ è¿™é‡Œçš„æ‰©å®¹ä¹Ÿæ˜¯åšç¿»å€æ‰©å®¹çš„ï¼Œæ‰©å®¹åæ•°ç»„å®¹é‡ä¸ºåŸæ¥çš„ 2 å€ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// é¦–å…ˆè¦è¯´æ˜çš„æ˜¯ï¼Œæ–¹æ³•å‚æ•° size ä¼ è¿›æ¥çš„æ—¶å€™å°±å·²ç»ç¿»äº†å€äº†private final void tryPresize(int size) &#123; // c: size çš„ 1.5 å€ï¼Œå†åŠ  1ï¼Œå†å¾€ä¸Šå–æœ€è¿‘çš„ 2 çš„ n æ¬¡æ–¹ã€‚ int c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(size + (size &gt;&gt;&gt; 1) + 1); int sc; while ((sc = sizeCtl) &gt;= 0) &#123; Node&lt;K,V&gt;[] tab = table; int n; // è¿™ä¸ª if åˆ†æ”¯å’Œä¹‹å‰è¯´çš„åˆå§‹åŒ–æ•°ç»„çš„ä»£ç åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨ç®¡è¿™å—ä»£ç  if (tab == null || (n = tab.length) == 0) &#123; n = (sc &gt; c) ? sc : c; if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123; try &#123; if (table == tab) &#123; @SuppressWarnings(&quot;unchecked&quot;) Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n]; table = nt; sc = n - (n &gt;&gt;&gt; 2); // 0.75 * n &#125; &#125; finally &#123; sizeCtl = sc; &#125; &#125; &#125; else if (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY) break; else if (tab == table) &#123; // æˆ‘æ²¡çœ‹æ‡‚ rs çš„çœŸæ­£å«ä¹‰æ˜¯ä»€ä¹ˆï¼Œä¸è¿‡ä¹Ÿå…³ç³»ä¸å¤§ int rs = resizeStamp(n); if (sc &lt; 0) &#123; Node&lt;K,V&gt;[] nt; if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0) break; // 2. ç”¨ CAS å°† sizeCtl åŠ  1ï¼Œç„¶åæ‰§è¡Œ transfer æ–¹æ³• // æ­¤æ—¶ nextTab ä¸ä¸º null if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) transfer(tab, nt); &#125; // 1. å°† sizeCtl è®¾ç½®ä¸º (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2) // æˆ‘æ˜¯æ²¡çœ‹æ‡‚è¿™ä¸ªå€¼çœŸæ­£çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ? ä¸è¿‡å¯ä»¥è®¡ç®—å‡ºæ¥çš„æ˜¯ï¼Œç»“æœæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„è´Ÿæ•° // è°ƒç”¨ transfer æ–¹æ³•ï¼Œæ­¤æ—¶ nextTab å‚æ•°ä¸º null else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)) transfer(tab, null); &#125; &#125;&#125; è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒåœ¨äº sizeCtl å€¼çš„æ“ä½œï¼Œé¦–å…ˆå°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼Œç„¶åæ‰§è¡Œ transfer(tab, null)ï¼Œå†ä¸‹ä¸€ä¸ªå¾ªç¯å°† sizeCtl åŠ  1ï¼Œå¹¶æ‰§è¡Œ transfer(tab, nt)ï¼Œä¹‹åå¯èƒ½æ˜¯ç»§ç»­ sizeCtl åŠ  1ï¼Œå¹¶æ‰§è¡Œ transfer(tab, nt)ã€‚ æ‰€ä»¥ï¼Œå¯èƒ½çš„æ“ä½œå°±æ˜¯æ‰§è¡Œ 1 æ¬¡ transfer(tab, null) + å¤šæ¬¡ transfer(tab, nt)ï¼Œè¿™é‡Œæ€ä¹ˆç»“æŸå¾ªç¯çš„éœ€è¦çœ‹å®Œ transfer æºç æ‰æ¸…æ¥šã€‚ æ•°æ®è¿ç§»: transferä¸‹é¢è¿™ä¸ªæ–¹æ³•æœ‰ç‚¹é•¿ï¼Œå°†åŸæ¥çš„ tab æ•°ç»„çš„å…ƒç´ è¿ç§»åˆ°æ–°çš„ nextTab æ•°ç»„ä¸­ã€‚ è™½ç„¶æˆ‘ä»¬ä¹‹å‰è¯´çš„ tryPresize æ–¹æ³•ä¸­å¤šæ¬¡è°ƒç”¨ transfer ä¸æ¶‰åŠå¤šçº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ª transfer æ–¹æ³•å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è¢«è°ƒç”¨ï¼Œå…¸å‹åœ°ï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨è¯´ put æ–¹æ³•çš„æ—¶å€™å°±è¯´è¿‡äº†ï¼Œè¯·å¾€ä¸Šçœ‹ put æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸ªåœ°æ–¹è°ƒç”¨äº† helpTransfer æ–¹æ³•ï¼ŒhelpTransfer æ–¹æ³•ä¼šè°ƒç”¨ transfer æ–¹æ³•çš„ã€‚ æ­¤æ–¹æ³•æ”¯æŒå¤šçº¿ç¨‹æ‰§è¡Œï¼Œå¤–å›´è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šä¿è¯ç¬¬ä¸€ä¸ªå‘èµ·æ•°æ®è¿ç§»çš„çº¿ç¨‹ï¼ŒnextTab å‚æ•°ä¸º nullï¼Œä¹‹åå†è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™ï¼ŒnextTab ä¸ä¼šä¸º nullã€‚ é˜…è¯»æºç ä¹‹å‰ï¼Œå…ˆè¦ç†è§£å¹¶å‘æ“ä½œçš„æœºåˆ¶ã€‚åŸæ•°ç»„é•¿åº¦ä¸º nï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ n ä¸ªè¿ç§»ä»»åŠ¡ï¼Œè®©æ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è´Ÿè´£ä¸€ä¸ªå°ä»»åŠ¡æ˜¯æœ€ç®€å•çš„ï¼Œæ¯åšå®Œä¸€ä¸ªä»»åŠ¡å†æ£€æµ‹æ˜¯å¦æœ‰å…¶ä»–æ²¡åšå®Œçš„ä»»åŠ¡ï¼Œå¸®åŠ©è¿ç§»å°±å¯ä»¥äº†ï¼Œè€Œ Doug Lea ä½¿ç”¨äº†ä¸€ä¸ª strideï¼Œç®€å•ç†è§£å°±æ˜¯æ­¥é•¿ï¼Œæ¯ä¸ªçº¿ç¨‹æ¯æ¬¡è´Ÿè´£è¿ç§»å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æ¯æ¬¡è¿ç§» 16 ä¸ªå°ä»»åŠ¡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªå…¨å±€çš„è°ƒåº¦è€…æ¥å®‰æ’å“ªä¸ªçº¿ç¨‹æ‰§è¡Œå“ªå‡ ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªå°±æ˜¯å±æ€§ transferIndex çš„ä½œç”¨ã€‚ ç¬¬ä¸€ä¸ªå‘èµ·æ•°æ®è¿ç§»çš„çº¿ç¨‹ä¼šå°† transferIndex æŒ‡å‘åŸæ•°ç»„æœ€åçš„ä½ç½®ï¼Œç„¶åä»åå¾€å‰çš„ stride ä¸ªä»»åŠ¡å±äºç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åå°† transferIndex æŒ‡å‘æ–°çš„ä½ç½®ï¼Œå†å¾€å‰çš„ stride ä¸ªä»»åŠ¡å±äºç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œä¾æ­¤ç±»æ¨ã€‚å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ç¬¬äºŒä¸ªçº¿ç¨‹ä¸æ˜¯çœŸçš„ä¸€å®šæŒ‡ä»£äº†ç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªè¯»è€…åº”è¯¥èƒ½ç†è§£å§ã€‚å…¶å®å°±æ˜¯å°†ä¸€ä¸ªå¤§çš„è¿ç§»ä»»åŠ¡åˆ†ä¸ºäº†ä¸€ä¸ªä¸ªä»»åŠ¡åŒ…ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123; int n = tab.length, stride; // stride åœ¨å•æ ¸ä¸‹ç›´æ¥ç­‰äº nï¼Œå¤šæ ¸æ¨¡å¼ä¸‹ä¸º (n&gt;&gt;&gt;3)/NCPUï¼Œæœ€å°å€¼æ˜¯ 16 // stride å¯ä»¥ç†è§£ä¸ºâ€æ­¥é•¿â€œï¼Œæœ‰ n ä¸ªä½ç½®æ˜¯éœ€è¦è¿›è¡Œè¿ç§»çš„ï¼Œ // å°†è¿™ n ä¸ªä»»åŠ¡åˆ†ä¸ºå¤šä¸ªä»»åŠ¡åŒ…ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…æœ‰ stride ä¸ªä»»åŠ¡ if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE) stride = MIN_TRANSFER_STRIDE; // subdivide range // å¦‚æœ nextTab ä¸º nullï¼Œå…ˆè¿›è¡Œä¸€æ¬¡åˆå§‹åŒ– // å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œå¤–å›´ä¼šä¿è¯ç¬¬ä¸€ä¸ªå‘èµ·è¿ç§»çš„çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œå‚æ•° nextTab ä¸º null // ä¹‹åå‚ä¸è¿ç§»çš„çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼ŒnextTab ä¸ä¼šä¸º null if (nextTab == null) &#123; try &#123; // å®¹é‡ç¿»å€ Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1]; nextTab = nt; &#125; catch (Throwable ex) &#123; // try to cope with OOME sizeCtl = Integer.MAX_VALUE; return; &#125; // nextTable æ˜¯ ConcurrentHashMap ä¸­çš„å±æ€§ nextTable = nextTab; // transferIndex ä¹Ÿæ˜¯ ConcurrentHashMap çš„å±æ€§ï¼Œç”¨äºæ§åˆ¶è¿ç§»çš„ä½ç½® transferIndex = n; &#125; int nextn = nextTab.length; // ForwardingNode ç¿»è¯‘è¿‡æ¥å°±æ˜¯æ­£åœ¨è¢«è¿ç§»çš„ Node // è¿™ä¸ªæ„é€ æ–¹æ³•ä¼šç”Ÿæˆä¸€ä¸ªNodeï¼Œkeyã€value å’Œ next éƒ½ä¸º nullï¼Œå…³é”®æ˜¯ hash ä¸º MOVED // åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒåŸæ•°ç»„ä¸­ä½ç½® i å¤„çš„èŠ‚ç‚¹å®Œæˆè¿ç§»å·¥ä½œåï¼Œ // å°±ä¼šå°†ä½ç½® i å¤„è®¾ç½®ä¸ºè¿™ä¸ª ForwardingNodeï¼Œç”¨æ¥å‘Šè¯‰å…¶ä»–çº¿ç¨‹è¯¥ä½ç½®å·²ç»å¤„ç†è¿‡äº† // æ‰€ä»¥å®ƒå…¶å®ç›¸å½“äºæ˜¯ä¸€ä¸ªæ ‡å¿—ã€‚ ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab); // advance æŒ‡çš„æ˜¯åšå®Œäº†ä¸€ä¸ªä½ç½®çš„è¿ç§»å·¥ä½œï¼Œå¯ä»¥å‡†å¤‡åšä¸‹ä¸€ä¸ªä½ç½®çš„äº† boolean advance = true; boolean finishing = false; // to ensure sweep before committing nextTab /* * ä¸‹é¢è¿™ä¸ª for å¾ªç¯ï¼Œæœ€éš¾ç†è§£çš„åœ¨å‰é¢ï¼Œè€Œè¦çœ‹æ‡‚å®ƒä»¬ï¼Œåº”è¯¥å…ˆçœ‹æ‡‚åé¢çš„ï¼Œç„¶åå†å€’å›æ¥çœ‹ * */ // i æ˜¯ä½ç½®ç´¢å¼•ï¼Œbound æ˜¯è¾¹ç•Œï¼Œæ³¨æ„æ˜¯ä»åå¾€å‰ for (int i = 0, bound = 0;;) &#123; Node&lt;K,V&gt; f; int fh; // ä¸‹é¢è¿™ä¸ª while çœŸçš„æ˜¯ä¸å¥½ç†è§£ // advance ä¸º true è¡¨ç¤ºå¯ä»¥è¿›è¡Œä¸‹ä¸€ä¸ªä½ç½®çš„è¿ç§»äº† // ç®€å•ç†è§£ç»“å±€: i æŒ‡å‘äº† transferIndexï¼Œbound æŒ‡å‘äº† transferIndex-stride while (advance) &#123; int nextIndex, nextBound; if (--i &gt;= bound || finishing) advance = false; // å°† transferIndex å€¼èµ‹ç»™ nextIndex // è¿™é‡Œ transferIndex ä¸€æ—¦å°äºç­‰äº 0ï¼Œè¯´æ˜åŸæ•°ç»„çš„æ‰€æœ‰ä½ç½®éƒ½æœ‰ç›¸åº”çš„çº¿ç¨‹å»å¤„ç†äº† else if ((nextIndex = transferIndex) &lt;= 0) &#123; i = -1; advance = false; &#125; else if (U.compareAndSwapInt (this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) &#123; // çœ‹æ‹¬å·ä¸­çš„ä»£ç ï¼ŒnextBound æ˜¯è¿™æ¬¡è¿ç§»ä»»åŠ¡çš„è¾¹ç•Œï¼Œæ³¨æ„ï¼Œæ˜¯ä»åå¾€å‰ bound = nextBound; i = nextIndex - 1; advance = false; &#125; &#125; if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123; int sc; if (finishing) &#123; // æ‰€æœ‰çš„è¿ç§»æ“ä½œå·²ç»å®Œæˆ nextTable = null; // å°†æ–°çš„ nextTab èµ‹å€¼ç»™ table å±æ€§ï¼Œå®Œæˆè¿ç§» table = nextTab; // é‡æ–°è®¡ç®— sizeCtl: n æ˜¯åŸæ•°ç»„é•¿åº¦ï¼Œæ‰€ä»¥ sizeCtl å¾—å‡ºçš„å€¼å°†æ˜¯æ–°æ•°ç»„é•¿åº¦çš„ 0.75 å€ sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1); return; &#125; // ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒsizeCtl åœ¨è¿ç§»å‰ä¼šè®¾ç½®ä¸º (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2 // ç„¶åï¼Œæ¯æœ‰ä¸€ä¸ªçº¿ç¨‹å‚ä¸è¿ç§»å°±ä¼šå°† sizeCtl åŠ  1ï¼Œ // è¿™é‡Œä½¿ç”¨ CAS æ“ä½œå¯¹ sizeCtl è¿›è¡Œå‡ 1ï¼Œä»£è¡¨åšå®Œäº†å±äºè‡ªå·±çš„ä»»åŠ¡ if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123; // ä»»åŠ¡ç»“æŸï¼Œæ–¹æ³•é€€å‡º if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) return; // åˆ°è¿™é‡Œï¼Œè¯´æ˜ (sc - 2) == resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFTï¼Œ // ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„è¿ç§»ä»»åŠ¡éƒ½åšå®Œäº†ï¼Œä¹Ÿå°±ä¼šè¿›å…¥åˆ°ä¸Šé¢çš„ if(finishing)&#123;&#125; åˆ†æ”¯äº† finishing = advance = true; i = n; // recheck before commit &#125; &#125; // å¦‚æœä½ç½® i å¤„æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰ä»»ä½•èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ”¾å…¥åˆšåˆšåˆå§‹åŒ–çš„ ForwardingNode â€ç©ºèŠ‚ç‚¹â€œ else if ((f = tabAt(tab, i)) == null) advance = casTabAt(tab, i, null, fwd); // è¯¥ä½ç½®å¤„æ˜¯ä¸€ä¸ª ForwardingNodeï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»è¿‡äº† else if ((fh = f.hash) == MOVED) advance = true; // already processed else &#123; // å¯¹æ•°ç»„è¯¥ä½ç½®å¤„çš„ç»“ç‚¹åŠ é”ï¼Œå¼€å§‹å¤„ç†æ•°ç»„è¯¥ä½ç½®å¤„çš„è¿ç§»å·¥ä½œ synchronized (f) &#123; if (tabAt(tab, i) == f) &#123; Node&lt;K,V&gt; ln, hn; // å¤´èŠ‚ç‚¹çš„ hash å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨çš„ Node èŠ‚ç‚¹ if (fh &gt;= 0) &#123; // ä¸‹é¢è¿™ä¸€å—å’Œ Java7 ä¸­çš„ ConcurrentHashMap è¿ç§»æ˜¯å·®ä¸å¤šçš„ï¼Œ // éœ€è¦å°†é“¾è¡¨ä¸€åˆ†ä¸ºäºŒï¼Œ // æ‰¾åˆ°åŸé“¾è¡¨ä¸­çš„ lastRunï¼Œç„¶å lastRun åŠå…¶ä¹‹åçš„èŠ‚ç‚¹æ˜¯ä¸€èµ·è¿›è¡Œè¿ç§»çš„ // lastRun ä¹‹å‰çš„èŠ‚ç‚¹éœ€è¦è¿›è¡Œå…‹éš†ï¼Œç„¶ååˆ†åˆ°ä¸¤ä¸ªé“¾è¡¨ä¸­ int runBit = fh &amp; n; Node&lt;K,V&gt; lastRun = f; for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123; int b = p.hash &amp; n; if (b != runBit) &#123; runBit = b; lastRun = p; &#125; &#125; if (runBit == 0) &#123; ln = lastRun; hn = null; &#125; else &#123; hn = lastRun; ln = null; &#125; for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123; int ph = p.hash; K pk = p.key; V pv = p.val; if ((ph &amp; n) == 0) ln = new Node&lt;K,V&gt;(ph, pk, pv, ln); else hn = new Node&lt;K,V&gt;(ph, pk, pv, hn); &#125; // å…¶ä¸­çš„ä¸€ä¸ªé“¾è¡¨æ”¾åœ¨æ–°æ•°ç»„çš„ä½ç½® i setTabAt(nextTab, i, ln); // å¦ä¸€ä¸ªé“¾è¡¨æ”¾åœ¨æ–°æ•°ç»„çš„ä½ç½® i+n setTabAt(nextTab, i + n, hn); // å°†åŸæ•°ç»„è¯¥ä½ç½®å¤„è®¾ç½®ä¸º fwdï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»å¤„ç†å®Œæ¯•ï¼Œ // å…¶ä»–çº¿ç¨‹ä¸€æ—¦çœ‹åˆ°è¯¥ä½ç½®çš„ hash å€¼ä¸º MOVEDï¼Œå°±ä¸ä¼šè¿›è¡Œè¿ç§»äº† setTabAt(tab, i, fwd); // advance è®¾ç½®ä¸º trueï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»å®Œæ¯• advance = true; &#125; else if (f instanceof TreeBin) &#123; // çº¢é»‘æ ‘çš„è¿ç§» TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f; TreeNode&lt;K,V&gt; lo = null, loTail = null; TreeNode&lt;K,V&gt; hi = null, hiTail = null; int lc = 0, hc = 0; for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123; int h = e.hash; TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt; (h, e.key, e.val, null, null); if ((h &amp; n) == 0) &#123; if ((p.prev = loTail) == null) lo = p; else loTail.next = p; loTail = p; ++lc; &#125; else &#123; if ((p.prev = hiTail) == null) hi = p; else hiTail.next = p; hiTail = p; ++hc; &#125; &#125; // å¦‚æœä¸€åˆ†ä¸ºäºŒåï¼ŒèŠ‚ç‚¹æ•°å°äºç­‰äº6ï¼Œé‚£ä¹ˆå°†çº¢é»‘æ ‘è½¬æ¢å›é“¾è¡¨ ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) : (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t; hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) : (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t; // å°† ln æ”¾ç½®åœ¨æ–°æ•°ç»„çš„ä½ç½® i setTabAt(nextTab, i, ln); // å°† hn æ”¾ç½®åœ¨æ–°æ•°ç»„çš„ä½ç½® i+n setTabAt(nextTab, i + n, hn); // å°†åŸæ•°ç»„è¯¥ä½ç½®å¤„è®¾ç½®ä¸º fwdï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»å¤„ç†å®Œæ¯•ï¼Œ // å…¶ä»–çº¿ç¨‹ä¸€æ—¦çœ‹åˆ°è¯¥ä½ç½®çš„ hash å€¼ä¸º MOVEDï¼Œå°±ä¸ä¼šè¿›è¡Œè¿ç§»äº† setTabAt(tab, i, fwd); // advance è®¾ç½®ä¸º trueï¼Œä»£è¡¨è¯¥ä½ç½®å·²ç»è¿ç§»å®Œæ¯• advance = true; &#125; &#125; &#125; &#125; &#125;&#125; è¯´åˆ°åº•ï¼Œtransfer è¿™ä¸ªæ–¹æ³•å¹¶æ²¡æœ‰å®ç°æ‰€æœ‰çš„è¿ç§»ä»»åŠ¡ï¼Œæ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•åªå®ç°äº† transferIndex å¾€å‰ stride ä¸ªä½ç½®çš„è¿ç§»å·¥ä½œï¼Œå…¶ä»–çš„éœ€è¦ç”±å¤–å›´æ¥æ§åˆ¶ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œå†å›å»ä»”ç»†çœ‹ tryPresize æ–¹æ³•å¯èƒ½å°±ä¼šæ›´åŠ æ¸…æ™°ä¸€äº›äº†ã€‚ get è¿‡ç¨‹åˆ†æget æ–¹æ³•ä»æ¥éƒ½æ˜¯æœ€ç®€å•çš„ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–: è®¡ç®— hash å€¼ æ ¹æ® hash å€¼æ‰¾åˆ°æ•°ç»„å¯¹åº”ä½ç½®: (n - 1) &amp; h æ ¹æ®è¯¥ä½ç½®å¤„ç»“ç‚¹æ€§è´¨è¿›è¡Œç›¸åº”æŸ¥æ‰¾ å¦‚æœè¯¥ä½ç½®ä¸º nullï¼Œé‚£ä¹ˆç›´æ¥è¿”å› null å°±å¯ä»¥äº† å¦‚æœè¯¥ä½ç½®å¤„çš„èŠ‚ç‚¹åˆšå¥½å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œè¿”å›è¯¥èŠ‚ç‚¹çš„å€¼å³å¯ å¦‚æœè¯¥ä½ç½®èŠ‚ç‚¹çš„ hash å€¼å°äº 0ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹ï¼Œæˆ–è€…æ˜¯çº¢é»‘æ ‘ï¼Œåé¢æˆ‘ä»¬å†ä»‹ç» find æ–¹æ³• å¦‚æœä»¥ä¸Š 3 æ¡éƒ½ä¸æ»¡è¶³ï¼Œé‚£å°±æ˜¯é“¾è¡¨ï¼Œè¿›è¡Œéå†æ¯”å¯¹å³å¯ 123456789101112131415161718192021222324public V get(Object key) &#123; Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek; int h = spread(key.hashCode()); if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123; // åˆ¤æ–­å¤´èŠ‚ç‚¹æ˜¯å¦å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„èŠ‚ç‚¹ if ((eh = e.hash) == h) &#123; if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))) return e.val; &#125; // å¦‚æœå¤´èŠ‚ç‚¹çš„ hash å°äº 0ï¼Œè¯´æ˜ æ­£åœ¨æ‰©å®¹ï¼Œæˆ–è€…è¯¥ä½ç½®æ˜¯çº¢é»‘æ ‘ else if (eh &lt; 0) // å‚è€ƒ ForwardingNode.find(int h, Object k) å’Œ TreeBin.find(int h, Object k) return (p = e.find(h, key)) != null ? p.val : null; // éå†é“¾è¡¨ while ((e = e.next) != null) &#123; if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) return e.val; &#125; &#125; return null;&#125; ç®€å•è¯´ä¸€å¥ï¼Œæ­¤æ–¹æ³•çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½å¾ˆç®€å•ï¼Œåªæœ‰æ­£å¥½ç¢°åˆ°æ‰©å®¹çš„æƒ…å†µï¼ŒForwardingNode.find(int h, Object k) ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä¸è¿‡åœ¨äº†è§£äº†æ•°æ®è¿ç§»çš„è¿‡ç¨‹åï¼Œè¿™ä¸ªä¹Ÿå°±ä¸éš¾äº†ï¼Œæ‰€ä»¥é™äºç¯‡å¹…è¿™é‡Œä¹Ÿä¸å±•å¼€è¯´äº†ã€‚ å¯¹æ¯”æ€»ç»“ HashTable : ä½¿ç”¨äº†synchronizedå…³é”®å­—å¯¹putç­‰æ“ä½œè¿›è¡ŒåŠ é”; ConcurrentHashMap JDK1.7: ä½¿ç”¨åˆ†æ®µé”æœºåˆ¶å®ç°; ConcurrentHashMap JDK1.8: åˆ™ä½¿ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘æ•°æ®ç»“æ„å’ŒCASåŸå­æ“ä½œå®ç°; å‚è€ƒæ–‡ç«  https://blog.csdn.net/defonds/article/details/44021605#t7 http://tutorials.jenkov.com/java-concurrency/index.html https://juejin.im/post/5aeeaba8f265da0b9d781d16 https://www.javadoop.com/post/hashmap#Java7%20ConcurrentHashMap https://blog.csdn.net/Bill_Xiang_/article/details/81122044 https://www.cnblogs.com/leesf456/p/5453341.html https://www.cnblogs.com/huaizuo/archive/2016/04/20/5413069.html","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"13.JUCé”: ReentrantReadWriteLockè¯¦è§£","path":"/2023/12/25/13-JUCé”-ReentrantReadWriteLockè¯¦è§£/","content":"ReentrantReadWriteLockè¡¨ç¤ºå¯é‡å…¥è¯»å†™é”ï¼ŒReentrantReadWriteLockä¸­åŒ…å«äº†ä¸¤ç§é”ï¼Œè¯»é”ReadLockå’Œå†™é”WriteLockï¼Œå¯ä»¥é€šè¿‡è¿™ä¸¤ç§é”å®ç°çº¿ç¨‹é—´çš„åŒæ­¥ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ ä¸ºäº†æœ‰äº†ReentrantLockè¿˜éœ€è¦ReentrantReadWriteLock? ReentrantReadWriteLockåº•å±‚å®ç°åŸç†? ReentrantReadWriteLockåº•å±‚è¯»å†™çŠ¶æ€å¦‚ä½•è®¾è®¡çš„? é«˜16ä½ä¸ºè¯»é”ï¼Œä½16ä½ä¸ºå†™é” è¯»é”å’Œå†™é”çš„æœ€å¤§æ•°é‡æ˜¯å¤šå°‘? æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨ThreadLocalHoldCounteræ˜¯ç”¨æ¥åšä»€ä¹ˆçš„? ç¼“å­˜è®¡æ•°å™¨HoldCounteræ˜¯ç”¨æ¥åšä»€ä¹ˆçš„? å†™é”çš„è·å–ä¸é‡Šæ”¾æ˜¯æ€ä¹ˆå®ç°çš„? è¯»é”çš„è·å–ä¸é‡Šæ”¾æ˜¯æ€ä¹ˆå®ç°çš„? RentrantReadWriteLockä¸ºä»€ä¹ˆä¸æ”¯æŒé”å‡çº§? ä»€ä¹ˆæ˜¯é”çš„å‡é™çº§? RentrantReadWriteLockä¸ºä»€ä¹ˆä¸æ”¯æŒé”å‡çº§? ReentrantReadWriteLockæ•°æ®ç»“æ„ReentrantReadWriteLockåº•å±‚æ˜¯åŸºäºReentrantLockå’ŒAbstractQueuedSynchronizeræ¥å®ç°çš„ï¼Œæ‰€ä»¥ï¼ŒReentrantReadWriteLockçš„æ•°æ®ç»“æ„ä¹Ÿä¾æ‰˜äºAQSçš„æ•°æ®ç»“æ„ã€‚ ReentrantReadWriteLockæºç åˆ†æç±»çš„ç»§æ‰¿å…³ç³»1public class ReentrantReadWriteLock implements ReadWriteLock, java.io.Serializable &#123;&#125; è¯´æ˜: å¯ä»¥çœ‹åˆ°ï¼ŒReentrantReadWriteLockå®ç°äº†ReadWriteLockæ¥å£ï¼ŒReadWriteLockæ¥å£å®šä¹‰äº†è·å–è¯»é”å’Œå†™é”çš„è§„èŒƒï¼Œå…·ä½“éœ€è¦å®ç°ç±»å»å®ç°ï¼›åŒæ—¶å…¶è¿˜å®ç°äº†Serializableæ¥å£ï¼Œè¡¨ç¤ºå¯ä»¥è¿›è¡Œåºåˆ—åŒ–ï¼Œåœ¨æºä»£ç ä¸­å¯ä»¥çœ‹åˆ°ReentrantReadWriteLockå®ç°äº†è‡ªå·±çš„åºåˆ—åŒ–é€»è¾‘ã€‚ ç±»çš„å†…éƒ¨ç±»ReentrantReadWriteLockæœ‰äº”ä¸ªå†…éƒ¨ç±»ï¼Œäº”ä¸ªå†…éƒ¨ç±»ä¹‹é—´ä¹Ÿæ˜¯ç›¸äº’å…³è”çš„ã€‚å†…éƒ¨ç±»çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ è¯´æ˜: å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒSyncç»§æ‰¿è‡ªAQSã€NonfairSyncç»§æ‰¿è‡ªSyncç±»ã€FairSyncç»§æ‰¿è‡ªSyncç±»ï¼›ReadLockå®ç°äº†Lockæ¥å£ã€WriteLockä¹Ÿå®ç°äº†Lockæ¥å£ã€‚ å†…éƒ¨ç±» - Syncç±» ç±»çš„ç»§æ‰¿å…³ç³» 1abstract static class Sync extends AbstractQueuedSynchronizer &#123;&#125; è¯´æ˜: SyncæŠ½è±¡ç±»ç»§æ‰¿è‡ªAQSæŠ½è±¡ç±»ï¼ŒSyncç±»æä¾›äº†å¯¹ReentrantReadWriteLockçš„æ”¯æŒã€‚ ç±»çš„å†…éƒ¨ç±» Syncç±»å†…éƒ¨å­˜åœ¨ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«ä¸ºHoldCounterå’ŒThreadLocalHoldCounterï¼Œå…¶ä¸­HoldCounterä¸»è¦ä¸è¯»é”é…å¥—ä½¿ç”¨ï¼Œå…¶ä¸­ï¼ŒHoldCounteræºç å¦‚ä¸‹ã€‚ 12345678// è®¡æ•°å™¨static final class HoldCounter &#123; // è®¡æ•° int count = 0; // Use id, not reference, to avoid garbage retention // è·å–å½“å‰çº¿ç¨‹çš„TIDå±æ€§çš„å€¼ final long tid = getThreadId(Thread.currentThread());&#125; è¯´æ˜: HoldCounterä¸»è¦æœ‰ä¸¤ä¸ªå±æ€§ï¼Œcountå’Œtidï¼Œå…¶ä¸­countè¡¨ç¤ºæŸä¸ªè¯»çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°ï¼Œtidè¡¨ç¤ºè¯¥çº¿ç¨‹çš„tidå­—æ®µçš„å€¼ï¼Œè¯¥å­—æ®µå¯ä»¥ç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªçº¿ç¨‹ã€‚ThreadLocalHoldCounterçš„æºç å¦‚ä¸‹ 12345678// æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨static final class ThreadLocalHoldCounter extends ThreadLocal&lt;HoldCounter&gt; &#123; // é‡å†™åˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨æ²¡æœ‰è¿›è¡Œsetçš„æƒ…å†µä¸‹ï¼Œè·å–çš„éƒ½æ˜¯è¯¥HoldCounterå€¼ public HoldCounter initialValue() &#123; return new HoldCounter(); &#125;&#125; è¯´æ˜: ThreadLocalHoldCounteré‡å†™äº†ThreadLocalçš„initialValueæ–¹æ³•ï¼ŒThreadLocalç±»å¯ä»¥å°†çº¿ç¨‹ä¸å¯¹è±¡ç›¸å…³è”ã€‚åœ¨æ²¡æœ‰è¿›è¡Œsetçš„æƒ…å†µä¸‹ï¼Œgetåˆ°çš„å‡æ˜¯initialValueæ–¹æ³•é‡Œé¢ç”Ÿæˆçš„é‚£ä¸ªHolderCounterå¯¹è±¡ã€‚ ç±»çš„å±æ€§ 1234567891011121314151617181920abstract static class Sync extends AbstractQueuedSynchronizer &#123; // ç‰ˆæœ¬åºåˆ—å· private static final long serialVersionUID = 6317671515068378041L; // é«˜16ä½ä¸ºè¯»é”ï¼Œä½16ä½ä¸ºå†™é” static final int SHARED_SHIFT = 16; // è¯»é”å•ä½ static final int SHARED_UNIT = (1 &lt;&lt; SHARED_SHIFT); // è¯»é”æœ€å¤§æ•°é‡ static final int MAX_COUNT = (1 &lt;&lt; SHARED_SHIFT) - 1; // å†™é”æœ€å¤§æ•°é‡ static final int EXCLUSIVE_MASK = (1 &lt;&lt; SHARED_SHIFT) - 1; // æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨ private transient ThreadLocalHoldCounter readHolds; // ç¼“å­˜çš„è®¡æ•°å™¨ private transient HoldCounter cachedHoldCounter; // ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ private transient Thread firstReader = null; // ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹çš„è®¡æ•° private transient int firstReaderHoldCount;&#125; è¯´æ˜: è¯¥å±æ€§ä¸­åŒ…æ‹¬äº†è¯»é”ã€å†™é”çº¿ç¨‹çš„æœ€å¤§é‡ã€‚æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨ç­‰ã€‚ ç±»çš„æ„é€ å‡½æ•° 1234567// æ„é€ å‡½æ•°Sync() &#123; // æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨ readHolds = new ThreadLocalHoldCounter(); // è®¾ç½®AQSçš„çŠ¶æ€ setState(getState()); // ensures visibility of readHolds&#125; è¯´æ˜: åœ¨Syncçš„æ„é€ å‡½æ•°ä¸­è®¾ç½®äº†æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨å’ŒAQSçš„çŠ¶æ€stateã€‚ å†…éƒ¨ç±» - Syncæ ¸å¿ƒå‡½æ•°åˆ†æå¯¹ReentrantReadWriteLockå¯¹è±¡çš„æ“ä½œç»å¤§å¤šæ•°éƒ½è½¬å‘è‡³Syncå¯¹è±¡è¿›è¡Œå¤„ç†ã€‚ä¸‹é¢å¯¹Syncç±»ä¸­çš„é‡ç‚¹å‡½æ•°è¿›è¡Œåˆ†æ sharedCountå‡½æ•° è¡¨ç¤ºå æœ‰è¯»é”çš„çº¿ç¨‹æ•°é‡ï¼Œæºç å¦‚ä¸‹ 1static int sharedCount(int c) &#123; return c &gt;&gt;&gt; SHARED_SHIFT; &#125; è¯´æ˜: ç›´æ¥å°†stateå³ç§»16ä½ï¼Œå°±å¯ä»¥å¾—åˆ°è¯»é”çš„çº¿ç¨‹æ•°é‡ï¼Œå› ä¸ºstateçš„é«˜16ä½è¡¨ç¤ºè¯»é”ï¼Œå¯¹åº”çš„ä½åå…­ä½è¡¨ç¤ºå†™é”æ•°é‡ã€‚ exclusiveCountå‡½æ•° è¡¨ç¤ºå æœ‰å†™é”çš„çº¿ç¨‹æ•°é‡ï¼Œæºç å¦‚ä¸‹ 1static int exclusiveCount(int c) &#123; return c &amp; EXCLUSIVE_MASK; &#125; è¯´æ˜: ç›´æ¥å°†çŠ¶æ€stateå’Œ(2^16 - 1)åšä¸è¿ç®—ï¼Œå…¶ç­‰æ•ˆäºå°†stateæ¨¡ä¸Š2^16ã€‚å†™é”æ•°é‡ç”±stateçš„ä½åå…­ä½è¡¨ç¤ºã€‚ tryReleaseå‡½æ•° 12345678910111213141516171819/** Note that tryRelease and tryAcquire can be called by* Conditions. So it is possible that their arguments contain* both read and write holds that are all released during a* condition wait and re-established in tryAcquire.*/protected final boolean tryRelease(int releases) &#123; // åˆ¤æ–­æ˜¯å¦ä¼ªç‹¬å çº¿ç¨‹ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); // è®¡ç®—é‡Šæ”¾èµ„æºåçš„å†™é”çš„æ•°é‡ int nextc = getState() - releases; boolean free = exclusiveCount(nextc) == 0; // æ˜¯å¦é‡Šæ”¾æˆåŠŸ if (free) setExclusiveOwnerThread(null); // è®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºç©º setState(nextc); // è®¾ç½®çŠ¶æ€ return free;&#125; è¯´æ˜: æ­¤å‡½æ•°ç”¨äºé‡Šæ”¾å†™é”èµ„æºï¼Œé¦–å…ˆä¼šåˆ¤æ–­è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºç‹¬å çº¿ç¨‹ï¼Œè‹¥ä¸ä¸ºç‹¬å çº¿ç¨‹ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™ï¼Œè®¡ç®—é‡Šæ”¾èµ„æºåçš„å†™é”çš„æ•°é‡ï¼Œè‹¥ä¸º0ï¼Œè¡¨ç¤ºæˆåŠŸé‡Šæ”¾ï¼Œèµ„æºä¸å°†è¢«å ç”¨ï¼Œå¦åˆ™ï¼Œè¡¨ç¤ºèµ„æºè¿˜è¢«å ç”¨ã€‚å…¶å‡½æ•°æµç¨‹å›¾å¦‚ä¸‹ã€‚ tryAcquireå‡½æ•° 123456789101112131415161718192021222324252627282930313233343536protected final boolean tryAcquire(int acquires) &#123; /* * Walkthrough: * 1. If read count nonzero or write count nonzero * and owner is a different thread, fail. * 2. If count would saturate, fail. (This can only * happen if count is already nonzero.) * 3. Otherwise, this thread is eligible for lock if * it is either a reentrant acquire or * queue policy allows it. If so, update state * and set owner. */ // è·å–å½“å‰çº¿ç¨‹ Thread current = Thread.currentThread(); // è·å–çŠ¶æ€ int c = getState(); // å†™çº¿ç¨‹æ•°é‡ int w = exclusiveCount(c); if (c != 0) &#123; // çŠ¶æ€ä¸ä¸º0 // (Note: if c != 0 and w == 0 then shared count != 0) if (w == 0 || current != getExclusiveOwnerThread()) // å†™çº¿ç¨‹æ•°é‡ä¸º0æˆ–è€…å½“å‰çº¿ç¨‹æ²¡æœ‰å æœ‰ç‹¬å èµ„æº return false; if (w + exclusiveCount(acquires) &gt; MAX_COUNT) // åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€é«˜å†™çº¿ç¨‹æ•°é‡ throw new Error(&quot;Maximum lock count exceeded&quot;); // Reentrant acquire // è®¾ç½®AQSçŠ¶æ€ setState(c + acquires); return true; &#125; if (writerShouldBlock() || !compareAndSetState(c, c + acquires)) // å†™çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡ return false; // è®¾ç½®ç‹¬å çº¿ç¨‹ setExclusiveOwnerThread(current); return true;&#125; è¯´æ˜: æ­¤å‡½æ•°ç”¨äºè·å–å†™é”ï¼Œé¦–å…ˆä¼šè·å–stateï¼Œåˆ¤æ–­æ˜¯å¦ä¸º0ï¼Œè‹¥ä¸º0ï¼Œè¡¨ç¤ºæ­¤æ—¶æ²¡æœ‰è¯»é”çº¿ç¨‹ï¼Œå†åˆ¤æ–­å†™çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡ï¼Œè€Œåœ¨éå…¬å¹³ç­–ç•¥ä¸‹æ€»æ˜¯ä¸ä¼šè¢«é˜»å¡ï¼Œåœ¨å…¬å¹³ç­–ç•¥ä¸‹ä¼šè¿›è¡Œåˆ¤æ–­(åˆ¤æ–­åŒæ­¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç­‰å¾…æ—¶é—´æ›´é•¿çš„çº¿ç¨‹ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™éœ€è¦è¢«é˜»å¡ï¼Œå¦åˆ™ï¼Œæ— éœ€é˜»å¡)ï¼Œä¹‹ååœ¨è®¾ç½®çŠ¶æ€stateï¼Œç„¶åè¿”å›trueã€‚è‹¥stateä¸ä¸º0ï¼Œåˆ™è¡¨ç¤ºæ­¤æ—¶å­˜åœ¨è¯»é”æˆ–å†™é”çº¿ç¨‹ï¼Œè‹¥å†™é”çº¿ç¨‹æ•°é‡ä¸º0æˆ–è€…å½“å‰çº¿ç¨‹ä¸ºç‹¬å é”çº¿ç¨‹ï¼Œåˆ™è¿”å›falseï¼Œè¡¨ç¤ºä¸æˆåŠŸï¼Œå¦åˆ™ï¼Œåˆ¤æ–­å†™é”çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°æ˜¯å¦å¤§äºäº†æœ€å¤§å€¼ï¼Œè‹¥æ˜¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™ï¼Œè®¾ç½®çŠ¶æ€stateï¼Œè¿”å›trueï¼Œè¡¨ç¤ºæˆåŠŸã€‚å…¶å‡½æ•°æµç¨‹å›¾å¦‚ä¸‹ tryReleaseSharedå‡½æ•° 1234567891011121314151617181920212223242526272829303132333435363738protected final boolean tryReleaseShared(int unused) &#123; // è·å–å½“å‰çº¿ç¨‹ Thread current = Thread.currentThread(); if (firstReader == current) &#123; // å½“å‰çº¿ç¨‹ä¸ºç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ // assert firstReaderHoldCount &gt; 0; if (firstReaderHoldCount == 1) // è¯»çº¿ç¨‹å ç”¨çš„èµ„æºæ•°ä¸º1 firstReader = null; else // å‡å°‘å ç”¨çš„èµ„æº firstReaderHoldCount--; &#125; else &#123; // å½“å‰çº¿ç¨‹ä¸ä¸ºç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ // è·å–ç¼“å­˜çš„è®¡æ•°å™¨ HoldCounter rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) // è®¡æ•°å™¨ä¸ºç©ºæˆ–è€…è®¡æ•°å™¨çš„tidä¸ä¸ºå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹çš„tid // è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„è®¡æ•°å™¨ rh = readHolds.get(); // è·å–è®¡æ•° int count = rh.count; if (count &lt;= 1) &#123; // è®¡æ•°å°äºç­‰äº1 // ç§»é™¤ readHolds.remove(); if (count &lt;= 0) // è®¡æ•°å°äºç­‰äº0ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw unmatchedUnlockException(); &#125; // å‡å°‘è®¡æ•° --rh.count; &#125; for (;;) &#123; // æ— é™å¾ªç¯ // è·å–çŠ¶æ€ int c = getState(); // è·å–çŠ¶æ€ int nextc = c - SHARED_UNIT; if (compareAndSetState(c, nextc)) // æ¯”è¾ƒå¹¶è¿›è¡Œè®¾ç½® // Releasing the read lock has no effect on readers, // but it may allow waiting writers to proceed if // both read and write locks are now free. return nextc == 0; &#125;&#125; è¯´æ˜: æ­¤å‡½æ•°è¡¨ç¤ºè¯»é”çº¿ç¨‹é‡Šæ”¾é”ã€‚é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹firstReaderï¼Œè‹¥æ˜¯ï¼Œåˆ™åˆ¤æ–­ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹å æœ‰çš„èµ„æºæ•°firstReaderHoldCountæ˜¯å¦ä¸º1ï¼Œè‹¥æ˜¯ï¼Œåˆ™è®¾ç½®ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹firstReaderä¸ºç©ºï¼Œå¦åˆ™ï¼Œå°†ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹å æœ‰çš„èµ„æºæ•°firstReaderHoldCountå‡1ï¼›è‹¥å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ï¼Œé‚£ä¹ˆé¦–å…ˆä¼šè·å–ç¼“å­˜è®¡æ•°å™¨(ä¸Šä¸€ä¸ªè¯»é”çº¿ç¨‹å¯¹åº”çš„è®¡æ•°å™¨ )ï¼Œè‹¥è®¡æ•°å™¨ä¸ºç©ºæˆ–è€…tidä¸ç­‰äºå½“å‰çº¿ç¨‹çš„tidå€¼ï¼Œåˆ™è·å–å½“å‰çº¿ç¨‹çš„è®¡æ•°å™¨ï¼Œå¦‚æœè®¡æ•°å™¨çš„è®¡æ•°countå°äºç­‰äº1ï¼Œåˆ™ç§»é™¤å½“å‰çº¿ç¨‹å¯¹åº”çš„è®¡æ•°å™¨ï¼Œå¦‚æœè®¡æ•°å™¨çš„è®¡æ•°countå°äºç­‰äº0ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¹‹åå†å‡å°‘è®¡æ•°å³å¯ã€‚æ— è®ºä½•ç§æƒ…å†µï¼Œéƒ½ä¼šè¿›å…¥æ— é™å¾ªç¯ï¼Œè¯¥å¾ªç¯å¯ä»¥ç¡®ä¿æˆåŠŸè®¾ç½®çŠ¶æ€stateã€‚å…¶æµç¨‹å›¾å¦‚ä¸‹ tryAcquireSharedå‡½æ•° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657private IllegalMonitorStateException unmatchedUnlockException() &#123; return new IllegalMonitorStateException( &quot;attempt to unlock read lock, not locked by current thread&quot;);&#125;// å…±äº«æ¨¡å¼ä¸‹è·å–èµ„æºprotected final int tryAcquireShared(int unused) &#123; /* * Walkthrough: * 1. If write lock held by another thread, fail. * 2. Otherwise, this thread is eligible for * lock wrt state, so ask if it should block * because of queue policy. If not, try * to grant by CASing state and updating count. * Note that step does not check for reentrant * acquires, which is postponed to full version * to avoid having to check hold count in * the more typical non-reentrant case. * 3. If step 2 fails either because thread * apparently not eligible or CAS fails or count * saturated, chain to version with full retry loop. */ // è·å–å½“å‰çº¿ç¨‹ Thread current = Thread.currentThread(); // è·å–çŠ¶æ€ int c = getState(); if (exclusiveCount(c) != 0 &amp;&amp; getExclusiveOwnerThread() != current) // å†™çº¿ç¨‹æ•°ä¸ä¸º0å¹¶ä¸”å æœ‰èµ„æºçš„ä¸æ˜¯å½“å‰çº¿ç¨‹ return -1; // è¯»é”æ•°é‡ int r = sharedCount(c); if (!readerShouldBlock() &amp;&amp; r &lt; MAX_COUNT &amp;&amp; compareAndSetState(c, c + SHARED_UNIT)) &#123; // è¯»çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡ã€å¹¶ä¸”å°äºæœ€å¤§å€¼ã€å¹¶ä¸”æ¯”è¾ƒè®¾ç½®æˆåŠŸ if (r == 0) &#123; // è¯»é”æ•°é‡ä¸º0 // è®¾ç½®ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ firstReader = current; // è¯»çº¿ç¨‹å ç”¨çš„èµ„æºæ•°ä¸º1 firstReaderHoldCount = 1; &#125; else if (firstReader == current) &#123; // å½“å‰çº¿ç¨‹ä¸ºç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ // å ç”¨èµ„æºæ•°åŠ 1 firstReaderHoldCount++; &#125; else &#123; // è¯»é”æ•°é‡ä¸ä¸º0å¹¶ä¸”ä¸ä¸ºå½“å‰çº¿ç¨‹ // è·å–è®¡æ•°å™¨ HoldCounter rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) // è®¡æ•°å™¨ä¸ºç©ºæˆ–è€…è®¡æ•°å™¨çš„tidä¸ä¸ºå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹çš„tid // è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„è®¡æ•°å™¨ cachedHoldCounter = rh = readHolds.get(); else if (rh.count == 0) // è®¡æ•°ä¸º0 // è®¾ç½® readHolds.set(rh); rh.count++; &#125; return 1; &#125; return fullTryAcquireShared(current);&#125; è¯´æ˜: æ­¤å‡½æ•°è¡¨ç¤ºè¯»é”çº¿ç¨‹è·å–è¯»é”ã€‚é¦–å…ˆåˆ¤æ–­å†™é”æ˜¯å¦ä¸º0å¹¶ä¸”å½“å‰çº¿ç¨‹ä¸å æœ‰ç‹¬å é”ï¼Œç›´æ¥è¿”å›ï¼›å¦åˆ™ï¼Œåˆ¤æ–­è¯»çº¿ç¨‹æ˜¯å¦éœ€è¦è¢«é˜»å¡å¹¶ä¸”è¯»é”æ•°é‡æ˜¯å¦å°äºæœ€å¤§å€¼å¹¶ä¸”æ¯”è¾ƒè®¾ç½®çŠ¶æ€æˆåŠŸï¼Œè‹¥å½“å‰æ²¡æœ‰è¯»é”ï¼Œåˆ™è®¾ç½®ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹firstReaderå’ŒfirstReaderHoldCountï¼›è‹¥å½“å‰çº¿ç¨‹çº¿ç¨‹ä¸ºç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ï¼Œåˆ™å¢åŠ firstReaderHoldCountï¼›å¦åˆ™ï¼Œå°†è®¾ç½®å½“å‰çº¿ç¨‹å¯¹åº”çš„HoldCounterå¯¹è±¡çš„å€¼ã€‚æµç¨‹å›¾å¦‚ä¸‹ã€‚ fullTryAcquireSharedå‡½æ•° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758final int fullTryAcquireShared(Thread current) &#123; /* * This code is in part redundant with that in * tryAcquireShared but is simpler overall by not * complicating tryAcquireShared with interactions between * retries and lazily reading hold counts. */ HoldCounter rh = null; for (;;) &#123; // æ— é™å¾ªç¯ // è·å–çŠ¶æ€ int c = getState(); if (exclusiveCount(c) != 0) &#123; // å†™çº¿ç¨‹æ•°é‡ä¸ä¸º0 if (getExclusiveOwnerThread() != current) // ä¸ä¸ºå½“å‰çº¿ç¨‹ return -1; // else we hold the exclusive lock; blocking here // would cause deadlock. &#125; else if (readerShouldBlock()) &#123; // å†™çº¿ç¨‹æ•°é‡ä¸º0å¹¶ä¸”è¯»çº¿ç¨‹è¢«é˜»å¡ // Make sure we&#x27;re not acquiring read lock reentrantly if (firstReader == current) &#123; // å½“å‰çº¿ç¨‹ä¸ºç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ // assert firstReaderHoldCount &gt; 0; &#125; else &#123; // å½“å‰çº¿ç¨‹ä¸ä¸ºç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ if (rh == null) &#123; // è®¡æ•°å™¨ä¸ä¸ºç©º // rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) &#123; // è®¡æ•°å™¨ä¸ºç©ºæˆ–è€…è®¡æ•°å™¨çš„tidä¸ä¸ºå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹çš„tid rh = readHolds.get(); if (rh.count == 0) readHolds.remove(); &#125; &#125; if (rh.count == 0) return -1; &#125; &#125; if (sharedCount(c) == MAX_COUNT) // è¯»é”æ•°é‡ä¸ºæœ€å¤§å€¼ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new Error(&quot;Maximum lock count exceeded&quot;); if (compareAndSetState(c, c + SHARED_UNIT)) &#123; // æ¯”è¾ƒå¹¶ä¸”è®¾ç½®æˆåŠŸ if (sharedCount(c) == 0) &#123; // è¯»çº¿ç¨‹æ•°é‡ä¸º0 // è®¾ç½®ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹ firstReader = current; // firstReaderHoldCount = 1; &#125; else if (firstReader == current) &#123; firstReaderHoldCount++; &#125; else &#123; if (rh == null) rh = cachedHoldCounter; if (rh == null || rh.tid != getThreadId(current)) rh = readHolds.get(); else if (rh.count == 0) readHolds.set(rh); rh.count++; cachedHoldCounter = rh; // cache for release &#125; return 1; &#125; &#125;&#125; è¯´æ˜: åœ¨tryAcquireSharedå‡½æ•°ä¸­ï¼Œå¦‚æœä¸‹åˆ—ä¸‰ä¸ªæ¡ä»¶ä¸æ»¡è¶³(è¯»çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡ã€å°äºæœ€å¤§å€¼ã€æ¯”è¾ƒè®¾ç½®æˆåŠŸ)åˆ™ä¼šè¿›è¡ŒfullTryAcquireSharedå‡½æ•°ä¸­ï¼Œå®ƒç”¨æ¥ä¿è¯ç›¸å…³æ“ä½œå¯ä»¥æˆåŠŸã€‚å…¶é€»è¾‘ä¸tryAcquireSharedé€»è¾‘ç±»ä¼¼ï¼Œä¸å†ç´¯èµ˜ã€‚ è€Œå…¶ä»–å†…éƒ¨ç±»çš„æ“ä½œåŸºæœ¬ä¸Šéƒ½æ˜¯è½¬åŒ–åˆ°äº†å¯¹Syncå¯¹è±¡çš„æ“ä½œï¼Œåœ¨æ­¤ä¸å†ç´¯èµ˜ã€‚ ç±»çš„å±æ€§1234567891011121314151617181920212223242526public class ReentrantReadWriteLock implements ReadWriteLock, java.io.Serializable &#123; // ç‰ˆæœ¬åºåˆ—å· private static final long serialVersionUID = -6992448646407690164L; // è¯»é” private final ReentrantReadWriteLock.ReadLock readerLock; // å†™é” private final ReentrantReadWriteLock.WriteLock writerLock; // åŒæ­¥é˜Ÿåˆ— final Sync sync; private static final sun.misc.Unsafe UNSAFE; // çº¿ç¨‹IDçš„åç§»åœ°å€ private static final long TID_OFFSET; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; tk = Thread.class; // è·å–çº¿ç¨‹çš„tidå­—æ®µçš„å†…å­˜åœ°å€ TID_OFFSET = UNSAFE.objectFieldOffset (tk.getDeclaredField(&quot;tid&quot;)); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125;&#125; è¯´æ˜: å¯ä»¥çœ‹åˆ°ReentrantReadWriteLockå±æ€§åŒ…æ‹¬äº†ä¸€ä¸ªReentrantReadWriteLock.ReadLockå¯¹è±¡ï¼Œè¡¨ç¤ºè¯»é”ï¼›ä¸€ä¸ªReentrantReadWriteLock.WriteLockå¯¹è±¡ï¼Œè¡¨ç¤ºå†™é”ï¼›ä¸€ä¸ªSyncå¯¹è±¡ï¼Œè¡¨ç¤ºåŒæ­¥é˜Ÿåˆ—ã€‚ ç±»çš„æ„é€ å‡½æ•° ReentrantReadWriteLock()å‹æ„é€ å‡½æ•° 123public ReentrantReadWriteLock() &#123; this(false);&#125; è¯´æ˜: æ­¤æ„é€ å‡½æ•°ä¼šè°ƒç”¨å¦å¤–ä¸€ä¸ªæœ‰å‚æ„é€ å‡½æ•°ã€‚ ReentrantReadWriteLock(boolean)å‹æ„é€ å‡½æ•° 12345678public ReentrantReadWriteLock(boolean fair) &#123; // å…¬å¹³ç­–ç•¥æˆ–è€…æ˜¯éå…¬å¹³ç­–ç•¥ sync = fair ? new FairSync() : new NonfairSync(); // è¯»é” readerLock = new ReadLock(this); // å†™é” writerLock = new WriteLock(this);&#125; è¯´æ˜: å¯ä»¥æŒ‡å®šè®¾ç½®å…¬å¹³ç­–ç•¥æˆ–è€…éå…¬å¹³ç­–ç•¥ï¼Œå¹¶ä¸”è¯¥æ„é€ å‡½æ•°ä¸­ç”Ÿæˆäº†è¯»é”ä¸å†™é”ä¸¤ä¸ªå¯¹è±¡ã€‚ æ ¸å¿ƒå‡½æ•°åˆ†æå¯¹ReentrantReadWriteLockçš„æ“ä½œåŸºæœ¬ä¸Šéƒ½è½¬åŒ–ä¸ºäº†å¯¹Syncå¯¹è±¡çš„æ“ä½œï¼Œè€ŒSyncçš„å‡½æ•°å·²ç»åˆ†æè¿‡ï¼Œä¸å†ç´¯èµ˜ã€‚ ReentrantReadWriteLockç¤ºä¾‹ä¸‹é¢ç»™å‡ºäº†ä¸€ä¸ªä½¿ç”¨ReentrantReadWriteLockçš„ç¤ºä¾‹ï¼Œæºä»£ç å¦‚ä¸‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556import java.util.concurrent.locks.ReentrantReadWriteLock;class ReadThread extends Thread &#123; private ReentrantReadWriteLock rrwLock; public ReadThread(String name, ReentrantReadWriteLock rrwLock) &#123; super(name); this.rrwLock = rrwLock; &#125; public void run() &#123; System.out.println(Thread.currentThread().getName() + &quot; trying to lock&quot;); try &#123; rrwLock.readLock().lock(); System.out.println(Thread.currentThread().getName() + &quot; lock successfully&quot;); Thread.sleep(5000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; rrwLock.readLock().unlock(); System.out.println(Thread.currentThread().getName() + &quot; unlock successfully&quot;); &#125; &#125;&#125;class WriteThread extends Thread &#123; private ReentrantReadWriteLock rrwLock; public WriteThread(String name, ReentrantReadWriteLock rrwLock) &#123; super(name); this.rrwLock = rrwLock; &#125; public void run() &#123; System.out.println(Thread.currentThread().getName() + &quot; trying to lock&quot;); try &#123; rrwLock.writeLock().lock(); System.out.println(Thread.currentThread().getName() + &quot; lock successfully&quot;); &#125; finally &#123; rrwLock.writeLock().unlock(); System.out.println(Thread.currentThread().getName() + &quot; unlock successfully&quot;); &#125; &#125;&#125;public class ReentrantReadWriteLockDemo &#123; public static void main(String[] args) &#123; ReentrantReadWriteLock rrwLock = new ReentrantReadWriteLock(); ReadThread rt1 = new ReadThread(&quot;rt1&quot;, rrwLock); ReadThread rt2 = new ReadThread(&quot;rt2&quot;, rrwLock); WriteThread wt1 = new WriteThread(&quot;wt1&quot;, rrwLock); rt1.start(); rt2.start(); wt1.start(); &#125; &#125; è¿è¡Œç»“æœ(æŸä¸€æ¬¡): 123456789rt1 trying to lockrt2 trying to lockwt1 trying to lockrt1 lock successfullyrt2 lock successfullyrt1 unlock successfullyrt2 unlock successfullywt1 lock successfullywt1 unlock successfully è¯´æ˜: ç¨‹åºä¸­ç”Ÿæˆäº†ä¸€ä¸ªReentrantReadWriteLockå¯¹è±¡ï¼Œå¹¶ä¸”è®¾ç½®äº†ä¸¤ä¸ªè¯»çº¿ç¨‹ï¼Œä¸€ä¸ªå†™çº¿ç¨‹ã€‚æ ¹æ®ç»“æœï¼Œå¯èƒ½å­˜åœ¨å¦‚ä¸‹çš„æ—¶åºå›¾ã€‚ rt1çº¿ç¨‹æ‰§è¡ŒrrwLock.readLock().lockæ“ä½œï¼Œä¸»è¦çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹ã€‚ è¯´æ˜: æ­¤æ—¶ï¼ŒAQSçš„çŠ¶æ€stateä¸º2^16 æ¬¡æ–¹ï¼Œå³è¡¨ç¤ºæ­¤æ—¶è¯»çº¿ç¨‹æ•°é‡ä¸º1ã€‚ rt2çº¿ç¨‹æ‰§è¡ŒrrwLock.readLock().lockæ“ä½œï¼Œä¸»è¦çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹ã€‚ è¯´æ˜: æ­¤æ—¶ï¼ŒAQSçš„çŠ¶æ€stateä¸º2 * 2^16æ¬¡æ–¹ï¼Œå³è¡¨ç¤ºæ­¤æ—¶è¯»çº¿ç¨‹æ•°é‡ä¸º2ã€‚ wt1çº¿ç¨‹æ‰§è¡ŒrrwLock.writeLock().lockæ“ä½œï¼Œä¸»è¦çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹ã€‚ è¯´æ˜: æ­¤æ—¶ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—Sync queueä¸­å­˜åœ¨ä¸¤ä¸ªç»“ç‚¹ï¼Œå¹¶ä¸”wt1çº¿ç¨‹ä¼šè¢«ç¦æ­¢è¿è¡Œã€‚ rt1çº¿ç¨‹æ‰§è¡ŒrrwLock.readLock().unlockæ“ä½œï¼Œä¸»è¦çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹ã€‚ è¯´æ˜: æ­¤æ—¶ï¼ŒAQSçš„stateä¸º2^16æ¬¡æ–¹ï¼Œè¡¨ç¤ºè¿˜æœ‰ä¸€ä¸ªè¯»çº¿ç¨‹ã€‚ rt2çº¿ç¨‹æ‰§è¡ŒrrwLock.readLock().unlockæ“ä½œï¼Œä¸»è¦çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹ã€‚ è¯´æ˜: å½“rt2çº¿ç¨‹æ‰§è¡Œunlockæ“ä½œåï¼ŒAQSçš„stateä¸º0ï¼Œå¹¶ä¸”wt1çº¿ç¨‹å°†ä¼šè¢«unparkï¼Œå…¶è·å¾—CPUèµ„æºå°±å¯ä»¥è¿è¡Œã€‚ wt1çº¿ç¨‹è·å¾—CPUèµ„æºï¼Œç»§ç»­è¿è¡Œï¼Œéœ€è¦æ¢å¤ã€‚ç”±äºä¹‹å‰acquireQueuedå‡½æ•°ä¸­çš„parkAndCheckInterruptå‡½æ•°ä¸­è¢«ç¦æ­¢çš„ï¼Œæ‰€ä»¥ï¼Œæ¢å¤åˆ°parkAndCheckInterruptå‡½æ•°ä¸­ï¼Œä¸»è¦çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹ è¯´æ˜: æœ€åï¼Œsync queueé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªç»“ç‚¹ï¼Œå¹¶ä¸”å¤´èŠ‚ç‚¹å°¾èŠ‚ç‚¹å‡æŒ‡å‘å®ƒï¼ŒAQSçš„stateå€¼ä¸º1ï¼Œè¡¨ç¤ºæ­¤æ—¶æœ‰ä¸€ä¸ªå†™çº¿ç¨‹ã€‚ wt1æ‰§è¡ŒrrwLock.writeLock().unlockæ“ä½œï¼Œä¸»è¦çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹ã€‚ è¯´æ˜: æ­¤æ—¶ï¼ŒAQSçš„stateä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰ä»»ä½•è¯»çº¿ç¨‹æˆ–è€…å†™çº¿ç¨‹äº†ã€‚å¹¶ä¸”Sync queueç»“æ„ä¸ä¸Šä¸€ä¸ªçŠ¶æ€çš„ç»“æ„ç›¸åŒï¼Œæ²¡æœ‰å˜åŒ–ã€‚ æ›´æ·±å…¥ç†è§£ä»€ä¹ˆæ˜¯é”å‡é™çº§?é”é™çº§æŒ‡çš„æ˜¯å†™é”é™çº§æˆä¸ºè¯»é”ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ‹¥æœ‰å†™é”ï¼Œç„¶åå°†å…¶é‡Šæ”¾ï¼Œæœ€åå†è·å–è¯»é”ï¼Œè¿™ç§åˆ†æ®µå®Œæˆçš„è¿‡ç¨‹ä¸èƒ½ç§°ä¹‹ä¸ºé”é™çº§ã€‚é”é™çº§æ˜¯æŒ‡æŠŠæŒä½(å½“å‰æ‹¥æœ‰çš„)å†™é”ï¼Œå†è·å–åˆ°è¯»é”ï¼Œéšåé‡Šæ”¾(å…ˆå‰æ‹¥æœ‰çš„)å†™é”çš„è¿‡ç¨‹ã€‚ æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªé”é™çº§çš„ç¤ºä¾‹ã€‚å› ä¸ºæ•°æ®ä¸å¸¸å˜åŒ–ï¼Œæ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘åœ°è¿›è¡Œæ•°æ®å¤„ç†ï¼Œå½“æ•°æ®å˜æ›´åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ„ŸçŸ¥åˆ°æ•°æ®å˜åŒ–ï¼Œåˆ™è¿›è¡Œæ•°æ®çš„å‡†å¤‡å·¥ä½œï¼ŒåŒæ—¶å…¶ä»–å¤„ç†çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹å®Œæˆæ•°æ®çš„å‡†å¤‡å·¥ä½œï¼Œå¦‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415161718192021222324public void processData() &#123; readLock.lock(); if (!update) &#123; // å¿…é¡»å…ˆé‡Šæ”¾è¯»é” readLock.unlock(); // é”é™çº§ä»å†™é”è·å–åˆ°å¼€å§‹ writeLock.lock(); try &#123; if (!update) &#123; // å‡†å¤‡æ•°æ®çš„æµç¨‹(ç•¥) update = true; &#125; readLock.lock(); &#125; finally &#123; writeLock.unlock(); &#125; // é”é™çº§å®Œæˆï¼Œå†™é”é™çº§ä¸ºè¯»é” &#125; try &#123; // ä½¿ç”¨æ•°æ®çš„æµç¨‹(ç•¥) &#125; finally &#123; readLock.unlock(); &#125;&#125; ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå½“æ•°æ®å‘ç”Ÿå˜æ›´åï¼Œupdateå˜é‡(å¸ƒå°”ç±»å‹ä¸”volatileä¿®é¥°)è¢«è®¾ç½®ä¸ºfalseï¼Œæ­¤æ—¶æ‰€æœ‰è®¿é—®processData()æ–¹æ³•çš„çº¿ç¨‹éƒ½èƒ½å¤Ÿæ„ŸçŸ¥åˆ°å˜åŒ–ï¼Œä½†åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°å†™é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šè¢«é˜»å¡åœ¨è¯»é”å’Œå†™é”çš„lock()æ–¹æ³•ä¸Šã€‚å½“å‰çº¿ç¨‹è·å–å†™é”å®Œæˆæ•°æ®å‡†å¤‡ä¹‹åï¼Œå†è·å–è¯»é”ï¼Œéšåé‡Šæ”¾å†™é”ï¼Œå®Œæˆé”é™çº§ã€‚ é”é™çº§ä¸­è¯»é”çš„è·å–æ˜¯å¦å¿…è¦å‘¢? ç­”æ¡ˆæ˜¯å¿…è¦çš„ã€‚ä¸»è¦æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸è·å–è¯»é”è€Œæ˜¯ç›´æ¥é‡Šæ”¾å†™é”ï¼Œå‡è®¾æ­¤åˆ»å¦ä¸€ä¸ªçº¿ç¨‹(è®°ä½œçº¿ç¨‹T)è·å–äº†å†™é”å¹¶ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ— æ³•æ„ŸçŸ¥çº¿ç¨‹Tçš„æ•°æ®æ›´æ–°ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–è¯»é”ï¼Œå³éµå¾ªé”é™çº§çš„æ­¥éª¤ï¼Œåˆ™çº¿ç¨‹Tå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹ä½¿ç”¨æ•°æ®å¹¶é‡Šæ”¾è¯»é”ä¹‹åï¼Œçº¿ç¨‹Tæ‰èƒ½è·å–å†™é”è¿›è¡Œæ•°æ®æ›´æ–°ã€‚ RentrantReadWriteLockä¸æ”¯æŒé”å‡çº§(æŠŠæŒè¯»é”ã€è·å–å†™é”ï¼Œæœ€åé‡Šæ”¾è¯»é”çš„è¿‡ç¨‹)ã€‚ç›®çš„ä¹Ÿæ˜¯ä¿è¯æ•°æ®å¯è§æ€§ï¼Œå¦‚æœè¯»é”å·²è¢«å¤šä¸ªçº¿ç¨‹è·å–ï¼Œå…¶ä¸­ä»»æ„çº¿ç¨‹æˆåŠŸè·å–äº†å†™é”å¹¶æ›´æ–°äº†æ•°æ®ï¼Œåˆ™å…¶æ›´æ–°å¯¹å…¶ä»–è·å–åˆ°è¯»é”çš„çº¿ç¨‹æ˜¯ä¸å¯è§çš„ã€‚ å‚è€ƒæ–‡ç«  æ–‡ç« ä¸»è¦å‚è€ƒè‡ªleesfçš„https://www.cnblogs.com/leesf456/p/5419132.htmlï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšäº†å¢æ”¹ã€‚ https://blog.csdn.net/jiankunking/article/details/83954263","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"è°·æ­Œå¤§æ¨¡å‹-Gemini å¿«é€Ÿå¼€å§‹","path":"/2023/12/25/è°·æ­Œå¤§æ¨¡å‹-Gemini-å¿«é€Ÿå¼€å§‹/","content":"å¼•è¨€è¿‘æœŸç›¸ä¿¡å¤§å®¶éƒ½å¬è¯´äº†è°·æ­Œå¤§æ¨¡å‹ï¼šGemini Geminiå®˜ç½‘è®¿é—®å®˜æ–¹ç½‘ç«™ï¼š å®˜ç½‘åœ°å€ï¼šGoogle AI for Developers å®˜æ–¹å·²ç»æä¾›äº†ä½“éªŒå…¥å£ï¼Œå¤§å®¶å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä½“éªŒè°·æ­Œå‘å¸ƒçš„æœ€å¤§ä¸”èƒ½åŠ›æœ€å¼ºçš„AIæ¨¡å‹ã€‚ ã€Œä½¿ç”¨æ¡ä»¶ï¼šã€ Googleè´¦å· ç§‘å­¦ä¸Šç½‘ å¦‚ä½•Geminiä½¿ç”¨ç‚¹å‡»ä¸Šå›¾ä¸­ Get API key in Google AI Studio, æ‰“å¼€Google AI Studioã€‚å¦‚æœæ˜¯é¦–æ¬¡æ‰“å¼€ï¼Œåˆ™éœ€è¦åŒæ„ç›¸å…³æœåŠ¡æ¡æ¬¾ï¼š ç¬¬ä¸€æ¡å¿…é¡»é€‰æ‹©ï¼Œç¬¬äºŒæ¡å’Œç¬¬ä¸‰æ¡å¯ä»¥ä¸é€‰! æœåŠ¡æ¡æ¬¾ ä½¿ç”¨Geminiçš„ä¸¤ç§æ–¹å¼å¦‚ä¸‹å›¾ï¼ŒGoogleç›®å‰æä¾›äº†ä¸¤ç§ä½¿ç”¨Geminiçš„æ–¹å¼ï¼šGoogle AI Studio å’Œ Develop in your own environmentï¼Œå³åœ¨ç±»ä¼¼äºChatGPTçš„é¡µé¢ä¸Šç›´æ¥ä½¿ç”¨å’Œæ–¹ä¾¿å¼€å‘è€…åœ¨è‡ªå·±çš„ç¯å¢ƒä¸­ä½¿ç”¨çš„APIæ–¹å¼ã€‚ é€‰æ‹©ä½¿ç”¨Geminiæ–¹å¼ æ–¹å¼ä¸€ï¼šä½¿ç”¨Google AI Studioï¼Œè¿™é‡Œäº†ä¸èµ·ä¹Ÿå°±æ¢ç´¢äº†ä¸€ä¸‹é¡µé¢æ–¹å¼ Google AI Studio Google AI Studioæä¾›äº†ä¸‰ç§ç±»å‹çš„Promptæ–¹å¼ï¼š ã€ŒFreeForm promptï¼ˆè‡ªç”±å¼æç¤ºè¯­ï¼‰ã€ è¯¥æç¤ºä¸ºç”Ÿæˆå†…å®¹å’Œå¯¹åº”æŒ‡ä»¤çš„å“åº”æä¾›äº†å¼€æ”¾å¼çš„æç¤ºä½“éªŒã€‚æ‚¨å¯ä»¥ä½¿ç”¨å›¾åƒå’Œæ–‡æœ¬ä½œä¸ºæç¤ºã€‚ ã€ŒStructured promptï¼ˆç»“æ„åŒ–æç¤ºè¯­ï¼‰ã€ è¿™ç§æç¤ºæŠ€æœ¯å…è®¸æ‚¨é€šè¿‡æä¾›ä¸€ç»„ç¤ºä¾‹è¯·æ±‚å’Œåº”ç­”æ¥æŒ‡å¯¼æ¨¡å‹è¾“å‡ºã€‚å½“æ‚¨éœ€è¦å¯¹æ¨¡å‹è¾“å‡ºçš„ç»“æ„è¿›è¡Œæ›´å¤šçš„æ§åˆ¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚ ã€ŒChat promptï¼ˆå¯¹è¯å¼æç¤ºè¯­ï¼‰ã€ ä½¿ç”¨å¯¹è¯å¼æç¤ºæ„å»ºå¯¹è¯ä½“éªŒã€‚è¯¥æç¤ºæŠ€æœ¯å…è®¸å¤šæ¬¡è¾“å…¥å’Œå“åº”è½®æµç”Ÿæˆè¾“å‡ºã€‚ è‡ªç”±æ ¼å¼æç¤ºç¤ºä¾‹ï¼šè¯¦ç»†äº†è§£å»ºç­‘ç‰©Gemini çš„å¤šæ¨¡æ€åŠŸèƒ½å¯è®©æ‚¨ç»“åˆä½¿ç”¨å›¾åƒå’Œæ–‡æœ¬æ¥æç¤ºæ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½è¯¦ç»†äº†è§£å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„å»ºç­‘ç‰©ã€‚ ç¬¬ 1 æ­¥ - ä½¿ç”¨æ–‡æœ¬å’Œå›¾ç‰‡åˆ›å»ºæç¤ºå¦‚éœ€åˆ›å»ºå¤šæ¨¡æ€æç¤ºï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š è¿›å…¥ Google AI Studioã€‚ åœ¨å·¦ä¾§é¢æ¿ä¸­ï¼Œä¾æ¬¡é€‰æ‹© æ–°å»º &gt; è‡ªç”±æ ¼å¼æç¤º ã€‚ åœ¨å³ä¾§åˆ—çš„æ¨¡å‹å­—æ®µä¸­ï¼Œé€‰æ‹©æ”¯æŒå›¾åƒçš„æ¨¡å‹ï¼Œä¾‹å¦‚ Gemini Pro Vision æ¨¡å‹ã€‚ åœ¨æç¤ºæ–‡æœ¬åŒºåŸŸä¸­ï¼Œè¾“å…¥ä»¥ä¸‹æ–‡æœ¬ï¼š 1look at the following picture and tell me who is the architect ä»æç¤ºåŒºåŸŸä¸Šæ–¹çš„æ’å…¥æ ä¸­ï¼Œé€‰æ‹© å›¾ç‰‡ ï¼Œç„¶åé€‰æ‹©æŸä¸ªå»ºç­‘ç‰©çš„ç¤ºä¾‹å›¾ç‰‡ã€‚ åœ¨åº”ç”¨çª—å£çš„åº•éƒ¨ï¼Œé€‰æ‹© Run ä»¥ç”Ÿæˆæ­¤è¯·æ±‚çš„å›å¤ã€‚ ç¬¬ 2 æ­¥ - åœ¨æç¤ºç¬¦ä¸­æ·»åŠ å¯æ›¿æ¢çš„å˜é‡åœ¨ç¬¬ 1 æ­¥ä¸­ï¼Œæ‚¨ä½¿ç”¨å›ºå®šçš„æ–‡æœ¬å­—ç¬¦ä¸²å’Œå›¾åƒæç¤ºæ¨¡å‹ã€‚ä½†æœ‰æ—¶ï¼Œæ‚¨å¸Œæœ›èƒ½å¤ŸåŠ¨æ€æ›´æ”¹æç¤ºçš„æŸäº›éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨è¦æ„å»ºäº¤äº’å¼åº”ç”¨ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„ç”¨æˆ·è¾“å…¥æ¥ä¿®æ”¹æç¤ºã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å˜é‡å°†æç¤ºå‚æ•°åŒ–ã€‚ å¦‚éœ€å‘æç¤ºæ·»åŠ å˜é‡ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š é€‰æ‹©è¦åœ¨é—®é¢˜ä¸­æ›¿æ¢çš„å­—è¯æˆ–çŸ­è¯­ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œè¯·é€‰æ‹©æ–‡æœ¬ï¼šwho is the architectã€‚ ä»æç¤ºä¸Šæ–¹çš„ Insert: æ ‡å¤´ä¸­ï¼Œé€‰æ‹© &#123;&#123; &#125;&#125; Test input ã€‚ åœ¨æç¤ºä¸‹æ–¹çš„ Test yourPrompt è¡¨æ ¼ä¸­ï¼Œä¸ºæ‚¨çš„æç¤ºæ·»åŠ ä¸€ä¸ªé¢å¤–çš„å€¼ï¼Œæ–¹æ³•æ˜¯é€‰æ‹©Add test exampleå¹¶è¾“å…¥é¢å¤–çš„æç¤ºå€¼ã€‚æ‚¨å¯ä»¥éšæ„æ·»åŠ å‡ ä¸ªæ–°çš„è¾“å…¥å€¼ã€‚ åœ¨åº”ç”¨çª—å£çš„åº•éƒ¨ï¼Œé€‰æ‹© Run ä»¥ä¸ºæ¯ä¸ªä¸åŒçš„è¯·æ±‚ç”Ÿæˆå›å¤ã€‚ ç¬¬ 3 æ­¥ - ç”¨æ¨¡å‹å‚æ•°è¿›è¡Œå®éªŒåœ¨å¯¹æç¤ºè¿›è¡ŒåŸå‹è®¾è®¡æ—¶ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨åº”ç”¨å³ä¾§çš„è¯•ç”¨æ¨¡å‹è¿è¡Œè®¾ç½®ã€‚ä»¥ä¸‹æ˜¯éœ€è¦äº†è§£çš„å…³é”®è®¾ç½®ï¼š æ¨¡å‹ - é€‰æ‹©æ‚¨è¦å›ç­”é—®é¢˜çš„æ¨¡å‹ã€‚å¦‚éœ€è¯¦ç»†äº†è§£å¯ç”¨çš„æ¨¡å‹å’ŒåŠŸèƒ½ï¼Œè¯·å‚é˜…æ¨¡å‹ã€‚ æ¸©åº¦ - æ§åˆ¶æ¨¡å‹å“åº”å¯ä»¥å…è®¸å¤šå¤§ç¨‹åº¦çš„éšæœºæ€§ã€‚æé«˜æ­¤å€¼å¯è®©æ¨¡å‹ç”Ÿæˆæ›´æ„å¤–ä¸”æ›´å…·åˆ›é€ æ€§çš„å“åº”ã€‚ æœ€å¤§è¾“å‡º - å¢åŠ æ¨¡å‹ä¸ºæ¯ä¸ªè¯·æ±‚è¿”å›çš„å“åº”æ•°ã€‚æ­¤é€‰é¡¹èƒ½å¤Ÿé’ˆå¯¹å•ä¸ªæç¤ºç”Ÿæˆå¤šä¸ªå“åº”ï¼Œæœ‰åŠ©äºå¿«é€Ÿæµ‹è¯•æç¤ºã€‚ Safety settings - è°ƒæ•´ç”¨äºç®¡ç†æ¨¡å‹å“åº”çš„å®‰å…¨è®¾ç½®ã€‚å¦‚éœ€è¯¦ç»†äº†è§£è¿™äº›æ§åˆ¶æªæ–½ï¼Œè¯·å‚é˜…å®‰å…¨è®¾ç½®ã€‚ ç¬¬ 4 æ­¥ - åç»­æ­¥éª¤ç°åœ¨ï¼Œæ‚¨å·²ç»ä¸ºç”Ÿæˆå¼ AI åº”ç”¨è®¾è®¡äº†åŸå‹ï¼Œæ¥ä¸‹æ¥å¯ä»¥ä¿å­˜æ‚¨çš„å·¥ä½œæˆ–ç”Ÿæˆä»£ç ï¼Œä»¥ä¾¿åœ¨æ‚¨è‡ªå·±çš„å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨æ­¤æç¤ºã€‚ å¦‚éœ€ä¿å­˜æ‚¨åˆ›å»ºçš„æç¤ºï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨ Google AI Studio åº”ç”¨çš„å³ä¸Šè§’ï¼Œé€‰æ‹© ä¿å­˜ ã€‚ å¦‚æœæ‚¨å°šæœªå°†åº”ç”¨å…³è”åˆ°æ‚¨çš„ Google äº‘ç«¯ç¡¬ç›˜å¸å·ï¼Œè¯·æ‰§è¡Œæ­¤æ“ä½œã€‚ åœ¨ä¿å­˜æç¤ºå¯¹è¯æ¡†ä¸­ï¼Œè¾“å…¥æç¤ºåç§°å’Œå¯é€‰çš„ è¯´æ˜ ï¼Œç„¶åé€‰æ‹© ä¿å­˜ ã€‚ å¦‚éœ€å°†æ‚¨åˆ›å»ºçš„æç¤ºä»¥ä»£ç çš„å½¢å¼å¯¼å‡ºï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨ Google AI Studio åº”ç”¨çš„å³ä¸Šè§’ï¼Œé€‰æ‹© è·å–ä»£ç  ã€‚ é€‰æ‹©ä¸€ä¸ªç¼–ç¨‹è¯­è¨€æ ‡ç­¾é¡µã€‚ é€‰æ‹©å¤åˆ¶ä»¥å°†æ­¤ä»£ç å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚ æ³¨æ„ ï¼šæ‚¨éœ€è¦ä½¿ç”¨ API å¯†é’¥æ‰èƒ½åœ¨ Google AI Studio ä¹‹å¤–è¿è¡Œæç¤ºä»£ç ï¼Œå› æ­¤è¯·åŠ¡å¿…åˆ›å»ºä¸€ä¸ªå¯†é’¥ï¼Œå¹¶å°†å…¶åŒ…å«åœ¨æç¤ºä»£ç ä¸­ã€‚æ³¨æ„ ï¼šè¯·å°† API å¯†é’¥è§†ä¸ºå¯†ç å¹¶å¦¥å–„ä¿æŠ¤ã€‚è¯·å‹¿å°†æ‚¨çš„å¯†é’¥åµŒå…¥åˆ°å…¬å¼€å‘å¸ƒçš„ä»£ç ä¸­ã€‚ ç»“æ„åŒ–æç¤ºç¤ºä¾‹ï¼šæ„å»ºå•†å“æ–‡æ¡ˆç”Ÿæˆå™¨åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‚¨å·²ç»äº†è§£äº†å¦‚ä½•ä½¿ç”¨æŒ‡ä»¤ï¼ˆâ€œçœ‹å›¾ç‰‡ï¼Œå‘Šè¯‰æˆ‘æ¶æ„å¸ˆæ˜¯è°â€ï¼‰æ¥æç¤ºæ¨¡å‹ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡ç»“åˆè¯´æ˜å’Œç¤ºä¾‹æ¥å‘æ¨¡å‹å‘å‡ºæç¤ºï¼Œä»è€Œè·å¾—æ›´å¥½çš„ç»“æœã€‚Google AI Studio ä¸­çš„ç»“æ„åŒ–æç¤ºå¯å¸®åŠ©æ‚¨åšåˆ°è¿™ä¸€ç‚¹ - å°†æŒ‡ä»¤ä¸ç¤ºä¾‹ç›¸ç»“åˆï¼Œå‘æ¨¡å‹æ˜¾ç¤ºæ‚¨æƒ³è¦çš„è¾“å‡ºç±»å‹ï¼Œè€Œä¸æ˜¯ä»…ä»…æŒ‡ç¤ºæ¨¡å‹è¦æ‰§è¡Œä»€ä¹ˆæ“ä½œã€‚å¦‚æœæ‚¨å¸Œæœ›æ¨¡å‹ä¿æŒä¸€è‡´çš„è¾“å‡ºæ ¼å¼ï¼ˆå³ç»“æ„åŒ– jsonï¼‰æˆ–éš¾ä»¥æè¿°æ¨¡å‹çš„å…·ä½“é£æ ¼ï¼Œè¿™ç§æç¤ºéå¸¸æœ‰ç”¨ã€‚åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæ‚¨å°†äº†è§£å¦‚ä½•åœ¨ Google AI Studio ä¸­åˆ›å»ºç»“æ„åŒ–æç¤ºã€‚ æ³¨æ„ ï¼šæ‚¨å¯ä»¥ç›´æ¥åœ¨ Google AI Studio ä¸­ä»ç¤ºä¾‹åº“ä¸­å°è¯•æ­¤ç¤ºä¾‹ã€‚ ç¬¬ 1 æ­¥ - åˆ›å»ºç»“æ„åŒ–æç¤ºåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ‚¨å°†åˆ›å»ºä¸€ä¸ªç»“æ„åŒ–æç¤ºï¼Œç”¨äºä¸ºäº§å“ç”Ÿæˆå¹¿å‘Šæ–‡æ¡ˆã€‚é¦–å…ˆï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸¤åˆ—ï¼ˆProduct è¾“å…¥åˆ—å’Œ Product copy è¾“å‡ºåˆ—ï¼‰æ¥å®šä¹‰æç¤ºçš„ç»“æ„ã€‚ å¦‚éœ€åˆ›å»ºç»“æ„åŒ–æç¤ºï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨ Google AI Studio Web åº”ç”¨çš„å·¦ä¸Šè§’ï¼Œä¾æ¬¡é€‰æ‹© æ–°å»º &gt; ç»“æ„åŒ–æç¤º ã€‚ åœ¨ Insert: æ ‡å¤´ä¸‹æ–¹ï¼Œæ·»åŠ ç»“æ„åŒ–æç¤ºçš„è¯´æ˜ï¼š 123You are a product marketer targeting a Gen Z audience. Create exciting andfresh advertising copy for products and their simple description. Keep copyunder a few sentences long. é€šè¿‡å°†é»˜è®¤çš„ input: æ–‡æœ¬è¯´æ˜æ›¿æ¢ä¸º Product:ï¼Œä¸º INPUT æ·»åŠ æè¿°æ€§æ ‡é¢˜ã€‚ é€šè¿‡å°†é»˜è®¤çš„ output: æ–‡æœ¬è¯´æ˜æ›¿æ¢ä¸º Product copy:ï¼Œä¸º OUTPUT æ·»åŠ æè¿°æ€§æ ‡é¢˜ã€‚ æç¤º ï¼šåœ¨åˆ—åç§°æœ«å°¾æ·»åŠ è‹±æ–‡å†’å·ï¼Œä»¥ä¾¿æ¨¡å‹æ›´è½»æ¾åœ°è§£æç»“æ„ã€‚ ç¬¬ 2 æ­¥ - æ·»åŠ ç¤ºä¾‹ç°åœ¨æ‚¨å·²ä¸ºåˆ—å‘½åï¼Œè¯·æä¾›ä¸€äº›ç¤ºä¾‹è¡Œã€‚è¿™äº›è¡Œåº”åŒ…å«ç¤ºä¾‹è¾“å…¥ï¼ˆæœ¬ä¾‹ä¸­çš„äº§å“åç§°ï¼‰å’Œç¤ºä¾‹è¾“å‡ºï¼ˆå¯¹åº”çš„äº§å“è¯´æ˜ï¼‰ã€‚é€šè¿‡ä¸ºæ¨¡å‹æä¾›å‡ ä¸ªç¤ºä¾‹äº§å“è¯´æ˜ï¼Œæ‚¨å¯ä»¥æŒ‡å¯¼æ¨¡å‹åœ¨ç”Ÿæˆè‡ªå·±çš„è¾“å‡ºæ—¶å¤åˆ¶ç±»ä¼¼çš„é£æ ¼ã€‚æ‚¨å¯ä»¥æ‰‹åŠ¨è¾“å…¥ç¤ºä¾‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨â€œå¯¼å…¥æ•°æ®â€èœå•ä»æ–‡ä»¶å¯¼å…¥ã€‚ è¦æ‰‹åŠ¨è¾“å…¥ç¤ºä¾‹ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨é¡¶éƒ¨çš„ç¤ºä¾‹æ•°æ®è¡¨ä¸­ï¼Œé€‰æ‹© Product: æ ‡é¢˜ä¸‹æ–¹çš„å­—æ®µï¼Œç„¶åè¾“å…¥äº§å“è¯´æ˜ã€‚ é€‰æ‹© Product copy: æ ‡é¢˜ä¸‹çš„å­—æ®µï¼Œç„¶åä¸ºæ­¤å•†å“è¾“å…¥ marketing copyã€‚ ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†æ­¤æç¤ºçš„è¾“å…¥å’Œè¾“å‡ºå€¼ï¼š äº§å“ï¼š äº§å“æ–‡æ¡ˆï¼š è€å¼è¿åŠ¨é‹ è®©æˆ‘ä»¬ç³»ä¸Šå®‰å…¨å¸¦ï¼è¿™äº›é‹å­çš„å¤–è§‚å’Œé¢œè‰²ä¹Ÿåˆ«å…·ä¸€æ ¼ï¼Œæ‹¥æœ‰åˆ«å…·ä¸€æ ¼çš„é£æ ¼å’ŒåŠŸèƒ½ã€‚ è¶…æŸ”è½¯è¿å¸½è¡« ç©¿ä¸Šæˆ‘ä»¬å…¨æ–°çš„ç”·å¥³é€šç”¨è¿å¸½è¡«ï¼Œèˆ’é€‚åˆæ—¶å°šï¼è¿™æ¬¾è¿å¸½è¡«ç”± 100% æ£‰åˆ¶æˆï¼ŒæŸ”è½¯èˆ’é€‚ï¼Œå…¨å¤©ä½©æˆ´ã€‚å³ä½¿æ˜¯åœ¨æœ€å†·çš„æ—¥å­ï¼Œé‡Œé¢çš„åŠåˆ·å¢™ä¹Ÿèƒ½è®©ä½ ä¿æŒæ¸©æš–ã€‚ æç¤º ï¼šå¦‚æœæ‚¨è®©ä½œè€…å±è”½æˆ–è€…æ²¡æœ‰ç¤ºä¾‹äº§å“æ–‡æ¡ˆç¤ºä¾‹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è‡ªç”±æ ¼å¼æç¤ºè®©æ–‡æœ¬æ¨¡å‹ä¸ºæ‚¨ç”Ÿæˆä¸€äº›ç¤ºä¾‹ã€‚å¦‚éœ€ä»æ–‡ä»¶å¯¼å…¥ç¤ºä¾‹ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨ç¤ºä¾‹è¡¨çš„å³ä¸Šè§’ï¼Œä¾æ¬¡é€‰æ‹© æ“ä½œ &gt; å¯¼å…¥ç¤ºä¾‹ ã€‚ åœ¨å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹© Google äº‘ç«¯ç¡¬ç›˜ä¸­çš„ CSV æˆ– Google è¡¨æ ¼æ–‡ä»¶ï¼Œæˆ–è€…ä»è®¡ç®—æœºä¸Šä¼ ã€‚ åœ¨â€œå¯¼å…¥ç¤ºä¾‹â€å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©è¦å¯¼å…¥çš„åˆ—ï¼Œè¦æ’é™¤å“ªäº›åˆ—ã€‚é€šè¿‡è¯¥å¯¹è¯æ¡†ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨ç»“æ„åŒ–æç¤ºä¸­æŒ‡å®šå°†å“ªä¸ªæ•°æ®åˆ—å¯¼å…¥å“ªä¸ªè¡¨åˆ—ã€‚ ç¬¬ 3 æ­¥ - æµ‹è¯•æ‚¨çš„æç¤ºå‡†å¤‡å¥½å‘æ¨¡å‹æ˜¾ç¤ºæ‰€éœ€å†…å®¹çš„ç¤ºä¾‹åï¼Œåœ¨åº•éƒ¨çš„æµ‹è¯•æ‚¨çš„æç¤ºè¡¨ä¸­ä½¿ç”¨æ–°è¾“å…¥æ¥æµ‹è¯•æç¤ºã€‚ä¸æ–‡æœ¬æç¤ºç±»å‹ä¸€æ ·ï¼Œæ‚¨å¯ä»¥è°ƒæ•´æ¨¡å‹å‚æ•°ï¼Œä»¥æµ‹è¯•è¿™äº›å‚æ•°æ˜¯å¦æœ‰åŠ©äºä¸ºæ‚¨çš„ä½¿ç”¨åœºæ™¯ç”Ÿæˆæ›´å¥½çš„ç»“æœã€‚ æŸ¥çœ‹å¦‚ä½•å°†æ ·æœ¬å‘é€åˆ°æ¨¡å‹ä»æœ¬è´¨ä¸Šè®²ï¼ŒGoogle AI Studio ä¼šå°†æŒ‡ä»¤ä¸æ‚¨æä¾›çš„ç¤ºä¾‹ç›¸ç»“åˆæ¥æ„å»ºæç¤ºã€‚éšç€æ‚¨æ·»åŠ æ›´å¤šæ ·æœ¬ï¼Œè¿™äº›æ ·æœ¬ä¼šæ·»åŠ åˆ°å‘é€ç»™æ¨¡å‹çš„æ–‡æœ¬ä¸­ã€‚æ ¹æ®æ ·æœ¬çš„é•¿åº¦ï¼Œæ‚¨å¯èƒ½ä¼šå¼€å§‹è¾¾åˆ°æ¨¡å‹çš„è¯å…ƒé™åˆ¶ã€‚æ‰€æœ‰ç”Ÿæˆå¼ AI æ¨¡å‹éƒ½æœ‰ä»¤ç‰Œé™åˆ¶ï¼Œå³å®ƒä»¬å¯ä»¥æ¥å—ä½œä¸ºè¾“å…¥çš„æ–‡æœ¬çš„æœ€å¤§é•¿åº¦ã€‚ å¦‚éœ€æŸ¥çœ‹æç¤ºçš„å®Œæ•´å†…å®¹ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š é€‰æ‹© Google AI Studio Web åº”ç”¨åº•éƒ¨çš„ æ–‡æœ¬é¢„è§ˆ ã€‚ æ³¨æ„ ï¼šæ¨¡å‹ä»¤ç‰Œé™åˆ¶æ˜¾ç¤ºåœ¨é¢„è§ˆçª—æ ¼åº•éƒ¨ã€‚ ç¬¬ 4 æ­¥ - åç»­æ­¥éª¤å¦‚æœæ‚¨å¯¹æç¤ºæ„Ÿåˆ°æ»¡æ„ï¼Œå¯ä»¥ç‚¹å‡»è·å–ä»£ç æŒ‰é’®å°†å…¶ä¿å­˜æˆ–å¯¼å‡ºåˆ°ä»£ç ä¸­ã€‚ æ‚¨è¿˜å¯ä»¥å°†å„ä¸ªå°‘æ ·æœ¬æ ·æœ¬å¯¼å‡ºåˆ° CSV æ–‡ä»¶æˆ– Google è¡¨æ ¼ä¸­ã€‚é€‰æ‹©æ“ä½œèœå•ä¸‹çš„å¯¼å‡ºç¤ºä¾‹é€‰é¡¹ä»¥å¯¼å‡ºæ‚¨çš„ç¤ºä¾‹ã€‚ èŠå¤©æç¤ºç¤ºä¾‹ï¼šæ„å»ºè‡ªå®šä¹‰èŠå¤©åº”ç”¨å¦‚æœæ‚¨ä½¿ç”¨è¿‡ Bard ç­‰é€šç”¨èŠå¤©æœºå™¨äººï¼Œå°±èƒ½äº²èº«ä½“éªŒç”Ÿæˆå¼ AI æ¨¡å‹åœ¨å¼€æ”¾å¼å¯¹è¯æ–¹é¢çš„å¼ºå¤§ä¹‹å¤„ã€‚è™½ç„¶è¿™äº›é€šç”¨èŠå¤©æœºå™¨äººéå¸¸æœ‰ç”¨ï¼Œä½†å®ƒä»¬é€šå¸¸éœ€è¦é’ˆå¯¹ç‰¹å®šä½¿ç”¨åœºæ™¯è¿›è¡Œå®šåˆ¶ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½å¸Œæœ›æ„å»ºä¸€ä¸ªå®¢æˆ·æœåŠ¡èŠå¤©æœºå™¨äººï¼Œå®ƒä»…æ”¯æŒæœ‰å…³å…¬å¸äº§å“çš„å¯¹è¯çš„å¯¹è¯ã€‚æ‚¨å¯èƒ½éœ€è¦æ„å»ºä¸€ä¸ªä½¿ç”¨ç‰¹å®šè¯­æ°”æˆ–é£æ ¼çš„èŠå¤©æœºå™¨äººï¼šä¸€ä¸ªå¯ä»¥è®²å¤§é‡ç¬‘è¯ã€åƒè¯—äººæŠ¼éŸµçš„æœºå™¨äººï¼Œæˆ–åœ¨å›ç­”ä¸­ä½¿ç”¨å¤§é‡è¡¨æƒ…ç¬¦å·ã€‚ æ­¤ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Google AI Studio æ„å»ºä¸€ä¸ªå‹å¥½çš„èŠå¤©æœºå™¨äººï¼Œå®ƒå°±åƒæ˜¯å±…ä½åœ¨æœ¨æ˜Ÿçš„ä¸€é¢—å«æ˜Ÿâ€œæ¬§ç½—å·´â€ä¸Šçš„å¤–æ˜Ÿäººä¸€æ ·è¿›è¡Œæ²Ÿé€šã€‚ ç¬¬ 1 æ­¥ - åˆ›å»ºèŠå¤©æç¤ºåœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ï¼Œæ‚¨è®¾è®¡äº†ä½¿ç”¨è¾“å…¥å’Œè¾“å‡ºç¤ºä¾‹ç»„åˆçš„ç»“æ„åŒ–æç¤ºã€‚åŒæ ·ï¼Œå¦‚éœ€æ„å»ºèŠå¤©æœºå™¨äººï¼Œæ‚¨éœ€è¦æä¾›ç”¨æˆ·å’ŒèŠå¤©æœºå™¨äººä¹‹é—´çš„äº’åŠ¨ç¤ºä¾‹ï¼Œä»¥æŒ‡å¯¼æ¨¡å‹æä¾›æ‚¨éœ€è¦çš„å“åº”ã€‚ å¦‚éœ€åˆ›å»ºèŠå¤©æç¤ºï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨ Google AI Studio Web åº”ç”¨çš„å·¦ä¸Šè§’ï¼Œä¾æ¬¡é€‰æ‹© æ–°å»º &gt; Chat æç¤º ã€‚ åœ¨æç¤ºç•Œé¢çš„ç¼–å†™æç¤ºç¤ºä¾‹åˆ—ä¸­ï¼Œæ‚¨å¯ä»¥å¼€å§‹æä¾›äº’åŠ¨ç¤ºä¾‹ã€‚æ‚¨è¿˜å¯ä»¥åœ¨ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­æä¾›å…¶ä»–ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚ï¼š 123User: You are Tim, a friendly alien that lives on Europa, one ofJupiter&#x27;s moons.Model: Ok User å’Œ Model å­—æ®µä¸­æä¾›äº†ç”¨æˆ·å’ŒèŠå¤©æœºå™¨äººä¹‹é—´çš„äº’åŠ¨ç¤ºä¾‹ï¼š 123User: Hi!Model: Hi! My name is Tim and I live on Europa, one of Jupiter&#x27;s moons. Brr!It&#x27;s cold down here! å¡«å†™å®Œç¤ºä¾‹åï¼Œé€šè¿‡åœ¨èŠå¤©æç¤ºç•Œé¢çš„å³ä¾§çª—æ ¼ä¸­ä¸æ¨¡å‹èŠå¤©æ¥å¼€å§‹æµ‹è¯•æ‚¨çš„åº”ç”¨ã€‚ å¦‚éœ€æµ‹è¯•èŠå¤©æœºå™¨äººçš„è¡Œä¸ºï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨æµ‹è¯•æç¤ºé¢æ¿ä¸­ï¼Œé€‰æ‹©åº•éƒ¨çš„è¾“å…¥å­—æ®µã€‚ è¾“å…¥ç”¨æˆ·å¯èƒ½æå‡ºçš„é—®é¢˜æˆ–è§‚å¯Ÿç»“æœï¼Œä¾‹å¦‚ï¼š 1What&#x27;s the weather like? é€‰æ‹©è¾“å…¥å­—æ®µå³ä¾§çš„è±å½¢æŒ‰é’®ï¼Œä»¥è·å–èŠå¤©æœºå™¨äººçš„å“åº”ï¼Œå“åº”å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š 1Model:The weather on Europais very cold and icy.... ç¬¬ 2 æ­¥ - è®­ç»ƒèŠå¤©æœºå™¨äººæ›´å¥½åœ°èŠå¤©é€šè¿‡æä¾›ä¸€ä¸ªè¯­å¥å’Œå“åº”ç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥æ„å»ºä¸€ä¸ªåŸºæœ¬çš„æ¬§ç½—å·´å¤–æ˜ŸèŠå¤©æœºå™¨äººã€‚ä½†æ˜¯ï¼Œå•ä¸ªæ ·æœ¬é€šå¸¸ä¸è¶³ä»¥ç¡®ä¿æ¨¡å‹å“åº”çš„ä¸€è‡´æ€§å’Œè´¨é‡ã€‚å¦‚æœæ²¡æœ‰è¿›ä¸€æ­¥è¾“å…¥ï¼Œæ¨¡å‹å¯¹å¤©æ°”ç›¸å…³é—®é¢˜çš„å›ç­”å¾€å¾€ä¼šå¾ˆé•¿ï¼Œå¬èµ·æ¥åƒæ˜¯æ•™ç§‘ä¹¦é‡Œçš„å›ç­”ï¼Œè€Œä¸æ˜¯å‹å¥½çš„å¤–æ˜Ÿäººç»™å‡ºçš„å›ç­”ã€‚ ä½¿ç”¨æ¨¡å‹å“åº”å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œä»¥åŒ¹é…å¤–æ˜ŸèŠå¤©æœºå™¨äººæ‰€éœ€çš„è¯­æ°”å’Œé£æ ¼ï¼Œä»è€Œè‡ªå®šä¹‰èŠå¤©æœºå™¨äººçš„è¯­æ°”ã€‚ å¦‚éœ€æ·»åŠ å’Œä¿®æ”¹èŠå¤©æœºå™¨äººå®šä¹‰çš„ç¤ºä¾‹ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š åœ¨ Test yourPrompt é¢æ¿ä¸­ï¼Œå°†å…‰æ ‡æ‚¬åœåœ¨ User æ ‡é¢˜çš„å·¦ä¾§ï¼Œç„¶åé€‰æ‹© Add to examples æŒ‰é’®ã€‚ åœ¨ç¼–å†™æç¤ºç¤ºä¾‹åˆ—ä¸­ï¼Œä¿®æ”¹å¤åˆ¶çš„è¾“å…¥å’Œå“åº”ï¼Œä»¥åŒ¹é…èŠå¤©æœºå™¨äººçš„é¢„æœŸé£æ ¼å’Œè¯­æ°”ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ·»åŠ æ›´å¤šç¤ºä¾‹ã€‚æå‡ºæ›´å¤šé—®é¢˜ã€ä¿®æ”¹ç­”æ¡ˆï¼Œå¹¶æé«˜èŠå¤©æœºå™¨äººçš„è´¨é‡ã€‚ç»§ç»­æ·»åŠ ç¤ºä¾‹ï¼Œå¹¶æµ‹è¯•è¿™äº›ç¤ºä¾‹ä¼šå¦‚ä½•ä¿®æ”¹èŠå¤©æœºå™¨äººçš„è¡Œä¸ºã€‚é€šå¸¸ï¼Œç¤ºä¾‹è¶Šå¤šï¼ŒèŠå¤©æœºå™¨äººå“åº”çš„è´¨é‡è¶Šé«˜ã€‚ åœ¨åå°ï¼ŒGoogle AI Studio ä¼šé€šè¿‡ç»„åˆä»¥ä¸‹å„é¡¹æ¥æ„å»ºæç¤ºï¼š å¯¹è¯æ¡†ç¤ºä¾‹ å¯¹è¯è®°å½• æ–‡æœ¬å—ä¼ é€’ç»™æ¨¡å‹ã€‚å¦‚éœ€æŸ¥çœ‹å®Œæ•´çš„æç¤ºæ˜¯ä»€ä¹ˆæ ·å­ï¼Œè¯·ç‚¹å‡»å±å¹•åº•éƒ¨çš„ Preview ï¼Œä»¥è°ƒå‡ºé¢„è§ˆçª—æ ¼ã€‚ è¯·æ³¨æ„ï¼Œç”±äºæ¨¡å‹ä¸ç”¨æˆ·ä¹‹é—´çš„æ¯æ¡æ¶ˆæ¯éƒ½åŒ…å«åœ¨æç¤ºä¸­ï¼ˆè¿™å°±æ˜¯â€œå¯¹è¯è®°å½•â€ï¼‰ï¼Œå› æ­¤å¯¹è¯æç¤ºå¯èƒ½ä¼šéšç€å¯¹è¯çš„è¿›è¡Œè€Œå¢é•¿ã€‚æœ€ç»ˆï¼Œæ‚¨å¯èƒ½ä¼šè¾¾åˆ°æ¨¡å‹çš„è¯å…ƒé™åˆ¶ï¼Œå³æ¨¡å‹å¯ä»¥æ¥å—çš„æ–‡æœ¬é•¿åº¦ä¸Šé™ã€‚æ‚¨å¯ä»¥åœ¨é¢„è§ˆæ ‡ç­¾é¡µä¸­æŸ¥çœ‹å®Œæ•´çš„å¯¹è¯å’Œä»¤ç‰Œæ•°é‡ã€‚ ç¬¬ 3 æ­¥ - ç”¨æ¨¡å‹å‚æ•°è¿›è¡Œå®éªŒæ‚¨è¿˜å¯ä»¥å°è¯•è°ƒæ•´æ¨¡å‹å‚æ•°ï¼Œä»¥æŸ¥çœ‹å®ƒä»¬æ˜¯å¦ä¸ºæ‚¨çš„ä½¿ç”¨åœºæ™¯ç”Ÿæˆäº†æ›´åˆé€‚çš„ç»“æœã€‚ ç¬¬ 4 æ­¥ - åç»­æ­¥éª¤ä¸å…¶ä»–æç¤ºç±»å‹ç±»ä¼¼ï¼Œä¸€æ—¦å¯¹æç¤ºçš„åŸå‹è®¾è®¡ç¬¦åˆæ‚¨çš„è¦æ±‚ï¼Œæ‚¨å°±å¯ä»¥ä½¿ç”¨è·å–ä»£ç æŒ‰é’®å¼€å§‹ç¼–å†™ä»£ç ï¼Œæˆ–ä¿å­˜æç¤ºï¼Œä»¥ä¾¿ç¨åå¤„ç†å¹¶ä¸ä»–äººåˆ†äº«ã€‚ å‚è€ƒï¼šhttps://ai.google.dev/tutorials/ai-studio_quickstart","tags":["Google","äººå·¥æ™ºèƒ½","Gemini"],"categories":["äººå·¥æ™ºèƒ½"]},{"title":"12.JUCé”: ReentrantLockè¯¦è§£","path":"/2023/12/25/12-JUCé”-ReentrantLockè¯¦è§£/","content":"å¯é‡å…¥é”ReentrantLockçš„åº•å±‚æ˜¯é€šè¿‡AbstractQueuedSynchronizerå®ç°ï¼Œæ‰€ä»¥å…ˆè¦å­¦ä¹ ä¸Šä¸€ç« èŠ‚AbstractQueuedSynchronizerè¯¦è§£ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ ä»€ä¹ˆæ˜¯å¯é‡å…¥ï¼Œä»€ä¹ˆæ˜¯å¯é‡å…¥é”? å®ƒç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜? ReentrantLockçš„æ ¸å¿ƒæ˜¯AQSï¼Œé‚£ä¹ˆå®ƒæ€ä¹ˆæ¥å®ç°çš„ï¼Œç»§æ‰¿å—? è¯´è¯´å…¶ç±»å†…éƒ¨ç»“æ„å…³ç³»ã€‚ ReentrantLockæ˜¯å¦‚ä½•å®ç°å…¬å¹³é”çš„? ReentrantLockæ˜¯å¦‚ä½•å®ç°éå…¬å¹³é”çš„? ReentrantLocké»˜è®¤å®ç°çš„æ˜¯å…¬å¹³è¿˜æ˜¯éå…¬å¹³é”? ä½¿ç”¨ReentrantLockå®ç°å…¬å¹³å’Œéå…¬å¹³é”çš„ç¤ºä¾‹? ReentrantLockå’ŒSynchronizedçš„å¯¹æ¯”? ReentrantLockæºç åˆ†æç±»çš„ç»§æ‰¿å…³ç³»ReentrantLockå®ç°äº†Lockæ¥å£ï¼ŒLockæ¥å£ä¸­å®šä¹‰äº†lockä¸unlockç›¸å…³æ“ä½œï¼Œå¹¶ä¸”è¿˜å­˜åœ¨newConditionæ–¹æ³•ï¼Œè¡¨ç¤ºç”Ÿæˆä¸€ä¸ªæ¡ä»¶ã€‚ 1public class ReentrantLock implements Lock, java.io.Serializable ç±»çš„å†…éƒ¨ç±»ReentrantLockæ€»å…±æœ‰ä¸‰ä¸ªå†…éƒ¨ç±»ï¼Œå¹¶ä¸”ä¸‰ä¸ªå†…éƒ¨ç±»æ˜¯ç´§å¯†ç›¸å…³çš„ï¼Œä¸‹é¢å…ˆçœ‹ä¸‰ä¸ªç±»çš„å…³ç³»ã€‚ è¯´æ˜: ReentrantLockç±»å†…éƒ¨æ€»å…±å­˜åœ¨Syncã€NonfairSyncã€FairSyncä¸‰ä¸ªç±»ï¼ŒNonfairSyncä¸FairSyncç±»ç»§æ‰¿è‡ªSyncç±»ï¼ŒSyncç±»ç»§æ‰¿è‡ªAbstractQueuedSynchronizeræŠ½è±¡ç±»ã€‚ä¸‹é¢é€ä¸ªè¿›è¡Œåˆ†æã€‚ Syncç±» Syncç±»çš„æºç å¦‚ä¸‹: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687abstract static class Sync extends AbstractQueuedSynchronizer &#123; // åºåˆ—å· private static final long serialVersionUID = -5179523762034025860L; // è·å–é” abstract void lock(); // éå…¬å¹³æ–¹å¼è·å– final boolean nonfairTryAcquire(int acquires) &#123; // å½“å‰çº¿ç¨‹ final Thread current = Thread.currentThread(); // è·å–çŠ¶æ€ int c = getState(); if (c == 0) &#123; // è¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹æ­£åœ¨ç«äº‰è¯¥é” if (compareAndSetState(0, acquires)) &#123; // æ¯”è¾ƒå¹¶è®¾ç½®çŠ¶æ€æˆåŠŸï¼ŒçŠ¶æ€0è¡¨ç¤ºé”æ²¡æœ‰è¢«å ç”¨ // è®¾ç½®å½“å‰çº¿ç¨‹ç‹¬å  setExclusiveOwnerThread(current); return true; // æˆåŠŸ &#125; &#125; else if (current == getExclusiveOwnerThread()) &#123; // å½“å‰çº¿ç¨‹æ‹¥æœ‰è¯¥é” int nextc = c + acquires; // å¢åŠ é‡å…¥æ¬¡æ•° if (nextc &lt; 0) // overflow throw new Error(&quot;Maximum lock count exceeded&quot;); // è®¾ç½®çŠ¶æ€ setState(nextc); // æˆåŠŸ return true; &#125; // å¤±è´¥ return false; &#125; // è¯•å›¾åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ï¼Œæ­¤æ–¹æ³•åº”è¯¥æŸ¥è¯¢æ˜¯å¦å…è®¸å®ƒåœ¨å…±äº«æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ï¼Œå¦‚æœå…è®¸ï¼Œåˆ™è·å–å®ƒ protected final boolean tryRelease(int releases) &#123; int c = getState() - releases; if (Thread.currentThread() != getExclusiveOwnerThread()) // å½“å‰çº¿ç¨‹ä¸ä¸ºç‹¬å çº¿ç¨‹ throw new IllegalMonitorStateException(); // æŠ›å‡ºå¼‚å¸¸ // é‡Šæ”¾æ ‡è¯† boolean free = false; if (c == 0) &#123; free = true; // å·²ç»é‡Šæ”¾ï¼Œæ¸…ç©ºç‹¬å  setExclusiveOwnerThread(null); &#125; // è®¾ç½®æ ‡è¯† setState(c); return free; &#125; // åˆ¤æ–­èµ„æºæ˜¯å¦è¢«å½“å‰çº¿ç¨‹å æœ‰ protected final boolean isHeldExclusively() &#123; // While we must in general read state before owner, // we don&#x27;t need to do so to check if current thread is owner return getExclusiveOwnerThread() == Thread.currentThread(); &#125; // æ–°ç”Ÿä¸€ä¸ªæ¡ä»¶ final ConditionObject newCondition() &#123; return new ConditionObject(); &#125; // Methods relayed from outer class // è¿”å›èµ„æºçš„å ç”¨çº¿ç¨‹ final Thread getOwner() &#123; return getState() == 0 ? null : getExclusiveOwnerThread(); &#125; // è¿”å›çŠ¶æ€ final int getHoldCount() &#123; return isHeldExclusively() ? getState() : 0; &#125; // èµ„æºæ˜¯å¦è¢«å ç”¨ final boolean isLocked() &#123; return getState() != 0; &#125; /** * Reconstitutes the instance from a stream (that is, deserializes it). */ // è‡ªå®šä¹‰ååºåˆ—åŒ–é€»è¾‘ private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException &#123; s.defaultReadObject(); setState(0); // reset to unlocked state &#125;&#125; Syncç±»å­˜åœ¨å¦‚ä¸‹æ–¹æ³•å’Œä½œç”¨å¦‚ä¸‹ã€‚ NonfairSyncç±» NonfairSyncç±»ç»§æ‰¿äº†Syncç±»ï¼Œè¡¨ç¤ºé‡‡ç”¨éå…¬å¹³ç­–ç•¥è·å–é”ï¼Œå…¶å®ç°äº†Syncç±»ä¸­æŠ½è±¡çš„lockæ–¹æ³•ï¼Œæºç å¦‚ä¸‹: 12345678910111213141516171819// éå…¬å¹³é”static final class NonfairSync extends Sync &#123; // ç‰ˆæœ¬å· private static final long serialVersionUID = 7316153563782823691L; // è·å¾—é” final void lock() &#123; if (compareAndSetState(0, 1)) // æ¯”è¾ƒå¹¶è®¾ç½®çŠ¶æ€æˆåŠŸï¼ŒçŠ¶æ€0è¡¨ç¤ºé”æ²¡æœ‰è¢«å ç”¨ // æŠŠå½“å‰çº¿ç¨‹è®¾ç½®ç‹¬å äº†é” setExclusiveOwnerThread(Thread.currentThread()); else // é”å·²ç»è¢«å ç”¨ï¼Œæˆ–è€…setå¤±è´¥ // ä»¥ç‹¬å æ¨¡å¼è·å–å¯¹è±¡ï¼Œå¿½ç•¥ä¸­æ–­ acquire(1); &#125; protected final boolean tryAcquire(int acquires) &#123; return nonfairTryAcquire(acquires); &#125;&#125; è¯´æ˜: ä»lockæ–¹æ³•çš„æºç å¯çŸ¥ï¼Œæ¯ä¸€æ¬¡éƒ½å°è¯•è·å–é”ï¼Œè€Œå¹¶ä¸ä¼šæŒ‰ç…§å…¬å¹³ç­‰å¾…çš„åŸåˆ™è¿›è¡Œç­‰å¾…ï¼Œè®©ç­‰å¾…æ—¶é—´æœ€ä¹…çš„çº¿ç¨‹è·å¾—é”ã€‚ FairSynç±» FairSyncç±»ä¹Ÿç»§æ‰¿äº†Syncç±»ï¼Œè¡¨ç¤ºé‡‡ç”¨å…¬å¹³ç­–ç•¥è·å–é”ï¼Œå…¶å®ç°äº†Syncç±»ä¸­çš„æŠ½è±¡lockæ–¹æ³•ï¼Œæºç å¦‚ä¸‹: 12345678910111213141516171819202122232425262728293031323334353637383940// å…¬å¹³é”static final class FairSync extends Sync &#123; // ç‰ˆæœ¬åºåˆ—åŒ– private static final long serialVersionUID = -3000897897090466540L; final void lock() &#123; // ä»¥ç‹¬å æ¨¡å¼è·å–å¯¹è±¡ï¼Œå¿½ç•¥ä¸­æ–­ acquire(1); &#125; /** * Fair version of tryAcquire. Don&#x27;t grant access unless * recursive call or no waiters or is first. */ // å°è¯•å…¬å¹³è·å–é” protected final boolean tryAcquire(int acquires) &#123; // è·å–å½“å‰çº¿ç¨‹ final Thread current = Thread.currentThread(); // è·å–çŠ¶æ€ int c = getState(); if (c == 0) &#123; // çŠ¶æ€ä¸º0 if (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(0, acquires)) &#123; // ä¸å­˜åœ¨å·²ç»ç­‰å¾…æ›´ä¹…çš„çº¿ç¨‹å¹¶ä¸”æ¯”è¾ƒå¹¶ä¸”è®¾ç½®çŠ¶æ€æˆåŠŸ // è®¾ç½®å½“å‰çº¿ç¨‹ç‹¬å  setExclusiveOwnerThread(current); return true; &#125; &#125; else if (current == getExclusiveOwnerThread()) &#123; // çŠ¶æ€ä¸ä¸º0ï¼Œå³èµ„æºå·²ç»è¢«çº¿ç¨‹å æ® // ä¸‹ä¸€ä¸ªçŠ¶æ€ int nextc = c + acquires; if (nextc &lt; 0) // è¶…è¿‡äº†intçš„è¡¨ç¤ºèŒƒå›´ throw new Error(&quot;Maximum lock count exceeded&quot;); // è®¾ç½®çŠ¶æ€ setState(nextc); return true; &#125; return false; &#125;&#125; è¯´æ˜: è·Ÿè¸ªlockæ–¹æ³•çš„æºç å¯çŸ¥ï¼Œå½“èµ„æºç©ºé—²æ—¶ï¼Œå®ƒæ€»æ˜¯ä¼šå…ˆåˆ¤æ–­syncé˜Ÿåˆ—(AbstractQueuedSynchronizerä¸­çš„æ•°æ®ç»“æ„)æ˜¯å¦æœ‰ç­‰å¾…æ—¶é—´æ›´é•¿çš„çº¿ç¨‹ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å°†è¯¥çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå®ç°äº†å…¬å¹³è·å–åŸåˆ™ã€‚å…¶ä¸­ï¼ŒFairSyncç±»çš„lockçš„æ–¹æ³•è°ƒç”¨å¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•ã€‚ è¯´æ˜: å¯ä»¥çœ‹å‡ºåªè¦èµ„æºè¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œè¯¥çº¿ç¨‹å°±ä¼šæ·»åŠ åˆ°sync queueä¸­çš„å°¾éƒ¨ï¼Œè€Œä¸ä¼šå…ˆå°è¯•è·å–èµ„æºã€‚è¿™ä¹Ÿæ˜¯å’ŒNonfairæœ€å¤§çš„åŒºåˆ«ï¼ŒNonfairæ¯ä¸€æ¬¡éƒ½ä¼šå°è¯•å»è·å–èµ„æºï¼Œå¦‚æœæ­¤æ—¶è¯¥èµ„æºæ°å¥½è¢«é‡Šæ”¾ï¼Œåˆ™ä¼šè¢«å½“å‰çº¿ç¨‹è·å–ï¼Œè¿™å°±é€ æˆäº†ä¸å…¬å¹³çš„ç°è±¡ï¼Œå½“è·å–ä¸æˆåŠŸï¼Œå†åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨ã€‚ ç±»çš„å±æ€§ReentrantLockç±»çš„syncéå¸¸é‡è¦ï¼Œå¯¹ReentrantLockç±»çš„æ“ä½œå¤§éƒ¨åˆ†éƒ½ç›´æ¥è½¬åŒ–ä¸ºå¯¹Syncå’ŒAbstractQueuedSynchronizerç±»çš„æ“ä½œã€‚ 123456public class ReentrantLock implements Lock, java.io.Serializable &#123; // åºåˆ—å· private static final long serialVersionUID = 7373984872572414699L; // åŒæ­¥é˜Ÿåˆ— private final Sync sync;&#125; ç±»çš„æ„é€ å‡½æ•° ReentrantLock()å‹æ„é€ å‡½æ•° é»˜è®¤æ˜¯é‡‡ç”¨çš„éå…¬å¹³ç­–ç•¥è·å–é” 1234public ReentrantLock() &#123; // é»˜è®¤éå…¬å¹³ç­–ç•¥ sync = new NonfairSync();&#125; ReentrantLock(boolean)å‹æ„é€ å‡½æ•° å¯ä»¥ä¼ é€’å‚æ•°ç¡®å®šé‡‡ç”¨å…¬å¹³ç­–ç•¥æˆ–è€…æ˜¯éå…¬å¹³ç­–ç•¥ï¼Œå‚æ•°ä¸ºtrueè¡¨ç¤ºå…¬å¹³ç­–ç•¥ï¼Œå¦åˆ™ï¼Œé‡‡ç”¨éå…¬å¹³ç­–ç•¥: 123public ReentrantLock(boolean fair) &#123; sync = fair ? new FairSync() : new NonfairSync();&#125; æ ¸å¿ƒå‡½æ•°åˆ†æé€šè¿‡åˆ†æReentrantLockçš„æºç ï¼Œå¯çŸ¥å¯¹å…¶æ“ä½œéƒ½è½¬åŒ–ä¸ºå¯¹Syncå¯¹è±¡çš„æ“ä½œï¼Œç”±äºSyncç»§æ‰¿äº†AQSï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šéƒ½å¯ä»¥è½¬åŒ–ä¸ºå¯¹AQSçš„æ“ä½œã€‚å¦‚å°†ReentrantLockçš„lockå‡½æ•°è½¬åŒ–ä¸ºå¯¹Syncçš„lockå‡½æ•°çš„è°ƒç”¨ï¼Œè€Œå…·ä½“ä¼šæ ¹æ®é‡‡ç”¨çš„ç­–ç•¥(å¦‚å…¬å¹³ç­–ç•¥æˆ–è€…éå…¬å¹³ç­–ç•¥)çš„ä¸åŒè€Œè°ƒç”¨åˆ°Syncçš„ä¸åŒå­ç±»ã€‚ æ‰€ä»¥å¯çŸ¥ï¼Œåœ¨ReentrantLockçš„èƒŒåï¼Œæ˜¯AQSå¯¹å…¶æœåŠ¡æä¾›äº†æ”¯æŒï¼Œç”±äºä¹‹å‰æˆ‘ä»¬åˆ†æAQSçš„æ ¸å¿ƒæºç ï¼Œé‚ä¸å†ç´¯èµ˜ã€‚ä¸‹é¢è¿˜æ˜¯é€šè¿‡ä¾‹å­æ¥æ›´è¿›ä¸€æ­¥åˆ†ææºç ã€‚ ç¤ºä¾‹åˆ†æå…¬å¹³é”12345678910111213141516171819202122232425262728293031323334353637import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;class MyThread extends Thread &#123; private Lock lock; public MyThread(String name, Lock lock) &#123; super(name); this.lock = lock; &#125; public void run () &#123; lock.lock(); try &#123; System.out.println(Thread.currentThread() + &quot; running&quot;); try &#123; Thread.sleep(500); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; finally &#123; lock.unlock(); &#125; &#125;&#125;public class AbstractQueuedSynchronizerDemo &#123; public static void main(String[] args) throws InterruptedException &#123; Lock lock = new ReentrantLock(true); MyThread t1 = new MyThread(&quot;t1&quot;, lock); MyThread t2 = new MyThread(&quot;t2&quot;, lock); MyThread t3 = new MyThread(&quot;t3&quot;, lock); t1.start(); t2.start(); t3.start(); &#125;&#125; è¿è¡Œç»“æœ(æŸä¸€æ¬¡): 123Thread[t1,5,main] runningThread[t2,5,main] runningThread[t3,5,main] running è¯´æ˜: è¯¥ç¤ºä¾‹ä½¿ç”¨çš„æ˜¯å…¬å¹³ç­–ç•¥ï¼Œç”±ç»“æœå¯çŸ¥ï¼Œå¯èƒ½ä¼šå­˜åœ¨å¦‚ä¸‹ä¸€ç§æ—¶åºã€‚ è¯´æ˜: é¦–å…ˆï¼Œt1çº¿ç¨‹çš„lockæ“ä½œ -&gt; t2çº¿ç¨‹çš„lockæ“ä½œ -&gt; t3çº¿ç¨‹çš„lockæ“ä½œ -&gt; t1çº¿ç¨‹çš„unlockæ“ä½œ -&gt; t2çº¿ç¨‹çš„unlockæ“ä½œ -&gt; t3çº¿ç¨‹çš„unlockæ“ä½œã€‚æ ¹æ®è¿™ä¸ªæ—¶åºå›¾æ¥è¿›ä¸€æ­¥åˆ†ææºç çš„å·¥ä½œæµç¨‹ã€‚ t1çº¿ç¨‹æ‰§è¡Œlock.lockï¼Œä¸‹å›¾ç»™å‡ºäº†æ–¹æ³•è°ƒç”¨ä¸­çš„ä¸»è¦æ–¹æ³•ã€‚ è¯´æ˜: ç”±è°ƒç”¨æµç¨‹å¯çŸ¥ï¼Œt1çº¿ç¨‹æˆåŠŸè·å–äº†èµ„æºï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚ t2çº¿ç¨‹æ‰§è¡Œlock.lockï¼Œä¸‹å›¾ç»™å‡ºäº†æ–¹æ³•è°ƒç”¨ä¸­çš„ä¸»è¦æ–¹æ³•ã€‚ è¯´æ˜: ç”±ä¸Šå›¾å¯çŸ¥ï¼Œæœ€åçš„ç»“æœæ˜¯t2çº¿ç¨‹ä¼šè¢«ç¦æ­¢ï¼Œå› ä¸ºè°ƒç”¨äº†LockSupport.parkã€‚ t3çº¿ç¨‹æ‰§è¡Œlock.lockï¼Œä¸‹å›¾ç»™å‡ºäº†æ–¹æ³•è°ƒç”¨ä¸­çš„ä¸»è¦æ–¹æ³•ã€‚ è¯´æ˜: ç”±ä¸Šå›¾å¯çŸ¥ï¼Œæœ€åçš„ç»“æœæ˜¯t3çº¿ç¨‹ä¼šè¢«ç¦æ­¢ï¼Œå› ä¸ºè°ƒç”¨äº†LockSupport.parkã€‚ t1çº¿ç¨‹è°ƒç”¨äº†lock.unlockï¼Œä¸‹å›¾ç»™å‡ºäº†æ–¹æ³•è°ƒç”¨ä¸­çš„ä¸»è¦æ–¹æ³•ã€‚ è¯´æ˜: å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ€åï¼Œheadçš„çŠ¶æ€ä¼šå˜ä¸º0ï¼Œt2çº¿ç¨‹ä¼šè¢«unparkï¼Œå³t2çº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œã€‚æ­¤æ—¶t3çº¿ç¨‹è¿˜æ˜¯è¢«ç¦æ­¢ã€‚ t2è·å¾—cpuèµ„æºï¼Œç»§ç»­è¿è¡Œï¼Œç”±äºt2ä¹‹å‰è¢«parkäº†ï¼Œç°åœ¨éœ€è¦æ¢å¤ä¹‹å‰çš„çŠ¶æ€ï¼Œä¸‹å›¾ç»™å‡ºäº†æ–¹æ³•è°ƒç”¨ä¸­çš„ä¸»è¦æ–¹æ³•ã€‚ è¯´æ˜: åœ¨setHeadå‡½æ•°ä¸­ä¼šå°†headè®¾ç½®ä¸ºä¹‹å‰headçš„ä¸‹ä¸€ä¸ªç»“ç‚¹ï¼Œå¹¶ä¸”å°†preåŸŸä¸threadåŸŸéƒ½è®¾ç½®ä¸ºnullï¼Œåœ¨acquireQueuedè¿”å›ä¹‹å‰ï¼Œsync queueå°±åªæœ‰ä¸¤ä¸ªç»“ç‚¹äº†ã€‚ t2æ‰§è¡Œlock.unlockï¼Œä¸‹å›¾ç»™å‡ºäº†æ–¹æ³•è°ƒç”¨ä¸­çš„ä¸»è¦æ–¹æ³•ã€‚ è¯´æ˜: ç”±ä¸Šå›¾å¯çŸ¥ï¼Œæœ€ç»ˆunpark t3çº¿ç¨‹ï¼Œè®©t3çº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œã€‚ t3çº¿ç¨‹è·å–cpuèµ„æºï¼Œæ¢å¤ä¹‹å‰çš„çŠ¶æ€ï¼Œç»§ç»­è¿è¡Œã€‚ è¯´æ˜: æœ€ç»ˆè¾¾åˆ°çš„çŠ¶æ€æ˜¯sync queueä¸­åªå‰©ä¸‹äº†ä¸€ä¸ªç»“ç‚¹ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹é™¤äº†çŠ¶æ€ä¸º0å¤–ï¼Œå…¶ä½™å‡ä¸ºnullã€‚ t3æ‰§è¡Œlock.unlockï¼Œä¸‹å›¾ç»™å‡ºäº†æ–¹æ³•è°ƒç”¨ä¸­çš„ä¸»è¦æ–¹æ³•ã€‚ è¯´æ˜: æœ€åçš„çŠ¶æ€å’Œä¹‹å‰çš„çŠ¶æ€æ˜¯ä¸€æ ·çš„ï¼Œé˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œå¤´èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹å‡æŒ‡å‘å®ƒã€‚ ä½¿ç”¨å…¬å¹³ç­–ç•¥å’ŒConditionçš„æƒ…å†µå¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡å…³äºAQSçš„æºç ç¤ºä¾‹åˆ†æéƒ¨åˆ†ï¼Œä¸å†ç´¯èµ˜ã€‚ å‚è€ƒæ–‡ç«  æ–‡ç« ä¸»è¦å‚è€ƒè‡ªleesfçš„https://www.cnblogs.com/leesf456/p/5383609.htmlï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšäº†å¢æ”¹ã€‚","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"11.JUCé”: é”æ ¸å¿ƒç±»AQSè¯¦è§£","path":"/2023/12/25/11-JUCé”-é”æ ¸å¿ƒç±»AQSè¯¦è§£/","content":"AbstractQueuedSynchronizeræŠ½è±¡ç±»æ˜¯æ ¸å¿ƒï¼Œéœ€è¦é‡ç‚¹æŒæ¡ã€‚å®ƒæä¾›äº†ä¸€ä¸ªåŸºäºFIFOé˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨äºæ„å»ºé”æˆ–è€…å…¶ä»–ç›¸å…³åŒæ­¥è£…ç½®çš„åŸºç¡€æ¡†æ¶ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ ä»€ä¹ˆæ˜¯AQS? ä¸ºä»€ä¹ˆå®ƒæ˜¯æ ¸å¿ƒ? AQSçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä»€ä¹ˆ? å®ƒæ˜¯æ€ä¹ˆå®ç°çš„? åº•å±‚æ•°æ®ç»“æ„ç­‰ AQSæœ‰å“ªäº›æ ¸å¿ƒçš„æ–¹æ³•? AQSå®šä¹‰ä»€ä¹ˆæ ·çš„èµ„æºè·å–æ–¹å¼? AQSå®šä¹‰äº†ä¸¤ç§èµ„æºè·å–æ–¹å¼ï¼šç‹¬å (åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®æ‰§è¡Œï¼Œåˆæ ¹æ®æ˜¯å¦æŒ‰é˜Ÿåˆ—çš„é¡ºåºåˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œå¦‚ReentrantLock) å’Œå…±äº«(å¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è®¿é—®æ‰§è¡Œï¼Œå¦‚Semaphoreã€CountDownLatchã€ CyclicBarrier )ã€‚ReentrantReadWriteLockå¯ä»¥çœ‹æˆæ˜¯ç»„åˆå¼ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè¯»ã€‚ AQSåº•å±‚ä½¿ç”¨äº†ä»€ä¹ˆæ ·çš„è®¾è®¡æ¨¡å¼? æ¨¡æ¿ AQSçš„åº”ç”¨ç¤ºä¾‹? AbstractQueuedSynchronizerç®€ä»‹AQSæ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶ï¼Œä½¿ç”¨AQSèƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„ReentrantLockï¼ŒSemaphoreï¼Œå…¶ä»–çš„è¯¸å¦‚ReentrantReadWriteLockï¼ŒSynchronousQueueï¼ŒFutureTaskç­‰ç­‰çš†æ˜¯åŸºäºAQSçš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿèƒ½åˆ©ç”¨AQSéå¸¸è½»æ¾å®¹æ˜“åœ°æ„é€ å‡ºç¬¦åˆæˆ‘ä»¬è‡ªå·±éœ€æ±‚çš„åŒæ­¥å™¨ã€‚ AQS æ ¸å¿ƒæ€æƒ³AQSæ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶AQSæ˜¯ç”¨CLHé˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚ CLH(Craig,Landin,and Hagersten)é˜Ÿåˆ—æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—(è™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»)ã€‚AQSæ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªCLHé”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹(Node)æ¥å®ç°é”çš„åˆ†é…ã€‚ AQSä½¿ç”¨ä¸€ä¸ªintæˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚AQSä½¿ç”¨CASå¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŸå­æ“ä½œå®ç°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚ 1private volatile int state;//å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§ çŠ¶æ€ä¿¡æ¯é€šè¿‡proctedç±»å‹çš„getStateï¼ŒsetStateï¼ŒcompareAndSetStateè¿›è¡Œæ“ä½œ 123456789101112//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼protected final int getState() &#123; return state;&#125; // è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼protected final void setState(int newState) &#123; state = newState;&#125;//åŸå­åœ°(CASæ“ä½œ)å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpect(æœŸæœ›å€¼)protected final boolean compareAndSetState(int expect, int update) &#123; return unsafe.compareAndSwapInt(this, stateOffset, expect, update);&#125; AQS å¯¹èµ„æºçš„å…±äº«æ–¹å¼AQSå®šä¹‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼ Exclusive(ç‹¬å )ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ReentrantLockã€‚åˆå¯åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼š å…¬å¹³é”ï¼šæŒ‰ç…§çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„æ’é˜Ÿé¡ºåºï¼Œå…ˆåˆ°è€…å…ˆæ‹¿åˆ°é” éå…¬å¹³é”ï¼šå½“çº¿ç¨‹è¦è·å–é”æ—¶ï¼Œæ— è§†é˜Ÿåˆ—é¡ºåºç›´æ¥å»æŠ¢é”ï¼Œè°æŠ¢åˆ°å°±æ˜¯è°çš„ Share(å…±äº«)ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚Semaphore&#x2F;CountDownLatchã€‚Semaphoreã€CountDownLatChã€ CyclicBarrierã€ReadWriteLock æˆ‘ä»¬éƒ½ä¼šåœ¨åé¢è®²åˆ°ã€‚ ReentrantReadWriteLock å¯ä»¥çœ‹æˆæ˜¯ç»„åˆå¼ï¼Œå› ä¸ºReentrantReadWriteLockä¹Ÿå°±æ˜¯è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè¯»ã€‚ ä¸åŒçš„è‡ªå®šä¹‰åŒæ­¥å™¨äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒã€‚è‡ªå®šä¹‰åŒæ­¥å™¨åœ¨å®ç°æ—¶åªéœ€è¦å®ç°å…±äº«èµ„æº state çš„è·å–ä¸é‡Šæ”¾æ–¹å¼å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤(å¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ&#x2F;å”¤é†’å‡ºé˜Ÿç­‰)ï¼ŒAQSå·²ç»åœ¨ä¸Šå±‚å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†ã€‚ AQSåº•å±‚ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨ä¸€èˆ¬çš„æ–¹å¼æ˜¯è¿™æ ·(æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªåº”ç”¨)ï¼š ä½¿ç”¨è€…ç»§æ‰¿AbstractQueuedSynchronizerå¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ã€‚(è¿™äº›é‡å†™æ–¹æ³•å¾ˆç®€å•ï¼Œæ— éæ˜¯å¯¹äºå…±äº«èµ„æºstateçš„è·å–å’Œé‡Šæ”¾) å°†AQSç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚ è¿™å’Œæˆ‘ä»¬ä»¥å¾€é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼è¯·å‚çœ‹ï¼šè®¾è®¡æ¨¡å¼è¡Œä¸ºå‹ - æ¨¡æ¿æ–¹æ³•(Template Method)è¯¦è§£ AQSä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ªAQSæä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š 12345isHeldExclusively()//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒã€‚tryAcquire(int)//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚tryRelease(int)//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚tryAcquireShared(int)//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚tryReleaseShared(int)//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º UnsupportedOperationExceptionã€‚ è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å†…éƒ¨çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”é€šå¸¸åº”è¯¥ç®€çŸ­è€Œä¸æ˜¯é˜»å¡ã€‚AQSç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯final ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»ä½¿ç”¨ï¼Œåªæœ‰è¿™å‡ ä¸ªæ–¹æ³•å¯ä»¥è¢«å…¶ä»–ç±»ä½¿ç”¨ã€‚ ä»¥ReentrantLockä¸ºä¾‹ï¼Œstateåˆå§‹åŒ–ä¸º0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚Açº¿ç¨‹lock()æ—¶ï¼Œä¼šè°ƒç”¨tryAcquire()ç‹¬å è¯¥é”å¹¶å°†state+1ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å†tryAcquire()æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ°Açº¿ç¨‹unlock()åˆ°state&#x3D;0(å³é‡Šæ”¾é”)ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒAçº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„(stateä¼šç´¯åŠ )ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šä¹ˆæ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯stateæ˜¯èƒ½å›åˆ°é›¶æ€çš„ã€‚ AbstractQueuedSynchronizeræ•°æ®ç»“æ„AbstractQueuedSynchronizerç±»åº•å±‚çš„æ•°æ®ç»“æ„æ˜¯ä½¿ç”¨CLH(Craig,Landin,and Hagersten)é˜Ÿåˆ—æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—(è™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»)ã€‚AQSæ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªCLHé”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹(Node)æ¥å®ç°é”çš„åˆ†é…ã€‚å…¶ä¸­Sync queueï¼Œå³åŒæ­¥é˜Ÿåˆ—ï¼Œæ˜¯åŒå‘é“¾è¡¨ï¼ŒåŒ…æ‹¬headç»“ç‚¹å’Œtailç»“ç‚¹ï¼Œheadç»“ç‚¹ä¸»è¦ç”¨ä½œåç»­çš„è°ƒåº¦ã€‚è€ŒCondition queueä¸æ˜¯å¿…é¡»çš„ï¼Œå…¶æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œåªæœ‰å½“ä½¿ç”¨Conditionæ—¶ï¼Œæ‰ä¼šå­˜åœ¨æ­¤å•å‘é“¾è¡¨ã€‚å¹¶ä¸”å¯èƒ½ä¼šæœ‰å¤šä¸ªCondition queueã€‚ AbstractQueuedSynchronizeræºç åˆ†æç±»çš„ç»§æ‰¿å…³ç³»AbstractQueuedSynchronizerç»§æ‰¿è‡ªAbstractOwnableSynchronizeræŠ½è±¡ç±»ï¼Œå¹¶ä¸”å®ç°äº†Serializableæ¥å£ï¼Œå¯ä»¥è¿›è¡Œåºåˆ—åŒ–ã€‚ 1public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable å…¶ä¸­AbstractOwnableSynchronizeræŠ½è±¡ç±»çš„æºç å¦‚ä¸‹: 12345678910111213141516171819public abstract class AbstractOwnableSynchronizer implements java.io.Serializable &#123; // ç‰ˆæœ¬åºåˆ—å· private static final long serialVersionUID = 3737899427754241961L; // æ„é€ æ–¹æ³• protected AbstractOwnableSynchronizer() &#123; &#125; // ç‹¬å æ¨¡å¼ä¸‹çš„çº¿ç¨‹ private transient Thread exclusiveOwnerThread; // è®¾ç½®ç‹¬å çº¿ç¨‹ protected final void setExclusiveOwnerThread(Thread thread) &#123; exclusiveOwnerThread = thread; &#125; // è·å–ç‹¬å çº¿ç¨‹ protected final Thread getExclusiveOwnerThread() &#123; return exclusiveOwnerThread; &#125;&#125; AbstractOwnableSynchronizeræŠ½è±¡ç±»ä¸­ï¼Œå¯ä»¥è®¾ç½®ç‹¬å èµ„æºçº¿ç¨‹å’Œè·å–ç‹¬å èµ„æºçº¿ç¨‹ã€‚åˆ†åˆ«ä¸ºsetExclusiveOwnerThreadä¸getExclusiveOwnerThreadæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¼šè¢«å­ç±»è°ƒç”¨ã€‚ AbstractQueuedSynchronizerç±»æœ‰ä¸¤ä¸ªå†…éƒ¨ç±»ï¼Œåˆ†åˆ«ä¸ºNodeç±»ä¸ConditionObjectç±»ã€‚ä¸‹é¢åˆ†åˆ«åšä»‹ç»ã€‚ ç±»çš„å†…éƒ¨ç±» - Nodeç±»1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859static final class Node &#123; // æ¨¡å¼ï¼Œåˆ†ä¸ºå…±äº«ä¸ç‹¬å  // å…±äº«æ¨¡å¼ static final Node SHARED = new Node(); // ç‹¬å æ¨¡å¼ static final Node EXCLUSIVE = null; // ç»“ç‚¹çŠ¶æ€ // CANCELLEDï¼Œå€¼ä¸º1ï¼Œè¡¨ç¤ºå½“å‰çš„çº¿ç¨‹è¢«å–æ¶ˆ // SIGNALï¼Œå€¼ä¸º-1ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹éœ€è¦è¿è¡Œï¼Œä¹Ÿå°±æ˜¯unpark // CONDITIONï¼Œå€¼ä¸º-2ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨ç­‰å¾…conditionï¼Œä¹Ÿå°±æ˜¯åœ¨conditioné˜Ÿåˆ—ä¸­ // PROPAGATEï¼Œå€¼ä¸º-3ï¼Œè¡¨ç¤ºå½“å‰åœºæ™¯ä¸‹åç»­çš„acquireSharedèƒ½å¤Ÿå¾—ä»¥æ‰§è¡Œ // å€¼ä¸º0ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨syncé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ç€è·å–é” static final int CANCELLED = 1; static final int SIGNAL = -1; static final int CONDITION = -2; static final int PROPAGATE = -3; // ç»“ç‚¹çŠ¶æ€ volatile int waitStatus; // å‰é©±ç»“ç‚¹ volatile Node prev; // åç»§ç»“ç‚¹ volatile Node next; // ç»“ç‚¹æ‰€å¯¹åº”çš„çº¿ç¨‹ volatile Thread thread; // ä¸‹ä¸€ä¸ªç­‰å¾…è€… Node nextWaiter; // ç»“ç‚¹æ˜¯å¦åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾… final boolean isShared() &#123; return nextWaiter == SHARED; &#125; // è·å–å‰é©±ç»“ç‚¹ï¼Œè‹¥å‰é©±ç»“ç‚¹ä¸ºç©ºï¼ŒæŠ›å‡ºå¼‚å¸¸ final Node predecessor() throws NullPointerException &#123; // ä¿å­˜å‰é©±ç»“ç‚¹ Node p = prev; if (p == null) // å‰é©±ç»“ç‚¹ä¸ºç©ºï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new NullPointerException(); else // å‰é©±ç»“ç‚¹ä¸ä¸ºç©ºï¼Œè¿”å› return p; &#125; // æ— å‚æ„é€ æ–¹æ³• Node() &#123; // Used to establish initial head or SHARED marker &#125; // æ„é€ æ–¹æ³• Node(Thread thread, Node mode) &#123; // Used by addWaiter this.nextWaiter = mode; this.thread = thread; &#125; // æ„é€ æ–¹æ³• Node(Thread thread, int waitStatus) &#123; // Used by Condition this.waitStatus = waitStatus; this.thread = thread; &#125;&#125; æ¯ä¸ªçº¿ç¨‹è¢«é˜»å¡çš„çº¿ç¨‹éƒ½ä¼šè¢«å°è£…æˆä¸€ä¸ªNodeç»“ç‚¹ï¼Œæ”¾å…¥é˜Ÿåˆ—ã€‚æ¯ä¸ªèŠ‚ç‚¹åŒ…å«äº†ä¸€ä¸ªThreadç±»å‹çš„å¼•ç”¨ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜åœ¨ä¸€ä¸ªçŠ¶æ€ï¼Œå…·ä½“çŠ¶æ€å¦‚ä¸‹ã€‚ CANCELLEDï¼Œå€¼ä¸º1ï¼Œè¡¨ç¤ºå½“å‰çš„çº¿ç¨‹è¢«å–æ¶ˆã€‚ SIGNALï¼Œå€¼ä¸º-1ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹éœ€è¦è¿è¡Œï¼Œéœ€è¦è¿›è¡Œunparkæ“ä½œã€‚ CONDITIONï¼Œå€¼ä¸º-2ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨ç­‰å¾…conditionï¼Œä¹Ÿå°±æ˜¯åœ¨condition queueä¸­ã€‚ PROPAGATEï¼Œå€¼ä¸º-3ï¼Œè¡¨ç¤ºå½“å‰åœºæ™¯ä¸‹åç»­çš„acquireSharedèƒ½å¤Ÿå¾—ä»¥æ‰§è¡Œã€‚ å€¼ä¸º0ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åœ¨sync queueä¸­ï¼Œç­‰å¾…ç€è·å–é”ã€‚ ç±»çš„å†…éƒ¨ç±» - ConditionObjectç±»è¿™ä¸ªç±»æœ‰ç‚¹é•¿ï¼Œè€å¿ƒçœ‹ä¸‹: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472// å†…éƒ¨ç±»public class ConditionObject implements Condition, java.io.Serializable &#123; // ç‰ˆæœ¬å· private static final long serialVersionUID = 1173984872572414699L; /** First node of condition queue. */ // conditioné˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ private transient Node firstWaiter; /** Last node of condition queue. */ // conditioné˜Ÿåˆ—çš„å°¾ç»“ç‚¹ private transient Node lastWaiter; /** * Creates a new &#123;@code ConditionObject&#125; instance. */ // æ„é€ æ–¹æ³• public ConditionObject() &#123; &#125; // Internal methods /** * Adds a new waiter to wait queue. * @return its new wait node */ // æ·»åŠ æ–°çš„waiteråˆ°waité˜Ÿåˆ— private Node addConditionWaiter() &#123; // ä¿å­˜å°¾ç»“ç‚¹ Node t = lastWaiter; // If lastWaiter is cancelled, clean out. if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) &#123; // å°¾ç»“ç‚¹ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å°¾ç»“ç‚¹çš„çŠ¶æ€ä¸ä¸ºCONDITION // æ¸…é™¤çŠ¶æ€ä¸ºCONDITIONçš„ç»“ç‚¹ unlinkCancelledWaiters(); // å°†æœ€åä¸€ä¸ªç»“ç‚¹é‡æ–°èµ‹å€¼ç»™t t = lastWaiter; &#125; // æ–°å»ºä¸€ä¸ªç»“ç‚¹ Node node = new Node(Thread.currentThread(), Node.CONDITION); if (t == null) // å°¾ç»“ç‚¹ä¸ºç©º // è®¾ç½®conditioné˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ firstWaiter = node; else // å°¾ç»“ç‚¹ä¸ä¸ºç©º // è®¾ç½®ä¸ºèŠ‚ç‚¹çš„nextWaiteråŸŸä¸ºnodeç»“ç‚¹ t.nextWaiter = node; // æ›´æ–°conditioné˜Ÿåˆ—çš„å°¾ç»“ç‚¹ lastWaiter = node; return node; &#125; /** * Removes and transfers nodes until hit non-cancelled one or * null. Split out from signal in part to encourage compilers * to inline the case of no waiters. * @param first (non-null) the first node on condition queue */ private void doSignal(Node first) &#123; // å¾ªç¯ do &#123; if ( (firstWaiter = first.nextWaiter) == null) // è¯¥èŠ‚ç‚¹çš„nextWaiterä¸ºç©º // è®¾ç½®å°¾ç»“ç‚¹ä¸ºç©º lastWaiter = null; // è®¾ç½®firstç»“ç‚¹çš„nextWaiteråŸŸ first.nextWaiter = null; &#125; while (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != null); // å°†ç»“ç‚¹ä»conditioné˜Ÿåˆ—è½¬ç§»åˆ°syncé˜Ÿåˆ—å¤±è´¥å¹¶ä¸”conditioné˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œä¸€ç›´å¾ªç¯ &#125; /** * Removes and transfers all nodes. * @param first (non-null) the first node on condition queue */ private void doSignalAll(Node first) &#123; // conditioné˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹å°¾ç»“ç‚¹éƒ½è®¾ç½®ä¸ºç©º lastWaiter = firstWaiter = null; // å¾ªç¯ do &#123; // è·å–firstç»“ç‚¹çš„nextWaiteråŸŸç»“ç‚¹ Node next = first.nextWaiter; // è®¾ç½®firstç»“ç‚¹çš„nextWaiteråŸŸä¸ºç©º first.nextWaiter = null; // å°†firstç»“ç‚¹ä»conditioné˜Ÿåˆ—è½¬ç§»åˆ°syncé˜Ÿåˆ— transferForSignal(first); // é‡æ–°è®¾ç½®first first = next; &#125; while (first != null); &#125; /** * Unlinks cancelled waiter nodes from condition queue. * Called only while holding lock. This is called when * cancellation occurred during condition wait, and upon * insertion of a new waiter when lastWaiter is seen to have * been cancelled. This method is needed to avoid garbage * retention in the absence of signals. So even though it may * require a full traversal, it comes into play only when * timeouts or cancellations occur in the absence of * signals. It traverses all nodes rather than stopping at a * particular target to unlink all pointers to garbage nodes * without requiring many re-traversals during cancellation * storms. */ // ä»conditioné˜Ÿåˆ—ä¸­æ¸…é™¤çŠ¶æ€ä¸ºCANCELçš„ç»“ç‚¹ private void unlinkCancelledWaiters() &#123; // ä¿å­˜conditioné˜Ÿåˆ—å¤´èŠ‚ç‚¹ Node t = firstWaiter; Node trail = null; while (t != null) &#123; // tä¸ä¸ºç©º // ä¸‹ä¸€ä¸ªç»“ç‚¹ Node next = t.nextWaiter; if (t.waitStatus != Node.CONDITION) &#123; // tç»“ç‚¹çš„çŠ¶æ€ä¸ä¸ºCONDTIONçŠ¶æ€ // è®¾ç½®tèŠ‚ç‚¹çš„nextWaiteråŸŸä¸ºç©º t.nextWaiter = null; if (trail == null) // trailä¸ºç©º // é‡æ–°è®¾ç½®conditioné˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ firstWaiter = next; else // trailä¸ä¸ºç©º // è®¾ç½®trailç»“ç‚¹çš„nextWaiteråŸŸä¸ºnextç»“ç‚¹ trail.nextWaiter = next; if (next == null) // nextç»“ç‚¹ä¸ºç©º // è®¾ç½®conditioné˜Ÿåˆ—çš„å°¾ç»“ç‚¹ lastWaiter = trail; &#125; else // tç»“ç‚¹çš„çŠ¶æ€ä¸ºCONDTIONçŠ¶æ€ // è®¾ç½®trailç»“ç‚¹ trail = t; // è®¾ç½®tç»“ç‚¹ t = next; &#125; &#125; // public methods /** * Moves the longest-waiting thread, if one exists, from the * wait queue for this condition to the wait queue for the * owning lock. * * @throws IllegalMonitorStateException if &#123;@link #isHeldExclusively&#125; * returns &#123;@code false&#125; */ // å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚å¦‚æœæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…æ­¤æ¡ä»¶ï¼Œåˆ™é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªå”¤é†’ã€‚åœ¨ä» await è¿”å›ä¹‹å‰ï¼Œè¯¥çº¿ç¨‹å¿…é¡»é‡æ–°è·å–é”ã€‚ public final void signal() &#123; if (!isHeldExclusively()) // ä¸è¢«å½“å‰çº¿ç¨‹ç‹¬å ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new IllegalMonitorStateException(); // ä¿å­˜conditioné˜Ÿåˆ—å¤´èŠ‚ç‚¹ Node first = firstWaiter; if (first != null) // å¤´èŠ‚ç‚¹ä¸ä¸ºç©º // å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ doSignal(first); &#125; /** * Moves all threads from the wait queue for this condition to * the wait queue for the owning lock. * * @throws IllegalMonitorStateException if &#123;@link #isHeldExclusively&#125; * returns &#123;@code false&#125; */ // å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚å¦‚æœæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…æ­¤æ¡ä»¶ï¼Œåˆ™å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚åœ¨ä» await è¿”å›ä¹‹å‰ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¿…é¡»é‡æ–°è·å–é”ã€‚ public final void signalAll() &#123; if (!isHeldExclusively()) // ä¸è¢«å½“å‰çº¿ç¨‹ç‹¬å ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new IllegalMonitorStateException(); // ä¿å­˜conditioné˜Ÿåˆ—å¤´èŠ‚ç‚¹ Node first = firstWaiter; if (first != null) // å¤´èŠ‚ç‚¹ä¸ä¸ºç©º // å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ doSignalAll(first); &#125; /** * Implements uninterruptible condition wait. * &lt;ol&gt; * &lt;li&gt; Save lock state returned by &#123;@link #getState&#125;. * &lt;li&gt; Invoke &#123;@link #release&#125; with saved state as argument, * throwing IllegalMonitorStateException if it fails. * &lt;li&gt; Block until signalled. * &lt;li&gt; Reacquire by invoking specialized version of * &#123;@link #acquire&#125; with saved state as argument. * &lt;/ol&gt; */ // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¸å“åº”ä¸­æ–­ public final void awaitUninterruptibly() &#123; // æ·»åŠ ä¸€ä¸ªç»“ç‚¹åˆ°ç­‰å¾…é˜Ÿåˆ— Node node = addConditionWaiter(); // è·å–é‡Šæ”¾çš„çŠ¶æ€ int savedState = fullyRelease(node); boolean interrupted = false; while (!isOnSyncQueue(node)) &#123; // // é˜»å¡å½“å‰çº¿ç¨‹ LockSupport.park(this); if (Thread.interrupted()) // å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ // è®¾ç½®interruptedçŠ¶æ€ interrupted = true; &#125; if (acquireQueued(node, savedState) || interrupted) // selfInterrupt(); &#125; /* * For interruptible waits, we need to track whether to throw * InterruptedException, if interrupted while blocked on * condition, versus reinterrupt current thread, if * interrupted while blocked waiting to re-acquire. */ /** Mode meaning to reinterrupt on exit from wait */ private static final int REINTERRUPT = 1; /** Mode meaning to throw InterruptedException on exit from wait */ private static final int THROW_IE = -1; /** * Checks for interrupt, returning THROW_IE if interrupted * before signalled, REINTERRUPT if after signalled, or * 0 if not interrupted. */ private int checkInterruptWhileWaiting(Node node) &#123; return Thread.interrupted() ? (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0; &#125; /** * Throws InterruptedException, reinterrupts current thread, or * does nothing, depending on mode. */ private void reportInterruptAfterWait(int interruptMode) throws InterruptedException &#123; if (interruptMode == THROW_IE) throw new InterruptedException(); else if (interruptMode == REINTERRUPT) selfInterrupt(); &#125; /** * Implements interruptible condition wait. * &lt;ol&gt; * &lt;li&gt; If current thread is interrupted, throw InterruptedException. * &lt;li&gt; Save lock state returned by &#123;@link #getState&#125;. * &lt;li&gt; Invoke &#123;@link #release&#125; with saved state as argument, * throwing IllegalMonitorStateException if it fails. * &lt;li&gt; Block until signalled or interrupted. * &lt;li&gt; Reacquire by invoking specialized version of * &#123;@link #acquire&#125; with saved state as argument. * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException. * &lt;/ol&gt; */ // // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·æˆ–è¢«ä¸­æ–­ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ public final void await() throws InterruptedException &#123; if (Thread.interrupted()) // å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new InterruptedException(); // åœ¨waité˜Ÿåˆ—ä¸Šæ·»åŠ ä¸€ä¸ªç»“ç‚¹ Node node = addConditionWaiter(); // int savedState = fullyRelease(node); int interruptMode = 0; while (!isOnSyncQueue(node)) &#123; // é˜»å¡å½“å‰çº¿ç¨‹ LockSupport.park(this); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) // æ£€æŸ¥ç»“ç‚¹ç­‰å¾…æ—¶çš„ä¸­æ–­ç±»å‹ break; &#125; if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) // clean up if cancelled unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode); &#125; /** * Implements timed condition wait. * &lt;ol&gt; * &lt;li&gt; If current thread is interrupted, throw InterruptedException. * &lt;li&gt; Save lock state returned by &#123;@link #getState&#125;. * &lt;li&gt; Invoke &#123;@link #release&#125; with saved state as argument, * throwing IllegalMonitorStateException if it fails. * &lt;li&gt; Block until signalled, interrupted, or timed out. * &lt;li&gt; Reacquire by invoking specialized version of * &#123;@link #acquire&#125; with saved state as argument. * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException. * &lt;/ol&gt; */ // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶é—´ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ public final long awaitNanos(long nanosTimeout) throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); Node node = addConditionWaiter(); int savedState = fullyRelease(node); final long deadline = System.nanoTime() + nanosTimeout; int interruptMode = 0; while (!isOnSyncQueue(node)) &#123; if (nanosTimeout &lt;= 0L) &#123; transferAfterCancelledWait(node); break; &#125; if (nanosTimeout &gt;= spinForTimeoutThreshold) LockSupport.parkNanos(this, nanosTimeout); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; nanosTimeout = deadline - System.nanoTime(); &#125; if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode); return deadline - System.nanoTime(); &#125; /** * Implements absolute timed condition wait. * &lt;ol&gt; * &lt;li&gt; If current thread is interrupted, throw InterruptedException. * &lt;li&gt; Save lock state returned by &#123;@link #getState&#125;. * &lt;li&gt; Invoke &#123;@link #release&#125; with saved state as argument, * throwing IllegalMonitorStateException if it fails. * &lt;li&gt; Block until signalled, interrupted, or timed out. * &lt;li&gt; Reacquire by invoking specialized version of * &#123;@link #acquire&#125; with saved state as argument. * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException. * &lt;li&gt; If timed out while blocked in step 4, return false, else true. * &lt;/ol&gt; */ // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šæœ€åæœŸé™ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ public final boolean awaitUntil(Date deadline) throws InterruptedException &#123; long abstime = deadline.getTime(); if (Thread.interrupted()) throw new InterruptedException(); Node node = addConditionWaiter(); int savedState = fullyRelease(node); boolean timedout = false; int interruptMode = 0; while (!isOnSyncQueue(node)) &#123; if (System.currentTimeMillis() &gt; abstime) &#123; timedout = transferAfterCancelledWait(node); break; &#125; LockSupport.parkUntil(this, abstime); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; &#125; if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode); return !timedout; &#125; /** * Implements timed condition wait. * &lt;ol&gt; * &lt;li&gt; If current thread is interrupted, throw InterruptedException. * &lt;li&gt; Save lock state returned by &#123;@link #getState&#125;. * &lt;li&gt; Invoke &#123;@link #release&#125; with saved state as argument, * throwing IllegalMonitorStateException if it fails. * &lt;li&gt; Block until signalled, interrupted, or timed out. * &lt;li&gt; Reacquire by invoking specialized version of * &#123;@link #acquire&#125; with saved state as argument. * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException. * &lt;li&gt; If timed out while blocked in step 4, return false, else true. * &lt;/ol&gt; */ // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶é—´ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚æ­¤æ–¹æ³•åœ¨è¡Œä¸ºä¸Šç­‰æ•ˆäº: awaitNanos(unit.toNanos(time)) &gt; 0 public final boolean await(long time, TimeUnit unit) throws InterruptedException &#123; long nanosTimeout = unit.toNanos(time); if (Thread.interrupted()) throw new InterruptedException(); Node node = addConditionWaiter(); int savedState = fullyRelease(node); final long deadline = System.nanoTime() + nanosTimeout; boolean timedout = false; int interruptMode = 0; while (!isOnSyncQueue(node)) &#123; if (nanosTimeout &lt;= 0L) &#123; timedout = transferAfterCancelledWait(node); break; &#125; if (nanosTimeout &gt;= spinForTimeoutThreshold) LockSupport.parkNanos(this, nanosTimeout); if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; nanosTimeout = deadline - System.nanoTime(); &#125; if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; if (node.nextWaiter != null) unlinkCancelledWaiters(); if (interruptMode != 0) reportInterruptAfterWait(interruptMode); return !timedout; &#125; // support for instrumentation /** * Returns true if this condition was created by the given * synchronization object. * * @return &#123;@code true&#125; if owned */ final boolean isOwnedBy(AbstractQueuedSynchronizer sync) &#123; return sync == AbstractQueuedSynchronizer.this; &#125; /** * Queries whether any threads are waiting on this condition. * Implements &#123;@link AbstractQueuedSynchronizer#hasWaiters(ConditionObject)&#125;. * * @return &#123;@code true&#125; if there are any waiting threads * @throws IllegalMonitorStateException if &#123;@link #isHeldExclusively&#125; * returns &#123;@code false&#125; */ // æŸ¥è¯¢æ˜¯å¦æœ‰æ­£åœ¨ç­‰å¾…æ­¤æ¡ä»¶çš„ä»»ä½•çº¿ç¨‹ protected final boolean hasWaiters() &#123; if (!isHeldExclusively()) throw new IllegalMonitorStateException(); for (Node w = firstWaiter; w != null; w = w.nextWaiter) &#123; if (w.waitStatus == Node.CONDITION) return true; &#125; return false; &#125; /** * Returns an estimate of the number of threads waiting on * this condition. * Implements &#123;@link AbstractQueuedSynchronizer#getWaitQueueLength(ConditionObject)&#125;. * * @return the estimated number of waiting threads * @throws IllegalMonitorStateException if &#123;@link #isHeldExclusively&#125; * returns &#123;@code false&#125; */ // è¿”å›æ­£åœ¨ç­‰å¾…æ­¤æ¡ä»¶çš„çº¿ç¨‹æ•°ä¼°è®¡å€¼ protected final int getWaitQueueLength() &#123; if (!isHeldExclusively()) throw new IllegalMonitorStateException(); int n = 0; for (Node w = firstWaiter; w != null; w = w.nextWaiter) &#123; if (w.waitStatus == Node.CONDITION) ++n; &#125; return n; &#125; /** * Returns a collection containing those threads that may be * waiting on this Condition. * Implements &#123;@link AbstractQueuedSynchronizer#getWaitingThreads(ConditionObject)&#125;. * * @return the collection of threads * @throws IllegalMonitorStateException if &#123;@link #isHeldExclusively&#125; * returns &#123;@code false&#125; */ // è¿”å›åŒ…å«é‚£äº›å¯èƒ½æ­£åœ¨ç­‰å¾…æ­¤æ¡ä»¶çš„çº¿ç¨‹é›†åˆ protected final Collection&lt;Thread&gt; getWaitingThreads() &#123; if (!isHeldExclusively()) throw new IllegalMonitorStateException(); ArrayList&lt;Thread&gt; list = new ArrayList&lt;Thread&gt;(); for (Node w = firstWaiter; w != null; w = w.nextWaiter) &#123; if (w.waitStatus == Node.CONDITION) &#123; Thread t = w.thread; if (t != null) list.add(t); &#125; &#125; return list; &#125;&#125; æ­¤ç±»å®ç°äº†Conditionæ¥å£ï¼ŒConditionæ¥å£å®šä¹‰äº†æ¡ä»¶æ“ä½œè§„èŒƒï¼Œå…·ä½“å¦‚ä¸‹ 1234567891011121314151617181920212223public interface Condition &#123; // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·æˆ–è¢«ä¸­æ–­ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ void await() throws InterruptedException; // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¸å“åº”ä¸­æ–­ void awaitUninterruptibly(); //ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶é—´ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ long awaitNanos(long nanosTimeout) throws InterruptedException; // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶é—´ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚æ­¤æ–¹æ³•åœ¨è¡Œä¸ºä¸Šç­‰æ•ˆäº: awaitNanos(unit.toNanos(time)) &gt; 0 boolean await(long time, TimeUnit unit) throws InterruptedException; // ç­‰å¾…ï¼Œå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šæœ€åæœŸé™ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ boolean awaitUntil(Date deadline) throws InterruptedException; // å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚å¦‚æœæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…æ­¤æ¡ä»¶ï¼Œåˆ™é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªå”¤é†’ã€‚åœ¨ä» await è¿”å›ä¹‹å‰ï¼Œè¯¥çº¿ç¨‹å¿…é¡»é‡æ–°è·å–é”ã€‚ void signal(); // å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚å¦‚æœæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…æ­¤æ¡ä»¶ï¼Œåˆ™å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚åœ¨ä» await è¿”å›ä¹‹å‰ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¿…é¡»é‡æ–°è·å–é”ã€‚ void signalAll();&#125; Conditionæ¥å£ä¸­å®šä¹‰äº†awaitã€signalæ–¹æ³•ï¼Œç”¨æ¥ç­‰å¾…æ¡ä»¶ã€é‡Šæ”¾æ¡ä»¶ã€‚ä¹‹åä¼šè¯¦ç»†åˆ†æCondtionObjectçš„æºç ã€‚ ç±»çš„å±æ€§å±æ€§ä¸­åŒ…å«äº†å¤´èŠ‚ç‚¹headï¼Œå°¾ç»“ç‚¹tailï¼ŒçŠ¶æ€stateã€è‡ªæ—‹æ—¶é—´spinForTimeoutThresholdï¼Œè¿˜æœ‰AbstractQueuedSynchronizeræŠ½è±¡çš„å±æ€§åœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œé€šè¿‡è¯¥åç§»åœ°å€ï¼Œå¯ä»¥è·å–å’Œè®¾ç½®è¯¥å±æ€§çš„å€¼ï¼ŒåŒæ—¶è¿˜åŒ…æ‹¬ä¸€ä¸ªé™æ€åˆå§‹åŒ–å—ï¼Œç”¨äºåŠ è½½å†…å­˜åç§»åœ°å€ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer implements java.io.Serializable &#123; // ç‰ˆæœ¬å· private static final long serialVersionUID = 7373984972572414691L; // å¤´èŠ‚ç‚¹ private transient volatile Node head; // å°¾ç»“ç‚¹ private transient volatile Node tail; // çŠ¶æ€ private volatile int state; // è‡ªæ—‹æ—¶é—´ static final long spinForTimeoutThreshold = 1000L; // Unsafeç±»å®ä¾‹ private static final Unsafe unsafe = Unsafe.getUnsafe(); // stateå†…å­˜åç§»åœ°å€ private static final long stateOffset; // headå†…å­˜åç§»åœ°å€ private static final long headOffset; // stateå†…å­˜åç§»åœ°å€ private static final long tailOffset; // tailå†…å­˜åç§»åœ°å€ private static final long waitStatusOffset; // nextå†…å­˜åç§»åœ°å€ private static final long nextOffset; // é™æ€åˆå§‹åŒ–å— static &#123; try &#123; stateOffset = unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;state&quot;)); headOffset = unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;head&quot;)); tailOffset = unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;tail&quot;)); waitStatusOffset = unsafe.objectFieldOffset (Node.class.getDeclaredField(&quot;waitStatus&quot;)); nextOffset = unsafe.objectFieldOffset (Node.class.getDeclaredField(&quot;next&quot;)); &#125; catch (Exception ex) &#123; throw new Error(ex); &#125; &#125;&#125; ç±»çš„æ„é€ æ–¹æ³•æ­¤ç±»æ„é€ æ–¹æ³•ä¸ºä»æŠ½è±¡æ„é€ æ–¹æ³•ï¼Œä¾›å­ç±»è°ƒç”¨ã€‚ 1protected AbstractQueuedSynchronizer() &#123; &#125; ç±»çš„æ ¸å¿ƒæ–¹æ³• - acquireæ–¹æ³•è¯¥æ–¹æ³•ä»¥ç‹¬å æ¨¡å¼è·å–(èµ„æº)ï¼Œå¿½ç•¥ä¸­æ–­ï¼Œå³çº¿ç¨‹åœ¨aquireè¿‡ç¨‹ä¸­ï¼Œä¸­æ–­æ­¤çº¿ç¨‹æ˜¯æ— æ•ˆçš„ã€‚æºç å¦‚ä¸‹: 1234public final void acquire(int arg) &#123; if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt();&#125; ç”±ä¸Šè¿°æºç å¯ä»¥çŸ¥é“ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨acquireæ—¶ï¼Œè°ƒç”¨æ–¹æ³•æµç¨‹å¦‚ä¸‹ é¦–å…ˆè°ƒç”¨tryAcquireæ–¹æ³•ï¼Œè°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹ä¼šè¯•å›¾åœ¨ç‹¬å æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ã€‚æ­¤æ–¹æ³•åº”è¯¥æŸ¥è¯¢æ˜¯å¦å…è®¸å®ƒåœ¨ç‹¬å æ¨¡å¼ä¸‹è·å–å¯¹è±¡çŠ¶æ€ï¼Œå¦‚æœå…è®¸ï¼Œåˆ™è·å–å®ƒã€‚åœ¨AbstractQueuedSynchronizeræºç ä¸­é»˜è®¤ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå³éœ€è¦å­ç±»å»é‡å†™æ­¤æ–¹æ³•å®Œæˆè‡ªå·±çš„é€»è¾‘ã€‚ä¹‹åä¼šè¿›è¡Œåˆ†æã€‚ è‹¥tryAcquireå¤±è´¥ï¼Œåˆ™è°ƒç”¨addWaiteræ–¹æ³•ï¼ŒaddWaiteræ–¹æ³•å®Œæˆçš„åŠŸèƒ½æ˜¯å°†è°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹å°è£…æˆä¸ºä¸€ä¸ªç»“ç‚¹å¹¶æ”¾å…¥Sync queueã€‚ è°ƒç”¨acquireQueuedæ–¹æ³•ï¼Œæ­¤æ–¹æ³•å®Œæˆçš„åŠŸèƒ½æ˜¯Sync queueä¸­çš„ç»“ç‚¹ä¸æ–­å°è¯•è·å–èµ„æºï¼Œè‹¥æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™ï¼Œè¿”å›falseã€‚ ç”±äºtryAcquireé»˜è®¤å®ç°æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥æ­¤æ—¶ï¼Œä¸è¿›è¡Œåˆ†æï¼Œä¹‹åä¼šç»“åˆä¸€ä¸ªä¾‹å­è¿›è¡Œåˆ†æã€‚ é¦–å…ˆåˆ†æaddWaiteræ–¹æ³• 12345678910111213141516171819// æ·»åŠ ç­‰å¾…è€…private Node addWaiter(Node mode) &#123; // æ–°ç”Ÿæˆä¸€ä¸ªç»“ç‚¹ï¼Œé»˜è®¤ä¸ºç‹¬å æ¨¡å¼ Node node = new Node(Thread.currentThread(), mode); // Try the fast path of enq; backup to full enq on failure // ä¿å­˜å°¾ç»“ç‚¹ Node pred = tail; if (pred != null) &#123; // å°¾ç»“ç‚¹ä¸ä¸ºç©ºï¼Œå³å·²ç»è¢«åˆå§‹åŒ– // å°†nodeç»“ç‚¹çš„prevåŸŸè¿æ¥åˆ°å°¾ç»“ç‚¹ node.prev = pred; if (compareAndSetTail(pred, node)) &#123; // æ¯”è¾ƒpredæ˜¯å¦ä¸ºå°¾ç»“ç‚¹ï¼Œæ˜¯åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸ºnode // è®¾ç½®å°¾ç»“ç‚¹çš„nextåŸŸä¸ºnode pred.next = node; return node; // è¿”å›æ–°ç”Ÿæˆçš„ç»“ç‚¹ &#125; &#125; enq(node); // å°¾ç»“ç‚¹ä¸ºç©º(å³è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–è¿‡)ï¼Œæˆ–è€…æ˜¯compareAndSetTailæ“ä½œå¤±è´¥ï¼Œåˆ™å…¥é˜Ÿåˆ— return node;&#125; addWaiteræ–¹æ³•ä½¿ç”¨å¿«é€Ÿæ·»åŠ çš„æ–¹å¼å¾€sync queueå°¾éƒ¨æ·»åŠ ç»“ç‚¹ï¼Œå¦‚æœsync queueé˜Ÿåˆ—è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™ä¼šä½¿ç”¨enqæ’å…¥é˜Ÿåˆ—ä¸­ï¼Œenqæ–¹æ³•æºç å¦‚ä¸‹ 123456789101112131415161718private Node enq(final Node node) &#123; for (;;) &#123; // æ— é™å¾ªç¯ï¼Œç¡®ä¿ç»“ç‚¹èƒ½å¤ŸæˆåŠŸå…¥é˜Ÿåˆ— // ä¿å­˜å°¾ç»“ç‚¹ Node t = tail; if (t == null) &#123; // å°¾ç»“ç‚¹ä¸ºç©ºï¼Œå³è¿˜æ²¡è¢«åˆå§‹åŒ– if (compareAndSetHead(new Node())) // å¤´èŠ‚ç‚¹ä¸ºç©ºï¼Œå¹¶è®¾ç½®å¤´èŠ‚ç‚¹ä¸ºæ–°ç”Ÿæˆçš„ç»“ç‚¹ tail = head; // å¤´èŠ‚ç‚¹ä¸å°¾ç»“ç‚¹éƒ½æŒ‡å‘åŒä¸€ä¸ªæ–°ç”Ÿç»“ç‚¹ &#125; else &#123; // å°¾ç»“ç‚¹ä¸ä¸ºç©ºï¼Œå³å·²ç»è¢«åˆå§‹åŒ–è¿‡ // å°†nodeç»“ç‚¹çš„prevåŸŸè¿æ¥åˆ°å°¾ç»“ç‚¹ node.prev = t; if (compareAndSetTail(t, node)) &#123; // æ¯”è¾ƒç»“ç‚¹tæ˜¯å¦ä¸ºå°¾ç»“ç‚¹ï¼Œè‹¥æ˜¯åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸ºnode // è®¾ç½®å°¾ç»“ç‚¹çš„nextåŸŸä¸ºnode t.next = node; return t; // è¿”å›å°¾ç»“ç‚¹ &#125; &#125; &#125;&#125; enqæ–¹æ³•ä¼šä½¿ç”¨æ— é™å¾ªç¯æ¥ç¡®ä¿èŠ‚ç‚¹çš„æˆåŠŸæ’å…¥ã€‚ ç°åœ¨ï¼Œåˆ†æacquireQueueæ–¹æ³•ã€‚å…¶æºç å¦‚ä¸‹ 12345678910111213141516171819202122232425// syncé˜Ÿåˆ—ä¸­çš„ç»“ç‚¹åœ¨ç‹¬å ä¸”å¿½ç•¥ä¸­æ–­çš„æ¨¡å¼ä¸‹è·å–(èµ„æº)final boolean acquireQueued(final Node node, int arg) &#123; // æ ‡å¿— boolean failed = true; try &#123; // ä¸­æ–­æ ‡å¿— boolean interrupted = false; for (;;) &#123; // æ— é™å¾ªç¯ // è·å–nodeèŠ‚ç‚¹çš„å‰é©±ç»“ç‚¹ final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) &#123; // å‰é©±ä¸ºå¤´èŠ‚ç‚¹å¹¶ä¸”æˆåŠŸè·å¾—é” setHead(node); // è®¾ç½®å¤´èŠ‚ç‚¹ p.next = null; // help GC failed = false; // è®¾ç½®æ ‡å¿— return interrupted; &#125; if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; é¦–å…ˆè·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œå¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹å¹¶ä¸”èƒ½å¤Ÿè·å–(èµ„æº)ï¼Œä»£è¡¨è¯¥å½“å‰èŠ‚ç‚¹èƒ½å¤Ÿå æœ‰é”ï¼Œè®¾ç½®å¤´èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿”å›ã€‚å¦åˆ™ï¼Œè°ƒç”¨shouldParkAfterFailedAcquireå’ŒparkAndCheckInterruptæ–¹æ³•ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬çœ‹shouldParkAfterFailedAcquireæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233// å½“è·å–(èµ„æº)å¤±è´¥åï¼Œæ£€æŸ¥å¹¶ä¸”æ›´æ–°ç»“ç‚¹çŠ¶æ€private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123; // è·å–å‰é©±ç»“ç‚¹çš„çŠ¶æ€ int ws = pred.waitStatus; if (ws == Node.SIGNAL) // çŠ¶æ€ä¸ºSIGNALï¼Œä¸º-1 /* * This node has already set status asking a release * to signal it, so it can safely park. */ // å¯ä»¥è¿›è¡Œparkæ“ä½œ return true; if (ws &gt; 0) &#123; // è¡¨ç¤ºçŠ¶æ€ä¸ºCANCELLEDï¼Œä¸º1 /* * Predecessor was cancelled. Skip over predecessors and * indicate retry. */ do &#123; node.prev = pred = pred.prev; &#125; while (pred.waitStatus &gt; 0); // æ‰¾åˆ°predç»“ç‚¹å‰é¢æœ€è¿‘çš„ä¸€ä¸ªçŠ¶æ€ä¸ä¸ºCANCELLEDçš„ç»“ç‚¹ // èµ‹å€¼predç»“ç‚¹çš„nextåŸŸ pred.next = node; &#125; else &#123; // ä¸ºPROPAGATE -3 æˆ–è€…æ˜¯0 è¡¨ç¤ºæ— çŠ¶æ€,(ä¸ºCONDITION -2æ—¶ï¼Œè¡¨ç¤ºæ­¤èŠ‚ç‚¹åœ¨condition queueä¸­) /* * waitStatus must be 0 or PROPAGATE. Indicate that we * need a signal, but don&#x27;t park yet. Caller will need to * retry to make sure it cannot acquire before parking. */ // æ¯”è¾ƒå¹¶è®¾ç½®å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL compareAndSetWaitStatus(pred, ws, Node.SIGNAL); &#125; // ä¸èƒ½è¿›è¡Œparkæ“ä½œ return false;&#125; åªæœ‰å½“è¯¥èŠ‚ç‚¹çš„å‰é©±ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNALæ—¶ï¼Œæ‰å¯ä»¥å¯¹è¯¥ç»“ç‚¹æ‰€å°è£…çš„çº¿ç¨‹è¿›è¡Œparkæ“ä½œã€‚å¦åˆ™ï¼Œå°†ä¸èƒ½è¿›è¡Œparkæ“ä½œã€‚å†çœ‹parkAndCheckInterruptæ–¹æ³•ï¼Œæºç å¦‚ä¸‹ 123456// è¿›è¡Œparkæ“ä½œå¹¶ä¸”è¿”å›è¯¥çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­private final boolean parkAndCheckInterrupt() &#123; // åœ¨è®¸å¯å¯ç”¨ä¹‹å‰ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”è®¾ç½®äº†blocker LockSupport.park(this); return Thread.interrupted(); // å½“å‰çº¿ç¨‹æ˜¯å¦å·²è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤ä¸­æ–­æ ‡è®°ä½&#125; parkAndCheckInterruptæ–¹æ³•é‡Œçš„é€»è¾‘æ˜¯é¦–å…ˆæ‰§è¡Œparkæ“ä½œï¼Œå³ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œç„¶åè¿”å›è¯¥çº¿ç¨‹æ˜¯å¦å·²ç»è¢«ä¸­æ–­ã€‚å†çœ‹finalå—ä¸­çš„cancelAcquireæ–¹æ³•ï¼Œå…¶æºç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// å–æ¶ˆç»§ç»­è·å–(èµ„æº)private void cancelAcquire(Node node) &#123; // Ignore if node doesn&#x27;t exist // nodeä¸ºç©ºï¼Œè¿”å› if (node == null) return; // è®¾ç½®nodeç»“ç‚¹çš„threadä¸ºç©º node.thread = null; // Skip cancelled predecessors // ä¿å­˜nodeçš„å‰é©±ç»“ç‚¹ Node pred = node.prev; while (pred.waitStatus &gt; 0) // æ‰¾åˆ°nodeå‰é©±ç»“ç‚¹ä¸­ç¬¬ä¸€ä¸ªçŠ¶æ€å°äº0çš„ç»“ç‚¹ï¼Œå³ä¸ä¸ºCANCELLEDçŠ¶æ€çš„ç»“ç‚¹ node.prev = pred = pred.prev; // predNext is the apparent node to unsplice. CASes below will // fail if not, in which case, we lost race vs another cancel // or signal, so no further action is necessary. // è·å–predç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ Node predNext = pred.next; // Can use unconditional write instead of CAS here. // After this atomic step, other Nodes can skip past us. // Before, we are free of interference from other threads. // è®¾ç½®nodeç»“ç‚¹çš„çŠ¶æ€ä¸ºCANCELLED node.waitStatus = Node.CANCELLED; // If we are the tail, remove ourselves. if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123; // nodeç»“ç‚¹ä¸ºå°¾ç»“ç‚¹ï¼Œåˆ™è®¾ç½®å°¾ç»“ç‚¹ä¸ºpredç»“ç‚¹ // æ¯”è¾ƒå¹¶è®¾ç½®predç»“ç‚¹çš„nextèŠ‚ç‚¹ä¸ºnull compareAndSetNext(pred, predNext, null); &#125; else &#123; // nodeç»“ç‚¹ä¸ä¸ºå°¾ç»“ç‚¹ï¼Œæˆ–è€…æ¯”è¾ƒè®¾ç½®ä¸æˆåŠŸ // If successor needs signal, try to set pred&#x27;s next-link // so it will get one. Otherwise wake it up to propagate. int ws; if (pred != head &amp;&amp; ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp; pred.thread != null) &#123; // (predç»“ç‚¹ä¸ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”predç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL)æˆ–è€… // predç»“ç‚¹çŠ¶æ€å°äºç­‰äº0ï¼Œå¹¶ä¸”æ¯”è¾ƒå¹¶è®¾ç½®ç­‰å¾…çŠ¶æ€ä¸ºSIGNALæˆåŠŸï¼Œå¹¶ä¸”predç»“ç‚¹æ‰€å°è£…çš„çº¿ç¨‹ä¸ä¸ºç©º // ä¿å­˜ç»“ç‚¹çš„åç»§ Node next = node.next; if (next != null &amp;&amp; next.waitStatus &lt;= 0) // åç»§ä¸ä¸ºç©ºå¹¶ä¸”åç»§çš„çŠ¶æ€å°äºç­‰äº0 compareAndSetNext(pred, predNext, next); // æ¯”è¾ƒå¹¶è®¾ç½®pred.next = next; &#125; else &#123; unparkSuccessor(node); // é‡Šæ”¾nodeçš„å‰ä¸€ä¸ªç»“ç‚¹ &#125; node.next = node; // help GC &#125;&#125; è¯¥æ–¹æ³•å®Œæˆçš„åŠŸèƒ½å°±æ˜¯å–æ¶ˆå½“å‰çº¿ç¨‹å¯¹èµ„æºçš„è·å–ï¼Œå³è®¾ç½®è¯¥ç»“ç‚¹çš„çŠ¶æ€ä¸ºCANCELLEDï¼Œæ¥ç€æˆ‘ä»¬å†çœ‹unparkSuccessoræ–¹æ³•ï¼Œæºç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233// é‡Šæ”¾åç»§ç»“ç‚¹private void unparkSuccessor(Node node) &#123; /* * If status is negative (i.e., possibly needing signal) try * to clear in anticipation of signalling. It is OK if this * fails or if status is changed by waiting thread. */ // è·å–nodeç»“ç‚¹çš„ç­‰å¾…çŠ¶æ€ int ws = node.waitStatus; if (ws &lt; 0) // çŠ¶æ€å€¼å°äº0ï¼Œä¸ºSIGNAL -1 æˆ– CONDITION -2 æˆ– PROPAGATE -3 // æ¯”è¾ƒå¹¶ä¸”è®¾ç½®ç»“ç‚¹ç­‰å¾…çŠ¶æ€ï¼Œè®¾ç½®ä¸º0 compareAndSetWaitStatus(node, ws, 0); /* * Thread to unpark is held in successor, which is normally * just the next node. But if cancelled or apparently null, * traverse backwards from tail to find the actual * non-cancelled successor. */ // è·å–nodeèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ Node s = node.next; if (s == null || s.waitStatus &gt; 0) &#123; // ä¸‹ä¸€ä¸ªç»“ç‚¹ä¸ºç©ºæˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€å¤§äº0ï¼Œå³ä¸ºCANCELLED // sèµ‹å€¼ä¸ºç©º s = null; // ä»å°¾ç»“ç‚¹å¼€å§‹ä»åå¾€å‰å¼€å§‹éå† for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) // æ‰¾åˆ°ç­‰å¾…çŠ¶æ€å°äºç­‰äº0çš„ç»“ç‚¹ï¼Œæ‰¾åˆ°æœ€å‰çš„çŠ¶æ€å°äºç­‰äº0çš„ç»“ç‚¹ // ä¿å­˜ç»“ç‚¹ s = t; &#125; if (s != null) // è¯¥ç»“ç‚¹ä¸ä¸ºä¸ºç©ºï¼Œé‡Šæ”¾è®¸å¯ LockSupport.unpark(s.thread);&#125; è¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä¸ºäº†é‡Šæ”¾nodeèŠ‚ç‚¹çš„åç»§ç»“ç‚¹ã€‚ å¯¹äºcancelAcquireä¸unparkSuccessoræ–¹æ³•ï¼Œå¦‚ä¸‹ç¤ºæ„å›¾å¯ä»¥æ¸…æ™°çš„è¡¨ç¤º: å…¶ä¸­nodeä¸ºå‚æ•°ï¼Œåœ¨æ‰§è¡Œå®ŒcancelAcquireæ–¹æ³•åçš„æ•ˆæœå°±æ˜¯unparkäº†sç»“ç‚¹æ‰€åŒ…å«çš„t4çº¿ç¨‹ã€‚ ç°åœ¨ï¼Œå†æ¥çœ‹acquireQueuedæ–¹æ³•çš„æ•´ä¸ªçš„é€»è¾‘ã€‚é€»è¾‘å¦‚ä¸‹: åˆ¤æ–­ç»“ç‚¹çš„å‰é©±æ˜¯å¦ä¸ºheadå¹¶ä¸”æ˜¯å¦æˆåŠŸè·å–(èµ„æº)ã€‚ è‹¥æ­¥éª¤1å‡æ»¡è¶³ï¼Œåˆ™è®¾ç½®ç»“ç‚¹ä¸ºheadï¼Œä¹‹åä¼šåˆ¤æ–­æ˜¯å¦finallyæ¨¡å—ï¼Œç„¶åè¿”å›ã€‚ è‹¥æ­¥éª¤2ä¸æ»¡è¶³ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦parkå½“å‰çº¿ç¨‹ï¼Œæ˜¯å¦éœ€è¦parkå½“å‰çº¿ç¨‹çš„é€»è¾‘æ˜¯åˆ¤æ–­ç»“ç‚¹çš„å‰é©±ç»“ç‚¹çš„çŠ¶æ€æ˜¯å¦ä¸ºSIGNALï¼Œè‹¥æ˜¯ï¼Œåˆ™parkå½“å‰ç»“ç‚¹ï¼Œå¦åˆ™ï¼Œä¸è¿›è¡Œparkæ“ä½œã€‚ è‹¥parkäº†å½“å‰çº¿ç¨‹ï¼Œä¹‹åæŸä¸ªçº¿ç¨‹å¯¹æœ¬çº¿ç¨‹unparkåï¼Œå¹¶ä¸”æœ¬çº¿ç¨‹ä¹Ÿè·å¾—æœºä¼šè¿è¡Œã€‚é‚£ä¹ˆï¼Œå°†ä¼šç»§ç»­è¿›è¡Œæ­¥éª¤â‘ çš„åˆ¤æ–­ã€‚ ç±»çš„æ ¸å¿ƒæ–¹æ³• - releaseæ–¹æ³•ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾å¯¹è±¡ï¼Œå…¶æºç å¦‚ä¸‹: 12345678910public final boolean release(int arg) &#123; if (tryRelease(arg)) &#123; // é‡Šæ”¾æˆåŠŸ // ä¿å­˜å¤´èŠ‚ç‚¹ Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) // å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºå¹¶ä¸”å¤´èŠ‚ç‚¹çŠ¶æ€ä¸ä¸º0 unparkSuccessor(h); //é‡Šæ”¾å¤´èŠ‚ç‚¹çš„åç»§ç»“ç‚¹ return true; &#125; return false;&#125; å…¶ä¸­ï¼ŒtryReleaseçš„é»˜è®¤å®ç°æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦å…·ä½“çš„å­ç±»å®ç°ï¼Œå¦‚æœtryReleaseæˆåŠŸï¼Œé‚£ä¹ˆå¦‚æœå¤´èŠ‚ç‚¹ä¸ä¸ºç©ºå¹¶ä¸”å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸ä¸º0ï¼Œåˆ™é‡Šæ”¾å¤´èŠ‚ç‚¹çš„åç»§ç»“ç‚¹ï¼ŒunparkSuccessoræ–¹æ³•å·²ç»åˆ†æè¿‡ï¼Œä¸å†ç´¯èµ˜ã€‚ å¯¹äºå…¶ä»–æ–¹æ³•æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ†æï¼Œä¸å‰é¢åˆ†æçš„æ–¹æ³•å¤§åŒå°å¼‚ï¼Œæ‰€ä»¥ï¼Œä¸å†ç´¯èµ˜ã€‚ AbstractQueuedSynchronizerç¤ºä¾‹è¯¦è§£ä¸€å€ŸåŠ©ä¸‹é¢ç¤ºä¾‹æ¥åˆ†æAbstractQueuedSyncrhonizerå†…éƒ¨çš„å·¥ä½œæœºåˆ¶ã€‚ç¤ºä¾‹æºç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;class MyThread extends Thread &#123; private Lock lock; public MyThread(String name, Lock lock) &#123; super(name); this.lock = lock; &#125; public void run () &#123; lock.lock(); try &#123; System.out.println(Thread.currentThread() + &quot; running&quot;); &#125; finally &#123; lock.unlock(); &#125; &#125;&#125;public class AbstractQueuedSynchronizerDemo &#123; public static void main(String[] args) &#123; Lock lock = new ReentrantLock(); MyThread t1 = new MyThread(&quot;t1&quot;, lock); MyThread t2 = new MyThread(&quot;t2&quot;, lock); t1.start(); t2.start(); &#125;&#125; è¿è¡Œç»“æœ(å¯èƒ½çš„ä¸€ç§): 12Thread[t1,5,main] runningThread[t2,5,main] running ç»“æœåˆ†æ: ä»ç¤ºä¾‹å¯çŸ¥ï¼Œçº¿ç¨‹t1ä¸t2å…±ç”¨äº†ä¸€æŠŠé”ï¼Œå³åŒä¸€ä¸ªlockã€‚å¯èƒ½ä¼šå­˜åœ¨å¦‚ä¸‹ä¸€ç§æ—¶åºã€‚ è¯´æ˜: é¦–å…ˆçº¿ç¨‹t1å…ˆæ‰§è¡Œlock.lockæ“ä½œï¼Œç„¶åt2æ‰§è¡Œlock.lockæ“ä½œï¼Œç„¶åt1æ‰§è¡Œlock.unlockæ“ä½œï¼Œæœ€åt2æ‰§è¡Œlock.unlockæ“ä½œã€‚åŸºäºè¿™æ ·çš„æ—¶åºï¼Œåˆ†æAbstractQueuedSynchronizerå†…éƒ¨çš„å·¥ä½œæœºåˆ¶ã€‚ t1çº¿ç¨‹è°ƒç”¨lock.lockæ–¹æ³•ï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ è¯´æ˜: å…¶ä¸­ï¼Œå‰é¢çš„éƒ¨åˆ†è¡¨ç¤ºå“ªä¸ªç±»ï¼Œåé¢æ˜¯å…·ä½“çš„ç±»ä¸­çš„å“ªä¸ªæ–¹æ³•ï¼ŒAQSè¡¨ç¤ºAbstractQueuedSynchronizerç±»ï¼ŒAOSè¡¨ç¤ºAbstractOwnableSynchronizerç±»ã€‚ t2çº¿ç¨‹è°ƒç”¨lock.lockæ–¹æ³•ï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ è¯´æ˜: ç»è¿‡ä¸€ç³»åˆ—çš„æ–¹æ³•è°ƒç”¨ï¼Œæœ€åè¾¾åˆ°çš„çŠ¶æ€æ˜¯ç¦ç”¨t2çº¿ç¨‹ï¼Œå› ä¸ºè°ƒç”¨äº†LockSupport.parkã€‚ t1çº¿ç¨‹è°ƒç”¨lock.unlockï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ è¯´æ˜: t1çº¿ç¨‹ä¸­è°ƒç”¨lock.unlockåï¼Œç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œæœ€ç»ˆçš„çŠ¶æ€æ˜¯é‡Šæ”¾äº†è®¸å¯ï¼Œå› ä¸ºè°ƒç”¨äº†LockSupport.unparkã€‚è¿™æ—¶ï¼Œt2çº¿ç¨‹å°±å¯ä»¥ç»§ç»­è¿è¡Œäº†ã€‚æ­¤æ—¶ï¼Œä¼šç»§ç»­æ¢å¤t2çº¿ç¨‹è¿è¡Œç¯å¢ƒï¼Œç»§ç»­æ‰§è¡ŒLockSupport.parkåé¢çš„è¯­å¥ï¼Œå³è¿›ä¸€æ­¥è°ƒç”¨å¦‚ä¸‹ã€‚ è¯´æ˜: åœ¨ä¸Šä¸€æ­¥è°ƒç”¨äº†LockSupport.unparkåï¼Œt2çº¿ç¨‹æ¢å¤è¿è¡Œï¼Œåˆ™è¿è¡ŒparkAndCheckInterruptï¼Œä¹‹åï¼Œç»§ç»­è¿è¡ŒacquireQueuedæ–¹æ³•ï¼Œæœ€åè¾¾åˆ°çš„çŠ¶æ€æ˜¯å¤´èŠ‚ç‚¹headä¸å°¾ç»“ç‚¹tailå‡æŒ‡å‘äº†t2çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹ï¼Œå¹¶ä¸”ä¹‹å‰çš„å¤´èŠ‚ç‚¹å·²ç»ä»syncé˜Ÿåˆ—ä¸­æ–­å¼€äº†ã€‚ t2çº¿ç¨‹è°ƒç”¨lock.unlockï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ è¯´æ˜: t2çº¿ç¨‹æ‰§è¡Œlock.unlockåï¼Œæœ€ç»ˆè¾¾åˆ°çš„çŠ¶æ€è¿˜æ˜¯ä¸ä¹‹å‰çš„çŠ¶æ€ä¸€æ ·ã€‚ AbstractQueuedSynchronizerç¤ºä¾‹è¯¦è§£äºŒä¸‹é¢æˆ‘ä»¬ç»“åˆConditionå®ç°ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ï¼Œæ¥è¿›ä¸€æ­¥åˆ†æAbstractQueuedSynchronizerçš„å†…éƒ¨å·¥ä½œæœºåˆ¶ã€‚ Depot(ä»“åº“)ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;public class Depot &#123; private int size; private int capacity; private Lock lock; private Condition fullCondition; private Condition emptyCondition; public Depot(int capacity) &#123; this.capacity = capacity; lock = new ReentrantLock(); fullCondition = lock.newCondition(); emptyCondition = lock.newCondition(); &#125; public void produce(int no) &#123; lock.lock(); int left = no; try &#123; while (left &gt; 0) &#123; while (size &gt;= capacity) &#123; System.out.println(Thread.currentThread() + &quot; before await&quot;); fullCondition.await(); System.out.println(Thread.currentThread() + &quot; after await&quot;); &#125; int inc = (left + size) &gt; capacity ? (capacity - size) : left; left -= inc; size += inc; System.out.println(&quot;produce = &quot; + inc + &quot;, size = &quot; + size); emptyCondition.signal(); &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125; public void consume(int no) &#123; lock.lock(); int left = no; try &#123; while (left &gt; 0) &#123; while (size &lt;= 0) &#123; System.out.println(Thread.currentThread() + &quot; before await&quot;); emptyCondition.await(); System.out.println(Thread.currentThread() + &quot; after await&quot;); &#125; int dec = (size - left) &gt; 0 ? left : size; left -= dec; size -= dec; System.out.println(&quot;consume = &quot; + dec + &quot;, size = &quot; + size); fullCondition.signal(); &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;&#125; æµ‹è¯•ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142class Consumer &#123; private Depot depot; public Consumer(Depot depot) &#123; this.depot = depot; &#125; public void consume(int no) &#123; new Thread(new Runnable() &#123; @Override public void run() &#123; depot.consume(no); &#125; &#125;, no + &quot; consume thread&quot;).start(); &#125;&#125;class Producer &#123; private Depot depot; public Producer(Depot depot) &#123; this.depot = depot; &#125; public void produce(int no) &#123; new Thread(new Runnable() &#123; @Override public void run() &#123; depot.produce(no); &#125; &#125;, no + &quot; produce thread&quot;).start(); &#125;&#125;public class ReentrantLockDemo &#123; public static void main(String[] args) throws InterruptedException &#123; Depot depot = new Depot(500); new Producer(depot).produce(500); new Producer(depot).produce(200); new Consumer(depot).consume(500); new Consumer(depot).consume(200); &#125;&#125; è¿è¡Œç»“æœ(å¯èƒ½çš„ä¸€ç§): 12345678produce = 500, size = 500Thread[200 produce thread,5,main] before awaitconsume = 500, size = 0Thread[200 consume thread,5,main] before awaitThread[200 produce thread,5,main] after awaitproduce = 200, size = 200Thread[200 consume thread,5,main] after awaitconsume = 200, size = 0 è¯´æ˜: æ ¹æ®ç»“æœï¼Œæˆ‘ä»¬çŒœæµ‹ä¸€ç§å¯èƒ½çš„æ—¶åºå¦‚ä¸‹ è¯´æ˜: p1ä»£è¡¨produce 500çš„é‚£ä¸ªçº¿ç¨‹ï¼Œp2ä»£è¡¨produce 200çš„é‚£ä¸ªçº¿ç¨‹ï¼Œc1ä»£è¡¨consume 500çš„é‚£ä¸ªçº¿ç¨‹ï¼Œc2ä»£è¡¨consume 200çš„é‚£ä¸ªçº¿ç¨‹ã€‚ p1çº¿ç¨‹è°ƒç”¨lock.lockï¼Œè·å¾—é”ï¼Œç»§ç»­è¿è¡Œï¼Œæ–¹æ³•è°ƒç”¨é¡ºåºåœ¨å‰é¢å·²ç»ç»™å‡ºã€‚ p2çº¿ç¨‹è°ƒç”¨lock.lockï¼Œç”±å‰é¢çš„åˆ†æå¯å¾—åˆ°å¦‚ä¸‹çš„æœ€ç»ˆçŠ¶æ€ã€‚ è¯´æ˜: p2çº¿ç¨‹è°ƒç”¨lock.lockåï¼Œä¼šç¦æ­¢p2çº¿ç¨‹çš„ç»§ç»­è¿è¡Œï¼Œå› ä¸ºæ‰§è¡Œäº†LockSupport.parkæ“ä½œã€‚ c1çº¿ç¨‹è°ƒç”¨lock.lockï¼Œç”±å‰é¢çš„åˆ†æå¾—åˆ°å¦‚ä¸‹çš„æœ€ç»ˆçŠ¶æ€ã€‚ è¯´æ˜: æœ€ç»ˆc1çº¿ç¨‹ä¼šåœ¨sync queueé˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä¸”å…¶ç»“ç‚¹çš„å‰é©±ç»“ç‚¹(åŒ…å«p2çš„ç»“ç‚¹)çš„waitStatuså˜ä¸ºäº†SIGNALã€‚ c2çº¿ç¨‹è°ƒç”¨lock.lockï¼Œç”±å‰é¢çš„åˆ†æå¾—åˆ°å¦‚ä¸‹çš„æœ€ç»ˆçŠ¶æ€ã€‚ è¯´æ˜: æœ€ç»ˆc1çº¿ç¨‹ä¼šåœ¨sync queueé˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä¸”å…¶ç»“ç‚¹çš„å‰é©±ç»“ç‚¹(åŒ…å«c1çš„ç»“ç‚¹)çš„waitStatuså˜ä¸ºäº†SIGNALã€‚ p1çº¿ç¨‹æ‰§è¡ŒemptyCondition.signalï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ è¯´æ˜: AQS.COè¡¨ç¤ºAbstractQueuedSynchronizer.ConditionObjectç±»ã€‚æ­¤æ—¶è°ƒç”¨signalæ–¹æ³•ä¸ä¼šäº§ç”Ÿä»»ä½•å…¶ä»–æ•ˆæœã€‚ p1çº¿ç¨‹æ‰§è¡Œlock.unlockï¼Œæ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥ï¼Œæœ€ç»ˆçš„çŠ¶æ€å¦‚ä¸‹ã€‚ è¯´æ˜: æ­¤æ—¶ï¼Œp2çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”å…¶ä»–ä¸¤ä¸ªçº¿ç¨‹(c1ã€c2)ä¾æ—§è¢«ç¦æ­¢ï¼Œæ‰€ä»¥ï¼Œæ­¤æ—¶p2çº¿ç¨‹ç»§ç»­è¿è¡Œï¼Œæ‰§è¡Œç”¨æˆ·é€»è¾‘ã€‚ p2çº¿ç¨‹æ‰§è¡ŒfullCondition.awaitï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ è¯´æ˜: æœ€ç»ˆåˆ°è¾¾çš„çŠ¶æ€æ˜¯æ–°ç”Ÿæˆäº†ä¸€ä¸ªç»“ç‚¹ï¼ŒåŒ…å«äº†p2çº¿ç¨‹ï¼Œæ­¤ç»“ç‚¹åœ¨condition queueä¸­ï¼›å¹¶ä¸”sync queueä¸­p2çº¿ç¨‹è¢«ç¦æ­¢äº†ï¼Œå› ä¸ºåœ¨æ‰§è¡Œäº†LockSupport.parkæ“ä½œã€‚ä»æ–¹æ³•ä¸€äº›è°ƒç”¨å¯çŸ¥ï¼Œåœ¨awaitæ“ä½œä¸­çº¿ç¨‹ä¼šé‡Šæ”¾é”èµ„æºï¼Œä¾›å…¶ä»–çº¿ç¨‹è·å–ã€‚åŒæ—¶ï¼Œheadç»“ç‚¹åç»§ç»“ç‚¹çš„åŒ…å«çš„çº¿ç¨‹çš„è®¸å¯è¢«é‡Šæ”¾äº†ï¼Œæ•…å…¶å¯ä»¥ç»§ç»­è¿è¡Œã€‚ç”±äºæ­¤æ—¶ï¼Œåªæœ‰c1çº¿ç¨‹å¯ä»¥è¿è¡Œï¼Œæ•…è¿è¡Œc1ã€‚ ç»§ç»­è¿è¡Œc1çº¿ç¨‹ï¼Œc1çº¿ç¨‹ç”±äºä¹‹å‰è¢«parkäº†ï¼Œæ‰€ä»¥æ­¤æ—¶æ¢å¤ï¼Œç»§ç»­ä¹‹å‰çš„æ­¥éª¤ï¼Œå³è¿˜æ˜¯æ‰§è¡Œå‰é¢æåˆ°çš„acquireQueuedæ–¹æ³•ï¼Œä¹‹åï¼Œc1åˆ¤æ–­è‡ªå·±çš„å‰é©±ç»“ç‚¹ä¸ºheadï¼Œå¹¶ä¸”å¯ä»¥è·å–é”èµ„æºï¼Œæœ€ç»ˆåˆ°è¾¾çš„çŠ¶æ€å¦‚ä¸‹ã€‚ è¯´æ˜: å…¶ä¸­ï¼Œheadè®¾ç½®ä¸ºåŒ…å«c1çº¿ç¨‹çš„ç»“ç‚¹ï¼Œc1ç»§ç»­è¿è¡Œã€‚ c1çº¿ç¨‹æ‰§è¡ŒfullCondtion.signalï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ è¯´æ˜: signalæ–¹æ³•è¾¾åˆ°çš„æœ€ç»ˆç»“æœæ˜¯å°†åŒ…å«p2çº¿ç¨‹çš„ç»“ç‚¹ä»condition queueä¸­è½¬ç§»åˆ°sync queueä¸­ï¼Œä¹‹åcondition queueä¸ºnullï¼Œä¹‹å‰çš„å°¾ç»“ç‚¹çš„çŠ¶æ€å˜ä¸ºSIGNALã€‚ c1çº¿ç¨‹æ‰§è¡Œlock.unlockæ“ä½œï¼Œæ ¹æ®ä¹‹å‰çš„åˆ†æï¼Œç»å†çš„çŠ¶æ€å˜åŒ–å¦‚ä¸‹ã€‚ è¯´æ˜: æœ€ç»ˆc2çº¿ç¨‹ä¼šè·å–é”èµ„æºï¼Œç»§ç»­è¿è¡Œç”¨æˆ·é€»è¾‘ã€‚ c2çº¿ç¨‹æ‰§è¡ŒemptyCondition.awaitï¼Œç”±å‰é¢çš„ç¬¬ä¸ƒæ­¥åˆ†æï¼Œå¯çŸ¥æœ€ç»ˆçš„çŠ¶æ€å¦‚ä¸‹ã€‚ è¯´æ˜: awaitæ“ä½œå°†ä¼šç”Ÿæˆä¸€ä¸ªç»“ç‚¹æ”¾å…¥condition queueä¸­ä¸ä¹‹å‰çš„ä¸€ä¸ªcondition queueæ˜¯ä¸ç›¸åŒçš„ï¼Œå¹¶ä¸”unparkå¤´èŠ‚ç‚¹åé¢çš„ç»“ç‚¹ï¼Œå³åŒ…å«çº¿ç¨‹p2çš„ç»“ç‚¹ã€‚ p2çº¿ç¨‹è¢«unparkï¼Œæ•…å¯ä»¥ç»§ç»­è¿è¡Œï¼Œç»è¿‡CPUè°ƒåº¦åï¼Œp2ç»§ç»­è¿è¡Œï¼Œä¹‹åp2çº¿ç¨‹åœ¨AQS:awaitæ–¹æ³•ä¸­è¢«parkï¼Œç»§ç»­AQS.CO:awaitæ–¹æ³•çš„è¿è¡Œï¼Œå…¶æ–¹æ³•è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼Œåªç»™å‡ºäº†ä¸»è¦çš„æ–¹æ³•è°ƒç”¨ã€‚ p2ç»§ç»­è¿è¡Œï¼Œæ‰§è¡ŒemptyCondition.signalï¼Œæ ¹æ®ç¬¬ä¹æ­¥åˆ†æå¯çŸ¥ï¼Œæœ€ç»ˆåˆ°è¾¾çš„çŠ¶æ€å¦‚ä¸‹ã€‚ è¯´æ˜: æœ€ç»ˆï¼Œå°†condition queueä¸­çš„ç»“ç‚¹è½¬ç§»åˆ°sync queueä¸­ï¼Œå¹¶æ·»åŠ è‡³å°¾éƒ¨ï¼Œcondition queueä¼šä¸ºç©ºï¼Œå¹¶ä¸”å°†headçš„çŠ¶æ€è®¾ç½®ä¸ºSIGNALã€‚ p2çº¿ç¨‹æ‰§è¡Œlock.unlockæ“ä½œï¼Œæ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥ï¼Œæœ€åçš„åˆ°è¾¾çš„çŠ¶æ€å¦‚ä¸‹ã€‚ è¯´æ˜: unlockæ“ä½œä¼šé‡Šæ”¾c2çº¿ç¨‹çš„è®¸å¯ï¼Œå¹¶ä¸”å°†å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºc2çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹ã€‚ c2çº¿ç¨‹ç»§ç»­è¿è¡Œï¼Œæ‰§è¡ŒfullCondition. signalï¼Œç”±äºæ­¤æ—¶fullConditionçš„condition queueå·²ç»ä¸å­˜åœ¨ä»»ä½•ç»“ç‚¹äº†ï¼Œæ•…å…¶ä¸ä¼šäº§ç”Ÿä½œç”¨ã€‚ c2æ‰§è¡Œlock.unlockï¼Œç”±äºc2æ˜¯syncé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªç»“ç‚¹ï¼Œæ•…å…¶ä¸ä¼šå†è°ƒç”¨unparkSuccessoräº†ï¼Œç›´æ¥è¿”å›trueã€‚å³æ•´ä¸ªæµç¨‹å°±å®Œæˆäº†ã€‚ AbstractQueuedSynchronizeræ€»ç»“å¯¹äºAbstractQueuedSynchronizerçš„åˆ†æï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯sync queueçš„åˆ†æã€‚ æ¯ä¸€ä¸ªç»“ç‚¹éƒ½æ˜¯ç”±å‰ä¸€ä¸ªç»“ç‚¹å”¤é†’ å½“ç»“ç‚¹å‘ç°å‰é©±ç»“ç‚¹æ˜¯headå¹¶ä¸”å°è¯•è·å–æˆåŠŸï¼Œåˆ™ä¼šè½®åˆ°è¯¥çº¿ç¨‹è¿è¡Œã€‚ condition queueä¸­çš„ç»“ç‚¹å‘sync queueä¸­è½¬ç§»æ˜¯é€šè¿‡signalæ“ä½œå®Œæˆçš„ã€‚ å½“ç»“ç‚¹çš„çŠ¶æ€ä¸ºSIGNALæ—¶ï¼Œè¡¨ç¤ºåé¢çš„ç»“ç‚¹éœ€è¦è¿è¡Œã€‚ å‚è€ƒæ–‡ç«  æ–‡ç« ä¸»è¦å‚è€ƒè‡ªleesfçš„https://www.cnblogs.com/leesf456/p/5350186.htmlï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšäº†å¢æ”¹ã€‚ http://ifeve.com/introduce-abstractqueuedsynchronizer/ http://blog.csdn.net/chen77716/article/details/6641477 https://blog.csdn.net/mulinsen77/article/details/84583716","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"10.JUCé”: LockSupportè¯¦è§£","path":"/2023/12/25/10-JUCé”-LockSupportè¯¦è§£/","content":"LockSupportæ˜¯é”ä¸­çš„åŸºç¡€ï¼Œæ˜¯ä¸€ä¸ªæä¾›é”æœºåˆ¶çš„å·¥å…·ç±»ï¼Œæ‰€ä»¥å…ˆå¯¹å…¶è¿›è¡Œåˆ†æã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ ä¸ºä»€ä¹ˆLockSupportä¹Ÿæ˜¯æ ¸å¿ƒåŸºç¡€ç±»? AQSæ¡†æ¶å€ŸåŠ©äºä¸¤ä¸ªç±»ï¼šUnsafe(æä¾›CASæ“ä½œ)å’ŒLockSupport(æä¾›park&#x2F;unparkæ“ä½œ) å†™å‡ºåˆ†åˆ«é€šè¿‡wait&#x2F;notifyå’ŒLockSupportçš„park&#x2F;unparkå®ç°åŒæ­¥? LockSupport.park()ä¼šé‡Šæ”¾é”èµ„æºå—? é‚£ä¹ˆCondition.await()å‘¢? Thread.sleep()ã€Object.wait()ã€Condition.await()ã€LockSupport.park()çš„åŒºåˆ«? é‡ç‚¹ å¦‚æœåœ¨wait()ä¹‹å‰æ‰§è¡Œäº†notify()ä¼šæ€æ ·? å¦‚æœåœ¨park()ä¹‹å‰æ‰§è¡Œäº†unpark()ä¼šæ€æ ·? LockSupportç®€ä»‹LockSupportç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå½“è°ƒç”¨LockSupport.parkæ—¶ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹å°†ä¼šç­‰å¾…ï¼Œç›´è‡³è·å¾—è®¸å¯ï¼Œå½“è°ƒç”¨LockSupport.unparkæ—¶ï¼Œå¿…é¡»æŠŠç­‰å¾…è·å¾—è®¸å¯çš„çº¿ç¨‹ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ï¼Œå¥½è®©æ­¤çº¿ç¨‹ç»§ç»­è¿è¡Œã€‚ LockSupportæºç åˆ†æç±»çš„å±æ€§123456789101112131415161718192021222324252627282930313233public class LockSupport &#123; // Hotspot implementation via intrinsics API private static final sun.misc.Unsafe UNSAFE; // è¡¨ç¤ºå†…å­˜åç§»åœ°å€ private static final long parkBlockerOffset; // è¡¨ç¤ºå†…å­˜åç§»åœ°å€ private static final long SEED; // è¡¨ç¤ºå†…å­˜åç§»åœ°å€ private static final long PROBE; // è¡¨ç¤ºå†…å­˜åç§»åœ°å€ private static final long SECONDARY; static &#123; try &#123; // è·å–Unsafeå®ä¾‹ UNSAFE = sun.misc.Unsafe.getUnsafe(); // çº¿ç¨‹ç±»ç±»å‹ Class&lt;?&gt; tk = Thread.class; // è·å–Threadçš„parkBlockerå­—æ®µçš„å†…å­˜åç§»åœ°å€ parkBlockerOffset = UNSAFE.objectFieldOffset (tk.getDeclaredField(&quot;parkBlocker&quot;)); // è·å–Threadçš„threadLocalRandomSeedå­—æ®µçš„å†…å­˜åç§»åœ°å€ SEED = UNSAFE.objectFieldOffset (tk.getDeclaredField(&quot;threadLocalRandomSeed&quot;)); // è·å–Threadçš„threadLocalRandomProbeå­—æ®µçš„å†…å­˜åç§»åœ°å€ PROBE = UNSAFE.objectFieldOffset (tk.getDeclaredField(&quot;threadLocalRandomProbe&quot;)); // è·å–Threadçš„threadLocalRandomSecondarySeedå­—æ®µçš„å†…å­˜åç§»åœ°å€ SECONDARY = UNSAFE.objectFieldOffset (tk.getDeclaredField(&quot;threadLocalRandomSecondarySeed&quot;)); &#125; catch (Exception ex) &#123; throw new Error(ex); &#125; &#125;&#125; è¯´æ˜: UNSAFEå­—æ®µè¡¨ç¤ºsun.misc.Unsafeç±»ï¼ŒæŸ¥çœ‹å…¶æºç ï¼Œç‚¹å‡»åœ¨è¿™é‡Œï¼Œä¸€èˆ¬ç¨‹åºä¸­ä¸å…è®¸ç›´æ¥è°ƒç”¨ï¼Œè€Œlongå‹çš„è¡¨ç¤ºå®ä¾‹å¯¹è±¡ç›¸åº”å­—æ®µåœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œå¯ä»¥é€šè¿‡è¯¥åç§»åœ°å€è·å–æˆ–è€…è®¾ç½®è¯¥å­—æ®µçš„å€¼ã€‚ ç±»çš„æ„é€ å‡½æ•°12// ç§æœ‰æ„é€ å‡½æ•°ï¼Œæ— æ³•è¢«å®ä¾‹åŒ–private LockSupport() &#123;&#125; è¯´æ˜: LockSupportåªæœ‰ä¸€ä¸ªç§æœ‰æ„é€ å‡½æ•°ï¼Œæ— æ³•è¢«å®ä¾‹åŒ–ã€‚ æ ¸å¿ƒå‡½æ•°åˆ†æåœ¨åˆ†æLockSupportå‡½æ•°ä¹‹å‰ï¼Œå…ˆå¼•å…¥sun.misc.Unsafeç±»ä¸­çš„parkå’Œunparkå‡½æ•°ï¼Œå› ä¸ºLockSupportçš„æ ¸å¿ƒå‡½æ•°éƒ½æ˜¯åŸºäºUnsafeç±»ä¸­å®šä¹‰çš„parkå’Œunparkå‡½æ•°ï¼Œä¸‹é¢ç»™å‡ºä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰: 12public native void park(boolean isAbsolute, long time);public native void unpark(Thread thread); è¯´æ˜: å¯¹ä¸¤ä¸ªå‡½æ•°çš„è¯´æ˜å¦‚ä¸‹: parkå‡½æ•°ï¼Œé˜»å¡çº¿ç¨‹ï¼Œå¹¶ä¸”è¯¥çº¿ç¨‹åœ¨ä¸‹åˆ—æƒ…å†µå‘ç”Ÿä¹‹å‰éƒ½ä¼šè¢«é˜»å¡: â‘  è°ƒç”¨unparkå‡½æ•°ï¼Œé‡Šæ”¾è¯¥çº¿ç¨‹çš„è®¸å¯ã€‚â‘¡ è¯¥çº¿ç¨‹è¢«ä¸­æ–­ã€‚â‘¢ è®¾ç½®çš„æ—¶é—´åˆ°äº†ã€‚å¹¶ä¸”ï¼Œå½“timeä¸ºç»å¯¹æ—¶é—´æ—¶ï¼ŒisAbsoluteä¸ºtrueï¼Œå¦åˆ™ï¼ŒisAbsoluteä¸ºfalseã€‚å½“timeä¸º0æ—¶ï¼Œè¡¨ç¤ºæ— é™ç­‰å¾…ï¼Œç›´åˆ°unparkå‘ç”Ÿã€‚ unparkå‡½æ•°ï¼Œé‡Šæ”¾çº¿ç¨‹çš„è®¸å¯ï¼Œå³æ¿€æ´»è°ƒç”¨parkåé˜»å¡çš„çº¿ç¨‹ã€‚è¿™ä¸ªå‡½æ•°ä¸æ˜¯å®‰å…¨çš„ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶è¦ç¡®ä¿çº¿ç¨‹ä¾æ—§å­˜æ´»ã€‚ parkå‡½æ•°parkå‡½æ•°æœ‰ä¸¤ä¸ªé‡è½½ç‰ˆæœ¬ï¼Œæ–¹æ³•æ‘˜è¦å¦‚ä¸‹ 12public static void park()ï¼›public static void park(Object blocker)ï¼› è¯´æ˜: ä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«åœ¨äºpark()å‡½æ•°æ²¡æœ‰æ²¡æœ‰blockerï¼Œå³æ²¡æœ‰è®¾ç½®çº¿ç¨‹çš„parkBlockerå­—æ®µã€‚park(Object)å‹å‡½æ•°å¦‚ä¸‹ã€‚ 12345678910public static void park(Object blocker) &#123; // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // è®¾ç½®Blocker setBlocker(t, blocker); // è·å–è®¸å¯ UNSAFE.park(false, 0L); // é‡æ–°å¯è¿è¡Œåå†æ­¤è®¾ç½®Blocker setBlocker(t, null);&#125; è¯´æ˜: è°ƒç”¨parkå‡½æ•°æ—¶ï¼Œé¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œç„¶åè®¾ç½®å½“å‰çº¿ç¨‹çš„parkBlockerå­—æ®µï¼Œå³è°ƒç”¨setBlockerå‡½æ•°ï¼Œä¹‹åè°ƒç”¨Unsafeç±»çš„parkå‡½æ•°ï¼Œä¹‹åå†è°ƒç”¨setBlockerå‡½æ•°ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆè¦åœ¨æ­¤parkå‡½æ•°ä¸­è¦è°ƒç”¨ä¸¤æ¬¡setBlockerå‡½æ•°å‘¢? åŸå› å…¶å®å¾ˆç®€å•ï¼Œè°ƒç”¨parkå‡½æ•°æ—¶ï¼Œå½“å‰çº¿ç¨‹é¦–å…ˆè®¾ç½®å¥½parkBlockerå­—æ®µï¼Œç„¶åå†è°ƒç”¨Unsafeçš„parkå‡½æ•°ï¼Œæ­¤åï¼Œå½“å‰çº¿ç¨‹å°±å·²ç»é˜»å¡äº†ï¼Œç­‰å¾…è¯¥çº¿ç¨‹çš„unparkå‡½æ•°è¢«è°ƒç”¨ï¼Œæ‰€ä»¥åé¢çš„ä¸€ä¸ªsetBlockerå‡½æ•°æ— æ³•è¿è¡Œï¼Œunparkå‡½æ•°è¢«è°ƒç”¨ï¼Œè¯¥çº¿ç¨‹è·å¾—è®¸å¯åï¼Œå°±å¯ä»¥ç»§ç»­è¿è¡Œäº†ï¼Œä¹Ÿå°±è¿è¡Œç¬¬äºŒä¸ªsetBlockerï¼ŒæŠŠè¯¥çº¿ç¨‹çš„parkBlockerå­—æ®µè®¾ç½®ä¸ºnullï¼Œè¿™æ ·å°±å®Œæˆäº†æ•´ä¸ªparkå‡½æ•°çš„é€»è¾‘ã€‚å¦‚æœæ²¡æœ‰ç¬¬äºŒä¸ªsetBlockerï¼Œé‚£ä¹ˆä¹‹åæ²¡æœ‰è°ƒç”¨park(Object blocker)ï¼Œè€Œç›´æ¥è°ƒç”¨getBlockerå‡½æ•°ï¼Œå¾—åˆ°çš„è¿˜æ˜¯å‰ä¸€ä¸ªpark(Object blocker)è®¾ç½®çš„blockerï¼Œæ˜¾ç„¶æ˜¯ä¸ç¬¦åˆé€»è¾‘çš„ã€‚æ€»ä¹‹ï¼Œå¿…é¡»è¦ä¿è¯åœ¨park(Object blocker)æ•´ä¸ªå‡½æ•°æ‰§è¡Œå®Œåï¼Œè¯¥çº¿ç¨‹çš„parkBlockerå­—æ®µåˆæ¢å¤ä¸ºnullã€‚æ‰€ä»¥ï¼Œpark(Object)å‹å‡½æ•°é‡Œå¿…é¡»è¦è°ƒç”¨setBlockerå‡½æ•°ä¸¤æ¬¡ã€‚setBlockeræ–¹æ³•å¦‚ä¸‹ã€‚ 1234private static void setBlocker(Thread t, Object arg) &#123; // è®¾ç½®çº¿ç¨‹tçš„parkBlockerå­—æ®µçš„å€¼ä¸ºarg UNSAFE.putObject(t, parkBlockerOffset, arg);&#125; è¯´æ˜: æ­¤æ–¹æ³•ç”¨äºè®¾ç½®çº¿ç¨‹tçš„parkBlockerå­—æ®µçš„å€¼ä¸ºargã€‚ å¦å¤–ä¸€ä¸ªæ— å‚é‡è½½ç‰ˆæœ¬ï¼Œpark()å‡½æ•°å¦‚ä¸‹ã€‚ 1234public static void park() &#123; // è·å–è®¸å¯ï¼Œè®¾ç½®æ—¶é—´ä¸ºæ— é™é•¿ï¼Œç›´åˆ°å¯ä»¥è·å–è®¸å¯ UNSAFE.park(false, 0L);&#125; è¯´æ˜: è°ƒç”¨äº†parkå‡½æ•°åï¼Œä¼šç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œé™¤éè®¸å¯å¯ç”¨ã€‚åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹ä¸€å‘ç”Ÿä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹éƒ½å°†å¤„äºä¼‘çœ çŠ¶æ€ï¼Œå³ä¸‹åˆ—æƒ…å†µå‘ç”Ÿæ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šè·å–è®¸å¯ï¼Œå¯ä»¥ç»§ç»­è¿è¡Œã€‚ å…¶ä»–æŸä¸ªçº¿ç¨‹å°†å½“å‰çº¿ç¨‹ä½œä¸ºç›®æ ‡è°ƒç”¨ unparkã€‚ å…¶ä»–æŸä¸ªçº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚ è¯¥è°ƒç”¨ä¸åˆé€»è¾‘åœ°(å³æ¯«æ— ç†ç”±åœ°)è¿”å›ã€‚ parkNanoså‡½æ•°æ­¤å‡½æ•°è¡¨ç¤ºåœ¨è®¸å¯å¯ç”¨å‰ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œå¹¶æœ€å¤šç­‰å¾…æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ã€‚å…·ä½“å‡½æ•°å¦‚ä¸‹ã€‚ 123456789101112public static void parkNanos(Object blocker, long nanos) &#123; if (nanos &gt; 0) &#123; // æ—¶é—´å¤§äº0 // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // è®¾ç½®Blocker setBlocker(t, blocker); // è·å–è®¸å¯ï¼Œå¹¶è®¾ç½®äº†æ—¶é—´ UNSAFE.park(false, nanos); // è®¾ç½®è®¸å¯ setBlocker(t, null); &#125;&#125; è¯´æ˜: è¯¥å‡½æ•°ä¹Ÿæ˜¯è°ƒç”¨äº†ä¸¤æ¬¡setBlockerå‡½æ•°ï¼Œnanoså‚æ•°è¡¨ç¤ºç›¸å¯¹æ—¶é—´ï¼Œè¡¨ç¤ºç­‰å¾…å¤šé•¿æ—¶é—´ã€‚ parkUntilå‡½æ•°æ­¤å‡½æ•°è¡¨ç¤ºåœ¨æŒ‡å®šçš„æ—¶é™å‰ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œé™¤éè®¸å¯å¯ç”¨, å…·ä½“å‡½æ•°å¦‚ä¸‹: 123456789public static void parkUntil(Object blocker, long deadline) &#123; // è·å–å½“å‰çº¿ç¨‹ Thread t = Thread.currentThread(); // è®¾ç½®Blocker setBlocker(t, blocker); UNSAFE.park(true, deadline); // è®¾ç½®Blockerä¸ºnull setBlocker(t, null);&#125; è¯´æ˜: è¯¥å‡½æ•°ä¹Ÿè°ƒç”¨äº†ä¸¤æ¬¡setBlockerå‡½æ•°ï¼Œdeadlineå‚æ•°è¡¨ç¤ºç»å¯¹æ—¶é—´ï¼Œè¡¨ç¤ºæŒ‡å®šçš„æ—¶é—´ã€‚ unparkå‡½æ•°æ­¤å‡½æ•°è¡¨ç¤ºå¦‚æœç»™å®šçº¿ç¨‹çš„è®¸å¯å°šä¸å¯ç”¨ï¼Œåˆ™ä½¿å…¶å¯ç”¨ã€‚å¦‚æœçº¿ç¨‹åœ¨ park ä¸Šå—é˜»å¡ï¼Œåˆ™å®ƒå°†è§£é™¤å…¶é˜»å¡çŠ¶æ€ã€‚å¦åˆ™ï¼Œä¿è¯ä¸‹ä¸€æ¬¡è°ƒç”¨ park ä¸ä¼šå—é˜»å¡ã€‚å¦‚æœç»™å®šçº¿ç¨‹å°šæœªå¯åŠ¨ï¼Œåˆ™æ— æ³•ä¿è¯æ­¤æ“ä½œæœ‰ä»»ä½•æ•ˆæœã€‚å…·ä½“å‡½æ•°å¦‚ä¸‹: 1234public static void unpark(Thread thread) &#123; if (thread != null) // çº¿ç¨‹ä¸ºä¸ç©º UNSAFE.unpark(thread); // é‡Šæ”¾è¯¥çº¿ç¨‹è®¸å¯&#125; è¯´æ˜: é‡Šæ”¾è®¸å¯ï¼ŒæŒ‡å®šçº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œã€‚ LockSupportç¤ºä¾‹è¯´æ˜ä½¿ç”¨wait&#x2F;notifyå®ç°çº¿ç¨‹åŒæ­¥1234567891011121314151617181920212223242526272829class MyThread extends Thread &#123; public void run() &#123; synchronized (this) &#123; System.out.println(&quot;before notify&quot;); notify(); System.out.println(&quot;after notify&quot;); &#125; &#125;&#125;public class WaitAndNotifyDemo &#123; public static void main(String[] args) throws InterruptedException &#123; MyThread myThread = new MyThread(); synchronized (myThread) &#123; try &#123; myThread.start(); // ä¸»çº¿ç¨‹ç¡çœ 3s Thread.sleep(3000); System.out.println(&quot;before wait&quot;); // é˜»å¡ä¸»çº¿ç¨‹ myThread.wait(); System.out.println(&quot;after wait&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; è¿è¡Œç»“æœ 1234before waitbefore notifyafter notifyafter wait è¯´æ˜: å…·ä½“çš„æµç¨‹å›¾å¦‚ä¸‹ ä½¿ç”¨wait&#x2F;notifyå®ç°åŒæ­¥æ—¶ï¼Œå¿…é¡»å…ˆè°ƒç”¨waitï¼Œåè°ƒç”¨notifyï¼Œå¦‚æœå…ˆè°ƒç”¨notifyï¼Œå†è°ƒç”¨waitï¼Œå°†èµ·ä¸äº†ä½œç”¨ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ 12345678910111213141516171819202122232425262728class MyThread extends Thread &#123; public void run() &#123; synchronized (this) &#123; System.out.println(&quot;before notify&quot;); notify(); System.out.println(&quot;after notify&quot;); &#125; &#125;&#125;public class WaitAndNotifyDemo &#123; public static void main(String[] args) throws InterruptedException &#123; MyThread myThread = new MyThread(); myThread.start(); // ä¸»çº¿ç¨‹ç¡çœ 3s Thread.sleep(3000); synchronized (myThread) &#123; try &#123; System.out.println(&quot;before wait&quot;); // é˜»å¡ä¸»çº¿ç¨‹ myThread.wait(); System.out.println(&quot;after wait&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; è¿è¡Œç»“æœ: 123before notifyafter notifybefore wait è¯´æ˜: ç”±äºå…ˆè°ƒç”¨äº†notifyï¼Œå†è°ƒç”¨çš„waitï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹è¿˜æ˜¯ä¼šä¸€ç›´é˜»å¡ã€‚ ä½¿ç”¨park&#x2F;unparkå®ç°çº¿ç¨‹åŒæ­¥12345678910111213141516171819202122232425262728293031323334353637383940414243import java.util.concurrent.locks.LockSupport;class MyThread extends Thread &#123; private Object object; public MyThread(Object object) &#123; this.object = object; &#125; public void run() &#123; System.out.println(&quot;before unpark&quot;); try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; // è·å–blocker System.out.println(&quot;Blocker info &quot; + LockSupport.getBlocker((Thread) object)); // é‡Šæ”¾è®¸å¯ LockSupport.unpark((Thread) object); // ä¼‘çœ 500msï¼Œä¿è¯å…ˆæ‰§è¡Œparkä¸­çš„setBlocker(t, null); try &#123; Thread.sleep(500); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; // å†æ¬¡è·å–blocker System.out.println(&quot;Blocker info &quot; + LockSupport.getBlocker((Thread) object)); System.out.println(&quot;after unpark&quot;); &#125;&#125;public class test &#123; public static void main(String[] args) &#123; MyThread myThread = new MyThread(Thread.currentThread()); myThread.start(); System.out.println(&quot;before park&quot;); // è·å–è®¸å¯ LockSupport.park(&quot;ParkAndUnparkDemo&quot;); System.out.println(&quot;after park&quot;); &#125;&#125; è¿è¡Œç»“æœ: 123456before parkbefore unparkBlocker info ParkAndUnparkDemoafter parkBlocker info nullafter unpark è¯´æ˜: æœ¬ç¨‹åºå…ˆæ‰§è¡Œparkï¼Œç„¶ååœ¨æ‰§è¡Œunparkï¼Œè¿›è¡ŒåŒæ­¥ï¼Œå¹¶ä¸”åœ¨unparkçš„å‰åéƒ½è°ƒç”¨äº†getBlockerï¼Œå¯ä»¥çœ‹åˆ°ä¸¤æ¬¡çš„ç»“æœä¸ä¸€æ ·ï¼Œå¹¶ä¸”ç¬¬äºŒæ¬¡è°ƒç”¨çš„ç»“æœä¸ºnullï¼Œè¿™æ˜¯å› ä¸ºåœ¨è°ƒç”¨unparkä¹‹åï¼Œæ‰§è¡Œäº†Lock.park(Object blocker)å‡½æ•°ä¸­çš„setBlocker(t, null)å‡½æ•°ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡è°ƒç”¨getBlockeræ—¶ä¸ºnullã€‚ ä¸Šä¾‹æ˜¯å…ˆè°ƒç”¨parkï¼Œç„¶åè°ƒç”¨unparkï¼Œç°åœ¨ä¿®æ”¹ç¨‹åºï¼Œå…ˆè°ƒç”¨unparkï¼Œç„¶åè°ƒç”¨parkï¼Œçœ‹èƒ½ä¸èƒ½æ­£ç¡®åŒæ­¥ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233import java.util.concurrent.locks.LockSupport;class MyThread extends Thread &#123; private Object object; public MyThread(Object object) &#123; this.object = object; &#125; public void run() &#123; System.out.println(&quot;before unpark&quot;); // é‡Šæ”¾è®¸å¯ LockSupport.unpark((Thread) object); System.out.println(&quot;after unpark&quot;); &#125;&#125;public class ParkAndUnparkDemo &#123; public static void main(String[] args) &#123; MyThread myThread = new MyThread(Thread.currentThread()); myThread.start(); try &#123; // ä¸»çº¿ç¨‹ç¡çœ 3s Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;before park&quot;); // è·å–è®¸å¯ LockSupport.park(&quot;ParkAndUnparkDemo&quot;); System.out.println(&quot;after park&quot;); &#125;&#125; è¿è¡Œç»“æœ: 1234before unparkafter unparkbefore parkafter park è¯´æ˜: å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å…ˆè°ƒç”¨unparkï¼Œå†è°ƒç”¨parkæ—¶ï¼Œä»èƒ½å¤Ÿæ­£ç¡®å®ç°åŒæ­¥ï¼Œä¸ä¼šé€ æˆç”±wait&#x2F;notifyè°ƒç”¨é¡ºåºä¸å½“æ‰€å¼•èµ·çš„é˜»å¡ã€‚å› æ­¤park&#x2F;unparkç›¸æ¯”wait&#x2F;notifyæ›´åŠ çš„çµæ´»ã€‚ ä¸­æ–­å“åº”çœ‹ä¸‹é¢ç¤ºä¾‹ 12345678910111213141516171819202122232425262728293031323334import java.util.concurrent.locks.LockSupport;class MyThread extends Thread &#123; private Object object; public MyThread(Object object) &#123; this.object = object; &#125; public void run() &#123; System.out.println(&quot;before interrupt&quot;); try &#123; // ä¼‘çœ 3s Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; Thread thread = (Thread) object; // ä¸­æ–­çº¿ç¨‹ thread.interrupt(); System.out.println(&quot;after interrupt&quot;); &#125;&#125;public class InterruptDemo &#123; public static void main(String[] args) &#123; MyThread myThread = new MyThread(Thread.currentThread()); myThread.start(); System.out.println(&quot;before park&quot;); // è·å–è®¸å¯ LockSupport.park(&quot;ParkAndUnparkDemo&quot;); System.out.println(&quot;after park&quot;); &#125;&#125; è¿è¡Œç»“æœ: 1234before parkbefore interruptafter interruptafter park è¯´æ˜: å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸»çº¿ç¨‹è°ƒç”¨parké˜»å¡åï¼Œåœ¨myThreadçº¿ç¨‹ä¸­å‘å‡ºäº†ä¸­æ–­ä¿¡å·ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹ä¼šç»§ç»­è¿è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´æ˜æ­¤æ—¶interruptèµ·åˆ°çš„ä½œç”¨ä¸unparkä¸€æ ·ã€‚ æ›´æ·±å…¥çš„ç†è§£Thread.sleep()å’ŒObject.wait()çš„åŒºåˆ«é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Thread.sleep()å’ŒObject.wait()çš„åŒºåˆ«ï¼Œè¿™æ˜¯ä¸€ä¸ªçƒ‚å¤§è¡—çš„é¢˜ç›®äº†ï¼Œå¤§å®¶åº”è¯¥éƒ½èƒ½è¯´ä¸Šæ¥ä¸¤ç‚¹ã€‚ Thread.sleep()ä¸ä¼šé‡Šæ”¾å æœ‰çš„é”ï¼ŒObject.wait()ä¼šé‡Šæ”¾å æœ‰çš„é”ï¼› Thread.sleep()å¿…é¡»ä¼ å…¥æ—¶é—´ï¼ŒObject.wait()å¯ä¼ å¯ä¸ä¼ ï¼Œä¸ä¼ è¡¨ç¤ºä¸€ç›´é˜»å¡ä¸‹å»ï¼› Thread.sleep()åˆ°æ—¶é—´äº†ä¼šè‡ªåŠ¨å”¤é†’ï¼Œç„¶åç»§ç»­æ‰§è¡Œï¼› Object.wait()ä¸å¸¦æ—¶é—´çš„ï¼Œéœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨Object.notify()å”¤é†’ï¼› Object.wait()å¸¦æ—¶é—´çš„ï¼Œå‡å¦‚æ²¡æœ‰è¢«notifyï¼Œåˆ°æ—¶é—´äº†ä¼šè‡ªåŠ¨å”¤é†’ï¼Œè¿™æ—¶åˆåˆ†å¥½ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯ç«‹å³è·å–åˆ°äº†é”ï¼Œçº¿ç¨‹è‡ªç„¶ä¼šç»§ç»­æ‰§è¡Œï¼›äºŒæ˜¯æ²¡æœ‰ç«‹å³è·å–é”ï¼Œçº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…è·å–é”ï¼› å…¶å®ï¼Œä»–ä»¬ä¿©æœ€å¤§çš„åŒºåˆ«å°±æ˜¯Thread.sleep()ä¸ä¼šé‡Šæ”¾é”èµ„æºï¼ŒObject.wait()ä¼šé‡Šæ”¾é”èµ„æºã€‚ Object.wait()å’ŒCondition.await()çš„åŒºåˆ«Object.wait()å’ŒCondition.await()çš„åŸç†æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œä¸åŒçš„æ˜¯Condition.await()åº•å±‚æ˜¯è°ƒç”¨LockSupport.park()æ¥å®ç°é˜»å¡å½“å‰çº¿ç¨‹çš„ã€‚ å®é™…ä¸Šï¼Œå®ƒåœ¨é˜»å¡å½“å‰çº¿ç¨‹ä¹‹å‰è¿˜å¹²äº†ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯æŠŠå½“å‰çº¿ç¨‹æ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ï¼ŒäºŒæ˜¯â€œå®Œå…¨â€é‡Šæ”¾é”ï¼Œä¹Ÿå°±æ˜¯è®©stateçŠ¶æ€å˜é‡å˜ä¸º0ï¼Œç„¶åæ‰æ˜¯è°ƒç”¨LockSupport.park()é˜»å¡å½“å‰çº¿ç¨‹ã€‚ Thread.sleep()å’ŒLockSupport.park()çš„åŒºåˆ«LockSupport.park()è¿˜æœ‰å‡ ä¸ªå…„å¼Ÿæ–¹æ³•â€”â€”parkNanos()ã€parkUtil()ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œè¯´çš„park()æ–¹æ³•ç»Ÿç§°è¿™ä¸€ç±»æ–¹æ³•ã€‚ ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼ŒThread.sleep()å’ŒLockSupport.park()æ–¹æ³•ç±»ä¼¼ï¼Œéƒ½æ˜¯é˜»å¡å½“å‰çº¿ç¨‹çš„æ‰§è¡Œï¼Œä¸”éƒ½ä¸ä¼šé‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„é”èµ„æºï¼› Thread.sleep()æ²¡æ³•ä»å¤–éƒ¨å”¤é†’ï¼Œåªèƒ½è‡ªå·±é†’è¿‡æ¥ï¼› LockSupport.park()æ–¹æ³•å¯ä»¥è¢«å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨LockSupport.unpark()æ–¹æ³•å”¤é†’ï¼› Thread.sleep()æ–¹æ³•å£°æ˜ä¸ŠæŠ›å‡ºäº†InterruptedExceptionä¸­æ–­å¼‚å¸¸ï¼Œæ‰€ä»¥è°ƒç”¨è€…éœ€è¦æ•è·è¿™ä¸ªå¼‚å¸¸æˆ–è€…å†æŠ›å‡ºï¼› LockSupport.park()æ–¹æ³•ä¸éœ€è¦æ•è·ä¸­æ–­å¼‚å¸¸ï¼› Thread.sleep()æœ¬èº«å°±æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼› LockSupport.park()åº•å±‚æ˜¯è°ƒç”¨çš„Unsafeçš„nativeæ–¹æ³•ï¼› Object.wait()å’ŒLockSupport.park()çš„åŒºåˆ«äºŒè€…éƒ½ä¼šé˜»å¡å½“å‰çº¿ç¨‹çš„è¿è¡Œï¼Œä»–ä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢? ç»è¿‡ä¸Šé¢çš„åˆ†æç›¸ä¿¡ä½ ä¸€å®šå¾ˆæ¸…æ¥šäº†ï¼ŒçœŸçš„å—? å¾€ä¸‹çœ‹ï¼ Object.wait()æ–¹æ³•éœ€è¦åœ¨synchronizedå—ä¸­æ‰§è¡Œï¼› LockSupport.park()å¯ä»¥åœ¨ä»»æ„åœ°æ–¹æ‰§è¡Œï¼› Object.wait()æ–¹æ³•å£°æ˜æŠ›å‡ºäº†ä¸­æ–­å¼‚å¸¸ï¼Œè°ƒç”¨è€…éœ€è¦æ•è·æˆ–è€…å†æŠ›å‡ºï¼› LockSupport.park()ä¸éœ€è¦æ•è·ä¸­æ–­å¼‚å¸¸ï¼› Object.wait()ä¸å¸¦è¶…æ—¶çš„ï¼Œéœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œnotify()æ¥å”¤é†’ï¼Œä½†ä¸ä¸€å®šç»§ç»­æ‰§è¡Œåç»­å†…å®¹ï¼› LockSupport.park()ä¸å¸¦è¶…æ—¶çš„ï¼Œéœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œunpark()æ¥å”¤é†’ï¼Œä¸€å®šä¼šç»§ç»­æ‰§è¡Œåç»­å†…å®¹ï¼› park()&#x2F;unpark()åº•å±‚çš„åŸç†æ˜¯â€œäºŒå…ƒä¿¡å·é‡â€ï¼Œä½ å¯ä»¥æŠŠå®ƒç›¸åƒæˆåªæœ‰ä¸€ä¸ªè®¸å¯è¯çš„Semaphoreï¼Œåªä¸è¿‡è¿™ä¸ªä¿¡å·é‡åœ¨é‡å¤æ‰§è¡Œunpark()çš„æ—¶å€™ä¹Ÿä¸ä¼šå†å¢åŠ è®¸å¯è¯ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªè®¸å¯è¯ã€‚ å¦‚æœåœ¨wait()ä¹‹å‰æ‰§è¡Œäº†notify()ä¼šæ€æ ·?å¦‚æœå½“å‰çš„çº¿ç¨‹ä¸æ˜¯æ­¤å¯¹è±¡é”çš„æ‰€æœ‰è€…ï¼Œå´è°ƒç”¨è¯¥å¯¹è±¡çš„notify()æˆ–wait()æ–¹æ³•æ—¶æŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ï¼› å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ­¤å¯¹è±¡é”çš„æ‰€æœ‰è€…ï¼Œwait()å°†ä¸€ç›´é˜»å¡ï¼Œå› ä¸ºåç»­å°†æ²¡æœ‰å…¶å®ƒnotify()å”¤é†’å®ƒã€‚ å¦‚æœåœ¨park()ä¹‹å‰æ‰§è¡Œäº†unpark()ä¼šæ€æ ·?çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œç›´æ¥è·³è¿‡park()ï¼Œç»§ç»­æ‰§è¡Œåç»­å†…å®¹ LockSupport.park()ä¼šé‡Šæ”¾é”èµ„æºå—?ä¸ä¼šï¼Œå®ƒåªè´Ÿè´£é˜»å¡å½“å‰çº¿ç¨‹ï¼Œé‡Šæ”¾é”èµ„æºå®é™…ä¸Šæ˜¯åœ¨Conditionçš„await()æ–¹æ³•ä¸­å®ç°çš„ã€‚ å‚è€ƒæ–‡ç«  æ–‡ç« ä¸»è¦å‚è€ƒè‡ªleesfçš„https://www.cnblogs.com/leesf456/p/5347293.htmlï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšäº†å¢æ”¹ã€‚ https://blog.csdn.net/tangtong1/article/details/102829724","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"9.JUCåŸå­ç±»: CAS, Unsafeå’ŒåŸå­ç±»è¯¦è§£","path":"/2023/12/25/9-JUCåŸå­ç±»-CAS-Unsafeå’ŒåŸå­ç±»è¯¦è§£/","content":"JUCä¸­å¤šæ•°ç±»æ˜¯é€šè¿‡volatileå’ŒCASæ¥å®ç°çš„ï¼ŒCASæœ¬è´¨ä¸Šæä¾›çš„æ˜¯ä¸€ç§æ— é”æ–¹æ¡ˆï¼Œè€ŒSynchronizedå’ŒLockæ˜¯äº’æ–¥é”æ–¹æ¡ˆ; javaåŸå­ç±»æœ¬è´¨ä¸Šä½¿ç”¨çš„æ˜¯CASï¼Œè€ŒCASåº•å±‚æ˜¯é€šè¿‡Unsafeç±»å®ç°çš„ã€‚æ‰€ä»¥æœ¬ç« å°†å¯¹CAS, Unsafeå’ŒåŸå­ç±»è¯¦è§£ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•æœ‰å“ªäº›? ä»€ä¹ˆæ˜¯CAS? CASä½¿ç”¨ç¤ºä¾‹ï¼Œç»“åˆAtomicIntegerç»™å‡ºç¤ºä¾‹? CASä¼šæœ‰å“ªäº›é—®é¢˜? é’ˆå¯¹è¿™è¿™äº›é—®é¢˜ï¼ŒJavaæä¾›äº†å“ªå‡ ä¸ªè§£å†³çš„? AtomicIntegeråº•å±‚å®ç°? CAS+volatile è¯·é˜è¿°ä½ å¯¹Unsafeç±»çš„ç†è§£? è¯´è¯´ä½ å¯¹JavaåŸå­ç±»çš„ç†è§£? åŒ…å«13ä¸ªï¼Œ4ç»„åˆ†ç±»ï¼Œè¯´è¯´ä½œç”¨å’Œä½¿ç”¨åœºæ™¯ã€‚ AtomicStampedReferenceæ˜¯ä»€ä¹ˆ? AtomicStampedReferenceæ˜¯æ€ä¹ˆè§£å†³ABAçš„? å†…éƒ¨ä½¿ç”¨Pairæ¥å­˜å‚¨å…ƒç´ å€¼åŠå…¶ç‰ˆæœ¬å· javaä¸­è¿˜æœ‰å“ªäº›ç±»å¯ä»¥è§£å†³ABAçš„é—®é¢˜? AtomicMarkableReference CASå‰é¢æˆ‘ä»¬è¯´åˆ°ï¼Œçº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•åŒ…å«: äº’æ–¥åŒæ­¥: synchronized å’Œ ReentrantLock éé˜»å¡åŒæ­¥: CAS, AtomicXXXX æ— åŒæ­¥æ–¹æ¡ˆ: æ ˆå°é—­ï¼ŒThread Localï¼Œå¯é‡å…¥ä»£ç  å…·ä½“å¯ä»¥å‚çœ‹ï¼šçº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å°†å¯¹CASé‡ç‚¹é˜é‡Šã€‚ ä»€ä¹ˆæ˜¯CASCASçš„å…¨ç§°ä¸ºCompare-And-Swapï¼Œç›´è¯‘å°±æ˜¯å¯¹æ¯”äº¤æ¢ã€‚æ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œå…¶ä½œç”¨æ˜¯è®©CPUå…ˆè¿›è¡Œæ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œç„¶ååŸå­åœ°æ›´æ–°æŸä¸ªä½ç½®çš„å€¼ï¼Œç»è¿‡è°ƒæŸ¥å‘ç°ï¼Œå…¶å®ç°æ–¹å¼æ˜¯åŸºäºç¡¬ä»¶å¹³å°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå°±æ˜¯è¯´CASæ˜¯é ç¡¬ä»¶å®ç°çš„ï¼ŒJVMåªæ˜¯å°è£…äº†æ±‡ç¼–è°ƒç”¨ï¼Œé‚£äº›AtomicIntegerç±»ä¾¿æ˜¯ä½¿ç”¨äº†è¿™äº›å°è£…åçš„æ¥å£ã€‚ ç®€å•è§£é‡Šï¼šCASæ“ä½œéœ€è¦è¾“å…¥ä¸¤ä¸ªæ•°å€¼ï¼Œä¸€ä¸ªæ—§å€¼(æœŸæœ›æ“ä½œå‰çš„å€¼)å’Œä¸€ä¸ªæ–°å€¼ï¼Œåœ¨æ“ä½œæœŸé—´å…ˆæ¯”è¾ƒä¸‹åœ¨æ—§å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰äº¤æ¢æˆæ–°å€¼ï¼Œå‘ç”Ÿäº†å˜åŒ–åˆ™ä¸äº¤æ¢ã€‚ CASæ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹å¹¶å‘ä½¿ç”¨CASæ›´æ–°æ•°æ®æ—¶ï¼Œå¯ä»¥ä¸ä½¿ç”¨é”ã€‚JDKä¸­å¤§é‡ä½¿ç”¨äº†CASæ¥æ›´æ–°æ•°æ®è€Œé˜²æ­¢åŠ é”(synchronized é‡é‡çº§é”)æ¥ä¿æŒåŸå­æ›´æ–°ã€‚ ç›¸ä¿¡sqlå¤§å®¶éƒ½ç†Ÿæ‚‰ï¼Œç±»ä¼¼sqlä¸­çš„æ¡ä»¶æ›´æ–°ä¸€æ ·ï¼šupdate set id&#x3D;3 from table where id&#x3D;2ã€‚å› ä¸ºå•æ¡sqlæ‰§è¡Œå…·æœ‰åŸå­æ€§ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œæ­¤sqlè¯­å¥ï¼Œåªæœ‰ä¸€æ¡èƒ½æ›´æ–°æˆåŠŸã€‚ CASä½¿ç”¨ç¤ºä¾‹å¦‚æœä¸ä½¿ç”¨CASï¼Œåœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹ä¸€ä¸ªå˜é‡çš„å€¼æˆ‘ä»¬éœ€è¦synchronizedåŠ é”(å¯èƒ½æœ‰äººè¯´å¯ä»¥ç”¨LockåŠ é”ï¼ŒLockåº•å±‚çš„AQSä¹Ÿæ˜¯åŸºäºCASè¿›è¡Œè·å–é”çš„)ã€‚ 123456public class Test &#123; private int i=0; public synchronized int add()&#123; return i++; &#125;&#125; javaä¸­ä¸ºæˆ‘ä»¬æä¾›äº†AtomicInteger åŸå­ç±»(åº•å±‚åŸºäºCASè¿›è¡Œæ›´æ–°æ•°æ®çš„)ï¼Œä¸éœ€è¦åŠ é”å°±åœ¨å¤šçº¿ç¨‹å¹¶å‘åœºæ™¯ä¸‹å®ç°æ•°æ®çš„ä¸€è‡´æ€§ã€‚ 123456public class Test &#123; private AtomicInteger i = new AtomicInteger(0); public int add()&#123; return i.addAndGet(1); &#125;&#125; CAS é—®é¢˜CAS æ–¹å¼ä¸ºä¹è§‚é”ï¼Œsynchronized ä¸ºæ‚²è§‚é”ã€‚å› æ­¤ä½¿ç”¨ CAS è§£å†³å¹¶å‘é—®é¢˜é€šå¸¸æƒ…å†µä¸‹æ€§èƒ½æ›´ä¼˜ã€‚ ä½†ä½¿ç”¨ CAS æ–¹å¼ä¹Ÿä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼š ABAé—®é¢˜å› ä¸ºCASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™ï¼Œæ£€æŸ¥å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ¯”å¦‚æ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜æˆäº†Aï¼Œé‚£ä¹ˆä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶åˆ™ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šå´å˜åŒ–äº†ã€‚ ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·åŠ 1ï¼Œé‚£ä¹ˆA-&gt;B-&gt;Aå°±ä¼šå˜æˆ1A-&gt;2B-&gt;3Aã€‚ ä»Java 1.5å¼€å§‹ï¼ŒJDKçš„AtomicåŒ…é‡Œæä¾›äº†ä¸€ä¸ªç±»AtomicStampedReferenceæ¥è§£å†³ABAé—®é¢˜ã€‚è¿™ä¸ªç±»çš„compareAndSetæ–¹æ³•çš„ä½œç”¨æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥å½“å‰æ ‡å¿—æ˜¯å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚ å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§è‡ªæ—‹CASå¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™CPUå¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚å¦‚æœJVMèƒ½æ”¯æŒå¤„ç†å™¨æä¾›çš„pauseæŒ‡ä»¤ï¼Œé‚£ä¹ˆæ•ˆç‡ä¼šæœ‰ä¸€å®šçš„æå‡ã€‚pauseæŒ‡ä»¤æœ‰ä¸¤ä¸ªä½œç”¨ï¼šç¬¬ä¸€ï¼Œå®ƒå¯ä»¥å»¶è¿Ÿæµæ°´çº¿æ‰§è¡Œå‘½ä»¤(de-pipeline)ï¼Œä½¿CPUä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„æ‰§è¡Œèµ„æºï¼Œå»¶è¿Ÿçš„æ—¶é—´å–å†³äºå…·ä½“å®ç°çš„ç‰ˆæœ¬ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šå»¶è¿Ÿæ—¶é—´æ˜¯é›¶ï¼›ç¬¬äºŒï¼Œå®ƒå¯ä»¥é¿å…åœ¨é€€å‡ºå¾ªç¯çš„æ—¶å€™å› å†…å­˜é¡ºåºå†²çª(Memory Order Violation)è€Œå¼•èµ·CPUæµæ°´çº¿è¢«æ¸…ç©º(CPU Pipeline Flush)ï¼Œä»è€Œæé«˜CPUçš„æ‰§è¡Œæ•ˆç‡ã€‚ åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œå½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚ è¿˜æœ‰ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªå…±äº«å˜é‡i &#x3D; 2ï¼Œj &#x3D; aï¼Œåˆå¹¶ä¸€ä¸‹ij &#x3D; 2aï¼Œç„¶åç”¨CASæ¥æ“ä½œijã€‚ ä»Java 1.5å¼€å§‹ï¼ŒJDKæä¾›äº†AtomicReferenceç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œå°±å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡ŒCASæ“ä½œã€‚ UnSafeç±»è¯¦è§£ ä¸Šæ–‡æˆ‘ä»¬äº†è§£åˆ°JavaåŸå­ç±»æ˜¯é€šè¿‡UnSafeç±»å®ç°çš„ï¼Œè¿™èŠ‚ä¸»è¦åˆ†æä¸‹UnSafeç±»ã€‚UnSafeç±»åœ¨J.U.Cä¸­CASæ“ä½œæœ‰å¾ˆå¹¿æ³›çš„åº”ç”¨ã€‚ Unsafeæ˜¯ä½äºsun.miscåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦æä¾›ä¸€äº›ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºã€è‡ªä¸»ç®¡ç†å†…å­˜èµ„æºç­‰ï¼Œè¿™äº›æ–¹æ³•åœ¨æå‡Javaè¿è¡Œæ•ˆç‡ã€å¢å¼ºJavaè¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚ä½†ç”±äºUnsafeç±»ä½¿Javaè¯­è¨€æ‹¥æœ‰äº†ç±»ä¼¼Cè¯­è¨€æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼Œè¿™æ— ç–‘ä¹Ÿå¢åŠ äº†ç¨‹åºå‘ç”Ÿç›¸å…³æŒ‡é’ˆé—®é¢˜çš„é£é™©ã€‚åœ¨ç¨‹åºä¸­è¿‡åº¦ã€ä¸æ­£ç¡®ä½¿ç”¨Unsafeç±»ä¼šä½¿å¾—ç¨‹åºå‡ºé”™çš„æ¦‚ç‡å˜å¤§ï¼Œä½¿å¾—Javaè¿™ç§å®‰å…¨çš„è¯­è¨€å˜å¾—ä¸å†â€œå®‰å…¨â€ï¼Œå› æ­¤å¯¹Unsafeçš„ä½¿ç”¨ä¸€å®šè¦æ…é‡ã€‚ è¿™ä¸ªç±»å°½ç®¡é‡Œé¢çš„æ–¹æ³•éƒ½æ˜¯ public çš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åŠæ³•ä½¿ç”¨å®ƒä»¬ï¼ŒJDK API æ–‡æ¡£ä¹Ÿæ²¡æœ‰æä¾›ä»»ä½•å…³äºè¿™ä¸ªç±»çš„æ–¹æ³•çš„è§£é‡Šã€‚æ€»è€Œè¨€ä¹‹ï¼Œå¯¹äº Unsafe ç±»çš„ä½¿ç”¨éƒ½æ˜¯å—é™åˆ¶çš„ï¼Œåªæœ‰æˆä¿¡çš„ä»£ç æ‰èƒ½è·å¾—è¯¥ç±»çš„å®ä¾‹ï¼Œå½“ç„¶ JDK åº“é‡Œé¢çš„ç±»æ˜¯å¯ä»¥éšæ„ä½¿ç”¨çš„ã€‚ å…ˆæ¥çœ‹ä¸‹è¿™å¼ å›¾ï¼Œå¯¹UnSafeç±»æ€»ä½“åŠŸèƒ½ï¼š å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒUnsafeæä¾›çš„APIå¤§è‡´å¯åˆ†ä¸ºå†…å­˜æ“ä½œã€CASã€Classç›¸å…³ã€å¯¹è±¡æ“ä½œã€çº¿ç¨‹è°ƒåº¦ã€ç³»ç»Ÿä¿¡æ¯è·å–ã€å†…å­˜å±éšœã€æ•°ç»„æ“ä½œç­‰å‡ ç±»ï¼Œä¸‹é¢å°†å¯¹å…¶ç›¸å…³æ–¹æ³•å’Œåº”ç”¨åœºæ™¯è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚ Unsafeä¸CASåç¼–è¯‘å‡ºæ¥çš„ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344public final int getAndAddInt(Object paramObject, long paramLong, int paramInt) &#123; int i; do i = getIntVolatile(paramObject, paramLong); while (!compareAndSwapInt(paramObject, paramLong, i, i + paramInt)); return i; &#125; public final long getAndAddLong(Object paramObject, long paramLong1, long paramLong2) &#123; long l; do l = getLongVolatile(paramObject, paramLong1); while (!compareAndSwapLong(paramObject, paramLong1, l, l + paramLong2)); return l; &#125; public final int getAndSetInt(Object paramObject, long paramLong, int paramInt) &#123; int i; do i = getIntVolatile(paramObject, paramLong); while (!compareAndSwapInt(paramObject, paramLong, i, paramInt)); return i; &#125; public final long getAndSetLong(Object paramObject, long paramLong1, long paramLong2) &#123; long l; do l = getLongVolatile(paramObject, paramLong1); while (!compareAndSwapLong(paramObject, paramLong1, l, paramLong2)); return l; &#125; public final Object getAndSetObject(Object paramObject1, long paramLong, Object paramObject2) &#123; Object localObject; do localObject = getObjectVolatile(paramObject1, paramLong); while (!compareAndSwapObject(paramObject1, paramLong, localObject, paramObject2)); return localObject; &#125; ä»æºç ä¸­å‘ç°ï¼Œå†…éƒ¨ä½¿ç”¨è‡ªæ—‹çš„æ–¹å¼è¿›è¡ŒCASæ›´æ–°(whileå¾ªç¯è¿›è¡ŒCASæ›´æ–°ï¼Œå¦‚æœæ›´æ–°å¤±è´¥ï¼Œåˆ™å¾ªç¯å†æ¬¡é‡è¯•)ã€‚ åˆä»Unsafeç±»ä¸­å‘ç°ï¼ŒåŸå­æ“ä½œå…¶å®åªæ”¯æŒä¸‹é¢ä¸‰ä¸ªæ–¹æ³•ã€‚ 12345public final native boolean compareAndSwapObject(Object paramObject1, long paramLong, Object paramObject2, Object paramObject3);public final native boolean compareAndSwapInt(Object paramObject, long paramLong, int paramInt1, int paramInt2);public final native boolean compareAndSwapLong(Object paramObject, long paramLong1, long paramLong2, long paramLong3); æˆ‘ä»¬å‘ç°Unsafeåªæä¾›äº†3ç§CASæ–¹æ³•ï¼šcompareAndSwapObjectã€compareAndSwapIntå’ŒcompareAndSwapLongã€‚éƒ½æ˜¯nativeæ–¹æ³•ã€‚ Unsafeåº•å±‚ä¸å¦¨å†çœ‹çœ‹Unsafeçš„compareAndSwap*æ–¹æ³•æ¥å®ç°CASæ“ä½œï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œå®ç°ä½äºunsafe.cppä¸­ã€‚ 123456UNSAFE_ENTRY(jboolean, Unsafe_CompareAndSwapInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x)) UnsafeWrapper(&quot;Unsafe_CompareAndSwapInt&quot;); oop p = JNIHandles::resolve(obj); jint* addr = (jint *) index_oop_from_field_offset_long(p, offset); return (jint)(Atomic::cmpxchg(x, addr, e)) == e;UNSAFE_END å¯ä»¥çœ‹åˆ°å®ƒé€šè¿‡ Atomic::cmpxchg æ¥å®ç°æ¯”è¾ƒå’Œæ›¿æ¢æ“ä½œã€‚å…¶ä¸­å‚æ•°xæ˜¯å³å°†æ›´æ–°çš„å€¼ï¼Œå‚æ•°eæ˜¯åŸå†…å­˜çš„å€¼ã€‚ å¦‚æœæ˜¯Linuxçš„x86ï¼ŒAtomic::cmpxchgæ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š 12345678inline jint Atomic::cmpxchg (jint exchange_value, volatile jint* dest, jint compare_value) &#123; int mp = os::is_MP(); __asm__ volatile (LOCK_IF_MP(%4) &quot;cmpxchgl %1,(%3)&quot; : &quot;=a&quot; (exchange_value) : &quot;r&quot; (exchange_value), &quot;a&quot; (compare_value), &quot;r&quot; (dest), &quot;r&quot; (mp) : &quot;cc&quot;, &quot;memory&quot;); return exchange_value;&#125; è€Œwindowsçš„x86çš„å®ç°å¦‚ä¸‹ï¼š 12345678910111213141516171819inline jint Atomic::cmpxchg (jint exchange_value, volatile jint* dest, jint compare_value) &#123; int mp = os::isMP(); //åˆ¤æ–­æ˜¯å¦æ˜¯å¤šå¤„ç†å™¨ _asm &#123; mov edx, dest mov ecx, exchange_value mov eax, compare_value LOCK_IF_MP(mp) cmpxchg dword ptr [edx], ecx &#125;&#125;// Adding a lock prefix to an instruction on MP machine// VC++ doesn&#x27;t like the lock prefix to be on a single line// so we can&#x27;t insert a label after the lock prefix.// By emitting a lock prefix, we can define a label after it.#define LOCK_IF_MP(mp) __asm cmp mp, 0 \\ __asm je L0 \\ __asm _emit 0xF0 \\ __asm L0: å¦‚æœæ˜¯å¤šå¤„ç†å™¨ï¼Œä¸ºcmpxchgæŒ‡ä»¤æ·»åŠ lockå‰ç¼€ã€‚åä¹‹ï¼Œå°±çœç•¥lockå‰ç¼€(å•å¤„ç†å™¨ä¼šä¸éœ€è¦lockå‰ç¼€æä¾›çš„å†…å­˜å±éšœæ•ˆæœ)ã€‚è¿™é‡Œçš„lockå‰ç¼€å°±æ˜¯ä½¿ç”¨äº†å¤„ç†å™¨çš„æ€»çº¿é”(æœ€æ–°çš„å¤„ç†å™¨éƒ½ä½¿ç”¨ç¼“å­˜é”ä»£æ›¿æ€»çº¿é”æ¥æé«˜æ€§èƒ½)ã€‚ cmpxchg(void* ptr, int old, int new)ï¼Œå¦‚æœptrå’Œoldçš„å€¼ä¸€æ ·ï¼Œåˆ™æŠŠnewå†™åˆ°ptrå†…å­˜ï¼Œå¦åˆ™è¿”å›ptrçš„å€¼ï¼Œæ•´ä¸ªæ“ä½œæ˜¯åŸå­çš„ã€‚åœ¨Intelå¹³å°ä¸‹ï¼Œä¼šç”¨lock cmpxchgæ¥å®ç°ï¼Œä½¿ç”¨lockè§¦å‘ç¼“å­˜é”ï¼Œè¿™æ ·å¦ä¸€ä¸ªçº¿ç¨‹æƒ³è®¿é—®ptrçš„å†…å­˜ï¼Œå°±ä¼šè¢«blockä½ã€‚ Unsafeå…¶å®ƒåŠŸèƒ½Unsafe æä¾›äº†ç¡¬ä»¶çº§åˆ«çš„æ“ä½œï¼Œæ¯”å¦‚è¯´è·å–æŸä¸ªå±æ€§åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œæ¯”å¦‚è¯´ä¿®æ”¹å¯¹è±¡çš„å­—æ®µå€¼ï¼Œå³ä½¿å®ƒæ˜¯ç§æœ‰çš„ã€‚ä¸è¿‡ Java æœ¬èº«å°±æ˜¯ä¸ºäº†å±è”½åº•å±‚çš„å·®å¼‚ï¼Œå¯¹äºä¸€èˆ¬çš„å¼€å‘è€Œè¨€ä¹Ÿå¾ˆå°‘ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ã€‚ ä¸¾ä¸¤ä¸ªä¾‹å­ï¼Œæ¯”æ–¹è¯´ï¼š 1public native long staticFieldOffset(Field paramField); è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥è·å–ç»™å®šçš„ paramField çš„å†…å­˜åœ°å€åç§»é‡ï¼Œè¿™ä¸ªå€¼å¯¹äºç»™å®šçš„ field æ˜¯å”¯ä¸€çš„ä¸”æ˜¯å›ºå®šä¸å˜çš„ã€‚ å†æ¯”å¦‚è¯´ï¼š 12public native int arrayBaseOffset(Class paramClass);public native int arrayIndexScale(Class paramClass); å‰ä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è·å–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€ï¼Œåä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è·å–æ•°ç»„çš„è½¬æ¢å› å­å³æ•°ç»„ä¸­å…ƒç´ çš„å¢é‡åœ°å€çš„ã€‚ æœ€åçœ‹ä¸‰ä¸ªæ–¹æ³•ï¼š 123public native long allocateMemory(long paramLong);public native long reallocateMemory(long paramLong1, long paramLong2);public native void freeMemory(long paramLong); åˆ†åˆ«ç”¨æ¥åˆ†é…å†…å­˜ï¼Œæ‰©å……å†…å­˜å’Œé‡Šæ”¾å†…å­˜çš„ã€‚ æ›´å¤šç›¸å…³åŠŸèƒ½ï¼Œæ¨èä½ çœ‹ä¸‹è¿™ç¯‡æ–‡ç« ï¼šæ¥è‡ªç¾å›¢æŠ€æœ¯å›¢é˜Ÿï¼šJavaé­”æ³•ç±»ï¼šUnsafeåº”ç”¨è§£æåœ¨ AtomicIntegerä½¿ç”¨ä¸¾ä¾‹ä»¥ AtomicInteger ä¸ºä¾‹ï¼Œå¸¸ç”¨ APIï¼š 123456public final int get()ï¼šè·å–å½“å‰çš„å€¼public final int getAndSet(int newValue)ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼public final int getAndIncrement()ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢public final int getAndDecrement()ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡public final int getAndAdd(int delta)ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼void lazySet(int newValue): æœ€ç»ˆä¼šè®¾ç½®æˆnewValue,ä½¿ç”¨lazySetè®¾ç½®å€¼åï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚ ç›¸æ¯” Integer çš„ä¼˜åŠ¿ï¼Œå¤šçº¿ç¨‹ä¸­è®©å˜é‡è‡ªå¢ï¼š 12345678private volatile int count = 0;// è‹¥è¦çº¿ç¨‹å®‰å…¨æ‰§è¡Œæ‰§è¡Œ count++ï¼Œéœ€è¦åŠ é”public synchronized void increment() &#123; count++;&#125;public int getCount() &#123; return count;&#125; ä½¿ç”¨ AtomicInteger åï¼š 12345678private AtomicInteger count = new AtomicInteger();public void increment() &#123; count.incrementAndGet();&#125;// ä½¿ç”¨ AtomicInteger åï¼Œä¸éœ€è¦åŠ é”ï¼Œä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹å®‰å…¨public int getCount() &#123; return count.get();&#125; æºç è§£æ1234567891011121314151617181920212223242526272829public class AtomicInteger extends Number implements java.io.Serializable &#123; private static final Unsafe unsafe = Unsafe.getUnsafe(); private static final long valueOffset; static &#123; try &#123; //ç”¨äºè·å–valueå­—æ®µç›¸å¯¹å½“å‰å¯¹è±¡çš„â€œèµ·å§‹åœ°å€â€çš„åç§»é‡ valueOffset = unsafe.objectFieldOffset(AtomicInteger.class.getDeclaredField(&quot;value&quot;)); &#125; catch (Exception ex) &#123; throw new Error(ex); &#125; &#125; private volatile int value; //è¿”å›å½“å‰å€¼ public final int get() &#123; return value; &#125; //é€’å¢åŠ detla public final int getAndAdd(int delta) &#123; //ä¸‰ä¸ªå‚æ•°ï¼Œ1ã€å½“å‰çš„å®ä¾‹ 2ã€valueå®ä¾‹å˜é‡çš„åç§»é‡ 3ã€å½“å‰valueè¦åŠ ä¸Šçš„æ•°(value+delta)ã€‚ return unsafe.getAndAddInt(this, valueOffset, delta); &#125; //é€’å¢åŠ 1 public final int incrementAndGet() &#123; return unsafe.getAndAddInt(this, valueOffset, 1) + 1; &#125;...&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ° AtomicInteger åº•å±‚ç”¨çš„æ˜¯volatileçš„å˜é‡å’ŒCASæ¥è¿›è¡Œæ›´æ”¹æ•°æ®çš„ã€‚ volatileä¿è¯çº¿ç¨‹çš„å¯è§æ€§ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œå¯ä»¥ä¿è¯å…¶å®ƒçº¿ç¨‹ç«‹é©¬çœ‹åˆ°ä¿®æ”¹åçš„å€¼ CAS ä¿è¯æ•°æ®æ›´æ–°çš„åŸå­æ€§ã€‚ å»¶ä¼¸åˆ°æ‰€æœ‰åŸå­ç±»ï¼šå…±12ä¸ª JDKä¸­æä¾›äº†12ä¸ªåŸå­æ“ä½œç±»ã€‚ åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹ï¼ŒAtomicåŒ…æä¾›äº†ä»¥ä¸‹3ä¸ªç±»ã€‚ AtomicBoolean: åŸå­æ›´æ–°å¸ƒå°”ç±»å‹ã€‚ AtomicInteger: åŸå­æ›´æ–°æ•´å‹ã€‚ AtomicLong: åŸå­æ›´æ–°é•¿æ•´å‹ã€‚ ä»¥ä¸Š3ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œå¯ä»¥å‚è€ƒä¸Šé¢AtomicIntegerä¸­çš„ç›¸å…³æ–¹æ³•ã€‚ åŸå­æ›´æ–°æ•°ç»„é€šè¿‡åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ ï¼ŒAtomicåŒ…æä¾›äº†ä»¥ä¸‹çš„3ä¸ªç±»ï¼š AtomicIntegerArray: åŸå­æ›´æ–°æ•´å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚ AtomicLongArray: åŸå­æ›´æ–°é•¿æ•´å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚ AtomicReferenceArray: åŸå­æ›´æ–°å¼•ç”¨ç±»å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚ è¿™ä¸‰ä¸ªç±»çš„æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š get(int index)ï¼šè·å–ç´¢å¼•ä¸ºindexçš„å…ƒç´ å€¼ã€‚ compareAndSet(int i,E expect,E update): å¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†æ•°ç»„ä½ç½®içš„å…ƒç´ è®¾ç½®ä¸ºupdateå€¼ã€‚ ä¸¾ä¸ªAtomicIntegerArrayä¾‹å­ï¼š 12345678910import java.util.concurrent.atomic.AtomicIntegerArray;public class Demo5 &#123; public static void main(String[] args) throws InterruptedException &#123; AtomicIntegerArray array = new AtomicIntegerArray(new int[] &#123; 0, 0 &#125;); System.out.println(array); System.out.println(array.getAndAdd(1, 2)); System.out.println(array); &#125;&#125; è¾“å‡ºç»“æœï¼š 123[0, 0]0[0, 2] åŸå­æ›´æ–°å¼•ç”¨ç±»å‹AtomicåŒ…æä¾›äº†ä»¥ä¸‹ä¸‰ä¸ªç±»ï¼š AtomicReference: åŸå­æ›´æ–°å¼•ç”¨ç±»å‹ã€‚ AtomicStampedReference: åŸå­æ›´æ–°å¼•ç”¨ç±»å‹, å†…éƒ¨ä½¿ç”¨Pairæ¥å­˜å‚¨å…ƒç´ å€¼åŠå…¶ç‰ˆæœ¬å·ã€‚ AtomicMarkableReferce: åŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹ã€‚ è¿™ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•éƒ½å·®ä¸å¤šï¼Œé¦–å…ˆæ„é€ ä¸€ä¸ªå¼•ç”¨å¯¹è±¡ï¼Œç„¶åæŠŠå¼•ç”¨å¯¹è±¡setè¿›Atomicç±»ï¼Œç„¶åè°ƒç”¨compareAndSetç­‰ä¸€äº›æ–¹æ³•å»è¿›è¡ŒåŸå­æ“ä½œï¼ŒåŸç†éƒ½æ˜¯åŸºäºUnsafeå®ç°ï¼Œä½†AtomicReferenceFieldUpdaterç•¥æœ‰ä¸åŒï¼Œæ›´æ–°çš„å­—æ®µå¿…é¡»ç”¨volatileä¿®é¥°ã€‚ ä¸¾ä¸ªAtomicReferenceä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829import java.util.concurrent.atomic.AtomicReference;public class AtomicReferenceTest &#123; public static void main(String[] args)&#123; // åˆ›å»ºä¸¤ä¸ªPersonå¯¹è±¡ï¼Œå®ƒä»¬çš„idåˆ†åˆ«æ˜¯101å’Œ102ã€‚ Person p1 = new Person(101); Person p2 = new Person(102); // æ–°å»ºAtomicReferenceå¯¹è±¡ï¼Œåˆå§‹åŒ–å®ƒçš„å€¼ä¸ºp1å¯¹è±¡ AtomicReference ar = new AtomicReference(p1); // é€šè¿‡CASè®¾ç½®arã€‚å¦‚æœarçš„å€¼ä¸ºp1çš„è¯ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºp2ã€‚ ar.compareAndSet(p1, p2); Person p3 = (Person)ar.get(); System.out.println(&quot;p3 is &quot;+p3); System.out.println(&quot;p3.equals(p1)=&quot;+p3.equals(p1)); &#125;&#125;class Person &#123; volatile long id; public Person(long id) &#123; this.id = id; &#125; public String toString() &#123; return &quot;id:&quot;+id; &#125;&#125; ç»“æœè¾“å‡ºï¼š 12p3 is id:102p3.equals(p1)=false ç»“æœè¯´æ˜ï¼š æ–°å»ºAtomicReferenceå¯¹è±¡aræ—¶ï¼Œå°†å®ƒåˆå§‹åŒ–ä¸ºp1ã€‚ ç´§æ¥ç€ï¼Œé€šè¿‡CASå‡½æ•°å¯¹å®ƒè¿›è¡Œè®¾ç½®ã€‚å¦‚æœarçš„å€¼ä¸ºp1çš„è¯ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºp2ã€‚ æœ€åï¼Œè·å–arå¯¹åº”çš„å¯¹è±¡ï¼Œå¹¶æ‰“å°ç»“æœã€‚p3.equals(p1)çš„ç»“æœä¸ºfalseï¼Œè¿™æ˜¯å› ä¸ºPersonå¹¶æ²¡æœ‰è¦†ç›–equals()æ–¹æ³•ï¼Œè€Œæ˜¯é‡‡ç”¨ç»§æ‰¿è‡ªObject.javaçš„equals()æ–¹æ³•ï¼›è€ŒObject.javaä¸­çš„equals()å®é™…ä¸Šæ˜¯è°ƒç”¨â€&#x3D;&#x3D;â€å»æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡ï¼Œå³æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„åœ°å€æ˜¯å¦ç›¸ç­‰ã€‚ åŸå­æ›´æ–°å­—æ®µç±»AtomicåŒ…æä¾›äº†å››ä¸ªç±»è¿›è¡ŒåŸå­å­—æ®µæ›´æ–°ï¼š AtomicIntegerFieldUpdater: åŸå­æ›´æ–°æ•´å‹çš„å­—æ®µçš„æ›´æ–°å™¨ã€‚ AtomicLongFieldUpdater: åŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨ã€‚ AtomicReferenceFieldUpdater: ä¸Šé¢å·²ç»è¯´è¿‡æ­¤å¤„ä¸åœ¨èµ˜è¿°ã€‚ è¿™å››ä¸ªç±»çš„ä½¿ç”¨æ–¹å¼éƒ½å·®ä¸å¤šï¼Œæ˜¯åŸºäºåå°„çš„åŸå­æ›´æ–°å­—æ®µçš„å€¼ã€‚è¦æƒ³åŸå­åœ°æ›´æ–°å­—æ®µç±»éœ€è¦ä¸¤æ­¥: ç¬¬ä¸€æ­¥ï¼Œå› ä¸ºåŸå­æ›´æ–°å­—æ®µç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³•newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚ ç¬¬äºŒæ­¥ï¼Œæ›´æ–°ç±»çš„å­—æ®µå¿…é¡»ä½¿ç”¨public volatileä¿®é¥°ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243public class TestAtomicIntegerFieldUpdater &#123; public static void main(String[] args)&#123; TestAtomicIntegerFieldUpdater tIA = new TestAtomicIntegerFieldUpdater(); tIA.doIt(); &#125; public AtomicIntegerFieldUpdater&lt;DataDemo&gt; updater(String name)&#123; return AtomicIntegerFieldUpdater.newUpdater(DataDemo.class,name); &#125; public void doIt()&#123; DataDemo data = new DataDemo(); System.out.println(&quot;publicVar = &quot;+updater(&quot;publicVar&quot;).getAndAdd(data, 2)); /* * ç”±äºåœ¨DataDemoç±»ä¸­å±æ€§value2/value3,åœ¨TestAtomicIntegerFieldUpdaterä¸­ä¸èƒ½è®¿é—® * */ //System.out.println(&quot;protectedVar = &quot;+updater(&quot;protectedVar&quot;).getAndAdd(data,2)); //System.out.println(&quot;privateVar = &quot;+updater(&quot;privateVar&quot;).getAndAdd(data,2)); //System.out.println(&quot;staticVar = &quot;+updater(&quot;staticVar&quot;).getAndIncrement(data));//æŠ¥java.lang.IllegalArgumentException /* * ä¸‹é¢æŠ¥å¼‚å¸¸ï¼šmust be integer * */ //System.out.println(&quot;integerVar = &quot;+updater(&quot;integerVar&quot;).getAndIncrement(data)); //System.out.println(&quot;longVar = &quot;+updater(&quot;longVar&quot;).getAndIncrement(data)); &#125;&#125;class DataDemo&#123; public volatile int publicVar=3; protected volatile int protectedVar=4; private volatile int privateVar=5; public volatile static int staticVar = 10; //public final int finalVar = 11; public volatile Integer integerVar = 19; public volatile Long longVar = 18L;&#125; å†è¯´ä¸‹å¯¹äºAtomicIntegerFieldUpdater çš„ä½¿ç”¨ç¨å¾®æœ‰ä¸€äº›é™åˆ¶å’Œçº¦æŸï¼Œçº¦æŸå¦‚ä¸‹ï¼š å­—æ®µå¿…é¡»æ˜¯volatileç±»å‹çš„ï¼Œåœ¨çº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡æ—¶ä¿è¯ç«‹å³å¯è§.eg:volatile int value &#x3D; 3 å­—æ®µçš„æè¿°ç±»å‹(ä¿®é¥°ç¬¦public&#x2F;protected&#x2F;default&#x2F;private)æ˜¯ä¸è°ƒç”¨è€…ä¸æ“ä½œå¯¹è±¡å­—æ®µçš„å…³ç³»ä¸€è‡´ã€‚ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨è€…èƒ½å¤Ÿç›´æ¥æ“ä½œå¯¹è±¡å­—æ®µï¼Œé‚£ä¹ˆå°±å¯ä»¥åå°„è¿›è¡ŒåŸå­æ“ä½œã€‚ä½†æ˜¯å¯¹äºçˆ¶ç±»çš„å­—æ®µï¼Œå­ç±»æ˜¯ä¸èƒ½ç›´æ¥æ“ä½œçš„ï¼Œå°½ç®¡å­ç±»å¯ä»¥è®¿é—®çˆ¶ç±»çš„å­—æ®µã€‚ åªèƒ½æ˜¯å®ä¾‹å˜é‡ï¼Œä¸èƒ½æ˜¯ç±»å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åŠ staticå…³é”®å­—ã€‚ åªèƒ½æ˜¯å¯ä¿®æ”¹å˜é‡ï¼Œä¸èƒ½ä½¿finalå˜é‡ï¼Œå› ä¸ºfinalçš„è¯­ä¹‰å°±æ˜¯ä¸å¯ä¿®æ”¹ã€‚å®é™…ä¸Šfinalçš„è¯­ä¹‰å’Œvolatileæ˜¯æœ‰å†²çªçš„ï¼Œè¿™ä¸¤ä¸ªå…³é”®å­—ä¸èƒ½åŒæ—¶å­˜åœ¨ã€‚ å¯¹äºAtomicIntegerFieldUpdaterå’ŒAtomicLongFieldUpdateråªèƒ½ä¿®æ”¹int&#x2F;longç±»å‹çš„å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹å…¶åŒ…è£…ç±»å‹(Integer&#x2F;Long)ã€‚å¦‚æœè¦ä¿®æ”¹åŒ…è£…ç±»å‹å°±éœ€è¦ä½¿ç”¨AtomicReferenceFieldUpdaterã€‚ å†è®²è®²AtomicStampedReferenceè§£å†³CASçš„ABAé—®é¢˜AtomicStampedReferenceè§£å†³ABAé—®é¢˜AtomicStampedReferenceä¸»è¦ç»´æŠ¤åŒ…å«ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ä»¥åŠä¸€ä¸ªå¯ä»¥è‡ªåŠ¨æ›´æ–°çš„æ•´æ•°â€stampâ€çš„pairå¯¹è±¡æ¥è§£å†³ABAé—®é¢˜ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344public class AtomicStampedReference&lt;V&gt; &#123; private static class Pair&lt;T&gt; &#123; final T reference; //ç»´æŠ¤å¯¹è±¡å¼•ç”¨ final int stamp; //ç”¨äºæ ‡å¿—ç‰ˆæœ¬ private Pair(T reference, int stamp) &#123; this.reference = reference; this.stamp = stamp; &#125; static &lt;T&gt; Pair&lt;T&gt; of(T reference, int stamp) &#123; return new Pair&lt;T&gt;(reference, stamp); &#125; &#125; private volatile Pair&lt;V&gt; pair; .... /** * expectedReference ï¼šæ›´æ–°ä¹‹å‰çš„åŸå§‹å€¼ * newReference : å°†è¦æ›´æ–°çš„æ–°å€¼ * expectedStamp : æœŸå¾…æ›´æ–°çš„æ ‡å¿—ç‰ˆæœ¬ * newStamp : å°†è¦æ›´æ–°çš„æ ‡å¿—ç‰ˆæœ¬ */ public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) &#123; // è·å–å½“å‰çš„(å…ƒç´ å€¼ï¼Œç‰ˆæœ¬å·)å¯¹ Pair&lt;V&gt; current = pair; return // å¼•ç”¨æ²¡å˜ expectedReference == current.reference &amp;&amp; // ç‰ˆæœ¬å·æ²¡å˜ expectedStamp == current.stamp &amp;&amp; // æ–°å¼•ç”¨ç­‰äºæ—§å¼•ç”¨ ((newReference == current.reference &amp;&amp; // æ–°ç‰ˆæœ¬å·ç­‰äºæ—§ç‰ˆæœ¬å· newStamp == current.stamp) || // æ„é€ æ–°çš„Pairå¯¹è±¡å¹¶CASæ›´æ–° casPair(current, Pair.of(newReference, newStamp))); &#125; private boolean casPair(Pair&lt;V&gt; cmp, Pair&lt;V&gt; val) &#123; // è°ƒç”¨Unsafeçš„compareAndSwapObject()æ–¹æ³•CASæ›´æ–°pairçš„å¼•ç”¨ä¸ºæ–°å¼•ç”¨ return UNSAFE.compareAndSwapObject(this, pairOffset, cmp, val); &#125; å¦‚æœå…ƒç´ å€¼å’Œç‰ˆæœ¬å·éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå¹¶ä¸”å’Œæ–°çš„ä¹Ÿç›¸åŒï¼Œè¿”å›trueï¼› å¦‚æœå…ƒç´ å€¼å’Œç‰ˆæœ¬å·éƒ½æ²¡æœ‰å˜åŒ–ï¼Œå¹¶ä¸”å’Œæ–°çš„ä¸å®Œå…¨ç›¸åŒï¼Œå°±æ„é€ ä¸€ä¸ªæ–°çš„Pairå¯¹è±¡å¹¶æ‰§è¡ŒCASæ›´æ–°pairã€‚ å¯ä»¥çœ‹åˆ°ï¼Œjavaä¸­çš„å®ç°è·Ÿæˆ‘ä»¬ä¸Šé¢è®²çš„ABAçš„è§£å†³æ–¹æ³•æ˜¯ä¸€è‡´çš„ã€‚ é¦–å…ˆï¼Œä½¿ç”¨ç‰ˆæœ¬å·æ§åˆ¶ï¼› å…¶æ¬¡ï¼Œä¸é‡å¤ä½¿ç”¨èŠ‚ç‚¹(Pair)çš„å¼•ç”¨ï¼Œæ¯æ¬¡éƒ½æ–°å»ºä¸€ä¸ªæ–°çš„Pairæ¥ä½œä¸ºCASæ¯”è¾ƒçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯å¤ç”¨æ—§çš„ï¼› æœ€åï¼Œå¤–éƒ¨ä¼ å…¥å…ƒç´ å€¼åŠç‰ˆæœ¬å·ï¼Œè€Œä¸æ˜¯èŠ‚ç‚¹(Pair)çš„å¼•ç”¨ã€‚ ä½¿ç”¨ä¸¾ä¾‹12345678910111213141516171819202122232425262728293031323334public class AtomicTester &#123; private static AtomicStampedReference&lt;Integer&gt; atomicStampedRef = new AtomicStampedReference&lt;&gt;(1, 0); public static void main(String[] args)&#123; first().start(); second().start(); &#125; private static Thread first() &#123; return new Thread(() -&gt; &#123; System.out.println(&quot;æ“ä½œçº¿ç¨‹&quot; + Thread.currentThread() +&quot;,åˆå§‹å€¼ a = &quot; + atomicStampedRef.getReference()); int stamp = atomicStampedRef.getStamp(); //è·å–å½“å‰æ ‡è¯†åˆ« try &#123; Thread.sleep(1000); //ç­‰å¾…1ç§’ ï¼Œä»¥ä¾¿è®©å¹²æ‰°çº¿ç¨‹æ‰§è¡Œ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; boolean isCASSuccess = atomicStampedRef.compareAndSet(1,2,stamp,stamp +1); //æ­¤æ—¶expectedReferenceæœªå‘ç”Ÿæ”¹å˜ï¼Œä½†æ˜¯stampå·²ç»è¢«ä¿®æ”¹äº†,æ‰€ä»¥CASå¤±è´¥ System.out.println(&quot;æ“ä½œçº¿ç¨‹&quot; + Thread.currentThread() +&quot;,CASæ“ä½œç»“æœ: &quot; + isCASSuccess); &#125;,&quot;ä¸»æ“ä½œçº¿ç¨‹&quot;); &#125; private static Thread second() &#123; return new Thread(() -&gt; &#123; Thread.yield(); // ç¡®ä¿thread-first ä¼˜å…ˆæ‰§è¡Œ atomicStampedRef.compareAndSet(1,2,atomicStampedRef.getStamp(),atomicStampedRef.getStamp() +1); System.out.println(&quot;æ“ä½œçº¿ç¨‹&quot; + Thread.currentThread() +&quot;,ã€incrementã€‘ ,å€¼ = &quot;+ atomicStampedRef.getReference()); atomicStampedRef.compareAndSet(2,1,atomicStampedRef.getStamp(),atomicStampedRef.getStamp() +1); System.out.println(&quot;æ“ä½œçº¿ç¨‹&quot; + Thread.currentThread() +&quot;,ã€decrementã€‘ ,å€¼ = &quot;+ atomicStampedRef.getReference()); &#125;,&quot;å¹²æ‰°çº¿ç¨‹&quot;); &#125;&#125; è¾“å‡ºç»“æœï¼š 1234æ“ä½œçº¿ç¨‹Thread[ä¸»æ“ä½œçº¿ç¨‹,5,main],åˆå§‹å€¼ a = 1æ“ä½œçº¿ç¨‹Thread[å¹²æ‰°çº¿ç¨‹,5,main],ã€incrementã€‘ ,å€¼ = 2æ“ä½œçº¿ç¨‹Thread[å¹²æ‰°çº¿ç¨‹,5,main],ã€decrementã€‘ ,å€¼ = 1æ“ä½œçº¿ç¨‹Thread[ä¸»æ“ä½œçº¿ç¨‹,5,main],CASæ“ä½œç»“æœ: false javaä¸­è¿˜æœ‰å“ªäº›ç±»å¯ä»¥è§£å†³ABAçš„é—®é¢˜?AtomicMarkableReferenceï¼Œå®ƒä¸æ˜¯ç»´æŠ¤ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œè€Œæ˜¯ç»´æŠ¤ä¸€ä¸ªbooleanç±»å‹çš„æ ‡è®°ï¼Œæ ‡è®°å€¼æœ‰ä¿®æ”¹ï¼Œäº†è§£ä¸€ä¸‹ã€‚ å‚è€ƒæ–‡ç«  https://benjaminwhx.com/2018/05/03/%E3%80%90%E7%BB%86%E8%B0%88Java%E5%B9%B6%E5%8F%91%E3%80%91%E8%B0%88%E8%B0%88CAS/ https://www.jianshu.com/p/9a1e6940987a https://www.jianshu.com/p/a533cbb740c6 https://blog.csdn.net/qq_36236890/article/details/81914871 https://www.cnblogs.com/lodor/p/7492805.html https://blog.csdn.net/u010412719/article/details/52068888 https://www.jianshu.com/p/18dfc5fa0171 https://www.jianshu.com/p/8b227a8adbc1 https://www.jianshu.com/p/77f75b398be9 https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"8.JUC - ç±»æ±‡æ€»å’Œå­¦ä¹ æŒ‡å—","path":"/2023/12/25/8-JUC-ç±»æ±‡æ€»å’Œå­¦ä¹ æŒ‡å—/","content":"æç¤º æœ¬æ–‡å¯¹J.U.Cè¿›è¡ŒçŸ¥è¯†ä½“ç³»è§£è¯»ï¼Œåç»­çš„æ–‡ç« è¿˜é’ˆå¯¹å‡ ä¹æ‰€æœ‰çš„æ ¸å¿ƒçš„ç±»ä»¥åŠå¸¸ç”¨çš„å·¥å…·ç±»ä½œäº†è¯¦ç»†çš„è§£è¯»; å¦‚æœæ²¡æœ‰æ—¶é—´è¯¦ç»†é˜…è¯»ç›¸å…³ç« èŠ‚ï¼Œå¯ä»¥è·Ÿç€æœ¬æ–‡ç«™åœ¨ä¸€å®šçš„é«˜åº¦äº†è§£JUCä¸‹åŒ…çš„è®¾è®¡å’Œå®ç°ï¼›åŒæ—¶å¯¹é‡è¦çš„ç« èŠ‚æä¾›è·³è½¬é“¾æ¥ï¼Œæ‚¨å¯ä»¥é“¾æ¥è¿‡å»è¯¦è¯»ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ JUCæ¡†æ¶åŒ…å«å‡ ä¸ªéƒ¨åˆ†? æ¯ä¸ªéƒ¨åˆ†æœ‰å“ªäº›æ ¸å¿ƒçš„ç±»? æœ€æœ€æ ¸å¿ƒçš„ç±»æœ‰å“ªäº›? Overviewé˜…è¯»å‰ï¼Œæ¨èä½ å­¦ä¹ ä¸‹å¹¶å‘ç›¸å…³åŸºç¡€ Java å¹¶å‘ - ç†è®ºåŸºç¡€ Java å¹¶å‘ - çº¿ç¨‹åŸºç¡€ å…³é”®å­—: synchronizedè¯¦è§£ å…³é”®å­—: volatileè¯¦è§£ å…³é”®å­—: finalè¯¦è§£ æ­£å¼å­¦ä¹ æ—¶å…ˆäº†è§£äº”ä¸ªéƒ¨åˆ†ï¼š ä¸»è¦åŒ…å«: (æ³¨æ„: ä¸Šå›¾æ˜¯ç½‘ä¸Šæ‰¾çš„å›¾ï¼Œæ— æ³•è¡¨è¿°ä¸€äº›ç»§æ‰¿å…³ç³»ï¼ŒåŒæ—¶å°‘äº†éƒ¨åˆ†ç±»ï¼›ä½†æ˜¯ä¸»ä½“ä¸Šå¯ä»¥çœ‹å‡ºå…¶åˆ†ç±»å…³ç³»ä¹Ÿå¤Ÿäº†) Lockæ¡†æ¶å’ŒToolsç±»(æŠŠå›¾ä¸­è¿™ä¸¤ä¸ªæ”¾åˆ°ä¸€èµ·ç†è§£) Collections: å¹¶å‘é›†åˆ Atomic: åŸå­ç±» Executors: çº¿ç¨‹æ±  Lockæ¡†æ¶å’ŒToolsç±»ç±»ç»“æ„æ€»è§ˆ æ¥å£: Condition Conditionä¸ºæ¥å£ç±»å‹ï¼Œå®ƒå°† Object ç›‘è§†å™¨æ–¹æ³•(waitã€notify å’Œ notifyAll)åˆ†è§£æˆæˆªç„¶ä¸åŒçš„å¯¹è±¡ï¼Œä»¥ä¾¿é€šè¿‡å°†è¿™äº›å¯¹è±¡ä¸ä»»æ„ Lock å®ç°ç»„åˆä½¿ç”¨ï¼Œä¸ºæ¯ä¸ªå¯¹è±¡æä¾›å¤šä¸ªç­‰å¾… set (wait-set)ã€‚å…¶ä¸­ï¼ŒLock æ›¿ä»£äº† synchronized æ–¹æ³•å’Œè¯­å¥çš„ä½¿ç”¨ï¼ŒCondition æ›¿ä»£äº† Object ç›‘è§†å™¨æ–¹æ³•çš„ä½¿ç”¨ã€‚å¯ä»¥é€šè¿‡await(),signal()æ¥ä¼‘çœ &#x2F;å”¤é†’çº¿ç¨‹ã€‚ åœ¨JUCé”: AbstractQueuedSynchronizerè¯¦è§£ä¸­ç±»çš„å†…éƒ¨ç±»-conditionobjectç±»æœ‰å…·ä½“åˆ†æã€‚ æ¥å£: Lock Lockä¸ºæ¥å£ç±»å‹ï¼ŒLockå®ç°æä¾›äº†æ¯”ä½¿ç”¨synchronizedæ–¹æ³•å’Œè¯­å¥å¯è·å¾—çš„æ›´å¹¿æ³›çš„é”å®šæ“ä½œã€‚æ­¤å®ç°å…è®¸æ›´çµæ´»çš„ç»“æ„ï¼Œå¯ä»¥å…·æœ‰å·®åˆ«å¾ˆå¤§çš„å±æ€§ï¼Œå¯ä»¥æ”¯æŒå¤šä¸ªç›¸å…³çš„Conditionå¯¹è±¡ã€‚ æ¥å£: ReadWriteLock ReadWriteLockä¸ºæ¥å£ç±»å‹ï¼Œ ç»´æŠ¤äº†ä¸€å¯¹ç›¸å…³çš„é”ï¼Œä¸€ä¸ªç”¨äºåªè¯»æ“ä½œï¼Œå¦ä¸€ä¸ªç”¨äºå†™å…¥æ“ä½œã€‚åªè¦æ²¡æœ‰ writerï¼Œè¯»å–é”å¯ä»¥ç”±å¤šä¸ª reader çº¿ç¨‹åŒæ—¶ä¿æŒã€‚å†™å…¥é”æ˜¯ç‹¬å çš„ã€‚ æŠ½è±¡ç±»: AbstractOwnableSynchonizer AbstractOwnableSynchonizerä¸ºæŠ½è±¡ç±»ï¼Œå¯ä»¥ç”±çº¿ç¨‹ä»¥ç‹¬å æ–¹å¼æ‹¥æœ‰çš„åŒæ­¥å™¨ã€‚æ­¤ç±»ä¸ºåˆ›å»ºé”å’Œç›¸å…³åŒæ­¥å™¨(ä¼´éšç€æ‰€æœ‰æƒçš„æ¦‚å¿µ)æä¾›äº†åŸºç¡€ã€‚AbstractOwnableSynchronizer ç±»æœ¬èº«ä¸ç®¡ç†æˆ–ä½¿ç”¨æ­¤ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œå­ç±»å’Œå·¥å…·å¯ä»¥ä½¿ç”¨é€‚å½“ç»´æŠ¤çš„å€¼å¸®åŠ©æ§åˆ¶å’Œç›‘è§†è®¿é—®ä»¥åŠæä¾›è¯Šæ–­ã€‚ æŠ½è±¡ç±»(long): AbstractQueuedLongSynchronizer AbstractQueuedLongSynchronizerä¸ºæŠ½è±¡ç±»ï¼Œä»¥ long å½¢å¼ç»´æŠ¤åŒæ­¥çŠ¶æ€çš„ä¸€ä¸ª AbstractQueuedSynchronizer ç‰ˆæœ¬ã€‚æ­¤ç±»å…·æœ‰çš„ç»“æ„ã€å±æ€§å’Œæ–¹æ³•ä¸ AbstractQueuedSynchronizer å®Œå…¨ç›¸åŒï¼Œä½†æ‰€æœ‰ä¸çŠ¶æ€ç›¸å…³çš„å‚æ•°å’Œç»“æœéƒ½å®šä¹‰ä¸º long è€Œä¸æ˜¯ intã€‚å½“åˆ›å»ºéœ€è¦ 64 ä½çŠ¶æ€çš„å¤šçº§åˆ«é”å’Œå±éšœç­‰åŒæ­¥å™¨æ—¶ï¼Œæ­¤ç±»å¾ˆæœ‰ç”¨ã€‚ æ ¸å¿ƒæŠ½è±¡ç±»(int): AbstractQueuedSynchronizer AbstractQueuedSynchronizerä¸ºæŠ½è±¡ç±»ï¼Œå…¶ä¸ºå®ç°ä¾èµ–äºå…ˆè¿›å…ˆå‡º (FIFO) ç­‰å¾…é˜Ÿåˆ—çš„é˜»å¡é”å’Œç›¸å…³åŒæ­¥å™¨(ä¿¡å·é‡ã€äº‹ä»¶ï¼Œç­‰ç­‰)æä¾›ä¸€ä¸ªæ¡†æ¶ã€‚æ­¤ç±»çš„è®¾è®¡ç›®æ ‡æ˜¯æˆä¸ºä¾é å•ä¸ªåŸå­ int å€¼æ¥è¡¨ç¤ºçŠ¶æ€çš„å¤§å¤šæ•°åŒæ­¥å™¨çš„ä¸€ä¸ªæœ‰ç”¨åŸºç¡€ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCé”: AbstractQueuedSynchronizerè¯¦è§£ é”å¸¸ç”¨ç±»: LockSupport LockSupportä¸ºå¸¸ç”¨ç±»ï¼Œç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚LockSupportçš„åŠŸèƒ½å’Œâ€Threadä¸­çš„ Thread.suspend()å’ŒThread.resume()æœ‰ç‚¹ç±»ä¼¼â€ï¼ŒLockSupportä¸­çš„park() å’Œ unpark() çš„ä½œç”¨åˆ†åˆ«æ˜¯é˜»å¡çº¿ç¨‹å’Œè§£é™¤é˜»å¡çº¿ç¨‹ã€‚ä½†æ˜¯park()å’Œunpark()ä¸ä¼šé‡åˆ°â€œThread.suspend å’Œ Thread.resumeæ‰€å¯èƒ½å¼•å‘çš„æ­»é”â€é—®é¢˜ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCé”: LockSupportè¯¦è§£ é”å¸¸ç”¨ç±»: ReentrantLock ReentrantLockä¸ºå¸¸ç”¨ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„äº’æ–¥é” Lockï¼Œå®ƒå…·æœ‰ä¸ä½¿ç”¨ synchronized æ–¹æ³•å’Œè¯­å¥æ‰€è®¿é—®çš„éšå¼ç›‘è§†å™¨é”ç›¸åŒçš„ä¸€äº›åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCé”: ReentrantLockè¯¦è§£ é”å¸¸ç”¨ç±»: ReentrantReadWriteLock ReentrantReadWriteLockæ˜¯è¯»å†™é”æ¥å£ReadWriteLockçš„å®ç°ç±»ï¼Œå®ƒåŒ…æ‹¬Lockå­ç±»ReadLockå’ŒWriteLockã€‚ReadLockæ˜¯å…±äº«é”ï¼ŒWriteLockæ˜¯ç‹¬å é”ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå·¥å…·ç±»: ReentrantReadWriteLockè¯¦è§£ é”å¸¸ç”¨ç±»: StampedLock å®ƒæ˜¯java8åœ¨java.util.concurrent.locksæ–°å¢çš„ä¸€ä¸ªAPIã€‚StampedLockæ§åˆ¶é”æœ‰ä¸‰ç§æ¨¡å¼(å†™ï¼Œè¯»ï¼Œä¹è§‚è¯»)ï¼Œä¸€ä¸ªStampedLockçŠ¶æ€æ˜¯ç”±ç‰ˆæœ¬å’Œæ¨¡å¼ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼Œé”è·å–æ–¹æ³•è¿”å›ä¸€ä¸ªæ•°å­—ä½œä¸ºç¥¨æ®stampï¼Œå®ƒç”¨ç›¸åº”çš„é”çŠ¶æ€è¡¨ç¤ºå¹¶æ§åˆ¶è®¿é—®ï¼Œæ•°å­—0è¡¨ç¤ºæ²¡æœ‰å†™é”è¢«æˆæƒè®¿é—®ã€‚åœ¨è¯»é”ä¸Šåˆ†ä¸ºæ‚²è§‚é”å’Œä¹è§‚é”ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: Java 8 - StampedLockè¯¦è§£ å·¥å…·å¸¸ç”¨ç±»: CountDownLatch CountDownLatchä¸ºå¸¸ç”¨ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ï¼Œåœ¨å®Œæˆä¸€ç»„æ­£åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œä¹‹å‰ï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå·¥å…·ç±»: CountDownLatchè¯¦è§£ å·¥å…·å¸¸ç”¨ç±»: CyclicBarrier CyclicBarrierä¸ºå¸¸ç”¨ç±»ï¼Œå…¶æ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ï¼Œå®ƒå…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æŸä¸ªå…¬å…±å±éšœç‚¹ (common barrier point)ã€‚åœ¨æ¶‰åŠä¸€ç»„å›ºå®šå¤§å°çš„çº¿ç¨‹çš„ç¨‹åºä¸­ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»ä¸æ—¶åœ°äº’ç›¸ç­‰å¾…ï¼Œæ­¤æ—¶ CyclicBarrier å¾ˆæœ‰ç”¨ã€‚å› ä¸ºè¯¥ barrier åœ¨é‡Šæ”¾ç­‰å¾…çº¿ç¨‹åå¯ä»¥é‡ç”¨ï¼Œæ‰€ä»¥ç§°å®ƒä¸ºå¾ªç¯ çš„ barrierã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå·¥å…·ç±»: CyclicBarrierè¯¦è§£ å·¥å…·å¸¸ç”¨ç±»: Phaser Phaseræ˜¯JDK 7æ–°å¢çš„ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ï¼Œå®ƒå¯ä»¥å®ç°CyclicBarrierå’ŒCountDownLatchç±»ä¼¼çš„åŠŸèƒ½ï¼Œè€Œä¸”å®ƒæ”¯æŒå¯¹ä»»åŠ¡çš„åŠ¨æ€è°ƒæ•´ï¼Œå¹¶æ”¯æŒåˆ†å±‚ç»“æ„æ¥è¾¾åˆ°æ›´é«˜çš„ååé‡ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå·¥å…·ç±»: Phaserè¯¦è§£ å·¥å…·å¸¸ç”¨ç±»: Semaphore Semaphoreä¸ºå¸¸ç”¨ç±»ï¼Œå…¶æ˜¯ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ï¼Œä»æ¦‚å¿µä¸Šè®²ï¼Œä¿¡å·é‡ç»´æŠ¤äº†ä¸€ä¸ªè®¸å¯é›†ã€‚å¦‚æœ‰å¿…è¦ï¼Œåœ¨è®¸å¯å¯ç”¨å‰ä¼šé˜»å¡æ¯ä¸€ä¸ª acquire()ï¼Œç„¶åå†è·å–è¯¥è®¸å¯ã€‚æ¯ä¸ª release() æ·»åŠ ä¸€ä¸ªè®¸å¯ï¼Œä»è€Œå¯èƒ½é‡Šæ”¾ä¸€ä¸ªæ­£åœ¨é˜»å¡çš„è·å–è€…ã€‚ä½†æ˜¯ï¼Œä¸ä½¿ç”¨å®é™…çš„è®¸å¯å¯¹è±¡ï¼ŒSemaphore åªå¯¹å¯ç”¨è®¸å¯çš„å·ç è¿›è¡Œè®¡æ•°ï¼Œå¹¶é‡‡å–ç›¸åº”çš„è¡ŒåŠ¨ã€‚é€šå¸¸ç”¨äºé™åˆ¶å¯ä»¥è®¿é—®æŸäº›èµ„æº(ç‰©ç†æˆ–é€»è¾‘çš„)çš„çº¿ç¨‹æ•°ç›®ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå·¥å…·ç±»: Semaphoreè¯¦è§£ å·¥å…·å¸¸ç”¨ç±»: Exchanger Exchangeræ˜¯ç”¨äºçº¿ç¨‹åä½œçš„å·¥å…·ç±», ä¸»è¦ç”¨äºä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚å®ƒæä¾›ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œåœ¨è¿™ä¸ªåŒæ­¥ç‚¹ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯ä»¥äº¤æ¢å½¼æ­¤çš„æ•°æ®ã€‚è¿™ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡exchange()æ–¹æ³•äº¤æ¢æ•°æ®ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œexchange()æ–¹æ³•åï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œexchange()æ–¹æ³•ï¼Œå½“è¿™ä¸¤ä¸ªçº¿ç¨‹åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®äº†ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå·¥å…·ç±»: Exchangerè¯¦è§£ Collections: å¹¶å‘é›†åˆç±»ç»“æ„å…³ç³» Queue: ArrayBlockingQueue ä¸€ä¸ªç”±æ•°ç»„æ”¯æŒçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—æŒ‰ FIFO(å…ˆè¿›å…ˆå‡º)åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚é˜Ÿåˆ—çš„å¤´éƒ¨ æ˜¯åœ¨é˜Ÿåˆ—ä¸­å­˜åœ¨æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚é˜Ÿåˆ—çš„å°¾éƒ¨ æ˜¯åœ¨é˜Ÿåˆ—ä¸­å­˜åœ¨æ—¶é—´æœ€çŸ­çš„å…ƒç´ ã€‚æ–°å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œé˜Ÿåˆ—è·å–æ“ä½œåˆ™æ˜¯ä»é˜Ÿåˆ—å¤´éƒ¨å¼€å§‹è·å¾—å…ƒç´ ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå¹¶å‘é›†åˆ: BlockingQueueè¯¦è§£ Queue: LinkedBlockingQueue ä¸€ä¸ªåŸºäºå·²é“¾æ¥èŠ‚ç‚¹çš„ã€èŒƒå›´ä»»æ„çš„ blocking queueã€‚æ­¤é˜Ÿåˆ—æŒ‰ FIFO(å…ˆè¿›å…ˆå‡º)æ’åºå…ƒç´ ã€‚é˜Ÿåˆ—çš„å¤´éƒ¨ æ˜¯åœ¨é˜Ÿåˆ—ä¸­æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚é˜Ÿåˆ—çš„å°¾éƒ¨ æ˜¯åœ¨é˜Ÿåˆ—ä¸­æ—¶é—´æœ€çŸ­çš„å…ƒç´ ã€‚æ–°å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä¸”é˜Ÿåˆ—è·å–æ“ä½œä¼šè·å¾—ä½äºé˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ã€‚é“¾æ¥é˜Ÿåˆ—çš„ååé‡é€šå¸¸è¦é«˜äºåŸºäºæ•°ç»„çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•°å¹¶å‘åº”ç”¨ç¨‹åºä¸­ï¼Œå…¶å¯é¢„çŸ¥çš„æ€§èƒ½è¦ä½ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå¹¶å‘é›†åˆ: BlockingQueueè¯¦è§£ Queue: LinkedBlockingDeque ä¸€ä¸ªåŸºäºå·²é“¾æ¥èŠ‚ç‚¹çš„ã€ä»»é€‰èŒƒå›´çš„é˜»å¡åŒç«¯é˜Ÿåˆ—ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå¹¶å‘é›†åˆ: BlockingQueueè¯¦è§£ Queue: ConcurrentLinkedQueue ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§ FIFO(å…ˆè¿›å…ˆå‡º)åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚é˜Ÿåˆ—çš„å¤´éƒ¨ æ˜¯é˜Ÿåˆ—ä¸­æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚é˜Ÿåˆ—çš„å°¾éƒ¨ æ˜¯é˜Ÿåˆ—ä¸­æ—¶é—´æœ€çŸ­çš„å…ƒç´ ã€‚æ–°çš„å…ƒç´ æ’å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œé˜Ÿåˆ—è·å–æ“ä½œä»é˜Ÿåˆ—å¤´éƒ¨è·å¾—å…ƒç´ ã€‚å½“å¤šä¸ªçº¿ç¨‹å…±äº«è®¿é—®ä¸€ä¸ªå…¬å…± collection æ—¶ï¼ŒConcurrentLinkedQueue æ˜¯ä¸€ä¸ªæ°å½“çš„é€‰æ‹©ã€‚æ­¤é˜Ÿåˆ—ä¸å…è®¸ä½¿ç”¨ null å…ƒç´ ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå¹¶å‘é›†åˆ: ConcurrentLinkedQueueè¯¦è§£ Queue: ConcurrentLinkedDeque æ˜¯åŒå‘é“¾è¡¨å®ç°çš„æ— ç•Œé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—åŒæ—¶æ”¯æŒFIFOå’ŒFILOä¸¤ç§æ“ä½œæ–¹å¼ã€‚ Queue: DelayQueue å»¶æ—¶æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨Lockæœºåˆ¶å®ç°å¹¶å‘è®¿é—®ã€‚é˜Ÿåˆ—é‡Œåªå…è®¸æ”¾å¯ä»¥â€œå»¶æœŸâ€çš„å…ƒç´ ï¼Œé˜Ÿåˆ—ä¸­çš„headæ˜¯æœ€å…ˆâ€œåˆ°æœŸâ€çš„å…ƒç´ ã€‚å¦‚æœé˜Ÿé‡Œä¸­æ²¡æœ‰å…ƒç´ åˆ°â€œåˆ°æœŸâ€ï¼Œé‚£ä¹ˆå°±ç®—é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ä¹Ÿä¸èƒ½è·å–åˆ°ã€‚ Queue: PriorityBlockingQueue æ— ç•Œä¼˜å…ˆçº§é˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨Lockæœºåˆ¶å®ç°å¹¶å‘è®¿é—®ã€‚priorityQueueçš„çº¿ç¨‹å®‰å…¨ç‰ˆï¼Œä¸å…è®¸å­˜æ”¾nullå€¼ï¼Œä¾èµ–äºcomparableçš„æ’åºï¼Œä¸å…è®¸å­˜æ”¾ä¸å¯æ¯”è¾ƒçš„å¯¹è±¡ç±»å‹ã€‚ Queue: SynchronousQueue æ²¡æœ‰å®¹é‡çš„åŒæ­¥é˜Ÿåˆ—ï¼Œé€šè¿‡CASå®ç°å¹¶å‘è®¿é—®ï¼Œæ”¯æŒFIFOå’ŒFILOã€‚ Queue: LinkedTransferQueue JDK 7æ–°å¢ï¼Œå•å‘é“¾è¡¨å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œé€šè¿‡CASå®ç°å¹¶å‘è®¿é—®ï¼Œé˜Ÿåˆ—å…ƒç´ ä½¿ç”¨ FIFO(å…ˆè¿›å…ˆå‡º)æ–¹å¼ã€‚LinkedTransferQueueå¯ä»¥è¯´æ˜¯ConcurrentLinkedQueueã€SynchronousQueue(å…¬å¹³æ¨¡å¼)å’ŒLinkedBlockingQueueçš„è¶…é›†, å®ƒä¸ä»…ä»…ç»¼åˆäº†è¿™å‡ ä¸ªç±»çš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†æ›´é«˜æ•ˆçš„å®ç°ã€‚ List: CopyOnWriteArrayList ArrayList çš„ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å˜ä½“ï¼Œå…¶ä¸­æ‰€æœ‰å¯å˜æ“ä½œ(addã€set ç­‰ç­‰)éƒ½æ˜¯é€šè¿‡å¯¹åº•å±‚æ•°ç»„è¿›è¡Œä¸€æ¬¡æ–°çš„å¤åˆ¶æ¥å®ç°çš„ã€‚è¿™ä¸€èˆ¬éœ€è¦å¾ˆå¤§çš„å¼€é”€ï¼Œä½†æ˜¯å½“éå†æ“ä½œçš„æ•°é‡å¤§å¤§è¶…è¿‡å¯å˜æ“ä½œçš„æ•°é‡æ—¶ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½æ¯”å…¶ä»–æ›¿ä»£æ–¹æ³•æ›´ æœ‰æ•ˆã€‚åœ¨ä¸èƒ½æˆ–ä¸æƒ³è¿›è¡ŒåŒæ­¥éå†ï¼Œä½†åˆéœ€è¦ä»å¹¶å‘çº¿ç¨‹ä¸­æ’é™¤å†²çªæ—¶ï¼Œå®ƒä¹Ÿå¾ˆæœ‰ç”¨ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå¹¶å‘é›†åˆ: CopyOnWriteArrayListè¯¦è§£ Set: CopyOnWriteArraySet å¯¹å…¶æ‰€æœ‰æ“ä½œä½¿ç”¨å†…éƒ¨CopyOnWriteArrayListçš„Setã€‚å³å°†æ‰€æœ‰æ“ä½œè½¬å‘è‡³CopyOnWriteArayListæ¥è¿›è¡Œæ“ä½œï¼Œèƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨ã€‚åœ¨addæ—¶ï¼Œä¼šè°ƒç”¨addIfAbsentï¼Œç”±äºæ¯æ¬¡addæ—¶éƒ½è¦è¿›è¡Œæ•°ç»„éå†ï¼Œå› æ­¤æ€§èƒ½ä¼šç•¥ä½äºCopyOnWriteArrayListã€‚ Set: ConcurrentSkipListSet ä¸€ä¸ªåŸºäºConcurrentSkipListMap çš„å¯ç¼©æ”¾å¹¶å‘ NavigableSet å®ç°ã€‚set çš„å…ƒç´ å¯ä»¥æ ¹æ®å®ƒä»¬çš„è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå¯ä»¥æ ¹æ®åˆ›å»º set æ—¶æ‰€æä¾›çš„ Comparator è¿›è¡Œæ’åºï¼Œå…·ä½“å–å†³äºä½¿ç”¨çš„æ„é€ æ–¹æ³•ã€‚ Map: ConcurrentHashMap æ˜¯çº¿ç¨‹å®‰å…¨HashMapçš„ã€‚ConcurrentHashMapåœ¨JDK 7ä¹‹å‰æ˜¯é€šè¿‡Lockå’Œsegment(åˆ†æ®µé”)å®ç°ï¼ŒJDK 8 ä¹‹åæ”¹ä¸ºCAS+synchronizedæ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCå¹¶å‘é›†åˆ: ConcurrentHashMapè¯¦è§£, åŒ…å«äº†å¯¹JDK 7å’ŒJDK 8ç‰ˆæœ¬çš„æºç åˆ†æã€‚ Map: ConcurrentSkipListMap çº¿ç¨‹å®‰å…¨çš„æœ‰åºçš„å“ˆå¸Œè¡¨(ç›¸å½“äºçº¿ç¨‹å®‰å…¨çš„TreeMap);æ˜ å°„å¯ä»¥æ ¹æ®é”®çš„è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå¯ä»¥æ ¹æ®åˆ›å»ºæ˜ å°„æ—¶æ‰€æä¾›çš„ Comparator è¿›è¡Œæ’åºï¼Œå…·ä½“å–å†³äºä½¿ç”¨çš„æ„é€ æ–¹æ³•ã€‚ Atomic: åŸå­ç±»å…¶åŸºæœ¬çš„ç‰¹æ€§å°±æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œè¿™äº›ç±»çš„å®ä¾‹åŒ…å«çš„æ–¹æ³•æ—¶ï¼Œå…·æœ‰æ’ä»–æ€§ï¼Œå³å½“æŸä¸ªçº¿ç¨‹è¿›å…¥æ–¹æ³•ï¼Œæ‰§è¡Œå…¶ä¸­çš„æŒ‡ä»¤æ—¶ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ï¼Œè€Œåˆ«çš„çº¿ç¨‹å°±åƒè‡ªæ—‹é”ä¸€æ ·ï¼Œä¸€ç›´ç­‰åˆ°è¯¥æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œæ‰ç”±JVMä»ç­‰å¾…é˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªå¦ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œè¿™åªæ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„ç†è§£ã€‚å®é™…ä¸Šæ˜¯å€ŸåŠ©ç¡¬ä»¶çš„ç›¸å…³æŒ‡ä»¤æ¥å®ç°çš„ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹(æˆ–è€…è¯´åªæ˜¯åœ¨ç¡¬ä»¶çº§åˆ«ä¸Šé˜»å¡äº†)ã€‚ å¯¹CASï¼ŒUnsafeç±»ï¼Œä»¥åŠ13ä¸ªåŸå­ç±»è¯¦è§£è¯·å‚è€ƒï¼šè¯¦ç»†åˆ†æè¯·çœ‹: JUCåŸå­ç±»: CAS, Unsafeå’ŒåŸå­ç±»è¯¦è§£ åŸºç¡€ç±»å‹ï¼šAtomicBooleanï¼ŒAtomicIntegerï¼ŒAtomicLong AtomicBooleanï¼ŒAtomicIntegerï¼ŒAtomicLongæ˜¯ç±»ä¼¼çš„ï¼Œåˆ†åˆ«é’ˆå¯¹boolï¼Œintergerï¼Œlongçš„åŸå­ç±»ã€‚ æ•°ç»„ï¼šAtomicIntegerArrayï¼ŒAtomicLongArrayï¼ŒBooleanArray AtomicIntegerArrayï¼ŒAtomicLongArrayï¼ŒAtomicBooleanArrayæ˜¯æ•°ç»„åŸå­ç±»ã€‚ å¼•ç”¨ï¼šAtomicReferenceï¼ŒAtomicMarkedReferenceï¼ŒAtomicStampedReference AtomicReferenceï¼ŒAtomicMarkedReferenceï¼ŒAtomicStampedReferenceæ˜¯å¼•ç”¨ç›¸å…³çš„åŸå­ç±»ã€‚ FieldUpdaterï¼šAtomicLongFieldUpdaterï¼ŒAtomicIntegerFieldUpdaterï¼ŒAtomicReferenceFieldUpdater AtomicLongFieldUpdaterï¼ŒAtomicIntegerFieldUpdaterï¼ŒAtomicReferenceFieldUpdateræ˜¯FieldUpdateråŸå­ç±»ã€‚ Executors: çº¿ç¨‹æ± ç±»ç»“æ„å…³ç³» æ¥å£: Executor Executoræ¥å£æä¾›ä¸€ç§å°†ä»»åŠ¡æäº¤ä¸æ¯ä¸ªä»»åŠ¡å°†å¦‚ä½•è¿è¡Œçš„æœºåˆ¶(åŒ…æ‹¬çº¿ç¨‹ä½¿ç”¨çš„ç»†èŠ‚ã€è°ƒåº¦ç­‰)åˆ†ç¦»å¼€æ¥çš„æ–¹æ³•ã€‚é€šå¸¸ä½¿ç”¨ Executor è€Œä¸æ˜¯æ˜¾å¼åœ°åˆ›å»ºçº¿ç¨‹ã€‚ ExecutorService ExecutorServiceç»§æ‰¿è‡ªExecutoræ¥å£ï¼ŒExecutorServiceæä¾›äº†ç®¡ç†ç»ˆæ­¢çš„æ–¹æ³•ï¼Œä»¥åŠå¯ä¸ºè·Ÿè¸ªä¸€ä¸ªæˆ–å¤šä¸ªå¼‚æ­¥ä»»åŠ¡æ‰§è¡ŒçŠ¶å†µè€Œç”Ÿæˆ Future çš„æ–¹æ³•ã€‚ å¯ä»¥å…³é—­ ExecutorServiceï¼Œè¿™å°†å¯¼è‡´å…¶åœæ­¢æ¥å—æ–°ä»»åŠ¡ã€‚å…³é—­åï¼Œæ‰§è¡Œç¨‹åºå°†æœ€åç»ˆæ­¢ï¼Œè¿™æ—¶æ²¡æœ‰ä»»åŠ¡åœ¨æ‰§è¡Œï¼Œä¹Ÿæ²¡æœ‰ä»»åŠ¡åœ¨ç­‰å¾…æ‰§è¡Œï¼Œå¹¶ä¸”æ— æ³•æäº¤æ–°ä»»åŠ¡ã€‚ ScheduledExecutorService ScheduledExecutorServiceç»§æ‰¿è‡ªExecutorServiceæ¥å£ï¼Œå¯å®‰æ’åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œæˆ–å®šæœŸæ‰§è¡Œçš„å‘½ä»¤ã€‚ AbstractExecutorService AbstractExecutorServiceç»§æ‰¿è‡ªExecutorServiceæ¥å£ï¼Œå…¶æä¾› ExecutorService æ‰§è¡Œæ–¹æ³•çš„é»˜è®¤å®ç°ã€‚æ­¤ç±»ä½¿ç”¨ newTaskFor è¿”å›çš„ RunnableFuture å®ç° submitã€invokeAny å’Œ invokeAll æ–¹æ³•ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒRunnableFuture æ˜¯æ­¤åŒ…ä¸­æä¾›çš„ FutureTask ç±»ã€‚ FutureTask FutureTask ä¸º Future æä¾›äº†åŸºç¡€å®ç°ï¼Œå¦‚è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ(get)å’Œå–æ¶ˆä»»åŠ¡(cancel)ç­‰ã€‚å¦‚æœä»»åŠ¡å°šæœªå®Œæˆï¼Œè·å–ä»»åŠ¡æ‰§è¡Œç»“æœæ—¶å°†ä¼šé˜»å¡ã€‚ä¸€æ—¦æ‰§è¡Œç»“æŸï¼Œä»»åŠ¡å°±ä¸èƒ½è¢«é‡å¯æˆ–å–æ¶ˆ(é™¤éä½¿ç”¨runAndResetæ‰§è¡Œè®¡ç®—)ã€‚FutureTask å¸¸ç”¨æ¥å°è£… Callable å’Œ Runnableï¼Œä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚é™¤äº†ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç±»ä¹‹å¤–ï¼Œæ­¤ç±»ä¹Ÿæä¾›äº†ä¸€äº›åŠŸèƒ½æ€§å‡½æ•°ä¾›æˆ‘ä»¬åˆ›å»ºè‡ªå®šä¹‰ task ç±»ä½¿ç”¨ã€‚FutureTask çš„çº¿ç¨‹å®‰å…¨ç”±CASæ¥ä¿è¯ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCçº¿ç¨‹æ± : FutureTaskè¯¦è§£ æ ¸å¿ƒ: ThreadPoolExecutor ThreadPoolExecutorå®ç°äº†AbstractExecutorServiceæ¥å£ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª ExecutorServiceï¼Œå®ƒä½¿ç”¨å¯èƒ½çš„å‡ ä¸ªæ± çº¿ç¨‹ä¹‹ä¸€æ‰§è¡Œæ¯ä¸ªæäº¤çš„ä»»åŠ¡ï¼Œé€šå¸¸ä½¿ç”¨ Executors å·¥å‚æ–¹æ³•é…ç½®ã€‚ çº¿ç¨‹æ± å¯ä»¥è§£å†³ä¸¤ä¸ªä¸åŒé—®é¢˜: ç”±äºå‡å°‘äº†æ¯ä¸ªä»»åŠ¡è°ƒç”¨çš„å¼€é”€ï¼Œå®ƒä»¬é€šå¸¸å¯ä»¥åœ¨æ‰§è¡Œå¤§é‡å¼‚æ­¥ä»»åŠ¡æ—¶æä¾›å¢å¼ºçš„æ€§èƒ½ï¼Œå¹¶ä¸”è¿˜å¯ä»¥æä¾›ç»‘å®šå’Œç®¡ç†èµ„æº(åŒ…æ‹¬æ‰§è¡Œä»»åŠ¡é›†æ—¶ä½¿ç”¨çš„çº¿ç¨‹)çš„æ–¹æ³•ã€‚æ¯ä¸ª ThreadPoolExecutor è¿˜ç»´æŠ¤ç€ä¸€äº›åŸºæœ¬çš„ç»Ÿè®¡æ•°æ®ï¼Œå¦‚å®Œæˆçš„ä»»åŠ¡æ•°ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCçº¿ç¨‹æ± : ThreadPoolExecutorè¯¦è§£ æ ¸å¿ƒ: ScheduledThreadExecutor ScheduledThreadPoolExecutorå®ç°ScheduledExecutorServiceæ¥å£ï¼Œå¯å®‰æ’åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œå‘½ä»¤ï¼Œæˆ–è€…å®šæœŸæ‰§è¡Œå‘½ä»¤ã€‚éœ€è¦å¤šä¸ªè¾…åŠ©çº¿ç¨‹æ—¶ï¼Œæˆ–è€…è¦æ±‚ ThreadPoolExecutor å…·æœ‰é¢å¤–çš„çµæ´»æ€§æˆ–åŠŸèƒ½æ—¶ï¼Œæ­¤ç±»è¦ä¼˜äº Timerã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCçº¿ç¨‹æ± : ScheduledThreadExecutorè¯¦è§£ æ ¸å¿ƒ: Fork&#x2F;Joinæ¡†æ¶ ForkJoinPool æ˜¯JDK 7åŠ å…¥çš„ä¸€ä¸ªçº¿ç¨‹æ± ç±»ã€‚Fork&#x2F;Join æŠ€æœ¯æ˜¯åˆ†æ²»ç®—æ³•(Divide-and-Conquer)çš„å¹¶è¡Œå®ç°ï¼Œå®ƒæ˜¯ä¸€é¡¹å¯ä»¥è·å¾—è‰¯å¥½çš„å¹¶è¡Œæ€§èƒ½çš„ç®€å•ä¸”é«˜æ•ˆçš„è®¾è®¡æŠ€æœ¯ã€‚ç›®çš„æ˜¯ä¸ºäº†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°åˆ©ç”¨å¤šå¤„ç†å™¨å¸¦æ¥çš„å¥½å¤„ï¼Œä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„è¿ç®—èƒ½åŠ›æ¥æå‡åº”ç”¨çš„æ€§èƒ½ã€‚ è¯¦ç»†åˆ†æè¯·çœ‹: JUCçº¿ç¨‹æ± : Fork&#x2F;Joinæ¡†æ¶è¯¦è§£ å·¥å…·ç±»: Executors Executorsæ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨å…¶å¯ä»¥åˆ›å»ºExecutorServiceã€ScheduledExecutorServiceã€ThreadFactoryã€Callableç­‰å¯¹è±¡ã€‚å®ƒçš„ä½¿ç”¨èå…¥åˆ°äº†ThreadPoolExecutor, ScheduledThreadExecutorå’ŒForkJoinPoolä¸­ã€‚ å‚è€ƒæ–‡ç«  https://www.cnblogs.com/leesf456/p/5344133.html https://www.cnblogs.com/leesf456/p/5428630.html https://www.cnblogs.com/leesf456/p/5550043.html https://www.jianshu.com/p/8cb5d816cb69 æ³°è¿ªçš„bagwell https://www.jianshu.com/p/af9c0f404a93","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘","JUC"]},{"title":"7.å…³é”®å­—: finalè¯¦è§£","path":"/2023/12/25/7-å…³é”®å­—-finalè¯¦è§£/","content":"final å…³é”®å­—çœ‹ä¸Šå»ç®€å•ï¼Œä½†æ˜¯çœŸæ­£æ·±å…¥ç†è§£çš„äººå¯ä»¥è¯´å°‘ä¹‹åˆå°‘ï¼Œè¯»å®Œæœ¬æ–‡ä½ å°±çŸ¥é“æˆ‘åœ¨è¯´ä»€ä¹ˆäº†ã€‚æœ¬æ–‡å°†å¸¸è§„çš„ç”¨æ³•ç®€åŒ–ï¼Œæå‡ºä¸€äº›ç”¨æ³•å’Œæ·±å…¥çš„æ€è€ƒã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£final æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£finalã€‚ æ‰€æœ‰çš„finalä¿®é¥°çš„å­—æ®µéƒ½æ˜¯ç¼–è¯‘æœŸå¸¸é‡å—? å¦‚ä½•ç†è§£privateæ‰€ä¿®é¥°çš„æ–¹æ³•æ˜¯éšå¼çš„final? è¯´è¯´finalç±»å‹çš„ç±»å¦‚ä½•æ‹“å±•? æ¯”å¦‚Stringæ˜¯finalç±»å‹ï¼Œæˆ‘ä»¬æƒ³å†™ä¸ªMyStringå¤ç”¨æ‰€æœ‰Stringä¸­æ–¹æ³•ï¼ŒåŒæ—¶å¢åŠ ä¸€ä¸ªæ–°çš„toMyString()çš„æ–¹æ³•ï¼Œåº”è¯¥å¦‚ä½•åš? finalæ–¹æ³•å¯ä»¥è¢«é‡è½½å—? å¯ä»¥ çˆ¶ç±»çš„finalæ–¹æ³•èƒ½ä¸èƒ½å¤Ÿè¢«å­ç±»é‡å†™? ä¸å¯ä»¥ è¯´è¯´finalåŸŸé‡æ’åºè§„åˆ™? è¯´è¯´finalçš„åŸç†? ä½¿ç”¨ final çš„é™åˆ¶æ¡ä»¶å’Œå±€é™æ€§? çœ‹æœ¬æ–‡æœ€åçš„ä¸€ä¸ªæ€è€ƒé¢˜ finalåŸºç¡€ä½¿ç”¨ä¿®é¥°ç±»å½“æŸä¸ªç±»çš„æ•´ä½“å®šä¹‰ä¸ºfinalæ—¶ï¼Œå°±è¡¨æ˜äº†ä½ ä¸èƒ½æ‰“ç®—ç»§æ‰¿è¯¥ç±»ï¼Œè€Œä¸”ä¹Ÿä¸å…è®¸åˆ«äººè¿™ä¹ˆåšã€‚å³è¿™ä¸ªç±»æ˜¯ä¸èƒ½æœ‰å­ç±»çš„ã€‚ æ³¨æ„ï¼šfinalç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½éšå¼ä¸ºfinalï¼Œå› ä¸ºæ— æ³•è¦†ç›–ä»–ä»¬ï¼Œæ‰€ä»¥åœ¨finalç±»ä¸­ç»™ä»»ä½•æ–¹æ³•æ·»åŠ finalå…³é”®å­—æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ã€‚ è¿™é‡Œé¡ºé“è¯´è¯´finalç±»å‹çš„ç±»å¦‚ä½•æ‹“å±•? æ¯”å¦‚Stringæ˜¯finalç±»å‹ï¼Œæˆ‘ä»¬æƒ³å†™ä¸ªMyStringå¤ç”¨æ‰€æœ‰Stringä¸­æ–¹æ³•ï¼ŒåŒæ—¶å¢åŠ ä¸€ä¸ªæ–°çš„toMyString()çš„æ–¹æ³•ï¼Œåº”è¯¥å¦‚ä½•åš? @pdai è®¾è®¡æ¨¡å¼ä¸­æœ€é‡è¦çš„ä¸¤ç§å…³ç³»ï¼Œä¸€ç§æ˜¯ç»§æ‰¿&#x2F;å®ç°ï¼›å¦å¤–ä¸€ç§æ˜¯ç»„åˆå…³ç³»ã€‚æ‰€ä»¥å½“é‡åˆ°ä¸èƒ½ç”¨ç»§æ‰¿çš„(finalä¿®é¥°çš„ç±»),åº”è¯¥è€ƒè™‘ç”¨ç»„åˆ, å¦‚ä¸‹ä»£ç å¤§æ¦‚å†™ä¸ªç»„åˆå®ç°çš„æ„æ€ï¼š 12345678910111213141516171819/*** @pdai*/class MyString&#123; private String innerString; // ...init &amp; other methods // æ”¯æŒè€çš„æ–¹æ³• public int length()&#123; return innerString.length(); // é€šè¿‡innerStringè°ƒç”¨è€çš„æ–¹æ³• &#125; // æ·»åŠ æ–°æ–¹æ³• public String toMyString()&#123; //... &#125;&#125; ä¿®é¥°æ–¹æ³• å¸¸è§„çš„ä½¿ç”¨å°±ä¸è¯´äº†ï¼Œè¿™é‡Œè¯´ä¸‹: private æ–¹æ³•æ˜¯éšå¼çš„final finalæ–¹æ³•æ˜¯å¯ä»¥è¢«é‡è½½çš„ private finalç±»ä¸­æ‰€æœ‰privateæ–¹æ³•éƒ½éšå¼åœ°æŒ‡å®šä¸ºfinalçš„ï¼Œç”±äºæ— æ³•å–ç”¨privateæ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸èƒ½è¦†ç›–å®ƒã€‚å¯ä»¥å¯¹privateæ–¹æ³•å¢æ·»finalå…³é”®å­—ï¼Œä½†è¿™æ ·åšå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½å¤„ã€‚çœ‹ä¸‹ä¸‹é¢çš„ä¾‹å­ï¼š 1234567891011121314public class Base &#123; private void test() &#123; &#125;&#125;public class Son extends Base&#123; public void test() &#123; &#125; public static void main(String[] args) &#123; Son son = new Son(); Base father = son; //father.test(); &#125;&#125; Baseå’ŒSonéƒ½æœ‰æ–¹æ³•test(),ä½†æ˜¯è¿™å¹¶ä¸æ˜¯ä¸€ç§è¦†ç›–ï¼Œå› ä¸ºprivateæ‰€ä¿®é¥°çš„æ–¹æ³•æ˜¯éšå¼çš„finalï¼Œä¹Ÿå°±æ˜¯æ— æ³•è¢«ç»§æ‰¿ï¼Œæ‰€ä»¥æ›´ä¸ç”¨è¯´æ˜¯è¦†ç›–äº†ï¼Œåœ¨Sonä¸­çš„test()æ–¹æ³•ä¸è¿‡æ˜¯å±äºSonçš„æ–°æˆå‘˜ç½¢äº†ï¼ŒSonè¿›è¡Œå‘ä¸Šè½¬å‹å¾—åˆ°fatherï¼Œä½†æ˜¯father.test()æ˜¯ä¸å¯æ‰§è¡Œçš„ï¼Œå› ä¸ºBaseä¸­çš„testæ–¹æ³•æ˜¯privateçš„ï¼Œæ— æ³•è¢«è®¿é—®åˆ°ã€‚ finalæ–¹æ³•æ˜¯å¯ä»¥è¢«é‡è½½çš„æˆ‘ä»¬çŸ¥é“çˆ¶ç±»çš„finalæ–¹æ³•æ˜¯ä¸èƒ½å¤Ÿè¢«å­ç±»é‡å†™çš„ï¼Œé‚£ä¹ˆfinalæ–¹æ³•å¯ä»¥è¢«é‡è½½å—? ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä¸‹é¢ä»£ç æ˜¯æ­£ç¡®çš„ã€‚ 1234567public class FinalExampleParent &#123; public final void test() &#123; &#125; public final void test(String str) &#123; &#125;&#125; ä¿®é¥°å‚æ•°Javaå…è®¸åœ¨å‚æ•°åˆ—è¡¨ä¸­ä»¥å£°æ˜çš„æ–¹å¼å°†å‚æ•°æŒ‡æ˜ä¸ºfinalï¼Œè¿™æ„å‘³è¿™ä½ æ— æ³•åœ¨æ–¹æ³•ä¸­æ›´æ”¹å‚æ•°å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚è¿™ä¸ªç‰¹æ€§ä¸»è¦ç”¨æ¥å‘åŒ¿åå†…éƒ¨ç±»ä¼ é€’æ•°æ®ã€‚ ä¿®é¥°å˜é‡ å¸¸è§„çš„ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œé€šè¿‡ä¸‹é¢ä¸‰ä¸ªé—®é¢˜è¿›ä¸€æ­¥è¯´æ˜ã€‚ æ‰€æœ‰çš„finalä¿®é¥°çš„å­—æ®µéƒ½æ˜¯ç¼–è¯‘æœŸå¸¸é‡å—?ç°åœ¨æ¥çœ‹ç¼–è¯‘æœŸå¸¸é‡å’Œéç¼–è¯‘æœŸå¸¸é‡, å¦‚ï¼š 12345678910111213public class Test &#123; //ç¼–è¯‘æœŸå¸¸é‡ final int i = 1; final static int J = 1; final int[] a = &#123;1,2,3,4&#125;; //éç¼–è¯‘æœŸå¸¸é‡ Random r = new Random(); final int k = r.nextInt(); public static void main(String[] args) &#123; &#125;&#125; kçš„å€¼ç”±éšæœºæ•°å¯¹è±¡å†³å®šï¼Œæ‰€ä»¥ä¸æ˜¯æ‰€æœ‰çš„finalä¿®é¥°çš„å­—æ®µéƒ½æ˜¯ç¼–è¯‘æœŸå¸¸é‡ï¼Œåªæ˜¯kçš„å€¼åœ¨è¢«åˆå§‹åŒ–åæ— æ³•è¢«æ›´æ”¹ã€‚ static finalä¸€ä¸ªæ—¢æ˜¯staticåˆæ˜¯final çš„å­—æ®µåªå æ®ä¸€æ®µä¸èƒ½æ”¹å˜çš„å­˜å‚¨ç©ºé—´ï¼Œå®ƒå¿…é¡»åœ¨å®šä¹‰çš„æ—¶å€™è¿›è¡Œèµ‹å€¼ï¼Œå¦åˆ™ç¼–è¯‘å™¨å°†ä¸äºˆé€šè¿‡ã€‚ 123456789101112import java.util.Random;public class Test &#123; static Random r = new Random(); final int k = r.nextInt(10); static final int k2 = r.nextInt(10); public static void main(String[] args) &#123; Test t1 = new Test(); System.out.println(&quot;k=&quot;+t1.k+&quot; k2=&quot;+t1.k2); Test t2 = new Test(); System.out.println(&quot;k=&quot;+t2.k+&quot; k2=&quot;+t2.k2); &#125;&#125; ä¸Šé¢ä»£ç æŸæ¬¡è¾“å‡ºç»“æœï¼š 12k=2 k2=7k=8 k2=7 æˆ‘ä»¬å¯ä»¥å‘ç°å¯¹äºä¸åŒçš„å¯¹è±¡kçš„å€¼æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯k2çš„å€¼å´æ˜¯ç›¸åŒçš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢? å› ä¸ºstaticå…³é”®å­—æ‰€ä¿®é¥°çš„å­—æ®µå¹¶ä¸å±äºä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯å±äºè¿™ä¸ªç±»çš„ã€‚ä¹Ÿå¯ç®€å•çš„ç†è§£ä¸ºstatic finalæ‰€ä¿®é¥°çš„å­—æ®µä»…å æ®å†…å­˜çš„ä¸€ä¸ªä¸€ä»½ç©ºé—´ï¼Œä¸€æ—¦è¢«åˆå§‹åŒ–ä¹‹åä¾¿ä¸ä¼šè¢«æ›´æ”¹ã€‚ blank finalJavaå…è®¸ç”Ÿæˆç©ºç™½finalï¼Œä¹Ÿå°±æ˜¯è¯´è¢«å£°æ˜ä¸ºfinalä½†åˆæ²¡æœ‰ç»™å‡ºå®šå€¼çš„å­—æ®µ,ä½†æ˜¯å¿…é¡»åœ¨è¯¥å­—æ®µè¢«ä½¿ç”¨ä¹‹å‰è¢«èµ‹å€¼ï¼Œè¿™ç»™äºˆæˆ‘ä»¬ä¸¤ç§é€‰æ‹©ï¼š åœ¨å®šä¹‰å¤„è¿›è¡Œèµ‹å€¼(è¿™ä¸å«ç©ºç™½final) åœ¨æ„é€ å™¨ä¸­è¿›è¡Œèµ‹å€¼ï¼Œä¿è¯äº†è¯¥å€¼åœ¨è¢«ä½¿ç”¨å‰èµ‹å€¼ã€‚ è¿™å¢å¼ºäº†finalçš„çµæ´»æ€§ã€‚ çœ‹ä¸‹é¢ä»£ç : 12345678910public class Test &#123; final int i1 = 1; final int i2;//ç©ºç™½final public Test() &#123; i2 = 1; &#125; public Test(int x) &#123; this.i2 = x; &#125;&#125; å¯ä»¥çœ‹åˆ°i2çš„èµ‹å€¼æ›´ä¸ºçµæ´»ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œå¦‚æœå­—æ®µç”±staticå’Œfinalä¿®é¥°ï¼Œä»…èƒ½åœ¨å£°æ˜æ—¶èµ‹å€¼æˆ–å£°æ˜ååœ¨é™æ€ä»£ç å—ä¸­èµ‹å€¼ï¼Œå› ä¸ºè¯¥å­—æ®µä¸å±äºå¯¹è±¡ï¼Œå±äºè¿™ä¸ªç±»ã€‚ finalåŸŸé‡æ’åºè§„åˆ™ä¸Šé¢æˆ‘ä»¬èŠçš„finalä½¿ç”¨ï¼Œåº”è¯¥å±äºJavaåŸºç¡€å±‚é¢çš„ï¼Œå½“ç†è§£è¿™äº›åæˆ‘ä»¬å°±çœŸçš„ç®—æ˜¯æŒæ¡äº†finalå—? æœ‰è€ƒè™‘è¿‡finalåœ¨å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µå—? åœ¨javaå†…å­˜æ¨¡å‹ä¸­æˆ‘ä»¬çŸ¥é“javaå†…å­˜æ¨¡å‹ä¸ºäº†èƒ½è®©å¤„ç†å™¨å’Œç¼–è¯‘å™¨åº•å±‚å‘æŒ¥ä»–ä»¬çš„æœ€å¤§ä¼˜åŠ¿ï¼Œå¯¹åº•å±‚çš„çº¦æŸå°±å¾ˆå°‘ï¼Œä¹Ÿå°±æ˜¯è¯´é’ˆå¯¹åº•å±‚æ¥è¯´javaå†…å­˜æ¨¡å‹å°±æ˜¯ä¸€å¼±å†…å­˜æ•°æ®æ¨¡å‹ã€‚åŒæ—¶ï¼Œå¤„ç†å™¨å’Œç¼–è¯‘ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ä¼šå¯¹æŒ‡ä»¤åºåˆ—æœ‰ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚é‚£ä¹ˆï¼Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹,finalä¼šè¿›è¡Œæ€æ ·çš„é‡æ’åº? ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨çš„é—®é¢˜å—? ä¸‹é¢ï¼Œå°±æ¥çœ‹çœ‹finalçš„é‡æ’åºã€‚ finalåŸŸä¸ºåŸºæœ¬ç±»å‹å…ˆçœ‹ä¸€æ®µç¤ºä¾‹æ€§çš„ä»£ç ï¼š 1234567891011121314151617181920public class FinalDemo &#123; private int a; //æ™®é€šåŸŸ private final int b; //finalåŸŸ private static FinalDemo finalDemo; public FinalDemo() &#123; a = 1; // 1. å†™æ™®é€šåŸŸ b = 2; // 2. å†™finalåŸŸ &#125; public static void writer() &#123; finalDemo = new FinalDemo(); &#125; public static void reader() &#123; FinalDemo demo = finalDemo; // 3.è¯»å¯¹è±¡å¼•ç”¨ int a = demo.a; //4.è¯»æ™®é€šåŸŸ int b = demo.b; //5.è¯»finalåŸŸ &#125;&#125; å‡è®¾çº¿ç¨‹Aåœ¨æ‰§è¡Œwriter()æ–¹æ³•ï¼Œçº¿ç¨‹Bæ‰§è¡Œreader()æ–¹æ³•ã€‚ å†™finalåŸŸé‡æ’åºè§„åˆ™å†™finalåŸŸçš„é‡æ’åºè§„åˆ™ç¦æ­¢å¯¹finalåŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ï¼Œè¿™ä¸ªè§„åˆ™çš„å®ç°ä¸»è¦åŒ…å«äº†ä¸¤ä¸ªæ–¹é¢ï¼š JMMç¦æ­¢ç¼–è¯‘å™¨æŠŠfinalåŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ï¼› ç¼–è¯‘å™¨ä¼šåœ¨finalåŸŸå†™ä¹‹åï¼Œæ„é€ å‡½æ•°returnä¹‹å‰ï¼Œæ’å…¥ä¸€ä¸ªstorestoreå±éšœã€‚è¿™ä¸ªå±éšœå¯ä»¥ç¦æ­¢å¤„ç†å™¨æŠŠfinalåŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚ æˆ‘ä»¬å†æ¥åˆ†æwriteræ–¹æ³•ï¼Œè™½ç„¶åªæœ‰ä¸€è¡Œä»£ç ï¼Œä½†å®é™…ä¸Šåšäº†ä¸¤ä»¶äº‹æƒ…ï¼š æ„é€ äº†ä¸€ä¸ªFinalDemoå¯¹è±¡ï¼› æŠŠè¿™ä¸ªå¯¹è±¡èµ‹å€¼ç»™æˆå‘˜å˜é‡finalDemoã€‚ æˆ‘ä»¬æ¥ç”»ä¸‹å­˜åœ¨çš„ä¸€ç§å¯èƒ½æ‰§è¡Œæ—¶åºå›¾ï¼Œå¦‚ä¸‹ï¼š ç”±äºa,bä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–æ€§ï¼Œæ™®é€šåŸŸ(æ™®é€šå˜é‡)aå¯èƒ½ä¼šè¢«é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ï¼Œçº¿ç¨‹Bå°±æœ‰å¯èƒ½è¯»åˆ°çš„æ˜¯æ™®é€šå˜é‡aåˆå§‹åŒ–ä¹‹å‰çš„å€¼(é›¶å€¼)ï¼Œè¿™æ ·å°±å¯èƒ½å‡ºç°é”™è¯¯ã€‚è€ŒfinalåŸŸå˜é‡bï¼Œæ ¹æ®é‡æ’åºè§„åˆ™ï¼Œä¼šç¦æ­¢finalä¿®é¥°çš„å˜é‡bé‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ï¼Œä»è€Œbèƒ½å¤Ÿæ­£ç¡®èµ‹å€¼ï¼Œçº¿ç¨‹Bå°±èƒ½å¤Ÿè¯»åˆ°finalå˜é‡åˆå§‹åŒ–åçš„å€¼ã€‚ å› æ­¤ï¼Œå†™finalåŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨å¯¹è±¡å¼•ç”¨ä¸ºä»»æ„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œå¯¹è±¡çš„finalåŸŸå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–è¿‡äº†ï¼Œè€Œæ™®é€šåŸŸå°±ä¸å…·æœ‰è¿™ä¸ªä¿éšœã€‚æ¯”å¦‚åœ¨ä¸Šä¾‹ï¼Œçº¿ç¨‹Bæœ‰å¯èƒ½å°±æ˜¯ä¸€ä¸ªæœªæ­£ç¡®åˆå§‹åŒ–çš„å¯¹è±¡finalDemoã€‚ è¯»finalåŸŸé‡æ’åºè§„åˆ™è¯»finalåŸŸé‡æ’åºè§„åˆ™ä¸ºï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œåˆæ¬¡è¯»å¯¹è±¡å¼•ç”¨å’Œåˆæ¬¡è¯»è¯¥å¯¹è±¡åŒ…å«çš„finalåŸŸï¼ŒJMMä¼šç¦æ­¢è¿™ä¸¤ä¸ªæ“ä½œçš„é‡æ’åºã€‚(æ³¨æ„ï¼Œè¿™ä¸ªè§„åˆ™ä»…ä»…æ˜¯é’ˆå¯¹å¤„ç†å™¨)ï¼Œå¤„ç†å™¨ä¼šåœ¨è¯»finalåŸŸæ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœã€‚å®é™…ä¸Šï¼Œè¯»å¯¹è±¡çš„å¼•ç”¨å’Œè¯»è¯¥å¯¹è±¡çš„finalåŸŸå­˜åœ¨é—´æ¥ä¾èµ–æ€§ï¼Œä¸€èˆ¬å¤„ç†å™¨ä¸ä¼šé‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚ä½†æ˜¯æœ‰ä¸€äº›å¤„ç†å™¨ä¼šé‡æ’åºï¼Œå› æ­¤ï¼Œè¿™æ¡ç¦æ­¢é‡æ’åºè§„åˆ™å°±æ˜¯é’ˆå¯¹è¿™äº›å¤„ç†å™¨è€Œè®¾å®šçš„ã€‚ read()æ–¹æ³•ä¸»è¦åŒ…å«äº†ä¸‰ä¸ªæ“ä½œï¼š åˆæ¬¡è¯»å¼•ç”¨å˜é‡finalDemo; åˆæ¬¡è¯»å¼•ç”¨å˜é‡finalDemoçš„æ™®é€šåŸŸa; åˆæ¬¡è¯»å¼•ç”¨å˜é‡finalDemoçš„finalåŸŸb; å‡è®¾çº¿ç¨‹Aå†™è¿‡ç¨‹æ²¡æœ‰é‡æ’åºï¼Œé‚£ä¹ˆçº¿ç¨‹Aå’Œçº¿ç¨‹Bæœ‰ä¸€ç§çš„å¯èƒ½æ‰§è¡Œæ—¶åºä¸ºä¸‹å›¾ï¼š è¯»å¯¹è±¡çš„æ™®é€šåŸŸè¢«é‡æ’åºåˆ°äº†è¯»å¯¹è±¡å¼•ç”¨çš„å‰é¢å°±ä¼šå‡ºç°çº¿ç¨‹Bè¿˜æœªè¯»åˆ°å¯¹è±¡å¼•ç”¨å°±åœ¨è¯»å–è¯¥å¯¹è±¡çš„æ™®é€šåŸŸå˜é‡ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„æ“ä½œã€‚è€ŒfinalåŸŸçš„è¯»æ“ä½œå°±â€œé™å®šâ€äº†åœ¨è¯»finalåŸŸå˜é‡å‰å·²ç»è¯»åˆ°äº†è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œä»è€Œå°±å¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚ è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨è¯»ä¸€ä¸ªå¯¹è±¡çš„finalåŸŸä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆè¯»è¿™ä¸ªåŒ…å«è¿™ä¸ªfinalåŸŸçš„å¯¹è±¡çš„å¼•ç”¨ã€‚ finalåŸŸä¸ºå¼•ç”¨ç±»å‹æˆ‘ä»¬å·²ç»çŸ¥é“äº†finalåŸŸæ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„æ—¶å€™é‡æ’åºè§„åˆ™æ˜¯æ€ä¹ˆçš„äº†? å¦‚æœæ˜¯å¼•ç”¨æ•°æ®ç±»å‹äº†? æˆ‘ä»¬æ¥ç€ç»§ç»­æ¥æ¢è®¨ã€‚ å¯¹finalä¿®é¥°çš„å¯¹è±¡çš„æˆå‘˜åŸŸå†™æ“ä½œé’ˆå¯¹å¼•ç”¨æ•°æ®ç±»å‹ï¼ŒfinalåŸŸå†™é’ˆå¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºå¢åŠ äº†è¿™æ ·çš„çº¦æŸï¼šåœ¨æ„é€ å‡½æ•°å†…å¯¹ä¸€ä¸ªfinalä¿®é¥°çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ï¼Œä¸éšååœ¨æ„é€ å‡½æ•°ä¹‹å¤–æŠŠè¿™ä¸ªè¢«æ„é€ çš„å¯¹è±¡çš„å¼•ç”¨èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸èƒ½è¢«é‡æ’åºçš„ã€‚æ³¨æ„è¿™é‡Œçš„æ˜¯â€œå¢åŠ â€ä¹Ÿå°±è¯´å‰é¢å¯¹finalåŸºæœ¬æ•°æ®ç±»å‹çš„é‡æ’åºè§„åˆ™åœ¨è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨ã€‚è¿™å¥è¯æ˜¯æ¯”è¾ƒæ‹—å£çš„ï¼Œä¸‹é¢ç»“åˆå®ä¾‹æ¥çœ‹ã€‚ 1234567891011121314151617181920212223public class FinalReferenceDemo &#123; final int[] arrays; private FinalReferenceDemo finalReferenceDemo; public FinalReferenceDemo() &#123; arrays = new int[1]; //1 arrays[0] = 1; //2 &#125; public void writerOne() &#123; finalReferenceDemo = new FinalReferenceDemo(); //3 &#125; public void writerTwo() &#123; arrays[0] = 2; //4 &#125; public void reader() &#123; if (finalReferenceDemo != null) &#123; //5 int temp = finalReferenceDemo.arrays[0]; //6 &#125; &#125;&#125; é’ˆå¯¹ä¸Šé¢çš„å®ä¾‹ç¨‹åºï¼Œçº¿ç¨‹çº¿ç¨‹Aæ‰§è¡ŒwirterOneæ–¹æ³•ï¼Œæ‰§è¡Œå®Œåçº¿ç¨‹Bæ‰§è¡ŒwriterTwoæ–¹æ³•ï¼Œç„¶åçº¿ç¨‹Cæ‰§è¡Œreaderæ–¹æ³•ã€‚ä¸‹å›¾å°±ä»¥è¿™ç§æ‰§è¡Œæ—¶åºå‡ºç°çš„ä¸€ç§æƒ…å†µæ¥è®¨è®º(è€å¿ƒçœ‹å®Œæ‰æœ‰æ”¶è·)ã€‚ ç”±äºå¯¹finalåŸŸçš„å†™ç¦æ­¢é‡æ’åºåˆ°æ„é€ æ–¹æ³•å¤–ï¼Œå› æ­¤1å’Œ3ä¸èƒ½è¢«é‡æ’åºã€‚ç”±äºä¸€ä¸ªfinalåŸŸçš„å¼•ç”¨å¯¹è±¡çš„æˆå‘˜åŸŸå†™å…¥ä¸èƒ½ä¸éšåå°†è¿™ä¸ªè¢«æ„é€ å‡ºæ¥çš„å¯¹è±¡èµ‹ç»™å¼•ç”¨å˜é‡é‡æ’åºï¼Œå› æ­¤2å’Œ3ä¸èƒ½é‡æ’åºã€‚ å¯¹finalä¿®é¥°çš„å¯¹è±¡çš„æˆå‘˜åŸŸè¯»æ“ä½œJMMå¯ä»¥ç¡®ä¿çº¿ç¨‹Cè‡³å°‘èƒ½çœ‹åˆ°å†™çº¿ç¨‹Aå¯¹finalå¼•ç”¨çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ï¼Œå³èƒ½çœ‹ä¸‹arrays[0] &#x3D; 1ï¼Œè€Œå†™çº¿ç¨‹Bå¯¹æ•°ç»„å…ƒç´ çš„å†™å…¥å¯èƒ½çœ‹åˆ°å¯èƒ½çœ‹ä¸åˆ°ã€‚JMMä¸ä¿è¯çº¿ç¨‹Bçš„å†™å…¥å¯¹çº¿ç¨‹Cå¯è§ï¼Œçº¿ç¨‹Bå’Œçº¿ç¨‹Cä¹‹é—´å­˜åœ¨æ•°æ®ç«äº‰ï¼Œæ­¤æ—¶çš„ç»“æœæ˜¯ä¸å¯é¢„çŸ¥çš„ã€‚å¦‚æœå¯è§çš„ï¼Œå¯ä½¿ç”¨é”æˆ–è€…volatileã€‚ å…³äºfinalé‡æ’åºçš„æ€»ç»“æŒ‰ç…§finalä¿®é¥°çš„æ•°æ®ç±»å‹åˆ†ç±»ï¼š åŸºæœ¬æ•°æ®ç±»å‹: finalåŸŸå†™ï¼šç¦æ­¢finalåŸŸå†™ä¸æ„é€ æ–¹æ³•é‡æ’åºï¼Œå³ç¦æ­¢finalåŸŸå†™é‡æ’åºåˆ°æ„é€ æ–¹æ³•ä¹‹å¤–ï¼Œä»è€Œä¿è¯è¯¥å¯¹è±¡å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§æ—¶ï¼Œè¯¥å¯¹è±¡çš„finalåŸŸå…¨éƒ¨å·²ç»åˆå§‹åŒ–è¿‡ã€‚ finalåŸŸè¯»ï¼šç¦æ­¢åˆæ¬¡è¯»å¯¹è±¡çš„å¼•ç”¨ä¸è¯»è¯¥å¯¹è±¡åŒ…å«çš„finalåŸŸçš„é‡æ’åºã€‚ å¼•ç”¨æ•°æ®ç±»å‹ï¼š é¢å¤–å¢åŠ çº¦æŸï¼šç¦æ­¢åœ¨æ„é€ å‡½æ•°å¯¹ä¸€ä¸ªfinalä¿®é¥°çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ä¸éšåå°†è¿™ä¸ªè¢«æ„é€ çš„å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™å¼•ç”¨å˜é‡ é‡æ’åº finalå†æ·±å…¥ç†è§£finalçš„å®ç°åŸç†ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œå†™finalåŸŸä¼šè¦æ±‚ç¼–è¯‘å™¨åœ¨finalåŸŸå†™ä¹‹åï¼Œæ„é€ å‡½æ•°è¿”å›å‰æ’å…¥ä¸€ä¸ªStoreStoreå±éšœã€‚è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™ä¼šè¦æ±‚ç¼–è¯‘å™¨åœ¨è¯»finalåŸŸçš„æ“ä½œå‰æ’å…¥ä¸€ä¸ªLoadLoadå±éšœã€‚ å¾ˆæœ‰æ„æ€çš„æ˜¯ï¼Œå¦‚æœä»¥X86å¤„ç†ä¸ºä¾‹ï¼ŒX86ä¸ä¼šå¯¹å†™-å†™é‡æ’åºï¼Œæ‰€ä»¥StoreStoreå±éšœå¯ä»¥çœç•¥ã€‚ç”±äºä¸ä¼šå¯¹æœ‰é—´æ¥ä¾èµ–æ€§çš„æ“ä½œé‡æ’åºï¼Œæ‰€ä»¥åœ¨X86å¤„ç†å™¨ä¸­ï¼Œè¯»finalåŸŸéœ€è¦çš„LoadLoadå±éšœä¹Ÿä¼šè¢«çœç•¥æ‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥X86ä¸ºä¾‹çš„è¯ï¼Œå¯¹finalåŸŸçš„è¯»&#x2F;å†™çš„å†…å­˜å±éšœéƒ½ä¼šè¢«çœç•¥ï¼å…·ä½“æ˜¯å¦æ’å…¥è¿˜æ˜¯å¾—çœ‹æ˜¯ä»€ä¹ˆå¤„ç†å™¨ ä¸ºä»€ä¹ˆfinalå¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°ä¸­â€œæº¢å‡ºâ€è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„é—®é¢˜ï¼šä¸Šé¢å¯¹finalåŸŸå†™é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿æˆ‘ä»¬åœ¨ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨çš„æ—¶å€™è¯¥å¯¹è±¡çš„finalåŸŸå·²ç»åœ¨æ„é€ å‡½æ•°è¢«åˆå§‹åŒ–è¿‡äº†ã€‚ä½†æ˜¯è¿™é‡Œå…¶å®æ˜¯æœ‰ä¸€ä¸ªå‰ææ¡ä»¶çš„ï¼Œä¹Ÿå°±æ˜¯ï¼šåœ¨æ„é€ å‡½æ•°ï¼Œä¸èƒ½è®©è¿™ä¸ªè¢«æ„é€ çš„å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹å¯è§ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å¯¹è±¡å¼•ç”¨ä¸èƒ½åœ¨æ„é€ å‡½æ•°ä¸­â€œæº¢å‡ºâ€ã€‚ä»¥ä¸‹é¢çš„ä¾‹å­æ¥è¯´ï¼š 12345678910111213141516171819public class FinalReferenceEscapeDemo &#123; private final int a; private FinalReferenceEscapeDemo referenceDemo; public FinalReferenceEscapeDemo() &#123; a = 1; //1 referenceDemo = this; //2 &#125; public void writer() &#123; new FinalReferenceEscapeDemo(); &#125; public void reader() &#123; if (referenceDemo != null) &#123; //3 int temp = referenceDemo.a; //4 &#125; &#125;&#125; å¯èƒ½çš„æ‰§è¡Œæ—¶åºå¦‚å›¾æ‰€ç¤ºï¼š å‡è®¾ä¸€ä¸ªçº¿ç¨‹Aæ‰§è¡Œwriteræ–¹æ³•å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œreaderæ–¹æ³•ã€‚å› ä¸ºæ„é€ å‡½æ•°ä¸­æ“ä½œ1å’Œ2ä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–æ€§ï¼Œ1å’Œ2å¯ä»¥é‡æ’åºï¼Œå…ˆæ‰§è¡Œäº†2ï¼Œè¿™ä¸ªæ—¶å€™å¼•ç”¨å¯¹è±¡referenceDemoæ˜¯ä¸ªæ²¡æœ‰å®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡ï¼Œè€Œå½“çº¿ç¨‹Bå»è¯»å–è¯¥å¯¹è±¡æ—¶å°±ä¼šå‡ºé”™ã€‚å°½ç®¡ä¾ç„¶æ»¡è¶³äº†finalåŸŸå†™é‡æ’åºè§„åˆ™ï¼šåœ¨å¼•ç”¨å¯¹è±¡å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§æ—¶ï¼Œå…¶finalåŸŸå·²ç»å®Œå…¨åˆå§‹åŒ–æˆåŠŸã€‚ä½†æ˜¯ï¼Œå¼•ç”¨å¯¹è±¡â€œthisâ€é€¸å‡ºï¼Œè¯¥ä»£ç ä¾ç„¶å­˜åœ¨çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚ ä½¿ç”¨ final çš„é™åˆ¶æ¡ä»¶å’Œå±€é™æ€§å½“å£°æ˜ä¸€ä¸ª final æˆå‘˜æ—¶ï¼Œå¿…é¡»åœ¨æ„é€ å‡½æ•°é€€å‡ºå‰è®¾ç½®å®ƒçš„å€¼ã€‚ 123456public class MyClass &#123; private final int myField = 1; public MyClass() &#123; ... &#125;&#125; æˆ–è€… 12345678public class MyClass &#123; private final int myField; public MyClass() &#123; ... myField = 1; ... &#125;&#125; å°†æŒ‡å‘å¯¹è±¡çš„æˆå‘˜å£°æ˜ä¸º final åªèƒ½å°†è¯¥å¼•ç”¨è®¾ä¸ºä¸å¯å˜çš„ï¼Œè€Œéæ‰€æŒ‡çš„å¯¹è±¡ã€‚ ä¸‹é¢çš„æ–¹æ³•ä»ç„¶å¯ä»¥ä¿®æ”¹è¯¥ listã€‚ 12private final List myList = new ArrayList();myList.add(&quot;Hello&quot;); å£°æ˜ä¸º final å¯ä»¥ä¿è¯å¦‚ä¸‹æ“ä½œä¸åˆæ³• 12myList = new ArrayList();myList = someOtherList; å¦‚æœä¸€ä¸ªå¯¹è±¡å°†ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¸­è®¿é—®å¹¶ä¸”ä½ å¹¶æ²¡æœ‰å°†å…¶æˆå‘˜å£°æ˜ä¸º finalï¼Œåˆ™å¿…é¡»æä¾›å…¶ä»–æ–¹å¼ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ â€œ å…¶ä»–æ–¹å¼ â€œ å¯ä»¥åŒ…æ‹¬å£°æ˜æˆå‘˜ä¸º volatileï¼Œä½¿ç”¨ synchronized æˆ–è€…æ˜¾å¼ Lock æ§åˆ¶æ‰€æœ‰è¯¥æˆå‘˜çš„è®¿é—®ã€‚ å†æ€è€ƒä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼š123byte b1=1;byte b2=3;byte b3=b1+b2;//å½“ç¨‹åºæ‰§è¡Œåˆ°è¿™ä¸€è¡Œçš„æ—¶å€™ä¼šå‡ºé”™ï¼Œå› ä¸ºb1ã€b2å¯ä»¥è‡ªåŠ¨è½¬æ¢æˆintç±»å‹çš„å˜é‡ï¼Œè¿ç®—æ—¶javaè™šæ‹Ÿæœºå¯¹å®ƒè¿›è¡Œäº†è½¬æ¢ï¼Œç»“æœå¯¼è‡´æŠŠä¸€ä¸ªintèµ‹å€¼ç»™byte-----å‡ºé”™ å¦‚æœå¯¹b1 b2åŠ ä¸Šfinalå°±ä¸ä¼šå‡ºé”™ 123final byte b1=1;final byte b2=3;byte b3=b1+b2;//ä¸ä¼šå‡ºé”™ï¼Œç›¸ä¿¡ä½ çœ‹äº†ä¸Šé¢çš„è§£é‡Šå°±çŸ¥é“åŸå› äº†ã€‚ å‚è€ƒæ–‡ç«  https://www.jianshu.com/p/1e82c75034b7 ã€Šjavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ ã€Šç–¯ç‹‚javaè®²ä¹‰ã€‹","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"]},{"title":"6.å…³é”®å­—: volatileè¯¦è§£","path":"/2023/12/25/6-å…³é”®å­—-volatileè¯¦è§£/","content":"ç›¸æ¯”Sychronized(é‡é‡çº§é”ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§)ï¼Œvolatileæä¾›äº†å¦ä¸€ç§è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜çš„æ–¹æ¡ˆã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£volatile æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£volatileã€‚ volatileå…³é”®å­—çš„ä½œç”¨æ˜¯ä»€ä¹ˆ? volatileèƒ½ä¿è¯åŸå­æ€§å—? ä¹‹å‰32ä½æœºå™¨ä¸Šå…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile? ç°åœ¨64ä½æœºå™¨ä¸Šæ˜¯å¦ä¹Ÿè¦è®¾ç½®å‘¢? i++ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§? volatileæ˜¯å¦‚ä½•å®ç°å¯è§æ€§çš„? å†…å­˜å±éšœã€‚ volatileæ˜¯å¦‚ä½•å®ç°æœ‰åºæ€§çš„? happens-beforeç­‰ è¯´ä¸‹volatileçš„åº”ç”¨åœºæ™¯? volatileçš„ä½œç”¨è¯¦è§£é˜²é‡æ’åºæˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç»å…¸çš„ä¾‹å­æ¥åˆ†æé‡æ’åºé—®é¢˜ã€‚å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Œè€Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„å•ä¾‹å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é‡‡ç”¨åŒé‡æ£€æŸ¥åŠ é”(DCL)çš„æ–¹å¼æ¥å®ç°ã€‚å…¶æºç å¦‚ä¸‹ï¼š 1234567891011121314151617public class Singleton &#123; public static volatile Singleton singleton; /** * æ„é€ å‡½æ•°ç§æœ‰ï¼Œç¦æ­¢å¤–éƒ¨å®ä¾‹åŒ– */ private Singleton() &#123;&#125;; public static Singleton getInstance() &#123; if (singleton == null) &#123; synchronized (singleton.class) &#123; if (singleton == null) &#123; singleton = new Singleton(); &#125; &#125; &#125; return singleton; &#125;&#125; ç°åœ¨æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åœ¨å˜é‡singletonä¹‹é—´åŠ ä¸Švolatileå…³é”®å­—ã€‚è¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œå…ˆè¦äº†è§£å¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å…¶å®å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š åˆ†é…å†…å­˜ç©ºé—´ã€‚ åˆå§‹åŒ–å¯¹è±¡ã€‚ å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚ ä½†æ˜¯ç”±äºæ“ä½œç³»ç»Ÿå¯ä»¥å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œæ‰€ä»¥ä¸Šé¢çš„è¿‡ç¨‹ä¹Ÿå¯èƒ½ä¼šå˜æˆå¦‚ä¸‹è¿‡ç¨‹ï¼š åˆ†é…å†…å­˜ç©ºé—´ã€‚ å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚ åˆå§‹åŒ–å¯¹è±¡ å¦‚æœæ˜¯è¿™ä¸ªæµç¨‹ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å°±å¯èƒ½å°†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å¯¹è±¡å¼•ç”¨æš´éœ²å‡ºæ¥ï¼Œä»è€Œå¯¼è‡´ä¸å¯é¢„æ–™çš„ç»“æœã€‚å› æ­¤ï¼Œä¸ºäº†é˜²æ­¢è¿™ä¸ªè¿‡ç¨‹çš„é‡æ’åºï¼Œæˆ‘ä»¬éœ€è¦å°†å˜é‡è®¾ç½®ä¸ºvolatileç±»å‹çš„å˜é‡ã€‚ å®ç°å¯è§æ€§å¯è§æ€§é—®é¢˜ä¸»è¦æŒ‡ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡å€¼ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹å´çœ‹ä¸åˆ°ã€‚å¼•èµ·å¯è§æ€§é—®é¢˜çš„ä¸»è¦åŸå› æ˜¯æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„ä¸€ä¸ªé«˜é€Ÿç¼“å­˜åŒºâ€”â€”çº¿ç¨‹å·¥ä½œå†…å­˜ã€‚volatileå…³é”®å­—èƒ½æœ‰æ•ˆçš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä¸‹é¢çš„ä¾‹å­ï¼Œå°±å¯ä»¥çŸ¥é“å…¶ä½œç”¨ï¼š 123456789101112131415161718192021222324public class TestVolatile &#123; private static boolean stop = false; public static void main(String[] args) &#123; // Thread-A new Thread(&quot;Thread A&quot;) &#123; @Override public void run() &#123; while (!stop) &#123; &#125; System.out.println(Thread.currentThread() + &quot; stopped&quot;); &#125; &#125;.start(); // Thread-main try &#123; TimeUnit.SECONDS.sleep(1); System.out.println(Thread.currentThread() + &quot; after 1 seconds&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; stop = true; &#125;&#125; æ‰§è¡Œè¾“å‡ºå¦‚ä¸‹ 123Thread[main,5,main] after 1 seconds// Thread Aä¸€ç›´åœ¨loop, å› ä¸ºThread A ç”±äºå¯è§æ€§åŸå› çœ‹ä¸åˆ°Thread Main å·²ç»ä¿®æ”¹stopçš„å€¼ å¯ä»¥çœ‹åˆ° Thread-main ä¼‘çœ 1ç§’ä¹‹åï¼Œè®¾ç½® stop &#x3D; tureï¼Œä½†æ˜¯Thread Aæ ¹æœ¬æ²¡åœä¸‹æ¥ï¼Œè¿™å°±æ˜¯å¯è§æ€§é—®é¢˜ã€‚å¦‚æœé€šè¿‡åœ¨stopå˜é‡å‰é¢åŠ ä¸Švolatileå…³é”®å­—åˆ™ä¼šçœŸæ­£stop: 1234Thread[main,5,main] after 1 secondsThread[Thread A,5,main] stoppedProcess finished with exit code 0 ä¿è¯åŸå­æ€§:å•æ¬¡è¯»&#x2F;å†™volatileä¸èƒ½ä¿è¯å®Œå…¨çš„åŸå­æ€§ï¼Œåªèƒ½ä¿è¯å•æ¬¡çš„è¯»&#x2F;å†™æ“ä½œå…·æœ‰åŸå­æ€§ã€‚å…ˆä»å¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜æ¥ç†è§£ï¼ˆåæ–‡å†ä»å†…å­˜å±éšœçš„è§’åº¦ç†è§£ï¼‰ï¼š é—®é¢˜1ï¼š i++ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§?å¯¹äºåŸå­æ€§ï¼Œéœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œä¹Ÿæ˜¯å¤§å®¶å®¹æ˜“è¯¯è§£çš„ä¸€ç‚¹ï¼šå¯¹volatileå˜é‡çš„å•æ¬¡è¯»&#x2F;å†™æ“ä½œå¯ä»¥ä¿è¯åŸå­æ€§çš„ï¼Œå¦‚longå’Œdoubleç±»å‹å˜é‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯i++è¿™ç§æ“ä½œçš„åŸå­æ€§ï¼Œå› ä¸ºæœ¬è´¨ä¸Ši++æ˜¯è¯»ã€å†™ä¸¤æ¬¡æ“ä½œã€‚ ç°åœ¨æˆ‘ä»¬å°±é€šè¿‡ä¸‹åˆ—ç¨‹åºæ¥æ¼”ç¤ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼š 1234567891011121314151617181920212223242526public class VolatileTest01 &#123; volatile int i; public void addI()&#123; i++; &#125; public static void main(String[] args) throws InterruptedException &#123; final VolatileTest01 test01 = new VolatileTest01(); for (int n = 0; n &lt; 1000; n++) &#123; new Thread(new Runnable() &#123; @Override public void run() &#123; try &#123; Thread.sleep(10); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; test01.addI(); &#125; &#125;).start(); &#125; Thread.sleep(10000);//ç­‰å¾…10ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ System.out.println(test01.i); &#125;&#125; å¤§å®¶å¯èƒ½ä¼šè¯¯è®¤ä¸ºå¯¹å˜é‡iåŠ ä¸Šå…³é”®å­—volatileåï¼Œè¿™æ®µç¨‹åºå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤§å®¶å¯ä»¥å°è¯•è¿è¡Œä¸Šé¢çš„ç¨‹åºã€‚ä¸‹é¢æ˜¯æˆ‘æœ¬åœ°è¿è¡Œçš„ç»“æœï¼š981 å¯èƒ½æ¯ä¸ªäººè¿è¡Œçš„ç»“æœä¸ç›¸åŒã€‚ä¸è¿‡åº”è¯¥èƒ½çœ‹å‡ºï¼Œvolatileæ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„(å¦åˆ™ç»“æœåº”è¯¥æ˜¯1000)ã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œi++å…¶å®æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼ŒåŒ…æ‹¬ä¸‰æ­¥éª¤ï¼š è¯»å–içš„å€¼ã€‚ å¯¹iåŠ 1ã€‚ å°†içš„å€¼å†™å›å†…å­˜ã€‚ volatileæ˜¯æ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œæ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AtomicIntegeræˆ–è€…Synchronizedæ¥ä¿è¯+1æ“ä½œçš„åŸå­æ€§ã€‚ æ³¨ï¼šä¸Šé¢å‡ æ®µä»£ç ä¸­å¤šå¤„æ‰§è¡Œäº†Thread.sleep()æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†å¢åŠ å¹¶å‘é—®é¢˜çš„äº§ç”Ÿå‡ ç‡ï¼Œæ— å…¶ä»–ä½œç”¨ã€‚ é—®é¢˜2ï¼š å…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile?å› ä¸ºlongå’Œdoubleä¸¤ç§æ•°æ®ç±»å‹çš„æ“ä½œå¯åˆ†ä¸ºé«˜32ä½å’Œä½32ä½ä¸¤éƒ¨åˆ†ï¼Œå› æ­¤æ™®é€šçš„longæˆ–doubleç±»å‹è¯»&#x2F;å†™å¯èƒ½ä¸æ˜¯åŸå­çš„ã€‚å› æ­¤ï¼Œé¼“åŠ±å¤§å®¶å°†å…±äº«çš„longå’Œdoubleå˜é‡è®¾ç½®ä¸ºvolatileç±»å‹ï¼Œè¿™æ ·èƒ½ä¿è¯ä»»ä½•æƒ…å†µä¸‹å¯¹longå’Œdoubleçš„å•æ¬¡è¯»&#x2F;å†™æ“ä½œéƒ½å…·æœ‰åŸå­æ€§ã€‚ å¦‚ä¸‹æ˜¯JLSä¸­çš„è§£é‡Šï¼š 17.7 Non-Atomic Treatment of double and long For the purposes of the Java programming language memory model, a single write to a non-volatile long or double value is treated as two separate writes: one to each 32-bit half. This can result in a situation where a thread sees the first 32 bits of a 64-bit value from one write, and the second 32 bits from another write. Writes and reads of volatile long and double values are always atomic. Writes to and reads of references are always atomic, regardless of whether they are implemented as 32-bit or 64-bit values. Some implementations may find it convenient to divide a single write action on a 64-bit long or double value into two write actions on adjacent 32-bit values. For efficiencyâ€™s sake, this behavior is implementation-specific; an implementation of the Java Virtual Machine is free to perform writes to long and double values atomically or in two parts. Implementations of the Java Virtual Machine are encouraged to avoid splitting 64-bit values where possible. Programmers are encouraged to declare shared 64-bit values as volatile or synchronize their programs correctly to avoid possible complications. ç›®å‰å„ç§å¹³å°ä¸‹çš„å•†ç”¨è™šæ‹Ÿæœºéƒ½é€‰æ‹©æŠŠ 64 ä½æ•°æ®çš„è¯»å†™æ“ä½œä½œä¸ºåŸå­æ“ä½œæ¥å¯¹å¾…ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ä¸€èˆ¬ä¸æŠŠlong å’Œ double å˜é‡ä¸“é—¨å£°æ˜ä¸º volatileå¤šæ•°æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸ä¼šé”™çš„ã€‚ volatile çš„å®ç°åŸç†volatile å¯è§æ€§å®ç° volatile å˜é‡çš„å†…å­˜å¯è§æ€§æ˜¯åŸºäºå†…å­˜å±éšœ(Memory Barrier)å®ç°: å†…å­˜å±éšœï¼Œåˆç§°å†…å­˜æ …æ ï¼Œæ˜¯ä¸€ä¸ª CPU æŒ‡ä»¤ã€‚ åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œä¸ºäº†æé«˜æ‰§è¡Œæ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼ŒJMM ä¸ºäº†ä¿è¯åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œ CPU ä¸Šæœ‰ç›¸åŒçš„ç»“æœï¼Œé€šè¿‡æ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœæ¥ç¦æ­¢+ ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œæ’å…¥ä¸€æ¡å†…å­˜å±éšœä¼šå‘Šè¯‰ç¼–è¯‘å™¨å’Œ CPUï¼šä¸ç®¡ä»€ä¹ˆæŒ‡ä»¤éƒ½ä¸èƒ½å’Œè¿™æ¡ Memory Barrier æŒ‡ä»¤é‡æ’åºã€‚ å†™ä¸€æ®µç®€å•çš„ Java ä»£ç ï¼Œå£°æ˜ä¸€ä¸ª volatile å˜é‡ï¼Œå¹¶èµ‹å€¼ã€‚ 12345678910public class Test &#123; private volatile int a; public void update() &#123; a = 1; &#125; public static void main(String[] args) &#123; Test test = new Test(); test.update(); &#125;&#125; é€šè¿‡ hsdis å’Œ jitwatch å·¥å…·å¯ä»¥å¾—åˆ°ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç : 123456789101112131415161718...... 0x0000000002951563: and $0xffffffffffffff87,%rdi 0x0000000002951567: je 0x00000000029515f8 0x000000000295156d: test $0x7,%rdi 0x0000000002951574: jne 0x00000000029515bd 0x0000000002951576: test $0x300,%rdi 0x000000000295157d: jne 0x000000000295159c 0x000000000295157f: and $0x37f,%rax 0x0000000002951586: mov %rax,%rdi 0x0000000002951589: or %r15,%rdi 0x000000000295158c: lock cmpxchg %rdi,(%rdx) //åœ¨ volatile ä¿®é¥°çš„å…±äº«å˜é‡è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ä¼šå¤šå‡º lock å‰ç¼€çš„æŒ‡ä»¤ 0x0000000002951591: jne 0x0000000002951a15 0x0000000002951597: jmpq 0x00000000029515f8 0x000000000295159c: mov 0x8(%rdx),%edi 0x000000000295159f: shl $0x3,%rdi 0x00000000029515a3: mov 0xa8(%rdi),%rdi 0x00000000029515aa: or %r15,%rdi...... lock å‰ç¼€çš„æŒ‡ä»¤åœ¨å¤šæ ¸å¤„ç†å™¨ä¸‹ä¼šå¼•å‘ä¸¤ä»¶äº‹æƒ…: å°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚ å†™å›å†…å­˜çš„æ“ä½œä¼šä½¿åœ¨å…¶ä»– CPU é‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®æ— æ•ˆã€‚ ä¸ºäº†æé«˜å¤„ç†é€Ÿåº¦ï¼Œå¤„ç†å™¨ä¸ç›´æ¥å’Œå†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯å…ˆå°†ç³»ç»Ÿå†…å­˜çš„æ•°æ®è¯»åˆ°å†…éƒ¨ç¼“å­˜(L1ï¼ŒL2 æˆ–å…¶ä»–)åå†è¿›è¡Œæ“ä½œï¼Œä½†æ“ä½œå®Œä¸çŸ¥é“ä½•æ—¶ä¼šå†™åˆ°å†…å­˜ã€‚ å¦‚æœå¯¹å£°æ˜äº† volatile çš„å˜é‡è¿›è¡Œå†™æ“ä½œï¼ŒJVM å°±ä¼šå‘å¤„ç†å™¨å‘é€ä¸€æ¡ lock å‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªå˜é‡æ‰€åœ¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚ ä¸ºäº†ä¿è¯å„ä¸ªå¤„ç†å™¨çš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼Œå®ç°äº†ç¼“å­˜ä¸€è‡´æ€§åè®®(MESI)ï¼Œæ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜çš„å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æˆæ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»ç³»ç»Ÿå†…å­˜ä¸­æŠŠæ•°æ®è¯»åˆ°å¤„ç†å™¨ç¼“å­˜é‡Œã€‚ æ‰€æœ‰å¤šæ ¸å¤„ç†å™¨ä¸‹è¿˜ä¼šå®Œæˆï¼šå½“å¤„ç†å™¨å‘ç°æœ¬åœ°ç¼“å­˜å¤±æ•ˆåï¼Œå°±ä¼šä»å†…å­˜ä¸­é‡è¯»è¯¥å˜é‡æ•°æ®ï¼Œå³å¯ä»¥è·å–å½“å‰æœ€æ–°å€¼ã€‚ volatile å˜é‡é€šè¿‡è¿™æ ·çš„æœºåˆ¶å°±ä½¿å¾—æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½è·å¾—è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚ lock æŒ‡ä»¤åœ¨ Pentium å’Œæ—©æœŸçš„ IA-32 å¤„ç†å™¨ä¸­ï¼Œlock å‰ç¼€ä¼šä½¿å¤„ç†å™¨æ‰§è¡Œå½“å‰æŒ‡ä»¤æ—¶äº§ç”Ÿä¸€ä¸ª LOCK# ä¿¡å·ï¼Œä¼šå¯¹æ€»çº¿è¿›è¡Œé”å®šï¼Œå…¶å®ƒ CPU å¯¹å†…å­˜çš„è¯»å†™è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”é‡Šæ”¾ã€‚ åæ¥çš„å¤„ç†å™¨ï¼ŒåŠ é”æ“ä½œæ˜¯ç”±é«˜é€Ÿç¼“å­˜é”ä»£æ›¿æ€»çº¿é”æ¥å¤„ç†ã€‚ å› ä¸ºé”æ€»çº¿çš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œé”æ€»çº¿æœŸé—´å…¶ä»– CPU æ²¡æ³•è®¿é—®å†…å­˜ã€‚ è¿™ç§åœºæ™¯å¤šç¼“å­˜çš„æ•°æ®ä¸€è‡´é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®(MESI)æ¥ä¿è¯ã€‚ ç¼“å­˜ä¸€è‡´æ€§ç¼“å­˜æ˜¯åˆ†æ®µ(line)çš„ï¼Œä¸€ä¸ªæ®µå¯¹åº”ä¸€å—å­˜å‚¨ç©ºé—´ï¼Œç§°ä¹‹ä¸ºç¼“å­˜è¡Œï¼Œå®ƒæ˜¯ CPU ç¼“å­˜ä¸­å¯åˆ†é…çš„æœ€å°å­˜å‚¨å•å…ƒï¼Œå¤§å° 32 å­—èŠ‚ã€64 å­—èŠ‚ã€128 å­—èŠ‚ä¸ç­‰ï¼Œè¿™ä¸ CPU æ¶æ„æœ‰å…³ï¼Œé€šå¸¸æ¥è¯´æ˜¯ 64 å­—èŠ‚ã€‚ LOCK# å› ä¸ºé”æ€»çº¿æ•ˆç‡å¤ªä½ï¼Œå› æ­¤ä½¿ç”¨äº†å¤šç»„ç¼“å­˜ã€‚ ä¸ºäº†ä½¿å…¶è¡Œä¸ºçœ‹èµ·æ¥å¦‚åŒä¸€ç»„ç¼“å­˜é‚£æ ·ã€‚å› è€Œè®¾è®¡äº† ç¼“å­˜ä¸€è‡´æ€§åè®®ã€‚ ç¼“å­˜ä¸€è‡´æ€§åè®®æœ‰å¤šç§ï¼Œä½†æ˜¯æ—¥å¸¸å¤„ç†çš„å¤§å¤šæ•°è®¡ç®—æœºè®¾å¤‡éƒ½å±äº â€œ å—…æ¢(snooping)â€ åè®®ã€‚ æ‰€æœ‰å†…å­˜çš„ä¼ è¾“éƒ½å‘ç”Ÿåœ¨ä¸€æ¡å…±äº«çš„æ€»çº¿ä¸Šï¼Œè€Œæ‰€æœ‰çš„å¤„ç†å™¨éƒ½èƒ½çœ‹åˆ°è¿™æ¡æ€»çº¿ã€‚ ç¼“å­˜æœ¬èº«æ˜¯ç‹¬ç«‹çš„ï¼Œä½†æ˜¯å†…å­˜æ˜¯å…±äº«èµ„æºï¼Œæ‰€æœ‰çš„å†…å­˜è®¿é—®éƒ½è¦ç»è¿‡ä»²è£(åŒä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸä¸­ï¼Œåªæœ‰ä¸€ä¸ª CPU ç¼“å­˜å¯ä»¥è¯»å†™å†…å­˜)ã€‚ CPU ç¼“å­˜ä¸ä»…ä»…åœ¨åšå†…å­˜ä¼ è¾“çš„æ—¶å€™æ‰ä¸æ€»çº¿æ‰“äº¤é“ï¼Œè€Œæ˜¯ä¸åœåœ¨å—…æ¢æ€»çº¿ä¸Šå‘ç”Ÿçš„æ•°æ®äº¤æ¢ï¼Œè·Ÿè¸ªå…¶ä»–ç¼“å­˜åœ¨åšä»€ä¹ˆã€‚ å½“ä¸€ä¸ªç¼“å­˜ä»£è¡¨å®ƒæ‰€å±çš„å¤„ç†å™¨å»è¯»å†™å†…å­˜æ—¶ï¼Œå…¶å®ƒå¤„ç†å™¨éƒ½ä¼šå¾—åˆ°é€šçŸ¥ï¼Œå®ƒä»¬ä»¥æ­¤æ¥ä½¿è‡ªå·±çš„ç¼“å­˜ä¿æŒåŒæ­¥ã€‚ åªè¦æŸä¸ªå¤„ç†å™¨å†™å†…å­˜ï¼Œå…¶å®ƒå¤„ç†å™¨é©¬ä¸ŠçŸ¥é“è¿™å—å†…å­˜åœ¨å®ƒä»¬çš„ç¼“å­˜æ®µä¸­å·²ç»å¤±æ•ˆã€‚ volatile æœ‰åºæ€§å®ç°volatile çš„ happens-before å…³ç³»happens-before è§„åˆ™ä¸­æœ‰ä¸€æ¡æ˜¯ volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens-before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ã€‚ 1234567891011121314151617//å‡è®¾çº¿ç¨‹Aæ‰§è¡Œwriteræ–¹æ³•ï¼Œçº¿ç¨‹Bæ‰§è¡Œreaderæ–¹æ³•class VolatileExample &#123; int a = 0; volatile boolean flag = false; public void writer() &#123; a = 1; // 1 çº¿ç¨‹Aä¿®æ”¹å…±äº«å˜é‡ flag = true; // 2 çº¿ç¨‹Aå†™volatileå˜é‡ &#125; public void reader() &#123; if (flag) &#123; // 3 çº¿ç¨‹Bè¯»åŒä¸€ä¸ªvolatileå˜é‡ int i = a; // 4 çº¿ç¨‹Bè¯»å…±äº«å˜é‡ â€¦â€¦ &#125; &#125;&#125; æ ¹æ® happens-before è§„åˆ™ï¼Œä¸Šé¢è¿‡ç¨‹ä¼šå»ºç«‹ 3 ç±» happens-before å…³ç³»ã€‚ æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼š1 happens-before 2 ä¸” 3 happens-before 4ã€‚ æ ¹æ® volatile è§„åˆ™ï¼š2 happens-before 3ã€‚ æ ¹æ® happens-before çš„ä¼ é€’æ€§è§„åˆ™ï¼š1 happens-before 4ã€‚ å› ä¸ºä»¥ä¸Šè§„åˆ™ï¼Œå½“çº¿ç¨‹ A å°† volatile å˜é‡ flag æ›´æ”¹ä¸º true åï¼Œçº¿ç¨‹ B èƒ½å¤Ÿè¿…é€Ÿæ„ŸçŸ¥ã€‚ volatile ç¦æ­¢é‡æ’åºä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒJMM åœ¨ä¸æ”¹å˜æ­£ç¡®è¯­ä¹‰çš„å‰æä¸‹ï¼Œä¼šå…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹æŒ‡ä»¤åºåˆ—è¿›è¡Œé‡æ’åºã€‚JMM æä¾›äº†å†…å­˜å±éšœé˜»æ­¢è¿™ç§é‡æ’åºã€‚ Java ç¼–è¯‘å™¨ä¼šåœ¨ç”ŸæˆæŒ‡ä»¤ç³»åˆ—æ—¶åœ¨é€‚å½“çš„ä½ç½®ä¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚ JMM ä¼šé’ˆå¯¹ç¼–è¯‘å™¨åˆ¶å®š volatile é‡æ’åºè§„åˆ™è¡¨ã€‚ â€œ NO â€œ è¡¨ç¤ºç¦æ­¢é‡æ’åºã€‚ ä¸ºäº†å®ç° volatile å†…å­˜è¯­ä¹‰æ—¶ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚ å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå‘ç°ä¸€ä¸ªæœ€ä¼˜å¸ƒç½®æ¥æœ€å°åŒ–æ’å…¥å±éšœçš„æ€»æ•°å‡ ä¹æ˜¯ä¸å¯èƒ½çš„ï¼Œä¸ºæ­¤ï¼ŒJMM é‡‡å–äº†ä¿å®ˆçš„ç­–ç•¥ã€‚ åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ª StoreStore å±éšœã€‚ åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœã€‚ åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadLoad å±éšœã€‚ åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadStore å±éšœã€‚ volatile å†™æ˜¯åœ¨å‰é¢å’Œåé¢åˆ†åˆ«æ’å…¥å†…å­˜å±éšœï¼Œè€Œ volatile è¯»æ“ä½œæ˜¯åœ¨åé¢æ’å…¥ä¸¤ä¸ªå†…å­˜å±éšœã€‚ å†…å­˜å±éšœ è¯´æ˜ StoreStore å±éšœ ç¦æ­¢ä¸Šé¢çš„æ™®é€šå†™å’Œä¸‹é¢çš„ volatile å†™é‡æ’åºã€‚ StoreLoad å±éšœ é˜²æ­¢ä¸Šé¢çš„ volatile å†™ä¸ä¸‹é¢å¯èƒ½æœ‰çš„ volatile è¯»&#x2F;å†™é‡æ’åºã€‚ LoadLoad å±éšœ ç¦æ­¢ä¸‹é¢æ‰€æœ‰çš„æ™®é€šè¯»æ“ä½œå’Œä¸Šé¢çš„ volatile è¯»é‡æ’åºã€‚ LoadStore å±éšœ ç¦æ­¢ä¸‹é¢æ‰€æœ‰çš„æ™®é€šå†™æ“ä½œå’Œä¸Šé¢çš„ volatile è¯»é‡æ’åºã€‚ volatile çš„åº”ç”¨åœºæ™¯ä½¿ç”¨ volatile å¿…é¡»å…·å¤‡çš„æ¡ä»¶ å¯¹å˜é‡çš„å†™æ“ä½œä¸ä¾èµ–äºå½“å‰å€¼ã€‚ è¯¥å˜é‡æ²¡æœ‰åŒ…å«åœ¨å…·æœ‰å…¶ä»–å˜é‡çš„ä¸å˜å¼ä¸­ã€‚ åªæœ‰åœ¨çŠ¶æ€çœŸæ­£ç‹¬ç«‹äºç¨‹åºå†…å…¶ä»–å†…å®¹æ—¶æ‰èƒ½ä½¿ç”¨ volatileã€‚ æ¨¡å¼1ï¼šçŠ¶æ€æ ‡å¿—ä¹Ÿè®¸å®ç° volatile å˜é‡çš„è§„èŒƒä½¿ç”¨ä»…ä»…æ˜¯ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”çŠ¶æ€æ ‡å¿—ï¼Œç”¨äºæŒ‡ç¤ºå‘ç”Ÿäº†ä¸€ä¸ªé‡è¦çš„ä¸€æ¬¡æ€§äº‹ä»¶ï¼Œä¾‹å¦‚å®Œæˆåˆå§‹åŒ–æˆ–è¯·æ±‚åœæœºã€‚ 12345678volatile boolean shutdownRequested;......public void shutdown() &#123; shutdownRequested = true; &#125;public void doWork() &#123; while (!shutdownRequested) &#123; // do stuff &#125;&#125; æ¨¡å¼2ï¼šä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ(one-time safe publication)ç¼ºä¹åŒæ­¥ä¼šå¯¼è‡´æ— æ³•å®ç°å¯è§æ€§ï¼Œè¿™ä½¿å¾—ç¡®å®šä½•æ—¶å†™å…¥å¯¹è±¡å¼•ç”¨è€Œä¸æ˜¯åŸå§‹å€¼å˜å¾—æ›´åŠ å›°éš¾ã€‚åœ¨ç¼ºä¹åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé‡åˆ°æŸä¸ªå¯¹è±¡å¼•ç”¨çš„æ›´æ–°å€¼(ç”±å¦ä¸€ä¸ªçº¿ç¨‹å†™å…¥)å’Œè¯¥å¯¹è±¡çŠ¶æ€çš„æ—§å€¼åŒæ—¶å­˜åœ¨ã€‚(è¿™å°±æ˜¯é€ æˆè‘—åçš„åŒé‡æ£€æŸ¥é”å®š(double-checked-locking)é—®é¢˜çš„æ ¹æºï¼Œå…¶ä¸­å¯¹è±¡å¼•ç”¨åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹è¿›è¡Œè¯»æ“ä½œï¼Œäº§ç”Ÿçš„é—®é¢˜æ˜¯æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªæ›´æ–°çš„å¼•ç”¨ï¼Œä½†æ˜¯ä»ç„¶ä¼šé€šè¿‡è¯¥å¼•ç”¨çœ‹åˆ°ä¸å®Œå…¨æ„é€ çš„å¯¹è±¡)ã€‚ 12345678910111213141516171819public class BackgroundFloobleLoader &#123; public volatile Flooble theFlooble; public void initInBackground() &#123; // do lots of stuff theFlooble = new Flooble(); // this is the only write to theFlooble &#125;&#125; public class SomeOtherClass &#123; public void doWork() &#123; while (true) &#123; // do some stuff... // use the Flooble, but only if it is ready if (floobleLoader.theFlooble != null) doSomething(floobleLoader.theFlooble); &#125; &#125;&#125; æ¨¡å¼3ï¼šç‹¬ç«‹è§‚å¯Ÿ(independent observation)å®‰å…¨ä½¿ç”¨ volatile çš„å¦ä¸€ç§ç®€å•æ¨¡å¼æ˜¯å®šæœŸ å‘å¸ƒ è§‚å¯Ÿç»“æœä¾›ç¨‹åºå†…éƒ¨ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€ç§ç¯å¢ƒä¼ æ„Ÿå™¨èƒ½å¤Ÿæ„Ÿè§‰ç¯å¢ƒæ¸©åº¦ã€‚ä¸€ä¸ªåå°çº¿ç¨‹å¯èƒ½ä¼šæ¯éš”å‡ ç§’è¯»å–ä¸€æ¬¡è¯¥ä¼ æ„Ÿå™¨ï¼Œå¹¶æ›´æ–°åŒ…å«å½“å‰æ–‡æ¡£çš„ volatile å˜é‡ã€‚ç„¶åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è¯»å–è¿™ä¸ªå˜é‡ï¼Œä»è€Œéšæ—¶èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°çš„æ¸©åº¦å€¼ã€‚ 12345678910111213public class UserManager &#123; public volatile String lastUser; public boolean authenticate(String user, String password) &#123; boolean valid = passwordIsValid(user, password); if (valid) &#123; User u = new User(); activeUsers.add(u); lastUser = user; &#125; return valid; &#125;&#125; æ¨¡å¼4ï¼švolatile bean æ¨¡å¼åœ¨ volatile bean æ¨¡å¼ä¸­ï¼ŒJavaBean çš„æ‰€æœ‰æ•°æ®æˆå‘˜éƒ½æ˜¯ volatile ç±»å‹çš„ï¼Œå¹¶ä¸” getter å’Œ setter æ–¹æ³•å¿…é¡»éå¸¸æ™®é€š â€”â€” é™¤äº†è·å–æˆ–è®¾ç½®ç›¸åº”çš„å±æ€§å¤–ï¼Œä¸èƒ½åŒ…å«ä»»ä½•é€»è¾‘ã€‚æ­¤å¤–ï¼Œå¯¹äºå¯¹è±¡å¼•ç”¨çš„æ•°æ®æˆå‘˜ï¼Œå¼•ç”¨çš„å¯¹è±¡å¿…é¡»æ˜¯æœ‰æ•ˆä¸å¯å˜çš„ã€‚(è¿™å°†ç¦æ­¢å…·æœ‰æ•°ç»„å€¼çš„å±æ€§ï¼Œå› ä¸ºå½“æ•°ç»„å¼•ç”¨è¢«å£°æ˜ä¸º volatile æ—¶ï¼Œåªæœ‰å¼•ç”¨è€Œä¸æ˜¯æ•°ç»„æœ¬èº«å…·æœ‰ volatile è¯­ä¹‰)ã€‚å¯¹äºä»»ä½• volatile å˜é‡ï¼Œä¸å˜å¼æˆ–çº¦æŸéƒ½ä¸èƒ½åŒ…å« JavaBean å±æ€§ã€‚ 12345678910111213141516171819202122@ThreadSafepublic class Person &#123; private volatile String firstName; private volatile String lastName; private volatile int age; public String getFirstName() &#123; return firstName; &#125; public String getLastName() &#123; return lastName; &#125; public int getAge() &#123; return age; &#125; public void setFirstName(String firstName) &#123; this.firstName = firstName; &#125; public void setLastName(String lastName) &#123; this.lastName = lastName; &#125; public void setAge(int age) &#123; this.age = age; &#125;&#125; æ¨¡å¼5ï¼šå¼€é”€è¾ƒä½çš„è¯»ï¼å†™é”ç­–ç•¥volatile çš„åŠŸèƒ½è¿˜ä¸è¶³ä»¥å®ç°è®¡æ•°å™¨ã€‚å› ä¸º ++x å®é™…ä¸Šæ˜¯ä¸‰ç§æ“ä½œ(è¯»ã€æ·»åŠ ã€å­˜å‚¨)çš„ç®€å•ç»„åˆï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹å‡‘å·§è¯•å›¾åŒæ—¶å¯¹ volatile è®¡æ•°å™¨æ‰§è¡Œå¢é‡æ“ä½œï¼Œé‚£ä¹ˆå®ƒçš„æ›´æ–°å€¼æœ‰å¯èƒ½ä¼šä¸¢å¤±ã€‚ å¦‚æœè¯»æ“ä½œè¿œè¿œè¶…è¿‡å†™æ“ä½œï¼Œå¯ä»¥ç»“åˆä½¿ç”¨å†…éƒ¨é”å’Œ volatile å˜é‡æ¥å‡å°‘å…¬å…±ä»£ç è·¯å¾„çš„å¼€é”€ã€‚ å®‰å…¨çš„è®¡æ•°å™¨ä½¿ç”¨ synchronized ç¡®ä¿å¢é‡æ“ä½œæ˜¯åŸå­çš„ï¼Œå¹¶ä½¿ç”¨ volatile ä¿è¯å½“å‰ç»“æœçš„å¯è§æ€§ã€‚å¦‚æœæ›´æ–°ä¸é¢‘ç¹çš„è¯ï¼Œè¯¥æ–¹æ³•å¯å®ç°æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºè¯»è·¯å¾„çš„å¼€é”€ä»…ä»…æ¶‰åŠ volatile è¯»æ“ä½œï¼Œè¿™é€šå¸¸è¦ä¼˜äºä¸€ä¸ªæ— ç«äº‰çš„é”è·å–çš„å¼€é”€ã€‚ 123456789101112@ThreadSafepublic class CheesyCounter &#123; // Employs the cheap read-write lock trick // All mutative operations MUST be done with the &#x27;this&#x27; lock held @GuardedBy(&quot;this&quot;) private volatile int value; public int getValue() &#123; return value; &#125; public synchronized int increment() &#123; return value++; &#125;&#125; æ¨¡å¼6ï¼šåŒé‡æ£€æŸ¥(double-checked)å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡ä¸¾çš„ä¾‹å­ã€‚ å•ä¾‹æ¨¡å¼çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œä½†å¾ˆå¤šäººä¼šå¿½ç•¥ volatile å…³é”®å­—ï¼Œå› ä¸ºæ²¡æœ‰è¯¥å…³é”®å­—ï¼Œç¨‹åºä¹Ÿå¯ä»¥å¾ˆå¥½çš„è¿è¡Œï¼Œåªä¸è¿‡ä»£ç çš„ç¨³å®šæ€§æ€»ä¸æ˜¯ 100%ï¼Œè¯´ä¸å®šåœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œéšè—çš„ bug å°±å‡ºæ¥äº†ã€‚ 123456789101112131415class Singleton &#123; private volatile static Singleton instance; private Singleton() &#123; &#125; public static Singleton getInstance() &#123; if (instance == null) &#123; syschronized(Singleton.class) &#123; if (instance == null) &#123; instance = new Singleton(); &#125; &#125; &#125; return instance; &#125; &#125; å‚è€ƒæ–‡ç«  https://blog.csdn.net/devotion987/article/details/68486942 https://www.jianshu.com/p/ccfe24b63d87","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"]},{"title":"5.å…³é”®å­—: synchronizedè¯¦è§£","path":"/2023/12/25/5-å…³é”®å­—-synchronizedè¯¦è§£/","content":"åœ¨Cç¨‹åºä»£ç ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„äº’æ–¥é”æ¥å®ç°åŒæ­¥å—çš„äº’æ–¥è®¿é—®åŠçº¿ç¨‹çš„é˜»å¡åŠå”¤é†’ç­‰å·¥ä½œã€‚åœ¨Javaä¸­é™¤äº†æä¾›Lock APIå¤–è¿˜åœ¨è¯­æ³•å±‚é¢ä¸Šæä¾›äº†synchronizedå…³é”®å­—æ¥å®ç°äº’æ–¥åŒæ­¥åŸè¯­, æœ¬æ–‡å°†å¯¹synchronizedå…³é”®å­—è¯¦ç»†åˆ†æã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£Synchronized æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£synchronizedã€‚ Synchronizedå¯ä»¥ä½œç”¨åœ¨å“ªé‡Œ? åˆ†åˆ«é€šè¿‡å¯¹è±¡é”å’Œç±»é”è¿›è¡Œä¸¾ä¾‹ã€‚ Synchronizedæœ¬è´¨ä¸Šæ˜¯é€šè¿‡ä»€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨çš„? åˆ†ä¸‰ä¸ªæ–¹é¢å›ç­”ï¼šåŠ é”å’Œé‡Šæ”¾é”çš„åŸç†ï¼Œå¯é‡å…¥åŸç†ï¼Œä¿è¯å¯è§æ€§åŸç†ã€‚ Synchronizedç”±ä»€ä¹ˆæ ·çš„ç¼ºé™·? Java Lockæ˜¯æ€ä¹ˆå¼¥è¡¥è¿™äº›ç¼ºé™·çš„ã€‚ Synchronizedå’ŒLockçš„å¯¹æ¯”ï¼Œå’Œé€‰æ‹©? Synchronizedåœ¨ä½¿ç”¨æ—¶æœ‰ä½•æ³¨æ„äº‹é¡¹? Synchronizedä¿®é¥°çš„æ–¹æ³•åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶,ä¼šé‡Šæ”¾é”å—? å¤šä¸ªçº¿ç¨‹ç­‰å¾…åŒä¸€ä¸ªSynchronizedé”çš„æ—¶å€™ï¼ŒJVMå¦‚ä½•é€‰æ‹©ä¸‹ä¸€ä¸ªè·å–é”çš„çº¿ç¨‹? Synchronizedä½¿å¾—åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œï¼Œæ€§èƒ½æ¯”è¾ƒå·®ï¼Œæœ‰ä»€ä¹ˆæå‡çš„æ–¹æ³•? æˆ‘æƒ³æ›´åŠ çµæ´»çš„æ§åˆ¶é”çš„é‡Šæ”¾å’Œè·å–(ç°åœ¨é‡Šæ”¾é”å’Œè·å–é”çš„æ—¶æœºéƒ½è¢«è§„å®šæ­»äº†)ï¼Œæ€ä¹ˆåŠ? ä»€ä¹ˆæ˜¯é”çš„å‡çº§å’Œé™çº§? ä»€ä¹ˆæ˜¯JVMé‡Œçš„åæ–œé”ã€è½»é‡çº§é”ã€é‡é‡çº§é”? ä¸åŒçš„JDKä¸­å¯¹Synchronizedæœ‰ä½•ä¼˜åŒ–? Synchronizedçš„ä½¿ç”¨åœ¨åº”ç”¨Sychronizedå…³é”®å­—æ—¶éœ€è¦æŠŠæ¡å¦‚ä¸‹æ³¨æ„ç‚¹ï¼š ä¸€æŠŠé”åªèƒ½åŒæ—¶è¢«ä¸€ä¸ªçº¿ç¨‹è·å–ï¼Œæ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹åªèƒ½ç­‰å¾…ï¼› æ¯ä¸ªå®ä¾‹éƒ½å¯¹åº”æœ‰è‡ªå·±çš„ä¸€æŠŠé”(this),ä¸åŒå®ä¾‹ä¹‹é—´äº’ä¸å½±å“ï¼›ä¾‹å¤–ï¼šé”å¯¹è±¡æ˜¯*.classä»¥åŠsynchronizedä¿®é¥°çš„æ˜¯staticæ–¹æ³•çš„æ—¶å€™ï¼Œæ‰€æœ‰å¯¹è±¡å…¬ç”¨åŒä¸€æŠŠé” synchronizedä¿®é¥°çš„æ–¹æ³•ï¼Œæ— è®ºæ–¹æ³•æ­£å¸¸æ‰§è¡Œå®Œæ¯•è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½ä¼šé‡Šæ”¾é” å¯¹è±¡é”åŒ…æ‹¬æ–¹æ³•é”(é»˜è®¤é”å¯¹è±¡ä¸ºthis,å½“å‰å®ä¾‹å¯¹è±¡)å’ŒåŒæ­¥ä»£ç å—é”(è‡ªå·±æŒ‡å®šé”å¯¹è±¡) ä»£ç å—å½¢å¼ï¼šæ‰‹åŠ¨æŒ‡å®šé”å®šå¯¹è±¡ï¼Œä¹Ÿå¯æ˜¯æ˜¯this,ä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰çš„é” ç¤ºä¾‹1 123456789101112131415161718192021222324public class SynchronizedObjectLock implements Runnable &#123; static SynchronizedObjectLock instance = new SynchronizedObjectLock(); @Override public void run() &#123; // åŒæ­¥ä»£ç å—å½¢å¼â€”â€”é”ä¸ºthis,ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨çš„é”æ˜¯ä¸€æ ·çš„,çº¿ç¨‹1å¿…é¡»è¦ç­‰åˆ°çº¿ç¨‹0é‡Šæ”¾äº†è¯¥é”åï¼Œæ‰èƒ½æ‰§è¡Œ synchronized (this) &#123; System.out.println(&quot;æˆ‘æ˜¯çº¿ç¨‹&quot; + Thread.currentThread().getName()); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(Thread.currentThread().getName() + &quot;ç»“æŸ&quot;); &#125; &#125; public static void main(String[] args) &#123; Thread t1 = new Thread(instance); Thread t2 = new Thread(instance); t1.start(); t2.start(); &#125;&#125; è¾“å‡ºç»“æœï¼š 1234æˆ‘æ˜¯çº¿ç¨‹Thread-0Thread-0ç»“æŸæˆ‘æ˜¯çº¿ç¨‹Thread-1Thread-1ç»“æŸ ç¤ºä¾‹2 12345678910111213141516171819202122232425262728293031323334353637public class SynchronizedObjectLock implements Runnable &#123; static SynchronizedObjectLock instance = new SynchronizedObjectLock(); // åˆ›å»º2æŠŠé” Object block1 = new Object(); Object block2 = new Object(); @Override public void run() &#123; // è¿™ä¸ªä»£ç å—ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€æŠŠé”ï¼Œå½“ä»–é‡Šæ”¾åï¼Œåé¢çš„ä»£ç å—ç”±äºä½¿ç”¨çš„æ˜¯ç¬¬äºŒæŠŠé”ï¼Œå› æ­¤å¯ä»¥é©¬ä¸Šæ‰§è¡Œ synchronized (block1) &#123; System.out.println(&quot;block1é”,æˆ‘æ˜¯çº¿ç¨‹&quot; + Thread.currentThread().getName()); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;block1é”,&quot;+Thread.currentThread().getName() + &quot;ç»“æŸ&quot;); &#125; synchronized (block2) &#123; System.out.println(&quot;block2é”,æˆ‘æ˜¯çº¿ç¨‹&quot; + Thread.currentThread().getName()); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;block2é”,&quot;+Thread.currentThread().getName() + &quot;ç»“æŸ&quot;); &#125; &#125; public static void main(String[] args) &#123; Thread t1 = new Thread(instance); Thread t2 = new Thread(instance); t1.start(); t2.start(); &#125;&#125; è¾“å‡ºç»“æœï¼š 12345678block1é”,æˆ‘æ˜¯çº¿ç¨‹Thread-0block1é”,Thread-0ç»“æŸblock2é”,æˆ‘æ˜¯çº¿ç¨‹Thread-0 // å¯ä»¥çœ‹åˆ°å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå®Œç¬¬ä¸€æ®µåŒæ­¥ä»£ç å—ä¹‹åï¼Œç¬¬äºŒä¸ªåŒæ­¥ä»£ç å—å¯ä»¥é©¬ä¸Šå¾—åˆ°æ‰§è¡Œï¼Œå› ä¸ºä»–ä»¬ä½¿ç”¨çš„é”ä¸æ˜¯åŒä¸€æŠŠblock1é”,æˆ‘æ˜¯çº¿ç¨‹Thread-1block2é”,Thread-0ç»“æŸblock1é”,Thread-1ç»“æŸblock2é”,æˆ‘æ˜¯çº¿ç¨‹Thread-1block2é”,Thread-1ç»“æŸ æ–¹æ³•é”å½¢å¼ï¼šsynchronizedä¿®é¥°æ™®é€šæ–¹æ³•ï¼Œé”å¯¹è±¡é»˜è®¤ä¸ºthis12345678910111213141516171819202122232425public class SynchronizedObjectLock implements Runnable &#123; static SynchronizedObjectLock instance = new SynchronizedObjectLock(); @Override public void run() &#123; method(); &#125; public synchronized void method() &#123; System.out.println(&quot;æˆ‘æ˜¯çº¿ç¨‹&quot; + Thread.currentThread().getName()); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(Thread.currentThread().getName() + &quot;ç»“æŸ&quot;); &#125; public static void main(String[] args) &#123; Thread t1 = new Thread(instance); Thread t2 = new Thread(instance); t1.start(); t2.start(); &#125;&#125; è¾“å‡ºç»“æœï¼š 1234æˆ‘æ˜¯çº¿ç¨‹Thread-0Thread-0ç»“æŸæˆ‘æ˜¯çº¿ç¨‹Thread-1Thread-1ç»“æŸ ç±»é”æŒ‡synchronizeä¿®é¥°é™æ€çš„æ–¹æ³•æˆ–æŒ‡å®šé”å¯¹è±¡ä¸ºClasså¯¹è±¡ synchronizeä¿®é¥°é™æ€æ–¹æ³• ç¤ºä¾‹1 12345678910111213141516171819202122232425262728public class SynchronizedObjectLock implements Runnable &#123; static SynchronizedObjectLock instance1 = new SynchronizedObjectLock(); static SynchronizedObjectLock instance2 = new SynchronizedObjectLock(); @Override public void run() &#123; method(); &#125; // synchronizedç”¨åœ¨æ™®é€šæ–¹æ³•ä¸Šï¼Œé»˜è®¤çš„é”å°±æ˜¯thisï¼Œå½“å‰å®ä¾‹ public synchronized void method() &#123; System.out.println(&quot;æˆ‘æ˜¯çº¿ç¨‹&quot; + Thread.currentThread().getName()); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(Thread.currentThread().getName() + &quot;ç»“æŸ&quot;); &#125; public static void main(String[] args) &#123; // t1å’Œt2å¯¹åº”çš„thisæ˜¯ä¸¤ä¸ªä¸åŒçš„å®ä¾‹ï¼Œæ‰€ä»¥ä»£ç ä¸ä¼šä¸²è¡Œ Thread t1 = new Thread(instance1); Thread t2 = new Thread(instance2); t1.start(); t2.start(); &#125;&#125; è¾“å‡ºç»“æœï¼š 1234æˆ‘æ˜¯çº¿ç¨‹Thread-0æˆ‘æ˜¯çº¿ç¨‹Thread-1Thread-1ç»“æŸThread-0ç»“æŸ ç¤ºä¾‹2 123456789101112131415161718192021222324252627public class SynchronizedObjectLock implements Runnable &#123; static SynchronizedObjectLock instance1 = new SynchronizedObjectLock(); static SynchronizedObjectLock instance2 = new SynchronizedObjectLock(); @Override public void run() &#123; method(); &#125; // synchronizedç”¨åœ¨é™æ€æ–¹æ³•ä¸Šï¼Œé»˜è®¤çš„é”å°±æ˜¯å½“å‰æ‰€åœ¨çš„Classç±»ï¼Œæ‰€ä»¥æ— è®ºæ˜¯å“ªä¸ªçº¿ç¨‹è®¿é—®å®ƒï¼Œéœ€è¦çš„é”éƒ½åªæœ‰ä¸€æŠŠ public static synchronized void method() &#123; System.out.println(&quot;æˆ‘æ˜¯çº¿ç¨‹&quot; + Thread.currentThread().getName()); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(Thread.currentThread().getName() + &quot;ç»“æŸ&quot;); &#125; public static void main(String[] args) &#123; Thread t1 = new Thread(instance1); Thread t2 = new Thread(instance2); t1.start(); t2.start(); &#125;&#125; è¾“å‡ºç»“æœï¼š 1234æˆ‘æ˜¯çº¿ç¨‹Thread-0Thread-0ç»“æŸæˆ‘æ˜¯çº¿ç¨‹Thread-1Thread-1ç»“æŸ synchronizedæŒ‡å®šé”å¯¹è±¡ä¸ºClasså¯¹è±¡12345678910111213141516171819202122232425public class SynchronizedObjectLock implements Runnable &#123; static SynchronizedObjectLock instance1 = new SynchronizedObjectLock(); static SynchronizedObjectLock instance2 = new SynchronizedObjectLock(); @Override public void run() &#123; // æ‰€æœ‰çº¿ç¨‹éœ€è¦çš„é”éƒ½æ˜¯åŒä¸€æŠŠ synchronized(SynchronizedObjectLock.class)&#123; System.out.println(&quot;æˆ‘æ˜¯çº¿ç¨‹&quot; + Thread.currentThread().getName()); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(Thread.currentThread().getName() + &quot;ç»“æŸ&quot;); &#125; &#125; public static void main(String[] args) &#123; Thread t1 = new Thread(instance1); Thread t2 = new Thread(instance2); t1.start(); t2.start(); &#125;&#125; è¾“å‡ºç»“æœï¼š 1234æˆ‘æ˜¯çº¿ç¨‹Thread-0Thread-0ç»“æŸæˆ‘æ˜¯çº¿ç¨‹Thread-1Thread-1ç»“æŸ SynchronizedåŸç†åˆ†æåŠ é”å’Œé‡Šæ”¾é”çš„åŸç† ç°è±¡ã€æ—¶æœº(å†…ç½®é”this)ã€æ·±å…¥JVMçœ‹å­—èŠ‚ç (åç¼–è¯‘çœ‹monitoræŒ‡ä»¤) æ·±å…¥JVMçœ‹å­—èŠ‚ç ï¼Œåˆ›å»ºå¦‚ä¸‹çš„ä»£ç ï¼š 1234567891011121314public class SynchronizedDemo2 &#123; Object object = new Object(); public void method1() &#123; synchronized (object) &#123; &#125; method2(); &#125; private static void method2() &#123; &#125;&#125; ä½¿ç”¨javacå‘½ä»¤è¿›è¡Œç¼–è¯‘ç”Ÿæˆ.classæ–‡ä»¶ 1&gt;javac SynchronizedDemo2.java ä½¿ç”¨javapå‘½ä»¤åç¼–è¯‘æŸ¥çœ‹.classæ–‡ä»¶çš„ä¿¡æ¯ 1&gt;javap -verbose SynchronizedDemo2.class å¾—åˆ°å¦‚ä¸‹çš„ä¿¡æ¯ï¼š å…³æ³¨çº¢è‰²æ–¹æ¡†é‡Œçš„monitorenterå’Œmonitorexitå³å¯ã€‚ Monitorenterå’ŒMonitorexitæŒ‡ä»¤ï¼Œä¼šè®©å¯¹è±¡åœ¨æ‰§è¡Œï¼Œä½¿å…¶é”è®¡æ•°å™¨åŠ 1æˆ–è€…å‡1ã€‚æ¯ä¸€ä¸ªå¯¹è±¡åœ¨åŒä¸€æ—¶é—´åªä¸ä¸€ä¸ªmonitor(é”)ç›¸å…³è”ï¼Œè€Œä¸€ä¸ªmonitoråœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å¾—ï¼Œä¸€ä¸ªå¯¹è±¡åœ¨å°è¯•è·å¾—ä¸è¿™ä¸ªå¯¹è±¡ç›¸å…³è”çš„Monitoré”çš„æ‰€æœ‰æƒçš„æ—¶å€™ï¼ŒmonitorenteræŒ‡ä»¤ä¼šå‘ç”Ÿå¦‚ä¸‹3ä¸­æƒ…å†µä¹‹ä¸€ï¼š monitorè®¡æ•°å™¨ä¸º0ï¼Œæ„å‘³ç€ç›®å‰è¿˜æ²¡æœ‰è¢«è·å¾—ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹å°±ä¼šç«‹åˆ»è·å¾—ç„¶åæŠŠé”è®¡æ•°å™¨+1ï¼Œä¸€æ—¦+1ï¼Œåˆ«çš„çº¿ç¨‹å†æƒ³è·å–ï¼Œå°±éœ€è¦ç­‰å¾… å¦‚æœè¿™ä¸ªmonitorå·²ç»æ‹¿åˆ°äº†è¿™ä¸ªé”çš„æ‰€æœ‰æƒï¼Œåˆé‡å…¥äº†è¿™æŠŠé”ï¼Œé‚£é”è®¡æ•°å™¨å°±ä¼šç´¯åŠ ï¼Œå˜æˆ2ï¼Œå¹¶ä¸”éšç€é‡å…¥çš„æ¬¡æ•°ï¼Œä¼šä¸€ç›´ç´¯åŠ  è¿™æŠŠé”å·²ç»è¢«åˆ«çš„çº¿ç¨‹è·å–äº†ï¼Œç­‰å¾…é”é‡Šæ”¾ monitorexitæŒ‡ä»¤ï¼šé‡Šæ”¾å¯¹äºmonitorçš„æ‰€æœ‰æƒï¼Œé‡Šæ”¾è¿‡ç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯è®²monitorçš„è®¡æ•°å™¨å‡1ï¼Œå¦‚æœå‡å®Œä»¥åï¼Œè®¡æ•°å™¨ä¸æ˜¯0ï¼Œåˆ™ä»£è¡¨åˆšæ‰æ˜¯é‡å…¥è¿›æ¥çš„ï¼Œå½“å‰çº¿ç¨‹è¿˜ç»§ç»­æŒæœ‰è¿™æŠŠé”çš„æ‰€æœ‰æƒï¼Œå¦‚æœè®¡æ•°å™¨å˜æˆ0ï¼Œåˆ™ä»£è¡¨å½“å‰çº¿ç¨‹ä¸å†æ‹¥æœ‰è¯¥monitorçš„æ‰€æœ‰æƒï¼Œå³é‡Šæ”¾é”ã€‚ ä¸‹å›¾è¡¨ç°äº†å¯¹è±¡ï¼Œå¯¹è±¡ç›‘è§†å™¨ï¼ŒåŒæ­¥é˜Ÿåˆ—ä»¥åŠæ‰§è¡Œçº¿ç¨‹çŠ¶æ€ä¹‹é—´çš„å…³ç³»ï¼š è¯¥å›¾å¯ä»¥çœ‹å‡ºï¼Œä»»æ„çº¿ç¨‹å¯¹Objectçš„è®¿é—®ï¼Œé¦–å…ˆè¦è·å¾—Objectçš„ç›‘è§†å™¨ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œè¯¥çº¿ç¨‹å°±è¿›å…¥åŒæ­¥çŠ¶æ€ï¼Œçº¿ç¨‹çŠ¶æ€å˜ä¸ºBLOCKEDï¼Œå½“Objectçš„ç›‘è§†å™¨å æœ‰è€…é‡Šæ”¾åï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­å¾—çº¿ç¨‹å°±ä¼šæœ‰æœºä¼šé‡æ–°è·å–è¯¥ç›‘è§†å™¨ã€‚ å¯é‡å…¥åŸç†ï¼šåŠ é”æ¬¡æ•°è®¡æ•°å™¨ ä»€ä¹ˆæ˜¯å¯é‡å…¥ï¼Ÿå¯é‡å…¥é”ï¼Ÿ å¯é‡å…¥ï¼šï¼ˆæ¥æºäºç»´åŸºç™¾ç§‘ï¼‰è‹¥ä¸€ä¸ªç¨‹åºæˆ–å­ç¨‹åºå¯ä»¥â€œåœ¨ä»»æ„æ—¶åˆ»è¢«ä¸­æ–­ç„¶åæ“ä½œç³»ç»Ÿè°ƒåº¦æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç åˆè°ƒç”¨äº†è¯¥å­ç¨‹åºä¸ä¼šå‡ºé”™â€ï¼Œåˆ™ç§°å…¶ä¸ºå¯é‡å…¥ï¼ˆreentrantæˆ–re-entrantï¼‰çš„ã€‚å³å½“è¯¥å­ç¨‹åºæ­£åœ¨è¿è¡Œæ—¶ï¼Œæ‰§è¡Œçº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥å¹¶æ‰§è¡Œå®ƒï¼Œä»ç„¶è·å¾—ç¬¦åˆè®¾è®¡æ—¶é¢„æœŸçš„ç»“æœã€‚ä¸å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹å®‰å…¨ä¸åŒï¼Œå¯é‡å…¥å¼ºè°ƒå¯¹å•ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶é‡æ–°è¿›å…¥åŒä¸€ä¸ªå­ç¨‹åºä»ç„¶æ˜¯å®‰å…¨çš„ã€‚ å¯é‡å…¥é”ï¼šåˆåé€’å½’é”ï¼Œæ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å…¥è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ï¼ˆå‰æé”å¯¹è±¡å¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡æˆ–è€…classï¼‰ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ã€‚ çœ‹å¦‚ä¸‹çš„ä¾‹å­ 123456789101112131415161718192021public class SynchronizedDemo &#123; public static void main(String[] args) &#123; SynchronizedDemo demo = new SynchronizedDemo(); demo.method1(); &#125; private synchronized void method1() &#123; System.out.println(Thread.currentThread().getId() + &quot;: method1()&quot;); method2(); &#125; private synchronized void method2() &#123; System.out.println(Thread.currentThread().getId()+ &quot;: method2()&quot;); method3(); &#125; private synchronized void method3() &#123; System.out.println(Thread.currentThread().getId()+ &quot;: method3()&quot;); &#125;&#125; ç»“åˆå‰æ–‡ä¸­åŠ é”å’Œé‡Šæ”¾é”çš„åŸç†ï¼Œä¸éš¾ç†è§£ï¼š æ‰§è¡Œmonitorenterè·å–é” ï¼ˆmonitorè®¡æ•°å™¨&#x3D;0ï¼Œå¯è·å–é”ï¼‰ æ‰§è¡Œmethod1()æ–¹æ³•ï¼Œmonitorè®¡æ•°å™¨+1 -&gt; 1 ï¼ˆè·å–åˆ°é”ï¼‰ æ‰§è¡Œmethod2()æ–¹æ³•ï¼Œmonitorè®¡æ•°å™¨+1 -&gt; 2 æ‰§è¡Œmethod3()æ–¹æ³•ï¼Œmonitorè®¡æ•°å™¨+1 -&gt; 3 æ‰§è¡Œmonitorexitå‘½ä»¤ method3()æ–¹æ³•æ‰§è¡Œå®Œï¼Œmonitorè®¡æ•°å™¨-1 -&gt; 2 method2()æ–¹æ³•æ‰§è¡Œå®Œï¼Œmonitorè®¡æ•°å™¨-1 -&gt; 1 method2()æ–¹æ³•æ‰§è¡Œå®Œï¼Œmonitorè®¡æ•°å™¨-1 -&gt; 0 ï¼ˆé‡Šæ”¾äº†é”ï¼‰ ï¼ˆmonitorè®¡æ•°å™¨&#x3D;0ï¼Œé”è¢«é‡Šæ”¾äº†ï¼‰ è¿™å°±æ˜¯Synchronizedçš„é‡å…¥æ€§ï¼Œå³åœ¨åŒä¸€é”ç¨‹ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªmonitorè®¡æ•°å™¨ï¼Œå½“çº¿ç¨‹è·å–è¯¥å¯¹è±¡é”åï¼Œmonitorè®¡æ•°å™¨å°±ä¼šåŠ ä¸€ï¼Œé‡Šæ”¾é”åå°±ä¼šå°†monitorè®¡æ•°å™¨å‡ä¸€ï¼Œçº¿ç¨‹ä¸éœ€è¦å†æ¬¡è·å–åŒä¸€æŠŠé”ã€‚ ä¿è¯å¯è§æ€§çš„åŸç†ï¼šå†…å­˜æ¨¡å‹å’Œhappens-beforeè§„åˆ™Synchronizedçš„happens-beforeè§„åˆ™ï¼Œå³ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹åŒä¸€ä¸ªç›‘è§†å™¨çš„è§£é”ï¼Œhappens-beforeäºå¯¹è¯¥ç›‘è§†å™¨çš„åŠ é”ã€‚ç»§ç»­æ¥çœ‹ä»£ç ï¼š 1234567891011public class MonitorDemo &#123; private int a = 0; public synchronized void writer() &#123; // 1 a++; // 2 &#125; // 3 public synchronized void reader() &#123; // 4 int i = a; // 5 &#125; // 6&#125; è¯¥ä»£ç çš„happens-beforeå…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š åœ¨å›¾ä¸­æ¯ä¸€ä¸ªç®­å¤´è¿æ¥çš„ä¸¤ä¸ªèŠ‚ç‚¹å°±ä»£è¡¨ä¹‹é—´çš„happens-beforeå…³ç³»ï¼Œé»‘è‰²çš„æ˜¯é€šè¿‡ç¨‹åºé¡ºåºè§„åˆ™æ¨å¯¼å‡ºæ¥ï¼Œçº¢è‰²çš„ä¸ºç›‘è§†å™¨é”è§„åˆ™æ¨å¯¼è€Œå‡ºï¼šçº¿ç¨‹Aé‡Šæ”¾é”happens-beforeçº¿ç¨‹BåŠ é”ï¼Œè“è‰²çš„åˆ™æ˜¯é€šè¿‡ç¨‹åºé¡ºåºè§„åˆ™å’Œç›‘è§†å™¨é”è§„åˆ™æ¨æµ‹å‡ºæ¥happens-beforå…³ç³»ï¼Œé€šè¿‡ä¼ é€’æ€§è§„åˆ™è¿›ä¸€æ­¥æ¨å¯¼çš„happens-beforeå…³ç³»ã€‚ç°åœ¨æˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨2 happens-before 5ï¼Œé€šè¿‡è¿™ä¸ªå…³ç³»æˆ‘ä»¬å¯ä»¥å¾—å‡ºä»€ä¹ˆ? æ ¹æ®happens-beforeçš„å®šä¹‰ä¸­çš„ä¸€æ¡:å¦‚æœA happens-before Bï¼Œåˆ™Açš„æ‰§è¡Œç»“æœå¯¹Bå¯è§ï¼Œå¹¶ä¸”Açš„æ‰§è¡Œé¡ºåºå…ˆäºBã€‚çº¿ç¨‹Aå…ˆå¯¹å…±äº«å˜é‡Aè¿›è¡ŒåŠ ä¸€ï¼Œç”±2 happens-before 5å…³ç³»å¯çŸ¥çº¿ç¨‹Açš„æ‰§è¡Œç»“æœå¯¹çº¿ç¨‹Bå¯è§å³çº¿ç¨‹Bæ‰€è¯»å–åˆ°çš„açš„å€¼ä¸º1ã€‚ JVMä¸­é”çš„ä¼˜åŒ–ç®€å•æ¥è¯´åœ¨JVMä¸­monitorenterå’Œmonitorexitå­—èŠ‚ç ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„Mutex Lockæ¥å®ç°çš„ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨Mutex Lockéœ€è¦å°†å½“å‰çº¿ç¨‹æŒ‚èµ·å¹¶ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ¥æ‰§è¡Œï¼Œè¿™ç§åˆ‡æ¢çš„ä»£ä»·æ˜¯éå¸¸æ˜‚è´µçš„ï¼›ç„¶è€Œåœ¨ç°å®ä¸­çš„å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒåŒæ­¥æ–¹æ³•æ˜¯è¿è¡Œåœ¨å•çº¿ç¨‹ç¯å¢ƒ(æ— é”ç«äº‰ç¯å¢ƒ)å¦‚æœæ¯æ¬¡éƒ½è°ƒç”¨Mutex Locké‚£ä¹ˆå°†ä¸¥é‡çš„å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚ä¸è¿‡åœ¨jdk1.6ä¸­å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚é”ç²—åŒ–(Lock Coarsening)ã€é”æ¶ˆé™¤(Lock Elimination)ã€è½»é‡çº§é”(Lightweight Locking)ã€åå‘é”(Biased Locking)ã€é€‚åº”æ€§è‡ªæ—‹(Adaptive Spinning)ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚ é”ç²—åŒ–(Lock Coarsening)ï¼šä¹Ÿå°±æ˜¯å‡å°‘ä¸å¿…è¦çš„ç´§è¿åœ¨ä¸€èµ·çš„unlockï¼Œlockæ“ä½œï¼Œå°†å¤šä¸ªè¿ç»­çš„é”æ‰©å±•æˆä¸€ä¸ªèŒƒå›´æ›´å¤§çš„é”ã€‚ é”æ¶ˆé™¤(Lock Elimination)ï¼šé€šè¿‡è¿è¡Œæ—¶JITç¼–è¯‘å™¨çš„é€ƒé€¸åˆ†ææ¥æ¶ˆé™¤ä¸€äº›æ²¡æœ‰åœ¨å½“å‰åŒæ­¥å—ä»¥å¤–è¢«å…¶ä»–çº¿ç¨‹å…±äº«çš„æ•°æ®çš„é”ä¿æŠ¤ï¼Œé€šè¿‡é€ƒé€¸åˆ†æä¹Ÿå¯ä»¥åœ¨çº¿ç¨‹æœ¬çš„Stackä¸Šè¿›è¡Œå¯¹è±¡ç©ºé—´çš„åˆ†é…(åŒæ—¶è¿˜å¯ä»¥å‡å°‘Heapä¸Šçš„åƒåœ¾æ”¶é›†å¼€é”€)ã€‚ è½»é‡çº§é”(Lightweight Locking)ï¼šè¿™ç§é”å®ç°çš„èƒŒååŸºäºè¿™æ ·ä¸€ç§å‡è®¾ï¼Œå³åœ¨çœŸå®çš„æƒ…å†µä¸‹æˆ‘ä»¬ç¨‹åºä¸­çš„å¤§éƒ¨åˆ†åŒæ­¥ä»£ç ä¸€èˆ¬éƒ½å¤„äºæ— é”ç«äº‰çŠ¶æ€(å³å•çº¿ç¨‹æ‰§è¡Œç¯å¢ƒ)ï¼Œåœ¨æ— é”ç«äº‰çš„æƒ…å†µä¸‹å®Œå…¨å¯ä»¥é¿å…è°ƒç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„é‡é‡çº§äº’æ–¥é”ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åœ¨monitorenterå’Œmonitorexitä¸­åªéœ€è¦ä¾é ä¸€æ¡CASåŸå­æŒ‡ä»¤å°±å¯ä»¥å®Œæˆé”çš„è·å–åŠé‡Šæ”¾ã€‚å½“å­˜åœ¨é”ç«äº‰çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡ŒCASæŒ‡ä»¤å¤±è´¥çš„çº¿ç¨‹å°†è°ƒç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é”è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ï¼Œå½“é”è¢«é‡Šæ”¾çš„æ—¶å€™è¢«å”¤é†’(å…·ä½“å¤„ç†æ­¥éª¤ä¸‹é¢è¯¦ç»†è®¨è®º)ã€‚ åå‘é”(Biased Locking)ï¼šæ˜¯ä¸ºäº†åœ¨æ— é”ç«äº‰çš„æƒ…å†µä¸‹é¿å…åœ¨é”è·å–è¿‡ç¨‹ä¸­æ‰§è¡Œä¸å¿…è¦çš„CASåŸå­æŒ‡ä»¤ï¼Œå› ä¸ºCASåŸå­æŒ‡ä»¤è™½ç„¶ç›¸å¯¹äºé‡é‡çº§é”æ¥è¯´å¼€é”€æ¯”è¾ƒå°ä½†è¿˜æ˜¯å­˜åœ¨éå¸¸å¯è§‚çš„æœ¬åœ°å»¶è¿Ÿã€‚ é€‚åº”æ€§è‡ªæ—‹(Adaptive Spinning)ï¼šå½“çº¿ç¨‹åœ¨è·å–è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­æ‰§è¡ŒCASæ“ä½œå¤±è´¥æ—¶ï¼Œåœ¨è¿›å…¥ä¸monitorç›¸å…³è”çš„æ“ä½œç³»ç»Ÿé‡é‡çº§é”(mutex semaphore)å‰ä¼šè¿›å…¥å¿™ç­‰å¾…(Spinning)ç„¶åå†æ¬¡å°è¯•ï¼Œå½“å°è¯•ä¸€å®šçš„æ¬¡æ•°åå¦‚æœä»ç„¶æ²¡æœ‰æˆåŠŸåˆ™è°ƒç”¨ä¸è¯¥monitorå…³è”çš„semaphore(å³äº’æ–¥é”)è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚ ä¸‹é¢æ¥è¯¦ç»†è®²è§£ä¸‹ï¼Œå…ˆä»SynchroniedåŒæ­¥é”å¼€å§‹è®²èµ·ï¼š é”çš„ç±»å‹åœ¨Java SE 1.6é‡ŒSynchroniedåŒæ­¥é”ï¼Œä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼šæ— é”ã€åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ï¼Œå®ƒä¼šéšç€ç«äº‰æƒ…å†µé€æ¸å‡çº§ã€‚é”å¯ä»¥å‡çº§ä½†æ˜¯ä¸å¯ä»¥é™çº§ï¼Œç›®çš„æ˜¯ä¸ºäº†æä¾›è·å–é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚ é”è†¨èƒ€æ–¹å‘ï¼š æ— é” â†’ åå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é” (æ­¤è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„) è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹é”è‡ªæ—‹é” å¼•å…¥èƒŒæ™¯ï¼šå¤§å®¶éƒ½çŸ¥é“ï¼Œåœ¨æ²¡æœ‰åŠ å…¥é”ä¼˜åŒ–æ—¶ï¼ŒSynchronizedæ˜¯ä¸€ä¸ªéå¸¸â€œèƒ–å¤§â€çš„å®¶ä¼™ã€‚åœ¨å¤šçº¿ç¨‹ç«äº‰é”æ—¶ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼Œå®ƒä¼šé˜»å¡æ‰€æœ‰æ­£åœ¨ç«äº‰çš„çº¿ç¨‹ï¼Œè¿™æ ·å¯¹æ€§èƒ½å¸¦æ¥äº†æå¤§çš„å½±å“ã€‚åœ¨æŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€ä¸­å®Œæˆï¼Œè¿™äº›æ“ä½œå¯¹ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›ã€‚åŒæ—¶HotSpotå›¢é˜Ÿæ³¨æ„åˆ°åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»æŒ‚èµ·å’Œå›å¤é˜»å¡çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚åœ¨å¦‚ä»Šå¤šå¤„ç†å™¨ç¯å¢ƒä¸‹ï¼Œå®Œå…¨å¯ä»¥è®©å¦ä¸€ä¸ªæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹åœ¨é—¨å¤–ç­‰å¾…ä¸€ä¼š(è‡ªæ—‹)ï¼Œä½†ä¸æ”¾å¼ƒCPUçš„æ‰§è¡Œæ—¶é—´ã€‚ç­‰å¾…æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…ï¼Œæˆ‘ä»¬åªéœ€è¦è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯(è‡ªæ—‹)ï¼Œè¿™ä¾¿æ˜¯è‡ªæ—‹é”ç”±æ¥çš„åŸå› ã€‚ è‡ªæ—‹é”æ—©åœ¨JDK1.4 ä¸­å°±å¼•å…¥äº†ï¼Œåªæ˜¯å½“æ—¶é»˜è®¤æ—¶å…³é—­çš„ã€‚åœ¨JDK 1.6åé»˜è®¤ä¸ºå¼€å¯çŠ¶æ€ã€‚è‡ªæ—‹é”æœ¬è´¨ä¸Šä¸é˜»å¡å¹¶ä¸ç›¸åŒï¼Œå…ˆä¸è€ƒè™‘å…¶å¯¹å¤šå¤„ç†å™¨çš„è¦æ±‚ï¼Œå¦‚æœé”å ç”¨çš„æ—¶é—´éå¸¸çš„çŸ­ï¼Œé‚£ä¹ˆè‡ªæ—‹é”çš„æ€§èƒ½ä¼šéå¸¸çš„å¥½ï¼Œç›¸åï¼Œå…¶ä¼šå¸¦æ¥æ›´å¤šçš„æ€§èƒ½å¼€é”€(å› ä¸ºåœ¨çº¿ç¨‹è‡ªæ—‹æ—¶ï¼Œå§‹ç»ˆä¼šå ç”¨CPUçš„æ—¶é—´ç‰‡ï¼Œå¦‚æœé”å ç”¨çš„æ—¶é—´å¤ªé•¿ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹ä¼šç™½ç™½æ¶ˆè€—æ‰CPUèµ„æº)ã€‚å› æ­¤è‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å–åˆ°é”ï¼Œå°±åº”è¯¥ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼å»æŒ‚èµ·çº¿ç¨‹äº†ï¼Œåœ¨JDKå®šä¹‰ä¸­ï¼Œè‡ªæ—‹é”é»˜è®¤çš„è‡ªæ—‹æ¬¡æ•°ä¸º10æ¬¡ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å‚æ•°-XX:PreBlockSpinæ¥æ›´æ”¹ã€‚ å¯æ˜¯ç°åœ¨åˆå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœçº¿ç¨‹é”åœ¨çº¿ç¨‹è‡ªæ—‹åˆšç»“æŸå°±é‡Šæ”¾æ‰äº†é”ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯æœ‰ç‚¹å¾—ä¸å¿å¤±ã€‚æ‰€ä»¥è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦æ›´åŠ èªæ˜çš„é”æ¥å®ç°æ›´åŠ çµæ´»çš„è‡ªæ—‹ã€‚æ¥æé«˜å¹¶å‘çš„æ€§èƒ½ã€‚(è¿™é‡Œåˆ™éœ€è¦è‡ªé€‚åº”è‡ªæ—‹é”ï¼) è‡ªé€‚åº”è‡ªæ—‹é” åœ¨JDK 1.6ä¸­å¼•å…¥äº†è‡ªé€‚åº”è‡ªæ—‹é”ã€‚è¿™å°±æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹ æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šçš„ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…åˆšåˆšæˆåŠŸè·å–è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆJVMä¼šè®¤ä¸ºè¯¥é”è‡ªæ—‹è·å–åˆ°é”çš„å¯èƒ½æ€§å¾ˆå¤§ï¼Œä¼šè‡ªåŠ¨å¢åŠ ç­‰å¾…æ—¶é—´ã€‚æ¯”å¦‚å¢åŠ åˆ°100æ­¤å¾ªç¯ã€‚ç›¸åï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å–é”ã€‚é‚£å†ä»¥åè¦è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼ŒJVMå¯¹ç¨‹åºçš„é”çš„çŠ¶æ€é¢„æµ‹ä¼šè¶Šæ¥è¶Šå‡†ç¡®ï¼ŒJVMä¹Ÿä¼šè¶Šæ¥è¶Šèªæ˜ã€‚ é”æ¶ˆé™¤é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨å†è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤å®šä¾æ®æ¥æºäºé€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒã€‚æ„æ€å°±æ˜¯ï¼šJVMä¼šåˆ¤æ–­å†ä¸€æ®µç¨‹åºä¸­çš„åŒæ­¥æ˜æ˜¾ä¸ä¼šé€ƒé€¸å‡ºå»ä»è€Œè¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£JVMå°±æŠŠå®ƒä»¬å½“ä½œæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºè¿™äº›æ•°æ®æ˜¯çº¿ç¨‹ç‹¬æœ‰çš„ï¼Œä¸éœ€è¦åŠ åŒæ­¥ã€‚æ­¤æ—¶å°±ä¼šè¿›è¡Œé”æ¶ˆé™¤ã€‚ å½“ç„¶åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾ˆæ¸…æ¥šçš„çŸ¥é“å“ªäº›æ˜¯çº¿ç¨‹ç‹¬æœ‰çš„ï¼Œä¸éœ€è¦åŠ åŒæ­¥é”ï¼Œä½†æ˜¯åœ¨Java APIä¸­æœ‰å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯åŠ äº†åŒæ­¥çš„ï¼Œé‚£ä¹ˆæ­¤æ—¶JVMä¼šåˆ¤æ–­è¿™æ®µä»£ç æ˜¯å¦éœ€è¦åŠ é”ã€‚å¦‚æœæ•°æ®å¹¶ä¸ä¼šé€ƒé€¸ï¼Œåˆ™ä¼šè¿›è¡Œé”æ¶ˆé™¤ã€‚æ¯”å¦‚å¦‚ä¸‹æ“ä½œï¼šåœ¨æ“ä½œStringç±»å‹æ•°æ®æ—¶ï¼Œç”±äºStringæ˜¯ä¸€ä¸ªä¸å¯å˜ç±»ï¼Œå¯¹å­—ç¬¦ä¸²çš„è¿æ¥æ“ä½œæ€»æ˜¯é€šè¿‡ç”Ÿæˆçš„æ–°çš„Stringå¯¹è±¡æ¥è¿›è¡Œçš„ã€‚å› æ­¤Javacç¼–è¯‘å™¨ä¼šå¯¹Stringè¿æ¥åšè‡ªåŠ¨ä¼˜åŒ–ã€‚åœ¨JDK 1.5ä¹‹å‰ä¼šä½¿ç”¨StringBufferå¯¹è±¡çš„è¿ç»­append()æ“ä½œï¼Œåœ¨JDK 1.5åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œä¼šè½¬åŒ–ä¸ºStringBuidlerå¯¹è±¡çš„è¿ç»­append()æ“ä½œã€‚ 1234public static String test03(String s1, String s2, String s3) &#123; String s = s1 + s2 + s3; return s;&#125; ä¸Šè¿°ä»£ç ä½¿ç”¨javap ç¼–è¯‘ç»“æœ ä¼—æ‰€å‘¨çŸ¥ï¼ŒStringBuilderä¸æ˜¯å®‰å…¨åŒæ­¥çš„ï¼Œä½†æ˜¯åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼ŒJVMåˆ¤æ–­è¯¥æ®µä»£ç å¹¶ä¸ä¼šé€ƒé€¸ï¼Œåˆ™å°†è¯¥ä»£ç å¸¦é»˜è®¤ä¸ºçº¿ç¨‹ç‹¬æœ‰çš„èµ„æºï¼Œå¹¶ä¸éœ€è¦åŒæ­¥ï¼Œæ‰€ä»¥æ‰§è¡Œäº†é”æ¶ˆé™¤æ“ä½œã€‚(è¿˜æœ‰Vectorä¸­çš„å„ç§æ“ä½œä¹Ÿå¯å®ç°é”æ¶ˆé™¤ã€‚åœ¨æ²¡æœ‰é€ƒé€¸å‡ºæ•°æ®å®‰å…¨é˜²å«å†…) é”ç²—åŒ–åŸåˆ™ä¸Šï¼Œæˆ‘ä»¬éƒ½çŸ¥é“åœ¨åŠ åŒæ­¥é”æ—¶ï¼Œå°½å¯èƒ½çš„å°†åŒæ­¥å—çš„ä½œç”¨èŒƒå›´é™åˆ¶åˆ°å°½é‡å°çš„èŒƒå›´(åªåœ¨å…±äº«æ•°æ®çš„å®é™…ä½œç”¨åŸŸä¸­æ‰è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä½¿å¾—éœ€è¦åŒæ­¥çš„æ“ä½œæ•°é‡å°½å¯èƒ½å˜å°ã€‚åœ¨å­˜åœ¨é”åŒæ­¥ç«äº‰ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿å¾—ç­‰å¾…é”çš„çº¿ç¨‹å°½æ—©çš„æ‹¿åˆ°é”)ã€‚ å¤§éƒ¨åˆ†ä¸Šè¿°æƒ…å†µæ˜¯å®Œç¾æ­£ç¡®çš„ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨è¿ä¸²çš„ä¸€ç³»åˆ—æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ—¶å‡ºç°åœ¨å¾ªç¯ä½“ä¸­çš„ï¼Œé‚£å³ä½¿æ²¡æœ‰çº¿ç¨‹ç«äº‰ï¼Œé¢‘ç¹çš„è¿›è¡Œäº’æ–¥åŒæ­¥æ“ä½œä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æ“ä½œã€‚ è¿™é‡Œè´´ä¸Šæ ¹æ®ä¸Šè¿°Javap ç¼–è¯‘çš„æƒ…å†µç¼–å†™çš„å®ä¾‹javaç±» 1234567public static String test04(String s1, String s2, String s3) &#123; StringBuffer sb = new StringBuffer(); sb.append(s1); sb.append(s2); sb.append(s3); return sb.toString();&#125; åœ¨ä¸Šè¿°çš„è¿ç»­append()æ“ä½œä¸­å°±å±äºè¿™ç±»æƒ…å†µã€‚JVMä¼šæ£€æµ‹åˆ°è¿™æ ·ä¸€è¿ä¸²çš„æ“ä½œéƒ½æ˜¯å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œé‚£ä¹ˆJVMä¼šå°†åŠ é”åŒæ­¥çš„èŒƒå›´æ‰©å±•(ç²—åŒ–)åˆ°æ•´ä¸ªä¸€ç³»åˆ—æ“ä½œçš„ å¤–éƒ¨ï¼Œä½¿æ•´ä¸ªä¸€è¿ä¸²çš„append()æ“ä½œåªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚ è½»é‡çº§é”åœ¨JDK 1.6ä¹‹åå¼•å…¥çš„è½»é‡çº§é”ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è½»é‡çº§é”å¹¶ä¸æ˜¯æ›¿ä»£é‡é‡çº§é”çš„ï¼Œè€Œæ˜¯å¯¹åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åŒæ­¥å—å¹¶ä¸ä¼šæœ‰ç«äº‰å‡ºç°æå‡ºçš„ä¸€ç§ä¼˜åŒ–ã€‚å®ƒå¯ä»¥å‡å°‘é‡é‡çº§é”å¯¹çº¿ç¨‹çš„é˜»å¡å¸¦æ¥çš„çº¿ç¨‹å¼€é”€ã€‚ä»è€Œæé«˜å¹¶å‘æ€§èƒ½ã€‚ å¦‚æœè¦ç†è§£è½»é‡çº§é”ï¼Œé‚£ä¹ˆå¿…é¡»å…ˆè¦äº†è§£HotSpotè™šæ‹Ÿæœºä¸­å¯¹è±¡å¤´çš„å†…å­˜å¸ƒå±€ã€‚ä¸Šé¢ä»‹ç»Javaå¯¹è±¡å¤´ä¹Ÿè¯¦ç»†ä»‹ç»è¿‡ã€‚åœ¨å¯¹è±¡å¤´ä¸­(Object Header)å­˜åœ¨ä¸¤éƒ¨åˆ†ã€‚ç¬¬ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼ŒHashCodeã€GC Ageã€é”æ ‡è®°ä½ã€æ˜¯å¦ä¸ºåå‘é”ã€‚ç­‰ã€‚ä¸€èˆ¬ä¸º32ä½æˆ–è€…64ä½(è§†æ“ä½œç³»ç»Ÿä½æ•°å®š)ã€‚å®˜æ–¹ç§°ä¹‹ä¸ºMark Wordï¼Œå®ƒæ˜¯å®ç°è½»é‡çº§é”å’Œåå‘é”çš„å…³é”®ã€‚ å¦å¤–ä¸€éƒ¨åˆ†å­˜å‚¨çš„æ˜¯æŒ‡å‘æ–¹æ³•åŒºå¯¹è±¡ç±»å‹æ•°æ®çš„æŒ‡é’ˆ(Klass Point)ï¼Œå¦‚æœå¯¹è±¡æ˜¯æ•°ç»„çš„è¯ï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„éƒ¨åˆ†ç”¨äºå­˜å‚¨æ•°æ®çš„é•¿åº¦ã€‚ è½»é‡çº§é”åŠ é”åœ¨çº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVMä¼šå…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºé”è®°å½•(Lock Record)çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´(JVMä¼šå°†å¯¹è±¡å¤´ä¸­çš„Mark Wordæ‹·è´åˆ°é”è®°å½•ä¸­ï¼Œå®˜æ–¹ç§°ä¸ºDisplaced Mark Ward)è¿™ä¸ªæ—¶å€™çº¿ç¨‹å †æ ˆä¸å¯¹è±¡å¤´çš„çŠ¶æ€å¦‚å›¾ï¼š å¦‚ä¸Šå›¾æ‰€ç¤ºï¼šå¦‚æœå½“å‰å¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œé‚£ä¹ˆé”æ ‡å¿—ä½ä¸º01çŠ¶æ€ï¼ŒJVMåœ¨æ‰§è¡Œå½“å‰çº¿ç¨‹æ—¶ï¼Œé¦–å…ˆä¼šåœ¨å½“å‰çº¿ç¨‹æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•Lock Recordçš„ç©ºé—´ç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ã€‚ ç„¶åï¼Œè™šæ‹Ÿæœºä½¿ç”¨CASæ“ä½œå°†æ ‡è®°å­—æ®µMark Wordæ‹·è´åˆ°é”è®°å½•ä¸­ï¼Œå¹¶ä¸”å°†Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆã€‚å¦‚æœæ›´æ–°æˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥ç”¨äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡Mark Wordçš„é”æ ‡å¿—ä½æ›´æ–°ä¸º(Mark Wordä¸­æœ€åçš„2bit)00ï¼Œå³è¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é”å®šçŠ¶æ€ï¼Œå¦‚å›¾ï¼š å¦‚æœè¿™ä¸ªæ›´æ–°æ“ä½œå¤±è´¥ï¼ŒJVMä¼šæ£€æŸ¥å½“å‰çš„Mark Wordä¸­æ˜¯å¦å­˜åœ¨æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§çš„æŒ‡é’ˆï¼Œå¦‚æœæœ‰ï¼Œè¯´æ˜è¯¥é”å·²ç»è¢«è·å–ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¯´æ˜è¯¥é”è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ï¼Œå¦‚æœæœ‰ä¸¤æ¡ä»¥ä¸Šçš„çº¿ç¨‹ç«äº‰åŒä¸€ä¸ªé”ï¼Œé‚£è½»é‡çº§é”å°±ä¸å†æœ‰æ•ˆï¼Œç›´æ¥è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œæ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚æ­¤æ—¶ï¼Œé”çš„æ ‡å¿—ä½ä¸º10.Mark Wordä¸­å­˜å‚¨çš„æŒ‡å‘é‡é‡çº§é”çš„æŒ‡é’ˆã€‚ è½»é‡çº§è§£é”æ—¶ï¼Œä¼šä½¿ç”¨åŸå­çš„CASæ“ä½œå°†Displaced Mark Wordæ›¿æ¢å›åˆ°å¯¹è±¡å¤´ä¸­ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰å‘ç”Ÿç«äº‰å…³ç³»ã€‚å¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå½“å‰é”å­˜åœ¨ç«äº‰å…³ç³»ã€‚é”å°±ä¼šè†¨èƒ€æˆé‡é‡çº§é”ã€‚ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶äº‰å¤ºé”ï¼Œå¯¼è‡´é”è†¨èƒ€çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š åå‘é” å¼•å…¥èƒŒæ™¯ï¼šåœ¨å¤§å¤šå®é™…ç¯å¢ƒä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ï¼Œé‚£ä¹ˆåœ¨åŒä¸€ä¸ªçº¿ç¨‹åå¤è·å–æ‰€é‡Šæ”¾é”ä¸­ï¼Œå…¶ä¸­å¹¶è¿˜æ²¡æœ‰é”çš„ç«äº‰ï¼Œé‚£ä¹ˆè¿™æ ·çœ‹ä¸Šå»ï¼Œå¤šæ¬¡çš„è·å–é”å’Œé‡Šæ”¾é”å¸¦æ¥äº†å¾ˆå¤šä¸å¿…è¦çš„æ€§èƒ½å¼€é”€å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒHotSpotçš„ä½œè€…åœ¨Java SE 1.6 ä¸­å¯¹Synchronizedè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¼•å…¥äº†åå‘é”ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—å¹¶è·å–é”æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´å’Œæ ˆå¸§ä¸­çš„é”è®°å½•é‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹IDï¼Œä»¥åè¯¥çº¿ç¨‹åœ¨è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ä¸éœ€è¦è¿›è¡ŒCASæ“ä½œæ¥åŠ é”å’Œè§£é”ã€‚åªéœ€è¦ç®€å•çš„æµ‹è¯•ä¸€ä¸‹å¯¹è±¡å¤´çš„Mark Wordé‡Œæ˜¯å¦å­˜å‚¨ç€æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚å¦‚æœæˆåŠŸï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»è·å–åˆ°äº†é”ã€‚ åå‘é”çš„æ’¤é”€ åå‘é”ä½¿ç”¨äº†ä¸€ç§ç­‰å¾…ç«äº‰å‡ºç°æ‰ä¼šé‡Šæ”¾é”çš„æœºåˆ¶ã€‚æ‰€ä»¥å½“å…¶ä»–çº¿ç¨‹å°è¯•è·å–åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ã€‚ä½†æ˜¯åå‘é”çš„æ’¤é”€éœ€è¦ç­‰åˆ°å…¨å±€å®‰å…¨ç‚¹(å°±æ˜¯å½“å‰çº¿ç¨‹æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç )ã€‚å®ƒä¼šé¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œè®©ä½ åæ£€æŸ¥æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦æ´»ç€ã€‚å¦‚æœçº¿ç¨‹ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç›´æ¥å°†å¯¹è±¡å¤´è®¾ç½®ä¸ºæ— é”çŠ¶æ€ã€‚å¦‚æœçº¿ç¨‹æ´»ç€ï¼ŒJVMä¼šéå†æ ˆå¸§ä¸­çš„é”è®°å½•ï¼Œæ ˆå¸§ä¸­çš„é”è®°å½•å’Œå¯¹è±¡å¤´è¦ä¹ˆåå‘äºå…¶ä»–çº¿ç¨‹ï¼Œè¦ä¹ˆæ¢å¤åˆ°æ— é”çŠ¶æ€æˆ–è€…æ ‡è®°å¯¹è±¡ä¸é€‚åˆä½œä¸ºåå‘é”ã€‚ é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯” é” ä¼˜ç‚¹ ç¼ºç‚¹ ä½¿ç”¨åœºæ™¯ åå‘é” åŠ é”å’Œè§£é”ä¸éœ€è¦CASæ“ä½œï¼Œæ²¡æœ‰é¢å¤–çš„æ€§èƒ½æ¶ˆè€—ï¼Œå’Œæ‰§è¡ŒéåŒæ­¥æ–¹æ³•ç›¸æ¯”ä»…å­˜åœ¨çº³ç§’çº§çš„å·®è· å¦‚æœçº¿ç¨‹é—´å­˜åœ¨é”ç«äº‰ï¼Œä¼šå¸¦æ¥é¢å¤–çš„é”æ’¤é”€çš„æ¶ˆè€— é€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—çš„åœºæ™¯ è½»é‡çº§é” ç«äº‰çš„çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ å¦‚çº¿ç¨‹å§‹ç»ˆå¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ï¼Œä½¿ç”¨è‡ªæ—‹ä¼šæ¶ˆè€—CPUæ€§èƒ½ è¿½æ±‚å“åº”æ—¶é—´ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦éå¸¸å¿« é‡é‡çº§é” çº¿ç¨‹ç«äº‰ä¸é€‚ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€—CPU çº¿ç¨‹é˜»å¡ï¼Œå“åº”æ—¶é—´ç¼“æ…¢ï¼Œåœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œé¢‘ç¹çš„è·å–é‡Šæ”¾é”ï¼Œä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æ¶ˆè€— è¿½æ±‚ååé‡ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦è¾ƒé•¿ Synchronizedä¸Locksynchronizedçš„ç¼ºé™· æ•ˆç‡ä½ï¼šé”çš„é‡Šæ”¾æƒ…å†µå°‘ï¼Œåªæœ‰ä»£ç æ‰§è¡Œå®Œæ¯•æˆ–è€…å¼‚å¸¸ç»“æŸæ‰ä¼šé‡Šæ”¾é”ï¼›è¯•å›¾è·å–é”çš„æ—¶å€™ä¸èƒ½è®¾å®šè¶…æ—¶ï¼Œä¸èƒ½ä¸­æ–­ä¸€ä¸ªæ­£åœ¨ä½¿ç”¨é”çš„çº¿ç¨‹ï¼Œç›¸å¯¹è€Œè¨€ï¼ŒLockå¯ä»¥ä¸­æ–­å’Œè®¾ç½®è¶…æ—¶ ä¸å¤Ÿçµæ´»ï¼šåŠ é”å’Œé‡Šæ”¾çš„æ—¶æœºå•ä¸€ï¼Œæ¯ä¸ªé”ä»…æœ‰ä¸€ä¸ªå•ä¸€çš„æ¡ä»¶(æŸä¸ªå¯¹è±¡)ï¼Œç›¸å¯¹è€Œè¨€ï¼Œè¯»å†™é”æ›´åŠ çµæ´» æ— æ³•çŸ¥é“æ˜¯å¦æˆåŠŸè·å¾—é”ï¼Œç›¸å¯¹è€Œè¨€ï¼ŒLockå¯ä»¥æ‹¿åˆ°çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸè·å–é”ï¼Œâ€¦.ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œâ€¦.. Lockè§£å†³ç›¸åº”é—®é¢˜Lockç±»è¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šï¼Œä¸»è¦çœ‹é‡Œé¢çš„4ä¸ªæ–¹æ³•: lock(): åŠ é” unlock(): è§£é” tryLock(): å°è¯•è·å–é”ï¼Œè¿”å›ä¸€ä¸ªbooleanå€¼ tryLock(long,TimeUtil): å°è¯•è·å–é”ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶ SynchronizedåŠ é”åªä¸ä¸€ä¸ªæ¡ä»¶(æ˜¯å¦è·å–é”)ç›¸å…³è”ï¼Œä¸çµæ´»ï¼Œåæ¥Conditionä¸Lockçš„ç»“åˆè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ å¤šçº¿ç¨‹ç«äº‰ä¸€ä¸ªé”æ—¶ï¼Œå…¶ä½™æœªå¾—åˆ°é”çš„çº¿ç¨‹åªèƒ½ä¸åœçš„å°è¯•è·å¾—é”ï¼Œè€Œä¸èƒ½ä¸­æ–­ã€‚é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ReentrantLockçš„lockInterruptibly()æ–¹æ³•å¯ä»¥ä¼˜å…ˆè€ƒè™‘å“åº”ä¸­æ–­ã€‚ ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œå®ƒå¯ä»¥ä¸­æ–­è‡ªå·±ï¼Œç„¶åReentrantLockå“åº”è¿™ä¸ªä¸­æ–­ï¼Œä¸å†è®©è¿™ä¸ªçº¿ç¨‹ç»§ç»­ç­‰å¾…ã€‚æœ‰äº†è¿™ä¸ªæœºåˆ¶ï¼Œä½¿ç”¨ReentrantLockæ—¶å°±ä¸ä¼šåƒsynchronizedé‚£æ ·äº§ç”Ÿæ­»é”äº†ã€‚ ReentrantLockä¸ºå¸¸ç”¨ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„äº’æ–¥é” Lockï¼Œå®ƒå…·æœ‰ä¸ä½¿ç”¨ synchronized æ–¹æ³•å’Œè¯­å¥æ‰€è®¿é—®çš„éšå¼ç›‘è§†å™¨é”ç›¸åŒçš„ä¸€äº›åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ã€‚è¯¦ç»†åˆ†æè¯·çœ‹: JUCé”: ReentrantLockè¯¦è§£ å†æ·±å…¥ç†è§£synchronizedæ˜¯é€šè¿‡è½¯ä»¶(JVM)å®ç°çš„ï¼Œç®€å•æ˜“ç”¨ï¼Œå³ä½¿åœ¨JDK5ä¹‹åæœ‰äº†Lockï¼Œä»ç„¶è¢«å¹¿æ³›çš„ä½¿ç”¨ã€‚ ä½¿ç”¨Synchronizedæœ‰å“ªäº›è¦æ³¨æ„çš„ï¼Ÿ é”å¯¹è±¡ä¸èƒ½ä¸ºç©ºï¼Œå› ä¸ºé”çš„ä¿¡æ¯éƒ½ä¿å­˜åœ¨å¯¹è±¡å¤´é‡Œ ä½œç”¨åŸŸä¸å®œè¿‡å¤§ï¼Œå½±å“ç¨‹åºæ‰§è¡Œçš„é€Ÿåº¦ï¼Œæ§åˆ¶èŒƒå›´è¿‡å¤§ï¼Œç¼–å†™ä»£ç ä¹Ÿå®¹æ˜“å‡ºé”™ é¿å…æ­»é” åœ¨èƒ½é€‰æ‹©çš„æƒ…å†µä¸‹ï¼Œæ—¢ä¸è¦ç”¨Lockä¹Ÿä¸è¦ç”¨synchronizedå…³é”®å­—ï¼Œç”¨java.util.concurrentåŒ…ä¸­çš„å„ç§å„æ ·çš„ç±»ï¼Œå¦‚æœä¸ç”¨è¯¥åŒ…ä¸‹çš„ç±»ï¼Œåœ¨æ»¡è¶³ä¸šåŠ¡çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨synchronizedå…³é”®ï¼Œå› ä¸ºä»£ç é‡å°‘ï¼Œé¿å…å‡ºé”™ synchronizedæ˜¯å…¬å¹³é”å—ï¼Ÿ synchronizedå®é™…ä¸Šæ˜¯éå…¬å¹³çš„ï¼Œæ–°æ¥çš„çº¿ç¨‹æœ‰å¯èƒ½ç«‹å³è·å¾—ç›‘è§†å™¨ï¼Œè€Œåœ¨ç­‰å¾…åŒºä¸­ç­‰å€™å·²ä¹…çš„çº¿ç¨‹å¯èƒ½å†æ¬¡ç­‰å¾…ï¼Œè¿™æ ·æœ‰åˆ©äºæé«˜æ€§èƒ½ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´é¥¥é¥¿ç°è±¡ã€‚ å‚è€ƒæ–‡ç« +ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ +ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ https://juejin.im/post/5ae6dc04f265da0ba351d3ff https://www.cnblogs.com/javaminer/p/3889023.html https://www.jianshu.com/p/dab7745c0954 https://www.cnblogs.com/wuchaodzxx/p/6867546.html https://www.cnblogs.com/xyabk/p/10901291.html https://www.jianshu.com/p/64240319ed60","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"]},{"title":"4.Javaå¹¶å‘ - Javaä¸­æ‰€æœ‰çš„é”","path":"/2023/12/25/4-Javaå¹¶å‘-Javaä¸­æ‰€æœ‰çš„é”/","content":"Javaæä¾›äº†ç§ç±»ä¸°å¯Œçš„é”ï¼Œæ¯ç§é”å› å…¶ç‰¹æ€§çš„ä¸åŒï¼Œåœ¨é€‚å½“çš„åœºæ™¯ä¸‹èƒ½å¤Ÿå±•ç°å‡ºéå¸¸é«˜çš„æ•ˆç‡ã€‚æœ¬æ–‡æ—¨åœ¨å¯¹é”ç›¸å…³æºç ï¼ˆæœ¬æ–‡ä¸­çš„æºç æ¥è‡ªJDK 8å’ŒNetty 3.10.6ï¼‰ã€ä½¿ç”¨åœºæ™¯è¿›è¡Œä¸¾ä¾‹ï¼Œä¸ºè¯»è€…ä»‹ç»ä¸»æµé”çš„çŸ¥è¯†ç‚¹ï¼Œä»¥åŠä¸åŒçš„é”çš„é€‚ç”¨åœºæ™¯ã€‚ å‰è¨€Javaæä¾›äº†ç§ç±»ä¸°å¯Œçš„é”ï¼Œæ¯ç§é”å› å…¶ç‰¹æ€§çš„ä¸åŒï¼Œåœ¨é€‚å½“çš„åœºæ™¯ä¸‹èƒ½å¤Ÿå±•ç°å‡ºéå¸¸é«˜çš„æ•ˆç‡ã€‚æœ¬æ–‡æ—¨åœ¨å¯¹é”ç›¸å…³æºç ï¼ˆæœ¬æ–‡ä¸­çš„æºç æ¥è‡ªJDK 8å’ŒNetty 3.10.6ï¼‰ã€ä½¿ç”¨åœºæ™¯è¿›è¡Œä¸¾ä¾‹ï¼Œä¸ºè¯»è€…ä»‹ç»ä¸»æµé”çš„çŸ¥è¯†ç‚¹ï¼Œä»¥åŠä¸åŒçš„é”çš„é€‚ç”¨åœºæ™¯ã€‚ Javaä¸­å¾€å¾€æ˜¯æŒ‰ç…§æ˜¯å¦å«æœ‰æŸä¸€ç‰¹æ€§æ¥å®šä¹‰é”ï¼Œæˆ‘ä»¬é€šè¿‡ç‰¹æ€§å°†é”è¿›è¡Œåˆ†ç»„å½’ç±»ï¼Œå†ä½¿ç”¨å¯¹æ¯”çš„æ–¹å¼è¿›è¡Œä»‹ç»ï¼Œå¸®åŠ©å¤§å®¶æ›´å¿«æ·çš„ç†è§£ç›¸å…³çŸ¥è¯†ã€‚ä¸‹é¢ç»™å‡ºæœ¬æ–‡å†…å®¹çš„æ€»ä½“åˆ†ç±»ç›®å½•ï¼š 1. ä¹è§‚é” VS æ‚²è§‚é” ä¹è§‚é”ä¸æ‚²è§‚é”æ˜¯ä¸€ç§å¹¿ä¹‰ä¸Šçš„æ¦‚å¿µï¼Œä½“ç°äº†çœ‹å¾…çº¿ç¨‹åŒæ­¥çš„ä¸åŒè§’åº¦ã€‚åœ¨Javaå’Œæ•°æ®åº“ä¸­éƒ½æœ‰æ­¤æ¦‚å¿µå¯¹åº”çš„å®é™…åº”ç”¨ã€‚ å…ˆè¯´æ¦‚å¿µã€‚å¯¹äºåŒä¸€ä¸ªæ•°æ®çš„å¹¶å‘æ“ä½œï¼Œæ‚²è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®çš„æ—¶å€™ä¸€å®šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®ï¼Œå› æ­¤åœ¨è·å–æ•°æ®çš„æ—¶å€™ä¼šå…ˆåŠ é”ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ã€‚Javaä¸­ï¼Œsynchronizedå…³é”®å­—å’ŒLockçš„å®ç°ç±»éƒ½æ˜¯æ‚²è§‚é”ã€‚ è€Œä¹è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®æ—¶ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šæ·»åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å»åˆ¤æ–­ä¹‹å‰æœ‰æ²¡æœ‰åˆ«çš„çº¿ç¨‹æ›´æ–°äº†è¿™ä¸ªæ•°æ®ã€‚å¦‚æœè¿™ä¸ªæ•°æ®æ²¡æœ‰è¢«æ›´æ–°ï¼Œå½“å‰çº¿ç¨‹å°†è‡ªå·±ä¿®æ”¹çš„æ•°æ®æˆåŠŸå†™å…¥ã€‚å¦‚æœæ•°æ®å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°ï¼Œåˆ™æ ¹æ®ä¸åŒçš„å®ç°æ–¹å¼æ‰§è¡Œä¸åŒçš„æ“ä½œï¼ˆä¾‹å¦‚æŠ¥é”™æˆ–è€…è‡ªåŠ¨é‡è¯•ï¼‰ã€‚ ä¹è§‚é”åœ¨Javaä¸­æ˜¯é€šè¿‡ä½¿ç”¨æ— é”ç¼–ç¨‹æ¥å®ç°ï¼Œæœ€å¸¸é‡‡ç”¨çš„æ˜¯CASç®—æ³•ï¼ŒJavaåŸå­ç±»ä¸­çš„é€’å¢æ“ä½œå°±é€šè¿‡CASè‡ªæ—‹å®ç°çš„ã€‚ æ ¹æ®ä»ä¸Šé¢çš„æ¦‚å¿µæè¿°æˆ‘ä»¬å¯ä»¥å‘ç°ï¼š æ‚²è§‚é”é€‚åˆå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œå…ˆåŠ é”å¯ä»¥ä¿è¯å†™æ“ä½œæ—¶æ•°æ®æ­£ç¡®ã€‚ ä¹è§‚é”é€‚åˆè¯»æ“ä½œå¤šçš„åœºæ™¯ï¼Œä¸åŠ é”çš„ç‰¹ç‚¹èƒ½å¤Ÿä½¿å…¶è¯»æ“ä½œçš„æ€§èƒ½å¤§å¹…æå‡ã€‚ å…‰è¯´æ¦‚å¿µæœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¹è§‚é”å’Œæ‚²è§‚é”çš„è°ƒç”¨æ–¹å¼ç¤ºä¾‹ï¼š 12345678910111213141516// ------------------------- æ‚²è§‚é”çš„è°ƒç”¨æ–¹å¼ -------------------------// synchronizedpublic synchronized void testMethod() &#123;\t// æ“ä½œåŒæ­¥èµ„æº&#125;// ReentrantLockprivate ReentrantLock lock = new ReentrantLock(); // éœ€è¦ä¿è¯å¤šä¸ªçº¿ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªé”public void modifyPublicResources() &#123;\tlock.lock();\t// æ“ä½œåŒæ­¥èµ„æº\tlock.unlock();&#125;// ------------------------- ä¹è§‚é”çš„è°ƒç”¨æ–¹å¼ -------------------------private AtomicInteger atomicInteger = new AtomicInteger(); // éœ€è¦ä¿è¯å¤šä¸ªçº¿ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªAtomicIntegeratomicInteger.incrementAndGet(); //æ‰§è¡Œè‡ªå¢1 é€šè¿‡è°ƒç”¨æ–¹å¼ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æ‚²è§‚é”åŸºæœ¬éƒ½æ˜¯åœ¨æ˜¾å¼çš„é”å®šä¹‹åå†æ“ä½œåŒæ­¥èµ„æºï¼Œè€Œä¹è§‚é”åˆ™ç›´æ¥å»æ“ä½œåŒæ­¥èµ„æºã€‚é‚£ä¹ˆï¼Œä¸ºä½•ä¹è§‚é”èƒ½å¤Ÿåšåˆ°ä¸é”å®šåŒæ­¥èµ„æºä¹Ÿå¯ä»¥æ­£ç¡®çš„å®ç°çº¿ç¨‹åŒæ­¥å‘¢ï¼Ÿå…·ä½“å¯ä»¥å‚çœ‹JUCåŸå­ç±»: CAS, Unsafeå’ŒåŸå­ç±»è¯¦è§£ã€‚ 2. è‡ªæ—‹é” VS é€‚åº”æ€§è‡ªæ—‹é” åœ¨ä»‹ç»è‡ªæ—‹é”å‰ï¼Œæˆ‘ä»¬éœ€è¦ä»‹ç»ä¸€äº›å‰æçŸ¥è¯†æ¥å¸®åŠ©å¤§å®¶æ˜ç™½è‡ªæ—‹é”çš„æ¦‚å¿µã€‚ é˜»å¡æˆ–å”¤é†’ä¸€ä¸ªJavaçº¿ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿåˆ‡æ¢CPUçŠ¶æ€æ¥å®Œæˆï¼Œè¿™ç§çŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¤„ç†å™¨æ—¶é—´ã€‚å¦‚æœåŒæ­¥ä»£ç å—ä¸­çš„å†…å®¹è¿‡äºç®€å•ï¼ŒçŠ¶æ€è½¬æ¢æ¶ˆè€—çš„æ—¶é—´æœ‰å¯èƒ½æ¯”ç”¨æˆ·ä»£ç æ‰§è¡Œçš„æ—¶é—´è¿˜è¦é•¿ã€‚ åœ¨è®¸å¤šåœºæ™¯ä¸­ï¼ŒåŒæ­¥èµ„æºçš„é”å®šæ—¶é—´å¾ˆçŸ­ï¼Œä¸ºäº†è¿™ä¸€å°æ®µæ—¶é—´å»åˆ‡æ¢çº¿ç¨‹ï¼Œçº¿ç¨‹æŒ‚èµ·å’Œæ¢å¤ç°åœºçš„èŠ±è´¹å¯èƒ½ä¼šè®©ç³»ç»Ÿå¾—ä¸å¿å¤±ã€‚å¦‚æœç‰©ç†æœºå™¨æœ‰å¤šä¸ªå¤„ç†å™¨ï¼Œèƒ½å¤Ÿè®©ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„çº¿ç¨‹åŒæ—¶å¹¶è¡Œæ‰§è¡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©åé¢é‚£ä¸ªè¯·æ±‚é”çš„çº¿ç¨‹ä¸æ”¾å¼ƒCPUçš„æ‰§è¡Œæ—¶é—´ï¼Œçœ‹çœ‹æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å¾ˆå¿«å°±ä¼šé‡Šæ”¾é”ã€‚ è€Œä¸ºäº†è®©å½“å‰çº¿ç¨‹â€œç¨ç­‰ä¸€ä¸‹â€ï¼Œæˆ‘ä»¬éœ€è®©å½“å‰çº¿ç¨‹è¿›è¡Œè‡ªæ—‹ï¼Œå¦‚æœåœ¨è‡ªæ—‹å®Œæˆåå‰é¢é”å®šåŒæ­¥èµ„æºçš„çº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±å¯ä»¥ä¸å¿…é˜»å¡è€Œæ˜¯ç›´æ¥è·å–åŒæ­¥èµ„æºï¼Œä»è€Œé¿å…åˆ‡æ¢çº¿ç¨‹çš„å¼€é”€ã€‚è¿™å°±æ˜¯è‡ªæ—‹é”ã€‚ è‡ªæ—‹é”æœ¬èº«æ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œå®ƒä¸èƒ½ä»£æ›¿é˜»å¡ã€‚è‡ªæ—‹ç­‰å¾…è™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä½†å®ƒè¦å ç”¨å¤„ç†å™¨æ—¶é—´ã€‚å¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ•ˆæœå°±ä¼šéå¸¸å¥½ã€‚åä¹‹ï¼Œå¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹åªä¼šç™½æµªè´¹å¤„ç†å™¨èµ„æºã€‚æ‰€ä»¥ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šæ¬¡æ•°ï¼ˆé»˜è®¤æ˜¯10æ¬¡ï¼Œå¯ä»¥ä½¿ç”¨-XX:PreBlockSpinæ¥æ›´æ”¹ï¼‰æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œå°±åº”å½“æŒ‚èµ·çº¿ç¨‹ã€‚ è‡ªæ—‹é”çš„å®ç°åŸç†åŒæ ·ä¹Ÿæ˜¯CASï¼ŒAtomicIntegerä¸­è°ƒç”¨unsafeè¿›è¡Œè‡ªå¢æ“ä½œçš„æºç ä¸­çš„do-whileå¾ªç¯å°±æ˜¯ä¸€ä¸ªè‡ªæ—‹æ“ä½œï¼Œå¦‚æœä¿®æ”¹æ•°å€¼å¤±è´¥åˆ™é€šè¿‡å¾ªç¯æ¥æ‰§è¡Œè‡ªæ—‹ï¼Œç›´è‡³ä¿®æ”¹æˆåŠŸã€‚ è‡ªæ—‹é”ç›¸å…³å¯ä»¥çœ‹å…³é”®å­— - synchronizedè¯¦è§£ - è‡ªæ—‹é”ä¸è‡ªé€‚åº”è‡ªæ—‹é” 3. æ— é” VS åå‘é” VS è½»é‡çº§é” VS é‡é‡çº§é” è¿™å››ç§é”æ˜¯æŒ‡é”çš„çŠ¶æ€ï¼Œä¸“é—¨é’ˆå¯¹synchronizedçš„ã€‚åœ¨ä»‹ç»è¿™å››ç§é”çŠ¶æ€ä¹‹å‰è¿˜éœ€è¦ä»‹ç»ä¸€äº›é¢å¤–çš„çŸ¥è¯†ã€‚ æ€»ç»“è€Œè¨€ï¼š åå‘é”é€šè¿‡å¯¹æ¯”Mark Wordè§£å†³åŠ é”é—®é¢˜ï¼Œé¿å…æ‰§è¡ŒCASæ“ä½œã€‚è€Œè½»é‡çº§é”æ˜¯é€šè¿‡ç”¨CASæ“ä½œå’Œè‡ªæ—‹æ¥è§£å†³åŠ é”é—®é¢˜ï¼Œé¿å…çº¿ç¨‹é˜»å¡å’Œå”¤é†’è€Œå½±å“æ€§èƒ½ã€‚é‡é‡çº§é”æ˜¯å°†é™¤äº†æ‹¥æœ‰é”çš„çº¿ç¨‹ä»¥å¤–çš„çº¿ç¨‹éƒ½é˜»å¡ã€‚ ç›¸å…³å¯ä»¥çœ‹å…³é”®å­— - synchronizedè¯¦è§£ - é”çš„ç±»å‹ 4. å…¬å¹³é” VS éå…¬å¹³é”å…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œçº¿ç¨‹ç›´æ¥è¿›å…¥é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½è·å¾—é”ã€‚å…¬å¹³é”çš„ä¼˜ç‚¹æ˜¯ç­‰å¾…é”çš„çº¿ç¨‹ä¸ä¼šé¥¿æ­»ã€‚ç¼ºç‚¹æ˜¯æ•´ä½“ååæ•ˆç‡ç›¸å¯¹éå…¬å¹³é”è¦ä½ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­é™¤ç¬¬ä¸€ä¸ªçº¿ç¨‹ä»¥å¤–çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼ŒCPUå”¤é†’é˜»å¡çº¿ç¨‹çš„å¼€é”€æ¯”éå…¬å¹³é”å¤§ã€‚ éå…¬å¹³é”æ˜¯å¤šä¸ªçº¿ç¨‹åŠ é”æ—¶ç›´æ¥å°è¯•è·å–é”ï¼Œè·å–ä¸åˆ°æ‰ä¼šåˆ°ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå°¾ç­‰å¾…ã€‚ä½†å¦‚æœæ­¤æ—¶é”åˆšå¥½å¯ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å¯ä»¥æ— éœ€é˜»å¡ç›´æ¥è·å–åˆ°é”ï¼Œæ‰€ä»¥éå…¬å¹³é”æœ‰å¯èƒ½å‡ºç°åç”³è¯·é”çš„çº¿ç¨‹å…ˆè·å–é”çš„åœºæ™¯ã€‚éå…¬å¹³é”çš„ä¼˜ç‚¹æ˜¯å¯ä»¥å‡å°‘å”¤èµ·çº¿ç¨‹çš„å¼€é”€ï¼Œæ•´ä½“çš„ååæ•ˆç‡é«˜ï¼Œå› ä¸ºçº¿ç¨‹æœ‰å‡ ç‡ä¸é˜»å¡ç›´æ¥è·å¾—é”ï¼ŒCPUä¸å¿…å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚ç¼ºç‚¹æ˜¯å¤„äºç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å¯èƒ½ä¼šé¥¿æ­»ï¼Œæˆ–è€…ç­‰å¾ˆä¹…æ‰ä¼šè·å¾—é”ã€‚ ç›´æ¥ç”¨è¯­è¨€æè¿°å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œè¿™é‡Œä½œè€…ç”¨ä»åˆ«å¤„çœ‹åˆ°çš„ä¸€ä¸ªä¾‹å­æ¥è®²è¿°ä¸€ä¸‹å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾æœ‰ä¸€å£æ°´äº•ï¼Œæœ‰ç®¡ç†å‘˜çœ‹å®ˆï¼Œç®¡ç†å‘˜æœ‰ä¸€æŠŠé”ï¼Œåªæœ‰æ‹¿åˆ°é”çš„äººæ‰èƒ½å¤Ÿæ‰“æ°´ï¼Œæ‰“å®Œæ°´è¦æŠŠé”è¿˜ç»™ç®¡ç†å‘˜ã€‚æ¯ä¸ªè¿‡æ¥æ‰“æ°´çš„äººéƒ½è¦ç®¡ç†å‘˜çš„å…è®¸å¹¶æ‹¿åˆ°é”ä¹‹åæ‰èƒ½å»æ‰“æ°´ï¼Œå¦‚æœå‰é¢æœ‰äººæ­£åœ¨æ‰“æ°´ï¼Œé‚£ä¹ˆè¿™ä¸ªæƒ³è¦æ‰“æ°´çš„äººå°±å¿…é¡»æ’é˜Ÿã€‚ç®¡ç†å‘˜ä¼šæŸ¥çœ‹ä¸‹ä¸€ä¸ªè¦å»æ‰“æ°´çš„äººæ˜¯ä¸æ˜¯é˜Ÿä¼é‡Œæ’æœ€å‰é¢çš„äººï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œæ‰ä¼šç»™ä½ é”è®©ä½ å»æ‰“æ°´ï¼›å¦‚æœä½ ä¸æ˜¯æ’ç¬¬ä¸€çš„äººï¼Œå°±å¿…é¡»å»é˜Ÿå°¾æ’é˜Ÿï¼Œè¿™å°±æ˜¯å…¬å¹³é”ã€‚ ä½†æ˜¯å¯¹äºéå…¬å¹³é”ï¼Œç®¡ç†å‘˜å¯¹æ‰“æ°´çš„äººæ²¡æœ‰è¦æ±‚ã€‚å³ä½¿ç­‰å¾…é˜Ÿä¼é‡Œæœ‰æ’é˜Ÿç­‰å¾…çš„äººï¼Œä½†å¦‚æœåœ¨ä¸Šä¸€ä¸ªäººåˆšæ‰“å®Œæ°´æŠŠé”è¿˜ç»™ç®¡ç†å‘˜è€Œä¸”ç®¡ç†å‘˜è¿˜æ²¡æœ‰å…è®¸ç­‰å¾…é˜Ÿä¼é‡Œä¸‹ä¸€ä¸ªäººå»æ‰“æ°´æ—¶ï¼Œåˆšå¥½æ¥äº†ä¸€ä¸ªæ’é˜Ÿçš„äººï¼Œè¿™ä¸ªæ’é˜Ÿçš„äººæ˜¯å¯ä»¥ç›´æ¥ä»ç®¡ç†å‘˜é‚£é‡Œæ‹¿åˆ°é”å»æ‰“æ°´ï¼Œä¸éœ€è¦æ’é˜Ÿï¼ŒåŸæœ¬æ’é˜Ÿç­‰å¾…çš„äººåªèƒ½ç»§ç»­ç­‰å¾…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ›´å¤šè¯·å‚çœ‹JUC - ReentrantLockè¯¦è§£ã€‚ 5. å¯é‡å…¥é” VS éå¯é‡å…¥é”å¯é‡å…¥é”åˆåé€’å½’é”ï¼Œæ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å…¥è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ï¼ˆå‰æé”å¯¹è±¡å¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡æˆ–è€…classï¼‰ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ã€‚Javaä¸­ReentrantLockå’Œsynchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œå¯é‡å…¥é”çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚ä¸‹é¢ç”¨ç¤ºä¾‹ä»£ç æ¥è¿›è¡Œåˆ†æï¼š 12345678910public class Widget &#123; public synchronized void doSomething() &#123; System.out.println(&quot;æ–¹æ³•1æ‰§è¡Œ...&quot;); doOthers(); &#125; public synchronized void doOthers() &#123; System.out.println(&quot;æ–¹æ³•2æ‰§è¡Œ...&quot;); &#125;&#125; åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç±»ä¸­çš„ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯è¢«å†…ç½®é”synchronizedä¿®é¥°çš„ï¼ŒdoSomething()æ–¹æ³•ä¸­è°ƒç”¨doOthers()æ–¹æ³•ã€‚å› ä¸ºå†…ç½®é”æ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥åŒä¸€ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨doOthers()æ—¶å¯ä»¥ç›´æ¥è·å¾—å½“å‰å¯¹è±¡çš„é”ï¼Œè¿›å…¥doOthers()è¿›è¡Œæ“ä½œã€‚ å¦‚æœæ˜¯ä¸€ä¸ªä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹åœ¨è°ƒç”¨doOthers()ä¹‹å‰éœ€è¦å°†æ‰§è¡ŒdoSomething()æ—¶è·å–å½“å‰å¯¹è±¡çš„é”é‡Šæ”¾æ‰ï¼Œå®é™…ä¸Šè¯¥å¯¹è±¡é”å·²è¢«å½“å‰çº¿ç¨‹æ‰€æŒæœ‰ï¼Œä¸”æ— æ³•é‡Šæ”¾ã€‚æ‰€ä»¥æ­¤æ—¶ä¼šå‡ºç°æ­»é”ã€‚ è€Œä¸ºä»€ä¹ˆå¯é‡å…¥é”å°±å¯ä»¥åœ¨åµŒå¥—è°ƒç”¨æ—¶å¯ä»¥è‡ªåŠ¨è·å¾—é”å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡å›¾ç¤ºå’Œæºç æ¥åˆ†åˆ«è§£æä¸€ä¸‹ã€‚ è¿˜æ˜¯æ‰“æ°´çš„ä¾‹å­ï¼Œæœ‰å¤šä¸ªäººåœ¨æ’é˜Ÿæ‰“æ°´ï¼Œæ­¤æ—¶ç®¡ç†å‘˜å…è®¸é”å’ŒåŒä¸€ä¸ªäººçš„å¤šä¸ªæ°´æ¡¶ç»‘å®šã€‚è¿™ä¸ªäººç”¨å¤šä¸ªæ°´æ¡¶æ‰“æ°´æ—¶ï¼Œç¬¬ä¸€ä¸ªæ°´æ¡¶å’Œé”ç»‘å®šå¹¶æ‰“å®Œæ°´ä¹‹åï¼Œç¬¬äºŒä¸ªæ°´æ¡¶ä¹Ÿå¯ä»¥ç›´æ¥å’Œé”ç»‘å®šå¹¶å¼€å§‹æ‰“æ°´ï¼Œæ‰€æœ‰çš„æ°´æ¡¶éƒ½æ‰“å®Œæ°´ä¹‹åæ‰“æ°´äººæ‰ä¼šå°†é”è¿˜ç»™ç®¡ç†å‘˜ã€‚è¿™ä¸ªäººçš„æ‰€æœ‰æ‰“æ°´æµç¨‹éƒ½èƒ½å¤ŸæˆåŠŸæ‰§è¡Œï¼Œåç»­ç­‰å¾…çš„äººä¹Ÿèƒ½å¤Ÿæ‰“åˆ°æ°´ã€‚è¿™å°±æ˜¯å¯é‡å…¥é”ã€‚ ä½†å¦‚æœæ˜¯éå¯é‡å…¥é”çš„è¯ï¼Œæ­¤æ—¶ç®¡ç†å‘˜åªå…è®¸é”å’ŒåŒä¸€ä¸ªäººçš„ä¸€ä¸ªæ°´æ¡¶ç»‘å®šã€‚ç¬¬ä¸€ä¸ªæ°´æ¡¶å’Œé”ç»‘å®šæ‰“å®Œæ°´ä¹‹åå¹¶ä¸ä¼šé‡Šæ”¾é”ï¼Œå¯¼è‡´ç¬¬äºŒä¸ªæ°´æ¡¶ä¸èƒ½å’Œé”ç»‘å®šä¹Ÿæ— æ³•æ‰“æ°´ã€‚å½“å‰çº¿ç¨‹å‡ºç°æ­»é”ï¼Œæ•´ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ— æ³•è¢«å”¤é†’ã€‚ ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ReentrantLockå’Œsynchronizedéƒ½æ˜¯é‡å…¥é”ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šè¿‡é‡å…¥é”ReentrantLockä»¥åŠéå¯é‡å…¥é”NonReentrantLockçš„æºç æ¥å¯¹æ¯”åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆéå¯é‡å…¥é”åœ¨é‡å¤è°ƒç”¨åŒæ­¥èµ„æºæ—¶ä¼šå‡ºç°æ­»é”ã€‚ é¦–å…ˆReentrantLockå’ŒNonReentrantLockéƒ½ç»§æ‰¿çˆ¶ç±»AQSï¼Œå…¶çˆ¶ç±»AQSä¸­ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥çŠ¶æ€statusæ¥è®¡æ•°é‡å…¥æ¬¡æ•°ï¼Œstatusåˆå§‹å€¼ä¸º0ã€‚ å½“çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œå¯é‡å…¥é”å…ˆå°è¯•è·å–å¹¶æ›´æ–°statuså€¼ï¼Œå¦‚æœstatus &#x3D;&#x3D; 0è¡¨ç¤ºæ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œåˆ™æŠŠstatusç½®ä¸º1ï¼Œå½“å‰çº¿ç¨‹å¼€å§‹æ‰§è¡Œã€‚å¦‚æœstatus !&#x3D; 0ï¼Œåˆ™åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯è·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯çš„è¯æ‰§è¡Œstatus+1ï¼Œä¸”å½“å‰çº¿ç¨‹å¯ä»¥å†æ¬¡è·å–é”ã€‚è€Œéå¯é‡å…¥é”æ˜¯ç›´æ¥å»è·å–å¹¶å°è¯•æ›´æ–°å½“å‰statusçš„å€¼ï¼Œå¦‚æœstatus !&#x3D; 0çš„è¯ä¼šå¯¼è‡´å…¶è·å–é”å¤±è´¥ï¼Œå½“å‰çº¿ç¨‹é˜»å¡ã€‚ é‡Šæ”¾é”æ—¶ï¼Œå¯é‡å…¥é”åŒæ ·å…ˆè·å–å½“å‰statusçš„å€¼ï¼Œåœ¨å½“å‰çº¿ç¨‹æ˜¯æŒæœ‰é”çš„çº¿ç¨‹çš„å‰æä¸‹ã€‚å¦‚æœstatus-1 &#x3D;&#x3D; 0ï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹æ‰€æœ‰é‡å¤è·å–é”çš„æ“ä½œéƒ½å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åè¯¥çº¿ç¨‹æ‰ä¼šçœŸæ­£é‡Šæ”¾é”ã€‚è€Œéå¯é‡å…¥é”åˆ™æ˜¯åœ¨ç¡®å®šå½“å‰çº¿ç¨‹æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ä¹‹åï¼Œç›´æ¥å°†statusç½®ä¸º0ï¼Œå°†é”é‡Šæ”¾ã€‚ æ›´å¤šè¯·å‚çœ‹ï¼š JUCé”: LockSupportè¯¦è§£ JUCé”: AbstractQueuedSynchronizerè¯¦è§£ JUCé” - ReentrantLockè¯¦è§£ã€‚ å…³é”®å­— - synchronizedè¯¦è§£ 6. ç‹¬äº«é”(æ’ä»–é”) VS å…±äº«é” ç‹¬äº«é”å’Œå…±äº«é”åŒæ ·æ˜¯ä¸€ç§æ¦‚å¿µã€‚æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹å…·ä½“çš„æ¦‚å¿µï¼Œç„¶åé€šè¿‡ReentrantLockå’ŒReentrantReadWriteLockçš„æºç æ¥ä»‹ç»ç‹¬äº«é”å’Œå…±äº«é”ã€‚ ç‹¬äº«é”ä¹Ÿå«æ’ä»–é”ï¼Œæ˜¯æŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¦‚æœçº¿ç¨‹Tå¯¹æ•°æ®AåŠ ä¸Šæ’å®ƒé”åï¼Œåˆ™å…¶ä»–çº¿ç¨‹ä¸èƒ½å†å¯¹AåŠ ä»»ä½•ç±»å‹çš„é”ã€‚è·å¾—æ’å®ƒé”çš„çº¿ç¨‹å³èƒ½è¯»æ•°æ®åˆèƒ½ä¿®æ”¹æ•°æ®ã€‚JDKä¸­çš„synchronizedå’ŒJUCä¸­Lockçš„å®ç°ç±»å°±æ˜¯äº’æ–¥é”ã€‚ å…±äº«é”æ˜¯æŒ‡è¯¥é”å¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¦‚æœçº¿ç¨‹Tå¯¹æ•°æ®AåŠ ä¸Šå…±äº«é”åï¼Œåˆ™å…¶ä»–çº¿ç¨‹åªèƒ½å¯¹Aå†åŠ å…±äº«é”ï¼Œä¸èƒ½åŠ æ’å®ƒé”ã€‚è·å¾—å…±äº«é”çš„çº¿ç¨‹åªèƒ½è¯»æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹æ•°æ®ã€‚ ç‹¬äº«é”ä¸å…±äº«é”ä¹Ÿæ˜¯é€šè¿‡AQSæ¥å®ç°çš„ï¼Œé€šè¿‡å®ç°ä¸åŒçš„æ–¹æ³•ï¼Œæ¥å®ç°ç‹¬äº«æˆ–è€…å…±äº«ã€‚ ä¸‹å›¾ä¸ºReentrantReadWriteLockçš„éƒ¨åˆ†æºç ï¼š æˆ‘ä»¬çœ‹åˆ°ReentrantReadWriteLockæœ‰ä¸¤æŠŠé”ï¼šReadLockå’ŒWriteLockï¼Œç”±è¯çŸ¥æ„ï¼Œä¸€ä¸ªè¯»é”ä¸€ä¸ªå†™é”ï¼Œåˆç§°â€œè¯»å†™é”â€ã€‚å†è¿›ä¸€æ­¥è§‚å¯Ÿå¯ä»¥å‘ç°ReadLockå’ŒWriteLockæ˜¯é å†…éƒ¨ç±»Syncå®ç°çš„é”ã€‚Syncæ˜¯AQSçš„ä¸€ä¸ªå­ç±»ï¼Œè¿™ç§ç»“æ„åœ¨CountDownLatchã€ReentrantLockã€Semaphoreé‡Œé¢ä¹Ÿéƒ½å­˜åœ¨ã€‚ åœ¨ReentrantReadWriteLocké‡Œé¢ï¼Œè¯»é”å’Œå†™é”çš„é”ä¸»ä½“éƒ½æ˜¯Syncï¼Œä½†è¯»é”å’Œå†™é”çš„åŠ é”æ–¹å¼ä¸ä¸€æ ·ã€‚è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬äº«é”ã€‚è¯»é”çš„å…±äº«é”å¯ä¿è¯å¹¶å‘è¯»éå¸¸é«˜æ•ˆï¼Œè€Œè¯»å†™ã€å†™è¯»ã€å†™å†™çš„è¿‡ç¨‹äº’æ–¥ï¼Œå› ä¸ºè¯»é”å’Œå†™é”æ˜¯åˆ†ç¦»çš„ã€‚æ‰€ä»¥ReentrantReadWriteLockçš„å¹¶å‘æ€§ç›¸æ¯”ä¸€èˆ¬çš„äº’æ–¥é”æœ‰äº†å¾ˆå¤§æå‡ã€‚ æ›´å¤šè¯·å‚çœ‹ JUCé”: ReentrantReadWriteLockè¯¦è§£ ç»“è¯­æœ¬æ–‡Javaä¸­å¸¸ç”¨çš„é”ä»¥åŠå¸¸è§çš„é”çš„æ¦‚å¿µè¿›è¡Œäº†åŸºæœ¬ä»‹ç»ï¼Œå¹¶ä»æºç ä»¥åŠå®é™…åº”ç”¨çš„è§’åº¦è¿›è¡Œäº†å¯¹æ¯”åˆ†æã€‚é™äºç¯‡å¹…ä»¥åŠä¸ªäººæ°´å¹³ï¼Œæ²¡æœ‰åœ¨æœ¬ç¯‡æ–‡ç« ä¸­å¯¹æ‰€æœ‰å†…å®¹è¿›è¡Œæ·±å±‚æ¬¡çš„è®²è§£ã€‚ å…¶å®Javaæœ¬èº«å·²ç»å¯¹é”æœ¬èº«è¿›è¡Œäº†è‰¯å¥½çš„å°è£…ï¼Œé™ä½äº†ç ”å‘åŒå­¦åœ¨å¹³æ—¶å·¥ä½œä¸­çš„ä½¿ç”¨éš¾åº¦ã€‚ä½†æ˜¯ç ”å‘åŒå­¦ä¹Ÿéœ€è¦ç†Ÿæ‚‰é”çš„åº•å±‚åŸç†ï¼Œä¸åŒåœºæ™¯ä¸‹é€‰æ‹©æœ€é€‚åˆçš„é”ã€‚è€Œä¸”æºç ä¸­çš„æ€è·¯éƒ½æ˜¯éå¸¸å¥½çš„æ€è·¯ï¼Œä¹Ÿæ˜¯å€¼å¾—å¤§å®¶å»å­¦ä¹ å’Œå€Ÿé‰´çš„ã€‚ å‚è€ƒèµ„æ–™ ã€ŠJavaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ã€‹ Javaä¸­çš„é” Java CAS åŸç†å‰–æ Javaå¹¶å‘â€”â€”å…³é”®å­—synchronizedè§£æ Java synchronizedåŸç†æ€»ç»“ èŠèŠå¹¶å‘ï¼ˆäºŒï¼‰â€”â€”Java SE1.6ä¸­çš„Synchronized æ·±å…¥ç†è§£è¯»å†™é”â€”ReadWriteLockæºç åˆ†æ ã€JUCã€‘JDK1.8æºç åˆ†æä¹‹ReentrantReadWriteLock Javaå¤šçº¿ç¨‹ï¼ˆåï¼‰ä¹‹ReentrantReadWriteLockæ·±å…¥åˆ†æ Javaâ€“è¯»å†™é”çš„å®ç°åŸç† ä½œè€…ç®€ä»‹å®¶çªï¼Œç¾å›¢ç‚¹è¯„åç«¯å·¥ç¨‹å¸ˆã€‚2017 å¹´åŠ å…¥ç¾å›¢ç‚¹è¯„ï¼Œè´Ÿè´£ç¾å›¢ç‚¹è¯„å¢ƒå†…åº¦å‡çš„ä¸šåŠ¡å¼€å‘ã€‚ æ–‡ç« æ¥æºæœ¬æ–‡ä¸»è¦åœ¨ç¾å›¢æŠ€æœ¯å›¢é˜Ÿå®¶çªçš„æ–‡ç« åŸºç¡€ä¸Šè¿›è¡Œè°ƒæ•´ï¼Œä»¥æ»¡è¶³æ•´ä½“çš„çŸ¥è¯†ä½“ç³»ã€‚ è‘—ä½œæƒå½’@pdaiæ‰€æœ‰ åŸæ–‡é“¾æ¥ï¼šhttps://pdai.tech/md/java/thread/java-thread-x-lock-all.html","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"]},{"title":"3.Java å¹¶å‘ - çº¿ç¨‹åŸºç¡€","path":"/2023/12/25/3-Java-å¹¶å‘-çº¿ç¨‹åŸºç¡€/","content":"æœ¬æ–‡ä¸»è¦æ¦‚è¦æ€§çš„ä»‹ç»çº¿ç¨‹çš„åŸºç¡€ï¼Œä¸ºåé¢çš„ç« èŠ‚æ·±å…¥ä»‹ç»Javaå¹¶å‘çš„çŸ¥è¯†æä¾›åŸºç¡€ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£çº¿ç¨‹åŸºç¡€ã€‚ çº¿ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€? åˆ†åˆ«è¯´æ˜ä»ä¸€ç§çŠ¶æ€åˆ°å¦ä¸€ç§çŠ¶æ€è½¬å˜æœ‰å“ªäº›æ–¹å¼? é€šå¸¸çº¿ç¨‹æœ‰å“ªå‡ ç§ä½¿ç”¨æ–¹å¼? åŸºç¡€çº¿ç¨‹æœºåˆ¶æœ‰å“ªäº›? çº¿ç¨‹çš„ä¸­æ–­æ–¹å¼æœ‰å“ªäº›? çº¿ç¨‹çš„äº’æ–¥åŒæ­¥æ–¹å¼æœ‰å“ªäº›? å¦‚ä½•æ¯”è¾ƒå’Œé€‰æ‹©? çº¿ç¨‹ä¹‹é—´æœ‰å“ªäº›åä½œæ–¹å¼? çº¿ç¨‹çŠ¶æ€è½¬æ¢ æ–°å»º(New)åˆ›å»ºåå°šæœªå¯åŠ¨ã€‚ å¯è¿è¡Œ(Runnable)å¯èƒ½æ­£åœ¨è¿è¡Œï¼Œä¹Ÿå¯èƒ½æ­£åœ¨ç­‰å¾… CPU æ—¶é—´ç‰‡ã€‚ åŒ…å«äº†æ“ä½œç³»ç»Ÿçº¿ç¨‹çŠ¶æ€ä¸­çš„ Running å’Œ Readyã€‚ é˜»å¡(Blocking)ç­‰å¾…è·å–ä¸€ä¸ªæ’å®ƒé”ï¼Œå¦‚æœå…¶çº¿ç¨‹é‡Šæ”¾äº†é”å°±ä¼šç»“æŸæ­¤çŠ¶æ€ã€‚ æ— é™æœŸç­‰å¾…(Waiting)ç­‰å¾…å…¶å®ƒçº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ï¼Œå¦åˆ™ä¸ä¼šè¢«åˆ†é… CPU æ—¶é—´ç‰‡ã€‚ è¿›å…¥æ–¹æ³• é€€å‡ºæ–¹æ³• æ²¡æœ‰è®¾ç½® Timeout å‚æ•°çš„ Object.wait() æ–¹æ³• Object.notify() &#x2F; Object.notifyAll() æ²¡æœ‰è®¾ç½® Timeout å‚æ•°çš„ Thread.join() æ–¹æ³• è¢«è°ƒç”¨çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯• LockSupport.park() æ–¹æ³• - é™æœŸç­‰å¾…(Timed Waiting)æ— éœ€ç­‰å¾…å…¶å®ƒçº¿ç¨‹æ˜¾å¼åœ°å”¤é†’ï¼Œåœ¨ä¸€å®šæ—¶é—´ä¹‹åä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨å”¤é†’ã€‚ è°ƒç”¨ Thread.sleep() æ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥é™æœŸç­‰å¾…çŠ¶æ€æ—¶ï¼Œå¸¸å¸¸ç”¨â€œä½¿ä¸€ä¸ªçº¿ç¨‹ç¡çœ â€è¿›è¡Œæè¿°ã€‚ è°ƒç”¨ Object.wait() æ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥é™æœŸç­‰å¾…æˆ–è€…æ— é™æœŸç­‰å¾…æ—¶ï¼Œå¸¸å¸¸ç”¨â€œæŒ‚èµ·ä¸€ä¸ªçº¿ç¨‹â€è¿›è¡Œæè¿°ã€‚ ç¡çœ å’ŒæŒ‚èµ·æ˜¯ç”¨æ¥æè¿°è¡Œä¸ºï¼Œè€Œé˜»å¡å’Œç­‰å¾…ç”¨æ¥æè¿°çŠ¶æ€ã€‚ é˜»å¡å’Œç­‰å¾…çš„åŒºåˆ«åœ¨äºï¼Œé˜»å¡æ˜¯è¢«åŠ¨çš„ï¼Œå®ƒæ˜¯åœ¨ç­‰å¾…è·å–ä¸€ä¸ªæ’å®ƒé”ã€‚è€Œç­‰å¾…æ˜¯ä¸»åŠ¨çš„ï¼Œé€šè¿‡è°ƒç”¨ Thread.sleep() å’Œ Object.wait() ç­‰æ–¹æ³•è¿›å…¥ã€‚ è¿›å…¥æ–¹æ³• é€€å‡ºæ–¹æ³• Thread.sleep() æ–¹æ³• æ—¶é—´ç»“æŸ è®¾ç½®äº† Timeout å‚æ•°çš„ Object.wait() æ–¹æ³• æ—¶é—´ç»“æŸ &#x2F; Object.notify() &#x2F; Object.notifyAll() è®¾ç½®äº† Timeout å‚æ•°çš„ Thread.join() æ–¹æ³• æ—¶é—´ç»“æŸ &#x2F; è¢«è°ƒç”¨çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯• LockSupport.parkNanos() æ–¹æ³• - LockSupport.parkUntil() æ–¹æ³• - æ­»äº¡(Terminated)å¯ä»¥æ˜¯çº¿ç¨‹ç»“æŸä»»åŠ¡ä¹‹åè‡ªå·±ç»“æŸï¼Œæˆ–è€…äº§ç”Ÿäº†å¼‚å¸¸è€Œç»“æŸã€‚ çº¿ç¨‹ä½¿ç”¨æ–¹å¼æœ‰ä¸‰ç§ä½¿ç”¨çº¿ç¨‹çš„æ–¹æ³•: å®ç° Runnable æ¥å£ï¼› å®ç° Callable æ¥å£ï¼› ç»§æ‰¿ Thread ç±»ã€‚ å®ç° Runnable å’Œ Callable æ¥å£çš„ç±»åªèƒ½å½“åšä¸€ä¸ªå¯ä»¥åœ¨çº¿ç¨‹ä¸­è¿è¡Œçš„ä»»åŠ¡ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„çº¿ç¨‹ï¼Œå› æ­¤æœ€åè¿˜éœ€è¦é€šè¿‡ Thread æ¥è°ƒç”¨ã€‚å¯ä»¥è¯´ä»»åŠ¡æ˜¯é€šè¿‡çº¿ç¨‹é©±åŠ¨ä»è€Œæ‰§è¡Œçš„ã€‚ å®ç° Runnable æ¥å£éœ€è¦å®ç° run() æ–¹æ³•ã€‚ é€šè¿‡ Thread è°ƒç”¨ start() æ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹ã€‚ 12345public class MyRunnable implements Runnable &#123; public void run() &#123; // ... &#125;&#125; 12345public static void main(String[] args) &#123; MyRunnable instance = new MyRunnable(); Thread thread = new Thread(instance); thread.start();&#125; å®ç° Callable æ¥å£ä¸ Runnable ç›¸æ¯”ï¼ŒCallable å¯ä»¥æœ‰è¿”å›å€¼ï¼Œè¿”å›å€¼é€šè¿‡ FutureTask è¿›è¡Œå°è£…ã€‚ 12345public class MyCallable implements Callable&lt;Integer&gt; &#123; public Integer call() &#123; return 123; &#125;&#125; 1234567public static void main(String[] args) throws ExecutionException, InterruptedException &#123; MyCallable mc = new MyCallable(); FutureTask&lt;Integer&gt; ft = new FutureTask&lt;&gt;(mc); Thread thread = new Thread(ft); thread.start(); System.out.println(ft.get());&#125; ç»§æ‰¿ Thread ç±»åŒæ ·ä¹Ÿæ˜¯éœ€è¦å®ç° run() æ–¹æ³•ï¼Œå› ä¸º Thread ç±»ä¹Ÿå®ç°äº† Runable æ¥å£ã€‚ å½“è°ƒç”¨ start() æ–¹æ³•å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œè™šæ‹Ÿæœºä¼šå°†è¯¥çº¿ç¨‹æ”¾å…¥å°±ç»ªé˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¢«è°ƒåº¦æ—¶ä¼šæ‰§è¡Œè¯¥çº¿ç¨‹çš„ run() æ–¹æ³•ã€‚ 12345public class MyThread extends Thread &#123; public void run() &#123; // ... &#125;&#125; 1234public static void main(String[] args) &#123; MyThread mt = new MyThread(); mt.start();&#125; å®ç°æ¥å£ VS ç»§æ‰¿ Threadå®ç°æ¥å£ä¼šæ›´å¥½ä¸€äº›ï¼Œå› ä¸º: Java ä¸æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå› æ­¤ç»§æ‰¿äº† Thread ç±»å°±æ— æ³•ç»§æ‰¿å…¶å®ƒç±»ï¼Œä½†æ˜¯å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼› ç±»å¯èƒ½åªè¦æ±‚å¯æ‰§è¡Œå°±è¡Œï¼Œç»§æ‰¿æ•´ä¸ª Thread ç±»å¼€é”€è¿‡å¤§ã€‚ åŸºç¡€çº¿ç¨‹æœºåˆ¶ExecutorExecutor ç®¡ç†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œè€Œæ— éœ€ç¨‹åºå‘˜æ˜¾å¼åœ°ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™é‡Œçš„å¼‚æ­¥æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡çš„æ‰§è¡Œäº’ä¸å¹²æ‰°ï¼Œä¸éœ€è¦è¿›è¡ŒåŒæ­¥æ“ä½œã€‚ ä¸»è¦æœ‰ä¸‰ç§ Executor: CachedThreadPool: ä¸€ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼› FixedThreadPool: æ‰€æœ‰ä»»åŠ¡åªèƒ½ä½¿ç”¨å›ºå®šå¤§å°çš„çº¿ç¨‹ï¼› SingleThreadExecutor: ç›¸å½“äºå¤§å°ä¸º 1 çš„ FixedThreadPoolã€‚ 1234567public static void main(String[] args) &#123; ExecutorService executorService = Executors.newCachedThreadPool(); for (int i = 0; i &lt; 5; i++) &#123; executorService.execute(new MyRunnable()); &#125; executorService.shutdown();&#125; Daemonå®ˆæŠ¤çº¿ç¨‹æ˜¯ç¨‹åºè¿è¡Œæ—¶åœ¨åå°æä¾›æœåŠ¡çš„çº¿ç¨‹ï¼Œä¸å±äºç¨‹åºä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ã€‚ å½“æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿå°±ç»ˆæ­¢ï¼ŒåŒæ—¶ä¼šæ€æ­»æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹ã€‚ main() å±äºéå®ˆæŠ¤çº¿ç¨‹ã€‚ ä½¿ç”¨ setDaemon() æ–¹æ³•å°†ä¸€ä¸ªçº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚ 1234public static void main(String[] args) &#123; Thread thread = new Thread(new MyRunnable()); thread.setDaemon(true);&#125; sleep()Thread.sleep(millisec) æ–¹æ³•ä¼šä¼‘çœ å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œmillisec å•ä½ä¸ºæ¯«ç§’ã€‚ sleep() å¯èƒ½ä¼šæŠ›å‡º InterruptedExceptionï¼Œå› ä¸ºå¼‚å¸¸ä¸èƒ½è·¨çº¿ç¨‹ä¼ æ’­å› main() ä¸­ï¼Œå› æ­¤å¿…é¡»åœ¨æœ¬åœ°è¿›è¡Œå¤„ç†ã€‚çº¿ç¨‹ä¸­æŠ›å‡ºçš„å…¶å®ƒå¼‚å¸¸ä¹ŸåŒæ ·éœ€è¦åœ¨æœ¬åœ°è¿›è¡Œå¤„ç†ã€‚ 1234567public void run() &#123; try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;&#125; yield()å¯¹é™æ€æ–¹æ³• Thread.yield() çš„è°ƒç”¨å£°æ˜äº†å½“å‰çº¿ç¨‹å·²ç»å®Œæˆäº†ç”Ÿå‘½å‘¨æœŸä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå¯ä»¥åˆ‡æ¢ç»™å…¶å®ƒçº¿ç¨‹æ¥æ‰§è¡Œã€‚è¯¥æ–¹æ³•åªæ˜¯å¯¹çº¿ç¨‹è°ƒåº¦å™¨çš„ä¸€ä¸ªå»ºè®®ï¼Œè€Œä¸”ä¹Ÿåªæ˜¯å»ºè®®å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„å…¶å®ƒçº¿ç¨‹å¯ä»¥è¿è¡Œã€‚ 123public void run() &#123; Thread.yield();&#125; çº¿ç¨‹ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åä¼šè‡ªåŠ¨ç»“æŸï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¼šæå‰ç»“æŸã€‚ InterruptedExceptioné€šè¿‡è°ƒç”¨ä¸€ä¸ªçº¿ç¨‹çš„ interrupt() æ¥ä¸­æ–­è¯¥çº¿ç¨‹ï¼Œå¦‚æœè¯¥çº¿ç¨‹å¤„äºé˜»å¡ã€é™æœŸç­‰å¾…æˆ–è€…æ— é™æœŸç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡º InterruptedExceptionï¼Œä»è€Œæå‰ç»“æŸè¯¥çº¿ç¨‹ã€‚ä½†æ˜¯ä¸èƒ½ä¸­æ–­ I&#x2F;O é˜»å¡å’Œ synchronized é”é˜»å¡ã€‚ å¯¹äºä»¥ä¸‹ä»£ç ï¼Œåœ¨ main() ä¸­å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä¹‹åå†ä¸­æ–­å®ƒï¼Œç”±äºçº¿ç¨‹ä¸­è°ƒç”¨äº† Thread.sleep() æ–¹æ³•ï¼Œå› æ­¤ä¼šæŠ›å‡ºä¸€ä¸ª InterruptedExceptionï¼Œä»è€Œæå‰ç»“æŸçº¿ç¨‹ï¼Œä¸æ‰§è¡Œä¹‹åçš„è¯­å¥ã€‚ 1234567891011121314public class InterruptExample &#123; private static class MyThread1 extends Thread &#123; @Override public void run() &#123; try &#123; Thread.sleep(2000); System.out.println(&quot;Thread run&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; 123456public static void main(String[] args) throws InterruptedException &#123; Thread thread1 = new MyThread1(); thread1.start(); thread1.interrupt(); System.out.println(&quot;Main run&quot;);&#125; 123456Main runjava.lang.InterruptedException: sleep interrupted at java.lang.Thread.sleep(Native Method) at InterruptExample.lambda$main$0(InterruptExample.java:5) at InterruptExample$$Lambda$1/713338599.run(Unknown Source) at java.lang.Thread.run(Thread.java:745) interrupted()å¦‚æœä¸€ä¸ªçº¿ç¨‹çš„ run() æ–¹æ³•æ‰§è¡Œä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¹¶ä¸”æ²¡æœ‰æ‰§è¡Œ sleep() ç­‰ä¼šæŠ›å‡º InterruptedException çš„æ“ä½œï¼Œé‚£ä¹ˆè°ƒç”¨çº¿ç¨‹çš„ interrupt() æ–¹æ³•å°±æ— æ³•ä½¿çº¿ç¨‹æå‰ç»“æŸã€‚ ä½†æ˜¯è°ƒç”¨ interrupt() æ–¹æ³•ä¼šè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ï¼Œæ­¤æ—¶è°ƒç”¨ interrupted() æ–¹æ³•ä¼šè¿”å› trueã€‚å› æ­¤å¯ä»¥åœ¨å¾ªç¯ä½“ä¸­ä½¿ç”¨ interrupted() æ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ï¼Œä»è€Œæå‰ç»“æŸçº¿ç¨‹ã€‚ 123456789101112public class InterruptExample &#123; private static class MyThread2 extends Thread &#123; @Override public void run() &#123; while (!interrupted()) &#123; // .. &#125; System.out.println(&quot;Thread end&quot;); &#125; &#125;&#125; 12345public static void main(String[] args) throws InterruptedException &#123; Thread thread2 = new MyThread2(); thread2.start(); thread2.interrupt();&#125; 1Thread end Executor çš„ä¸­æ–­æ“ä½œè°ƒç”¨ Executor çš„ shutdown() æ–¹æ³•ä¼šç­‰å¾…çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åå†å…³é—­ï¼Œä½†æ˜¯å¦‚æœè°ƒç”¨çš„æ˜¯ shutdownNow() æ–¹æ³•ï¼Œåˆ™ç›¸å½“äºè°ƒç”¨æ¯ä¸ªçº¿ç¨‹çš„ interrupt() æ–¹æ³•ã€‚ ä»¥ä¸‹ä½¿ç”¨ Lambda åˆ›å»ºçº¿ç¨‹ï¼Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå†…éƒ¨çº¿ç¨‹ã€‚ 12345678910111213public static void main(String[] args) &#123; ExecutorService executorService = Executors.newCachedThreadPool(); executorService.execute(() -&gt; &#123; try &#123; Thread.sleep(2000); System.out.println(&quot;Thread run&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;); executorService.shutdownNow(); System.out.println(&quot;Main run&quot;);&#125; 12345678Main runjava.lang.InterruptedException: sleep interrupted at java.lang.Thread.sleep(Native Method) at ExecutorInterruptExample.lambda$main$0(ExecutorInterruptExample.java:9) at ExecutorInterruptExample$$Lambda$1/1160460865.run(Unknown Source) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.Thread.run(Thread.java:745)\\ å¦‚æœåªæƒ³ä¸­æ–­ Executor ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ submit() æ–¹æ³•æ¥æäº¤ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª Future&lt;?&gt; å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨è¯¥å¯¹è±¡çš„ cancel(true) æ–¹æ³•å°±å¯ä»¥ä¸­æ–­çº¿ç¨‹ã€‚ 1234Future&lt;?&gt; future = executorService.submit(() -&gt; &#123; // ..&#125;);future.cancel(true); çº¿ç¨‹äº’æ–¥åŒæ­¥Java æä¾›äº†ä¸¤ç§é”æœºåˆ¶æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ï¼Œç¬¬ä¸€ä¸ªæ˜¯ JVM å®ç°çš„ synchronizedï¼Œè€Œå¦ä¸€ä¸ªæ˜¯ JDK å®ç°çš„ ReentrantLockã€‚ synchronized1. åŒæ­¥ä¸€ä¸ªä»£ç å— 12345public void func() &#123; synchronized (this) &#123; // ... &#125;&#125; å®ƒåªä½œç”¨äºåŒä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœè°ƒç”¨ä¸¤ä¸ªå¯¹è±¡ä¸Šçš„åŒæ­¥ä»£ç å—ï¼Œå°±ä¸ä¼šè¿›è¡ŒåŒæ­¥ã€‚ å¯¹äºä»¥ä¸‹ä»£ç ï¼Œä½¿ç”¨ ExecutorService æ‰§è¡Œäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œç”±äºè°ƒç”¨çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„åŒæ­¥ä»£ç å—ï¼Œå› æ­¤è¿™ä¸¤ä¸ªçº¿ç¨‹ä¼šè¿›è¡ŒåŒæ­¥ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åŒæ­¥è¯­å¥å—æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°±å¿…é¡»ç­‰å¾…ã€‚ 12345678910public class SynchronizedExample &#123; public void func1() &#123; synchronized (this) &#123; for (int i = 0; i &lt; 10; i++) &#123; System.out.print(i + &quot; &quot;); &#125; &#125; &#125;&#125; 123456public static void main(String[] args) &#123; SynchronizedExample e1 = new SynchronizedExample(); ExecutorService executorService = Executors.newCachedThreadPool(); executorService.execute(() -&gt; e1.func1()); executorService.execute(() -&gt; e1.func1());&#125; 10 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 å¯¹äºä»¥ä¸‹ä»£ç ï¼Œä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨äº†ä¸åŒå¯¹è±¡çš„åŒæ­¥ä»£ç å—ï¼Œå› æ­¤è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¸éœ€è¦åŒæ­¥ã€‚ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œä¸¤ä¸ªçº¿ç¨‹äº¤å‰æ‰§è¡Œã€‚ 1234567public static void main(String[] args) &#123; SynchronizedExample e1 = new SynchronizedExample(); SynchronizedExample e2 = new SynchronizedExample(); ExecutorService executorService = Executors.newCachedThreadPool(); executorService.execute(() -&gt; e1.func1()); executorService.execute(() -&gt; e2.func1());&#125; 10 0 1 1 2 2 3 3 4 4 5 5 6 6 7 7 8 8 9 9 2. åŒæ­¥ä¸€ä¸ªæ–¹æ³• 123public synchronized void func () &#123; // ...&#125; å®ƒå’ŒåŒæ­¥ä»£ç å—ä¸€æ ·ï¼Œä½œç”¨äºåŒä¸€ä¸ªå¯¹è±¡ã€‚ 3. åŒæ­¥ä¸€ä¸ªç±» 12345public void func() &#123; synchronized (SynchronizedExample.class) &#123; // ... &#125;&#125; ä½œç”¨äºæ•´ä¸ªç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªç±»çš„ä¸åŒå¯¹è±¡ä¸Šçš„è¿™ç§åŒæ­¥è¯­å¥ï¼Œä¹Ÿä¼šè¿›è¡ŒåŒæ­¥ã€‚ 12345678910public class SynchronizedExample &#123; public void func2() &#123; synchronized (SynchronizedExample.class) &#123; for (int i = 0; i &lt; 10; i++) &#123; System.out.print(i + &quot; &quot;); &#125; &#125; &#125;&#125; 1234567public static void main(String[] args) &#123; SynchronizedExample e1 = new SynchronizedExample(); SynchronizedExample e2 = new SynchronizedExample(); ExecutorService executorService = Executors.newCachedThreadPool(); executorService.execute(() -&gt; e1.func2()); executorService.execute(() -&gt; e2.func2());&#125; 10 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 4. åŒæ­¥ä¸€ä¸ªé™æ€æ–¹æ³• 123public synchronized static void fun() &#123; // ...&#125; ä½œç”¨äºæ•´ä¸ªç±»ã€‚ ReentrantLockReentrantLock æ˜¯ java.util.concurrent(J.U.C)åŒ…ä¸­çš„é”ã€‚ 123456789101112131415public class LockExample &#123; private Lock lock = new ReentrantLock(); public void func() &#123; lock.lock(); try &#123; for (int i = 0; i &lt; 10; i++) &#123; System.out.print(i + &quot; &quot;); &#125; &#125; finally &#123; lock.unlock(); // ç¡®ä¿é‡Šæ”¾é”ï¼Œä»è€Œé¿å…å‘ç”Ÿæ­»é”ã€‚ &#125; &#125;&#125; 123456public static void main(String[] args) &#123; LockExample lockExample = new LockExample(); ExecutorService executorService = Executors.newCachedThreadPool(); executorService.execute(() -&gt; lockExample.func()); executorService.execute(() -&gt; lockExample.func());&#125; 10 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 æ¯”è¾ƒ1. é”çš„å®ç° synchronized æ˜¯ JVM å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ JDK å®ç°çš„ã€‚ 2. æ€§èƒ½ æ–°ç‰ˆæœ¬ Java å¯¹ synchronized è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä¾‹å¦‚è‡ªæ—‹é”ç­‰ï¼Œsynchronized ä¸ ReentrantLock å¤§è‡´ç›¸åŒã€‚ 3. ç­‰å¾…å¯ä¸­æ–­ å½“æŒæœ‰é”çš„çº¿ç¨‹é•¿æœŸä¸é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚ ReentrantLock å¯ä¸­æ–­ï¼Œè€Œ synchronized ä¸è¡Œã€‚ 4. å…¬å¹³é” å…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”ã€‚ synchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„ï¼ŒReentrantLock é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯éå…¬å¹³çš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æ˜¯å…¬å¹³çš„ã€‚ 5. é”ç»‘å®šå¤šä¸ªæ¡ä»¶ ä¸€ä¸ª ReentrantLock å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ã€‚ ä½¿ç”¨é€‰æ‹©é™¤ééœ€è¦ä½¿ç”¨ ReentrantLock çš„é«˜çº§åŠŸèƒ½ï¼Œå¦åˆ™ä¼˜å…ˆä½¿ç”¨ synchronizedã€‚è¿™æ˜¯å› ä¸º synchronized æ˜¯ JVM å®ç°çš„ä¸€ç§é”æœºåˆ¶ï¼ŒJVM åŸç”Ÿåœ°æ”¯æŒå®ƒï¼Œè€Œ ReentrantLock ä¸æ˜¯æ‰€æœ‰çš„ JDK ç‰ˆæœ¬éƒ½æ”¯æŒã€‚å¹¶ä¸”ä½¿ç”¨ synchronized ä¸ç”¨æ‹…å¿ƒæ²¡æœ‰é‡Šæ”¾é”è€Œå¯¼è‡´æ­»é”é—®é¢˜ï¼Œå› ä¸º JVM ä¼šç¡®ä¿é”çš„é‡Šæ”¾ã€‚ çº¿ç¨‹ä¹‹é—´çš„åä½œå½“å¤šä¸ªçº¿ç¨‹å¯ä»¥ä¸€èµ·å·¥ä½œå»è§£å†³æŸä¸ªé—®é¢˜æ—¶ï¼Œå¦‚æœæŸäº›éƒ¨åˆ†å¿…é¡»åœ¨å…¶å®ƒéƒ¨åˆ†ä¹‹å‰å®Œæˆï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹çº¿ç¨‹è¿›è¡Œåè°ƒã€‚ join()åœ¨çº¿ç¨‹ä¸­è°ƒç”¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ join() æ–¹æ³•ï¼Œä¼šå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œè€Œä¸æ˜¯å¿™ç­‰å¾…ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹ç»“æŸã€‚ å¯¹äºä»¥ä¸‹ä»£ç ï¼Œè™½ç„¶ b çº¿ç¨‹å…ˆå¯åŠ¨ï¼Œä½†æ˜¯å› ä¸ºåœ¨ b çº¿ç¨‹ä¸­è°ƒç”¨äº† a çº¿ç¨‹çš„ join() æ–¹æ³•ï¼Œb çº¿ç¨‹ä¼šç­‰å¾… a çº¿ç¨‹ç»“æŸæ‰ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤æœ€åèƒ½å¤Ÿä¿è¯ a çº¿ç¨‹çš„è¾“å‡ºå…ˆäº b çº¿ç¨‹çš„è¾“å‡ºã€‚ 1234567891011121314151617181920212223242526272829303132333435public class JoinExample &#123; private class A extends Thread &#123; @Override public void run() &#123; System.out.println(&quot;A&quot;); &#125; &#125; private class B extends Thread &#123; private A a; B(A a) &#123; this.a = a; &#125; @Override public void run() &#123; try &#123; a.join(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;B&quot;); &#125; &#125; public void test() &#123; A a = new A(); B b = new B(a); b.start(); a.start(); &#125;&#125; 1234public static void main(String[] args) &#123; JoinExample example = new JoinExample(); example.test();&#125; 12AB wait() notify() notifyAll()è°ƒç”¨ wait() ä½¿å¾—çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ—¶ä¼šè¢«æŒ‚èµ·ï¼Œå½“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œä½¿å¾—è¿™ä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹ä¼šè°ƒç”¨ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ã€‚ å®ƒä»¬éƒ½å±äº Object çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸å±äº Threadã€‚ åªèƒ½ç”¨åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥æ§åˆ¶å—ä¸­ä½¿ç”¨ï¼Œå¦åˆ™ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡º IllegalMonitorStateExeceptionã€‚ ä½¿ç”¨ wait() æŒ‚èµ·æœŸé—´ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾é”ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾é”ï¼Œé‚£ä¹ˆå…¶å®ƒçº¿ç¨‹å°±æ— æ³•è¿›å…¥å¯¹è±¡çš„åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥æ§åˆ¶å—ä¸­ï¼Œé‚£ä¹ˆå°±æ— æ³•æ‰§è¡Œ notify() æˆ–è€… notifyAll() æ¥å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹ï¼Œé€ æˆæ­»é”ã€‚ 123456789101112131415public class WaitNotifyExample &#123; public synchronized void before() &#123; System.out.println(&quot;before&quot;); notifyAll(); &#125; public synchronized void after() &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(&quot;after&quot;); &#125;&#125; 123456public static void main(String[] args) &#123; ExecutorService executorService = Executors.newCachedThreadPool(); WaitNotifyExample example = new WaitNotifyExample(); executorService.execute(() -&gt; example.after()); executorService.execute(() -&gt; example.before());&#125; 12beforeafter wait() å’Œ sleep() çš„åŒºåˆ« wait() æ˜¯ Object çš„æ–¹æ³•ï¼Œè€Œ sleep() æ˜¯ Thread çš„é™æ€æ–¹æ³•ï¼› wait() ä¼šé‡Šæ”¾é”ï¼Œsleep() ä¸ä¼šã€‚ await() signal() signalAll()java.util.concurrent ç±»åº“ä¸­æä¾›äº† Condition ç±»æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åè°ƒï¼Œå¯ä»¥åœ¨ Condition ä¸Šè°ƒç”¨ await() æ–¹æ³•ä½¿çº¿ç¨‹ç­‰å¾…ï¼Œå…¶å®ƒçº¿ç¨‹è°ƒç”¨ signal() æˆ– signalAll() æ–¹æ³•å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚ç›¸æ¯”äº wait() è¿™ç§ç­‰å¾…æ–¹å¼ï¼Œawait() å¯ä»¥æŒ‡å®šç­‰å¾…çš„æ¡ä»¶ï¼Œå› æ­¤æ›´åŠ çµæ´»ã€‚ ä½¿ç”¨ Lock æ¥è·å–ä¸€ä¸ª Condition å¯¹è±¡ã€‚ 1234567891011121314151617181920212223242526public class AwaitSignalExample &#123; private Lock lock = new ReentrantLock(); private Condition condition = lock.newCondition(); public void before() &#123; lock.lock(); try &#123; System.out.println(&quot;before&quot;); condition.signalAll(); &#125; finally &#123; lock.unlock(); &#125; &#125; public void after() &#123; lock.lock(); try &#123; condition.await(); System.out.println(&quot;after&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;&#125; 123456public static void main(String[] args) &#123; ExecutorService executorService = Executors.newCachedThreadPool(); AwaitSignalExample example = new AwaitSignalExample(); executorService.execute(() -&gt; example.after()); executorService.execute(() -&gt; example.before());&#125; 12beforeafter","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"]},{"title":"2.Java å¹¶å‘ - ç†è®ºåŸºç¡€","path":"/2023/12/25/2-Java-å¹¶å‘-ç†è®ºåŸºç¡€/","content":"æœ¬æ–‡ä»ç†è®ºçš„è§’åº¦å¼•å…¥å¹¶å‘å®‰å…¨é—®é¢˜ä»¥åŠJMMåº”å¯¹å¹¶å‘é—®é¢˜çš„åŸç†ã€‚ å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£ æç¤º è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£å¹¶å‘ç†è®ºåŸºç¡€ã€‚ å¤šçº¿ç¨‹çš„å‡ºç°æ˜¯è¦è§£å†³ä»€ä¹ˆé—®é¢˜çš„? çº¿ç¨‹ä¸å®‰å…¨æ˜¯æŒ‡ä»€ä¹ˆ? ä¸¾ä¾‹è¯´æ˜ å¹¶å‘å‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æœ¬è´¨ä»€ä¹ˆ? å¯è§æ€§ï¼ŒåŸå­æ€§å’Œæœ‰åºæ€§ã€‚ Javaæ˜¯æ€ä¹ˆè§£å†³å¹¶å‘é—®é¢˜çš„? 3ä¸ªå…³é”®å­—ï¼ŒJMMå’Œ8ä¸ªHappens-Before çº¿ç¨‹å®‰å…¨æ˜¯ä¸æ˜¯éçœŸå³å‡? ä¸æ˜¯ çº¿ç¨‹å®‰å…¨æœ‰å“ªäº›å®ç°æ€è·¯? å¦‚ä½•ç†è§£å¹¶å‘å’Œå¹¶è¡Œçš„åŒºåˆ«? ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹ä¼—æ‰€å‘¨çŸ¥ï¼ŒCPUã€å†…å­˜ã€I&#x2F;O è®¾å¤‡çš„é€Ÿåº¦æ˜¯æœ‰æå¤§å·®å¼‚çš„ï¼Œä¸ºäº†åˆç†åˆ©ç”¨ CPU çš„é«˜æ€§èƒ½ï¼Œå¹³è¡¡è¿™ä¸‰è€…çš„é€Ÿåº¦å·®å¼‚ï¼Œè®¡ç®—æœºä½“ç³»ç»“æ„ã€æ“ä½œç³»ç»Ÿã€ç¼–è¯‘ç¨‹åºéƒ½åšå‡ºäº†è´¡çŒ®ï¼Œä¸»è¦ä½“ç°ä¸º: CPU å¢åŠ äº†ç¼“å­˜ï¼Œä»¥å‡è¡¡ä¸å†…å­˜çš„é€Ÿåº¦å·®å¼‚ï¼›&#x2F;&#x2F; å¯¼è‡´ å¯è§æ€§é—®é¢˜ æ“ä½œç³»ç»Ÿå¢åŠ äº†è¿›ç¨‹ã€çº¿ç¨‹ï¼Œä»¥åˆ†æ—¶å¤ç”¨ CPUï¼Œè¿›è€Œå‡è¡¡ CPU ä¸ I&#x2F;O è®¾å¤‡çš„é€Ÿåº¦å·®å¼‚ï¼›&#x2F;&#x2F; å¯¼è‡´ åŸå­æ€§é—®é¢˜ ç¼–è¯‘ç¨‹åºä¼˜åŒ–æŒ‡ä»¤æ‰§è¡Œæ¬¡åºï¼Œä½¿å¾—ç¼“å­˜èƒ½å¤Ÿå¾—åˆ°æ›´åŠ åˆç†åœ°åˆ©ç”¨ã€‚&#x2F;&#x2F; å¯¼è‡´ æœ‰åºæ€§é—®é¢˜ çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹å¦‚æœå¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå…±äº«æ•°æ®è¿›è¡Œè®¿é—®è€Œä¸é‡‡å–åŒæ­¥æ“ä½œçš„è¯ï¼Œé‚£ä¹ˆæ“ä½œçš„ç»“æœæ˜¯ä¸ä¸€è‡´çš„ã€‚ ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº† 1000 ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ cnt æ‰§è¡Œè‡ªå¢æ“ä½œï¼Œæ“ä½œç»“æŸä¹‹åå®ƒçš„å€¼æœ‰å¯èƒ½å°äº 1000ã€‚ 12345678910111213141516171819202122232425262728public class ThreadUnsafeExample &#123; private int cnt = 0; public void add() &#123; cnt++; &#125; public int get() &#123; return cnt; &#125;&#125;public static void main(String[] args) throws InterruptedException &#123; final int threadSize = 1000; ThreadUnsafeExample example = new ThreadUnsafeExample(); final CountDownLatch countDownLatch = new CountDownLatch(threadSize); ExecutorService executorService = Executors.newCachedThreadPool(); for (int i = 0; i &lt; threadSize; i++) &#123; executorService.execute(() -&gt; &#123; example.add(); countDownLatch.countDown(); &#125;); &#125; countDownLatch.await(); executorService.shutdown(); System.out.println(example.get());&#125;997 // ç»“æœæ€»æ˜¯å°äº1000 å¹¶å‘å‡ºç°é—®é¢˜çš„æ ¹æº: å¹¶å‘ä¸‰è¦ç´ ä¸Šè¿°ä»£ç è¾“å‡ºä¸ºä»€ä¹ˆä¸æ˜¯1000? å¹¶å‘å‡ºç°é—®é¢˜çš„æ ¹æºæ˜¯ä»€ä¹ˆ? å¯è§æ€§: CPUç¼“å­˜å¼•èµ·å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ã€‚ ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š 123456//çº¿ç¨‹1æ‰§è¡Œçš„ä»£ç int i = 0;i = 10; //çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç j = i; å‡è‹¥æ‰§è¡Œçº¿ç¨‹1çš„æ˜¯CPU1ï¼Œæ‰§è¡Œçº¿ç¨‹2çš„æ˜¯CPU2ã€‚ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œå½“çº¿ç¨‹1æ‰§è¡Œ i &#x3D;10è¿™å¥æ—¶ï¼Œä¼šå…ˆæŠŠiçš„åˆå§‹å€¼åŠ è½½åˆ°CPU1çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œç„¶åèµ‹å€¼ä¸º10ï¼Œé‚£ä¹ˆåœ¨CPU1çš„é«˜é€Ÿç¼“å­˜å½“ä¸­içš„å€¼å˜ä¸º10äº†ï¼Œå´æ²¡æœ‰ç«‹å³å†™å…¥åˆ°ä¸»å­˜å½“ä¸­ã€‚ æ­¤æ—¶çº¿ç¨‹2æ‰§è¡Œ j &#x3D; iï¼Œå®ƒä¼šå…ˆå»ä¸»å­˜è¯»å–içš„å€¼å¹¶åŠ è½½åˆ°CPU2çš„ç¼“å­˜å½“ä¸­ï¼Œæ³¨æ„æ­¤æ—¶å†…å­˜å½“ä¸­içš„å€¼è¿˜æ˜¯0ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—jçš„å€¼ä¸º0ï¼Œè€Œä¸æ˜¯10. è¿™å°±æ˜¯å¯è§æ€§é—®é¢˜ï¼Œçº¿ç¨‹1å¯¹å˜é‡iä¿®æ”¹äº†ä¹‹åï¼Œçº¿ç¨‹2æ²¡æœ‰ç«‹å³çœ‹åˆ°çº¿ç¨‹1ä¿®æ”¹çš„å€¼ã€‚ åŸå­æ€§: åˆ†æ—¶å¤ç”¨å¼•èµ·åŸå­æ€§ï¼šå³ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œ è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¹¶ä¸”æ‰§è¡Œçš„è¿‡ç¨‹ä¸ä¼šè¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œè¦ä¹ˆå°±éƒ½ä¸æ‰§è¡Œã€‚ ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š 1234567int i = 1;// çº¿ç¨‹1æ‰§è¡Œi += 1;// çº¿ç¨‹2æ‰§è¡Œi += 1; è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ši += 1éœ€è¦ä¸‰æ¡ CPU æŒ‡ä»¤ å°†å˜é‡ i ä»å†…å­˜è¯»å–åˆ° CPUå¯„å­˜å™¨ï¼› åœ¨CPUå¯„å­˜å™¨ä¸­æ‰§è¡Œ i + 1 æ“ä½œï¼› å°†æœ€åçš„ç»“æœiå†™å…¥å†…å­˜ï¼ˆç¼“å­˜æœºåˆ¶å¯¼è‡´å¯èƒ½å†™å…¥çš„æ˜¯ CPU ç¼“å­˜è€Œä¸æ˜¯å†…å­˜ï¼‰ã€‚ ç”±äºCPUåˆ†æ—¶å¤ç”¨ï¼ˆçº¿ç¨‹åˆ‡æ¢ï¼‰çš„å­˜åœ¨ï¼Œçº¿ç¨‹1æ‰§è¡Œäº†ç¬¬ä¸€æ¡æŒ‡ä»¤åï¼Œå°±åˆ‡æ¢åˆ°çº¿ç¨‹2æ‰§è¡Œï¼Œå‡å¦‚çº¿ç¨‹2æ‰§è¡Œäº†è¿™ä¸‰æ¡æŒ‡ä»¤åï¼Œå†åˆ‡æ¢ä¼šçº¿ç¨‹1æ‰§è¡Œåç»­ä¸¤æ¡æŒ‡ä»¤ï¼Œå°†é€ æˆæœ€åå†™åˆ°å†…å­˜ä¸­çš„iå€¼æ˜¯2è€Œä¸æ˜¯3ã€‚ æœ‰åºæ€§: é‡æ’åºå¼•èµ·æœ‰åºæ€§ï¼šå³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š 1234int i = 0; boolean flag = false;i = 1; //è¯­å¥1 flag = true; //è¯­å¥2 ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªintå‹å˜é‡ï¼Œå®šä¹‰äº†ä¸€ä¸ªbooleanç±»å‹å˜é‡ï¼Œç„¶ååˆ†åˆ«å¯¹ä¸¤ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼æ“ä½œã€‚ä»ä»£ç é¡ºåºä¸Šçœ‹ï¼Œè¯­å¥1æ˜¯åœ¨è¯­å¥2å‰é¢çš„ï¼Œé‚£ä¹ˆJVMåœ¨çœŸæ­£æ‰§è¡Œè¿™æ®µä»£ç çš„æ—¶å€™ä¼šä¿è¯è¯­å¥1ä¸€å®šä¼šåœ¨è¯­å¥2å‰é¢æ‰§è¡Œå—? ä¸ä¸€å®šï¼Œä¸ºä»€ä¹ˆå‘¢? è¿™é‡Œå¯èƒ½ä¼šå‘ç”ŸæŒ‡ä»¤é‡æ’åºï¼ˆInstruction Reorderï¼‰ã€‚ åœ¨æ‰§è¡Œç¨‹åºæ—¶ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚é‡æ’åºåˆ†ä¸‰ç§ç±»å‹ï¼š ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚ æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-Level Parallelismï¼Œ ILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚ å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯» &#x2F; å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚ ä» java æºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢ä¸‰ç§é‡æ’åºï¼š ä¸Šè¿°çš„ 1 å±äºç¼–è¯‘å™¨é‡æ’åºï¼Œ2 å’Œ 3 å±äºå¤„ç†å™¨é‡æ’åºã€‚è¿™äº›é‡æ’åºéƒ½å¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚å¯¹äºç¼–è¯‘å™¨ï¼ŒJMM çš„ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™ä¼šç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„ç¼–è¯‘å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚å¯¹äºå¤„ç†å™¨é‡æ’åºï¼ŒJMM çš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚ java ç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶ï¼Œæ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœï¼ˆmemory barriersï¼Œintel ç§°ä¹‹ä¸º memory fenceï¼‰æŒ‡ä»¤ï¼Œé€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚ å…·ä½“å¯ä»¥å‚çœ‹ï¼šJava å†…å­˜æ¨¡å‹è¯¦è§£çš„é‡æ’åºç« èŠ‚ã€‚ JAVAæ˜¯æ€ä¹ˆè§£å†³å¹¶å‘é—®é¢˜çš„: JMM(Javaå†…å­˜æ¨¡å‹)Java å†…å­˜æ¨¡å‹æ˜¯ä¸ªå¾ˆå¤æ‚çš„è§„èŒƒï¼Œå¼ºçƒˆæ¨èä½ çœ‹åç»­ï¼ˆåº”è¯¥æ˜¯ç½‘ä¸Šèƒ½æ‰¾åˆ°æœ€å¥½çš„ææ–™ä¹‹ä¸€äº†ï¼‰ï¼šJava å†…å­˜æ¨¡å‹è¯¦è§£ã€‚ ç†è§£çš„ç¬¬ä¸€ä¸ªç»´åº¦ï¼šæ ¸å¿ƒçŸ¥è¯†ç‚¹ JMMæœ¬è´¨ä¸Šå¯ä»¥ç†è§£ä¸ºï¼ŒJava å†…å­˜æ¨¡å‹è§„èŒƒäº† JVM å¦‚ä½•æä¾›æŒ‰éœ€ç¦ç”¨ç¼“å­˜å’Œç¼–è¯‘ä¼˜åŒ–çš„æ–¹æ³•ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™äº›æ–¹æ³•åŒ…æ‹¬ï¼š volatileã€synchronized å’Œ final ä¸‰ä¸ªå…³é”®å­— Happens-Before è§„åˆ™ ç†è§£çš„ç¬¬äºŒä¸ªç»´åº¦ï¼šå¯è§æ€§ï¼Œæœ‰åºæ€§ï¼ŒåŸå­æ€§ åŸå­æ€§ åœ¨Javaä¸­ï¼Œå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡çš„è¯»å–å’Œèµ‹å€¼æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼Œå³è¿™äº›æ“ä½œæ˜¯ä¸å¯è¢«ä¸­æ–­çš„ï¼Œè¦ä¹ˆæ‰§è¡Œï¼Œè¦ä¹ˆä¸æ‰§è¡Œã€‚ è¯·åˆ†æä»¥ä¸‹å“ªäº›æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼š 1234x = 10; //è¯­å¥1: ç›´æ¥å°†æ•°å€¼10èµ‹å€¼ç»™xï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥çš„ä¼šç›´æ¥å°†æ•°å€¼10å†™å…¥åˆ°å·¥ä½œå†…å­˜ä¸­y = x; //è¯­å¥2: åŒ…å«2ä¸ªæ“ä½œï¼Œå®ƒå…ˆè¦å»è¯»å–xçš„å€¼ï¼Œå†å°†xçš„å€¼å†™å…¥å·¥ä½œå†…å­˜ï¼Œè™½ç„¶è¯»å–xçš„å€¼ä»¥åŠ å°†xçš„å€¼å†™å…¥å·¥ä½œå†…å­˜ è¿™2ä¸ªæ“ä½œéƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œä½†æ˜¯åˆèµ·æ¥å°±ä¸æ˜¯åŸå­æ€§æ“ä½œäº†ã€‚x++; //è¯­å¥3ï¼š x++åŒ…æ‹¬3ä¸ªæ“ä½œï¼šè¯»å–xçš„å€¼ï¼Œè¿›è¡ŒåŠ 1æ“ä½œï¼Œå†™å…¥æ–°çš„å€¼ã€‚x = x + 1; //è¯­å¥4ï¼š åŒè¯­å¥3 ä¸Šé¢4ä¸ªè¯­å¥åªæœ‰è¯­å¥1çš„æ“ä½œå…·å¤‡åŸå­æ€§ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ç®€å•çš„è¯»å–ã€èµ‹å€¼ï¼ˆè€Œä¸”å¿…é¡»æ˜¯å°†æ•°å­—èµ‹å€¼ç»™æŸä¸ªå˜é‡ï¼Œå˜é‡ä¹‹é—´çš„ç›¸äº’èµ‹å€¼ä¸æ˜¯åŸå­æ“ä½œï¼‰æ‰æ˜¯åŸå­æ“ä½œã€‚ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒJavaå†…å­˜æ¨¡å‹åªä¿è¯äº†åŸºæœ¬è¯»å–å’Œèµ‹å€¼æ˜¯åŸå­æ€§æ“ä½œï¼Œå¦‚æœè¦å®ç°æ›´å¤§èŒƒå›´æ“ä½œçš„åŸå­æ€§ï¼Œå¯ä»¥é€šè¿‡synchronizedå’ŒLockæ¥å®ç°ã€‚ç”±äºsynchronizedå’ŒLockèƒ½å¤Ÿä¿è¯ä»»ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥ä»£ç å—ï¼Œé‚£ä¹ˆè‡ªç„¶å°±ä¸å­˜åœ¨åŸå­æ€§é—®é¢˜äº†ï¼Œä»è€Œä¿è¯äº†åŸå­æ€§ã€‚ å¯è§æ€§ Javaæä¾›äº†volatileå…³é”®å­—æ¥ä¿è¯å¯è§æ€§ã€‚ å½“ä¸€ä¸ªå…±äº«å˜é‡è¢«volatileä¿®é¥°æ—¶ï¼Œå®ƒä¼šä¿è¯ä¿®æ”¹çš„å€¼ä¼šç«‹å³è¢«æ›´æ–°åˆ°ä¸»å­˜ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦è¯»å–æ—¶ï¼Œå®ƒä¼šå»å†…å­˜ä¸­è¯»å–æ–°å€¼ã€‚ è€Œæ™®é€šçš„å…±äº«å˜é‡ä¸èƒ½ä¿è¯å¯è§æ€§ï¼Œå› ä¸ºæ™®é€šå…±äº«å˜é‡è¢«ä¿®æ”¹ä¹‹åï¼Œä»€ä¹ˆæ—¶å€™è¢«å†™å…¥ä¸»å­˜æ˜¯ä¸ç¡®å®šçš„ï¼Œå½“å…¶ä»–çº¿ç¨‹å»è¯»å–æ—¶ï¼Œæ­¤æ—¶å†…å­˜ä¸­å¯èƒ½è¿˜æ˜¯åŸæ¥çš„æ—§å€¼ï¼Œå› æ­¤æ— æ³•ä¿è¯å¯è§æ€§ã€‚ å¦å¤–ï¼Œé€šè¿‡synchronizedå’ŒLockä¹Ÿèƒ½å¤Ÿä¿è¯å¯è§æ€§ï¼Œsynchronizedå’ŒLockèƒ½ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”ç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œå¹¶ä¸”åœ¨é‡Šæ”¾é”ä¹‹å‰ä¼šå°†å¯¹å˜é‡çš„ä¿®æ”¹åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚å› æ­¤å¯ä»¥ä¿è¯å¯è§æ€§ã€‚ æœ‰åºæ€§ åœ¨Javaé‡Œé¢ï¼Œå¯ä»¥é€šè¿‡volatileå…³é”®å­—æ¥ä¿è¯ä¸€å®šçš„â€œæœ‰åºæ€§â€ï¼ˆå…·ä½“åŸç†åœ¨ä¸‹ä¸€èŠ‚è®²è¿°ï¼‰ã€‚å¦å¤–å¯ä»¥é€šè¿‡synchronizedå’ŒLockæ¥ä¿è¯æœ‰åºæ€§ï¼Œå¾ˆæ˜¾ç„¶ï¼Œsynchronizedå’ŒLockä¿è¯æ¯ä¸ªæ—¶åˆ»æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œç›¸å½“äºæ˜¯è®©çº¿ç¨‹é¡ºåºæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œè‡ªç„¶å°±ä¿è¯äº†æœ‰åºæ€§ã€‚å½“ç„¶JMMæ˜¯é€šè¿‡Happens-Before è§„åˆ™æ¥ä¿è¯æœ‰åºæ€§çš„ã€‚ å…³é”®å­—: volatileã€synchronized å’Œ finalä»¥ä¸‹ä¸‰ç¯‡æ–‡ç« è¯¦ç»†åˆ†æäº†è¿™ä¸‰ä¸ªå…³é”®å­—ï¼š å…³é”®å­—: synchronizedè¯¦è§£ å…³é”®å­—: volatileè¯¦è§£ å…³é”®å­—: finalè¯¦è§£ Happens-Before è§„åˆ™ä¸Šé¢æåˆ°äº†å¯ä»¥ç”¨ volatile å’Œ synchronized æ¥ä¿è¯æœ‰åºæ€§ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒJVM è¿˜è§„å®šäº†å…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼Œè®©ä¸€ä¸ªæ“ä½œæ— éœ€æ§åˆ¶å°±èƒ½å…ˆäºå¦ä¸€ä¸ªæ“ä½œå®Œæˆã€‚ 1. å•ä¸€çº¿ç¨‹åŸåˆ™ Single Thread rule åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼Œåœ¨ç¨‹åºå‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢çš„æ“ä½œã€‚ 2. ç®¡ç¨‹é”å®šè§„åˆ™ Monitor Lock Rule ä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚ 3. volatile å˜é‡è§„åˆ™ Volatile Variable Rule å¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œã€‚ 4. çº¿ç¨‹å¯åŠ¨è§„åˆ™ Thread Start Rule Thread å¯¹è±¡çš„ start() æ–¹æ³•è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚ 5. çº¿ç¨‹åŠ å…¥è§„åˆ™ Thread Join Rule Thread å¯¹è±¡çš„ç»“æŸå…ˆè¡Œå‘ç”Ÿäº join() æ–¹æ³•è¿”å›ã€‚ 6. çº¿ç¨‹ä¸­æ–­è§„åˆ™ Thread Interruption Rule å¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡ interrupted() æ–¹æ³•æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚ 7. å¯¹è±¡ç»ˆç»“è§„åˆ™ Finalizer Rule ä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆ(æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸ)å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹ã€‚ 8. ä¼ é€’æ€§ Transitivity å¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œé‚£ä¹ˆæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cã€‚ çº¿ç¨‹å®‰å…¨: ä¸æ˜¯ä¸€ä¸ªéçœŸå³å‡çš„å‘½é¢˜ä¸€ä¸ªç±»åœ¨å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å®‰å…¨è°ƒç”¨æ—¶å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ çº¿ç¨‹å®‰å…¨ä¸æ˜¯ä¸€ä¸ªéçœŸå³å‡çš„å‘½é¢˜ï¼Œå¯ä»¥å°†å…±äº«æ•°æ®æŒ‰ç…§å®‰å…¨ç¨‹åº¦çš„å¼ºå¼±é¡ºåºåˆ†æˆä»¥ä¸‹äº”ç±»: ä¸å¯å˜ã€ç»å¯¹çº¿ç¨‹å®‰å…¨ã€ç›¸å¯¹çº¿ç¨‹å®‰å…¨ã€çº¿ç¨‹å…¼å®¹å’Œçº¿ç¨‹å¯¹ç«‹ã€‚ 1. ä¸å¯å˜ä¸å¯å˜(Immutable)çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦å†é‡‡å–ä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ã€‚åªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®åœ°æ„å»ºå‡ºæ¥ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹ä¸­å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚ å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåº”å½“å°½é‡ä½¿å¯¹è±¡æˆä¸ºä¸å¯å˜ï¼Œæ¥æ»¡è¶³çº¿ç¨‹å®‰å…¨ã€‚ ä¸å¯å˜çš„ç±»å‹: final å…³é”®å­—ä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹ String æšä¸¾ç±»å‹ Number éƒ¨åˆ†å­ç±»ï¼Œå¦‚ Long å’Œ Double ç­‰æ•°å€¼åŒ…è£…ç±»å‹ï¼ŒBigInteger å’Œ BigDecimal ç­‰å¤§æ•°æ®ç±»å‹ã€‚ä½†åŒä¸º Number çš„åŸå­ç±» AtomicInteger å’Œ AtomicLong åˆ™æ˜¯å¯å˜çš„ã€‚ å¯¹äºé›†åˆç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ Collections.unmodifiableXXX() æ–¹æ³•æ¥è·å–ä¸€ä¸ªä¸å¯å˜çš„é›†åˆã€‚ 12345678910public class ImmutableExample &#123; public static void main(String[] args) &#123; Map&lt;String, Integer&gt; map = new HashMap&lt;&gt;(); Map&lt;String, Integer&gt; unmodifiableMap = Collections.unmodifiableMap(map); unmodifiableMap.put(&quot;a&quot;, 1); &#125;&#125;Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException at java.util.Collections$UnmodifiableMap.put(Collections.java:1457) at ImmutableExample.main(ImmutableExample.java:9) Collections.unmodifiableXXX() å…ˆå¯¹åŸå§‹çš„é›†åˆè¿›è¡Œæ‹·è´ï¼Œéœ€è¦å¯¹é›†åˆè¿›è¡Œä¿®æ”¹çš„æ–¹æ³•éƒ½ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ 123public V put(K key, V value) &#123; throw new UnsupportedOperationException();&#125; 2. ç»å¯¹çº¿ç¨‹å®‰å…¨ä¸ç®¡è¿è¡Œæ—¶ç¯å¢ƒå¦‚ä½•ï¼Œè°ƒç”¨è€…éƒ½ä¸éœ€è¦ä»»ä½•é¢å¤–çš„åŒæ­¥æªæ–½ã€‚ 3. ç›¸å¯¹çº¿ç¨‹å®‰å…¨ç›¸å¯¹çº¿ç¨‹å®‰å…¨éœ€è¦ä¿è¯å¯¹è¿™ä¸ªå¯¹è±¡å•ç‹¬çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™ä¸éœ€è¦åšé¢å¤–çš„ä¿éšœæªæ–½ã€‚ä½†æ˜¯å¯¹äºä¸€äº›ç‰¹å®šé¡ºåºçš„è¿ç»­è°ƒç”¨ï¼Œå°±å¯èƒ½éœ€è¦åœ¨è°ƒç”¨ç«¯ä½¿ç”¨é¢å¤–çš„åŒæ­¥æ‰‹æ®µæ¥ä¿è¯è°ƒç”¨çš„æ­£ç¡®æ€§ã€‚ åœ¨ Java è¯­è¨€ä¸­ï¼Œå¤§éƒ¨åˆ†çš„çº¿ç¨‹å®‰å…¨ç±»éƒ½å±äºè¿™ç§ç±»å‹ï¼Œä¾‹å¦‚ Vectorã€HashTableã€Collections çš„ synchronizedCollection() æ–¹æ³•åŒ…è£…çš„é›†åˆç­‰ã€‚ å¯¹äºä¸‹é¢çš„ä»£ç ï¼Œå¦‚æœåˆ é™¤å…ƒç´ çš„çº¿ç¨‹åˆ é™¤äº† Vector çš„ä¸€ä¸ªå…ƒç´ ï¼Œè€Œè·å–å…ƒç´ çš„çº¿ç¨‹è¯•å›¾è®¿é—®ä¸€ä¸ªå·²ç»è¢«åˆ é™¤çš„å…ƒç´ ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡º ArrayIndexOutOfBoundsExceptionã€‚ 12345678910111213141516171819202122232425262728public class VectorUnsafeExample &#123; private static Vector&lt;Integer&gt; vector = new Vector&lt;&gt;(); public static void main(String[] args) &#123; while (true) &#123; for (int i = 0; i &lt; 100; i++) &#123; vector.add(i); &#125; ExecutorService executorService = Executors.newCachedThreadPool(); executorService.execute(() -&gt; &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; vector.remove(i); &#125; &#125;); executorService.execute(() -&gt; &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; vector.get(i); &#125; &#125;); executorService.shutdown(); &#125; &#125;&#125;Exception in thread &quot;Thread-159738&quot; java.lang.ArrayIndexOutOfBoundsException: Array index out of range: 3 at java.util.Vector.remove(Vector.java:831) at VectorUnsafeExample.lambda$main$0(VectorUnsafeExample.java:14) at VectorUnsafeExample$$Lambda$1/713338599.run(Unknown Source) at java.lang.Thread.run(Thread.java:745) å¦‚æœè¦ä¿è¯ä¸Šé¢çš„ä»£ç èƒ½æ­£ç¡®æ‰§è¡Œä¸‹å»ï¼Œå°±éœ€è¦å¯¹åˆ é™¤å…ƒç´ å’Œè·å–å…ƒç´ çš„ä»£ç è¿›è¡ŒåŒæ­¥ã€‚ 1234567891011121314executorService.execute(() -&gt; &#123; synchronized (vector) &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; vector.remove(i); &#125; &#125;&#125;);executorService.execute(() -&gt; &#123; synchronized (vector) &#123; for (int i = 0; i &lt; vector.size(); i++) &#123; vector.get(i); &#125; &#125;&#125;); 4. çº¿ç¨‹å…¼å®¹çº¿ç¨‹å…¼å®¹æ˜¯æŒ‡å¯¹è±¡æœ¬èº«å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ç«¯æ­£ç¡®åœ°ä½¿ç”¨åŒæ­¥æ‰‹æ®µæ¥ä¿è¯å¯¹è±¡åœ¨å¹¶å‘ç¯å¢ƒä¸­å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ï¼Œæˆ‘ä»¬å¹³å¸¸è¯´ä¸€ä¸ªç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç»å¤§å¤šæ•°æ—¶å€™æŒ‡çš„æ˜¯è¿™ä¸€ç§æƒ…å†µã€‚Java API ä¸­å¤§éƒ¨åˆ†çš„ç±»éƒ½æ˜¯å±äºçº¿ç¨‹å…¼å®¹çš„ï¼Œå¦‚ä¸å‰é¢çš„ Vector å’Œ HashTable ç›¸å¯¹åº”çš„é›†åˆç±» ArrayList å’Œ HashMap ç­‰ã€‚ 5. çº¿ç¨‹å¯¹ç«‹çº¿ç¨‹å¯¹ç«‹æ˜¯æŒ‡æ— è®ºè°ƒç”¨ç«¯æ˜¯å¦é‡‡å–äº†åŒæ­¥æªæ–½ï¼Œéƒ½æ— æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¹¶å‘ä½¿ç”¨çš„ä»£ç ã€‚ç”±äº Java è¯­è¨€å¤©ç”Ÿå°±å…·å¤‡å¤šçº¿ç¨‹ç‰¹æ€§ï¼Œçº¿ç¨‹å¯¹ç«‹è¿™ç§æ’æ–¥å¤šçº¿ç¨‹çš„ä»£ç æ˜¯å¾ˆå°‘å‡ºç°çš„ï¼Œè€Œä¸”é€šå¸¸éƒ½æ˜¯æœ‰å®³çš„ï¼Œåº”å½“å°½é‡é¿å…ã€‚ çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•1. äº’æ–¥åŒæ­¥synchronized å’Œ ReentrantLockã€‚ åˆæ­¥äº†è§£ä½ å¯ä»¥çœ‹ï¼š Java å¹¶å‘ - çº¿ç¨‹åŸºç¡€ï¼šçº¿ç¨‹äº’æ–¥åŒæ­¥ è¯¦ç»†åˆ†æè¯·çœ‹ï¼š å…³é”®å­—: Synchronizedè¯¦è§£ JUCé”: ReentrantLockè¯¦è§£ 2. éé˜»å¡åŒæ­¥äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤è¿™ç§åŒæ­¥ä¹Ÿç§°ä¸ºé˜»å¡åŒæ­¥ã€‚ äº’æ–¥åŒæ­¥å±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜ã€‚æ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”(è¿™é‡Œè®¨è®ºçš„æ˜¯æ¦‚å¿µæ¨¡å‹ï¼Œå®é™…ä¸Šè™šæ‹Ÿæœºä¼šä¼˜åŒ–æ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„åŠ é”)ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦å”¤é†’ç­‰æ“ä½œã€‚ (ä¸€)CAS éšç€ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚å¹¶å‘ç­–ç•¥: å…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œé‚£æ“ä½œå°±æˆåŠŸäº†ï¼Œå¦åˆ™é‡‡å–è¡¥å¿æªæ–½(ä¸æ–­åœ°é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢)ã€‚è¿™ç§ä¹è§‚çš„å¹¶å‘ç­–ç•¥çš„è®¸å¤šå®ç°éƒ½ä¸éœ€è¦å°†çº¿ç¨‹é˜»å¡ï¼Œå› æ­¤è¿™ç§åŒæ­¥æ“ä½œç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚ ä¹è§‚é”éœ€è¦æ“ä½œå’Œå†²çªæ£€æµ‹è¿™ä¸¤ä¸ªæ­¥éª¤å…·å¤‡åŸå­æ€§ï¼Œè¿™é‡Œå°±ä¸èƒ½å†ä½¿ç”¨äº’æ–¥åŒæ­¥æ¥ä¿è¯äº†ï¼Œåªèƒ½é ç¡¬ä»¶æ¥å®Œæˆã€‚ç¡¬ä»¶æ”¯æŒçš„åŸå­æ€§æ“ä½œæœ€å…¸å‹çš„æ˜¯: æ¯”è¾ƒå¹¶äº¤æ¢(Compare-and-Swapï¼ŒCAS)ã€‚CAS æŒ‡ä»¤éœ€è¦æœ‰ 3 ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯å†…å­˜åœ°å€ Vã€æ—§çš„é¢„æœŸå€¼ A å’Œæ–°å€¼ Bã€‚å½“æ‰§è¡Œæ“ä½œæ—¶ï¼Œåªæœ‰å½“ V çš„å€¼ç­‰äº Aï¼Œæ‰å°† V çš„å€¼æ›´æ–°ä¸º Bã€‚ (äºŒ)AtomicInteger J.U.C åŒ…é‡Œé¢çš„æ•´æ•°åŸå­ç±» AtomicIntegerï¼Œå…¶ä¸­çš„ compareAndSet() å’Œ getAndIncrement() ç­‰æ–¹æ³•éƒ½ä½¿ç”¨äº† Unsafe ç±»çš„ CAS æ“ä½œã€‚ ä»¥ä¸‹ä»£ç ä½¿ç”¨äº† AtomicInteger æ‰§è¡Œäº†è‡ªå¢çš„æ“ä½œã€‚ 12345private AtomicInteger cnt = new AtomicInteger();public void add() &#123; cnt.incrementAndGet();&#125; ä»¥ä¸‹ä»£ç æ˜¯ incrementAndGet() çš„æºç ï¼Œå®ƒè°ƒç”¨äº† unsafe çš„ getAndAddInt() ã€‚ 123public final int incrementAndGet() &#123; return unsafe.getAndAddInt(this, valueOffset, 1) + 1;&#125; ä»¥ä¸‹ä»£ç æ˜¯ getAndAddInt() æºç ï¼Œvar1 æŒ‡ç¤ºå¯¹è±¡å†…å­˜åœ°å€ï¼Œvar2 æŒ‡ç¤ºè¯¥å­—æ®µç›¸å¯¹å¯¹è±¡å†…å­˜åœ°å€çš„åç§»ï¼Œvar4 æŒ‡ç¤ºæ“ä½œéœ€è¦åŠ çš„æ•°å€¼ï¼Œè¿™é‡Œä¸º 1ã€‚é€šè¿‡ getIntVolatile(var1, var2) å¾—åˆ°æ—§çš„é¢„æœŸå€¼ï¼Œé€šè¿‡è°ƒç”¨ compareAndSwapInt() æ¥è¿›è¡Œ CAS æ¯”è¾ƒï¼Œå¦‚æœè¯¥å­—æ®µå†…å­˜åœ°å€ä¸­çš„å€¼ç­‰äº var5ï¼Œé‚£ä¹ˆå°±æ›´æ–°å†…å­˜åœ°å€ä¸º var1+var2 çš„å˜é‡ä¸º var5+var4ã€‚ å¯ä»¥çœ‹åˆ° getAndAddInt() åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¿›è¡Œï¼Œå‘ç”Ÿå†²çªçš„åšæ³•æ˜¯ä¸æ–­çš„è¿›è¡Œé‡è¯•ã€‚ 12345678public final int getAndAddInt(Object var1, long var2, int var4) &#123; int var5; do &#123; var5 = this.getIntVolatile(var1, var2); &#125; while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4)); return var5;&#125; (ä¸‰)ABA å¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œåæ¥åˆè¢«æ”¹å›ä¸º Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«æ”¹å˜è¿‡ã€‚ J.U.C åŒ…æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„åŸå­å¼•ç”¨ç±» AtomicStampedReference æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯ CAS çš„æ­£ç¡®æ€§ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ ABA é—®é¢˜ä¸ä¼šå½±å“ç¨‹åºå¹¶å‘çš„æ­£ç¡®æ€§ï¼Œå¦‚æœéœ€è¦è§£å†³ ABA é—®é¢˜ï¼Œæ”¹ç”¨ä¼ ç»Ÿçš„äº’æ–¥åŒæ­¥å¯èƒ½ä¼šæ¯”åŸå­ç±»æ›´é«˜æ•ˆã€‚ CAS, Unsafeå’ŒåŸå­ç±»è¯¦ç»†åˆ†æè¯·çœ‹ï¼š JUCåŸå­ç±»: CAS, Unsafeå’ŒåŸå­ç±»è¯¦è§£ 3. æ— åŒæ­¥æ–¹æ¡ˆè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸æ˜¯ä¸€å®šå°±è¦è¿›è¡ŒåŒæ­¥ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•æœ¬æ¥å°±ä¸æ¶‰åŠå…±äº«æ•°æ®ï¼Œé‚£å®ƒè‡ªç„¶å°±æ— é¡»ä»»ä½•åŒæ­¥æªæ–½å»ä¿è¯æ­£ç¡®æ€§ã€‚ (ä¸€)æ ˆå°é—­ å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªæ–¹æ³•çš„å±€éƒ¨å˜é‡æ—¶ï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå±€éƒ¨å˜é‡å­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆä¸­ï¼Œå±äºçº¿ç¨‹ç§æœ‰çš„ã€‚ 123456789101112131415161718192021import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;public class StackClosedExample &#123; public void add100() &#123; int cnt = 0; for (int i = 0; i &lt; 100; i++) &#123; cnt++; &#125; System.out.println(cnt); &#125;&#125;public static void main(String[] args) &#123; StackClosedExample example = new StackClosedExample(); ExecutorService executorService = Executors.newCachedThreadPool(); executorService.execute(() -&gt; example.add100()); executorService.execute(() -&gt; example.add100()); executorService.shutdown();&#125;100100 æ›´è¯¦ç»†çš„åˆ†æè¯·çœ‹J.U.Cä¸­çº¿ç¨‹æ± ç›¸å…³å†…å®¹è¯¦è§£ï¼š JUCçº¿ç¨‹æ± : FutureTaskè¯¦è§£ JUCçº¿ç¨‹æ± : ThreadPoolExecutorè¯¦è§£ JUCçº¿ç¨‹æ± : ScheduledThreadPoolè¯¦è§£ JUCçº¿ç¨‹æ± : Fork&#x2F;Joinæ¡†æ¶è¯¦è§£ (äºŒ)çº¿ç¨‹æœ¬åœ°å­˜å‚¨(Thread Local Storage) å¦‚æœä¸€æ®µä»£ç ä¸­æ‰€éœ€è¦çš„æ•°æ®å¿…é¡»ä¸å…¶ä»–ä»£ç å…±äº«ï¼Œé‚£å°±çœ‹çœ‹è¿™äº›å…±äº«æ•°æ®çš„ä»£ç æ˜¯å¦èƒ½ä¿è¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æœèƒ½ä¿è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…±äº«æ•°æ®çš„å¯è§èŒƒå›´é™åˆ¶åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œè¿™æ ·ï¼Œæ— é¡»åŒæ­¥ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹ä¹‹é—´ä¸å‡ºç°æ•°æ®äº‰ç”¨çš„é—®é¢˜ã€‚ ç¬¦åˆè¿™ç§ç‰¹ç‚¹çš„åº”ç”¨å¹¶ä¸å°‘è§ï¼Œå¤§éƒ¨åˆ†ä½¿ç”¨æ¶ˆè´¹é˜Ÿåˆ—çš„æ¶æ„æ¨¡å¼(å¦‚â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€æ¨¡å¼)éƒ½ä¼šå°†äº§å“çš„æ¶ˆè´¹è¿‡ç¨‹å°½é‡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ¶ˆè´¹å®Œã€‚å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹å°±æ˜¯ç»å…¸ Web äº¤äº’æ¨¡å‹ä¸­çš„â€œä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªæœåŠ¡å™¨çº¿ç¨‹â€(Thread-per-Request)çš„å¤„ç†æ–¹å¼ï¼Œè¿™ç§å¤„ç†æ–¹å¼çš„å¹¿æ³›åº”ç”¨ä½¿å¾—å¾ˆå¤š Web æœåŠ¡ç«¯åº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ å¯ä»¥ä½¿ç”¨ java.lang.ThreadLocal ç±»æ¥å®ç°çº¿ç¨‹æœ¬åœ°å­˜å‚¨åŠŸèƒ½ã€‚ å¯¹äºä»¥ä¸‹ä»£ç ï¼Œthread1 ä¸­è®¾ç½® threadLocal ä¸º 1ï¼Œè€Œ thread2 è®¾ç½® threadLocal ä¸º 2ã€‚è¿‡äº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œthread1 è¯»å– threadLocal ä¾ç„¶æ˜¯ 1ï¼Œä¸å— thread2 çš„å½±å“ã€‚ 123456789101112131415161718192021public class ThreadLocalExample &#123; public static void main(String[] args) &#123; ThreadLocal threadLocal = new ThreadLocal(); Thread thread1 = new Thread(() -&gt; &#123; threadLocal.set(1); try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(threadLocal.get()); threadLocal.remove(); &#125;); Thread thread2 = new Thread(() -&gt; &#123; threadLocal.set(2); threadLocal.remove(); &#125;); thread1.start(); thread2.start(); &#125;&#125; è¾“å‡ºç»“æœ 11 ä¸ºäº†ç†è§£ ThreadLocalï¼Œå…ˆçœ‹ä»¥ä¸‹ä»£ç : 12345678910111213141516public class ThreadLocalExample1 &#123; public static void main(String[] args) &#123; ThreadLocal threadLocal1 = new ThreadLocal(); ThreadLocal threadLocal2 = new ThreadLocal(); Thread thread1 = new Thread(() -&gt; &#123; threadLocal1.set(1); threadLocal2.set(1); &#125;); Thread thread2 = new Thread(() -&gt; &#123; threadLocal1.set(2); threadLocal2.set(2); &#125;); thread1.start(); thread2.start(); &#125;&#125; å®ƒæ‰€å¯¹åº”çš„åº•å±‚ç»“æ„å›¾ä¸º: æ¯ä¸ª Thread éƒ½æœ‰ä¸€ä¸ª ThreadLocal.ThreadLocalMap å¯¹è±¡ï¼ŒThread ç±»ä¸­å°±å®šä¹‰äº† ThreadLocal.ThreadLocalMap æˆå‘˜ã€‚ 123/* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ThreadLocal.ThreadLocalMap threadLocals = null; å½“è°ƒç”¨ä¸€ä¸ª ThreadLocal çš„ set(T value) æ–¹æ³•æ—¶ï¼Œå…ˆå¾—åˆ°å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åå°† ThreadLocal-&gt;value é”®å€¼å¯¹æ’å…¥åˆ°è¯¥ Map ä¸­ã€‚ 12345678public void set(T value) &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value);&#125; get() æ–¹æ³•ç±»ä¼¼ã€‚ 12345678910111213public T get() &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) &#123; ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; @SuppressWarnings(&quot;unchecked&quot;) T result = (T)e.value; return result; &#125; &#125; return setInitialValue();&#125; ThreadLocal ä»ç†è®ºä¸Šè®²å¹¶ä¸æ˜¯ç”¨æ¥è§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜çš„ï¼Œå› ä¸ºæ ¹æœ¬ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ã€‚ åœ¨ä¸€äº›åœºæ™¯ (å°¤å…¶æ˜¯ä½¿ç”¨çº¿ç¨‹æ± ) ä¸‹ï¼Œç”±äº ThreadLocal.ThreadLocalMap çš„åº•å±‚æ•°æ®ç»“æ„å¯¼è‡´ ThreadLocal æœ‰å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œåº”è¯¥å°½å¯èƒ½åœ¨æ¯æ¬¡ä½¿ç”¨ ThreadLocal åæ‰‹åŠ¨è°ƒç”¨ remove()ï¼Œä»¥é¿å…å‡ºç° ThreadLocal ç»å…¸çš„å†…å­˜æ³„æ¼ç”šè‡³æ˜¯é€ æˆè‡ªèº«ä¸šåŠ¡æ··ä¹±çš„é£é™©ã€‚ æ›´è¯¦ç»†çš„åˆ†æçœ‹ï¼šJava å¹¶å‘ - ThreadLocalè¯¦è§£ (ä¸‰)å¯é‡å…¥ä»£ç (Reentrant Code) è¿™ç§ä»£ç ä¹Ÿå«åšçº¯ä»£ç (Pure Code)ï¼Œå¯ä»¥åœ¨ä»£ç æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬è€Œå»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç (åŒ…æ‹¬é€’å½’è°ƒç”¨å®ƒæœ¬èº«)ï¼Œè€Œåœ¨æ§åˆ¶æƒè¿”å›åï¼ŒåŸæ¥çš„ç¨‹åºä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚ å¯é‡å…¥ä»£ç æœ‰ä¸€äº›å…±åŒçš„ç‰¹å¾ï¼Œä¾‹å¦‚ä¸ä¾èµ–å­˜å‚¨åœ¨å †ä¸Šçš„æ•°æ®å’Œå…¬ç”¨çš„ç³»ç»Ÿèµ„æºã€ç”¨åˆ°çš„çŠ¶æ€é‡éƒ½ç”±å‚æ•°ä¸­ä¼ å…¥ã€ä¸è°ƒç”¨éå¯é‡å…¥çš„æ–¹æ³•ç­‰ã€‚","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"]},{"title":"1.Javaå¹¶å‘çŸ¥è¯†ä½“ç³»è¯¦è§£","path":"/2023/12/25/1-Javaå¹¶å‘çŸ¥è¯†ä½“ç³»è¯¦è§£/","content":"Java å¹¶å‘ç›¸å…³çŸ¥è¯†ä½“ç³»è¯¦è§£ï¼ŒåŒ…å«ç†è®ºåŸºç¡€ï¼Œçº¿ç¨‹åŸºç¡€ï¼Œsynchronizedï¼Œvolatileï¼Œfinalå…³é”®å­—, JUCæ¡†æ¶ç­‰å†…å®¹ã€‚ çŸ¥è¯†ä½“ç³» ç›¸å…³æ–‡ç«  A. Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹åŸºç¡€ï¼šé¦–å…ˆå…¨å±€çš„äº†è§£å¹¶å‘çš„çŸ¥è¯†ä½“ç³»ï¼ŒåŒæ—¶äº†è§£å¹¶å‘ç†è®ºåŸºç¡€å’Œçº¿ç¨‹åŸºç¡€ï¼Œå¹¶å‘å…³é”®å­—ç­‰ï¼Œè¿™äº›æ˜¯ä½ ç†è§£Javaå¹¶å‘æ¡†æ¶çš„åŸºç¡€ã€‚ Java å¹¶å‘ - çŸ¥è¯†ä½“ç³» Java å¹¶å‘ - ç†è®ºåŸºç¡€ å¤šçº¿ç¨‹çš„å‡ºç°æ˜¯è¦è§£å†³ä»€ä¹ˆé—®é¢˜çš„? çº¿ç¨‹ä¸å®‰å…¨æ˜¯æŒ‡ä»€ä¹ˆ? ä¸¾ä¾‹è¯´æ˜ å¹¶å‘å‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æœ¬è´¨ä»€ä¹ˆ? å¯è§æ€§ï¼ŒåŸå­æ€§å’Œæœ‰åºæ€§ã€‚ Javaæ˜¯æ€ä¹ˆè§£å†³å¹¶å‘é—®é¢˜çš„? 3ä¸ªå…³é”®å­—ï¼ŒJMMå’Œ8ä¸ªHappens-Before çº¿ç¨‹å®‰å…¨æ˜¯ä¸æ˜¯éçœŸå³å‡? ä¸æ˜¯ çº¿ç¨‹å®‰å…¨æœ‰å“ªäº›å®ç°æ€è·¯? å¦‚ä½•ç†è§£å¹¶å‘å’Œå¹¶è¡Œçš„åŒºåˆ«? Java å¹¶å‘ - çº¿ç¨‹åŸºç¡€ çº¿ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€? åˆ†åˆ«è¯´æ˜ä»ä¸€ç§çŠ¶æ€åˆ°å¦ä¸€ç§çŠ¶æ€è½¬å˜æœ‰å“ªäº›æ–¹å¼? é€šå¸¸çº¿ç¨‹æœ‰å“ªå‡ ç§ä½¿ç”¨æ–¹å¼? åŸºç¡€çº¿ç¨‹æœºåˆ¶æœ‰å“ªäº›? çº¿ç¨‹çš„ä¸­æ–­æ–¹å¼æœ‰å“ªäº›? çº¿ç¨‹çš„äº’æ–¥åŒæ­¥æ–¹å¼æœ‰å“ªäº›? å¦‚ä½•æ¯”è¾ƒå’Œé€‰æ‹©? çº¿ç¨‹ä¹‹é—´æœ‰å“ªäº›åä½œæ–¹å¼? Javaå¹¶å‘ - Javaä¸­æ‰€æœ‰çš„é” Javaæä¾›äº†ç§ç±»ä¸°å¯Œçš„é”ï¼Œæ¯ç§é”å› å…¶ç‰¹æ€§çš„ä¸åŒï¼Œåœ¨é€‚å½“çš„åœºæ™¯ä¸‹èƒ½å¤Ÿå±•ç°å‡ºéå¸¸é«˜çš„æ•ˆç‡ã€‚æœ¬æ–‡æ—¨åœ¨å¯¹é”ç›¸å…³æºç ã€ä½¿ç”¨åœºæ™¯è¿›è¡Œä¸¾ä¾‹ï¼Œä¸ºè¯»è€…ä»‹ç»ä¸»æµé”çš„çŸ¥è¯†ç‚¹ï¼Œä»¥åŠä¸åŒçš„é”çš„é€‚ç”¨åœºæ™¯ã€‚ å…³é”®å­—: synchronizedè¯¦è§£ Synchronizedå¯ä»¥ä½œç”¨åœ¨å“ªé‡Œ? åˆ†åˆ«é€šè¿‡å¯¹è±¡é”å’Œç±»é”è¿›è¡Œä¸¾ä¾‹ã€‚ Synchronizedæœ¬è´¨ä¸Šæ˜¯é€šè¿‡ä»€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨çš„? åˆ†ä¸‰ä¸ªæ–¹é¢å›ç­”ï¼šåŠ é”å’Œé‡Šæ”¾é”çš„åŸç†ï¼Œå¯é‡å…¥åŸç†ï¼Œä¿è¯å¯è§æ€§åŸç†ã€‚ Synchronizedç”±ä»€ä¹ˆæ ·çš„ç¼ºé™·? Java Lockæ˜¯æ€ä¹ˆå¼¥è¡¥è¿™äº›ç¼ºé™·çš„ã€‚ Synchronizedå’ŒLockçš„å¯¹æ¯”ï¼Œå’Œé€‰æ‹©? Synchronizedåœ¨ä½¿ç”¨æ—¶æœ‰ä½•æ³¨æ„äº‹é¡¹? Synchronizedä¿®é¥°çš„æ–¹æ³•åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶,ä¼šé‡Šæ”¾é”å—? å¤šä¸ªçº¿ç¨‹ç­‰å¾…åŒä¸€ä¸ªSynchronizedé”çš„æ—¶å€™ï¼ŒJVMå¦‚ä½•é€‰æ‹©ä¸‹ä¸€ä¸ªè·å–é”çš„çº¿ç¨‹? Synchronizedä½¿å¾—åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œï¼Œæ€§èƒ½æ¯”è¾ƒå·®ï¼Œæœ‰ä»€ä¹ˆæå‡çš„æ–¹æ³•? æˆ‘æƒ³æ›´åŠ çµæ´»åœ°æ§åˆ¶é”çš„é‡Šæ”¾å’Œè·å–(ç°åœ¨é‡Šæ”¾é”å’Œè·å–é”çš„æ—¶æœºéƒ½è¢«è§„å®šæ­»äº†)ï¼Œæ€ä¹ˆåŠ? ä»€ä¹ˆæ˜¯é”çš„å‡çº§å’Œé™çº§? ä»€ä¹ˆæ˜¯JVMé‡Œçš„åæ–œé”ã€è½»é‡çº§é”ã€é‡é‡çº§é”? ä¸åŒçš„JDKä¸­å¯¹Synchronizedæœ‰ä½•ä¼˜åŒ–? å…³é”®å­—: volatileè¯¦è§£ volatileå…³é”®å­—çš„ä½œç”¨æ˜¯ä»€ä¹ˆ? volatileèƒ½ä¿è¯åŸå­æ€§å—? ä¹‹å‰32ä½æœºå™¨ä¸Šå…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile? ç°åœ¨64ä½æœºå™¨ä¸Šæ˜¯å¦ä¹Ÿè¦è®¾ç½®å‘¢? i++ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§? volatileæ˜¯å¦‚ä½•å®ç°å¯è§æ€§çš„? å†…å­˜å±éšœã€‚ volatileæ˜¯å¦‚ä½•å®ç°æœ‰åºæ€§çš„? happens-beforeç­‰ è¯´ä¸‹volatileçš„åº”ç”¨åœºæ™¯? å…³é”®å­—: finalè¯¦è§£ æ‰€æœ‰çš„finalä¿®é¥°çš„å­—æ®µéƒ½æ˜¯ç¼–è¯‘æœŸå¸¸é‡å—? å¦‚ä½•ç†è§£privateæ‰€ä¿®é¥°çš„æ–¹æ³•æ˜¯éšå¼çš„final? è¯´è¯´finalç±»å‹çš„ç±»å¦‚ä½•æ‹“å±•? æ¯”å¦‚Stringæ˜¯finalç±»å‹ï¼Œæˆ‘ä»¬æƒ³å†™ä¸ªMyStringå¤ç”¨æ‰€æœ‰Stringä¸­æ–¹æ³•ï¼ŒåŒæ—¶å¢åŠ ä¸€ä¸ªæ–°çš„toMyString()çš„æ–¹æ³•ï¼Œåº”è¯¥å¦‚ä½•åš? finalæ–¹æ³•å¯ä»¥è¢«é‡è½½å—? å¯ä»¥ çˆ¶ç±»çš„finalæ–¹æ³•èƒ½ä¸èƒ½å¤Ÿè¢«å­ç±»é‡å†™? ä¸å¯ä»¥ è¯´è¯´finalåŸŸé‡æ’åºè§„åˆ™? è¯´è¯´finalçš„åŸç†? ä½¿ç”¨ final çš„é™åˆ¶æ¡ä»¶å’Œå±€é™æ€§? çœ‹æœ¬æ–‡æœ€åçš„ä¸€ä¸ªæ€è€ƒé¢˜ B. Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹J.U.Cæ¡†æ¶ï¼šç„¶åéœ€è¦å¯¹J.U.Cæ¡†æ¶äº”å¤§ç±»è¯¦ç»†è§£è¯»ï¼ŒåŒ…æ‹¬ï¼šLockæ¡†æ¶ï¼Œå¹¶å‘é›†åˆ, åŸå­ç±», çº¿ç¨‹æ± å’Œå·¥å…·ç±»ã€‚@pdai JUC - ç±»æ±‡æ€»å’Œå­¦ä¹ æŒ‡å— JUCæ¡†æ¶åŒ…å«å‡ ä¸ªéƒ¨åˆ†? æ¯ä¸ªéƒ¨åˆ†æœ‰å“ªäº›æ ¸å¿ƒçš„ç±»? æœ€æœ€æ ¸å¿ƒçš„ç±»æœ‰å“ªäº›? B.1 Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹J.U.Cæ¡†æ¶ã€1&#x2F;5ã€‘ï¼šCASåŠåŸå­ç±»ï¼šä»æœ€æ ¸å¿ƒçš„CAS, Unsafeå’ŒåŸå­ç±»å¼€å§‹åˆ†æã€‚ JUCåŸå­ç±»: CAS, Unsafeå’ŒåŸå­ç±»è¯¦è§£ çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•æœ‰å“ªäº›? ä»€ä¹ˆæ˜¯CAS? CASä½¿ç”¨ç¤ºä¾‹ï¼Œç»“åˆAtomicIntegerç»™å‡ºç¤ºä¾‹? CASä¼šæœ‰å“ªäº›é—®é¢˜? é’ˆå¯¹è¿™è¿™äº›é—®é¢˜ï¼ŒJavaæä¾›äº†å“ªå‡ ä¸ªè§£å†³çš„? AtomicIntegeråº•å±‚å®ç°? CAS+volatile è¯·é˜è¿°ä½ å¯¹Unsafeç±»çš„ç†è§£? è¯´è¯´ä½ å¯¹JavaåŸå­ç±»çš„ç†è§£? åŒ…å«13ä¸ªï¼Œ4ç»„åˆ†ç±»ï¼Œè¯´è¯´ä½œç”¨å’Œä½¿ç”¨åœºæ™¯ã€‚ AtomicStampedReferenceæ˜¯ä»€ä¹ˆ? AtomicStampedReferenceæ˜¯æ€ä¹ˆè§£å†³ABAçš„? å†…éƒ¨ä½¿ç”¨Pairæ¥å­˜å‚¨å…ƒç´ å€¼åŠå…¶ç‰ˆæœ¬å· javaä¸­è¿˜æœ‰å“ªäº›ç±»å¯ä»¥è§£å†³ABAçš„é—®é¢˜? AtomicMarkableReference B.2 Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹J.U.Cæ¡†æ¶ã€2&#x2F;5ã€‘ï¼šé”ï¼šç„¶ååˆ†æJUCä¸­é”ã€‚ JUCé”: LockSupportè¯¦è§£ ä¸ºä»€ä¹ˆLockSupportä¹Ÿæ˜¯æ ¸å¿ƒåŸºç¡€ç±»? AQSæ¡†æ¶å€ŸåŠ©äºä¸¤ä¸ªç±»ï¼šUnsafe(æä¾›CASæ“ä½œ)å’ŒLockSupport(æä¾›park&#x2F;unparkæ“ä½œ) å†™å‡ºåˆ†åˆ«é€šè¿‡wait&#x2F;notifyå’ŒLockSupportçš„park&#x2F;unparkå®ç°åŒæ­¥? LockSupport.park()ä¼šé‡Šæ”¾é”èµ„æºå—? é‚£ä¹ˆCondition.await()å‘¢? Thread.sleep()ã€Object.wait()ã€Condition.await()ã€LockSupport.park()çš„åŒºåˆ«? é‡ç‚¹ å¦‚æœåœ¨wait()ä¹‹å‰æ‰§è¡Œäº†notify()ä¼šæ€æ ·? å¦‚æœåœ¨park()ä¹‹å‰æ‰§è¡Œäº†unpark()ä¼šæ€æ ·? JUCé”: é”æ ¸å¿ƒç±»AQSè¯¦è§£ ä»€ä¹ˆæ˜¯AQS? ä¸ºä»€ä¹ˆå®ƒæ˜¯æ ¸å¿ƒ? AQSçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä»€ä¹ˆ? å®ƒæ˜¯æ€ä¹ˆå®ç°çš„? åº•å±‚æ•°æ®ç»“æ„ç­‰ AQSæœ‰å“ªäº›æ ¸å¿ƒçš„æ–¹æ³•? AQSå®šä¹‰ä»€ä¹ˆæ ·çš„èµ„æºè·å–æ–¹å¼? AQSå®šä¹‰äº†ä¸¤ç§èµ„æºè·å–æ–¹å¼ï¼šç‹¬å (åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®æ‰§è¡Œï¼Œåˆæ ¹æ®æ˜¯å¦æŒ‰é˜Ÿåˆ—çš„é¡ºåºåˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œå¦‚ReentrantLock) å’Œå…±äº«(å¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è®¿é—®æ‰§è¡Œï¼Œå¦‚Semaphoreã€CountDownLatchã€ CyclicBarrier )ã€‚ReentrantReadWriteLockå¯ä»¥çœ‹æˆæ˜¯ç»„åˆå¼ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æŸä¸€èµ„æºè¿›è¡Œè¯»ã€‚ AQSåº•å±‚ä½¿ç”¨äº†ä»€ä¹ˆæ ·çš„è®¾è®¡æ¨¡å¼? æ¨¡æ¿ AQSçš„åº”ç”¨ç¤ºä¾‹? JUCé”: ReentrantLockè¯¦è§£ ä»€ä¹ˆæ˜¯å¯é‡å…¥ï¼Œä»€ä¹ˆæ˜¯å¯é‡å…¥é”? å®ƒç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜? ReentrantLockçš„æ ¸å¿ƒæ˜¯AQSï¼Œé‚£ä¹ˆå®ƒæ€ä¹ˆæ¥å®ç°çš„ï¼Œç»§æ‰¿å—? è¯´è¯´å…¶ç±»å†…éƒ¨ç»“æ„å…³ç³»ã€‚ ReentrantLockæ˜¯å¦‚ä½•å®ç°å…¬å¹³é”çš„? ReentrantLockæ˜¯å¦‚ä½•å®ç°éå…¬å¹³é”çš„? ReentrantLocké»˜è®¤å®ç°çš„æ˜¯å…¬å¹³è¿˜æ˜¯éå…¬å¹³é”? ä½¿ç”¨ReentrantLockå®ç°å…¬å¹³å’Œéå…¬å¹³é”çš„ç¤ºä¾‹? ReentrantLockå’ŒSynchronizedçš„å¯¹æ¯”? JUCé”: ReentrantReadWriteLockè¯¦è§£ ä¸ºäº†æœ‰äº†ReentrantLockè¿˜éœ€è¦ReentrantReadWriteLock? ReentrantReadWriteLockåº•å±‚å®ç°åŸç†? ReentrantReadWriteLockåº•å±‚è¯»å†™çŠ¶æ€å¦‚ä½•è®¾è®¡çš„? é«˜16ä½ä¸ºè¯»é”ï¼Œä½16ä½ä¸ºå†™é” è¯»é”å’Œå†™é”çš„æœ€å¤§æ•°é‡æ˜¯å¤šå°‘? æœ¬åœ°çº¿ç¨‹è®¡æ•°å™¨ThreadLocalHoldCounteræ˜¯ç”¨æ¥åšä»€ä¹ˆçš„? ç¼“å­˜è®¡æ•°å™¨HoldCounteræ˜¯ç”¨æ¥åšä»€ä¹ˆçš„? å†™é”çš„è·å–ä¸é‡Šæ”¾æ˜¯æ€ä¹ˆå®ç°çš„? è¯»é”çš„è·å–ä¸é‡Šæ”¾æ˜¯æ€ä¹ˆå®ç°çš„? RentrantReadWriteLockä¸ºä»€ä¹ˆä¸æ”¯æŒé”å‡çº§? ä»€ä¹ˆæ˜¯é”çš„å‡é™çº§? RentrantReadWriteLockä¸ºä»€ä¹ˆä¸æ”¯æŒé”å‡çº§? B.3 Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹J.U.Cæ¡†æ¶ã€3&#x2F;5ã€‘ï¼šé›†åˆï¼šå†ç†è§£JUCä¸­é‡è¦çš„æ”¯æŒå¹¶å‘çš„é›†åˆã€‚ JUCé›†åˆ: ConcurrentHashMapè¯¦è§£ ä¸ºä»€ä¹ˆHashTableæ…¢? å®ƒçš„å¹¶å‘åº¦æ˜¯ä»€ä¹ˆ? é‚£ä¹ˆConcurrentHashMapå¹¶å‘åº¦æ˜¯ä»€ä¹ˆ? ConcurrentHashMapåœ¨JDK1.7å’ŒJDK1.8ä¸­å®ç°æœ‰ä»€ä¹ˆå·®åˆ«? JDK1.8è§£æ±ºäº†JDK1.7ä¸­ä»€ä¹ˆé—®é¢˜ ConcurrentHashMap JDK1.7å®ç°çš„åŸç†æ˜¯ä»€ä¹ˆ? åˆ†æ®µé”æœºåˆ¶ ConcurrentHashMap JDK1.8å®ç°çš„åŸç†æ˜¯ä»€ä¹ˆ? æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ï¼ŒCAS ConcurrentHashMap JDK1.7ä¸­Segmentæ•°(concurrencyLevel)é»˜è®¤å€¼æ˜¯å¤šå°‘? ä¸ºä½•ä¸€æ—¦åˆå§‹åŒ–å°±ä¸å¯å†æ‰©å®¹? ConcurrentHashMap JDK1.7è¯´è¯´å…¶putçš„æœºåˆ¶? ConcurrentHashMap JDK1.7æ˜¯å¦‚ä½•æ‰©å®¹çš„? rehash(æ³¨ï¼šsegment æ•°ç»„ä¸èƒ½æ‰©å®¹ï¼Œæ‰©å®¹æ˜¯ segment æ•°ç»„æŸä¸ªä½ç½®å†…éƒ¨çš„æ•°ç»„ HashEntry&lt;K,V&gt;[] è¿›è¡Œæ‰©å®¹) ConcurrentHashMap JDK1.8æ˜¯å¦‚ä½•æ‰©å®¹çš„? tryPresize ConcurrentHashMap JDK1.8é“¾è¡¨è½¬çº¢é»‘æ ‘çš„æ—¶æœºæ˜¯ä»€ä¹ˆ? ä¸´ç•Œå€¼ä¸ºä»€ä¹ˆæ˜¯8? ConcurrentHashMap JDK1.8æ˜¯å¦‚ä½•è¿›è¡Œæ•°æ®è¿ç§»çš„? transfer JUCé›†åˆ: CopyOnWriteArrayListè¯¦è§£ è¯·å…ˆè¯´è¯´éå¹¶å‘é›†åˆä¸­Fail-fastæœºåˆ¶? å†ä¸ºä»€ä¹ˆè¯´ArrayListæŸ¥è¯¢å¿«è€Œå¢åˆ æ…¢? å¯¹æ¯”ArrayListè¯´è¯´CopyOnWriteArrayListçš„å¢åˆ æ”¹æŸ¥å®ç°åŸç†? COWåŸºäºæ‹·è´ å†è¯´ä¸‹å¼±ä¸€è‡´æ€§çš„è¿­ä»£å™¨åŸç†æ˜¯æ€ä¹ˆæ ·çš„? COWIterator&lt;E&gt; CopyOnWriteArrayListä¸ºä»€ä¹ˆå¹¶å‘å®‰å…¨ä¸”æ€§èƒ½æ¯”Vectorå¥½? CopyOnWriteArrayListæœ‰ä½•ç¼ºé™·ï¼Œè¯´è¯´å…¶åº”ç”¨åœºæ™¯? JUCé›†åˆ: ConcurrentLinkedQueueè¯¦è§£ è¦æƒ³ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—æœ‰å“ªäº›é€‰æ‹©? Vectorï¼ŒCollections.synchronizedList( List&lt;T&gt; list), ConcurrentLinkedQueueç­‰ ConcurrentLinkedQueueå®ç°çš„æ•°æ®ç»“æ„? ConcurrentLinkedQueueåº•å±‚åŸç†? å…¨ç¨‹æ— é”(CAS) ConcurrentLinkedQueueçš„æ ¸å¿ƒæ–¹æ³•æœ‰å“ªäº›? offer()ï¼Œpoll()ï¼Œpeek()ï¼ŒisEmpty()ç­‰é˜Ÿåˆ—å¸¸ç”¨æ–¹æ³• è¯´è¯´ConcurrentLinkedQueueçš„HOPS(å»¶è¿Ÿæ›´æ–°çš„ç­–ç•¥)çš„è®¾è®¡? ConcurrentLinkedQueueé€‚åˆä»€ä¹ˆæ ·çš„ä½¿ç”¨åœºæ™¯? JUCé›†åˆ: BlockingQueueè¯¦è§£ ä»€ä¹ˆæ˜¯BlockingDeque? BlockingQueueå¤§å®¶æ—æœ‰å“ªäº›? ArrayBlockingQueue, DelayQueue, LinkedBlockingQueue, SynchronousQueueâ€¦ BlockingQueueé€‚åˆç”¨åœ¨ä»€ä¹ˆæ ·çš„åœºæ™¯? BlockingQueueå¸¸ç”¨çš„æ–¹æ³•? BlockingQueueæ’å…¥æ–¹æ³•æœ‰å“ªäº›? è¿™äº›æ–¹æ³•(add(o),offer(o),put(o),offer(o, timeout, timeunit))çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ? BlockingDeque ä¸BlockingQueueæœ‰ä½•å…³ç³»ï¼Œè¯·å¯¹æ¯”ä¸‹å®ƒä»¬çš„æ–¹æ³•? BlockingDequeé€‚åˆç”¨åœ¨ä»€ä¹ˆæ ·çš„åœºæ™¯? BlockingDequeå¤§å®¶æ—æœ‰å“ªäº›? BlockingDeque ä¸BlockingQueueå®ç°ä¾‹å­? B.4 Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹J.U.Cæ¡†æ¶ã€4&#x2F;5ã€‘ï¼šçº¿ç¨‹æ± ï¼šå†è€…åˆ†æJUCä¸­éå¸¸å¸¸ç”¨çš„çº¿ç¨‹æ± ç­‰ã€‚ JUCçº¿ç¨‹æ± : FutureTaskè¯¦è§£ FutureTaskç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„? ä¸ºä»€ä¹ˆä¼šå‡ºç°? FutureTaskç±»ç»“æ„å…³ç³»æ€ä¹ˆæ ·çš„? FutureTaskçš„çº¿ç¨‹å®‰å…¨æ˜¯ç”±ä»€ä¹ˆä¿è¯çš„? FutureTaskç»“æœè¿”å›æœºåˆ¶? FutureTaskå†…éƒ¨è¿è¡ŒçŠ¶æ€çš„è½¬å˜? FutureTaské€šå¸¸ä¼šæ€ä¹ˆç”¨? ä¸¾ä¾‹è¯´æ˜ã€‚ JUCçº¿ç¨‹æ± : ThreadPoolExecutorè¯¦è§£ ä¸ºä»€ä¹ˆè¦æœ‰çº¿ç¨‹æ± ? Javaæ˜¯å®ç°å’Œç®¡ç†çº¿ç¨‹æ± æœ‰å“ªäº›æ–¹å¼? è¯·ç®€å•ä¸¾ä¾‹å¦‚ä½•ä½¿ç”¨ã€‚ ä¸ºä»€ä¹ˆå¾ˆå¤šå…¬å¸ä¸å…è®¸ä½¿ç”¨Executorså»åˆ›å»ºçº¿ç¨‹æ± ? é‚£ä¹ˆæ¨èæ€ä¹ˆä½¿ç”¨å‘¢? ThreadPoolExecutoræœ‰å“ªäº›æ ¸å¿ƒçš„é…ç½®å‚æ•°? è¯·ç®€è¦è¯´æ˜ ThreadPoolExecutorå¯ä»¥åˆ›å»ºå“ªæ˜¯å“ªä¸‰ç§çº¿ç¨‹æ± å‘¢? å½“é˜Ÿåˆ—æ»¡äº†å¹¶ä¸”workerçš„æ•°é‡è¾¾åˆ°maxSizeçš„æ—¶å€™ï¼Œä¼šæ€ä¹ˆæ ·? è¯´è¯´ThreadPoolExecutoræœ‰å“ªäº›RejectedExecutionHandlerç­–ç•¥? é»˜è®¤æ˜¯ä»€ä¹ˆç­–ç•¥? ç®€è¦è¯´ä¸‹çº¿ç¨‹æ± çš„ä»»åŠ¡æ‰§è¡Œæœºåˆ¶? execute â€“&gt; addWorker â€“&gt;runworker (getTask) çº¿ç¨‹æ± ä¸­ä»»åŠ¡æ˜¯å¦‚ä½•æäº¤çš„? çº¿ç¨‹æ± ä¸­ä»»åŠ¡æ˜¯å¦‚ä½•å…³é—­çš„? åœ¨é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™éœ€è¦è€ƒè™‘å“ªäº›é…ç½®å› ç´ ? å¦‚ä½•ç›‘æ§çº¿ç¨‹æ± çš„çŠ¶æ€? JUCçº¿ç¨‹æ± : ScheduledThreadPoolè¯¦è§£ ScheduledThreadPoolExecutorè¦è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜? ScheduledThreadPoolExecutorç›¸æ¯”ThreadPoolExecutoræœ‰å“ªäº›ç‰¹æ€§? ScheduledThreadPoolExecutoræœ‰ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„ï¼Œæ ¸å¿ƒå†…éƒ¨ç±»å’ŒæŠ½è±¡ç±»? ScheduledThreadPoolExecutoræœ‰å“ªä¸¤ä¸ªå…³é—­ç­–ç•¥? åŒºåˆ«æ˜¯ä»€ä¹ˆ? ScheduledThreadPoolExecutorä¸­scheduleAtFixedRate å’Œ scheduleWithFixedDelayåŒºåˆ«æ˜¯ä»€ä¹ˆ? ä¸ºä»€ä¹ˆThreadPoolExecutor çš„è°ƒæ•´ç­–ç•¥å´ä¸é€‚ç”¨äº ScheduledThreadPoolExecutor? Executors æä¾›äº†å‡ ç§æ–¹æ³•æ¥æ„é€  ScheduledThreadPoolExecutor? JUCçº¿ç¨‹æ± : Fork&#x2F;Joinæ¡†æ¶è¯¦è§£ Fork&#x2F;Joinä¸»è¦ç”¨æ¥è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜? Fork&#x2F;Joinæ¡†æ¶æ˜¯åœ¨å“ªä¸ªJDKç‰ˆæœ¬ä¸­å¼•å…¥çš„? Fork&#x2F;Joinæ¡†æ¶ä¸»è¦åŒ…å«å“ªä¸‰ä¸ªæ¨¡å—? æ¨¡å—ä¹‹é—´çš„å…³ç³»æ˜¯æ€ä¹ˆæ ·çš„? ForkJoinPoolç±»ç»§æ‰¿å…³ç³»? ForkJoinTaskæŠ½è±¡ç±»ç»§æ‰¿å…³ç³»? åœ¨å®é™…è¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šç»§æ‰¿ RecursiveTask ã€RecursiveAction æˆ– CountedCompleter æ¥å®ç°æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè€Œä¸ä¼šç›´æ¥ç»§æ‰¿ ForkJoinTask ç±»ã€‚ æ•´ä¸ªFork&#x2F;Join æ¡†æ¶çš„æ‰§è¡Œæµç¨‹&#x2F;è¿è¡Œæœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„? å…·ä½“é˜è¿°Fork&#x2F;Joinçš„åˆ†æ²»æ€æƒ³å’Œwork-stealing å®ç°æ–¹å¼? æœ‰å“ªäº›JDKæºç ä¸­ä½¿ç”¨äº†Fork&#x2F;Joinæ€æƒ³? å¦‚ä½•ä½¿ç”¨Executorså·¥å…·ç±»åˆ›å»ºForkJoinPool? å†™ä¸€ä¸ªä¾‹å­: ç”¨ForkJoinæ–¹å¼å®ç°1+2+3+â€¦+100000? Fork&#x2F;Joinåœ¨ä½¿ç”¨æ—¶æœ‰å“ªäº›æ³¨æ„äº‹é¡¹? ç»“åˆJDKä¸­çš„æ–æ³¢é‚£å¥‘æ•°åˆ—å®ä¾‹å…·ä½“è¯´æ˜ã€‚ B.5 Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹J.U.Cæ¡†æ¶ã€5&#x2F;5ã€‘ï¼šå·¥å…·ç±»ï¼šæœ€åæ¥çœ‹ä¸‹JUCä¸­æœ‰å“ªäº›å·¥å…·ç±»ï¼Œä»¥åŠçº¿ç¨‹éš”ç¦»æœ¯ThreadLocalã€‚ JUCå·¥å…·ç±»: CountDownLatchè¯¦è§£ ä»€ä¹ˆæ˜¯CountDownLatch? CountDownLatchåº•å±‚å®ç°åŸç†? CountDownLatchä¸€æ¬¡å¯ä»¥å”¤é†’å‡ ä¸ªä»»åŠ¡? å¤šä¸ª CountDownLatchæœ‰å“ªäº›ä¸»è¦æ–¹æ³•? await(),countDown() CountDownLatché€‚ç”¨äºä»€ä¹ˆåœºæ™¯? å†™é“é¢˜ï¼šå®ç°ä¸€ä¸ªå®¹å™¨ï¼Œæä¾›ä¸¤ä¸ªæ–¹æ³•ï¼Œaddï¼Œsize å†™ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹1æ·»åŠ 10ä¸ªå…ƒç´ åˆ°å®¹å™¨ä¸­ï¼Œçº¿ç¨‹2å®ç°ç›‘æ§å…ƒç´ çš„ä¸ªæ•°ï¼Œå½“ä¸ªæ•°åˆ°5ä¸ªæ—¶ï¼Œçº¿ç¨‹2ç»™å‡ºæç¤ºå¹¶ç»“æŸ? ä½¿ç”¨CountDownLatch ä»£æ›¿wait notify å¥½å¤„ã€‚ JUCå·¥å…·ç±»: CyclicBarrierè¯¦è§£ ä»€ä¹ˆæ˜¯CyclicBarrier? CyclicBarrieråº•å±‚å®ç°åŸç†? CountDownLatchå’ŒCyclicBarrierå¯¹æ¯”? CyclicBarrierçš„æ ¸å¿ƒå‡½æ•°æœ‰å“ªäº›? CyclicBarrieré€‚ç”¨äºä»€ä¹ˆåœºæ™¯? JUCå·¥å…·ç±»: Semaphoreè¯¦è§£ ä»€ä¹ˆæ˜¯Semaphore? Semaphoreå†…éƒ¨åŸç†? Semaphoreå¸¸ç”¨æ–¹æ³•æœ‰å“ªäº›? å¦‚ä½•å®ç°çº¿ç¨‹åŒæ­¥å’Œäº’æ–¥çš„? Semaphoreé€‚åˆç”¨åœ¨ä»€ä¹ˆåœºæ™¯? å•ç‹¬ä½¿ç”¨Semaphoreæ˜¯ä¸ä¼šä½¿ç”¨åˆ°AQSçš„æ¡ä»¶é˜Ÿåˆ—? Semaphoreä¸­ç”³è¯·ä»¤ç‰Œ(acquire)ã€é‡Šæ”¾ä»¤ç‰Œ(release)çš„å®ç°? Semaphoreåˆå§‹åŒ–æœ‰10ä¸ªä»¤ç‰Œï¼Œ11ä¸ªçº¿ç¨‹åŒæ—¶å„è°ƒç”¨1æ¬¡acquireæ–¹æ³•ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ? Semaphoreåˆå§‹åŒ–æœ‰10ä¸ªä»¤ç‰Œï¼Œä¸€ä¸ªçº¿ç¨‹é‡å¤è°ƒç”¨11æ¬¡acquireæ–¹æ³•ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ? Semaphoreåˆå§‹åŒ–æœ‰1ä¸ªä»¤ç‰Œï¼Œ1ä¸ªçº¿ç¨‹è°ƒç”¨ä¸€æ¬¡acquireæ–¹æ³•ï¼Œç„¶åè°ƒç”¨ä¸¤æ¬¡releaseæ–¹æ³•ï¼Œä¹‹åå¦å¤–ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨acquire(2)æ–¹æ³•ï¼Œæ­¤çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¶³å¤Ÿçš„ä»¤ç‰Œå¹¶ç»§ç»­è¿è¡Œå—? Semaphoreåˆå§‹åŒ–æœ‰2ä¸ªä»¤ç‰Œï¼Œä¸€ä¸ªçº¿ç¨‹è°ƒç”¨1æ¬¡releaseæ–¹æ³•ï¼Œç„¶åä¸€æ¬¡æ€§è·å–3ä¸ªä»¤ç‰Œï¼Œä¼šè·å–åˆ°å—? JUCå·¥å…·ç±»: Phaserè¯¦è§£ Phaserä¸»è¦ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜? Phaserä¸CyclicBarrierå’ŒCountDownLatchçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ? å¦‚æœç”¨CountDownLatchæ¥å®ç°Phaserçš„åŠŸèƒ½åº”è¯¥æ€ä¹ˆå®ç°? Phaserè¿è¡Œæœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„? ç»™ä¸€ä¸ªPhaserä½¿ç”¨çš„ç¤ºä¾‹? JUCå·¥å…·ç±»: Exchangerè¯¦è§£ Exchangerä¸»è¦è§£å†³ä»€ä¹ˆé—®é¢˜? å¯¹æ¯”SynchronousQueueï¼Œä¸ºä»€ä¹ˆè¯´Exchangerå¯è¢«è§†ä¸º SynchronousQueue çš„åŒå‘å½¢å¼? Exchangeråœ¨ä¸åŒçš„JDKç‰ˆæœ¬ä¸­å®ç°æœ‰ä»€ä¹ˆå·®åˆ«? Exchangerå®ç°æœºåˆ¶? Exchangerå·²ç»æœ‰äº†slotå•èŠ‚ç‚¹ï¼Œä¸ºä»€ä¹ˆä¼šåŠ å…¥arena nodeæ•°ç»„? ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°æ•°ç»„? arenaå¯ä»¥ç¡®ä¿ä¸åŒçš„slotåœ¨arenaä¸­æ˜¯ä¸ä¼šç›¸å†²çªçš„ï¼Œé‚£ä¹ˆæ˜¯æ€ä¹ˆä¿è¯çš„å‘¢? ä»€ä¹ˆæ˜¯ä¼ªå…±äº«ï¼ŒExchangerä¸­å¦‚ä½•ä½“ç°çš„? Exchangerå®ç°ä¸¾ä¾‹ Java å¹¶å‘ - ThreadLocalè¯¦è§£ ä»€ä¹ˆæ˜¯ThreadLocal? ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„? è¯´è¯´ä½ å¯¹ThreadLocalçš„ç†è§£ ThreadLocalæ˜¯å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»çš„? ä¸ºä»€ä¹ˆThreadLocalä¼šé€ æˆå†…å­˜æ³„éœ²? å¦‚ä½•è§£å†³ è¿˜æœ‰å“ªäº›ä½¿ç”¨ThreadLocalçš„åº”ç”¨åœºæ™¯? C. Javaè¿›é˜¶ - Java å¹¶å‘ä¹‹ æœ¬è´¨ä¸æ¨¡å¼ï¼šæœ€åç«™åœ¨æ›´é«˜çš„è§’åº¦çœ‹å…¶æœ¬è´¨(åä½œï¼Œåˆ†å·¥å’Œäº’æ–¥)ï¼ŒåŒæ—¶æ€»ç»“ä¸Šè¿°çŸ¥è¯†ç‚¹æ‰€ä½¿ç”¨çš„æ¨¡å¼ã€‚@pdai TODOï¼šJava å¹¶å‘ - å¹¶å‘çš„æœ¬è´¨ï¼šåä½œ,åˆ†å·¥å’Œäº’æ–¥ TODOï¼šJava å¹¶å‘ - å¹¶å‘çš„æ¨¡å¼æ¢³ç† å‚è€ƒæ–‡æ¡£å®˜æ–¹æ–‡æ¡£ https://docs.oracle.com/javase/specs/jls/se7/html/jls-17.html å¹¶å‘å®˜æ–¹æ•™ç¨‹ https://docs.oracle.com/javase/tutorial/essential/concurrency/atomic.html Doug Leaå¹¶å‘ç¼–ç¨‹æ–‡ç« å…¨éƒ¨è¯‘æ–‡ http://ifeve.com/doug-lea/ Javaå¹¶å‘çŸ¥è¯†ç‚¹æ€»ç»“ https://github.com/CL0610/Java-concurrency çº¿ç¨‹ä¸å¤šçº¿ç¨‹å¿…çŸ¥å¿…ä¼š(åŸºç¡€ç¯‡) https://zhuanlan.zhihu.com/p/33616143","tags":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"],"categories":["Java","å¤šçº¿ç¨‹ä¸å¹¶å‘"]},{"title":"9.Map - WeakHashMapæºç è§£æ","path":"/2023/12/25/9-Map-WeakHashMapæºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Map - WeakHashMapæºç è§£æ æºç è§£æã€‚ Java 7- WeakHashMapæ€»ä½“ä»‹ç»åœ¨Javaé›†åˆæ¡†æ¶ç³»åˆ—æ–‡ç« çš„æœ€åï¼Œç¬”è€…æ‰“ç®—ä»‹ç»ä¸€ä¸ªç‰¹æ®Šçš„æˆå‘˜: WeakHashMapï¼Œä»åå­—å¯ä»¥çœ‹å‡ºå®ƒæ˜¯æŸç§ Mapã€‚å®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äº WeakHashMap é‡Œçš„entryå¯èƒ½ä¼šè¢«GCè‡ªåŠ¨åˆ é™¤ï¼Œå³ä½¿ç¨‹åºå‘˜æ²¡æœ‰è°ƒç”¨remove()æˆ–è€…clear()æ–¹æ³•ã€‚ æ›´ç›´è§‚çš„è¯´ï¼Œå½“ä½¿ç”¨ WeakHashMap æ—¶ï¼Œå³ä½¿æ²¡æœ‰æ˜¾ç¤ºçš„æ·»åŠ æˆ–åˆ é™¤ä»»ä½•å…ƒç´ ï¼Œä¹Ÿå¯èƒ½å‘ç”Ÿå¦‚ä¸‹æƒ…å†µ: è°ƒç”¨ä¸¤æ¬¡size()æ–¹æ³•è¿”å›ä¸åŒçš„å€¼ï¼› ä¸¤æ¬¡è°ƒç”¨isEmpty()æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡è¿”å›falseï¼Œç¬¬äºŒæ¬¡è¿”å›trueï¼› ä¸¤æ¬¡è°ƒç”¨containsKey()æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡è¿”å›trueï¼Œç¬¬äºŒæ¬¡è¿”å›falseï¼Œå°½ç®¡ä¸¤æ¬¡ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªkeyï¼› ä¸¤æ¬¡è°ƒç”¨get()æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡è¿”å›ä¸€ä¸ªvalueï¼Œç¬¬äºŒæ¬¡è¿”å›nullï¼Œå°½ç®¡ä¸¤æ¬¡ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚ é‡åˆ°è¿™ä¹ˆå¥‡è‘©çš„ç°è±¡ï¼Œä½ æ˜¯ä¸æ˜¯è§‰å¾—ä½¿ç”¨è€…ä¸€å®šä¼šç–¯æ‰? å…¶å®ä¸ç„¶ï¼Œ*WeakHashMap* çš„è¿™ä¸ªç‰¹ç‚¹ç‰¹åˆ«é€‚ç”¨äºéœ€è¦ç¼“å­˜çš„åœºæ™¯ã€‚åœ¨ç¼“å­˜åœºæ™¯ä¸‹ï¼Œç”±äºå†…å­˜æ˜¯æœ‰é™çš„ï¼Œä¸èƒ½ç¼“å­˜æ‰€æœ‰å¯¹è±¡ï¼›å¯¹è±¡ç¼“å­˜å‘½ä¸­å¯ä»¥æé«˜ç³»ç»Ÿæ•ˆç‡ï¼Œä½†ç¼“å­˜MISSä¹Ÿä¸ä¼šé€ æˆé”™è¯¯ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡è®¡ç®—é‡æ–°å¾—åˆ°ã€‚ è¦æ˜ç™½ WeakHashMap çš„å·¥ä½œåŸç†ï¼Œè¿˜éœ€è¦å¼•å…¥ä¸€ä¸ªæ¦‚å¿µ : å¼±å¼•ç”¨(WeakReference)ã€‚æˆ‘ä»¬éƒ½çŸ¥é“Javaä¸­å†…å­˜æ˜¯é€šè¿‡GCè‡ªåŠ¨ç®¡ç†çš„ï¼ŒGCä¼šåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨åˆ¤æ–­å“ªäº›å¯¹è±¡æ˜¯å¯ä»¥è¢«å›æ”¶çš„ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚GCåˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶çš„ä¾æ®æ˜¯ï¼Œæ˜¯å¦æœ‰æœ‰æ•ˆçš„å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰æœ‰æ•ˆå¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡(åŸºæœ¬æ„å‘³ç€ä¸å­˜åœ¨è®¿é—®è¯¥å¯¹è±¡çš„æ–¹å¼)ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±æ˜¯å¯å›æ”¶çš„ã€‚è¿™é‡Œçš„æœ‰æ•ˆå¼•ç”¨ å¹¶ä¸åŒ…æ‹¬å¼±å¼•ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶å¼±å¼•ç”¨å¯ä»¥ç”¨æ¥è®¿é—®å¯¹è±¡ï¼Œä½†è¿›è¡Œåƒåœ¾å›æ”¶æ—¶å¼±å¼•ç”¨å¹¶ä¸ä¼šè¢«è€ƒè™‘åœ¨å†…ï¼Œä»…æœ‰å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ä»ç„¶ä¼šè¢«GCå›æ”¶ã€‚ WeakHashMap å†…éƒ¨æ˜¯é€šè¿‡å¼±å¼•ç”¨æ¥ç®¡ç†entryçš„ï¼Œå¼±å¼•ç”¨çš„ç‰¹æ€§å¯¹åº”åˆ° WeakHashMap ä¸Šæ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿå°†ä¸€å¯¹key, valueæ”¾å…¥åˆ° *WeakHashMap* é‡Œå¹¶ä¸èƒ½é¿å…è¯¥keyå€¼è¢«GCå›æ”¶ï¼Œé™¤éåœ¨ *WeakHashMap* ä¹‹å¤–è¿˜æœ‰å¯¹è¯¥keyçš„å¼ºå¼•ç”¨ã€‚ å…³äºå¼ºå¼•ç”¨ï¼Œå¼±å¼•ç”¨ç­‰æ¦‚å¿µä»¥åå†å…·ä½“è®²è§£ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“Javaä¸­å¼•ç”¨ä¹Ÿæ˜¯åˆ†ç§ç±»çš„ï¼Œå¹¶ä¸”ä¸åŒç§ç±»çš„å¼•ç”¨å¯¹GCçš„å½±å“ä¸åŒå°±å¤Ÿäº†ã€‚ å…·ä½“å®ç°WeakHashMapçš„å­˜å‚¨ç»“æ„ç±»ä¼¼äºMap - HashSet &amp; HashMap æºç è§£æï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ å…³äºå¼ºå¼±å¼•ç”¨çš„ç®¡ç†æ–¹å¼ï¼Œåšä¸»å°†ä¼šå¦å¼€ä¸“é¢˜å•ç‹¬è®²è§£ã€‚ Weak HashSet?å¦‚æœä½ çœ‹è¿‡å‰å‡ ç¯‡å…³äº Map å’Œ Set çš„è®²è§£ï¼Œä¸€å®šä¼šé—®: æ—¢ç„¶æœ‰ WeakHashMapï¼Œæ˜¯å¦æœ‰ WeekHashSet å‘¢? ç­”æ¡ˆæ˜¯æ²¡æœ‰:( ã€‚ä¸è¿‡Java Collectionså·¥å…·ç±»ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼ŒCollections.newSetFromMap(Map&lt;E,Boolean&gt; map)æ–¹æ³•å¯ä»¥å°†ä»»ä½• MapåŒ…è£…æˆä¸€ä¸ªSetã€‚é€šè¿‡å¦‚ä¸‹æ–¹å¼å¯ä»¥å¿«é€Ÿå¾—åˆ°ä¸€ä¸ª Weak HashSet: 123// å°†WeakHashMapåŒ…è£…æˆä¸€ä¸ªSetSet&lt;Object&gt; weakHashSet = Collections.newSetFromMap( new WeakHashMap&lt;Object, Boolean&gt;()); ä¸å‡ºä½ æ‰€æ–™ï¼ŒnewSetFromMap()æ–¹æ³•åªæ˜¯å¯¹ä¼ å…¥çš„ Mapåšäº†ç®€å•åŒ…è£…: 12345678910111213141516171819202122232425262728293031323334// Collections.newSetFromMap()ç”¨äºå°†ä»»ä½•MapåŒ…è£…æˆä¸€ä¸ªSetpublic static &lt;E&gt; Set&lt;E&gt; newSetFromMap(Map&lt;E, Boolean&gt; map) &#123; return new SetFromMap&lt;&gt;(map);&#125;private static class SetFromMap&lt;E&gt; extends AbstractSet&lt;E&gt; implements Set&lt;E&gt;, Serializable&#123; private final Map&lt;E, Boolean&gt; m; // The backing map private transient Set&lt;E&gt; s; // Its keySet SetFromMap(Map&lt;E, Boolean&gt; map) &#123; if (!map.isEmpty()) throw new IllegalArgumentException(&quot;Map is non-empty&quot;); m = map; s = map.keySet(); &#125; public void clear() &#123; m.clear(); &#125; public int size() &#123; return m.size(); &#125; public boolean isEmpty() &#123; return m.isEmpty(); &#125; public boolean contains(Object o) &#123; return m.containsKey(o); &#125; public boolean remove(Object o) &#123; return m.remove(o) != null; &#125; public boolean add(E e) &#123; return m.put(e, Boolean.TRUE) == null; &#125; public Iterator&lt;E&gt; iterator() &#123; return s.iterator(); &#125; public Object[] toArray() &#123; return s.toArray(); &#125; public &lt;T&gt; T[] toArray(T[] a) &#123; return s.toArray(a); &#125; public String toString() &#123; return s.toString(); &#125; public int hashCode() &#123; return s.hashCode(); &#125; public boolean equals(Object o) &#123; return o == this || s.equals(o); &#125; public boolean containsAll(Collection&lt;?&gt; c) &#123;return s.containsAll(c);&#125; public boolean removeAll(Collection&lt;?&gt; c) &#123;return s.removeAll(c);&#125; public boolean retainAll(Collection&lt;?&gt; c) &#123;return s.retainAll(c);&#125; // addAll is the only inherited implementation ......&#125; å‚è€ƒæ–‡ç«  æµ…è°ˆWeakHashMap https://www.cnblogs.com/CarpenterLee/p/5544598.html","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"8.Map - TreeSet & TreeMap æºç è§£æ","path":"/2023/12/25/8-Map-TreeSet-TreeMap-æºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Map - TreeSet &amp; TreeMap æºç è§£æã€‚ Java 7 - TreeSet &amp; TreeMapæ€»ä½“ä»‹ç»ä¹‹æ‰€ä»¥æŠŠTreeSetå’ŒTreeMapæ”¾åœ¨ä¸€èµ·è®²è§£ï¼Œæ˜¯å› ä¸ºäºŒè€…åœ¨Javaé‡Œæœ‰ç€ç›¸åŒçš„å®ç°ï¼Œå‰è€…ä»…ä»…æ˜¯å¯¹åè€…åšäº†ä¸€å±‚åŒ…è£…ï¼Œä¹Ÿå°±æ˜¯è¯´**TreeSet*é‡Œé¢æœ‰ä¸€ä¸ª*TreeMap(é€‚é…å™¨æ¨¡å¼)*ã€‚å› æ­¤æœ¬æ–‡å°†é‡ç‚¹åˆ†æTreeMap*ã€‚ Java TreeMapå®ç°äº†SortedMapæ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šæŒ‰ç…§keyçš„å¤§å°é¡ºåºå¯¹Mapä¸­çš„å…ƒç´ è¿›è¡Œæ’åºï¼Œkeyå¤§å°çš„è¯„åˆ¤å¯ä»¥é€šè¿‡å…¶æœ¬èº«çš„è‡ªç„¶é¡ºåº(natural ordering)ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ—¶ä¼ å…¥çš„æ¯”è¾ƒå™¨(Comparator)ã€‚ *TreeMap*åº•å±‚é€šè¿‡çº¢é»‘æ ‘(Red-Black tree)å®ç°ï¼Œä¹Ÿå°±æ„å‘³ç€containsKey(), get(), put(), remove()éƒ½æœ‰ç€log(n)çš„æ—¶é—´å¤æ‚åº¦ã€‚å…¶å…·ä½“ç®—æ³•å®ç°å‚ç…§äº†ã€Šç®—æ³•å¯¼è®ºã€‹ã€‚ å‡ºäºæ€§èƒ½åŸå› ï¼ŒTreeMapæ˜¯éåŒæ­¥çš„(not synchronized)ï¼Œå¦‚æœéœ€è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨ï¼Œéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨åŒæ­¥ï¼›æˆ–è€…é€šè¿‡å¦‚ä¸‹æ–¹å¼å°†TreeMapåŒ…è£…æˆ(wrapped)åŒæ­¥çš„: 1SortedMap m = Collections.synchronizedSortedMap(new TreeMap(...)); çº¢é»‘æ ‘æ˜¯ä¸€ç§è¿‘ä¼¼å¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå®ƒèƒ½å¤Ÿç¡®ä¿ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å³å­æ ‘çš„é«˜åº¦å·®ä¸ä¼šè¶…è¿‡äºŒè€…ä¸­è¾ƒä½é‚£ä¸ªçš„ä¸€å€ã€‚å…·ä½“æ¥è¯´ï¼Œçº¢é»‘æ ‘æ˜¯æ»¡è¶³å¦‚ä¸‹æ¡ä»¶çš„äºŒå‰æŸ¥æ‰¾æ ‘(binary search tree): æ¯ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯çº¢è‰²ï¼Œè¦ä¹ˆæ˜¯é»‘è‰²ã€‚ æ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰² çº¢è‰²èŠ‚ç‚¹ä¸èƒ½è¿ç»­(ä¹Ÿå³æ˜¯ï¼Œçº¢è‰²èŠ‚ç‚¹çš„å­©å­å’Œçˆ¶äº²éƒ½ä¸èƒ½æ˜¯çº¢è‰²)ã€‚ å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œä»è¯¥ç‚¹è‡³null(æ ‘å°¾ç«¯)çš„ä»»ä½•è·¯å¾„ï¼Œéƒ½å«æœ‰ç›¸åŒä¸ªæ•°çš„é»‘è‰²èŠ‚ç‚¹ã€‚ åœ¨æ ‘çš„ç»“æ„å‘ç”Ÿæ”¹å˜æ—¶(æ’å…¥æˆ–è€…åˆ é™¤æ“ä½œ)ï¼Œå¾€å¾€ä¼šç ´åä¸Šè¿°æ¡ä»¶3æˆ–æ¡ä»¶4ï¼Œéœ€è¦é€šè¿‡è°ƒæ•´ä½¿å¾—æŸ¥æ‰¾æ ‘é‡æ–°æ»¡è¶³çº¢é»‘æ ‘çš„çº¦æŸæ¡ä»¶ã€‚ é¢„å¤‡çŸ¥è¯†å‰æ–‡è¯´åˆ°å½“æŸ¥æ‰¾æ ‘çš„ç»“æ„å‘ç”Ÿæ”¹å˜æ—¶ï¼Œçº¢é»‘æ ‘çš„çº¦æŸæ¡ä»¶å¯èƒ½è¢«ç ´åï¼Œéœ€è¦é€šè¿‡è°ƒæ•´ä½¿å¾—æŸ¥æ‰¾æ ‘é‡æ–°æ»¡è¶³çº¢é»‘æ ‘çš„çº¦æŸæ¡ä»¶ã€‚è°ƒæ•´å¯ä»¥åˆ†ä¸ºä¸¤ç±»: ä¸€ç±»æ˜¯é¢œè‰²è°ƒæ•´ï¼Œå³æ”¹å˜æŸä¸ªèŠ‚ç‚¹çš„é¢œè‰²ï¼›å¦ä¸€ç±»æ˜¯ç»“æ„è°ƒæ•´ï¼Œå³æ”¹å˜æ£€ç´¢æ ‘çš„ç»“æ„å…³ç³»ã€‚ç»“æ„è°ƒæ•´è¿‡ç¨‹åŒ…å«ä¸¤ä¸ªåŸºæœ¬æ“ä½œ** : å·¦æ—‹(Rotate Left)ï¼Œå³æ—‹(RotateRight)**ã€‚ å·¦æ—‹å·¦æ—‹çš„è¿‡ç¨‹æ˜¯å°†xçš„å³å­æ ‘ç»•xé€†æ—¶é’ˆæ—‹è½¬ï¼Œä½¿å¾—xçš„å³å­æ ‘æˆä¸ºxçš„çˆ¶äº²ï¼ŒåŒæ—¶ä¿®æ”¹ç›¸å…³èŠ‚ç‚¹çš„å¼•ç”¨ã€‚æ—‹è½¬ä¹‹åï¼ŒäºŒå‰æŸ¥æ‰¾æ ‘çš„å±æ€§ä»ç„¶æ»¡è¶³ã€‚ TreeMapä¸­å·¦æ—‹ä»£ç å¦‚ä¸‹: 123456789101112131415161718//Rotate Leftprivate void rotateLeft(Entry&lt;K,V&gt; p) &#123; if (p != null) &#123; Entry&lt;K,V&gt; r = p.right; p.right = r.left; if (r.left != null) r.left.parent = p; r.parent = p.parent; if (p.parent == null) root = r; else if (p.parent.left == p) p.parent.left = r; else p.parent.right = r; r.left = p; p.parent = r; &#125;&#125; å³æ—‹å³æ—‹çš„è¿‡ç¨‹æ˜¯å°†xçš„å·¦å­æ ‘ç»•xé¡ºæ—¶é’ˆæ—‹è½¬ï¼Œä½¿å¾—xçš„å·¦å­æ ‘æˆä¸ºxçš„çˆ¶äº²ï¼ŒåŒæ—¶ä¿®æ”¹ç›¸å…³èŠ‚ç‚¹çš„å¼•ç”¨ã€‚æ—‹è½¬ä¹‹åï¼ŒäºŒå‰æŸ¥æ‰¾æ ‘çš„å±æ€§ä»ç„¶æ»¡è¶³ã€‚ TreeMapä¸­å³æ—‹ä»£ç å¦‚ä¸‹: 12345678910111213141516//Rotate Rightprivate void rotateRight(Entry&lt;K,V&gt; p) &#123; if (p != null) &#123; Entry&lt;K,V&gt; l = p.left; p.left = l.right; if (l.right != null) l.right.parent = p; l.parent = p.parent; if (p.parent == null) root = l; else if (p.parent.right == p) p.parent.right = l; else p.parent.left = l; l.right = p; p.parent = l; &#125;&#125; å¯»æ‰¾èŠ‚ç‚¹åç»§å¯¹äºä¸€æ£µäºŒå‰æŸ¥æ‰¾æ ‘ï¼Œç»™å®šèŠ‚ç‚¹tï¼Œå…¶åç»§(æ ‘ä¸­æ¯”å¤§äºtçš„æœ€å°çš„é‚£ä¸ªå…ƒç´ )å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æ‰¾åˆ°: tçš„å³å­æ ‘ä¸ç©ºï¼Œåˆ™tçš„åç»§æ˜¯å…¶å³å­æ ‘ä¸­æœ€å°çš„é‚£ä¸ªå…ƒç´ ã€‚ tçš„å³å­©å­ä¸ºç©ºï¼Œåˆ™tçš„åç»§æ˜¯å…¶ç¬¬ä¸€ä¸ªå‘å·¦èµ°çš„ç¥–å…ˆã€‚ åç»§èŠ‚ç‚¹åœ¨çº¢é»‘æ ‘çš„åˆ é™¤æ“ä½œä¸­å°†ä¼šç”¨åˆ°ã€‚ TreeMapä¸­å¯»æ‰¾èŠ‚ç‚¹åç»§çš„ä»£ç å¦‚ä¸‹: 12345678910111213141516171819// å¯»æ‰¾èŠ‚ç‚¹åç»§å‡½æ•°successor()static &lt;K,V&gt; TreeMap.Entry&lt;K,V&gt; successor(Entry&lt;K,V&gt; t) &#123; if (t == null) return null; else if (t.right != null) &#123;// 1. tçš„å³å­æ ‘ä¸ç©ºï¼Œåˆ™tçš„åç»§æ˜¯å…¶å³å­æ ‘ä¸­æœ€å°çš„é‚£ä¸ªå…ƒç´  Entry&lt;K,V&gt; p = t.right; while (p.left != null) p = p.left; return p; &#125; else &#123;// 2. tçš„å³å­©å­ä¸ºç©ºï¼Œåˆ™tçš„åç»§æ˜¯å…¶ç¬¬ä¸€ä¸ªå‘å·¦èµ°çš„ç¥–å…ˆ Entry&lt;K,V&gt; p = t.parent; Entry&lt;K,V&gt; ch = t; while (p != null &amp;&amp; ch == p.right) &#123; ch = p; p = p.parent; &#125; return p; &#125;&#125; æ–¹æ³•å‰–æget()get(Object key)æ–¹æ³•æ ¹æ®æŒ‡å®šçš„keyå€¼è¿”å›å¯¹åº”çš„valueï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†getEntry(Object key)å¾—åˆ°ç›¸åº”çš„entryï¼Œç„¶åè¿”å›entry.valueã€‚å› æ­¤getEntry()æ˜¯ç®—æ³•çš„æ ¸å¿ƒã€‚ç®—æ³•æ€æƒ³æ˜¯æ ¹æ®keyçš„è‡ªç„¶é¡ºåº(æˆ–è€…æ¯”è¾ƒå™¨é¡ºåº)å¯¹äºŒå‰æŸ¥æ‰¾æ ‘è¿›è¡ŒæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æ»¡è¶³k.compareTo(p.key) == 0çš„entryã€‚ å…·ä½“ä»£ç å¦‚ä¸‹: 123456789101112131415161718//getEntry()æ–¹æ³•final Entry&lt;K,V&gt; getEntry(Object key) &#123; ...... if (key == null)//ä¸å…è®¸keyå€¼ä¸ºnull throw new NullPointerException(); Comparable&lt;? super K&gt; k = (Comparable&lt;? super K&gt;) key;//ä½¿ç”¨å…ƒç´ çš„è‡ªç„¶é¡ºåº Entry&lt;K,V&gt; p = root; while (p != null) &#123; int cmp = k.compareTo(p.key); if (cmp &lt; 0)//å‘å·¦æ‰¾ p = p.left; else if (cmp &gt; 0)//å‘å³æ‰¾ p = p.right; else return p; &#125; return null;&#125; put()put(K key, V value)æ–¹æ³•æ˜¯å°†æŒ‡å®šçš„key, valueå¯¹æ·»åŠ åˆ°mapé‡Œã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šå¯¹mapåšä¸€æ¬¡æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦åŒ…å«è¯¥å…ƒç»„ï¼Œå¦‚æœå·²ç»åŒ…å«åˆ™ç›´æ¥è¿”å›ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç±»ä¼¼äºgetEntry()æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™ä¼šåœ¨çº¢é»‘æ ‘ä¸­æ’å…¥æ–°çš„entryï¼Œå¦‚æœæ’å…¥ä¹‹åç ´åäº†çº¢é»‘æ ‘çš„çº¦æŸæ¡ä»¶ï¼Œè¿˜éœ€è¦è¿›è¡Œè°ƒæ•´(æ—‹è½¬ï¼Œæ”¹å˜æŸäº›èŠ‚ç‚¹çš„é¢œè‰²)ã€‚ 123456789101112131415161718192021public V put(K key, V value) &#123;\t...... int cmp; Entry&lt;K,V&gt; parent; if (key == null) throw new NullPointerException(); Comparable&lt;? super K&gt; k = (Comparable&lt;? super K&gt;) key;//ä½¿ç”¨å…ƒç´ çš„è‡ªç„¶é¡ºåº do &#123; parent = t; cmp = k.compareTo(t.key); if (cmp &lt; 0) t = t.left;//å‘å·¦æ‰¾ else if (cmp &gt; 0) t = t.right;//å‘å³æ‰¾ else return t.setValue(value); &#125; while (t != null); Entry&lt;K,V&gt; e = new Entry&lt;&gt;(key, value, parent);//åˆ›å»ºå¹¶æ’å…¥æ–°çš„entry if (cmp &lt; 0) parent.left = e; else parent.right = e; fixAfterInsertion(e);//è°ƒæ•´ size++; return null;&#125; ä¸Šè¿°ä»£ç çš„æ’å…¥éƒ¨åˆ†å¹¶ä¸éš¾ç†è§£: é¦–å…ˆåœ¨çº¢é»‘æ ‘ä¸Šæ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œç„¶ååˆ›å»ºæ–°çš„entryå¹¶æ’å…¥(å½“ç„¶ï¼Œæ–°æ’å…¥çš„èŠ‚ç‚¹ä¸€å®šæ˜¯æ ‘çš„å¶å­)ã€‚éš¾ç‚¹æ˜¯è°ƒæ•´å‡½æ•°fixAfterInsertion()ï¼Œå‰é¢å·²ç»è¯´è¿‡ï¼Œè°ƒæ•´å¾€å¾€éœ€è¦1.æ”¹å˜æŸäº›èŠ‚ç‚¹çš„é¢œè‰²ï¼Œ2.å¯¹æŸäº›èŠ‚ç‚¹è¿›è¡Œæ—‹è½¬ã€‚ è°ƒæ•´å‡½æ•°fixAfterInsertion()çš„å…·ä½“ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ç”¨åˆ°äº†ä¸Šæ–‡ä¸­æåˆ°çš„rotateLeft()å’ŒrotateRight()å‡½æ•°ã€‚é€šè¿‡ä»£ç æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œæƒ…å†µ2å…¶å®æ˜¯è½åœ¨æƒ…å†µ3å†…çš„ã€‚æƒ…å†µ4ï½æƒ…å†µ6è·Ÿå‰ä¸‰ç§æƒ…å†µæ˜¯å¯¹ç§°çš„ï¼Œå› æ­¤å›¾è§£ä¸­å¹¶æ²¡æœ‰ç”»å‡ºåä¸‰ç§æƒ…å†µï¼Œè¯»è€…å¯ä»¥å‚è€ƒä»£ç è‡ªè¡Œç†è§£ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940//çº¢é»‘æ ‘è°ƒæ•´å‡½æ•°fixAfterInsertion()private void fixAfterInsertion(Entry&lt;K,V&gt; x) &#123; x.color = RED; while (x != null &amp;&amp; x != root &amp;&amp; x.parent.color == RED) &#123; if (parentOf(x) == leftOf(parentOf(parentOf(x)))) &#123; Entry&lt;K,V&gt; y = rightOf(parentOf(parentOf(x))); if (colorOf(y) == RED) &#123; setColor(parentOf(x), BLACK); // æƒ…å†µ1 setColor(y, BLACK); // æƒ…å†µ1 setColor(parentOf(parentOf(x)), RED); // æƒ…å†µ1 x = parentOf(parentOf(x)); // æƒ…å†µ1 &#125; else &#123; if (x == rightOf(parentOf(x))) &#123; x = parentOf(x); // æƒ…å†µ2 rotateLeft(x); // æƒ…å†µ2 &#125; setColor(parentOf(x), BLACK); // æƒ…å†µ3 setColor(parentOf(parentOf(x)), RED); // æƒ…å†µ3 rotateRight(parentOf(parentOf(x))); // æƒ…å†µ3 &#125; &#125; else &#123; Entry&lt;K,V&gt; y = leftOf(parentOf(parentOf(x))); if (colorOf(y) == RED) &#123; setColor(parentOf(x), BLACK); // æƒ…å†µ4 setColor(y, BLACK); // æƒ…å†µ4 setColor(parentOf(parentOf(x)), RED); // æƒ…å†µ4 x = parentOf(parentOf(x)); // æƒ…å†µ4 &#125; else &#123; if (x == leftOf(parentOf(x))) &#123; x = parentOf(x); // æƒ…å†µ5 rotateRight(x); // æƒ…å†µ5 &#125; setColor(parentOf(x), BLACK); // æƒ…å†µ6 setColor(parentOf(parentOf(x)), RED); // æƒ…å†µ6 rotateLeft(parentOf(parentOf(x))); // æƒ…å†µ6 &#125; &#125; &#125; root.color = BLACK;&#125; remove()remove(Object key)çš„ä½œç”¨æ˜¯åˆ é™¤keyå€¼å¯¹åº”çš„entryï¼Œè¯¥æ–¹æ³•é¦–å…ˆé€šè¿‡ä¸Šæ–‡ä¸­æåˆ°çš„getEntry(Object key)æ–¹æ³•æ‰¾åˆ°keyå€¼å¯¹åº”çš„entryï¼Œç„¶åè°ƒç”¨deleteEntry(Entry&lt;K,V&gt; entry)åˆ é™¤å¯¹åº”çš„entryã€‚ç”±äºåˆ é™¤æ“ä½œä¼šæ”¹å˜çº¢é»‘æ ‘çš„ç»“æ„ï¼Œæœ‰å¯èƒ½ç ´åçº¢é»‘æ ‘çš„çº¦æŸæ¡ä»¶ï¼Œå› æ­¤æœ‰å¯èƒ½è¦è¿›è¡Œè°ƒæ•´ã€‚ getEntry()å‡½æ•°å‰é¢å·²ç»è®²è§£è¿‡ï¼Œè¿™é‡Œé‡ç‚¹æ”¾deleteEntry()ä¸Šï¼Œè¯¥å‡½æ•°åˆ é™¤æŒ‡å®šçš„entryå¹¶åœ¨çº¢é»‘æ ‘çš„çº¦æŸè¢«ç ´åæ—¶è¿›è¡Œè°ƒç”¨fixAfterDeletion(Entry&lt;K,V&gt; x)è¿›è¡Œè°ƒæ•´ã€‚ ç”±äºçº¢é»‘æ ‘æ˜¯ä¸€æ£µå¢å¼ºç‰ˆçš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œçº¢é»‘æ ‘çš„åˆ é™¤æ“ä½œè·Ÿæ™®é€šäºŒå‰æŸ¥æ‰¾æ ‘çš„åˆ é™¤æ“ä½œä¹Ÿå°±éå¸¸ç›¸ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯çº¢é»‘æ ‘åœ¨èŠ‚ç‚¹åˆ é™¤ä¹‹åå¯èƒ½éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚ç°åœ¨è€ƒè™‘ä¸€æ£µæ™®é€šäºŒå‰æŸ¥æ‰¾æ ‘çš„åˆ é™¤è¿‡ç¨‹ï¼Œå¯ä»¥ç®€å•åˆ†ä¸ºä¸¤ç§æƒ…å†µ: åˆ é™¤ç‚¹pçš„å·¦å³å­æ ‘éƒ½ä¸ºç©ºï¼Œæˆ–è€…åªæœ‰ä¸€æ£µå­æ ‘éç©ºã€‚ åˆ é™¤ç‚¹pçš„å·¦å³å­æ ‘éƒ½éç©ºã€‚ å¯¹äºä¸Šè¿°æƒ…å†µ1ï¼Œå¤„ç†èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œç›´æ¥å°†påˆ é™¤(å·¦å³å­æ ‘éƒ½ä¸ºç©ºæ—¶)ï¼Œæˆ–è€…ç”¨éç©ºå­æ ‘æ›¿ä»£p(åªæœ‰ä¸€æ£µå­æ ‘éç©ºæ—¶)ï¼›å¯¹äºæƒ…å†µ2ï¼Œå¯ä»¥ç”¨pçš„åç»§s(æ ‘ä¸­å¤§äºxçš„æœ€å°çš„é‚£ä¸ªå…ƒç´ )ä»£æ›¿pï¼Œç„¶åä½¿ç”¨æƒ…å†µ1åˆ é™¤s(æ­¤æ—¶sä¸€å®šæ»¡è¶³æƒ…å†µ1.å¯ä»¥ç”»ç”»çœ‹)ã€‚ åŸºäºä»¥ä¸Šé€»è¾‘ï¼Œçº¢é»‘æ ‘çš„èŠ‚ç‚¹åˆ é™¤å‡½æ•°deleteEntry()ä»£ç å¦‚ä¸‹: 123456789101112131415161718192021222324252627282930313233343536// çº¢é»‘æ ‘entryåˆ é™¤å‡½æ•°deleteEntry()private void deleteEntry(Entry&lt;K,V&gt; p) &#123; modCount++; size--; if (p.left != null &amp;&amp; p.right != null) &#123;// 2. åˆ é™¤ç‚¹pçš„å·¦å³å­æ ‘éƒ½éç©ºã€‚ Entry&lt;K,V&gt; s = successor(p);// åç»§ p.key = s.key; p.value = s.value; p = s; &#125; Entry&lt;K,V&gt; replacement = (p.left != null ? p.left : p.right); if (replacement != null) &#123;// 1. åˆ é™¤ç‚¹påªæœ‰ä¸€æ£µå­æ ‘éç©ºã€‚ replacement.parent = p.parent; if (p.parent == null) root = replacement; else if (p == p.parent.left) p.parent.left = replacement; else p.parent.right = replacement; p.left = p.right = p.parent = null; if (p.color == BLACK) fixAfterDeletion(replacement);// è°ƒæ•´ &#125; else if (p.parent == null) &#123; root = null; &#125; else &#123; // 1. åˆ é™¤ç‚¹pçš„å·¦å³å­æ ‘éƒ½ä¸ºç©º if (p.color == BLACK) fixAfterDeletion(p);// è°ƒæ•´ if (p.parent != null) &#123; if (p == p.parent.left) p.parent.left = null; else if (p == p.parent.right) p.parent.right = null; p.parent = null; &#125; &#125;&#125; ä¸Šè¿°ä»£ç ä¸­å æ®å¤§é‡ä»£ç è¡Œçš„ï¼Œæ˜¯ç”¨æ¥ä¿®æ”¹çˆ¶å­èŠ‚ç‚¹é—´å¼•ç”¨å…³ç³»çš„ä»£ç ï¼Œå…¶é€»è¾‘å¹¶ä¸éš¾ç†è§£ã€‚ä¸‹é¢ç€é‡è®²è§£åˆ é™¤åè°ƒæ•´å‡½æ•°fixAfterDeletion()ã€‚é¦–å…ˆè¯·æ€è€ƒä¸€ä¸‹ï¼Œåˆ é™¤äº†å“ªäº›ç‚¹æ‰ä¼šå¯¼è‡´è°ƒæ•´ï¼Ÿåªæœ‰åˆ é™¤ç‚¹æ˜¯BLACKçš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘è°ƒæ•´å‡½æ•°ï¼Œå› ä¸ºåˆ é™¤REDèŠ‚ç‚¹ä¸ä¼šç ´åçº¢é»‘æ ‘çš„ä»»ä½•çº¦æŸï¼Œè€Œåˆ é™¤BLACKèŠ‚ç‚¹ä¼šç ´åè§„åˆ™4ã€‚ è·Ÿä¸Šæ–‡ä¸­è®²è¿‡çš„fixAfterInsertion()å‡½æ•°ä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿè¦åˆ†æˆè‹¥å¹²ç§æƒ…å†µã€‚è®°ä½ï¼Œæ— è®ºæœ‰å¤šå°‘æƒ…å†µï¼Œå…·ä½“çš„è°ƒæ•´æ“ä½œåªæœ‰ä¸¤ç§: 1.æ”¹å˜æŸäº›èŠ‚ç‚¹çš„é¢œè‰²ï¼Œ2.å¯¹æŸäº›èŠ‚ç‚¹è¿›è¡Œæ—‹è½¬ã€‚ ä¸Šè¿°å›¾è§£çš„æ€»ä½“æ€æƒ³æ˜¯: å°†æƒ…å†µ1é¦–å…ˆè½¬æ¢æˆæƒ…å†µ2ï¼Œæˆ–è€…è½¬æ¢æˆæƒ…å†µ3å’Œæƒ…å†µ4ã€‚å½“ç„¶ï¼Œè¯¥å›¾è§£å¹¶ä¸æ„å‘³ç€è°ƒæ•´è¿‡ç¨‹ä¸€å®šæ˜¯ä»æƒ…å†µ1å¼€å§‹ã€‚é€šè¿‡åç»­ä»£ç æˆ‘ä»¬è¿˜ä¼šå‘ç°å‡ ä¸ªæœ‰è¶£çš„è§„åˆ™: a).å¦‚æœæ˜¯ç”±æƒ…å†µ1ä¹‹åç´§æ¥ç€è¿›å…¥çš„æƒ…å†µ2ï¼Œé‚£ä¹ˆæƒ…å†µ2ä¹‹åä¸€å®šä¼šé€€å‡ºå¾ªç¯(å› ä¸ºxä¸ºçº¢è‰²)ï¼›b).ä¸€æ—¦è¿›å…¥æƒ…å†µ3å’Œæƒ…å†µ4ï¼Œä¸€å®šä¼šé€€å‡ºå¾ªç¯(å› ä¸ºxä¸ºroot)ã€‚ åˆ é™¤åè°ƒæ•´å‡½æ•°fixAfterDeletion()çš„å…·ä½“ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ç”¨åˆ°äº†ä¸Šæ–‡ä¸­æåˆ°çš„rotateLeft()å’ŒrotateRight()å‡½æ•°ã€‚é€šè¿‡ä»£ç æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œæƒ…å†µ3å…¶å®æ˜¯è½åœ¨æƒ…å†µ4å†…çš„ã€‚æƒ…å†µ5ï½æƒ…å†µ8è·Ÿå‰å››ç§æƒ…å†µæ˜¯å¯¹ç§°çš„ï¼Œå› æ­¤å›¾è§£ä¸­å¹¶æ²¡æœ‰ç”»å‡ºåå››ç§æƒ…å†µï¼Œè¯»è€…å¯ä»¥å‚è€ƒä»£ç è‡ªè¡Œç†è§£ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556private void fixAfterDeletion(Entry&lt;K,V&gt; x) &#123; while (x != root &amp;&amp; colorOf(x) == BLACK) &#123; if (x == leftOf(parentOf(x))) &#123; Entry&lt;K,V&gt; sib = rightOf(parentOf(x)); if (colorOf(sib) == RED) &#123; setColor(sib, BLACK); // æƒ…å†µ1 setColor(parentOf(x), RED); // æƒ…å†µ1 rotateLeft(parentOf(x)); // æƒ…å†µ1 sib = rightOf(parentOf(x)); // æƒ…å†µ1 &#125; if (colorOf(leftOf(sib)) == BLACK &amp;&amp; colorOf(rightOf(sib)) == BLACK) &#123; setColor(sib, RED); // æƒ…å†µ2 x = parentOf(x); // æƒ…å†µ2 &#125; else &#123; if (colorOf(rightOf(sib)) == BLACK) &#123; setColor(leftOf(sib), BLACK); // æƒ…å†µ3 setColor(sib, RED); // æƒ…å†µ3 rotateRight(sib); // æƒ…å†µ3 sib = rightOf(parentOf(x)); // æƒ…å†µ3 &#125; setColor(sib, colorOf(parentOf(x))); // æƒ…å†µ4 setColor(parentOf(x), BLACK); // æƒ…å†µ4 setColor(rightOf(sib), BLACK); // æƒ…å†µ4 rotateLeft(parentOf(x)); // æƒ…å†µ4 x = root; // æƒ…å†µ4 &#125; &#125; else &#123; // è·Ÿå‰å››ç§æƒ…å†µå¯¹ç§° Entry&lt;K,V&gt; sib = leftOf(parentOf(x)); if (colorOf(sib) == RED) &#123; setColor(sib, BLACK); // æƒ…å†µ5 setColor(parentOf(x), RED); // æƒ…å†µ5 rotateRight(parentOf(x)); // æƒ…å†µ5 sib = leftOf(parentOf(x)); // æƒ…å†µ5 &#125; if (colorOf(rightOf(sib)) == BLACK &amp;&amp; colorOf(leftOf(sib)) == BLACK) &#123; setColor(sib, RED); // æƒ…å†µ6 x = parentOf(x); // æƒ…å†µ6 &#125; else &#123; if (colorOf(leftOf(sib)) == BLACK) &#123; setColor(rightOf(sib), BLACK); // æƒ…å†µ7 setColor(sib, RED); // æƒ…å†µ7 rotateLeft(sib); // æƒ…å†µ7 sib = leftOf(parentOf(x)); // æƒ…å†µ7 &#125; setColor(sib, colorOf(parentOf(x))); // æƒ…å†µ8 setColor(parentOf(x), BLACK); // æƒ…å†µ8 setColor(leftOf(sib), BLACK); // æƒ…å†µ8 rotateRight(parentOf(x)); // æƒ…å†µ8 x = root; // æƒ…å†µ8 &#125; &#125; &#125; setColor(x, BLACK);&#125; TreeSetå‰é¢å·²ç»è¯´è¿‡TreeSetæ˜¯å¯¹TreeMapçš„ç®€å•åŒ…è£…ï¼Œå¯¹TreeSetçš„å‡½æ•°è°ƒç”¨éƒ½ä¼šè½¬æ¢æˆåˆé€‚çš„TreeMapæ–¹æ³•ï¼Œå› æ­¤TreeSetçš„å®ç°éå¸¸ç®€å•ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚ 1234567891011121314151617// TreeSetæ˜¯å¯¹TreeMapçš„ç®€å•åŒ…è£…public class TreeSet&lt;E&gt; extends AbstractSet&lt;E&gt; implements NavigableSet&lt;E&gt;, Cloneable, java.io.Serializable&#123;\t...... private transient NavigableMap&lt;E,Object&gt; m; // Dummy value to associate with an Object in the backing Map private static final Object PRESENT = new Object(); public TreeSet() &#123; this.m = new TreeMap&lt;E,Object&gt;();// TreeSeté‡Œé¢æœ‰ä¸€ä¸ªTreeMap &#125; ...... public boolean add(E e) &#123; return m.put(e, PRESENT)==null; &#125; ......&#125;","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"7.Map - LinkedHashSet&Mapæºç è§£æ","path":"/2023/12/25/7-Map-LinkedHashSet-Mapæºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Map - LinkedHashSet&amp;Map æºç è§£æã€‚ Java 7 - LinkedHashSet&amp;Mapæ€»ä½“ä»‹ç»å¦‚æœä½ å·²çœ‹è¿‡å‰é¢å…³äºHashSetå’ŒHashMapï¼Œä»¥åŠTreeSetå’ŒTreeMapçš„è®²è§£ï¼Œä¸€å®šèƒ½å¤Ÿæƒ³åˆ°æœ¬æ–‡å°†è¦è®²è§£çš„LinkedHashSetå’ŒLinkedHashMapå…¶å®ä¹Ÿæ˜¯ä¸€å›äº‹ã€‚LinkedHashSetå’ŒLinkedHashMapåœ¨Javaé‡Œä¹Ÿæœ‰ç€ç›¸åŒçš„å®ç°ï¼Œå‰è€…ä»…ä»…æ˜¯å¯¹åè€…åšäº†ä¸€å±‚åŒ…è£…ï¼Œä¹Ÿå°±æ˜¯è¯´**LinkedHashSeté‡Œé¢æœ‰ä¸€ä¸ªLinkedHashMap(é€‚é…å™¨æ¨¡å¼)*ã€‚å› æ­¤æœ¬æ–‡å°†é‡ç‚¹åˆ†æLinkedHashMap*ã€‚ LinkedHashMapå®ç°äº†Mapæ¥å£ï¼Œå³å…è®¸æ”¾å…¥keyä¸ºnullçš„å…ƒç´ ï¼Œä¹Ÿå…è®¸æ’å…¥valueä¸ºnullçš„å…ƒç´ ã€‚ä»åå­—ä¸Šå¯ä»¥çœ‹å‡ºè¯¥å®¹å™¨æ˜¯linked listå’ŒHashMapçš„æ··åˆä½“ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåŒæ—¶æ»¡è¶³HashMapå’Œlinked listçš„æŸäº›ç‰¹æ€§ã€‚å¯å°†*LinkedHashMap*çœ‹ä½œé‡‡ç”¨*linked list*å¢å¼ºçš„*HashMap*ã€‚ äº‹å®ä¸ŠLinkedHashMapæ˜¯HashMapçš„ç›´æ¥å­ç±»ï¼ŒäºŒè€…å”¯ä¸€çš„åŒºåˆ«æ˜¯*LinkedHashMap*åœ¨*HashMap*çš„åŸºç¡€ä¸Šï¼Œé‡‡ç”¨åŒå‘é“¾è¡¨(doubly-linked list)çš„å½¢å¼å°†æ‰€æœ‰entryè¿æ¥èµ·æ¥ï¼Œè¿™æ ·æ˜¯ä¸ºä¿è¯å…ƒç´ çš„è¿­ä»£é¡ºåºè·Ÿæ’å…¥é¡ºåºç›¸åŒã€‚ä¸Šå›¾ç»™å‡ºäº†LinkedHashMapçš„ç»“æ„å›¾ï¼Œä¸»ä½“éƒ¨åˆ†è·ŸHashMapå®Œå…¨ä¸€æ ·ï¼Œå¤šäº†headeræŒ‡å‘åŒå‘é“¾è¡¨çš„å¤´éƒ¨(æ˜¯ä¸€ä¸ªå“‘å…ƒ)ï¼Œè¯¥åŒå‘é“¾è¡¨çš„è¿­ä»£é¡ºåºå°±æ˜¯entryçš„æ’å…¥é¡ºåºã€‚ é™¤äº†å¯ä»¥ä¿è¿­ä»£å†é¡ºåºï¼Œè¿™ç§ç»“æ„è¿˜æœ‰ä¸€ä¸ªå¥½å¤„ : è¿­ä»£*LinkedHashMap*æ—¶ä¸éœ€è¦åƒ*HashMap*é‚£æ ·éå†æ•´ä¸ªtableï¼Œè€Œåªéœ€è¦ç›´æ¥éå†headeræŒ‡å‘çš„åŒå‘é“¾è¡¨å³å¯ï¼Œä¹Ÿå°±æ˜¯è¯´LinkedHashMapçš„è¿­ä»£æ—¶é—´å°±åªè·Ÿentryçš„ä¸ªæ•°ç›¸å…³ï¼Œè€Œè·Ÿtableçš„å¤§å°æ— å…³ã€‚ æœ‰ä¸¤ä¸ªå‚æ•°å¯ä»¥å½±å“LinkedHashMapçš„æ€§èƒ½: åˆå§‹å®¹é‡(inital capacity)å’Œè´Ÿè½½ç³»æ•°(load factor)ã€‚åˆå§‹å®¹é‡æŒ‡å®šäº†åˆå§‹tableçš„å¤§å°ï¼Œè´Ÿè½½ç³»æ•°ç”¨æ¥æŒ‡å®šè‡ªåŠ¨æ‰©å®¹çš„ä¸´ç•Œå€¼ã€‚å½“entryçš„æ•°é‡è¶…è¿‡capacity*load_factoræ—¶ï¼Œå®¹å™¨å°†è‡ªåŠ¨æ‰©å®¹å¹¶é‡æ–°å“ˆå¸Œã€‚å¯¹äºæ’å…¥å…ƒç´ è¾ƒå¤šçš„åœºæ™¯ï¼Œå°†åˆå§‹å®¹é‡è®¾å¤§å¯ä»¥å‡å°‘é‡æ–°å“ˆå¸Œçš„æ¬¡æ•°ã€‚ å°†å¯¹è±¡æ”¾å…¥åˆ°LinkedHashMapæˆ–LinkedHashSetä¸­æ—¶ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•éœ€è¦ç‰¹åˆ«å…³å¿ƒ: hashCode()å’Œequals()ã€‚**hashCode()æ–¹æ³•å†³å®šäº†å¯¹è±¡ä¼šè¢«æ”¾åˆ°å“ªä¸ªbucketé‡Œï¼Œå½“å¤šä¸ªå¯¹è±¡çš„å“ˆå¸Œå€¼å†²çªæ—¶ï¼Œequals()æ–¹æ³•å†³å®šäº†è¿™äº›å¯¹è±¡æ˜¯å¦æ˜¯â€œåŒä¸€ä¸ªå¯¹è±¡â€**ã€‚æ‰€ä»¥ï¼Œå¦‚æœè¦å°†è‡ªå®šä¹‰çš„å¯¹è±¡æ”¾å…¥åˆ°LinkedHashMapæˆ–LinkedHashSetä¸­ï¼Œéœ€è¦@Override hashCode()å’Œequals()æ–¹æ³•ã€‚ é€šè¿‡å¦‚ä¸‹æ–¹å¼å¯ä»¥å¾—åˆ°ä¸€ä¸ªè·ŸæºMap è¿­ä»£é¡ºåºä¸€æ ·çš„LinkedHashMap: 1234void foo(Map m) &#123; Map copy = new LinkedHashMap(m); ...&#125; å‡ºäºæ€§èƒ½åŸå› ï¼ŒLinkedHashMapæ˜¯éåŒæ­¥çš„(not synchronized)ï¼Œå¦‚æœéœ€è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨ï¼Œéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨åŒæ­¥ï¼›æˆ–è€…é€šè¿‡å¦‚ä¸‹æ–¹å¼å°†LinkedHashMapåŒ…è£…æˆ(wrapped)åŒæ­¥çš„: 1Map m = Collections.synchronizedMap(new LinkedHashMap(...)); æ–¹æ³•å‰–æget()get(Object key)æ–¹æ³•æ ¹æ®æŒ‡å®šçš„keyå€¼è¿”å›å¯¹åº”çš„valueã€‚è¯¥æ–¹æ³•è·ŸHashMap.get()æ–¹æ³•çš„æµç¨‹å‡ ä¹å®Œå…¨ä¸€æ ·ï¼Œè¯»è€…å¯è‡ªè¡Œ[å‚è€ƒå‰æ–‡åœ¨æ–°çª—å£æ‰“å¼€](https://github.com/CarpenterLee/JCFInternals/blob/master/markdown/6-HashSet and HashMap.md#get)ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ put()put(K key, V value)æ–¹æ³•æ˜¯å°†æŒ‡å®šçš„key, valueå¯¹æ·»åŠ åˆ°mapé‡Œã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šå¯¹mapåšä¸€æ¬¡æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦åŒ…å«è¯¥å…ƒç»„ï¼Œå¦‚æœå·²ç»åŒ…å«åˆ™ç›´æ¥è¿”å›ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç±»ä¼¼äºget()æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šé€šè¿‡addEntry(int hash, K key, V value, int bucketIndex)æ–¹æ³•æ’å…¥æ–°çš„entryã€‚ æ³¨æ„ï¼Œè¿™é‡Œçš„æ’å…¥æœ‰ä¸¤é‡å«ä¹‰: ä»tableçš„è§’åº¦çœ‹ï¼Œæ–°çš„entryéœ€è¦æ’å…¥åˆ°å¯¹åº”çš„bucketé‡Œï¼Œå½“æœ‰å“ˆå¸Œå†²çªæ—¶ï¼Œé‡‡ç”¨å¤´æ’æ³•å°†æ–°çš„entryæ’å…¥åˆ°å†²çªé“¾è¡¨çš„å¤´éƒ¨ã€‚ ä»headerçš„è§’åº¦çœ‹ï¼Œæ–°çš„entryéœ€è¦æ’å…¥åˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨ã€‚ addEntry()ä»£ç å¦‚ä¸‹: 123456789101112131415// LinkedHashMap.addEntry()void addEntry(int hash, K key, V value, int bucketIndex) &#123; if ((size &gt;= threshold) &amp;&amp; (null != table[bucketIndex])) &#123; resize(2 * table.length);// è‡ªåŠ¨æ‰©å®¹ï¼Œå¹¶é‡æ–°å“ˆå¸Œ hash = (null != key) ? hash(key) : 0; bucketIndex = hash &amp; (table.length-1);// hash%table.length &#125; // 1.åœ¨å†²çªé“¾è¡¨å¤´éƒ¨æ’å…¥æ–°çš„entry HashMap.Entry&lt;K,V&gt; old = table[bucketIndex]; Entry&lt;K,V&gt; e = new Entry&lt;&gt;(hash, key, value, old); table[bucketIndex] = e; // 2.åœ¨åŒå‘é“¾è¡¨çš„å°¾éƒ¨æ’å…¥æ–°çš„entry e.addBefore(header); size++;&#125; ä¸Šè¿°ä»£ç ä¸­ç”¨åˆ°äº†addBefore()æ–¹æ³•å°†æ–°entry eæ’å…¥åˆ°åŒå‘é“¾è¡¨å¤´å¼•ç”¨headerçš„å‰é¢ï¼Œè¿™æ ·eå°±æˆä¸ºåŒå‘é“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚addBefore()çš„ä»£ç å¦‚ä¸‹: 1234567// LinkedHashMap.Entry.addBefor()ï¼Œå°†thisæ’å…¥åˆ°existingEntryçš„å‰é¢private void addBefore(Entry&lt;K,V&gt; existingEntry) &#123; after = existingEntry; before = existingEntry.before; before.after = this; after.before = this;&#125; ä¸Šè¿°ä»£ç åªæ˜¯ç®€å•ä¿®æ”¹ç›¸å…³entryçš„å¼•ç”¨è€Œå·²ã€‚ remove()remove(Object key)çš„ä½œç”¨æ˜¯åˆ é™¤keyå€¼å¯¹åº”çš„entryï¼Œè¯¥æ–¹æ³•çš„å…·ä½“é€»è¾‘æ˜¯åœ¨removeEntryForKey(Object key)é‡Œå®ç°çš„ã€‚removeEntryForKey()æ–¹æ³•ä¼šé¦–å…ˆæ‰¾åˆ°keyå€¼å¯¹åº”çš„entryï¼Œç„¶ååˆ é™¤è¯¥entry(ä¿®æ”¹é“¾è¡¨çš„ç›¸åº”å¼•ç”¨)ã€‚æŸ¥æ‰¾è¿‡ç¨‹è·Ÿget()æ–¹æ³•ç±»ä¼¼ã€‚ æ³¨æ„ï¼Œè¿™é‡Œçš„åˆ é™¤ä¹Ÿæœ‰ä¸¤é‡å«ä¹‰: ä»tableçš„è§’åº¦çœ‹ï¼Œéœ€è¦å°†è¯¥entryä»å¯¹åº”çš„bucketé‡Œåˆ é™¤ï¼Œå¦‚æœå¯¹åº”çš„å†²çªé“¾è¡¨ä¸ç©ºï¼Œéœ€è¦ä¿®æ”¹å†²çªé“¾è¡¨çš„ç›¸åº”å¼•ç”¨ã€‚ ä»headerçš„è§’åº¦æ¥çœ‹ï¼Œéœ€è¦å°†è¯¥entryä»åŒå‘é“¾è¡¨ä¸­åˆ é™¤ï¼ŒåŒæ—¶ä¿®æ”¹é“¾è¡¨ä¸­å‰é¢ä»¥åŠåé¢å…ƒç´ çš„ç›¸åº”å¼•ç”¨ã€‚ removeEntryForKey()å¯¹åº”çš„ä»£ç å¦‚ä¸‹: 12345678910111213141516171819202122232425// LinkedHashMap.removeEntryForKey()ï¼Œåˆ é™¤keyå€¼å¯¹åº”çš„entryfinal Entry&lt;K,V&gt; removeEntryForKey(Object key) &#123;\t......\tint hash = (key == null) ? 0 : hash(key); int i = indexFor(hash, table.length);// hash&amp;(table.length-1) Entry&lt;K,V&gt; prev = table[i];// å¾—åˆ°å†²çªé“¾è¡¨ Entry&lt;K,V&gt; e = prev; while (e != null) &#123;// éå†å†²çªé“¾è¡¨ Entry&lt;K,V&gt; next = e.next; Object k; if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) &#123;// æ‰¾åˆ°è¦åˆ é™¤çš„entry modCount++; size--; // 1. å°†eä»å¯¹åº”bucketçš„å†²çªé“¾è¡¨ä¸­åˆ é™¤ if (prev == e) table[i] = next; else prev.next = next; // 2. å°†eä»åŒå‘é“¾è¡¨ä¸­åˆ é™¤ e.before.after = e.after; e.after.before = e.before; return e; &#125; prev = e; e = next; &#125; return e;&#125; LinkedHashSetå‰é¢å·²ç»è¯´è¿‡LinkedHashSetæ˜¯å¯¹LinkedHashMapçš„ç®€å•åŒ…è£…ï¼Œå¯¹LinkedHashSetçš„å‡½æ•°è°ƒç”¨éƒ½ä¼šè½¬æ¢æˆåˆé€‚çš„LinkedHashMapæ–¹æ³•ï¼Œå› æ­¤LinkedHashSetçš„å®ç°éå¸¸ç®€å•ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ 1234567891011121314public class LinkedHashSet&lt;E&gt; extends HashSet&lt;E&gt; implements Set&lt;E&gt;, Cloneable, java.io.Serializable &#123; ...... // LinkedHashSeté‡Œé¢æœ‰ä¸€ä¸ªLinkedHashMap public LinkedHashSet(int initialCapacity, float loadFactor) &#123; map = new LinkedHashMap&lt;&gt;(initialCapacity, loadFactor); &#125;\t...... public boolean add(E e) &#123;//ç®€å•çš„æ–¹æ³•è½¬æ¢ return map.put(e, PRESENT)==null; &#125; ......&#125; LinkedHashMapç»å…¸ç”¨æ³•LinkedHashMapé™¤äº†å¯ä»¥ä¿è¯è¿­ä»£é¡ºåºå¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç”¨æ³•: å¯ä»¥è½»æ¾å®ç°ä¸€ä¸ªé‡‡ç”¨äº†FIFOæ›¿æ¢ç­–ç•¥çš„ç¼“å­˜ã€‚å…·ä½“è¯´æ¥ï¼ŒLinkedHashMapæœ‰ä¸€ä¸ªå­ç±»æ–¹æ³•protected boolean removeEldestEntry(Map.Entry&lt;K,V&gt; eldest)ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯å‘Šè¯‰Mapæ˜¯å¦è¦åˆ é™¤â€œæœ€è€â€çš„Entryï¼Œæ‰€è°“æœ€è€å°±æ˜¯å½“å‰Mapä¸­æœ€æ—©æ’å…¥çš„Entryï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å›trueï¼Œæœ€è€çš„é‚£ä¸ªå…ƒç´ å°±ä¼šè¢«åˆ é™¤ã€‚åœ¨æ¯æ¬¡æ’å…¥æ–°å…ƒç´ çš„ä¹‹åLinkedHashMapä¼šè‡ªåŠ¨è¯¢é—®removeEldestEntry()æ˜¯å¦è¦åˆ é™¤æœ€è€çš„å…ƒç´ ã€‚è¿™æ ·åªéœ€è¦åœ¨å­ç±»ä¸­é‡è½½è¯¥æ–¹æ³•ï¼Œå½“å…ƒç´ ä¸ªæ•°è¶…è¿‡ä¸€å®šæ•°é‡æ—¶è®©removeEldestEntry()è¿”å›trueï¼Œå°±èƒ½å¤Ÿå®ç°ä¸€ä¸ªå›ºå®šå¤§å°çš„FIFOç­–ç•¥çš„ç¼“å­˜ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹: 12345678910111213/** ä¸€ä¸ªå›ºå®šå¤§å°çš„FIFOæ›¿æ¢ç­–ç•¥çš„ç¼“å­˜ */class FIFOCache&lt;K, V&gt; extends LinkedHashMap&lt;K, V&gt;&#123; private final int cacheSize; public FIFOCache(int cacheSize)&#123; this.cacheSize = cacheSize; &#125; // å½“Entryä¸ªæ•°è¶…è¿‡cacheSizeæ—¶ï¼Œåˆ é™¤æœ€è€çš„Entry @Override protected boolean removeEldestEntry(Map.Entry&lt;K,V&gt; eldest) &#123; return size() &gt; cacheSize; &#125;&#125;","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"6.Map - HashSet & HashMap æºç è§£æ","path":"/2023/12/25/6-Map-HashSet-HashMap-æºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Map - HashSet &amp; HashMapè¿›è¡Œæºç è§£æã€‚ Java7 HashMapæ¦‚è¿°ä¹‹æ‰€ä»¥æŠŠHashSetå’ŒHashMapæ”¾åœ¨ä¸€èµ·è®²è§£ï¼Œæ˜¯å› ä¸ºäºŒè€…åœ¨Javaé‡Œæœ‰ç€ç›¸åŒçš„å®ç°ï¼Œå‰è€…ä»…ä»…æ˜¯å¯¹åè€…åšäº†ä¸€å±‚åŒ…è£…ï¼Œä¹Ÿå°±æ˜¯è¯´HashSeté‡Œé¢æœ‰ä¸€ä¸ªHashMap(é€‚é…å™¨æ¨¡å¼)ã€‚å› æ­¤æœ¬æ–‡å°†é‡ç‚¹åˆ†æHashMapã€‚ HashMapå®ç°äº†Mapæ¥å£ï¼Œå³å…è®¸æ”¾å…¥keyä¸ºnullçš„å…ƒç´ ï¼Œä¹Ÿå…è®¸æ’å…¥valueä¸ºnullçš„å…ƒç´ ï¼›é™¤è¯¥ç±»æœªå®ç°åŒæ­¥å¤–ï¼Œå…¶ä½™è·ŸHashtableå¤§è‡´ç›¸åŒï¼›è·ŸTreeMapä¸åŒï¼Œè¯¥å®¹å™¨ä¸ä¿è¯å…ƒç´ é¡ºåºï¼Œæ ¹æ®éœ€è¦è¯¥å®¹å™¨å¯èƒ½ä¼šå¯¹å…ƒç´ é‡æ–°å“ˆå¸Œï¼Œå…ƒç´ çš„é¡ºåºä¹Ÿä¼šè¢«é‡æ–°æ‰“æ•£ï¼Œå› æ­¤ä¸åŒæ—¶é—´è¿­ä»£åŒä¸€ä¸ªHashMapçš„é¡ºåºå¯èƒ½ä¼šä¸åŒã€‚ æ ¹æ®å¯¹å†²çªçš„å¤„ç†æ–¹å¼ä¸åŒï¼Œå“ˆå¸Œè¡¨æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€ç§å¼€æ”¾åœ°å€æ–¹å¼(Open addressing)ï¼Œå¦ä¸€ç§æ˜¯å†²çªé“¾è¡¨æ–¹å¼(Separate chaining with linked lists)ã€‚Java7 *HashMap*é‡‡ç”¨çš„æ˜¯å†²çªé“¾è¡¨æ–¹å¼ã€‚ ä»ä¸Šå›¾å®¹æ˜“çœ‹å‡ºï¼Œå¦‚æœé€‰æ‹©åˆé€‚çš„å“ˆå¸Œå‡½æ•°ï¼Œput()å’Œget()æ–¹æ³•å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆã€‚ä½†åœ¨å¯¹HashMapè¿›è¡Œè¿­ä»£æ—¶ï¼Œéœ€è¦éå†æ•´ä¸ªtableä»¥åŠåé¢è·Ÿçš„å†²çªé“¾è¡¨ã€‚å› æ­¤å¯¹äºè¿­ä»£æ¯”è¾ƒé¢‘ç¹çš„åœºæ™¯ï¼Œä¸å®œå°†HashMapçš„åˆå§‹å¤§å°è®¾çš„è¿‡å¤§ã€‚ æœ‰ä¸¤ä¸ªå‚æ•°å¯ä»¥å½±å“HashMapçš„æ€§èƒ½: åˆå§‹å®¹é‡(inital capacity)å’Œè´Ÿè½½ç³»æ•°(load factor)ã€‚åˆå§‹å®¹é‡æŒ‡å®šäº†åˆå§‹tableçš„å¤§å°ï¼Œè´Ÿè½½ç³»æ•°ç”¨æ¥æŒ‡å®šè‡ªåŠ¨æ‰©å®¹çš„ä¸´ç•Œå€¼ã€‚å½“entryçš„æ•°é‡è¶…è¿‡capacity*load_factoræ—¶ï¼Œå®¹å™¨å°†è‡ªåŠ¨æ‰©å®¹å¹¶é‡æ–°å“ˆå¸Œã€‚å¯¹äºæ’å…¥å…ƒç´ è¾ƒå¤šçš„åœºæ™¯ï¼Œå°†åˆå§‹å®¹é‡è®¾å¤§å¯ä»¥å‡å°‘é‡æ–°å“ˆå¸Œçš„æ¬¡æ•°ã€‚ å°†å¯¹è±¡æ”¾å…¥åˆ°HashMapæˆ–HashSetä¸­æ—¶ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•éœ€è¦ç‰¹åˆ«å…³å¿ƒ: hashCode()å’Œequals()ã€‚**hashCode()æ–¹æ³•å†³å®šäº†å¯¹è±¡ä¼šè¢«æ”¾åˆ°å“ªä¸ªbucketé‡Œï¼Œå½“å¤šä¸ªå¯¹è±¡çš„å“ˆå¸Œå€¼å†²çªæ—¶ï¼Œequals()æ–¹æ³•å†³å®šäº†è¿™äº›å¯¹è±¡æ˜¯å¦æ˜¯â€œåŒä¸€ä¸ªå¯¹è±¡â€ã€‚æ‰€ä»¥ï¼Œå¦‚æœè¦å°†è‡ªå®šä¹‰çš„å¯¹è±¡æ”¾å…¥åˆ°HashMapæˆ–HashSetä¸­ï¼Œéœ€è¦@Override** hashCode()å’Œequals()æ–¹æ³•ã€‚ get()get(Object key)æ–¹æ³•æ ¹æ®æŒ‡å®šçš„keyå€¼è¿”å›å¯¹åº”çš„valueï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†getEntry(Object key)å¾—åˆ°ç›¸åº”çš„entryï¼Œç„¶åè¿”å›entry.getValue()ã€‚å› æ­¤getEntry()æ˜¯ç®—æ³•çš„æ ¸å¿ƒã€‚ ç®—æ³•æ€æƒ³æ˜¯é¦–å…ˆé€šè¿‡hash()å‡½æ•°å¾—åˆ°å¯¹åº”bucketçš„ä¸‹æ ‡ï¼Œç„¶åä¾æ¬¡éå†å†²çªé“¾è¡¨ï¼Œé€šè¿‡key.equals(k)æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è¦æ‰¾çš„é‚£ä¸ªentryã€‚ ä¸Šå›¾ä¸­hash(k)&amp;(table.length-1)ç­‰ä»·äºhash(k)%table.lengthï¼ŒåŸå› æ˜¯HashMapè¦æ±‚table.lengthå¿…é¡»æ˜¯2çš„æŒ‡æ•°ï¼Œå› æ­¤table.length-1å°±æ˜¯äºŒè¿›åˆ¶ä½ä½å…¨æ˜¯1ï¼Œè·Ÿhash(k)ç›¸ä¸ä¼šå°†å“ˆå¸Œå€¼çš„é«˜ä½å…¨æŠ¹æ‰ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä½™æ•°äº†ã€‚ 1234567891011121314//getEntry()æ–¹æ³•final Entry&lt;K,V&gt; getEntry(Object key) &#123;\t......\tint hash = (key == null) ? 0 : hash(key); for (Entry&lt;K,V&gt; e = table[hash&amp;(table.length-1)];//å¾—åˆ°å†²çªé“¾è¡¨ e != null; e = e.next) &#123;//ä¾æ¬¡éå†å†²çªé“¾è¡¨ä¸­çš„æ¯ä¸ªentry Object k; //ä¾æ®equals()æ–¹æ³•åˆ¤æ–­æ˜¯å¦ç›¸ç­‰ if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) return e; &#125; return null;&#125; put()put(K key, V value)æ–¹æ³•æ˜¯å°†æŒ‡å®šçš„key, valueå¯¹æ·»åŠ åˆ°mapé‡Œã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šå¯¹mapåšä¸€æ¬¡æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦åŒ…å«è¯¥å…ƒç»„ï¼Œå¦‚æœå·²ç»åŒ…å«åˆ™ç›´æ¥è¿”å›ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç±»ä¼¼äºgetEntry()æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šé€šè¿‡addEntry(int hash, K key, V value, int bucketIndex)æ–¹æ³•æ’å…¥æ–°çš„entryï¼Œæ’å…¥æ–¹å¼ä¸ºå¤´æ’æ³•ã€‚ 123456789101112//addEntry()void addEntry(int hash, K key, V value, int bucketIndex) &#123; if ((size &gt;= threshold) &amp;&amp; (null != table[bucketIndex])) &#123; resize(2 * table.length);//è‡ªåŠ¨æ‰©å®¹ï¼Œå¹¶é‡æ–°å“ˆå¸Œ hash = (null != key) ? hash(key) : 0; bucketIndex = hash &amp; (table.length-1);//hash%table.length &#125; //åœ¨å†²çªé“¾è¡¨å¤´éƒ¨æ’å…¥æ–°çš„entry Entry&lt;K,V&gt; e = table[bucketIndex]; table[bucketIndex] = new Entry&lt;&gt;(hash, key, value, e); size++;&#125; remove()remove(Object key)çš„ä½œç”¨æ˜¯åˆ é™¤keyå€¼å¯¹åº”çš„entryï¼Œè¯¥æ–¹æ³•çš„å…·ä½“é€»è¾‘æ˜¯åœ¨removeEntryForKey(Object key)é‡Œå®ç°çš„ã€‚removeEntryForKey()æ–¹æ³•ä¼šé¦–å…ˆæ‰¾åˆ°keyå€¼å¯¹åº”çš„entryï¼Œç„¶ååˆ é™¤è¯¥entry(ä¿®æ”¹é“¾è¡¨çš„ç›¸åº”å¼•ç”¨)ã€‚æŸ¥æ‰¾è¿‡ç¨‹è·ŸgetEntry()è¿‡ç¨‹ç±»ä¼¼ã€‚ 123456789101112131415161718192021//removeEntryForKey()final Entry&lt;K,V&gt; removeEntryForKey(Object key) &#123;\t......\tint hash = (key == null) ? 0 : hash(key); int i = indexFor(hash, table.length);//hash&amp;(table.length-1) Entry&lt;K,V&gt; prev = table[i];//å¾—åˆ°å†²çªé“¾è¡¨ Entry&lt;K,V&gt; e = prev; while (e != null) &#123;//éå†å†²çªé“¾è¡¨ Entry&lt;K,V&gt; next = e.next; Object k; if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) &#123;//æ‰¾åˆ°è¦åˆ é™¤çš„entry modCount++; size--; if (prev == e) table[i] = next;//åˆ é™¤çš„æ˜¯å†²çªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªentry else prev.next = next; return e; &#125; prev = e; e = next; &#125; return e;&#125; Java8 HashMapJava8 å¯¹ HashMap è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼Œæœ€å¤§çš„ä¸åŒå°±æ˜¯åˆ©ç”¨äº†çº¢é»‘æ ‘ï¼Œæ‰€ä»¥å…¶ç”± æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ ç»„æˆã€‚ æ ¹æ® Java7 HashMap çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒæŸ¥æ‰¾çš„æ—¶å€™ï¼Œæ ¹æ® hash å€¼æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ°æ•°ç»„çš„å…·ä½“ä¸‹æ ‡ï¼Œä½†æ˜¯ä¹‹åçš„è¯ï¼Œéœ€è¦é¡ºç€é“¾è¡¨ä¸€ä¸ªä¸ªæ¯”è¾ƒä¸‹å»æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„ï¼Œæ—¶é—´å¤æ‚åº¦å–å†³äºé“¾è¡¨çš„é•¿åº¦ï¼Œä¸º O(n)ã€‚ ä¸ºäº†é™ä½è¿™éƒ¨åˆ†çš„å¼€é”€ï¼Œåœ¨ Java8 ä¸­ï¼Œå½“é“¾è¡¨ä¸­çš„å…ƒç´ è¾¾åˆ°äº† 8 ä¸ªæ—¶ï¼Œä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œåœ¨è¿™äº›ä½ç½®è¿›è¡ŒæŸ¥æ‰¾çš„æ—¶å€™å¯ä»¥é™ä½æ—¶é—´å¤æ‚åº¦ä¸º O(logN)ã€‚ æ¥ä¸€å¼ å›¾ç®€å•ç¤ºæ„ä¸€ä¸‹å§ï¼š æ³¨æ„ï¼Œä¸Šå›¾æ˜¯ç¤ºæ„å›¾ï¼Œä¸»è¦æ˜¯æè¿°ç»“æ„ï¼Œä¸ä¼šè¾¾åˆ°è¿™ä¸ªçŠ¶æ€çš„ï¼Œå› ä¸ºè¿™ä¹ˆå¤šæ•°æ®çš„æ—¶å€™æ—©å°±æ‰©å®¹äº†ã€‚ ä¸‹é¢ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ä»£ç æ¥ä»‹ç»å§ï¼Œä¸ªäººæ„Ÿè§‰ï¼ŒJava8 çš„æºç å¯è¯»æ€§è¦å·®ä¸€äº›ï¼Œä¸è¿‡ç²¾ç®€ä¸€äº›ã€‚ Java7 ä¸­ä½¿ç”¨ Entry æ¥ä»£è¡¨æ¯ä¸ª HashMap ä¸­çš„æ•°æ®èŠ‚ç‚¹ï¼ŒJava8 ä¸­ä½¿ç”¨ Nodeï¼ŒåŸºæœ¬æ²¡æœ‰åŒºåˆ«ï¼Œéƒ½æ˜¯ keyï¼Œvalueï¼Œhash å’Œ next è¿™å››ä¸ªå±æ€§ï¼Œä¸è¿‡ï¼ŒNode åªèƒ½ç”¨äºé“¾è¡¨çš„æƒ…å†µï¼Œçº¢é»‘æ ‘çš„æƒ…å†µéœ€è¦ä½¿ç”¨ TreeNodeã€‚ æˆ‘ä»¬æ ¹æ®æ•°ç»„å…ƒç´ ä¸­ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ•°æ®ç±»å‹æ˜¯ Node è¿˜æ˜¯ TreeNode æ¥åˆ¤æ–­è¯¥ä½ç½®ä¸‹æ˜¯é“¾è¡¨è¿˜æ˜¯çº¢é»‘æ ‘çš„ã€‚ put è¿‡ç¨‹åˆ†æ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public V put(K key, V value) &#123; return putVal(hash(key), key, value, false, true);&#125;// ç¬¬å››ä¸ªå‚æ•° onlyIfAbsent å¦‚æœæ˜¯ trueï¼Œé‚£ä¹ˆåªæœ‰åœ¨ä¸å­˜åœ¨è¯¥ key æ—¶æ‰ä¼šè¿›è¡Œ put æ“ä½œ// ç¬¬äº”ä¸ªå‚æ•° evict æˆ‘ä»¬è¿™é‡Œä¸å…³å¿ƒfinal V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) &#123; Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i; // ç¬¬ä¸€æ¬¡ put å€¼çš„æ—¶å€™ï¼Œä¼šè§¦å‘ä¸‹é¢çš„ resize()ï¼Œç±»ä¼¼ java7 çš„ç¬¬ä¸€æ¬¡ put ä¹Ÿè¦åˆå§‹åŒ–æ•°ç»„é•¿åº¦ // ç¬¬ä¸€æ¬¡ resize å’Œåç»­çš„æ‰©å®¹æœ‰äº›ä¸ä¸€æ ·ï¼Œå› ä¸ºè¿™æ¬¡æ˜¯æ•°ç»„ä» null åˆå§‹åŒ–åˆ°é»˜è®¤çš„ 16 æˆ–è‡ªå®šä¹‰çš„åˆå§‹å®¹é‡ if ((tab = table) == null || (n = tab.length) == 0) n = (tab = resize()).length; // æ‰¾åˆ°å…·ä½“çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¦‚æœæ­¤ä½ç½®æ²¡æœ‰å€¼ï¼Œé‚£ä¹ˆç›´æ¥åˆå§‹åŒ–ä¸€ä¸‹ Node å¹¶æ”¾ç½®åœ¨è¿™ä¸ªä½ç½®å°±å¯ä»¥äº† if ((p = tab[i = (n - 1) &amp; hash]) == null) tab[i] = newNode(hash, key, value, null); else &#123;// æ•°ç»„è¯¥ä½ç½®æœ‰æ•°æ® Node&lt;K,V&gt; e; K k; // é¦–å…ˆï¼Œåˆ¤æ–­è¯¥ä½ç½®çš„ç¬¬ä¸€ä¸ªæ•°æ®å’Œæˆ‘ä»¬è¦æ’å…¥çš„æ•°æ®ï¼Œkey æ˜¯ä¸æ˜¯&quot;ç›¸ç­‰&quot;ï¼Œå¦‚æœæ˜¯ï¼Œå–å‡ºè¿™ä¸ªèŠ‚ç‚¹ if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k)))) e = p; // å¦‚æœè¯¥èŠ‚ç‚¹æ˜¯ä»£è¡¨çº¢é»‘æ ‘çš„èŠ‚ç‚¹ï¼Œè°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•ï¼Œæœ¬æ–‡ä¸å±•å¼€è¯´çº¢é»‘æ ‘ else if (p instanceof TreeNode) e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value); else &#123; // åˆ°è¿™é‡Œï¼Œè¯´æ˜æ•°ç»„è¯¥ä½ç½®ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨ for (int binCount = 0; ; ++binCount) &#123; // æ’å…¥åˆ°é“¾è¡¨çš„æœ€åé¢(Java7 æ˜¯æ’å…¥åˆ°é“¾è¡¨çš„æœ€å‰é¢) if ((e = p.next) == null) &#123; p.next = newNode(hash, key, value, null); // TREEIFY_THRESHOLD ä¸º 8ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæ–°æ’å…¥çš„å€¼æ˜¯é“¾è¡¨ä¸­çš„ç¬¬ 8 ä¸ª // ä¼šè§¦å‘ä¸‹é¢çš„ treeifyBinï¼Œä¹Ÿå°±æ˜¯å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st treeifyBin(tab, hash); break; &#125; // å¦‚æœåœ¨è¯¥é“¾è¡¨ä¸­æ‰¾åˆ°äº†&quot;ç›¸ç­‰&quot;çš„ key(== æˆ– equals) if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) // æ­¤æ—¶ breakï¼Œé‚£ä¹ˆ e ä¸ºé“¾è¡¨ä¸­[ä¸è¦æ’å…¥çš„æ–°å€¼çš„ key &quot;ç›¸ç­‰&quot;]çš„ node break; p = e; &#125; &#125; // e!=null è¯´æ˜å­˜åœ¨æ—§å€¼çš„keyä¸è¦æ’å…¥çš„key&quot;ç›¸ç­‰&quot; // å¯¹äºæˆ‘ä»¬åˆ†æçš„putæ“ä½œï¼Œä¸‹é¢è¿™ä¸ª if å…¶å®å°±æ˜¯è¿›è¡Œ &quot;å€¼è¦†ç›–&quot;ï¼Œç„¶åè¿”å›æ—§å€¼ if (e != null) &#123; V oldValue = e.value; if (!onlyIfAbsent || oldValue == null) e.value = value; afterNodeAccess(e); return oldValue; &#125; &#125; ++modCount; // å¦‚æœ HashMap ç”±äºæ–°æ’å…¥è¿™ä¸ªå€¼å¯¼è‡´ size å·²ç»è¶…è¿‡äº†é˜ˆå€¼ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹ if (++size &gt; threshold) resize(); afterNodeInsertion(evict); return null;&#125; å’Œ Java7 ç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·çš„åœ°æ–¹å°±æ˜¯ï¼ŒJava7 æ˜¯å…ˆæ‰©å®¹åæ’å…¥æ–°å€¼çš„ï¼ŒJava8 å…ˆæ’å€¼å†æ‰©å®¹ï¼Œä¸è¿‡è¿™ä¸ªä¸é‡è¦ã€‚ æ•°ç»„æ‰©å®¹resize() æ–¹æ³•ç”¨äºåˆå§‹åŒ–æ•°ç»„æˆ–æ•°ç»„æ‰©å®¹ï¼Œæ¯æ¬¡æ‰©å®¹åï¼Œå®¹é‡ä¸ºåŸæ¥çš„ 2 å€ï¼Œå¹¶è¿›è¡Œæ•°æ®è¿ç§»ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586final Node&lt;K,V&gt;[] resize() &#123; Node&lt;K,V&gt;[] oldTab = table; int oldCap = (oldTab == null) ? 0 : oldTab.length; int oldThr = threshold; int newCap, newThr = 0; if (oldCap &gt; 0) &#123; // å¯¹åº”æ•°ç»„æ‰©å®¹ if (oldCap &gt;= MAXIMUM_CAPACITY) &#123; threshold = Integer.MAX_VALUE; return oldTab; &#125; // å°†æ•°ç»„å¤§å°æ‰©å¤§ä¸€å€ else if ((newCap = oldCap &lt;&lt; 1) &lt; MAXIMUM_CAPACITY &amp;&amp; oldCap &gt;= DEFAULT_INITIAL_CAPACITY) // å°†é˜ˆå€¼æ‰©å¤§ä¸€å€ newThr = oldThr &lt;&lt; 1; // double threshold &#125; else if (oldThr &gt; 0) // å¯¹åº”ä½¿ç”¨ new HashMap(int initialCapacity) åˆå§‹åŒ–åï¼Œç¬¬ä¸€æ¬¡ put çš„æ—¶å€™ newCap = oldThr; else &#123;// å¯¹åº”ä½¿ç”¨ new HashMap() åˆå§‹åŒ–åï¼Œç¬¬ä¸€æ¬¡ put çš„æ—¶å€™ newCap = DEFAULT_INITIAL_CAPACITY; newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY); &#125; if (newThr == 0) &#123; float ft = (float)newCap * loadFactor; newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (float)MAXIMUM_CAPACITY ? (int)ft : Integer.MAX_VALUE); &#125; threshold = newThr; // ç”¨æ–°çš„æ•°ç»„å¤§å°åˆå§‹åŒ–æ–°çš„æ•°ç»„ Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])new Node[newCap]; table = newTab; // å¦‚æœæ˜¯åˆå§‹åŒ–æ•°ç»„ï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œè¿”å› newTab å³å¯ if (oldTab != null) &#123; // å¼€å§‹éå†åŸæ•°ç»„ï¼Œè¿›è¡Œæ•°æ®è¿ç§»ã€‚ for (int j = 0; j &lt; oldCap; ++j) &#123; Node&lt;K,V&gt; e; if ((e = oldTab[j]) != null) &#123; oldTab[j] = null; // å¦‚æœè¯¥æ•°ç»„ä½ç½®ä¸Šåªæœ‰å•ä¸ªå…ƒç´ ï¼Œé‚£å°±ç®€å•äº†ï¼Œç®€å•è¿ç§»è¿™ä¸ªå…ƒç´ å°±å¯ä»¥äº† if (e.next == null) newTab[e.hash &amp; (newCap - 1)] = e; // å¦‚æœæ˜¯çº¢é»‘æ ‘ï¼Œå…·ä½“æˆ‘ä»¬å°±ä¸å±•å¼€äº† else if (e instanceof TreeNode) ((TreeNode&lt;K,V&gt;)e).split(this, newTab, j, oldCap); else &#123; // è¿™å—æ˜¯å¤„ç†é“¾è¡¨çš„æƒ…å†µï¼Œ // éœ€è¦å°†æ­¤é“¾è¡¨æ‹†æˆä¸¤ä¸ªé“¾è¡¨ï¼Œæ”¾åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œå¹¶ä¸”ä¿ç•™åŸæ¥çš„å…ˆåé¡ºåº // loHeadã€loTail å¯¹åº”ä¸€æ¡é“¾è¡¨ï¼ŒhiHeadã€hiTail å¯¹åº”å¦ä¸€æ¡é“¾è¡¨ï¼Œä»£ç è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ Node&lt;K,V&gt; loHead = null, loTail = null; Node&lt;K,V&gt; hiHead = null, hiTail = null; Node&lt;K,V&gt; next; do &#123; next = e.next; if ((e.hash &amp; oldCap) == 0) &#123; if (loTail == null) loHead = e; else loTail.next = e; loTail = e; &#125; else &#123; if (hiTail == null) hiHead = e; else hiTail.next = e; hiTail = e; &#125; &#125; while ((e = next) != null); if (loTail != null) &#123; loTail.next = null; // ç¬¬ä¸€æ¡é“¾è¡¨ newTab[j] = loHead; &#125; if (hiTail != null) &#123; hiTail.next = null; // ç¬¬äºŒæ¡é“¾è¡¨çš„æ–°çš„ä½ç½®æ˜¯ j + oldCapï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ newTab[j + oldCap] = hiHead; &#125; &#125; &#125; &#125; &#125; return newTab;&#125; get è¿‡ç¨‹åˆ†æç›¸å¯¹äº put æ¥è¯´ï¼Œget çœŸçš„å¤ªç®€å•äº†ã€‚ è®¡ç®— key çš„ hash å€¼ï¼Œæ ¹æ® hash å€¼æ‰¾åˆ°å¯¹åº”æ•°ç»„ä¸‹æ ‡: hash &amp; (length-1) åˆ¤æ–­æ•°ç»„è¯¥ä½ç½®å¤„çš„å…ƒç´ æ˜¯å¦åˆšå¥½å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œèµ°ç¬¬ä¸‰æ­¥ åˆ¤æ–­è¯¥å…ƒç´ ç±»å‹æ˜¯å¦æ˜¯ TreeNodeï¼Œå¦‚æœæ˜¯ï¼Œç”¨çº¢é»‘æ ‘çš„æ–¹æ³•å–æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œèµ°ç¬¬å››æ­¥ éå†é“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸ç­‰(&#x3D;&#x3D;æˆ–equals)çš„ key 123456789101112131415161718192021222324252627public V get(Object key) &#123; Node&lt;K,V&gt; e; return (e = getNode(hash(key), key)) == null ? null : e.value;&#125;final Node&lt;K,V&gt; getNode(int hash, Object key) &#123; Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; int n; K k; if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (first = tab[(n - 1) &amp; hash]) != null) &#123; // åˆ¤æ–­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯å°±æ˜¯éœ€è¦çš„ if (first.hash == hash &amp;&amp; // always check first node ((k = first.key) == key || (key != null &amp;&amp; key.equals(k)))) return first; if ((e = first.next) != null) &#123; // åˆ¤æ–­æ˜¯å¦æ˜¯çº¢é»‘æ ‘ if (first instanceof TreeNode) return ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key); // é“¾è¡¨éå† do &#123; if (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != null &amp;&amp; key.equals(k)))) return e; &#125; while ((e = e.next) != null); &#125; &#125; return null;&#125; HashSetå‰é¢å·²ç»è¯´è¿‡HashSetæ˜¯å¯¹HashMapçš„ç®€å•åŒ…è£…ï¼Œå¯¹HashSetçš„å‡½æ•°è°ƒç”¨éƒ½ä¼šè½¬æ¢æˆåˆé€‚çš„HashMapæ–¹æ³•ï¼Œå› æ­¤HashSetçš„å®ç°éå¸¸ç®€å•ï¼Œåªæœ‰ä¸åˆ°300è¡Œä»£ç ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚ 12345678910111213141516//HashSetæ˜¯å¯¹HashMapçš„ç®€å•åŒ…è£…public class HashSet&lt;E&gt;&#123;\t......\tprivate transient HashMap&lt;E,Object&gt; map;//HashSeté‡Œé¢æœ‰ä¸€ä¸ªHashMap // Dummy value to associate with an Object in the backing Map private static final Object PRESENT = new Object(); public HashSet() &#123; map = new HashMap&lt;&gt;(); &#125; ...... public boolean add(E e) &#123;//ç®€å•çš„æ–¹æ³•è½¬æ¢ return map.put(e, PRESENT)==null; &#125; ......&#125;","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"5.Collection - PriorityQueueæºç è§£æ","path":"/2023/12/25/5-Collection-PriorityQueueæºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Collection - PriorityQueueè¿›è¡Œæºç è§£æã€‚ æ¦‚è¿°å‰é¢ä»¥Java ArrayDequeä¸ºä¾‹è®²è§£äº†Stackå’ŒQueueï¼Œå…¶å®è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—å«åšPriorityQueueï¼Œå³ä¼˜å…ˆé˜Ÿåˆ—ã€‚ä¼˜å…ˆé˜Ÿåˆ—çš„ä½œç”¨æ˜¯èƒ½ä¿è¯æ¯æ¬¡å–å‡ºçš„å…ƒç´ éƒ½æ˜¯é˜Ÿåˆ—ä¸­æƒå€¼æœ€å°çš„(Javaçš„ä¼˜å…ˆé˜Ÿåˆ—æ¯æ¬¡å–æœ€å°å…ƒç´ ï¼ŒC++çš„ä¼˜å…ˆé˜Ÿåˆ—æ¯æ¬¡å–æœ€å¤§å…ƒç´ )ã€‚è¿™é‡Œç‰µæ¶‰åˆ°äº†å¤§å°å…³ç³»ï¼Œå…ƒç´ å¤§å°çš„è¯„åˆ¤å¯ä»¥é€šè¿‡å…ƒç´ æœ¬èº«çš„è‡ªç„¶é¡ºåº(*natural ordering*)ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ—¶ä¼ å…¥çš„æ¯”è¾ƒå™¨(Comparatorï¼Œç±»ä¼¼äºC++çš„ä»¿å‡½æ•°)ã€‚ Javaä¸­PriorityQueueå®ç°äº†Queueæ¥å£ï¼Œä¸å…è®¸æ”¾å…¥nullå…ƒç´ ï¼›å…¶é€šè¿‡å †å®ç°ï¼Œå…·ä½“è¯´æ˜¯é€šè¿‡å®Œå…¨äºŒå‰æ ‘(complete binary tree)å®ç°çš„å°é¡¶å †(ä»»æ„ä¸€ä¸ªéå¶å­èŠ‚ç‚¹çš„æƒå€¼ï¼Œéƒ½ä¸å¤§äºå…¶å·¦å³å­èŠ‚ç‚¹çš„æƒå€¼)ï¼Œä¹Ÿå°±æ„å‘³ç€å¯ä»¥é€šè¿‡æ•°ç»„æ¥ä½œä¸ºPriorityQueueçš„åº•å±‚å®ç°ã€‚ ä¸Šå›¾ä¸­æˆ‘ä»¬ç»™æ¯ä¸ªå…ƒç´ æŒ‰ç…§å±‚åºéå†çš„æ–¹å¼è¿›è¡Œäº†ç¼–å·ï¼Œå¦‚æœä½ è¶³å¤Ÿç»†å¿ƒï¼Œä¼šå‘ç°çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹çš„ç¼–å·æ˜¯æœ‰è”ç³»çš„ï¼Œæ›´ç¡®åˆ‡çš„è¯´çˆ¶å­èŠ‚ç‚¹çš„ç¼–å·ä¹‹é—´æœ‰å¦‚ä¸‹å…³ç³»: 123leftNo = parentNo*2+1rightNo = parentNo*2+2parentNo = (nodeNo-1)/2 é€šè¿‡ä¸Šè¿°ä¸‰ä¸ªå…¬å¼ï¼Œå¯ä»¥è½»æ˜“è®¡ç®—å‡ºæŸä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä»¥åŠå­èŠ‚ç‚¹çš„ä¸‹æ ‡ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥ç”¨æ•°ç»„æ¥å­˜å‚¨å †çš„åŸå› ã€‚ PriorityQueueçš„peek()å’Œelementæ“ä½œæ˜¯å¸¸æ•°æ—¶é—´ï¼Œadd(), offer(), æ— å‚æ•°çš„remove()ä»¥åŠpoll()æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯*log(N)*ã€‚ æ–¹æ³•å‰–æadd()å’Œoffer()add(E e)å’Œoffer(E e)çš„è¯­ä¹‰ç›¸åŒï¼Œéƒ½æ˜¯å‘ä¼˜å…ˆé˜Ÿåˆ—ä¸­æ’å…¥å…ƒç´ ï¼Œåªæ˜¯Queueæ¥å£è§„å®šäºŒè€…å¯¹æ’å…¥å¤±è´¥æ—¶çš„å¤„ç†ä¸åŒï¼Œå‰è€…åœ¨æ’å…¥å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œååˆ™åˆ™ä¼šè¿”å›falseã€‚å¯¹äºPriorityQueueè¿™ä¸¤ä¸ªæ–¹æ³•å…¶å®æ²¡ä»€ä¹ˆå·®åˆ«ã€‚ æ–°åŠ å…¥çš„å…ƒç´ å¯èƒ½ä¼šç ´åå°é¡¶å †çš„æ€§è´¨ï¼Œå› æ­¤éœ€è¦è¿›è¡Œå¿…è¦çš„è°ƒæ•´ã€‚ 123456789101112131415//offer(E e)public boolean offer(E e) &#123; if (e == null)//ä¸å…è®¸æ”¾å…¥nullå…ƒç´  throw new NullPointerException(); modCount++; int i = size; if (i &gt;= queue.length) grow(i + 1);//è‡ªåŠ¨æ‰©å®¹ size = i + 1; if (i == 0)//é˜Ÿåˆ—åŸæ¥ä¸ºç©ºï¼Œè¿™æ˜¯æ’å…¥çš„ç¬¬ä¸€ä¸ªå…ƒç´  queue[0] = e; else siftUp(i, e);//è°ƒæ•´ return true;&#125; ä¸Šè¿°ä»£ç ä¸­ï¼Œæ‰©å®¹å‡½æ•°grow()ç±»ä¼¼äºArrayListé‡Œçš„grow()å‡½æ•°ï¼Œå°±æ˜¯å†ç”³è¯·ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼Œå¹¶å°†åŸæ•°ç»„çš„å…ƒç´ å¤åˆ¶è¿‡å»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯siftUp(int k, E x)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºæ’å…¥å…ƒç´ xå¹¶ç»´æŒå †çš„ç‰¹æ€§ã€‚ 123456789101112//siftUp()private void siftUp(int k, E x) &#123; while (k &gt; 0) &#123; int parent = (k - 1) &gt;&gt;&gt; 1;//parentNo = (nodeNo-1)/2 Object e = queue[parent]; if (comparator.compare(x, (E) e) &gt;= 0)//è°ƒç”¨æ¯”è¾ƒå™¨çš„æ¯”è¾ƒæ–¹æ³• break; queue[k] = e; k = parent; &#125; queue[k] = x;&#125; æ–°åŠ å…¥çš„å…ƒç´ xå¯èƒ½ä¼šç ´åå°é¡¶å †çš„æ€§è´¨ï¼Œå› æ­¤éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚è°ƒæ•´çš„è¿‡ç¨‹ä¸º** : ä»kæŒ‡å®šçš„ä½ç½®å¼€å§‹ï¼Œå°†xé€å±‚ä¸å½“å‰ç‚¹çš„parentè¿›è¡Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼Œç›´åˆ°æ»¡è¶³x &gt;= queue[parent]ä¸ºæ­¢**ã€‚æ³¨æ„è¿™é‡Œçš„æ¯”è¾ƒå¯ä»¥æ˜¯å…ƒç´ çš„è‡ªç„¶é¡ºåºï¼Œä¹Ÿå¯ä»¥æ˜¯ä¾é æ¯”è¾ƒå™¨çš„é¡ºåºã€‚ element()å’Œpeek()element()å’Œpeek()çš„è¯­ä¹‰å®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯è·å–ä½†ä¸åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—ä¸­æƒå€¼æœ€å°çš„é‚£ä¸ªå…ƒç´ ï¼ŒäºŒè€…å”¯ä¸€çš„åŒºåˆ«æ˜¯å½“æ–¹æ³•å¤±è´¥æ—¶å‰è€…æŠ›å‡ºå¼‚å¸¸ï¼Œåè€…è¿”å›nullã€‚æ ¹æ®å°é¡¶å †çš„æ€§è´¨ï¼Œå †é¡¶é‚£ä¸ªå…ƒç´ å°±æ˜¯å…¨å±€æœ€å°çš„é‚£ä¸ªï¼›ç”±äºå †ç”¨æ•°ç»„è¡¨ç¤ºï¼Œæ ¹æ®ä¸‹æ ‡å…³ç³»ï¼Œ0ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ æ—¢æ˜¯å †é¡¶å…ƒç´ ã€‚æ‰€ä»¥ç›´æ¥è¿”å›æ•°ç»„0ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ å³å¯ã€‚ ä»£ç ä¹Ÿå°±éå¸¸ç®€æ´: 123456//peek()public E peek() &#123; if (size == 0) return null; return (E) queue[0];//0ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ å°±æ˜¯æœ€å°çš„é‚£ä¸ª&#125; remove()å’Œpoll()remove()å’Œpoll()æ–¹æ³•çš„è¯­ä¹‰ä¹Ÿå®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯è·å–å¹¶åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼ŒåŒºåˆ«æ˜¯å½“æ–¹æ³•å¤±è´¥æ—¶å‰è€…æŠ›å‡ºå¼‚å¸¸ï¼Œåè€…è¿”å›nullã€‚ç”±äºåˆ é™¤æ“ä½œä¼šæ”¹å˜é˜Ÿåˆ—çš„ç»“æ„ï¼Œä¸ºç»´æŠ¤å°é¡¶å †çš„æ€§è´¨ï¼Œéœ€è¦è¿›è¡Œå¿…è¦çš„è°ƒæ•´ã€‚ 123456789101112public E poll() &#123; if (size == 0) return null; int s = --size; modCount++; E result = (E) queue[0];//0ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ å°±æ˜¯æœ€å°çš„é‚£ä¸ª E x = (E) queue[s]; queue[s] = null; if (s != 0) siftDown(0, x);//è°ƒæ•´ return result;&#125; ä¸Šè¿°ä»£ç é¦–å…ˆè®°å½•0ä¸‹æ ‡å¤„çš„å…ƒç´ ï¼Œå¹¶ç”¨æœ€åä¸€ä¸ªå…ƒç´ æ›¿æ¢0ä¸‹æ ‡ä½ç½®çš„å…ƒç´ ï¼Œä¹‹åè°ƒç”¨siftDown()æ–¹æ³•å¯¹å †è¿›è¡Œè°ƒæ•´ï¼Œæœ€åè¿”å›åŸæ¥0ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ (ä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªå…ƒç´ )ã€‚é‡ç‚¹æ˜¯siftDown(int k, E x)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯ä»kæŒ‡å®šçš„ä½ç½®å¼€å§‹ï¼Œå°†xé€å±‚å‘ä¸‹ä¸å½“å‰ç‚¹çš„å·¦å³å­©å­ä¸­è¾ƒå°çš„é‚£ä¸ªäº¤æ¢ï¼Œç›´åˆ°xå°äºæˆ–ç­‰äºå·¦å³å­©å­ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸ºæ­¢ã€‚ 123456789101112131415161718//siftDown()private void siftDown(int k, E x) &#123; int half = size &gt;&gt;&gt; 1; while (k &lt; half) &#123; //é¦–å…ˆæ‰¾åˆ°å·¦å³å­©å­ä¸­è¾ƒå°çš„é‚£ä¸ªï¼Œè®°å½•åˆ°cé‡Œï¼Œå¹¶ç”¨childè®°å½•å…¶ä¸‹æ ‡ int child = (k &lt;&lt; 1) + 1;//leftNo = parentNo*2+1 Object c = queue[child]; int right = child + 1; if (right &lt; size &amp;&amp; comparator.compare((E) c, (E) queue[right]) &gt; 0) c = queue[child = right]; if (comparator.compare(x, (E) c) &lt;= 0) break; queue[k] = c;//ç„¶åç”¨cå–ä»£åŸæ¥çš„å€¼ k = child; &#125; queue[k] = x;&#125; remove(Object o)remove(Object o)æ–¹æ³•ç”¨äºåˆ é™¤é˜Ÿåˆ—ä¸­è·Ÿoç›¸ç­‰çš„æŸä¸€ä¸ªå…ƒç´ (å¦‚æœæœ‰å¤šä¸ªç›¸ç­‰ï¼Œåªåˆ é™¤ä¸€ä¸ª)ï¼Œè¯¥æ–¹æ³•ä¸æ˜¯Queueæ¥å£å†…çš„æ–¹æ³•ï¼Œè€Œæ˜¯Collectionæ¥å£çš„æ–¹æ³•ã€‚ç”±äºåˆ é™¤æ“ä½œä¼šæ”¹å˜é˜Ÿåˆ—ç»“æ„ï¼Œæ‰€ä»¥è¦è¿›è¡Œè°ƒæ•´ï¼›åˆç”±äºåˆ é™¤å…ƒç´ çš„ä½ç½®å¯èƒ½æ˜¯ä»»æ„çš„ï¼Œæ‰€ä»¥è°ƒæ•´è¿‡ç¨‹æ¯”å…¶å®ƒå‡½æ•°ç¨åŠ ç¹çã€‚å…·ä½“æ¥è¯´ï¼Œremove(Object o)å¯ä»¥åˆ†ä¸º2ç§æƒ…å†µ: 1. åˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ã€‚ç›´æ¥åˆ é™¤å³å¯ï¼Œä¸éœ€è¦è°ƒæ•´ã€‚2. åˆ é™¤çš„ä¸æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä»åˆ é™¤ç‚¹å¼€å§‹ä»¥æœ€åä¸€ä¸ªå…ƒç´ ä¸ºå‚ç…§è°ƒç”¨ä¸€æ¬¡siftDown()å³å¯ã€‚æ­¤å¤„ä¸å†èµ˜è¿°ã€‚ å…·ä½“ä»£ç å¦‚ä¸‹: 1234567891011121314151617//remove(Object o)public boolean remove(Object o) &#123;\t//é€šè¿‡éå†æ•°ç»„çš„æ–¹å¼æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³o.equals(queue[i])å…ƒç´ çš„ä¸‹æ ‡ int i = indexOf(o); if (i == -1) return false; int s = --size; if (s == i) //æƒ…å†µ1 queue[i] = null; else &#123; E moved = (E) queue[s]; queue[s] = null; siftDown(i, moved);//æƒ…å†µ2 ...... &#125; return true;&#125; å‚è€ƒ æ·±å…¥ç†è§£Java PriorityQueue ç»“åˆæºç å¯¹PriorityQueueè¿›è¡Œè®²è§£ http://www.cnblogs.com/CarpenterLee/p/5488070.html","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"4.Collection - Stack & Queue æºç è§£æ","path":"/2023/12/25/4-Collection-Stack-Queue-æºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Collection - Stack &amp; Queueè¿›è¡Œæºç è§£æã€‚ Stack &amp; Queueæ¦‚è¿°Javaé‡Œæœ‰ä¸€ä¸ªå«åšStackçš„ç±»ï¼Œå´æ²¡æœ‰å«åšQueueçš„ç±»(å®ƒæ˜¯ä¸ªæ¥å£åå­—)ã€‚å½“éœ€è¦ä½¿ç”¨æ ˆæ—¶ï¼ŒJavaå·²ä¸æ¨èä½¿ç”¨Stackï¼Œè€Œæ˜¯æ¨èä½¿ç”¨æ›´é«˜æ•ˆçš„ArrayDequeï¼›æ—¢ç„¶Queueåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå½“éœ€è¦ä½¿ç”¨é˜Ÿåˆ—æ—¶ä¹Ÿå°±é¦–é€‰ArrayDequeäº†(æ¬¡é€‰æ˜¯LinkedList)ã€‚ QueueQueueæ¥å£ç»§æ‰¿è‡ªCollectionæ¥å£ï¼Œé™¤äº†æœ€åŸºæœ¬çš„Collectionçš„æ–¹æ³•ä¹‹å¤–ï¼Œå®ƒè¿˜æ”¯æŒé¢å¤–çš„insertion, extractionå’Œinspectionæ“ä½œã€‚è¿™é‡Œæœ‰ä¸¤ç»„æ ¼å¼ï¼Œå…±6ä¸ªæ–¹æ³•ï¼Œä¸€ç»„æ˜¯æŠ›å‡ºå¼‚å¸¸çš„å®ç°ï¼›å¦å¤–ä¸€ç»„æ˜¯è¿”å›å€¼çš„å®ç°(æ²¡æœ‰åˆ™è¿”å›null)ã€‚ Throws exception Returns special value Insert add(e) offer(e) Remove remove() poll() Examine element() peek() DequeDequeæ˜¯â€double ended queueâ€, è¡¨ç¤ºåŒå‘çš„é˜Ÿåˆ—ï¼Œè‹±æ–‡è¯»ä½œâ€deckâ€. Deque ç»§æ‰¿è‡ª Queueæ¥å£ï¼Œé™¤äº†æ”¯æŒQueueçš„æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æ”¯æŒinsert, removeå’Œexamineæ“ä½œï¼Œç”±äºDequeæ˜¯åŒå‘çš„ï¼Œæ‰€ä»¥å¯ä»¥å¯¹é˜Ÿåˆ—çš„å¤´å’Œå°¾éƒ½è¿›è¡Œæ“ä½œï¼Œå®ƒåŒæ—¶ä¹Ÿæ”¯æŒä¸¤ç»„æ ¼å¼ï¼Œä¸€ç»„æ˜¯æŠ›å‡ºå¼‚å¸¸çš„å®ç°ï¼›å¦å¤–ä¸€ç»„æ˜¯è¿”å›å€¼çš„å®ç°(æ²¡æœ‰åˆ™è¿”å›null)ã€‚å…±12ä¸ªæ–¹æ³•å¦‚ä¸‹: First Element - Head Last Element - Tail Throws exception Special value Throws exception Special value Insert addFirst(e) offerFirst(e) addLast(e) offerLast(e) Remove removeFirst() pollFirst() removeLast() pollLast() Examine getFirst() peekFirst() getLast() peekLast() å½“æŠŠDequeå½“åšFIFOçš„queueæ¥ä½¿ç”¨æ—¶ï¼Œå…ƒç´ æ˜¯ä»dequeçš„å°¾éƒ¨æ·»åŠ ï¼Œä»å¤´éƒ¨è¿›è¡Œåˆ é™¤çš„ï¼› æ‰€ä»¥dequeçš„éƒ¨åˆ†æ–¹æ³•æ˜¯å’Œqueueæ˜¯ç­‰åŒçš„ã€‚å…·ä½“å¦‚ä¸‹: Queue Method Equivalent Deque Method add(e) addLast(e) offer(e) offerLast(e) remove() removeFirst() poll() pollFirst() element() getFirst() peek() peekFirst() Dequeçš„å«ä¹‰æ˜¯â€œdouble ended queueâ€ï¼Œå³åŒç«¯é˜Ÿåˆ—ï¼Œå®ƒæ—¢å¯ä»¥å½“ä½œæ ˆä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å½“ä½œé˜Ÿåˆ—ä½¿ç”¨ã€‚ä¸‹è¡¨åˆ—å‡ºäº†Dequeä¸Queueç›¸å¯¹åº”çš„æ¥å£: Queue Method Equivalent Deque Method è¯´æ˜ add(e) addLast(e) å‘é˜Ÿå°¾æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ offer(e) offerLast(e) å‘é˜Ÿå°¾æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›false remove() removeFirst() è·å–å¹¶åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ poll() pollFirst() è·å–å¹¶åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›null element() getFirst() è·å–ä½†ä¸åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ peek() peekFirst() è·å–ä½†ä¸åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›null ä¸‹è¡¨åˆ—å‡ºäº†Dequeä¸Stackå¯¹åº”çš„æ¥å£: Stack Method Equivalent Deque Method è¯´æ˜ push(e) addFirst(e) å‘æ ˆé¡¶æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ æ—  offerFirst(e) å‘æ ˆé¡¶æ’å…¥å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›false pop() removeFirst() è·å–å¹¶åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ æ—  pollFirst() è·å–å¹¶åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›null peek() getFirst() è·å–ä½†ä¸åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ æ—  peekFirst() è·å–ä½†ä¸åˆ é™¤æ ˆé¡¶å…ƒç´ ï¼Œå¤±è´¥åˆ™è¿”å›null ä¸Šé¢ä¸¤ä¸ªè¡¨å…±å®šä¹‰äº†Dequeçš„12ä¸ªæ¥å£ã€‚æ·»åŠ ï¼Œåˆ é™¤ï¼Œå–å€¼éƒ½æœ‰ä¸¤å¥—æ¥å£ï¼Œå®ƒä»¬åŠŸèƒ½ç›¸åŒï¼ŒåŒºåˆ«æ˜¯å¯¹å¤±è´¥æƒ…å†µçš„å¤„ç†ä¸åŒã€‚ä¸€å¥—æ¥å£é‡åˆ°å¤±è´¥å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦ä¸€å¥—é‡åˆ°å¤±è´¥ä¼šè¿”å›ç‰¹æ®Šå€¼(falseæˆ–null)ã€‚é™¤éæŸç§å®ç°å¯¹å®¹é‡æœ‰é™åˆ¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ·»åŠ æ“ä½œæ˜¯ä¸ä¼šå¤±è´¥çš„ã€‚è™½ç„¶*Deque*çš„æ¥å£æœ‰12ä¸ªä¹‹å¤šï¼Œä½†æ— éå°±æ˜¯å¯¹å®¹å™¨çš„ä¸¤ç«¯è¿›è¡Œæ“ä½œï¼Œæˆ–æ·»åŠ ï¼Œæˆ–åˆ é™¤ï¼Œæˆ–æŸ¥çœ‹ã€‚æ˜ç™½äº†è¿™ä¸€ç‚¹è®²è§£èµ·æ¥å°±ä¼šéå¸¸ç®€å•ã€‚ ArrayDequeå’ŒLinkedListæ˜¯Dequeçš„ä¸¤ä¸ªé€šç”¨å®ç°ï¼Œç”±äºå®˜æ–¹æ›´æ¨èä½¿ç”¨AarryDequeç”¨ä½œæ ˆå’Œé˜Ÿåˆ—ï¼ŒåŠ ä¹‹ä¸Šä¸€ç¯‡å·²ç»è®²è§£è¿‡LinkedListï¼Œæœ¬æ–‡å°†ç€é‡è®²è§£ArrayDequeçš„å…·ä½“å®ç°ã€‚ ä»åå­—å¯ä»¥çœ‹å‡ºArrayDequeåº•å±‚é€šè¿‡æ•°ç»„å®ç°ï¼Œä¸ºäº†æ»¡è¶³å¯ä»¥åŒæ—¶åœ¨æ•°ç»„ä¸¤ç«¯æ’å…¥æˆ–åˆ é™¤å…ƒç´ çš„éœ€æ±‚ï¼Œè¯¥æ•°ç»„è¿˜å¿…é¡»æ˜¯å¾ªç¯çš„ï¼Œå³**å¾ªç¯æ•°ç»„(circular array)*ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°ç»„çš„ä»»ä½•ä¸€ç‚¹éƒ½å¯èƒ½è¢«çœ‹ä½œèµ·ç‚¹æˆ–è€…ç»ˆç‚¹ã€‚ArrayDeque*æ˜¯éçº¿ç¨‹å®‰å…¨çš„(not thread-safe)ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨åŒæ­¥ï¼›å¦å¤–ï¼Œè¯¥å®¹å™¨ä¸å…è®¸æ”¾å…¥nullå…ƒç´ ã€‚ ä¸Šå›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œ**headæŒ‡å‘é¦–ç«¯ç¬¬ä¸€ä¸ªæœ‰æ•ˆå…ƒç´ ï¼ŒtailæŒ‡å‘å°¾ç«¯ç¬¬ä¸€ä¸ªå¯ä»¥æ’å…¥å…ƒç´ çš„ç©ºä½**ã€‚å› ä¸ºæ˜¯å¾ªç¯æ•°ç»„ï¼Œæ‰€ä»¥headä¸ä¸€å®šæ€»ç­‰äº0ï¼Œtailä¹Ÿä¸ä¸€å®šæ€»æ˜¯æ¯”headå¤§ã€‚ æ–¹æ³•å‰–æaddFirst()addFirst(E e)çš„ä½œç”¨æ˜¯åœ¨Dequeçš„é¦–ç«¯æ’å…¥å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯åœ¨headçš„å‰é¢æ’å…¥å…ƒç´ ï¼Œåœ¨ç©ºé—´è¶³å¤Ÿä¸”ä¸‹æ ‡æ²¡æœ‰è¶Šç•Œçš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦å°†elements[--head] = eå³å¯ã€‚ å®é™…éœ€è¦è€ƒè™‘: 1.ç©ºé—´æ˜¯å¦å¤Ÿç”¨ï¼Œä»¥åŠ2.ä¸‹æ ‡æ˜¯å¦è¶Šç•Œçš„é—®é¢˜ã€‚ä¸Šå›¾ä¸­ï¼Œå¦‚æœheadä¸º0ä¹‹åæ¥ç€è°ƒç”¨addFirst()ï¼Œè™½ç„¶ç©ºä½™ç©ºé—´è¿˜å¤Ÿç”¨ï¼Œä½†headä¸º-1ï¼Œä¸‹æ ‡è¶Šç•Œäº†ã€‚ä¸‹åˆ—ä»£ç å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸¤ä¸ªé—®é¢˜ã€‚ 12345678//addFirst(E e)public void addFirst(E e) &#123; if (e == null)//ä¸å…è®¸æ”¾å…¥null throw new NullPointerException(); elements[head = (head - 1) &amp; (elements.length - 1)] = e;//2.ä¸‹æ ‡æ˜¯å¦è¶Šç•Œ if (head == tail)//1.ç©ºé—´æ˜¯å¦å¤Ÿç”¨ doubleCapacity();//æ‰©å®¹&#125; ä¸Šè¿°ä»£ç æˆ‘ä»¬çœ‹åˆ°ï¼Œç©ºé—´é—®é¢˜æ˜¯åœ¨æ’å…¥ä¹‹åè§£å†³çš„ï¼Œå› ä¸ºtailæ€»æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå¯æ’å…¥çš„ç©ºä½ï¼Œä¹Ÿå°±æ„å‘³ç€elementsæ•°ç»„è‡³å°‘æœ‰ä¸€ä¸ªç©ºä½ï¼Œæ‰€ä»¥æ’å…¥å…ƒç´ çš„æ—¶å€™ä¸ç”¨è€ƒè™‘ç©ºé—´é—®é¢˜ã€‚ ä¸‹æ ‡è¶Šç•Œçš„å¤„ç†è§£å†³èµ·æ¥éå¸¸ç®€å•ï¼Œhead = (head - 1) &amp; (elements.length - 1)å°±å¯ä»¥äº†ï¼Œè¿™æ®µä»£ç ç›¸å½“äºå–ä½™ï¼ŒåŒæ—¶è§£å†³äº†headä¸ºè´Ÿå€¼çš„æƒ…å†µã€‚å› ä¸ºelements.lengthå¿…éœ€æ˜¯2çš„æŒ‡æ•°å€ï¼Œelements - 1å°±æ˜¯äºŒè¿›åˆ¶ä½ä½å…¨1ï¼Œè·Ÿhead - 1ç›¸ä¸ä¹‹åå°±èµ·åˆ°äº†å–æ¨¡çš„ä½œç”¨ï¼Œå¦‚æœhead - 1ä¸ºè´Ÿæ•°(å…¶å®åªå¯èƒ½æ˜¯-1)ï¼Œåˆ™ç›¸å½“äºå¯¹å…¶å–ç›¸å¯¹äºelements.lengthçš„è¡¥ç ã€‚ ä¸‹é¢å†è¯´è¯´æ‰©å®¹å‡½æ•°doubleCapacity()ï¼Œå…¶é€»è¾‘æ˜¯ç”³è¯·ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„(åŸæ•°ç»„çš„ä¸¤å€)ï¼Œç„¶åå°†åŸæ•°ç»„å¤åˆ¶è¿‡å»ã€‚è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º: å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œå¤åˆ¶åˆ†ä¸¤æ¬¡è¿›è¡Œï¼Œç¬¬ä¸€æ¬¡å¤åˆ¶headå³è¾¹çš„å…ƒç´ ï¼Œç¬¬äºŒæ¬¡å¤åˆ¶headå·¦è¾¹çš„å…ƒç´ ã€‚ 12345678910111213141516//doubleCapacity()private void doubleCapacity() &#123; assert head == tail; int p = head; int n = elements.length; int r = n - p; // headå³è¾¹å…ƒç´ çš„ä¸ªæ•° int newCapacity = n &lt;&lt; 1;//åŸç©ºé—´çš„2å€ if (newCapacity &lt; 0) throw new IllegalStateException(&quot;Sorry, deque too big&quot;); Object[] a = new Object[newCapacity]; System.arraycopy(elements, p, a, 0, r);//å¤åˆ¶å³åŠéƒ¨åˆ†ï¼Œå¯¹åº”ä¸Šå›¾ä¸­ç»¿è‰²éƒ¨åˆ† System.arraycopy(elements, 0, a, r, p);//å¤åˆ¶å·¦åŠéƒ¨åˆ†ï¼Œå¯¹åº”ä¸Šå›¾ä¸­ç°è‰²éƒ¨åˆ† elements = (E[])a; head = 0; tail = n;&#125; addLast()addLast(E e)çš„ä½œç”¨æ˜¯åœ¨Dequeçš„å°¾ç«¯æ’å…¥å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯åœ¨tailçš„ä½ç½®æ’å…¥å…ƒç´ ï¼Œç”±äºtailæ€»æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ä»¥æ’å…¥çš„ç©ºä½ï¼Œå› æ­¤åªéœ€è¦elements[tail] = e;å³å¯ã€‚æ’å…¥å®Œæˆåå†æ£€æŸ¥ç©ºé—´ï¼Œå¦‚æœç©ºé—´å·²ç»ç”¨å…‰ï¼Œåˆ™è°ƒç”¨doubleCapacity()è¿›è¡Œæ‰©å®¹ã€‚ 1234567public void addLast(E e) &#123; if (e == null)//ä¸å…è®¸æ”¾å…¥null throw new NullPointerException(); elements[tail] = e;//èµ‹å€¼ if ( (tail = (tail + 1) &amp; (elements.length - 1)) == head)//ä¸‹æ ‡è¶Šç•Œå¤„ç† doubleCapacity();//æ‰©å®¹&#125; ä¸‹æ ‡è¶Šç•Œå¤„ç†æ–¹å¼addFirt()ä¸­å·²ç»è®²è¿‡ï¼Œä¸å†èµ˜è¿°ã€‚ pollFirst()pollFirst()çš„ä½œç”¨æ˜¯åˆ é™¤å¹¶è¿”å›Dequeé¦–ç«¯å…ƒç´ ï¼Œä¹Ÿå³æ˜¯headä½ç½®å¤„çš„å…ƒç´ ã€‚å¦‚æœå®¹å™¨ä¸ç©ºï¼Œåªéœ€è¦ç›´æ¥è¿”å›elements[head]å³å¯ï¼Œå½“ç„¶è¿˜éœ€è¦å¤„ç†ä¸‹æ ‡çš„é—®é¢˜ã€‚ç”±äºArrayDequeä¸­ä¸å…è®¸æ”¾å…¥nullï¼Œå½“elements[head] == nullæ—¶ï¼Œæ„å‘³ç€å®¹å™¨ä¸ºç©ºã€‚ 123456789public E pollFirst() &#123; int h = head; E result = elements[head]; if (result == null)//nullå€¼æ„å‘³ç€dequeä¸ºç©º return null; elements[h] = null;//let GC work head = (head + 1) &amp; (elements.length - 1);//ä¸‹æ ‡è¶Šç•Œå¤„ç† return result;&#125; pollLast()pollLast()çš„ä½œç”¨æ˜¯åˆ é™¤å¹¶è¿”å›Dequeå°¾ç«¯å…ƒç´ ï¼Œä¹Ÿå³æ˜¯tailä½ç½®å‰é¢çš„é‚£ä¸ªå…ƒç´ ã€‚ 123456789public E pollLast() &#123; int t = (tail - 1) &amp; (elements.length - 1);//tailçš„ä¸Šä¸€ä¸ªä½ç½®æ˜¯æœ€åä¸€ä¸ªå…ƒç´  E result = elements[t]; if (result == null)//nullå€¼æ„å‘³ç€dequeä¸ºç©º return null; elements[t] = null;//let GC work tail = t; return result;&#125; peekFirst()peekFirst()çš„ä½œç”¨æ˜¯è¿”å›ä½†ä¸åˆ é™¤Dequeé¦–ç«¯å…ƒç´ ï¼Œä¹Ÿå³æ˜¯headä½ç½®å¤„çš„å…ƒç´ ï¼Œç›´æ¥è¿”å›elements[head]å³å¯ã€‚ 123public E peekFirst() &#123; return elements[head]; // elements[head] is null if deque empty&#125; peekLast()peekLast()çš„ä½œç”¨æ˜¯è¿”å›ä½†ä¸åˆ é™¤Dequeå°¾ç«¯å…ƒç´ ï¼Œä¹Ÿå³æ˜¯tailä½ç½®å‰é¢çš„é‚£ä¸ªå…ƒç´ ã€‚ 123public E peekLast() &#123; return elements[(tail - 1) &amp; (elements.length - 1)];&#125;","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"3.Collection - LinkedListæºç è§£æ","path":"/2023/12/25/3-Collection-LinkedListæºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Collection - LinkedListè¿›è¡Œæºç è§£æã€‚ æ¦‚è¿°LinkedListåŒæ—¶å®ç°äº†Listæ¥å£å’ŒDequeæ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ—¢å¯ä»¥çœ‹ä½œä¸€ä¸ªé¡ºåºå®¹å™¨ï¼Œåˆå¯ä»¥çœ‹ä½œä¸€ä¸ªé˜Ÿåˆ—(Queue)ï¼ŒåŒæ—¶åˆå¯ä»¥çœ‹ä½œä¸€ä¸ªæ ˆ(Stack)ã€‚è¿™æ ·çœ‹æ¥ï¼ŒLinkedListç®€ç›´å°±æ˜¯ä¸ªå…¨èƒ½å† å†›ã€‚å½“ä½ éœ€è¦ä½¿ç”¨æ ˆæˆ–è€…é˜Ÿåˆ—æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨LinkedListï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºJavaå®˜æ–¹å·²ç»å£°æ˜ä¸å»ºè®®ä½¿ç”¨Stackç±»ï¼Œæ›´é—æ†¾çš„æ˜¯ï¼ŒJavaé‡Œæ ¹æœ¬æ²¡æœ‰ä¸€ä¸ªå«åšQueueçš„ç±»(å®ƒæ˜¯ä¸ªæ¥å£åå­—)ã€‚å…³äºæ ˆæˆ–é˜Ÿåˆ—ï¼Œç°åœ¨çš„é¦–é€‰æ˜¯ArrayDequeï¼Œå®ƒæœ‰ç€æ¯”LinkedList(å½“ä½œæ ˆæˆ–é˜Ÿåˆ—ä½¿ç”¨æ—¶)æœ‰ç€æ›´å¥½çš„æ€§èƒ½ã€‚ LinkedListçš„å®ç°æ–¹å¼å†³å®šäº†æ‰€æœ‰è·Ÿä¸‹æ ‡ç›¸å…³çš„æ“ä½œéƒ½æ˜¯çº¿æ€§æ—¶é—´ï¼Œè€Œåœ¨é¦–æ®µæˆ–è€…æœ«å°¾åˆ é™¤å…ƒç´ åªéœ€è¦å¸¸æ•°æ—¶é—´ã€‚ä¸ºè¿½æ±‚æ•ˆç‡LinkedListæ²¡æœ‰å®ç°åŒæ­¥(synchronized)ï¼Œå¦‚æœéœ€è¦å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œå¯ä»¥å…ˆé‡‡ç”¨Collections.synchronizedList()æ–¹æ³•å¯¹å…¶è¿›è¡ŒåŒ…è£…ã€‚ LinkedListå®ç°åº•å±‚æ•°æ®ç»“æ„LinkedListåº•å±‚é€šè¿‡åŒå‘é“¾è¡¨å®ç°ï¼Œæœ¬èŠ‚å°†ç€é‡è®²è§£æ’å…¥å’Œåˆ é™¤å…ƒç´ æ—¶åŒå‘é“¾è¡¨çš„ç»´æŠ¤è¿‡ç¨‹ï¼Œä¹Ÿå³æ˜¯ä¹‹é—´è§£è·ŸListæ¥å£ç›¸å…³çš„å‡½æ•°ï¼Œè€Œå°†Queueå’ŒStackä»¥åŠDequeç›¸å…³çš„çŸ¥è¯†æ”¾åœ¨ä¸‹ä¸€èŠ‚è®²ã€‚åŒå‘é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹ç”¨å†…éƒ¨ç±»Nodeè¡¨ç¤ºã€‚LinkedListé€šè¿‡firstå’Œlastå¼•ç”¨åˆ†åˆ«æŒ‡å‘é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ ã€‚æ³¨æ„è¿™é‡Œæ²¡æœ‰æ‰€è°“çš„å“‘å…ƒï¼Œå½“é“¾è¡¨ä¸ºç©ºçš„æ—¶å€™firstå’Œlastéƒ½æŒ‡å‘nullã€‚ 123456789101112131415transient int size = 0;/** * Pointer to first node. * Invariant: (first == null &amp;&amp; last == null) || * (first.prev == null &amp;&amp; first.item != null) */transient Node&lt;E&gt; first;/** * Pointer to last node. * Invariant: (first == null &amp;&amp; last == null) || * (last.next == null &amp;&amp; last.item != null) */transient Node&lt;E&gt; last; å…¶ä¸­Nodeæ˜¯ç§æœ‰çš„å†…éƒ¨ç±»: 1234567891011private static class Node&lt;E&gt; &#123; E item; Node&lt;E&gt; next; Node&lt;E&gt; prev; Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123; this.item = element; this.next = next; this.prev = prev; &#125;&#125; æ„é€ å‡½æ•°123456789101112131415161718/** * Constructs an empty list. */public LinkedList() &#123;&#125;/** * Constructs a list containing the elements of the specified * collection, in the order they are returned by the collection&#x27;s * iterator. * * @param c the collection whose elements are to be placed into this list * @throws NullPointerException if the specified collection is null */public LinkedList(Collection&lt;? extends E&gt; c) &#123; this(); addAll(c);&#125; getFirst(), getLast()è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ å’Œè·å–æœ€åä¸€ä¸ªå…ƒç´ : 12345678910111213141516171819202122232425/** * Returns the first element in this list. * * @return the first element in this list * @throws NoSuchElementException if this list is empty */public E getFirst() &#123; final Node&lt;E&gt; f = first; if (f == null) throw new NoSuchElementException(); return f.item;&#125;/** * Returns the last element in this list. * * @return the last element in this list * @throws NoSuchElementException if this list is empty */public E getLast() &#123; final Node&lt;E&gt; l = last; if (l == null) throw new NoSuchElementException(); return l.item;&#125; removeFirst(), removeLast(), remove(e), remove(index)remove()æ–¹æ³•ä¹Ÿæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯åˆ é™¤è·ŸæŒ‡å®šå…ƒç´ ç›¸ç­‰çš„ç¬¬ä¸€ä¸ªå…ƒç´ remove(Object o)ï¼Œå¦ä¸€ä¸ªæ˜¯åˆ é™¤æŒ‡å®šä¸‹æ ‡å¤„çš„å…ƒç´ remove(int index)ã€‚ åˆ é™¤å…ƒç´  - æŒ‡çš„æ˜¯åˆ é™¤ç¬¬ä¸€æ¬¡å‡ºç°çš„è¿™ä¸ªå…ƒç´ , å¦‚æœæ²¡æœ‰è¿™ä¸ªå…ƒç´ ï¼Œåˆ™è¿”å›falseï¼›åˆ¤æ–­çš„ä¾æ®æ˜¯equalsæ–¹æ³•ï¼Œ å¦‚æœequalsï¼Œåˆ™ç›´æ¥unlinkè¿™ä¸ªnodeï¼›ç”±äºLinkedListå¯å­˜æ”¾nullå…ƒç´ ï¼Œæ•…ä¹Ÿå¯ä»¥åˆ é™¤ç¬¬ä¸€æ¬¡å‡ºç°nullçš„å…ƒç´ ï¼› 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960/** * Removes the first occurrence of the specified element from this list, * if it is present. If this list does not contain the element, it is * unchanged. More formally, removes the element with the lowest index * &#123;@code i&#125; such that * &lt;tt&gt;(o==null&amp;nbsp;?&amp;nbsp;get(i)==null&amp;nbsp;:&amp;nbsp;o.equals(get(i)))&lt;/tt&gt; * (if such an element exists). Returns &#123;@code true&#125; if this list * contained the specified element (or equivalently, if this list * changed as a result of the call). * * @param o element to be removed from this list, if present * @return &#123;@code true&#125; if this list contained the specified element */public boolean remove(Object o) &#123; if (o == null) &#123; for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (x.item == null) &#123; unlink(x); return true; &#125; &#125; &#125; else &#123; for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (o.equals(x.item)) &#123; unlink(x); return true; &#125; &#125; &#125; return false;&#125;/** * Unlinks non-null node x. */E unlink(Node&lt;E&gt; x) &#123; // assert x != null; final E element = x.item; final Node&lt;E&gt; next = x.next; final Node&lt;E&gt; prev = x.prev; if (prev == null) &#123;// ç¬¬ä¸€ä¸ªå…ƒç´  first = next; &#125; else &#123; prev.next = next; x.prev = null; &#125; if (next == null) &#123;// æœ€åä¸€ä¸ªå…ƒç´  last = prev; &#125; else &#123; next.prev = prev; x.next = null; &#125; x.item = null; // GC size--; modCount++; return element;&#125; remove(int index)ä½¿ç”¨çš„æ˜¯ä¸‹æ ‡è®¡æ•°ï¼Œ åªéœ€è¦åˆ¤æ–­è¯¥indexæ˜¯å¦æœ‰å…ƒç´ å³å¯ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥unlinkè¿™ä¸ªnodeã€‚ 12345678910111213/** * Removes the element at the specified position in this list. Shifts any * subsequent elements to the left (subtracts one from their indices). * Returns the element that was removed from the list. * * @param index the index of the element to be removed * @return the element previously at the specified position * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public E remove(int index) &#123; checkElementIndex(index); return unlink(node(index));&#125; åˆ é™¤headå…ƒç´ : 1234567891011121314151617181920212223242526272829303132/** * Removes and returns the first element from this list. * * @return the first element from this list * @throws NoSuchElementException if this list is empty */public E removeFirst() &#123; final Node&lt;E&gt; f = first; if (f == null) throw new NoSuchElementException(); return unlinkFirst(f);&#125;/** * Unlinks non-null first node f. */private E unlinkFirst(Node&lt;E&gt; f) &#123; // assert f == first &amp;&amp; f != null; final E element = f.item; final Node&lt;E&gt; next = f.next; f.item = null; f.next = null; // help GC first = next; if (next == null) last = null; else next.prev = null; size--; modCount++; return element;&#125; åˆ é™¤lastå…ƒç´ : 12345678910111213141516171819202122232425262728293031/** * Removes and returns the last element from this list. * * @return the last element from this list * @throws NoSuchElementException if this list is empty */ public E removeLast() &#123; final Node&lt;E&gt; l = last; if (l == null) throw new NoSuchElementException(); return unlinkLast(l); &#125; /** * Unlinks non-null last node l. */ private E unlinkLast(Node&lt;E&gt; l) &#123; // assert l == last &amp;&amp; l != null; final E element = l.item; final Node&lt;E&gt; prev = l.prev; l.item = null; l.prev = null; // help GC last = prev; if (prev == null) first = null; else prev.next = null; size--; modCount++; return element; &#125; add()add()*æ–¹æ³•æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯add(E e)ï¼Œè¯¥æ–¹æ³•åœ¨*LinkedListçš„æœ«å°¾æ’å…¥å…ƒç´ ï¼Œå› ä¸ºæœ‰lastæŒ‡å‘é“¾è¡¨æœ«å°¾ï¼Œåœ¨æœ«å°¾æ’å…¥å…ƒç´ çš„èŠ±è´¹æ˜¯å¸¸æ•°æ—¶é—´ã€‚åªéœ€è¦ç®€å•ä¿®æ”¹å‡ ä¸ªç›¸å…³å¼•ç”¨å³å¯ï¼›å¦ä¸€ä¸ªæ˜¯add(int index, E element)ï¼Œè¯¥æ–¹æ³•æ˜¯åœ¨æŒ‡å®šä¸‹è¡¨å¤„æ’å…¥å…ƒç´ ï¼Œéœ€è¦å…ˆé€šè¿‡çº¿æ€§æŸ¥æ‰¾æ‰¾åˆ°å…·ä½“ä½ç½®ï¼Œç„¶åä¿®æ”¹ç›¸å…³å¼•ç”¨å®Œæˆæ’å…¥æ“ä½œã€‚ 123456789101112131415161718192021222324252627/** * Appends the specified element to the end of this list. * * &lt;p&gt;This method is equivalent to &#123;@link #addLast&#125;. * * @param e element to be appended to this list * @return &#123;@code true&#125; (as specified by &#123;@link Collection#add&#125;) */public boolean add(E e) &#123; linkLast(e); return true;&#125;/** * Links e as last element. */void linkLast(E e) &#123; final Node&lt;E&gt; l = last; final Node&lt;E&gt; newNode = new Node&lt;&gt;(l, e, null); last = newNode; if (l == null) first = newNode; else l.next = newNode; size++; modCount++;&#125; add(int index, E element), å½“index&#x3D;&#x3D;sizeæ—¶ï¼Œç­‰åŒäºadd(E e); å¦‚æœä¸æ˜¯ï¼Œåˆ™åˆ†ä¸¤æ­¥: 1.å…ˆæ ¹æ®indexæ‰¾åˆ°è¦æ’å…¥çš„ä½ç½®,å³node(index)æ–¹æ³•ï¼›2.ä¿®æ”¹å¼•ç”¨ï¼Œå®Œæˆæ’å…¥æ“ä½œã€‚ 1234567891011121314151617/** * Inserts the specified element at the specified position in this list. * Shifts the element currently at that position (if any) and any * subsequent elements to the right (adds one to their indices). * * @param index index at which the specified element is to be inserted * @param element element to be inserted * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public void add(int index, E element) &#123; checkPositionIndex(index); if (index == size) linkLast(element); else linkBefore(element, node(index));&#125; ä¸Šé¢ä»£ç ä¸­çš„node(int index)å‡½æ•°æœ‰ä¸€ç‚¹å°å°çš„trickï¼Œå› ä¸ºé“¾è¡¨åŒå‘çš„ï¼Œå¯ä»¥ä»å¼€å§‹å¾€åæ‰¾ï¼Œä¹Ÿå¯ä»¥ä»ç»“å°¾å¾€å‰æ‰¾ï¼Œå…·ä½“æœé‚£ä¸ªæ–¹å‘æ‰¾å–å†³äºæ¡ä»¶index &lt; (size &gt;&gt; 1)ï¼Œä¹Ÿå³æ˜¯indexæ˜¯é è¿‘å‰ç«¯è¿˜æ˜¯åç«¯ã€‚ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒlinkedListé€šè¿‡indexæ£€ç´¢å…ƒç´ çš„æ•ˆç‡æ²¡æœ‰arrayListé«˜ã€‚ 123456789101112131415161718/** * Returns the (non-null) Node at the specified element index. */Node&lt;E&gt; node(int index) &#123; // assert isElementIndex(index); if (index &lt; (size &gt;&gt; 1)) &#123; Node&lt;E&gt; x = first; for (int i = 0; i &lt; index; i++) x = x.next; return x; &#125; else &#123; Node&lt;E&gt; x = last; for (int i = size - 1; i &gt; index; i--) x = x.prev; return x; &#125;&#125; addAll()addAll(index, c) å®ç°æ–¹å¼å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨add(index,e)æ¥å®ç°ï¼Œä¸»è¦æ˜¯å› ä¸ºæ•ˆç‡çš„é—®é¢˜ï¼Œå¦ä¸€ä¸ªæ˜¯fail-fastä¸­modCountåªä¼šå¢åŠ 1æ¬¡ï¼› 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869/** * Appends all of the elements in the specified collection to the end of * this list, in the order that they are returned by the specified * collection&#x27;s iterator. The behavior of this operation is undefined if * the specified collection is modified while the operation is in * progress. (Note that this will occur if the specified collection is * this list, and it&#x27;s nonempty.) * * @param c collection containing elements to be added to this list * @return &#123;@code true&#125; if this list changed as a result of the call * @throws NullPointerException if the specified collection is null */public boolean addAll(Collection&lt;? extends E&gt; c) &#123; return addAll(size, c);&#125;/** * Inserts all of the elements in the specified collection into this * list, starting at the specified position. Shifts the element * currently at that position (if any) and any subsequent elements to * the right (increases their indices). The new elements will appear * in the list in the order that they are returned by the * specified collection&#x27;s iterator. * * @param index index at which to insert the first element * from the specified collection * @param c collection containing elements to be added to this list * @return &#123;@code true&#125; if this list changed as a result of the call * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; * @throws NullPointerException if the specified collection is null */public boolean addAll(int index, Collection&lt;? extends E&gt; c) &#123; checkPositionIndex(index); Object[] a = c.toArray(); int numNew = a.length; if (numNew == 0) return false; Node&lt;E&gt; pred, succ; if (index == size) &#123; succ = null; pred = last; &#125; else &#123; succ = node(index); pred = succ.prev; &#125; for (Object o : a) &#123; @SuppressWarnings(&quot;unchecked&quot;) E e = (E) o; Node&lt;E&gt; newNode = new Node&lt;&gt;(pred, e, null); if (pred == null) first = newNode; else pred.next = newNode; pred = newNode; &#125; if (succ == null) &#123; last = pred; &#125; else &#123; pred.next = succ; succ.prev = pred; &#125; size += numNew; modCount++; return true;&#125; clear()ä¸ºäº†è®©GCæ›´å¿«å¯ä»¥å›æ”¶æ”¾ç½®çš„å…ƒç´ ï¼Œéœ€è¦å°†nodeä¹‹é—´çš„å¼•ç”¨å…³ç³»èµ‹ç©ºã€‚ 1234567891011121314151617181920/** * Removes all of the elements from this list. * The list will be empty after this call returns. */public void clear() &#123; // Clearing all of the links between nodes is &quot;unnecessary&quot;, but: // - helps a generational GC if the discarded nodes inhabit // more than one generation // - is sure to free memory even if there is a reachable Iterator for (Node&lt;E&gt; x = first; x != null; ) &#123; Node&lt;E&gt; next = x.next; x.item = null; x.next = null; x.prev = null; x = next; &#125; first = last = null; size = 0; modCount++;&#125; Positional Access æ–¹æ³•é€šè¿‡indexè·å–å…ƒç´  1234567891011/** * Returns the element at the specified position in this list. * * @param index index of the element to return * @return the element at the specified position in this list * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public E get(int index) &#123; checkElementIndex(index); return node(index).item;&#125; å°†æŸä¸ªä½ç½®çš„å…ƒç´ é‡æ–°èµ‹å€¼: 12345678910111213141516/** * Replaces the element at the specified position in this list with the * specified element. * * @param index index of the element to replace * @param element element to be stored at the specified position * @return the element previously at the specified position * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public E set(int index, E element) &#123; checkElementIndex(index); Node&lt;E&gt; x = node(index); E oldVal = x.item; x.item = element; return oldVal;&#125; å°†å…ƒç´ æ’å…¥åˆ°æŒ‡å®šindexä½ç½®: 1234567891011121314151617/** * Inserts the specified element at the specified position in this list. * Shifts the element currently at that position (if any) and any * subsequent elements to the right (adds one to their indices). * * @param index index at which the specified element is to be inserted * @param element element to be inserted * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public void add(int index, E element) &#123; checkPositionIndex(index); if (index == size) linkLast(element); else linkBefore(element, node(index));&#125; åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ : 12345678910111213/** * Removes the element at the specified position in this list. Shifts any * subsequent elements to the left (subtracts one from their indices). * Returns the element that was removed from the list. * * @param index the index of the element to be removed * @return the element previously at the specified position * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public E remove(int index) &#123; checkElementIndex(index); return unlink(node(index));&#125; å…¶å®ƒä½ç½®çš„æ–¹æ³•: 123456789101112131415161718192021222324252627282930313233/** * Tells if the argument is the index of an existing element. */private boolean isElementIndex(int index) &#123; return index &gt;= 0 &amp;&amp; index &lt; size;&#125;/** * Tells if the argument is the index of a valid position for an * iterator or an add operation. */private boolean isPositionIndex(int index) &#123; return index &gt;= 0 &amp;&amp; index &lt;= size;&#125;/** * Constructs an IndexOutOfBoundsException detail message. * Of the many possible refactorings of the error handling code, * this &quot;outlining&quot; performs best with both server and client VMs. */private String outOfBoundsMsg(int index) &#123; return &quot;Index: &quot;+index+&quot;, Size: &quot;+size;&#125;private void checkElementIndex(int index) &#123; if (!isElementIndex(index)) throw new IndexOutOfBoundsException(outOfBoundsMsg(index));&#125;private void checkPositionIndex(int index) &#123; if (!isPositionIndex(index)) throw new IndexOutOfBoundsException(outOfBoundsMsg(index));&#125; æŸ¥æ‰¾æ“ä½œæŸ¥æ‰¾æ“ä½œçš„æœ¬è´¨æ˜¯æŸ¥æ‰¾å…ƒç´ çš„ä¸‹æ ‡: æŸ¥æ‰¾ç¬¬ä¸€æ¬¡å‡ºç°çš„index, å¦‚æœæ‰¾ä¸åˆ°è¿”å›-1ï¼› 12345678910111213141516171819202122232425262728/** * Returns the index of the first occurrence of the specified element * in this list, or -1 if this list does not contain the element. * More formally, returns the lowest index &#123;@code i&#125; such that * &lt;tt&gt;(o==null&amp;nbsp;?&amp;nbsp;get(i)==null&amp;nbsp;:&amp;nbsp;o.equals(get(i)))&lt;/tt&gt;, * or -1 if there is no such index. * * @param o element to search for * @return the index of the first occurrence of the specified element in * this list, or -1 if this list does not contain the element */public int indexOf(Object o) &#123; int index = 0; if (o == null) &#123; for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (x.item == null) return index; index++; &#125; &#125; else &#123; for (Node&lt;E&gt; x = first; x != null; x = x.next) &#123; if (o.equals(x.item)) return index; index++; &#125; &#125; return -1;&#125; æŸ¥æ‰¾æœ€åä¸€æ¬¡å‡ºç°çš„index, å¦‚æœæ‰¾ä¸åˆ°è¿”å›-1ï¼› 12345678910111213141516171819202122232425262728/** * Returns the index of the last occurrence of the specified element * in this list, or -1 if this list does not contain the element. * More formally, returns the highest index &#123;@code i&#125; such that * &lt;tt&gt;(o==null&amp;nbsp;?&amp;nbsp;get(i)==null&amp;nbsp;:&amp;nbsp;o.equals(get(i)))&lt;/tt&gt;, * or -1 if there is no such index. * * @param o element to search for * @return the index of the last occurrence of the specified element in * this list, or -1 if this list does not contain the element */public int lastIndexOf(Object o) &#123; int index = size; if (o == null) &#123; for (Node&lt;E&gt; x = last; x != null; x = x.prev) &#123; index--; if (x.item == null) return index; &#125; &#125; else &#123; for (Node&lt;E&gt; x = last; x != null; x = x.prev) &#123; index--; if (o.equals(x.item)) return index; &#125; &#125; return -1;&#125; Queue æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354/** * Retrieves, but does not remove, the head (first element) of this list. * * @return the head of this list, or &#123;@code null&#125; if this list is empty * @since 1.5 */public E peek() &#123; final Node&lt;E&gt; f = first; return (f == null) ? null : f.item;&#125;/** * Retrieves, but does not remove, the head (first element) of this list. * * @return the head of this list * @throws NoSuchElementException if this list is empty * @since 1.5 */public E element() &#123; return getFirst();&#125;/** * Retrieves and removes the head (first element) of this list. * * @return the head of this list, or &#123;@code null&#125; if this list is empty * @since 1.5 */public E poll() &#123; final Node&lt;E&gt; f = first; return (f == null) ? null : unlinkFirst(f);&#125;/** * Retrieves and removes the head (first element) of this list. * * @return the head of this list * @throws NoSuchElementException if this list is empty * @since 1.5 */public E remove() &#123; return removeFirst();&#125;/** * Adds the specified element as the tail (last element) of this list. * * @param e the element to add * @return &#123;@code true&#125; (as specified by &#123;@link Queue#offer&#125;) * @since 1.5 */public boolean offer(E e) &#123; return add(e);&#125; Deque æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144/** * Inserts the specified element at the front of this list. * * @param e the element to insert * @return &#123;@code true&#125; (as specified by &#123;@link Deque#offerFirst&#125;) * @since 1.6 */public boolean offerFirst(E e) &#123; addFirst(e); return true;&#125;/** * Inserts the specified element at the end of this list. * * @param e the element to insert * @return &#123;@code true&#125; (as specified by &#123;@link Deque#offerLast&#125;) * @since 1.6 */public boolean offerLast(E e) &#123; addLast(e); return true;&#125;/** * Retrieves, but does not remove, the first element of this list, * or returns &#123;@code null&#125; if this list is empty. * * @return the first element of this list, or &#123;@code null&#125; * if this list is empty * @since 1.6 */public E peekFirst() &#123; final Node&lt;E&gt; f = first; return (f == null) ? null : f.item; &#125;/** * Retrieves, but does not remove, the last element of this list, * or returns &#123;@code null&#125; if this list is empty. * * @return the last element of this list, or &#123;@code null&#125; * if this list is empty * @since 1.6 */public E peekLast() &#123; final Node&lt;E&gt; l = last; return (l == null) ? null : l.item;&#125;/** * Retrieves and removes the first element of this list, * or returns &#123;@code null&#125; if this list is empty. * * @return the first element of this list, or &#123;@code null&#125; if * this list is empty * @since 1.6 */public E pollFirst() &#123; final Node&lt;E&gt; f = first; return (f == null) ? null : unlinkFirst(f);&#125;/** * Retrieves and removes the last element of this list, * or returns &#123;@code null&#125; if this list is empty. * * @return the last element of this list, or &#123;@code null&#125; if * this list is empty * @since 1.6 */public E pollLast() &#123; final Node&lt;E&gt; l = last; return (l == null) ? null : unlinkLast(l);&#125;/** * Pushes an element onto the stack represented by this list. In other * words, inserts the element at the front of this list. * * &lt;p&gt;This method is equivalent to &#123;@link #addFirst&#125;. * * @param e the element to push * @since 1.6 */public void push(E e) &#123; addFirst(e);&#125;/** * Pops an element from the stack represented by this list. In other * words, removes and returns the first element of this list. * * &lt;p&gt;This method is equivalent to &#123;@link #removeFirst()&#125;. * * @return the element at the front of this list (which is the top * of the stack represented by this list) * @throws NoSuchElementException if this list is empty * @since 1.6 */public E pop() &#123; return removeFirst();&#125;/** * Removes the first occurrence of the specified element in this * list (when traversing the list from head to tail). If the list * does not contain the element, it is unchanged. * * @param o element to be removed from this list, if present * @return &#123;@code true&#125; if the list contained the specified element * @since 1.6 */public boolean removeFirstOccurrence(Object o) &#123; return remove(o);&#125;/** * Removes the last occurrence of the specified element in this * list (when traversing the list from head to tail). If the list * does not contain the element, it is unchanged. * * @param o element to be removed from this list, if present * @return &#123;@code true&#125; if the list contained the specified element * @since 1.6 */public boolean removeLastOccurrence(Object o) &#123; if (o == null) &#123; for (Node&lt;E&gt; x = last; x != null; x = x.prev) &#123; if (x.item == null) &#123; unlink(x); return true; &#125; &#125; &#125; else &#123; for (Node&lt;E&gt; x = last; x != null; x = x.prev) &#123; if (o.equals(x.item)) &#123; unlink(x); return true; &#125; &#125; &#125; return false;&#125; å‚è€ƒ Java LinkedListæºç å‰–æ ç»“åˆæºç å¯¹LinkedListè¿›è¡Œè®²è§£ http://www.cnblogs.com/CarpenterLee/p/5457150.html","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"2.Collection - ArrayList æºç è§£æ","path":"/2023/12/25/2-Collection-ArrayList-æºç è§£æ/","content":"æœ¬æ–‡ä¸»è¦å¯¹Collection - ArrayListè¿›è¡Œæºç è§£æã€‚ æ¦‚è¿°ArrayListå®ç°äº†Listæ¥å£ï¼Œæ˜¯é¡ºåºå®¹å™¨ï¼Œå³å…ƒç´ å­˜æ”¾çš„æ•°æ®ä¸æ”¾è¿›å»çš„é¡ºåºç›¸åŒï¼Œå…è®¸æ”¾å…¥nullå…ƒç´ ï¼Œåº•å±‚é€šè¿‡æ•°ç»„å®ç°ã€‚é™¤è¯¥ç±»æœªå®ç°åŒæ­¥å¤–ï¼Œå…¶ä½™è·ŸVectorå¤§è‡´ç›¸åŒã€‚æ¯ä¸ªArrayListéƒ½æœ‰ä¸€ä¸ªå®¹é‡(capacity)ï¼Œè¡¨ç¤ºåº•å±‚æ•°ç»„çš„å®é™…å¤§å°ï¼Œå®¹å™¨å†…å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°ä¸èƒ½å¤šäºå½“å‰å®¹é‡ã€‚å½“å‘å®¹å™¨ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœå®¹é‡ä¸è¶³ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨å¢å¤§åº•å±‚æ•°ç»„çš„å¤§å°ã€‚å‰é¢å·²ç»æè¿‡ï¼ŒJavaæ³›å‹åªæ˜¯ç¼–è¯‘å™¨æä¾›çš„è¯­æ³•ç³–ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ•°ç»„æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œä»¥ä¾¿èƒ½å¤Ÿå®¹çº³ä»»ä½•ç±»å‹çš„å¯¹è±¡ã€‚ size(), isEmpty(), get(), set()æ–¹æ³•å‡èƒ½åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆï¼Œadd()æ–¹æ³•çš„æ—¶é—´å¼€é”€è·Ÿæ’å…¥ä½ç½®æœ‰å…³ï¼ŒaddAll()æ–¹æ³•çš„æ—¶é—´å¼€é”€è·Ÿæ·»åŠ å…ƒç´ çš„ä¸ªæ•°æˆæ­£æ¯”ã€‚å…¶ä½™æ–¹æ³•å¤§éƒ½æ˜¯çº¿æ€§æ—¶é—´ã€‚ ä¸ºè¿½æ±‚æ•ˆç‡ï¼ŒArrayListæ²¡æœ‰å®ç°åŒæ­¥(synchronized)ï¼Œå¦‚æœéœ€è¦å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨åŒæ­¥ï¼Œä¹Ÿå¯ä½¿ç”¨Vectoræ›¿ä»£ã€‚ ArrayListçš„å®ç°åº•å±‚æ•°æ®ç»“æ„1234567891011121314/** * The array buffer into which the elements of the ArrayList are stored. * The capacity of the ArrayList is the length of this array buffer. Any * empty ArrayList with elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA * will be expanded to DEFAULT_CAPACITY when the first element is added. */ transient Object[] elementData; // non-private to simplify nested class access /** * The size of the ArrayList (the number of elements it contains). * * @serial */ private int size; æ„é€ å‡½æ•°1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * Constructs an empty list with the specified initial capacity. * * @param initialCapacity the initial capacity of the list * @throws IllegalArgumentException if the specified initial capacity * is negative */ public ArrayList(int initialCapacity) &#123; if (initialCapacity &gt; 0) &#123; this.elementData = new Object[initialCapacity]; &#125; else if (initialCapacity == 0) &#123; this.elementData = EMPTY_ELEMENTDATA; &#125; else &#123; throw new IllegalArgumentException(&quot;Illegal Capacity: &quot;+ initialCapacity); &#125; &#125; /** * Constructs an empty list with an initial capacity of ten. */ public ArrayList() &#123; this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA; &#125; /** * Constructs a list containing the elements of the specified * collection, in the order they are returned by the collection&#x27;s * iterator. * * @param c the collection whose elements are to be placed into this list * @throws NullPointerException if the specified collection is null */ public ArrayList(Collection&lt;? extends E&gt; c) &#123; elementData = c.toArray(); if ((size = elementData.length) != 0) &#123; // c.toArray might (incorrectly) not return Object[] (see 6260652) if (elementData.getClass() != Object[].class) elementData = Arrays.copyOf(elementData, size, Object[].class); &#125; else &#123; // replace with empty array. this.elementData = EMPTY_ELEMENTDATA; &#125; &#125; è‡ªåŠ¨æ‰©å®¹æ¯å½“å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œéƒ½è¦å»æ£€æŸ¥æ·»åŠ åå…ƒç´ çš„ä¸ªæ•°æ˜¯å¦ä¼šè¶…å‡ºå½“å‰æ•°ç»„çš„é•¿åº¦ï¼Œå¦‚æœè¶…å‡ºï¼Œæ•°ç»„å°†ä¼šè¿›è¡Œæ‰©å®¹ï¼Œä»¥æ»¡è¶³æ·»åŠ æ•°æ®çš„éœ€æ±‚ã€‚æ•°ç»„æ‰©å®¹é€šè¿‡ä¸€ä¸ªå…¬å¼€çš„æ–¹æ³•ensureCapacity(int minCapacity)æ¥å®ç°ã€‚åœ¨å®é™…æ·»åŠ å¤§é‡å…ƒç´ å‰ï¼Œæˆ‘ä¹Ÿå¯ä»¥ä½¿ç”¨ensureCapacityæ¥æ‰‹åŠ¨å¢åŠ ArrayListå®ä¾‹çš„å®¹é‡ï¼Œä»¥å‡å°‘é€’å¢å¼å†åˆ†é…çš„æ•°é‡ã€‚ æ•°ç»„è¿›è¡Œæ‰©å®¹æ—¶ï¼Œä¼šå°†è€æ•°ç»„ä¸­çš„å…ƒç´ é‡æ–°æ‹·è´ä¸€ä»½åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œæ¯æ¬¡æ•°ç»„å®¹é‡çš„å¢é•¿å¤§çº¦æ˜¯å…¶åŸå®¹é‡çš„1.5å€ã€‚è¿™ç§æ“ä½œçš„ä»£ä»·æ˜¯å¾ˆé«˜çš„ï¼Œå› æ­¤åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…æ•°ç»„å®¹é‡çš„æ‰©å¼ ã€‚å½“æˆ‘ä»¬å¯é¢„çŸ¥è¦ä¿å­˜çš„å…ƒç´ çš„å¤šå°‘æ—¶ï¼Œè¦åœ¨æ„é€ ArrayListå®ä¾‹æ—¶ï¼Œå°±æŒ‡å®šå…¶å®¹é‡ï¼Œä»¥é¿å…æ•°ç»„æ‰©å®¹çš„å‘ç”Ÿã€‚æˆ–è€…æ ¹æ®å®é™…éœ€æ±‚ï¼Œé€šè¿‡è°ƒç”¨ensureCapacityæ–¹æ³•æ¥æ‰‹åŠ¨å¢åŠ ArrayListå®ä¾‹çš„å®¹é‡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869/** * Increases the capacity of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance, if * necessary, to ensure that it can hold at least the number of elements * specified by the minimum capacity argument. * * @param minCapacity the desired minimum capacity */public void ensureCapacity(int minCapacity) &#123; int minExpand = (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA) // any size if not default element table ? 0 // larger than default for default empty table. It&#x27;s already // supposed to be at default size. : DEFAULT_CAPACITY; if (minCapacity &gt; minExpand) &#123; ensureExplicitCapacity(minCapacity); &#125;&#125;private void ensureCapacityInternal(int minCapacity) &#123; if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123; minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity); &#125; ensureExplicitCapacity(minCapacity);&#125;private void ensureExplicitCapacity(int minCapacity) &#123; modCount++; // overflow-conscious code if (minCapacity - elementData.length &gt; 0) grow(minCapacity);&#125;/** * The maximum size of array to allocate. * Some VMs reserve some header words in an array. * Attempts to allocate larger arrays may result in * OutOfMemoryError: Requested array size exceeds VM limit */private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;/** * Increases the capacity to ensure that it can hold at least the * number of elements specified by the minimum capacity argument. * * @param minCapacity the desired minimum capacity */private void grow(int minCapacity) &#123; // overflow-conscious code int oldCapacity = elementData.length; int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1); if (newCapacity - minCapacity &lt; 0) newCapacity = minCapacity; if (newCapacity - MAX_ARRAY_SIZE &gt; 0) newCapacity = hugeCapacity(minCapacity); // minCapacity is usually close to size, so this is a win: elementData = Arrays.copyOf(elementData, newCapacity);&#125;private static int hugeCapacity(int minCapacity) &#123; if (minCapacity &lt; 0) // overflow throw new OutOfMemoryError(); return (minCapacity &gt; MAX_ARRAY_SIZE) ? Integer.MAX_VALUE : MAX_ARRAY_SIZE;&#125; add(), addAll()è·ŸC++ çš„vectorä¸åŒï¼ŒArrayListæ²¡æœ‰push_back()æ–¹æ³•ï¼Œå¯¹åº”çš„æ–¹æ³•æ˜¯add(E e)ï¼ŒArrayListä¹Ÿæ²¡æœ‰insert()æ–¹æ³•ï¼Œå¯¹åº”çš„æ–¹æ³•æ˜¯add(int index, E e)ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯å‘å®¹å™¨ä¸­æ·»åŠ æ–°å…ƒç´ ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´capacityä¸è¶³ï¼Œå› æ­¤åœ¨æ·»åŠ å…ƒç´ ä¹‹å‰ï¼Œéƒ½éœ€è¦è¿›è¡Œå‰©ä½™ç©ºé—´æ£€æŸ¥ï¼Œå¦‚æœéœ€è¦åˆ™è‡ªåŠ¨æ‰©å®¹ã€‚æ‰©å®¹æ“ä½œæœ€ç»ˆæ˜¯é€šè¿‡grow()æ–¹æ³•å®Œæˆçš„ã€‚ 123456789101112131415161718192021222324252627282930/** * Appends the specified element to the end of this list. * * @param e element to be appended to this list * @return &lt;tt&gt;true&lt;/tt&gt; (as specified by &#123;@link Collection#add&#125;) */public boolean add(E e) &#123; ensureCapacityInternal(size + 1); // Increments modCount!! elementData[size++] = e; return true;&#125;/** * Inserts the specified element at the specified position in this * list. Shifts the element currently at that position (if any) and * any subsequent elements to the right (adds one to their indices). * * @param index index at which the specified element is to be inserted * @param element element to be inserted * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; */public void add(int index, E element) &#123; rangeCheckForAdd(index); ensureCapacityInternal(size + 1); // Increments modCount!! System.arraycopy(elementData, index, elementData, index + 1, size - index); elementData[index] = element; size++;&#125; add(int index, E e)éœ€è¦å…ˆå¯¹å…ƒç´ è¿›è¡Œç§»åŠ¨ï¼Œç„¶åå®Œæˆæ’å…¥æ“ä½œï¼Œä¹Ÿå°±æ„å‘³ç€è¯¥æ–¹æ³•æœ‰ç€çº¿æ€§çš„æ—¶é—´å¤æ‚åº¦ã€‚ addAll()æ–¹æ³•èƒ½å¤Ÿä¸€æ¬¡æ·»åŠ å¤šä¸ªå…ƒç´ ï¼Œæ ¹æ®ä½ç½®ä¸åŒä¹Ÿæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯åœ¨æœ«å°¾æ·»åŠ çš„addAll(Collection&lt;? extends E&gt; c)æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä»æŒ‡å®šä½ç½®å¼€å§‹æ’å…¥çš„addAll(int index, Collection&lt;? extends E&gt; c)æ–¹æ³•ã€‚è·Ÿadd()æ–¹æ³•ç±»ä¼¼ï¼Œåœ¨æ’å…¥ä¹‹å‰ä¹Ÿéœ€è¦è¿›è¡Œç©ºé—´æ£€æŸ¥ï¼Œå¦‚æœéœ€è¦åˆ™è‡ªåŠ¨æ‰©å®¹ï¼›å¦‚æœä»æŒ‡å®šä½ç½®æ’å…¥ï¼Œä¹Ÿä¼šå­˜åœ¨ç§»åŠ¨å…ƒç´ çš„æƒ…å†µã€‚ addAll()çš„æ—¶é—´å¤æ‚åº¦ä¸ä»…è·Ÿæ’å…¥å…ƒç´ çš„å¤šå°‘æœ‰å…³ï¼Œä¹Ÿè·Ÿæ’å…¥çš„ä½ç½®ç›¸å…³ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * Appends all of the elements in the specified collection to the end of * this list, in the order that they are returned by the * specified collection&#x27;s Iterator. The behavior of this operation is * undefined if the specified collection is modified while the operation * is in progress. (This implies that the behavior of this call is * undefined if the specified collection is this list, and this * list is nonempty.) * * @param c collection containing elements to be added to this list * @return &lt;tt&gt;true&lt;/tt&gt; if this list changed as a result of the call * @throws NullPointerException if the specified collection is null */public boolean addAll(Collection&lt;? extends E&gt; c) &#123; Object[] a = c.toArray(); int numNew = a.length; ensureCapacityInternal(size + numNew); // Increments modCount System.arraycopy(a, 0, elementData, size, numNew); size += numNew; return numNew != 0;&#125;/** * Inserts all of the elements in the specified collection into this * list, starting at the specified position. Shifts the element * currently at that position (if any) and any subsequent elements to * the right (increases their indices). The new elements will appear * in the list in the order that they are returned by the * specified collection&#x27;s iterator. * * @param index index at which to insert the first element from the * specified collection * @param c collection containing elements to be added to this list * @return &lt;tt&gt;true&lt;/tt&gt; if this list changed as a result of the call * @throws IndexOutOfBoundsException &#123;@inheritDoc&#125; * @throws NullPointerException if the specified collection is null */public boolean addAll(int index, Collection&lt;? extends E&gt; c) &#123; rangeCheckForAdd(index); Object[] a = c.toArray(); int numNew = a.length; ensureCapacityInternal(size + numNew); // Increments modCount int numMoved = size - index; if (numMoved &gt; 0) System.arraycopy(elementData, index, elementData, index + numNew, numMoved); System.arraycopy(a, 0, elementData, index, numNew); size += numNew; return numNew != 0;&#125; set()æ—¢ç„¶åº•å±‚æ˜¯ä¸€ä¸ªæ•°ç»„ArrayListçš„set()æ–¹æ³•ä¹Ÿå°±å˜å¾—éå¸¸ç®€å•ï¼Œç›´æ¥å¯¹æ•°ç»„çš„æŒ‡å®šä½ç½®èµ‹å€¼å³å¯ã€‚ 123456public E set(int index, E element) &#123; rangeCheck(index);//ä¸‹æ ‡è¶Šç•Œæ£€æŸ¥ E oldValue = elementData(index); elementData[index] = element;//èµ‹å€¼åˆ°æŒ‡å®šä½ç½®ï¼Œå¤åˆ¶çš„ä»…ä»…æ˜¯å¼•ç”¨ return oldValue;&#125; get()get()æ–¹æ³•åŒæ ·å¾ˆç®€å•ï¼Œå”¯ä¸€è¦æ³¨æ„çš„æ˜¯ç”±äºåº•å±‚æ•°ç»„æ˜¯Object[]ï¼Œå¾—åˆ°å…ƒç´ åéœ€è¦è¿›è¡Œç±»å‹è½¬æ¢ã€‚ 1234public E get(int index) &#123; rangeCheck(index); return (E) elementData[index];//æ³¨æ„ç±»å‹è½¬æ¢&#125; remove()remove()æ–¹æ³•ä¹Ÿæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯remove(int index)åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ ï¼Œå¦ä¸€ä¸ªæ˜¯remove(Object o)åˆ é™¤ç¬¬ä¸€ä¸ªæ»¡è¶³o.equals(elementData[index])çš„å…ƒç´ ã€‚åˆ é™¤æ“ä½œæ˜¯add()æ“ä½œçš„é€†è¿‡ç¨‹ï¼Œéœ€è¦å°†åˆ é™¤ç‚¹ä¹‹åçš„å…ƒç´ å‘å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸ºäº†è®©GCèµ·ä½œç”¨ï¼Œå¿…é¡»æ˜¾å¼çš„ä¸ºæœ€åä¸€ä¸ªä½ç½®èµ‹nullå€¼ã€‚ 12345678910public E remove(int index) &#123; rangeCheck(index); modCount++; E oldValue = elementData(index); int numMoved = size - index - 1; if (numMoved &gt; 0) System.arraycopy(elementData, index+1, elementData, index, numMoved); elementData[--size] = null; //æ¸…é™¤è¯¥ä½ç½®çš„å¼•ç”¨ï¼Œè®©GCèµ·ä½œç”¨ return oldValue;&#125; å…³äºJava GCè¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼Œæœ‰äº†åƒåœ¾æ”¶é›†å™¨å¹¶ä¸æ„å‘³ç€ä¸€å®šä¸ä¼šæœ‰å†…å­˜æ³„æ¼ã€‚å¯¹è±¡èƒ½å¦è¢«GCçš„ä¾æ®æ˜¯æ˜¯å¦è¿˜æœ‰å¼•ç”¨æŒ‡å‘å®ƒï¼Œä¸Šé¢ä»£ç ä¸­å¦‚æœä¸æ‰‹åŠ¨èµ‹nullå€¼ï¼Œé™¤éå¯¹åº”çš„ä½ç½®è¢«å…¶ä»–å…ƒç´ è¦†ç›–ï¼Œå¦åˆ™åŸæ¥çš„å¯¹è±¡å°±ä¸€ç›´ä¸ä¼šè¢«å›æ”¶ã€‚ trimToSize()ArrayListè¿˜ç»™æˆ‘ä»¬æä¾›äº†å°†åº•å±‚æ•°ç»„çš„å®¹é‡è°ƒæ•´ä¸ºå½“å‰åˆ—è¡¨ä¿å­˜çš„å®é™…å…ƒç´ çš„å¤§å°çš„åŠŸèƒ½ã€‚å®ƒå¯ä»¥é€šè¿‡trimToSizeæ–¹æ³•æ¥å®ç°ã€‚ä»£ç å¦‚ä¸‹: 12345678910111213/** * Trims the capacity of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance to be the * list&#x27;s current size. An application can use this operation to minimize * the storage of an &lt;tt&gt;ArrayList&lt;/tt&gt; instance. */public void trimToSize() &#123; modCount++; if (size &lt; elementData.length) &#123; elementData = (size == 0) ? EMPTY_ELEMENTDATA : Arrays.copyOf(elementData, size); &#125;&#125; indexOf(), lastIndexOf()è·å–å…ƒç´ çš„ç¬¬ä¸€æ¬¡å‡ºç°çš„index: 12345678910111213141516171819/** * Returns the index of the first occurrence of the specified element * in this list, or -1 if this list does not contain the element. * More formally, returns the lowest index &lt;tt&gt;i&lt;/tt&gt; such that * &lt;tt&gt;(o==null&amp;nbsp;?&amp;nbsp;get(i)==null&amp;nbsp;:&amp;nbsp;o.equals(get(i)))&lt;/tt&gt;, * or -1 if there is no such index. */ public int indexOf(Object o) &#123; if (o == null) &#123; for (int i = 0; i &lt; size; i++) if (elementData[i]==null) return i; &#125; else &#123; for (int i = 0; i &lt; size; i++) if (o.equals(elementData[i])) return i; &#125; return -1; &#125; è·å–å…ƒç´ çš„æœ€åä¸€æ¬¡å‡ºç°çš„index: 12345678910111213141516171819/** * Returns the index of the last occurrence of the specified element * in this list, or -1 if this list does not contain the element. * More formally, returns the highest index &lt;tt&gt;i&lt;/tt&gt; such that * &lt;tt&gt;(o==null&amp;nbsp;?&amp;nbsp;get(i)==null&amp;nbsp;:&amp;nbsp;o.equals(get(i)))&lt;/tt&gt;, * or -1 if there is no such index. */public int lastIndexOf(Object o) &#123; if (o == null) &#123; for (int i = size-1; i &gt;= 0; i--) if (elementData[i]==null) return i; &#125; else &#123; for (int i = size-1; i &gt;= 0; i--) if (o.equals(elementData[i])) return i; &#125; return -1;&#125; Fail-Fastæœºåˆ¶:ArrayListä¹Ÿé‡‡ç”¨äº†å¿«é€Ÿå¤±è´¥çš„æœºåˆ¶ï¼Œé€šè¿‡è®°å½•modCountå‚æ•°æ¥å®ç°ã€‚åœ¨é¢å¯¹å¹¶å‘çš„ä¿®æ”¹æ—¶ï¼Œè¿­ä»£å™¨å¾ˆå¿«å°±ä¼šå®Œå…¨å¤±è´¥ï¼Œè€Œä¸æ˜¯å†’ç€åœ¨å°†æ¥æŸä¸ªä¸ç¡®å®šæ—¶é—´å‘ç”Ÿä»»æ„ä¸ç¡®å®šè¡Œä¸ºçš„é£é™©ã€‚ å‚è€ƒ æ·±å…¥Javaé›†åˆå­¦ä¹ ç³»åˆ—: ArrayListçš„å®ç°åŸç† http://zhangshixi.iteye.com/blog/674856 Java ArrayListæºç å‰–æ ç»“åˆæºç å¯¹ArrayListè¿›è¡Œè®²è§£ http://www.cnblogs.com/CarpenterLee/p/5419880.html","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"1.Collection ç±»å…³ç³»å›¾","path":"/2023/12/25/1-Collection-ç±»å…³ç³»å›¾/","content":"æœ¬æ–‡ä¸»è¦ä»‹ç»JDKä¸­Collectionå’ŒMapç›¸å…³çŸ¥è¯†ä½“ç³»ï¼Œåç»­ç« èŠ‚å°†å¯¹ä¸»è¦å¯¹ç±»è¿›è¡Œæºç è§£è¯»ã€‚@pdai çŸ¥è¯†ä½“ç³»ç»“æ„ ä»‹ç»å®¹å™¨ï¼Œå°±æ˜¯å¯ä»¥å®¹çº³å…¶ä»–Javaå¯¹è±¡çš„å¯¹è±¡ã€‚*Java Collections Framework(JCF)*ä¸ºJavaå¼€å‘è€…æä¾›äº†é€šç”¨çš„å®¹å™¨ï¼Œå…¶å§‹äºJDK 1.2ï¼Œä¼˜ç‚¹æ˜¯: é™ä½ç¼–ç¨‹éš¾åº¦ æé«˜ç¨‹åºæ€§èƒ½ æé«˜APIé—´çš„äº’æ“ä½œæ€§ é™ä½å­¦ä¹ éš¾åº¦ é™ä½è®¾è®¡å’Œå®ç°ç›¸å…³APIçš„éš¾åº¦ å¢åŠ ç¨‹åºçš„é‡ç”¨æ€§ Javaå®¹å™¨é‡Œåªèƒ½æ”¾å¯¹è±¡ï¼Œå¯¹äºåŸºæœ¬ç±»å‹(int, long, float, doubleç­‰)ï¼Œéœ€è¦å°†å…¶åŒ…è£…æˆå¯¹è±¡ç±»å‹å(Integer, Long, Float, Doubleç­‰)æ‰èƒ½æ”¾åˆ°å®¹å™¨é‡Œã€‚å¾ˆå¤šæ—¶å€™æ‹†åŒ…è£…å’Œè§£åŒ…è£…èƒ½å¤Ÿè‡ªåŠ¨å®Œæˆã€‚è¿™è™½ç„¶ä¼šå¯¼è‡´é¢å¤–çš„æ€§èƒ½å’Œç©ºé—´å¼€é”€ï¼Œä½†ç®€åŒ–äº†è®¾è®¡å’Œç¼–ç¨‹ã€‚ Collection å®¹å™¨ä¸»è¦åŒ…æ‹¬ Collection å’Œ Map ä¸¤ç§ï¼ŒCollection å­˜å‚¨ç€å¯¹è±¡çš„é›†åˆï¼Œè€Œ Map å­˜å‚¨ç€é”®å€¼å¯¹(ä¸¤ä¸ªå¯¹è±¡)çš„æ˜ å°„è¡¨ã€‚ SetTreeSetåŸºäºçº¢é»‘æ ‘å®ç°ï¼Œæ”¯æŒæœ‰åºæ€§æ“ä½œï¼Œä¾‹å¦‚æ ¹æ®ä¸€ä¸ªèŒƒå›´æŸ¥æ‰¾å…ƒç´ çš„æ“ä½œã€‚ä½†æ˜¯æŸ¥æ‰¾æ•ˆç‡ä¸å¦‚ HashSetï¼ŒHashSet æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼ŒTreeSet åˆ™ä¸º O(logN)ã€‚ HashSetåŸºäºå“ˆå¸Œè¡¨å®ç°ï¼Œæ”¯æŒå¿«é€ŸæŸ¥æ‰¾ï¼Œä½†ä¸æ”¯æŒæœ‰åºæ€§æ“ä½œã€‚å¹¶ä¸”å¤±å»äº†å…ƒç´ çš„æ’å…¥é¡ºåºä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨ Iterator éå† HashSet å¾—åˆ°çš„ç»“æœæ˜¯ä¸ç¡®å®šçš„ã€‚ LinkedHashSetå…·æœ‰ HashSet çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œä¸”å†…éƒ¨ä½¿ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤å…ƒç´ çš„æ’å…¥é¡ºåºã€‚ ListArrayListåŸºäºåŠ¨æ€æ•°ç»„å®ç°ï¼Œæ”¯æŒéšæœºè®¿é—®ã€‚ Vectorå’Œ ArrayList ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ LinkedListåŸºäºåŒå‘é“¾è¡¨å®ç°ï¼Œåªèƒ½é¡ºåºè®¿é—®ï¼Œä½†æ˜¯å¯ä»¥å¿«é€Ÿåœ°åœ¨é“¾è¡¨ä¸­é—´æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒLinkedList è¿˜å¯ä»¥ç”¨ä½œæ ˆã€é˜Ÿåˆ—å’ŒåŒå‘é˜Ÿåˆ—ã€‚ QueueLinkedListå¯ä»¥ç”¨å®ƒæ¥å®ç°åŒå‘é˜Ÿåˆ—ã€‚ PriorityQueueåŸºäºå †ç»“æ„å®ç°ï¼Œå¯ä»¥ç”¨å®ƒæ¥å®ç°ä¼˜å…ˆé˜Ÿåˆ—ã€‚ MapTreeMapåŸºäºçº¢é»‘æ ‘å®ç°ã€‚ HashMapåŸºäºå“ˆå¸Œè¡¨å®ç°ã€‚ HashTableå’Œ HashMap ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™æ„å‘³ç€åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å†™å…¥ HashTable å¹¶ä¸”ä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚å®ƒæ˜¯é—ç•™ç±»ï¼Œä¸åº”è¯¥å»ä½¿ç”¨å®ƒã€‚ç°åœ¨å¯ä»¥ä½¿ç”¨ ConcurrentHashMap æ¥æ”¯æŒçº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸” ConcurrentHashMap çš„æ•ˆç‡ä¼šæ›´é«˜ï¼Œå› ä¸º ConcurrentHashMap å¼•å…¥äº†åˆ†æ®µé”ã€‚ LinkedHashMapä½¿ç”¨åŒå‘é“¾è¡¨æ¥ç»´æŠ¤å…ƒç´ çš„é¡ºåºï¼Œé¡ºåºä¸ºæ’å…¥é¡ºåºæˆ–è€…æœ€è¿‘æœ€å°‘ä½¿ç”¨(LRU)é¡ºåºã€‚ å‚è€ƒå†…å®¹ CarpenterLee&#x2F;JCFInternals https://github.com/CarpenterLee/JCFInternals","tags":["Java","Collectioné›†åˆæ¡†æ¶"],"categories":["Java","Collectioné›†åˆæ¡†æ¶"]},{"title":"8.Javaå¸¸ç”¨æœºåˆ¶ - SPIæœºåˆ¶è¯¦è§£","path":"/2023/12/25/8-Javaå¸¸ç”¨æœºåˆ¶-SPIæœºåˆ¶è¯¦è§£/","content":"SPIï¼ˆService Provider Interfaceï¼‰ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§ æœåŠ¡æä¾›å‘ç°æœºåˆ¶ï¼Œå¯ä»¥ç”¨æ¥å¯ç”¨æ¡†æ¶æ‰©å±•å’Œæ›¿æ¢ç»„ä»¶ï¼Œä¸»è¦æ˜¯è¢«æ¡†æ¶çš„å¼€å‘äººå‘˜ä½¿ç”¨ã€‚ ä»€ä¹ˆæ˜¯SPIæœºåˆ¶SPIï¼ˆService Provider Interfaceï¼‰ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§ æœåŠ¡æä¾›å‘ç°æœºåˆ¶ï¼Œå¯ä»¥ç”¨æ¥å¯ç”¨æ¡†æ¶æ‰©å±•å’Œæ›¿æ¢ç»„ä»¶ï¼Œä¸»è¦æ˜¯è¢«æ¡†æ¶çš„å¼€å‘äººå‘˜ä½¿ç”¨ï¼Œæ¯”å¦‚java.sql.Driveræ¥å£ï¼Œå…¶ä»–ä¸åŒå‚å•†å¯ä»¥é’ˆå¯¹åŒä¸€æ¥å£åšå‡ºä¸åŒçš„å®ç°ï¼ŒMySQLå’ŒPostgreSQLéƒ½æœ‰ä¸åŒçš„å®ç°æä¾›ç»™ç”¨æˆ·ï¼Œè€ŒJavaçš„SPIæœºåˆ¶å¯ä»¥ä¸ºæŸä¸ªæ¥å£å¯»æ‰¾æœåŠ¡å®ç°ã€‚Javaä¸­SPIæœºåˆ¶ä¸»è¦æ€æƒ³æ˜¯å°†è£…é…çš„æ§åˆ¶æƒç§»åˆ°ç¨‹åºä¹‹å¤–ï¼Œåœ¨æ¨¡å—åŒ–è®¾è®¡ä¸­è¿™ä¸ªæœºåˆ¶å°¤å…¶é‡è¦ï¼Œå…¶æ ¸å¿ƒæ€æƒ³å°±æ˜¯ è§£è€¦ã€‚ SPIæ•´ä½“æœºåˆ¶å›¾å¦‚ä¸‹ï¼š å½“æœåŠ¡çš„æä¾›è€…æä¾›äº†ä¸€ç§æ¥å£çš„å®ç°ä¹‹åï¼Œéœ€è¦åœ¨classpathä¸‹çš„META-INF/services/ç›®å½•é‡Œåˆ›å»ºä¸€ä¸ªä»¥æœåŠ¡æ¥å£å‘½åçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹å°±æ˜¯è¿™ä¸ªæ¥å£çš„å…·ä½“çš„å®ç°ç±»ã€‚å½“å…¶ä»–çš„ç¨‹åºéœ€è¦è¿™ä¸ªæœåŠ¡çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡æŸ¥æ‰¾è¿™ä¸ªjaråŒ…ï¼ˆä¸€èˆ¬éƒ½æ˜¯ä»¥jaråŒ…åšä¾èµ–ï¼‰çš„META-INF/services/ä¸­çš„é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶ä¸­æœ‰æ¥å£çš„å…·ä½“å®ç°ç±»åï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªç±»åè¿›è¡ŒåŠ è½½å®ä¾‹åŒ–ï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥æœåŠ¡äº†ã€‚JDKä¸­æŸ¥æ‰¾æœåŠ¡çš„å®ç°çš„å·¥å…·ç±»æ˜¯ï¼šjava.util.ServiceLoaderã€‚ SPIæœºåˆ¶çš„ç®€å•ç¤ºä¾‹ ç½‘ä¸Šæ‰¾äº†ä¸ªä¾‹å­ï¼šè¿™é‡Œ æˆ‘ä»¬ç°åœ¨éœ€è¦ä½¿ç”¨ä¸€ä¸ªå†…å®¹æœç´¢æ¥å£ï¼Œæœç´¢çš„å®ç°å¯èƒ½æ˜¯åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„æœç´¢ï¼Œä¹Ÿå¯èƒ½æ˜¯åŸºäºæ•°æ®åº“çš„æœç´¢ã€‚ å…ˆå®šä¹‰å¥½æ¥å£ 123public interface Search &#123; public List&lt;String&gt; searchDoc(String keyword); &#125; æ–‡ä»¶æœç´¢å®ç° 1234567public class FileSearch implements Search&#123; @Override public List&lt;String&gt; searchDoc(String keyword) &#123; System.out.println(&quot;æ–‡ä»¶æœç´¢ &quot;+keyword); return null; &#125;&#125; æ•°æ®åº“æœç´¢å®ç° 1234567public class DatabaseSearch implements Search&#123; @Override public List&lt;String&gt; searchDoc(String keyword) &#123; System.out.println(&quot;æ•°æ®æœç´¢ &quot;+keyword); return null; &#125;&#125; resources æ¥ä¸‹æ¥å¯ä»¥åœ¨resourcesä¸‹æ–°å»ºMETA-INF&#x2F;services&#x2F;ç›®å½•ï¼Œç„¶åæ–°å»ºæ¥å£å…¨é™å®šåçš„æ–‡ä»¶ï¼šcom.cainiao.ys.spi.learn.Searchï¼Œé‡Œé¢åŠ ä¸Šæˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„å®ç°ç±» 1com.cainiao.ys.spi.learn.FileSearch æµ‹è¯•æ–¹æ³• 12345678910public class TestCase &#123; public static void main(String[] args) &#123; ServiceLoader&lt;Search&gt; s = ServiceLoader.load(Search.class); Iterator&lt;Search&gt; iterator = s.iterator(); while (iterator.hasNext()) &#123; Search search = iterator.next(); search.searchDoc(&quot;hello world&quot;); &#125; &#125;&#125; å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœï¼šæ–‡ä»¶æœç´¢ hello world å¦‚æœåœ¨com.cainiao.ys.spi.learn.Searchæ–‡ä»¶é‡Œå†™ä¸Šä¸¤ä¸ªå®ç°ç±»ï¼Œé‚£æœ€åçš„è¾“å‡ºç»“æœå°±æ˜¯ä¸¤è¡Œäº†ã€‚ è¿™å°±æ˜¯å› ä¸ºServiceLoader.load(Search.class)åœ¨åŠ è½½æŸæ¥å£æ—¶ï¼Œä¼šå»META-INF/servicesä¸‹æ‰¾æ¥å£çš„å…¨é™å®šåæ–‡ä»¶ï¼Œå†æ ¹æ®é‡Œé¢çš„å†…å®¹åŠ è½½ç›¸åº”çš„å®ç°ç±»ã€‚ è¿™å°±æ˜¯spiçš„æ€æƒ³ï¼Œæ¥å£çš„å®ç°ç”±providerå®ç°ï¼Œprovideråªç”¨åœ¨æäº¤çš„jaråŒ…é‡Œçš„META-INF/servicesä¸‹æ ¹æ®å¹³å°å®šä¹‰çš„æ¥å£æ–°å»ºæ–‡ä»¶ï¼Œå¹¶æ·»åŠ è¿›ç›¸åº”çš„å®ç°ç±»å†…å®¹å°±å¥½ã€‚ SPIæœºåˆ¶çš„å¹¿æ³›åº”ç”¨SPIæœºåˆ¶ - JDBC DriverManager åœ¨JDBC4.0ä¹‹å‰ï¼Œæˆ‘ä»¬å¼€å‘æœ‰è¿æ¥æ•°æ®åº“çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šç”¨Class.forName(&quot;com.mysql.jdbc.Driver&quot;)è¿™å¥å…ˆåŠ è½½æ•°æ®åº“ç›¸å…³çš„é©±åŠ¨ï¼Œç„¶åå†è¿›è¡Œè·å–è¿æ¥ç­‰çš„æ“ä½œã€‚è€ŒJDBC4.0ä¹‹åä¸éœ€è¦ç”¨Class.forName(&quot;com.mysql.jdbc.Driver&quot;)æ¥åŠ è½½é©±åŠ¨ï¼Œç›´æ¥è·å–è¿æ¥å°±å¯ä»¥äº†ï¼Œç°åœ¨è¿™ç§æ–¹å¼å°±æ˜¯ä½¿ç”¨äº†Javaçš„SPIæ‰©å±•æœºåˆ¶æ¥å®ç°ã€‚ JDBCæ¥å£å®šä¹‰é¦–å…ˆåœ¨javaä¸­å®šä¹‰äº†æ¥å£java.sql.Driverï¼Œå¹¶æ²¡æœ‰å…·ä½“çš„å®ç°ï¼Œå…·ä½“çš„å®ç°éƒ½æ˜¯ç”±ä¸åŒå‚å•†æ¥æä¾›çš„ã€‚ mysqlå®ç°åœ¨mysqlçš„jaråŒ…mysql-connector-java-6.0.6.jarä¸­ï¼Œå¯ä»¥æ‰¾åˆ°META-INF/servicesç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ªåå­—ä¸ºjava.sql.Driverçš„æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯com.mysql.cj.jdbc.Driverï¼Œè¿™é‡Œé¢çš„å†…å®¹å°±æ˜¯é’ˆå¯¹Javaä¸­å®šä¹‰çš„æ¥å£çš„å®ç°ã€‚ postgresqlå®ç°åŒæ ·åœ¨postgresqlçš„jaråŒ…postgresql-42.0.0.jarä¸­ï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ°åŒæ ·çš„é…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯org.postgresql.Driverï¼Œè¿™æ˜¯postgresqlå¯¹Javaçš„java.sql.Driverçš„å®ç°ã€‚ ä½¿ç”¨æ–¹æ³•ä¸Šé¢è¯´äº†ï¼Œç°åœ¨ä½¿ç”¨SPIæ‰©å±•æ¥åŠ è½½å…·ä½“çš„é©±åŠ¨ï¼Œæˆ‘ä»¬åœ¨Javaä¸­å†™è¿æ¥æ•°æ®åº“çš„ä»£ç çš„æ—¶å€™ï¼Œä¸éœ€è¦å†ä½¿ç”¨Class.forName(&quot;com.mysql.jdbc.Driver&quot;)æ¥åŠ è½½é©±åŠ¨äº†ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š 123String url = &quot;jdbc:xxxx://xxxx:xxxx/xxxx&quot;;Connection conn = DriverManager.getConnection(url,username,password);..... è¿™é‡Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°spiçš„ä½¿ç”¨ï¼Œæ¥ç€çœ‹ä¸‹é¢çš„è§£æã€‚ æºç å®ç°ä¸Šé¢çš„ä½¿ç”¨æ–¹æ³•ï¼Œå°±æ˜¯æˆ‘ä»¬æ™®é€šçš„è¿æ¥æ•°æ®åº“çš„ä»£ç ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°SPIçš„ä¸œè¥¿ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰å†™æœ‰å…³å…·ä½“é©±åŠ¨çš„ç¡¬ç¼–ç Class.forName(&quot;com.mysql.jdbc.Driver&quot;)ï¼ ä¸Šé¢çš„ä»£ç å¯ä»¥ç›´æ¥è·å–æ•°æ®åº“è¿æ¥è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯è·ŸSPIæœ‰å•¥å…³ç³»å‘¢ï¼Ÿä¸Šé¢ä»£ç æ²¡æœ‰äº†åŠ è½½é©±åŠ¨çš„ä»£ç ï¼Œæˆ‘ä»¬æ€ä¹ˆå»ç¡®å®šä½¿ç”¨å“ªä¸ªæ•°æ®åº“è¿æ¥çš„é©±åŠ¨å‘¢ï¼Ÿè¿™é‡Œå°±æ¶‰åŠåˆ°ä½¿ç”¨Javaçš„SPIæ‰©å±•æœºåˆ¶æ¥æŸ¥æ‰¾ç›¸å…³é©±åŠ¨çš„ä¸œè¥¿äº†ï¼Œå…³äºé©±åŠ¨çš„æŸ¥æ‰¾å…¶å®éƒ½åœ¨DriverManagerä¸­ï¼ŒDriverManageræ˜¯Javaä¸­çš„å®ç°ï¼Œç”¨æ¥è·å–æ•°æ®åº“è¿æ¥ï¼Œåœ¨DriverManagerä¸­æœ‰ä¸€ä¸ªé™æ€ä»£ç å—å¦‚ä¸‹ï¼š 1234static &#123; loadInitialDrivers(); println(&quot;JDBC DriverManager initialized&quot;);&#125; å¯ä»¥çœ‹åˆ°æ˜¯åŠ è½½å®ä¾‹åŒ–é©±åŠ¨çš„ï¼Œæ¥ç€çœ‹loadInitialDriversæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445private static void loadInitialDrivers() &#123; String drivers; try &#123; drivers = AccessController.doPrivileged(new PrivilegedAction&lt;String&gt;() &#123; public String run() &#123; return System.getProperty(&quot;jdbc.drivers&quot;); &#125; &#125;); &#125; catch (Exception ex) &#123; drivers = null; &#125; AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; //ä½¿ç”¨SPIçš„ServiceLoaderæ¥åŠ è½½æ¥å£çš„å®ç° ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class); Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator(); try&#123; while(driversIterator.hasNext()) &#123; driversIterator.next(); &#125; &#125; catch(Throwable t) &#123; // Do nothing &#125; return null; &#125; &#125;); println(&quot;DriverManager.initialize: jdbc.drivers = &quot; + drivers); if (drivers == null || drivers.equals(&quot;&quot;)) &#123; return; &#125; String[] driversList = drivers.split(&quot;:&quot;); println(&quot;number of Drivers:&quot; + driversList.length); for (String aDriver : driversList) &#123; try &#123; println(&quot;DriverManager.Initialize: loading &quot; + aDriver); Class.forName(aDriver, true, ClassLoader.getSystemClassLoader()); &#125; catch (Exception ex) &#123; println(&quot;DriverManager.Initialize: load failed: &quot; + ex); &#125; &#125;&#125; ä¸Šé¢çš„ä»£ç ä¸»è¦æ­¥éª¤æ˜¯ï¼š ä»ç³»ç»Ÿå˜é‡ä¸­è·å–æœ‰å…³é©±åŠ¨çš„å®šä¹‰ã€‚ ä½¿ç”¨SPIæ¥è·å–é©±åŠ¨çš„å®ç°ã€‚ éå†ä½¿ç”¨SPIè·å–åˆ°çš„å…·ä½“å®ç°ï¼Œå®ä¾‹åŒ–å„ä¸ªå®ç°ç±»ã€‚ æ ¹æ®ç¬¬ä¸€æ­¥è·å–åˆ°çš„é©±åŠ¨åˆ—è¡¨æ¥å®ä¾‹åŒ–å…·ä½“å®ç°ç±»ã€‚ æˆ‘ä»¬ä¸»è¦å…³æ³¨2,3æ­¥ï¼Œè¿™ä¸¤æ­¥æ˜¯SPIçš„ç”¨æ³•ï¼Œé¦–å…ˆçœ‹ç¬¬äºŒæ­¥ï¼Œä½¿ç”¨SPIæ¥è·å–é©±åŠ¨çš„å®ç°ï¼Œå¯¹åº”çš„ä»£ç æ˜¯ï¼š 1ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class); è¿™é‡Œæ²¡æœ‰å»META-INF/servicesç›®å½•ä¸‹æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼Œä¹Ÿæ²¡æœ‰åŠ è½½å…·ä½“å®ç°ç±»ï¼Œåšçš„äº‹æƒ…å°±æ˜¯å°è£…äº†æˆ‘ä»¬çš„æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨ï¼Œå¹¶åˆå§‹åŒ–äº†ä¸€ä¸ªè¿­ä»£å™¨ã€‚ æ¥ç€çœ‹ç¬¬ä¸‰æ­¥ï¼Œéå†ä½¿ç”¨SPIè·å–åˆ°çš„å…·ä½“å®ç°ï¼Œå®ä¾‹åŒ–å„ä¸ªå®ç°ç±»ï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š 123456//è·å–è¿­ä»£å™¨Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();//éå†æ‰€æœ‰çš„é©±åŠ¨å®ç°while(driversIterator.hasNext()) &#123; driversIterator.next();&#125; åœ¨éå†çš„æ—¶å€™ï¼Œé¦–å…ˆè°ƒç”¨driversIterator.hasNext()æ–¹æ³•ï¼Œè¿™é‡Œä¼šæœç´¢classpathä¸‹ä»¥åŠjaråŒ…ä¸­æ‰€æœ‰çš„META-INF/servicesç›®å½•ä¸‹çš„java.sql.Driveræ–‡ä»¶ï¼Œå¹¶æ‰¾åˆ°æ–‡ä»¶ä¸­çš„å®ç°ç±»çš„åå­—ï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰å®ä¾‹åŒ–å…·ä½“çš„å®ç°ç±»ï¼ˆServiceLoaderå…·ä½“çš„æºç å®ç°åœ¨ä¸‹é¢ï¼‰ã€‚ ç„¶åæ˜¯è°ƒç”¨driversIterator.next();æ–¹æ³•ï¼Œæ­¤æ—¶å°±ä¼šæ ¹æ®é©±åŠ¨åå­—å…·ä½“å®ä¾‹åŒ–å„ä¸ªå®ç°ç±»äº†ã€‚ç°åœ¨é©±åŠ¨å°±è¢«æ‰¾åˆ°å¹¶å®ä¾‹åŒ–äº†ã€‚ å¯ä»¥çœ‹ä¸‹æˆªå›¾ï¼Œæˆ‘åœ¨æµ‹è¯•é¡¹ç›®ä¸­æ·»åŠ äº†ä¸¤ä¸ªjaråŒ…ï¼Œmysql-connector-java-6.0.6.jarå’Œpostgresql-42.0.0.0.jarï¼Œè·Ÿè¸ªåˆ°DriverManagerä¸­ä¹‹åï¼š å¯ä»¥çœ‹åˆ°æ­¤æ—¶è¿­ä»£å™¨ä¸­æœ‰ä¸¤ä¸ªé©±åŠ¨ï¼Œmysqlå’Œpostgresqlçš„éƒ½è¢«åŠ è½½äº†ã€‚ SPIæœºåˆ¶ - Common-Logging common-loggingï¼ˆä¹Ÿç§°Jakarta Commons Loggingï¼Œç¼©å†™ JCLï¼‰æ˜¯å¸¸ç”¨çš„æ—¥å¿—åº“é—¨é¢ï¼Œå…·ä½“æ—¥å¿—åº“ç›¸å…³å¯ä»¥çœ‹è¿™ç¯‡ã€‚æˆ‘ä»¬çœ‹ä¸‹å®ƒæ˜¯æ€ä¹ˆè§£è€¦çš„ã€‚ é¦–å…ˆï¼Œæ—¥å¿—å®ä¾‹æ˜¯é€šè¿‡LogFactoryçš„getLog(String)æ–¹æ³•åˆ›å»ºçš„ï¼š 123public static getLog(Class clazz) throws LogConfigurationException &#123; return getFactory().getInstance(clazz);&#125; LogFatoryæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒè´Ÿè´£åŠ è½½å…·ä½“çš„æ—¥å¿—å®ç°ï¼Œåˆ†æå…¶Factory.getFactory()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235public static org.apache.commons.logging.LogFactory getFactory() throws LogConfigurationException &#123; // Identify the class loader we will be using ClassLoader contextClassLoader = getContextClassLoaderInternal(); if (contextClassLoader == null) &#123; // This is an odd enough situation to report about. This // output will be a nuisance on JDK1.1, as the system // classloader is null in that environment. if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;Context classloader is null.&quot;); &#125; &#125; // Return any previously registered factory for this class loader org.apache.commons.logging.LogFactory factory = getCachedFactory(contextClassLoader); if (factory != null) &#123; return factory; &#125; if (isDiagnosticsEnabled()) &#123; logDiagnostic( &quot;[LOOKUP] LogFactory implementation requested for the first time for context classloader &quot; + objectId(contextClassLoader)); logHierarchy(&quot;[LOOKUP] &quot;, contextClassLoader); &#125; // Load properties file. // // If the properties file exists, then its contents are used as // &quot;attributes&quot; on the LogFactory implementation class. One particular // property may also control which LogFactory concrete subclass is // used, but only if other discovery mechanisms fail.. // // As the properties file (if it exists) will be used one way or // another in the end we may as well look for it first. // classpathæ ¹ç›®å½•ä¸‹å¯»æ‰¾commons-logging.properties Properties props = getConfigurationFile(contextClassLoader, FACTORY_PROPERTIES); // Determine whether we will be using the thread context class loader to // load logging classes or not by checking the loaded properties file (if any). // classpathæ ¹ç›®å½•ä¸‹commons-logging.propertiesæ˜¯å¦é…ç½®use_tccl ClassLoader baseClassLoader = contextClassLoader; if (props != null) &#123; String useTCCLStr = props.getProperty(TCCL_KEY); if (useTCCLStr != null) &#123; // The Boolean.valueOf(useTCCLStr).booleanValue() formulation // is required for Java 1.2 compatibility. if (Boolean.valueOf(useTCCLStr).booleanValue() == false) &#123; // Don&#x27;t use current context classloader when locating any // LogFactory or Log classes, just use the class that loaded // this abstract class. When this class is deployed in a shared // classpath of a container, it means webapps cannot deploy their // own logging implementations. It also means that it is up to the // implementation whether to load library-specific config files // from the TCCL or not. baseClassLoader = thisClassLoader; &#125; &#125; &#125; // è¿™é‡ŒçœŸæ­£å¼€å§‹å†³å®šä½¿ç”¨å“ªä¸ªfactory // é¦–å…ˆï¼Œå°è¯•æŸ¥æ‰¾vmç³»ç»Ÿå±æ€§org.apache.commons.logging.LogFactoryï¼Œå…¶æ˜¯å¦æŒ‡å®šfactory // Determine which concrete LogFactory subclass to use. // First, try a global system property if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] Looking for system property [&quot; + FACTORY_PROPERTY + &quot;] to define the LogFactory subclass to use...&quot;); &#125; try &#123; String factoryClass = getSystemProperty(FACTORY_PROPERTY, null); if (factoryClass != null) &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] Creating an instance of LogFactory class &#x27;&quot; + factoryClass + &quot;&#x27; as specified by system property &quot; + FACTORY_PROPERTY); &#125; factory = newFactory(factoryClass, baseClassLoader, contextClassLoader); &#125; else &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] No system property [&quot; + FACTORY_PROPERTY + &quot;] defined.&quot;); &#125; &#125; &#125; catch (SecurityException e) &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] A security exception occurred while trying to create an&quot; + &quot; instance of the custom factory class&quot; + &quot;: [&quot; + trim(e.getMessage()) + &quot;]. Trying alternative implementations...&quot;); &#125; // ignore &#125; catch (RuntimeException e) &#123; // This is not consistent with the behaviour when a bad LogFactory class is // specified in a services file. // // One possible exception that can occur here is a ClassCastException when // the specified class wasn&#x27;t castable to this LogFactory type. if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] An exception occurred while trying to create an&quot; + &quot; instance of the custom factory class&quot; + &quot;: [&quot; + trim(e.getMessage()) + &quot;] as specified by a system property.&quot;); &#125; throw e; &#125; // ç¬¬äºŒï¼Œå°è¯•ä½¿ç”¨java spiæœåŠ¡å‘ç°æœºåˆ¶ï¼Œè½½META-INF/servicesä¸‹å¯»æ‰¾org.apache.commons.logging.LogFactoryå®ç° // Second, try to find a service by using the JDK1.3 class // discovery mechanism, which involves putting a file with the name // of an interface class in the META-INF/services directory, where the // contents of the file is a single line specifying a concrete class // that implements the desired interface. if (factory == null) &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] Looking for a resource file of name [&quot; + SERVICE_ID + &quot;] to define the LogFactory subclass to use...&quot;); &#125; try &#123; // META-INF/services/org.apache.commons.logging.LogFactory, SERVICE_ID final InputStream is = getResourceAsStream(contextClassLoader, SERVICE_ID); if (is != null) &#123; // This code is needed by EBCDIC and other strange systems. // It&#x27;s a fix for bugs reported in xerces BufferedReader rd; try &#123; rd = new BufferedReader(new InputStreamReader(is, &quot;UTF-8&quot;)); &#125; catch (java.io.UnsupportedEncodingException e) &#123; rd = new BufferedReader(new InputStreamReader(is)); &#125; String factoryClassName = rd.readLine(); rd.close(); if (factoryClassName != null &amp;&amp; !&quot;&quot;.equals(factoryClassName)) &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] Creating an instance of LogFactory class &quot; + factoryClassName + &quot; as specified by file &#x27;&quot; + SERVICE_ID + &quot;&#x27; which was present in the path of the context classloader.&quot;); &#125; factory = newFactory(factoryClassName, baseClassLoader, contextClassLoader); &#125; &#125; else &#123; // is == null if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] No resource file with name &#x27;&quot; + SERVICE_ID + &quot;&#x27; found.&quot;); &#125; &#125; &#125; catch (Exception ex) &#123; // note: if the specified LogFactory class wasn&#x27;t compatible with LogFactory // for some reason, a ClassCastException will be caught here, and attempts will // continue to find a compatible class. if (isDiagnosticsEnabled()) &#123; logDiagnostic( &quot;[LOOKUP] A security exception occurred while trying to create an&quot; + &quot; instance of the custom factory class&quot; + &quot;: [&quot; + trim(ex.getMessage()) + &quot;]. Trying alternative implementations...&quot;); &#125; // ignore &#125; &#125; // ç¬¬ä¸‰ï¼Œå°è¯•ä»classpathæ ¹ç›®å½•ä¸‹çš„commons-logging.propertiesä¸­æŸ¥æ‰¾org.apache.commons.logging.LogFactoryå±æ€§æŒ‡å®šçš„factory // Third try looking into the properties file read earlier (if found) if (factory == null) &#123; if (props != null) &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic( &quot;[LOOKUP] Looking in properties file for entry with key &#x27;&quot; + FACTORY_PROPERTY + &quot;&#x27; to define the LogFactory subclass to use...&quot;); &#125; String factoryClass = props.getProperty(FACTORY_PROPERTY); if (factoryClass != null) &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic( &quot;[LOOKUP] Properties file specifies LogFactory subclass &#x27;&quot; + factoryClass + &quot;&#x27;&quot;); &#125; factory = newFactory(factoryClass, baseClassLoader, contextClassLoader); // TODO: think about whether we need to handle exceptions from newFactory &#125; else &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] Properties file has no entry specifying LogFactory subclass.&quot;); &#125; &#125; &#125; else &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic(&quot;[LOOKUP] No properties file available to determine&quot; + &quot; LogFactory subclass from..&quot;); &#125; &#125; &#125; // æœ€åï¼Œä½¿ç”¨åå¤‡factoryå®ç°ï¼Œorg.apache.commons.logging.impl.LogFactoryImpl // Fourth, try the fallback implementation class if (factory == null) &#123; if (isDiagnosticsEnabled()) &#123; logDiagnostic( &quot;[LOOKUP] Loading the default LogFactory implementation &#x27;&quot; + FACTORY_DEFAULT + &quot;&#x27; via the same classloader that loaded this LogFactory&quot; + &quot; class (ie not looking in the context classloader).&quot;); &#125; // Note: unlike the above code which can try to load custom LogFactory // implementations via the TCCL, we don&#x27;t try to load the default LogFactory // implementation via the context classloader because: // * that can cause problems (see comments in newFactory method) // * no-one should be customising the code of the default class // Yes, we do give up the ability for the child to ship a newer // version of the LogFactoryImpl class and have it used dynamically // by an old LogFactory class in the parent, but that isn&#x27;t // necessarily a good idea anyway. factory = newFactory(FACTORY_DEFAULT, thisClassLoader, contextClassLoader); &#125; if (factory != null) &#123; /** * Always cache using context class loader. */ cacheFactory(contextClassLoader, factory); if (props != null) &#123; Enumeration names = props.propertyNames(); while (names.hasMoreElements()) &#123; String name = (String) names.nextElement(); String value = props.getProperty(name); factory.setAttribute(name, value); &#125; &#125; &#125; return factory;&#125; å¯ä»¥çœ‹å‡ºï¼ŒæŠ½è±¡ç±»LogFactoryåŠ è½½å…·ä½“å®ç°çš„æ­¥éª¤å¦‚ä¸‹ï¼š ä»vmç³»ç»Ÿå±æ€§org.apache.commons.logging.LogFactory ä½¿ç”¨SPIæœåŠ¡å‘ç°æœºåˆ¶ï¼Œå‘ç°org.apache.commons.logging.LogFactoryçš„å®ç° æŸ¥æ‰¾classpathæ ¹ç›®å½•commons-logging.propertiesçš„org.apache.commons.logging.LogFactoryå±æ€§æ˜¯å¦æŒ‡å®šfactoryå®ç° ä½¿ç”¨é»˜è®¤factoryå®ç°ï¼Œorg.apache.commons.logging.impl.LogFactoryImpl LogFactoryçš„getLog()æ–¹æ³•è¿”å›ç±»å‹æ˜¯org.apache.commons.logging.Logæ¥å£ï¼Œæä¾›äº†ä»traceåˆ°fatalæ–¹æ³•ã€‚å¯ä»¥ç¡®å®šï¼Œå¦‚æœæ—¥å¿—å®ç°æä¾›è€…åªè¦å®ç°è¯¥æ¥å£ï¼Œå¹¶ä¸”ä½¿ç”¨ç»§æ‰¿è‡ªorg.apache.commons.logging.LogFactoryçš„å­ç±»åˆ›å»ºLogï¼Œå¿…ç„¶å¯ä»¥æ„å»ºä¸€ä¸ªæ¾è€¦åˆçš„æ—¥å¿—ç³»ç»Ÿã€‚ SPIæœºåˆ¶ - æ’ä»¶ä½“ç³» å…¶å®æœ€å…·spiæ€æƒ³çš„åº”è¯¥å±äºæ’ä»¶å¼€å‘ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸­ä¹Ÿç”¨åˆ°çš„è¿™ç§æ€æƒ³ï¼Œåé¢å†è¯´ï¼Œè¿™é‡Œå…·ä½“è¯´ä¸€ä¸‹eclipseçš„æ’ä»¶æ€æƒ³ã€‚ Eclipseä½¿ç”¨OSGiä½œä¸ºæ’ä»¶ç³»ç»Ÿçš„åŸºç¡€ï¼ŒåŠ¨æ€æ·»åŠ æ–°æ’ä»¶å’Œåœæ­¢ç°æœ‰æ’ä»¶ï¼Œä»¥åŠ¨æ€çš„æ–¹å¼ç®¡ç†ç»„ä»¶ç”Ÿå‘½å‘¨æœŸã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œæ’ä»¶çš„æ–‡ä»¶ç»“æ„å¿…é¡»åœ¨æŒ‡å®šç›®å½•ä¸‹åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š META-INF/MANIFEST.MF: é¡¹ç›®åŸºæœ¬é…ç½®ä¿¡æ¯ï¼Œç‰ˆæœ¬ã€åç§°ã€å¯åŠ¨å™¨ç­‰ build.properties: é¡¹ç›®çš„ç¼–è¯‘é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼Œæºä»£ç è·¯å¾„ã€è¾“å‡ºè·¯å¾„ plugin.xmlï¼šæ’ä»¶çš„æ“ä½œé…ç½®ä¿¡æ¯ï¼ŒåŒ…å«å¼¹å‡ºèœå•åŠç‚¹å‡»èœå•åå¯¹åº”çš„æ“ä½œæ‰§è¡Œç±»ç­‰ å½“eclipseå¯åŠ¨æ—¶ï¼Œä¼šéå†pluginsæ–‡ä»¶å¤¹ä¸­çš„ç›®å½•ï¼Œæ‰«ææ¯ä¸ªæ’ä»¶çš„æ¸…å•æ–‡ä»¶MANIFEST.MFï¼Œå¹¶å»ºç«‹ä¸€ä¸ªå†…éƒ¨æ¨¡å‹æ¥è®°å½•å®ƒæ‰€æ‰¾åˆ°çš„æ¯ä¸ªæ’ä»¶çš„ä¿¡æ¯ï¼Œå°±å®ç°äº†åŠ¨æ€æ·»åŠ æ–°çš„æ’ä»¶ã€‚ è¿™ä¹Ÿæ„å‘³ç€æ˜¯eclipseåˆ¶å®šäº†ä¸€ç³»åˆ—çš„è§„åˆ™ï¼Œåƒæ˜¯æ–‡ä»¶ç»“æ„ã€ç±»å‹ã€å‚æ•°ç­‰ã€‚æ’ä»¶å¼€å‘è€…éµå¾ªè¿™äº›è§„åˆ™å»å¼€å‘è‡ªå·±çš„æ’ä»¶ï¼Œeclipseå¹¶ä¸éœ€è¦çŸ¥é“æ’ä»¶å…·ä½“æ˜¯æ€æ ·å¼€å‘çš„ï¼Œåªéœ€è¦åœ¨å¯åŠ¨çš„æ—¶å€™æ ¹æ®é…ç½®æ–‡ä»¶è§£æã€åŠ è½½åˆ°ç³»ç»Ÿé‡Œå°±å¥½äº†ï¼Œæ˜¯spiæ€æƒ³çš„ä¸€ç§ä½“ç°ã€‚ SPIæœºåˆ¶ - Springä¸­SPIæœºåˆ¶åœ¨springbootçš„è‡ªåŠ¨è£…é…è¿‡ç¨‹ä¸­ï¼Œæœ€ç»ˆä¼šåŠ è½½META-INF/spring.factoriesæ–‡ä»¶ï¼Œè€ŒåŠ è½½çš„è¿‡ç¨‹æ˜¯ç”±SpringFactoriesLoaderåŠ è½½çš„ã€‚ä»CLASSPATHä¸‹çš„æ¯ä¸ªJaråŒ…ä¸­æœå¯»æ‰€æœ‰META-INF/spring.factoriesé…ç½®æ–‡ä»¶ï¼Œç„¶åå°†è§£æpropertiesæ–‡ä»¶ï¼Œæ‰¾åˆ°æŒ‡å®šåç§°çš„é…ç½®åè¿”å›ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¶å®è¿™é‡Œä¸ä»…ä»…æ˜¯ä¼šå»ClassPathè·¯å¾„ä¸‹æŸ¥æ‰¾ï¼Œä¼šæ‰«ææ‰€æœ‰è·¯å¾„ä¸‹çš„JaråŒ…ï¼Œåªä¸è¿‡è¿™ä¸ªæ–‡ä»¶åªä¼šåœ¨Classpathä¸‹çš„jaråŒ…ä¸­ã€‚ 1234567891011121314151617181920public static final String FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;;// spring.factoriesæ–‡ä»¶çš„æ ¼å¼ä¸ºï¼škey=value1,value2,value3// ä»æ‰€æœ‰çš„jaråŒ…ä¸­æ‰¾åˆ°META-INF/spring.factoriesæ–‡ä»¶// ç„¶åä»æ–‡ä»¶ä¸­è§£æå‡ºkey=factoryClassç±»åç§°çš„æ‰€æœ‰valueå€¼public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader) &#123; String factoryClassName = factoryClass.getName(); // å–å¾—èµ„æºæ–‡ä»¶çš„URL Enumeration&lt;URL&gt; urls = (classLoader != null ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) : ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION)); List&lt;String&gt; result = new ArrayList&lt;String&gt;(); // éå†æ‰€æœ‰çš„URL while (urls.hasMoreElements()) &#123; URL url = urls.nextElement(); // æ ¹æ®èµ„æºæ–‡ä»¶URLè§£æpropertiesæ–‡ä»¶ï¼Œå¾—åˆ°å¯¹åº”çš„ä¸€ç»„@Configurationç±» Properties properties = PropertiesLoaderUtils.loadProperties(new UrlResource(url)); String factoryClassNames = properties.getProperty(factoryClassName); // ç»„è£…æ•°æ®ï¼Œå¹¶è¿”å› result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames))); &#125; return result;&#125; SPIæœºåˆ¶æ·±å…¥ç†è§£ æç¤º æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£ä¸‹SPIç›¸å…³å†…å®¹ SPIæœºåˆ¶é€šå¸¸æ€ä¹ˆä½¿ç”¨çœ‹å®Œä¸Šé¢çš„å‡ ä¸ªä¾‹å­è§£æï¼Œåº”è¯¥éƒ½èƒ½çŸ¥é“å¤§æ¦‚çš„æµç¨‹äº†ï¼š æœ‰å…³ç»„ç»‡æˆ–è€…å…¬å¸å®šä¹‰æ ‡å‡†ã€‚ å…·ä½“å‚å•†æˆ–è€…æ¡†æ¶å¼€å‘è€…å®ç°ã€‚ ç¨‹åºçŒ¿ä½¿ç”¨ã€‚ å®šä¹‰æ ‡å‡†å®šä¹‰æ ‡å‡†ï¼Œå°±æ˜¯å®šä¹‰æ¥å£ã€‚æ¯”å¦‚æ¥å£java.sql.Driver å…·ä½“å‚å•†æˆ–è€…æ¡†æ¶å¼€å‘è€…å®ç°å‚å•†æˆ–è€…æ¡†æ¶å¼€å‘è€…å¼€å‘å…·ä½“çš„å®ç°ï¼š åœ¨META-INF/servicesç›®å½•ä¸‹å®šä¹‰ä¸€ä¸ªåå­—ä¸ºæ¥å£å…¨é™å®šåçš„æ–‡ä»¶ï¼Œæ¯”å¦‚java.sql.Driveræ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯å…·ä½“çš„å®ç°åå­—ï¼Œæ¯”å¦‚me.cxis.sql.MyDriverã€‚ å†™å…·ä½“çš„å®ç°me.cxis.sql.MyDriverï¼Œéƒ½æ˜¯å¯¹æ¥å£Driverçš„å®ç°ã€‚ ç¨‹åºçŒ¿ä½¿ç”¨æˆ‘ä»¬ä¼šå¼•ç”¨å…·ä½“å‚å•†çš„jaråŒ…æ¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½ï¼š 12345678ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);//è·å–è¿­ä»£å™¨Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();//éå†while(driversIterator.hasNext()) &#123; driversIterator.next(); //å¯ä»¥åšå…·ä½“çš„ä¸šåŠ¡é€»è¾‘&#125; ä½¿ç”¨è§„èŒƒæœ€åæ€»ç»“ä¸€ä¸‹jdk spiéœ€è¦éµå¾ªçš„è§„èŒƒ SPIå’ŒAPIçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ è¿™é‡Œå®é™…åŒ…å«ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªSPIå’ŒAPIçš„åŒºåˆ«ï¼Ÿç¬¬äºŒä¸ªä»€ä¹ˆæ—¶å€™ç”¨APIï¼Œä»€ä¹ˆæ—¶å€™ç”¨SPIï¼Ÿ SPI - â€œæ¥å£â€ä½äºâ€œè°ƒç”¨æ–¹â€æ‰€åœ¨çš„â€œåŒ…â€ä¸­ æ¦‚å¿µä¸Šæ›´ä¾èµ–è°ƒç”¨æ–¹ã€‚ ç»„ç»‡ä¸Šä½äºè°ƒç”¨æ–¹æ‰€åœ¨çš„åŒ…ä¸­ã€‚ å®ç°ä½äºç‹¬ç«‹çš„åŒ…ä¸­ã€‚ å¸¸è§çš„ä¾‹å­æ˜¯ï¼šæ’ä»¶æ¨¡å¼çš„æ’ä»¶ã€‚ API - â€œæ¥å£â€ä½äºâ€œå®ç°æ–¹â€æ‰€åœ¨çš„â€œåŒ…â€ä¸­ æ¦‚å¿µä¸Šæ›´æ¥è¿‘å®ç°æ–¹ã€‚ ç»„ç»‡ä¸Šä½äºå®ç°æ–¹æ‰€åœ¨çš„åŒ…ä¸­ã€‚ å®ç°å’Œæ¥å£åœ¨ä¸€ä¸ªåŒ…ä¸­ã€‚ å‚è€ƒï¼š difference-between-spi-and-apiåœ¨æ–°çª—å£æ‰“å¼€ è®¾è®¡åŸåˆ™ï¼šå°è®® SPI å’Œ APIåœ¨æ–°çª—å£æ‰“å¼€ SPIæœºåˆ¶å®ç°åŸç†ä¸å¦¨çœ‹ä¸‹JDKä¸­ServiceLoader&lt;S&gt;æ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259//ServiceLoaderå®ç°äº†Iterableæ¥å£ï¼Œå¯ä»¥éå†æ‰€æœ‰çš„æœåŠ¡å®ç°è€…public final class ServiceLoader&lt;S&gt; implements Iterable&lt;S&gt;&#123; //æŸ¥æ‰¾é…ç½®æ–‡ä»¶çš„ç›®å½• private static final String PREFIX = &quot;META-INF/services/&quot;; //è¡¨ç¤ºè¦è¢«åŠ è½½çš„æœåŠ¡çš„ç±»æˆ–æ¥å£ private final Class&lt;S&gt; service; //è¿™ä¸ªClassLoaderç”¨æ¥å®šä½ï¼ŒåŠ è½½ï¼Œå®ä¾‹åŒ–æœåŠ¡æä¾›è€… private final ClassLoader loader; // è®¿é—®æ§åˆ¶ä¸Šä¸‹æ–‡ private final AccessControlContext acc; // ç¼“å­˜å·²ç»è¢«å®ä¾‹åŒ–çš„æœåŠ¡æä¾›è€…ï¼ŒæŒ‰ç…§å®ä¾‹åŒ–çš„é¡ºåºå­˜å‚¨ private LinkedHashMap&lt;String,S&gt; providers = new LinkedHashMap&lt;&gt;(); // è¿­ä»£å™¨ private LazyIterator lookupIterator; //é‡æ–°åŠ è½½ï¼Œå°±ç›¸å½“äºé‡æ–°åˆ›å»ºServiceLoaderäº†ï¼Œç”¨äºæ–°çš„æœåŠ¡æä¾›è€…å®‰è£…åˆ°æ­£åœ¨è¿è¡Œçš„Javaè™šæ‹Ÿæœºä¸­çš„æƒ…å†µã€‚ public void reload() &#123; //æ¸…ç©ºç¼“å­˜ä¸­æ‰€æœ‰å·²å®ä¾‹åŒ–çš„æœåŠ¡æä¾›è€… providers.clear(); //æ–°å»ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¯¥è¿­ä»£å™¨ä¼šä»å¤´æŸ¥æ‰¾å’Œå®ä¾‹åŒ–æœåŠ¡æä¾›è€… lookupIterator = new LazyIterator(service, loader); &#125; //ç§æœ‰æ„é€ å™¨ //ä½¿ç”¨æŒ‡å®šçš„ç±»åŠ è½½å™¨å’ŒæœåŠ¡åˆ›å»ºæœåŠ¡åŠ è½½å™¨ //å¦‚æœæ²¡æœ‰æŒ‡å®šç±»åŠ è½½å™¨ï¼Œä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œå°±æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ã€‚ private ServiceLoader(Class&lt;S&gt; svc, ClassLoader cl) &#123; service = Objects.requireNonNull(svc, &quot;Service interface cannot be null&quot;); loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl; acc = (System.getSecurityManager() != null) ? AccessController.getContext() : null; reload(); &#125; //è§£æå¤±è´¥å¤„ç†çš„æ–¹æ³• private static void fail(Class&lt;?&gt; service, String msg, Throwable cause) throws ServiceConfigurationError &#123; throw new ServiceConfigurationError(service.getName() + &quot;: &quot; + msg, cause); &#125; private static void fail(Class&lt;?&gt; service, String msg) throws ServiceConfigurationError &#123; throw new ServiceConfigurationError(service.getName() + &quot;: &quot; + msg); &#125; private static void fail(Class&lt;?&gt; service, URL u, int line, String msg) throws ServiceConfigurationError &#123; fail(service, u + &quot;:&quot; + line + &quot;: &quot; + msg); &#125; //è§£ææœåŠ¡æä¾›è€…é…ç½®æ–‡ä»¶ä¸­çš„ä¸€è¡Œ //é¦–å…ˆå»æ‰æ³¨é‡Šæ ¡éªŒï¼Œç„¶åä¿å­˜ //è¿”å›ä¸‹ä¸€è¡Œè¡Œå· //é‡å¤çš„é…ç½®é¡¹å’Œå·²ç»è¢«å®ä¾‹åŒ–çš„é…ç½®é¡¹ä¸ä¼šè¢«ä¿å­˜ private int parseLine(Class&lt;?&gt; service, URL u, BufferedReader r, int lc, List&lt;String&gt; names) throws IOException, ServiceConfigurationError &#123; //è¯»å–ä¸€è¡Œ String ln = r.readLine(); if (ln == null) &#123; return -1; &#125; //#å·ä»£è¡¨æ³¨é‡Šè¡Œ int ci = ln.indexOf(&#x27;#&#x27;); if (ci &gt;= 0) ln = ln.substring(0, ci); ln = ln.trim(); int n = ln.length(); if (n != 0) &#123; if ((ln.indexOf(&#x27; &#x27;) &gt;= 0) || (ln.indexOf(&#x27;\\t&#x27;) &gt;= 0)) fail(service, u, lc, &quot;Illegal configuration-file syntax&quot;); int cp = ln.codePointAt(0); if (!Character.isJavaIdentifierStart(cp)) fail(service, u, lc, &quot;Illegal provider-class name: &quot; + ln); for (int i = Character.charCount(cp); i &lt; n; i += Character.charCount(cp)) &#123; cp = ln.codePointAt(i); if (!Character.isJavaIdentifierPart(cp) &amp;&amp; (cp != &#x27;.&#x27;)) fail(service, u, lc, &quot;Illegal provider-class name: &quot; + ln); &#125; if (!providers.containsKey(ln) &amp;&amp; !names.contains(ln)) names.add(ln); &#125; return lc + 1; &#125; //è§£æé…ç½®æ–‡ä»¶ï¼Œè§£ææŒ‡å®šçš„urlé…ç½®æ–‡ä»¶ //ä½¿ç”¨parseLineæ–¹æ³•è¿›è¡Œè§£æï¼Œæœªè¢«å®ä¾‹åŒ–çš„æœåŠ¡æä¾›è€…ä¼šè¢«ä¿å­˜åˆ°ç¼“å­˜ä¸­å» private Iterator&lt;String&gt; parse(Class&lt;?&gt; service, URL u) throws ServiceConfigurationError &#123; InputStream in = null; BufferedReader r = null; ArrayList&lt;String&gt; names = new ArrayList&lt;&gt;(); try &#123; in = u.openStream(); r = new BufferedReader(new InputStreamReader(in, &quot;utf-8&quot;)); int lc = 1; while ((lc = parseLine(service, u, r, lc, names)) &gt;= 0); &#125; return names.iterator(); &#125; //æœåŠ¡æä¾›è€…æŸ¥æ‰¾çš„è¿­ä»£å™¨ private class LazyIterator implements Iterator&lt;S&gt; &#123; Class&lt;S&gt; service;//æœåŠ¡æä¾›è€…æ¥å£ ClassLoader loader;//ç±»åŠ è½½å™¨ Enumeration&lt;URL&gt; configs = null;//ä¿å­˜å®ç°ç±»çš„url Iterator&lt;String&gt; pending = null;//ä¿å­˜å®ç°ç±»çš„å…¨å String nextName = null;//è¿­ä»£å™¨ä¸­ä¸‹ä¸€ä¸ªå®ç°ç±»çš„å…¨å private LazyIterator(Class&lt;S&gt; service, ClassLoader loader) &#123; this.service = service; this.loader = loader; &#125; private boolean hasNextService() &#123; if (nextName != null) &#123; return true; &#125; if (configs == null) &#123; try &#123; String fullName = PREFIX + service.getName(); if (loader == null) configs = ClassLoader.getSystemResources(fullName); else configs = loader.getResources(fullName); &#125; &#125; while ((pending == null) || !pending.hasNext()) &#123; if (!configs.hasMoreElements()) &#123; return false; &#125; pending = parse(service, configs.nextElement()); &#125; nextName = pending.next(); return true; &#125; private S nextService() &#123; if (!hasNextService()) throw new NoSuchElementException(); String cn = nextName; nextName = null; Class&lt;?&gt; c = null; try &#123; c = Class.forName(cn, false, loader); &#125; if (!service.isAssignableFrom(c)) &#123; fail(service, &quot;Provider &quot; + cn + &quot; not a subtype&quot;); &#125; try &#123; S p = service.cast(c.newInstance()); providers.put(cn, p); return p; &#125; &#125; public boolean hasNext() &#123; if (acc == null) &#123; return hasNextService(); &#125; else &#123; PrivilegedAction&lt;Boolean&gt; action = new PrivilegedAction&lt;Boolean&gt;() &#123; public Boolean run() &#123; return hasNextService(); &#125; &#125;; return AccessController.doPrivileged(action, acc); &#125; &#125; public S next() &#123; if (acc == null) &#123; return nextService(); &#125; else &#123; PrivilegedAction&lt;S&gt; action = new PrivilegedAction&lt;S&gt;() &#123; public S run() &#123; return nextService(); &#125; &#125;; return AccessController.doPrivileged(action, acc); &#125; &#125; public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125; //è·å–è¿­ä»£å™¨ //è¿”å›éå†æœåŠ¡æä¾›è€…çš„è¿­ä»£å™¨ //ä»¥æ‡’åŠ è½½çš„æ–¹å¼åŠ è½½å¯ç”¨çš„æœåŠ¡æä¾›è€… //æ‡’åŠ è½½çš„å®ç°æ˜¯ï¼šè§£æé…ç½®æ–‡ä»¶å’Œå®ä¾‹åŒ–æœåŠ¡æä¾›è€…çš„å·¥ä½œç”±è¿­ä»£å™¨æœ¬èº«å®Œæˆ public Iterator&lt;S&gt; iterator() &#123; return new Iterator&lt;S&gt;() &#123; //æŒ‰ç…§å®ä¾‹åŒ–é¡ºåºè¿”å›å·²ç»ç¼“å­˜çš„æœåŠ¡æä¾›è€…å®ä¾‹ Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders = providers.entrySet().iterator(); public boolean hasNext() &#123; if (knownProviders.hasNext()) return true; return lookupIterator.hasNext(); &#125; public S next() &#123; if (knownProviders.hasNext()) return knownProviders.next().getValue(); return lookupIterator.next(); &#125; public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125;; &#125; //ä¸ºæŒ‡å®šçš„æœåŠ¡ä½¿ç”¨æŒ‡å®šçš„ç±»åŠ è½½å™¨æ¥åˆ›å»ºä¸€ä¸ªServiceLoader public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service, ClassLoader loader) &#123; return new ServiceLoader&lt;&gt;(service, loader); &#125; //ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ç±»åŠ è½½å™¨æ¥åˆ›å»ºServiceLoader public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service) &#123; ClassLoader cl = Thread.currentThread().getContextClassLoader(); return ServiceLoader.load(service, cl); &#125; //ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ä¸ºæŒ‡å®šçš„æœåŠ¡åˆ›å»ºServiceLoader //åªèƒ½æ‰¾åˆ°å¹¶åŠ è½½å·²ç»å®‰è£…åˆ°å½“å‰Javaè™šæ‹Ÿæœºä¸­çš„æœåŠ¡æä¾›è€…ï¼Œåº”ç”¨ç¨‹åºç±»è·¯å¾„ä¸­çš„æœåŠ¡æä¾›è€…å°†è¢«å¿½ç•¥ public static &lt;S&gt; ServiceLoader&lt;S&gt; loadInstalled(Class&lt;S&gt; service) &#123; ClassLoader cl = ClassLoader.getSystemClassLoader(); ClassLoader prev = null; while (cl != null) &#123; prev = cl; cl = cl.getParent(); &#125; return ServiceLoader.load(service, prev); &#125; public String toString() &#123; return &quot;java.util.ServiceLoader[&quot; + service.getName() + &quot;]&quot;; &#125;&#125; é¦–å…ˆï¼ŒServiceLoaderå®ç°äº†Iterableæ¥å£ï¼Œæ‰€ä»¥å®ƒæœ‰è¿­ä»£å™¨çš„å±æ€§ï¼Œè¿™é‡Œä¸»è¦éƒ½æ˜¯å®ç°äº†è¿­ä»£å™¨çš„hasNextå’Œnextæ–¹æ³•ã€‚è¿™é‡Œä¸»è¦éƒ½æ˜¯è°ƒç”¨çš„lookupIteratorçš„ç›¸åº”hasNextå’Œnextæ–¹æ³•ï¼ŒlookupIteratoræ˜¯æ‡’åŠ è½½è¿­ä»£å™¨ã€‚ å…¶æ¬¡ï¼ŒLazyIteratorä¸­çš„hasNextæ–¹æ³•ï¼Œé™æ€å˜é‡PREFIXå°±æ˜¯â€META-INF/services/â€ç›®å½•ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦åœ¨classpathä¸‹çš„META-INF/services/ç›®å½•é‡Œåˆ›å»ºä¸€ä¸ªä»¥æœåŠ¡æ¥å£å‘½åçš„æ–‡ä»¶ã€‚ æœ€åï¼Œé€šè¿‡åå°„æ–¹æ³•Class.forName()åŠ è½½ç±»å¯¹è±¡ï¼Œå¹¶ç”¨newInstanceæ–¹æ³•å°†ç±»å®ä¾‹åŒ–ï¼Œå¹¶æŠŠå®ä¾‹åŒ–åçš„ç±»ç¼“å­˜åˆ°providerså¯¹è±¡ä¸­ï¼Œ(LinkedHashMap&lt;String,S&gt;ç±»å‹ï¼‰ç„¶åè¿”å›å®ä¾‹å¯¹è±¡ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ServiceLoaderä¸æ˜¯å®ä¾‹åŒ–ä»¥åï¼Œå°±å»è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„å…·ä½“å®ç°ï¼Œå¹¶è¿›è¡Œå®ä¾‹åŒ–ã€‚è€Œæ˜¯ç­‰åˆ°ä½¿ç”¨è¿­ä»£å™¨å»éå†çš„æ—¶å€™ï¼Œæ‰ä¼šåŠ è½½å¯¹åº”çš„é…ç½®æ–‡ä»¶å»è§£æï¼Œè°ƒç”¨hasNextæ–¹æ³•çš„æ—¶å€™ä¼šå»åŠ è½½é…ç½®æ–‡ä»¶è¿›è¡Œè§£æï¼Œè°ƒç”¨nextæ–¹æ³•çš„æ—¶å€™è¿›è¡Œå®ä¾‹åŒ–å¹¶ç¼“å­˜ã€‚ æ‰€æœ‰çš„é…ç½®æ–‡ä»¶åªä¼šåŠ è½½ä¸€æ¬¡ï¼ŒæœåŠ¡æä¾›è€…ä¹Ÿåªä¼šè¢«å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶å¯ä½¿ç”¨reloadæ–¹æ³•ã€‚ SPIæœºåˆ¶çš„ç¼ºé™·é€šè¿‡ä¸Šé¢çš„è§£æï¼Œå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬ä½¿ç”¨SPIæœºåˆ¶çš„ç¼ºé™·ï¼š ä¸èƒ½æŒ‰éœ€åŠ è½½ï¼Œéœ€è¦éå†æ‰€æœ‰çš„å®ç°ï¼Œå¹¶å®ä¾‹åŒ–ï¼Œç„¶ååœ¨å¾ªç¯ä¸­æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„å®ç°ã€‚å¦‚æœä¸æƒ³ç”¨æŸäº›å®ç°ç±»ï¼Œæˆ–è€…æŸäº›ç±»å®ä¾‹åŒ–å¾ˆè€—æ—¶ï¼Œå®ƒä¹Ÿè¢«è½½å…¥å¹¶å®ä¾‹åŒ–äº†ï¼Œè¿™å°±é€ æˆäº†æµªè´¹ã€‚ è·å–æŸä¸ªå®ç°ç±»çš„æ–¹å¼ä¸å¤Ÿçµæ´»ï¼Œåªèƒ½é€šè¿‡ Iterator å½¢å¼è·å–ï¼Œä¸èƒ½æ ¹æ®æŸä¸ªå‚æ•°æ¥è·å–å¯¹åº”çš„å®ç°ç±»ã€‚ å¤šä¸ªå¹¶å‘å¤šçº¿ç¨‹ä½¿ç”¨ ServiceLoader ç±»çš„å®ä¾‹æ˜¯ä¸å®‰å…¨çš„ã€‚ å‚è€ƒæ–‡ç«  https://cxis.me/2017/04/17/Java%E4%B8%ADSPI%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%85%A5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/ https://stackoverflow.com/questions/2954372/difference-between-spi-and-api?answertab=votes#tab-top https://zhuanlan.zhihu.com/p/28909673 http://blog.itpub.net/69912579/viewspace-2656555/ https://www.cnblogs.com/happyframework/archive/2013/09/17/3325560.html https://blog.csdn.net/sakurainluojia/article/details/53534949 https://www.jianshu.com/p/0d196ad23915","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"7.Java åŸºç¡€ - åå°„æœºåˆ¶è¯¦è§£","path":"/2023/12/25/7.Java-åŸºç¡€-åå°„æœºåˆ¶è¯¦è§£/","content":"JAVAåå°„æœºåˆ¶æ˜¯åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ï¼›è¿™ç§åŠ¨æ€è·å–çš„ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸ºjavaè¯­è¨€çš„åå°„æœºåˆ¶ã€‚Javaåå°„æœºåˆ¶åœ¨æ¡†æ¶è®¾è®¡ä¸­æä¸ºå¹¿æ³›ï¼Œéœ€è¦æ·±å…¥ç†è§£ã€‚æœ¬æ–‡ç»¼åˆå¤šç¯‡æ–‡ç« åï¼Œæ€»ç»“äº†Java åå°„çš„ç›¸å…³çŸ¥è¯†ï¼Œå¸Œæœ›å¯ä»¥æå‡ä½ å¯¹Javaä¸­åå°„çš„è®¤çŸ¥æ•ˆç‡ã€‚ åå°„åŸºç¡€RTTIï¼ˆRun-Time Type Identificationï¼‰è¿è¡Œæ—¶ç±»å‹è¯†åˆ«ã€‚åœ¨ã€ŠThinking in Javaã€‹ä¸€ä¹¦ç¬¬åå››ç« ä¸­æœ‰æåˆ°ï¼Œå…¶ä½œç”¨æ˜¯åœ¨è¿è¡Œæ—¶è¯†åˆ«ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹å’Œç±»çš„ä¿¡æ¯ã€‚ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼šä¸€ç§æ˜¯â€œä¼ ç»Ÿçš„â€RTTIï¼Œå®ƒå‡å®šæˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶å·²ç»çŸ¥é“äº†æ‰€æœ‰çš„ç±»å‹ï¼›å¦ä¸€ç§æ˜¯â€œåå°„â€æœºåˆ¶ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å‘ç°å’Œä½¿ç”¨ç±»çš„ä¿¡æ¯ã€‚ åå°„å°±æ˜¯æŠŠjavaç±»ä¸­çš„å„ç§æˆåˆ†æ˜ å°„æˆä¸€ä¸ªä¸ªçš„Javaå¯¹è±¡ ä¾‹å¦‚ï¼šä¸€ä¸ªç±»æœ‰ï¼šæˆå‘˜å˜é‡ã€æ–¹æ³•ã€æ„é€ æ–¹æ³•ã€åŒ…ç­‰ç­‰ä¿¡æ¯ï¼Œåˆ©ç”¨åå°„æŠ€æœ¯å¯ä»¥å¯¹ä¸€ä¸ªç±»è¿›è¡Œè§£å‰–ï¼ŒæŠŠä¸ªä¸ªç»„æˆéƒ¨åˆ†æ˜ å°„æˆä¸€ä¸ªä¸ªå¯¹è±¡ã€‚ è¿™é‡Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç†è§£ Classç±»ï¼Œä»¥åŠç±»çš„åŠ è½½æœºåˆ¶ï¼› ç„¶ååŸºäºæ­¤æˆ‘ä»¬å¦‚ä½•é€šè¿‡åå°„è·å–Classç±»ä»¥åŠç±»ä¸­çš„æˆå‘˜å˜é‡ã€æ–¹æ³•ã€æ„é€ æ–¹æ³•ç­‰ã€‚ Classç±»Classç±»ï¼ŒClassç±»ä¹Ÿæ˜¯ä¸€ä¸ªå®å®åœ¨åœ¨çš„ç±»ï¼Œå­˜åœ¨äºJDKçš„java.langåŒ…ä¸­ã€‚Classç±»çš„å®ä¾‹è¡¨ç¤ºjavaåº”ç”¨è¿è¡Œæ—¶çš„ç±»(class ans enum)æˆ–æ¥å£(interface and annotation)ï¼ˆæ¯ä¸ªjavaç±»è¿è¡Œæ—¶éƒ½åœ¨JVMé‡Œè¡¨ç°ä¸ºä¸€ä¸ªclasså¯¹è±¡ï¼Œå¯é€šè¿‡ç±»å.classã€ç±»å‹.getClass()ã€Class.forName(&quot;ç±»å&quot;)ç­‰æ–¹æ³•è·å–classå¯¹è±¡ï¼‰ã€‚æ•°ç»„åŒæ ·ä¹Ÿè¢«æ˜ å°„ä¸ºclass å¯¹è±¡çš„ä¸€ä¸ªç±»ï¼Œæ‰€æœ‰å…·æœ‰ç›¸åŒå…ƒç´ ç±»å‹å’Œç»´æ•°çš„æ•°ç»„éƒ½å…±äº«è¯¥ Class å¯¹è±¡ã€‚åŸºæœ¬ç±»å‹booleanï¼Œbyteï¼Œcharï¼Œshortï¼Œintï¼Œlongï¼Œfloatï¼Œdoubleå’Œå…³é”®å­—voidåŒæ ·è¡¨ç°ä¸º class å¯¹è±¡ã€‚ 1234567891011121314151617181920212223public final class Class&lt;T&gt; implements java.io.Serializable, GenericDeclaration, Type, AnnotatedElement &#123; private static final int ANNOTATION= 0x00002000; private static final int ENUM = 0x00004000; private static final int SYNTHETIC = 0x00001000; private static native void registerNatives(); static &#123; registerNatives(); &#125; /* * Private constructor. Only the Java Virtual Machine creates Class objects. //ç§æœ‰æ„é€ å™¨ï¼Œåªæœ‰JVMæ‰èƒ½è°ƒç”¨åˆ›å»ºClasså¯¹è±¡ * This constructor is not used and prevents the default constructor being * generated. */ private Class(ClassLoader loader) &#123; // Initialize final field for classLoader. The initialization value of non-null // prevents future JIT optimizations from assuming this final field is null. classLoader = loader; &#125; åˆ°è¿™æˆ‘ä»¬ä¹Ÿå°±å¯ä»¥å¾—å‡ºä»¥ä¸‹å‡ ç‚¹ä¿¡æ¯ï¼š Classç±»ä¹Ÿæ˜¯ç±»çš„ä¸€ç§ï¼Œä¸classå…³é”®å­—æ˜¯ä¸ä¸€æ ·çš„ã€‚ æ‰‹åŠ¨ç¼–å†™çš„ç±»è¢«ç¼–è¯‘åä¼šäº§ç”Ÿä¸€ä¸ªClasså¯¹è±¡ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯åˆ›å»ºçš„ç±»çš„ç±»å‹ä¿¡æ¯ï¼Œè€Œä¸”è¿™ä¸ªClasså¯¹è±¡ä¿å­˜åœ¨åŒå.classçš„æ–‡ä»¶ä¸­(å­—èŠ‚ç æ–‡ä»¶) æ¯ä¸ªé€šè¿‡å…³é”®å­—classæ ‡è¯†çš„ç±»ï¼Œåœ¨å†…å­˜ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„Classå¯¹è±¡æ¥æè¿°å…¶ç±»å‹ä¿¡æ¯ï¼Œæ— è®ºåˆ›å»ºå¤šå°‘ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå…¶ä¾æ®çš„éƒ½æ˜¯ç”¨ä¸€ä¸ªClasså¯¹è±¡ã€‚ Classç±»åªå­˜ç§æœ‰æ„é€ å‡½æ•°ï¼Œå› æ­¤å¯¹åº”Classå¯¹è±¡åªèƒ½æœ‰JVMåˆ›å»ºå’ŒåŠ è½½ Classç±»çš„å¯¹è±¡ä½œç”¨æ˜¯è¿è¡Œæ—¶æä¾›æˆ–è·å¾—æŸä¸ªå¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼Œè¿™ç‚¹å¯¹äºåå°„æŠ€æœ¯å¾ˆé‡è¦(å…³äºåå°„ç¨ååˆ†æ)ã€‚ [#ç±»åŠ è½½ç±»åŠ è½½æœºåˆ¶å’Œç±»å­—èŠ‚ç æŠ€æœ¯å¯ä»¥å‚è€ƒå¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š JVMåŸºç¡€ - ç±»å­—èŠ‚ç è¯¦è§£ æºä»£ç é€šè¿‡ç¼–è¯‘å™¨ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†é€šè¿‡ç±»åŠ è½½å­ç³»ç»Ÿè¿›è¡ŒåŠ è½½åˆ°JVMä¸­è¿è¡Œ JVMåŸºç¡€ - Java ç±»åŠ è½½æœºåˆ¶ è¿™ç¯‡æ–‡ç« å°†å¸¦ä½ æ·±å…¥ç†è§£Java ç±»åŠ è½½æœºåˆ¶ å…¶ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å›é¡¾çš„æ˜¯ï¼š ç±»åŠ è½½æœºåˆ¶æµç¨‹ ç±»çš„åŠ è½½ åå°„çš„ä½¿ç”¨ æç¤º åŸºäºæ­¤æˆ‘ä»¬å¦‚ä½•é€šè¿‡åå°„è·å–Classç±»å¯¹è±¡ä»¥åŠç±»ä¸­çš„æˆå‘˜å˜é‡ã€æ–¹æ³•ã€æ„é€ æ–¹æ³•ç­‰ åœ¨Javaä¸­ï¼ŒClassç±»ä¸java.lang.reflectç±»åº“ä¸€èµ·å¯¹åå°„æŠ€æœ¯è¿›è¡Œäº†å…¨åŠ›çš„æ”¯æŒã€‚åœ¨åå°„åŒ…ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ç±»ä¸»è¦æœ‰Constructorç±»è¡¨ç¤ºçš„æ˜¯Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»çš„æ„é€ æ–¹æ³•ï¼Œåˆ©ç”¨å®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºå¯¹è±¡ã€Fieldè¡¨ç¤ºClasså¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»çš„æˆå‘˜å˜é‡ï¼Œé€šè¿‡å®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹æˆå‘˜å˜é‡çš„å±æ€§å€¼(åŒ…å«private)ã€Methodè¡¨ç¤ºClasså¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»çš„æˆå‘˜æ–¹æ³•ï¼Œé€šè¿‡å®ƒå¯ä»¥åŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•(åŒ…å«private)ï¼Œä¸‹é¢å°†å¯¹è¿™å‡ ä¸ªé‡è¦ç±»è¿›è¡Œåˆ†åˆ«è¯´æ˜ã€‚ Classç±»å¯¹è±¡çš„è·å–åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œjvmä¼šåˆ›å»ºä¸€ä¸ªclasså¯¹è±¡ classå¯¹è±¡æ˜¯å¯ä»¥è¯´æ˜¯åå°„ä¸­æœ€å¸¸ç”¨çš„ï¼Œè·å–classå¯¹è±¡çš„æ–¹å¼çš„ä¸»è¦æœ‰ä¸‰ç§ æ ¹æ®ç±»åï¼šç±»å.class æ ¹æ®å¯¹è±¡ï¼šå¯¹è±¡.getClass() æ ¹æ®å…¨é™å®šç±»åï¼šClass.forName(å…¨é™å®šç±»å) 1234567891011121314151617181920212223242526272829303132333435363738394041@Testpublic void classTest() throws Exception &#123; // è·å–Classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ logger.info(&quot;æ ¹æ®ç±»å: \\t&quot; + User.class); logger.info(&quot;æ ¹æ®å¯¹è±¡: \\t&quot; + new User().getClass()); logger.info(&quot;æ ¹æ®å…¨é™å®šç±»å:\\t&quot; + Class.forName(&quot;com.test.User&quot;)); // å¸¸ç”¨çš„æ–¹æ³• logger.info(&quot;è·å–å…¨é™å®šç±»å:\\t&quot; + userClass.getName()); logger.info(&quot;è·å–ç±»å:\\t&quot; + userClass.getSimpleName()); logger.info(&quot;å®ä¾‹åŒ–:\\t&quot; + userClass.newInstance());&#125;// ...package com.test;public class User &#123; private String name = &quot;init&quot;; private int age; public User() &#123;&#125; public User(String name, int age) &#123; super(); this.name = name; this.age = age; &#125; private String getName() &#123; return name; &#125; private void setName(String name) &#123; this.name = name; &#125; public int getAge() &#123; return age; &#125; public void setAge(int age) &#123; this.age = age; &#125; @Override public String toString() &#123; return &quot;User [name=&quot; + name + &quot;, age=&quot; + age + &quot;]&quot;; &#125;&#125; è¾“å‡ºç»“æœï¼š 123456æ ¹æ®ç±»å: class com.test.Useræ ¹æ®å¯¹è±¡: class com.test.Useræ ¹æ®å…¨é™å®šç±»å:\tclass com.test.Userè·å–å…¨é™å®šç±»å:\tcom.test.Userè·å–ç±»å:\tUserå®ä¾‹åŒ–:\tUser [name=init, age=0] å†æ¥çœ‹çœ‹ Classç±»çš„æ–¹æ³• æ–¹æ³•å è¯´æ˜ forName() (1)è·å–Classå¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ï¼Œä½†å¼•ç”¨çš„ç±»è¿˜æ²¡æœ‰åŠ è½½(è¯¥ç±»çš„ç¬¬ä¸€ä¸ªå¯¹è±¡æ²¡æœ‰ç”Ÿæˆ)å°±åŠ è½½äº†è¿™ä¸ªç±»ã€‚ (2)ä¸ºäº†äº§ç”ŸClasså¼•ç”¨ï¼ŒforName()ç«‹å³å°±è¿›è¡Œäº†åˆå§‹åŒ–ã€‚ Object-getClass() è·å–Classå¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ï¼Œè¿”å›è¡¨ç¤ºè¯¥å¯¹è±¡çš„å®é™…ç±»å‹çš„Classå¼•ç”¨ã€‚ getName() å–å…¨é™å®šçš„ç±»å(åŒ…æ‹¬åŒ…å)ï¼Œå³ç±»çš„å®Œæ•´åå­—ã€‚ getSimpleName() è·å–ç±»å(ä¸åŒ…æ‹¬åŒ…å) getCanonicalName() è·å–å…¨é™å®šçš„ç±»å(åŒ…æ‹¬åŒ…å) isInterface() åˆ¤æ–­Classå¯¹è±¡æ˜¯å¦æ˜¯è¡¨ç¤ºä¸€ä¸ªæ¥å£ getInterfaces() è¿”å›Classå¯¹è±¡æ•°ç»„ï¼Œè¡¨ç¤ºClasså¯¹è±¡æ‰€å¼•ç”¨çš„ç±»æ‰€å®ç°çš„æ‰€æœ‰æ¥å£ã€‚ getSupercalss() è¿”å›Classå¯¹è±¡ï¼Œè¡¨ç¤ºClasså¯¹è±¡æ‰€å¼•ç”¨çš„ç±»æ‰€ç»§æ‰¿çš„ç›´æ¥åŸºç±»ã€‚åº”ç”¨è¯¥æ–¹æ³•å¯åœ¨è¿è¡Œæ—¶å‘ç°ä¸€ä¸ªå¯¹è±¡å®Œæ•´çš„ç»§æ‰¿ç»“æ„ã€‚ newInstance() è¿”å›ä¸€ä¸ªOjectå¯¹è±¡ï¼Œæ˜¯å®ç°â€œè™šæ‹Ÿæ„é€ å™¨â€çš„ä¸€ç§é€”å¾„ã€‚ä½¿ç”¨è¯¥æ–¹æ³•åˆ›å»ºçš„ç±»ï¼Œå¿…é¡»å¸¦æœ‰æ— å‚çš„æ„é€ å™¨ã€‚ getFields() è·å¾—æŸä¸ªç±»çš„æ‰€æœ‰çš„å…¬å…±ï¼ˆpublicï¼‰çš„å­—æ®µï¼ŒåŒ…æ‹¬ç»§æ‰¿è‡ªçˆ¶ç±»çš„æ‰€æœ‰å…¬å…±å­—æ®µã€‚ ç±»ä¼¼çš„è¿˜æœ‰getMethodså’ŒgetConstructorsã€‚ getDeclaredFields è·å¾—æŸä¸ªç±»çš„è‡ªå·±å£°æ˜çš„å­—æ®µï¼Œå³åŒ…æ‹¬publicã€privateå’Œprotecedï¼Œé»˜è®¤ä½†æ˜¯ä¸åŒ…æ‹¬çˆ¶ç±»å£°æ˜çš„ä»»ä½•å­—æ®µã€‚ç±»ä¼¼çš„è¿˜æœ‰getDeclaredMethodså’ŒgetDeclaredConstructorsã€‚ ç®€å•æµ‹è¯•ä¸‹ï¼ˆè¿™é‡Œä¾‹å­æºäºhttps://blog.csdn.net/mcryeasy/article/details/52344729ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677package com.cry;import java.lang.reflect.Field;interface I1 &#123;&#125;interface I2 &#123;&#125;class Cell&#123; public int mCellPublic;&#125;class Animal extends Cell&#123; private int mAnimalPrivate; protected int mAnimalProtected; int mAnimalDefault; public int mAnimalPublic; private static int sAnimalPrivate; protected static int sAnimalProtected; static int sAnimalDefault; public static int sAnimalPublic;&#125;class Dog extends Animal implements I1, I2 &#123; private int mDogPrivate; public int mDogPublic; protected int mDogProtected; private int mDogDefault; private static int sDogPrivate; protected static int sDogProtected; static int sDogDefault; public static int sDogPublic;&#125;public class Test &#123; public static void main(String[] args) throws IllegalAccessException, InstantiationException &#123; Class&lt;Dog&gt; dog = Dog.class; //ç±»åæ‰“å° System.out.println(dog.getName()); //com.cry.Dog System.out.println(dog.getSimpleName()); //Dog System.out.println(dog.getCanonicalName());//com.cry.Dog //æ¥å£ System.out.println(dog.isInterface()); //false for (Class iI : dog.getInterfaces()) &#123; System.out.println(iI); &#125; /* interface com.cry.I1 interface com.cry.I2 */ //çˆ¶ç±» System.out.println(dog.getSuperclass());//class com.cry.Animal //åˆ›å»ºå¯¹è±¡ Dog d = dog.newInstance(); //å­—æ®µ for (Field f : dog.getFields()) &#123; System.out.println(f.getName()); &#125; /* mDogPublic sDogPublic mAnimalPublic sAnimalPublic mCellPublic //çˆ¶ç±»çš„çˆ¶ç±»çš„å…¬å…±å­—æ®µä¹Ÿæ‰“å°å‡ºæ¥äº† */ System.out.println(&quot;---------&quot;); for (Field f : dog.getDeclaredFields()) &#123; System.out.println(f.getName()); &#125; /** åªæœ‰è‡ªå·±ç±»å£°æ˜çš„å­—æ®µ mDogPrivate mDogPublic mDogProtected mDogDefault sDogPrivate sDogProtected sDogDefault sDogPublic */ &#125;&#125; getNameã€getCanonicalNameä¸getSimpleNameçš„åŒºåˆ«ï¼š getSimpleNameï¼šåªè·å–ç±»å getNameï¼šç±»çš„å…¨é™å®šåï¼Œjvmä¸­Classçš„è¡¨ç¤ºï¼Œå¯ä»¥ç”¨äºåŠ¨æ€åŠ è½½Classå¯¹è±¡ï¼Œä¾‹å¦‚Class.forNameã€‚ getCanonicalNameï¼šè¿”å›æ›´å®¹æ˜“ç†è§£çš„è¡¨ç¤ºï¼Œä¸»è¦ç”¨äºè¾“å‡ºï¼ˆtoStringï¼‰æˆ–logæ‰“å°ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å’ŒgetNameä¸€æ ·ï¼Œä½†æ˜¯åœ¨å†…éƒ¨ç±»ã€æ•°ç»„ç­‰ç±»å‹çš„è¡¨ç¤ºå½¢å¼å°±ä¸åŒäº†ã€‚ 12345678910111213141516171819202122package com.cry;public class Test &#123; private class inner&#123; &#125; public static void main(String[] args) throws ClassNotFoundException &#123; //æ™®é€šç±» System.out.println(Test.class.getSimpleName()); //Test System.out.println(Test.class.getName()); //com.cry.Test System.out.println(Test.class.getCanonicalName()); //com.cry.Test //å†…éƒ¨ç±» System.out.println(inner.class.getSimpleName()); //inner System.out.println(inner.class.getName()); //com.cry.Test$inner System.out.println(inner.class.getCanonicalName()); //com.cry.Test.inner //æ•°ç»„ System.out.println(args.getClass().getSimpleName()); //String[] System.out.println(args.getClass().getName()); //[Ljava.lang.String; System.out.println(args.getClass().getCanonicalName()); //java.lang.String[] //æˆ‘ä»¬ä¸èƒ½ç”¨getCanonicalNameå»åŠ è½½ç±»å¯¹è±¡ï¼Œå¿…é¡»ç”¨getName //Class.forName(inner.class.getCanonicalName()); æŠ¥é”™ Class.forName(inner.class.getName()); &#125;&#125; Constructorç±»åŠå…¶ç”¨æ³• Constructorç±»å­˜åœ¨äºåå°„åŒ…(java.lang.reflect)ä¸­ï¼Œåæ˜ çš„æ˜¯Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»çš„æ„é€ æ–¹æ³•ã€‚ è·å–Constructorå¯¹è±¡æ˜¯é€šè¿‡Classç±»ä¸­çš„æ–¹æ³•è·å–çš„ï¼ŒClassç±»ä¸Constructorç›¸å…³çš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³•è¿”å›å€¼ æ–¹æ³•åç§° æ–¹æ³•è¯´æ˜ static Class&lt;?&gt; forName(String className) è¿”å›ä¸å¸¦æœ‰ç»™å®šå­—ç¬¦ä¸²åçš„ç±»æˆ–æ¥å£ç›¸å…³è”çš„ Class å¯¹è±¡ã€‚ Constructor getConstructor(Class&lt;?&gt;â€¦ parameterTypes) è¿”å›æŒ‡å®šå‚æ•°ç±»å‹ã€å…·æœ‰publicè®¿é—®æƒé™çš„æ„é€ å‡½æ•°å¯¹è±¡ Constructor&lt;?&gt;[] getConstructors() è¿”å›æ‰€æœ‰å…·æœ‰publicè®¿é—®æƒé™çš„æ„é€ å‡½æ•°çš„Constructorå¯¹è±¡æ•°ç»„ Constructor getDeclaredConstructor(Class&lt;?&gt;â€¦ parameterTypes) è¿”å›æŒ‡å®šå‚æ•°ç±»å‹ã€æ‰€æœ‰å£°æ˜çš„ï¼ˆåŒ…æ‹¬privateï¼‰æ„é€ å‡½æ•°å¯¹è±¡ Constructor&lt;?&gt;[] getDeclaredConstructors() è¿”å›æ‰€æœ‰å£°æ˜çš„ï¼ˆåŒ…æ‹¬privateï¼‰æ„é€ å‡½æ•°å¯¹è±¡ T newInstance() è°ƒç”¨æ— å‚æ„é€ å™¨åˆ›å»ºæ­¤ Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»çš„ä¸€ä¸ªæ–°å®ä¾‹ã€‚ ä¸‹é¢çœ‹ä¸€ä¸ªç®€å•ä¾‹å­æ¥äº†è§£Constructorå¯¹è±¡çš„ä½¿ç”¨ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101public class ConstructionTest implements Serializable &#123; public static void main(String[] args) throws Exception &#123; Class&lt;?&gt; clazz = null; //è·å–Classå¯¹è±¡çš„å¼•ç”¨ clazz = Class.forName(&quot;com.example.javabase.User&quot;); //ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå®ä¾‹åŒ–é»˜è®¤æ„é€ æ–¹æ³•ï¼ŒUserå¿…é¡»æ— å‚æ„é€ å‡½æ•°,å¦åˆ™å°†æŠ›å¼‚å¸¸ User user = (User) clazz.newInstance(); user.setAge(20); user.setName(&quot;Jack&quot;); System.out.println(user); System.out.println(&quot;--------------------------------------------&quot;); //è·å–å¸¦Stringå‚æ•°çš„publicæ„é€ å‡½æ•° Constructor cs1 =clazz.getConstructor(String.class); //åˆ›å»ºUser User user1= (User) cs1.newInstance(&quot;hiway&quot;); user1.setAge(22); System.out.println(&quot;user1:&quot;+user1.toString()); System.out.println(&quot;--------------------------------------------&quot;); //å–å¾—æŒ‡å®šå¸¦intå’ŒStringå‚æ•°æ„é€ å‡½æ•°,è¯¥æ–¹æ³•æ˜¯ç§æœ‰æ„é€ private Constructor cs2=clazz.getDeclaredConstructor(int.class,String.class); //ç”±äºæ˜¯privateå¿…é¡»è®¾ç½®å¯è®¿é—® cs2.setAccessible(true); //åˆ›å»ºuserå¯¹è±¡ User user2= (User) cs2.newInstance(25,&quot;hiway2&quot;); System.out.println(&quot;user2:&quot;+user2.toString()); System.out.println(&quot;--------------------------------------------&quot;); //è·å–æ‰€æœ‰æ„é€ åŒ…å«private Constructor&lt;?&gt; cons[] = clazz.getDeclaredConstructors(); // æŸ¥çœ‹æ¯ä¸ªæ„é€ æ–¹æ³•éœ€è¦çš„å‚æ•° for (int i = 0; i &lt; cons.length; i++) &#123; //è·å–æ„é€ å‡½æ•°å‚æ•°ç±»å‹ Class&lt;?&gt; clazzs[] = cons[i].getParameterTypes(); System.out.println(&quot;æ„é€ å‡½æ•°[&quot;+i+&quot;]:&quot;+cons[i].toString() ); System.out.print(&quot;å‚æ•°ç±»å‹[&quot;+i+&quot;]:(&quot;); for (int j = 0; j &lt; clazzs.length; j++) &#123; if (j == clazzs.length - 1) System.out.print(clazzs[j].getName()); else System.out.print(clazzs[j].getName() + &quot;,&quot;); &#125; System.out.println(&quot;)&quot;); &#125; &#125;&#125;class User &#123; private int age; private String name; public User() &#123; super(); &#125; public User(String name) &#123; super(); this.name = name; &#125; /** * ç§æœ‰æ„é€  * @param age * @param name */ private User(int age, String name) &#123; super(); this.age = age; this.name = name; &#125; public int getAge() &#123; return age; &#125; public void setAge(int age) &#123; this.age = age; &#125; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; @Override public String toString() &#123; return &quot;User&#123;&quot; + &quot;age=&quot; + age + &quot;, name=&#x27;&quot; + name + &#x27;\\&#x27;&#x27; + &#x27;&#125;&#x27;; &#125;&#125; è¾“å‡ºç»“æœ 12345678910111213/* output User&#123;age=20, name=&#x27;Jack&#x27;&#125;--------------------------------------------user1:User&#123;age=22, name=&#x27;hiway&#x27;&#125;--------------------------------------------user2:User&#123;age=25, name=&#x27;hiway2&#x27;&#125;--------------------------------------------æ„é€ å‡½æ•°[0]:private com.example.javabase.User(int,java.lang.String)å‚æ•°ç±»å‹[0]:(int,java.lang.String)æ„é€ å‡½æ•°[1]:public com.example.javabase.User(java.lang.String)å‚æ•°ç±»å‹[1]:(java.lang.String)æ„é€ å‡½æ•°[2]:public com.example.javabase.User()å‚æ•°ç±»å‹[2]:() å…³äº**Constructorç±»æœ¬èº«ä¸€äº›å¸¸ç”¨æ–¹æ³•**å¦‚ä¸‹(ä»…éƒ¨åˆ†ï¼Œå…¶ä»–å¯æŸ¥API) æ–¹æ³•è¿”å›å€¼ æ–¹æ³•åç§° æ–¹æ³•è¯´æ˜ Class getDeclaringClass() è¿”å› Class å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¡¨ç¤ºå£°æ˜ç”±æ­¤ Constructor å¯¹è±¡è¡¨ç¤ºçš„æ„é€ æ–¹æ³•çš„ç±»,å…¶å®å°±æ˜¯è¿”å›çœŸå®ç±»å‹ï¼ˆä¸åŒ…å«å‚æ•°ï¼‰ Type[] getGenericParameterTypes() æŒ‰ç…§å£°æ˜é¡ºåºè¿”å›ä¸€ç»„ Type å¯¹è±¡ï¼Œè¿”å›çš„å°±æ˜¯ Constructorå¯¹è±¡æ„é€ å‡½æ•°çš„å½¢å‚ç±»å‹ã€‚ String getName() ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›æ­¤æ„é€ æ–¹æ³•çš„åç§°ã€‚ Class&lt;?&gt;[] getParameterTypes() æŒ‰ç…§å£°æ˜é¡ºåºè¿”å›ä¸€ç»„ Class å¯¹è±¡ï¼Œå³è¿”å›Constructor å¯¹è±¡æ‰€è¡¨ç¤ºæ„é€ æ–¹æ³•çš„å½¢å‚ç±»å‹ T newInstance(Objectâ€¦ initargs) ä½¿ç”¨æ­¤ Constructorå¯¹è±¡è¡¨ç¤ºçš„æ„é€ å‡½æ•°æ¥åˆ›å»ºæ–°å®ä¾‹ String toGenericString() è¿”å›æè¿°æ­¤ Constructor çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…æ‹¬ç±»å‹å‚æ•°ã€‚ ä»£ç æ¼”ç¤ºå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425Constructor cs3 = clazz.getDeclaredConstructor(int.class,String.class);System.out.println(&quot;-----getDeclaringClass-----&quot;);Class uclazz=cs3.getDeclaringClass();//Constructorå¯¹è±¡è¡¨ç¤ºçš„æ„é€ æ–¹æ³•çš„ç±»System.out.println(&quot;æ„é€ æ–¹æ³•çš„ç±»:&quot;+uclazz.getName());System.out.println(&quot;-----getGenericParameterTypes-----&quot;);//å¯¹è±¡è¡¨ç¤ºæ­¤ Constructor å¯¹è±¡æ‰€è¡¨ç¤ºçš„æ–¹æ³•çš„å½¢å‚ç±»å‹Type[] tps=cs3.getGenericParameterTypes();for (Type tp:tps) &#123; System.out.println(&quot;å‚æ•°åç§°tp:&quot;+tp);&#125;System.out.println(&quot;-----getParameterTypes-----&quot;);//è·å–æ„é€ å‡½æ•°å‚æ•°ç±»å‹Class&lt;?&gt; clazzs[] = cs3.getParameterTypes();for (Class claz:clazzs) &#123; System.out.println(&quot;å‚æ•°åç§°:&quot;+claz.getName());&#125;System.out.println(&quot;-----getName-----&quot;);//ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›æ­¤æ„é€ æ–¹æ³•çš„åç§°System.out.println(&quot;getName:&quot;+cs3.getName());System.out.println(&quot;-----getoGenericString-----&quot;);//è¿”å›æè¿°æ­¤ Constructor çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…æ‹¬ç±»å‹å‚æ•°ã€‚System.out.println(&quot;getoGenericString():&quot;+cs3.toGenericString()); è¾“å‡ºç»“æœ 123456789101112-----getDeclaringClass-----æ„é€ æ–¹æ³•çš„ç±»:com.example.javabase.User-----getGenericParameterTypes-----å‚æ•°åç§°tp:intå‚æ•°åç§°tp:class java.lang.String-----getParameterTypes-----å‚æ•°åç§°:intå‚æ•°åç§°:java.lang.String-----getName-----getName:com.example.javabase.User-----getoGenericString-----getoGenericString():private com.example.javabase.User(int,java.lang.String) Fieldç±»åŠå…¶ç”¨æ³• Field æä¾›æœ‰å…³ç±»æˆ–æ¥å£çš„å•ä¸ªå­—æ®µçš„ä¿¡æ¯ï¼Œä»¥åŠå¯¹å®ƒçš„åŠ¨æ€è®¿é—®æƒé™ã€‚åå°„çš„å­—æ®µå¯èƒ½æ˜¯ä¸€ä¸ªç±»ï¼ˆé™æ€ï¼‰å­—æ®µæˆ–å®ä¾‹å­—æ®µã€‚ åŒæ ·çš„é“ç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Classç±»çš„æä¾›çš„æ–¹æ³•æ¥è·å–ä»£è¡¨å­—æ®µä¿¡æ¯çš„Fieldå¯¹è±¡ï¼ŒClassç±»ä¸Fieldå¯¹è±¡ç›¸å…³æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³•è¿”å›å€¼ æ–¹æ³•åç§° æ–¹æ³•è¯´æ˜ Field getDeclaredField(String name) è·å–æŒ‡å®šnameåç§°çš„(åŒ…å«privateä¿®é¥°çš„)å­—æ®µï¼Œä¸åŒ…æ‹¬ç»§æ‰¿çš„å­—æ®µ Field[] getDeclaredFields() è·å–Classå¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£çš„æ‰€æœ‰(åŒ…å«privateä¿®é¥°çš„)å­—æ®µ,ä¸åŒ…æ‹¬ç»§æ‰¿çš„å­—æ®µ Field getField(String name) è·å–æŒ‡å®šnameåç§°ã€å…·æœ‰publicä¿®é¥°çš„å­—æ®µï¼ŒåŒ…å«ç»§æ‰¿å­—æ®µ Field[] getFields() è·å–ä¿®é¥°ç¬¦ä¸ºpublicçš„å­—æ®µï¼ŒåŒ…å«ç»§æ‰¿å­—æ®µ ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†ä¸Šè¿°æ–¹æ³•çš„ä½¿ç”¨è¿‡ç¨‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class ReflectField &#123; public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException &#123; Class&lt;?&gt; clazz = Class.forName(&quot;reflect.Student&quot;); //è·å–æŒ‡å®šå­—æ®µåç§°çš„Fieldç±»,æ³¨æ„å­—æ®µä¿®é¥°ç¬¦å¿…é¡»ä¸ºpublicè€Œä¸”å­˜åœ¨è¯¥å­—æ®µ, // å¦åˆ™æŠ›NoSuchFieldException Field field = clazz.getField(&quot;age&quot;); System.out.println(&quot;field:&quot;+field); //è·å–æ‰€æœ‰ä¿®é¥°ç¬¦ä¸ºpublicçš„å­—æ®µ,åŒ…å«çˆ¶ç±»å­—æ®µ,æ³¨æ„ä¿®é¥°ç¬¦ä¸ºpublicæ‰ä¼šè·å– Field fields[] = clazz.getFields(); for (Field f:fields) &#123; System.out.println(&quot;f:&quot;+f.getDeclaringClass()); &#125; System.out.println(&quot;================getDeclaredFields====================&quot;); //è·å–å½“å‰ç±»æ‰€å­—æ®µ(åŒ…å«privateå­—æ®µ),æ³¨æ„ä¸åŒ…å«çˆ¶ç±»çš„å­—æ®µ Field fields2[] = clazz.getDeclaredFields(); for (Field f:fields2) &#123; System.out.println(&quot;f2:&quot;+f.getDeclaringClass()); &#125; //è·å–æŒ‡å®šå­—æ®µåç§°çš„Fieldç±»,å¯ä»¥æ˜¯ä»»æ„ä¿®é¥°ç¬¦çš„è‡ªåŠ¨,æ³¨æ„ä¸åŒ…å«çˆ¶ç±»çš„å­—æ®µ Field field2 = clazz.getDeclaredField(&quot;desc&quot;); System.out.println(&quot;field2:&quot;+field2); &#125; /** è¾“å‡ºç»“æœ: field:public int reflect.Person.age f:public java.lang.String reflect.Student.desc f:public int reflect.Person.age f:public java.lang.String reflect.Person.name ================getDeclaredFields==================== f2:public java.lang.String reflect.Student.desc f2:private int reflect.Student.score field2:public java.lang.String reflect.Student.desc */&#125;class Person&#123; public int age; public String name; //çœç•¥setå’Œgetæ–¹æ³•&#125;class Student extends Person&#123; public String desc; private int score; //çœç•¥setå’Œgetæ–¹æ³•&#125; ä¸Šè¿°æ–¹æ³•éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä¸æœŸæœ›è·å–å…¶çˆ¶ç±»çš„å­—æ®µï¼Œåˆ™éœ€ä½¿ç”¨Classç±»çš„getDeclaredField&#x2F;getDeclaredFieldsæ–¹æ³•æ¥è·å–å­—æ®µå³å¯ï¼Œå€˜è‹¥éœ€è¦è¿å¸¦è·å–åˆ°çˆ¶ç±»çš„å­—æ®µï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨Classç±»çš„getField&#x2F;getFieldsï¼Œä½†æ˜¯ä¹Ÿåªèƒ½è·å–åˆ°publicä¿®é¥°çš„çš„å­—æ®µï¼Œæ— æ³•è·å–çˆ¶ç±»çš„ç§æœ‰å­—æ®µã€‚ä¸‹é¢å°†é€šè¿‡Fieldç±»æœ¬èº«çš„æ–¹æ³•å¯¹æŒ‡å®šç±»å±æ€§èµ‹å€¼ï¼Œä»£ç æ¼”ç¤ºå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324//è·å–Classå¯¹è±¡å¼•ç”¨Class&lt;?&gt; clazz = Class.forName(&quot;reflect.Student&quot;);Student st= (Student) clazz.newInstance();//è·å–çˆ¶ç±»publicå­—æ®µå¹¶èµ‹å€¼Field ageField = clazz.getField(&quot;age&quot;);ageField.set(st,18);Field nameField = clazz.getField(&quot;name&quot;);nameField.set(st,&quot;Lily&quot;);//åªè·å–å½“å‰ç±»çš„å­—æ®µ,ä¸è·å–çˆ¶ç±»çš„å­—æ®µField descField = clazz.getDeclaredField(&quot;desc&quot;);descField.set(st,&quot;I am student&quot;);Field scoreField = clazz.getDeclaredField(&quot;score&quot;);//è®¾ç½®å¯è®¿é—®ï¼Œscoreæ˜¯privateçš„scoreField.setAccessible(true);scoreField.set(st,88);System.out.println(st.toString());//è¾“å‡ºç»“æœï¼šStudent&#123;age=18, name=&#x27;Lily ,desc=&#x27;I am student&#x27;, score=88&#125; //è·å–å­—æ®µå€¼System.out.println(scoreField.get(st));// 88 å…¶ä¸­çš„set(Object obj, Object value)æ–¹æ³•æ˜¯Fieldç±»æœ¬èº«çš„æ–¹æ³•ï¼Œç”¨äºè®¾ç½®å­—æ®µçš„å€¼ï¼Œè€Œget(Object obj)åˆ™æ˜¯è·å–å­—æ®µçš„å€¼ï¼Œå½“ç„¶å…³äºFieldç±»è¿˜æœ‰å…¶ä»–å¸¸ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³•è¿”å›å€¼ æ–¹æ³•åç§° æ–¹æ³•è¯´æ˜ void set(Object obj, Object value) å°†æŒ‡å®šå¯¹è±¡å˜é‡ä¸Šæ­¤ Field å¯¹è±¡è¡¨ç¤ºçš„å­—æ®µè®¾ç½®ä¸ºæŒ‡å®šçš„æ–°å€¼ã€‚ Object get(Object obj) è¿”å›æŒ‡å®šå¯¹è±¡ä¸Šæ­¤ Field è¡¨ç¤ºçš„å­—æ®µçš„å€¼ Class&lt;?&gt; getType() è¿”å›ä¸€ä¸ª Class å¯¹è±¡ï¼Œå®ƒæ ‡è¯†äº†æ­¤Field å¯¹è±¡æ‰€è¡¨ç¤ºå­—æ®µçš„å£°æ˜ç±»å‹ã€‚ boolean isEnumConstant() å¦‚æœæ­¤å­—æ®µè¡¨ç¤ºæšä¸¾ç±»å‹çš„å…ƒç´ åˆ™è¿”å› trueï¼›å¦åˆ™è¿”å› false String toGenericString() è¿”å›ä¸€ä¸ªæè¿°æ­¤ Fieldï¼ˆåŒ…æ‹¬å…¶ä¸€èˆ¬ç±»å‹ï¼‰çš„å­—ç¬¦ä¸² String getName() è¿”å›æ­¤ Field å¯¹è±¡è¡¨ç¤ºçš„å­—æ®µçš„åç§° Class&lt;?&gt; getDeclaringClass() è¿”å›è¡¨ç¤ºç±»æˆ–æ¥å£çš„ Class å¯¹è±¡ï¼Œè¯¥ç±»æˆ–æ¥å£å£°æ˜ç”±æ­¤ Field å¯¹è±¡è¡¨ç¤ºçš„å­—æ®µ void setAccessible(boolean flag) å°†æ­¤å¯¹è±¡çš„ accessible æ ‡å¿—è®¾ç½®ä¸ºæŒ‡ç¤ºçš„å¸ƒå°”å€¼,å³è®¾ç½®å…¶å¯è®¿é—®æ€§ ä¸Šè¿°æ–¹æ³•å¯èƒ½æ˜¯è¾ƒä¸ºå¸¸ç”¨çš„ï¼Œäº‹å®ä¸Šåœ¨è®¾ç½®å€¼çš„æ–¹æ³•ä¸Šï¼ŒFieldç±»è¿˜æä¾›äº†ä¸“é—¨é’ˆå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„æ–¹æ³•ï¼Œå¦‚setInt()/getInt()ã€setBoolean()/getBooleanã€setChar()/getChar()ç­‰ç­‰æ–¹æ³•ï¼Œè¿™é‡Œå°±ä¸å…¨éƒ¨åˆ—å‡ºäº†ï¼Œéœ€è¦æ—¶æŸ¥APIæ–‡æ¡£å³å¯ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯è¢«finalå…³é”®å­—ä¿®é¥°çš„Fieldå­—æ®µæ˜¯å®‰å…¨çš„ï¼Œåœ¨è¿è¡Œæ—¶å¯ä»¥æ¥æ”¶ä»»ä½•ä¿®æ”¹ï¼Œä½†æœ€ç»ˆå…¶å®é™…å€¼æ˜¯ä¸ä¼šå‘ç”Ÿæ”¹å˜çš„ã€‚ Methodç±»åŠå…¶ç”¨æ³• Method æä¾›å…³äºç±»æˆ–æ¥å£ä¸Šå•ç‹¬æŸä¸ªæ–¹æ³•ï¼ˆä»¥åŠå¦‚ä½•è®¿é—®è¯¥æ–¹æ³•ï¼‰çš„ä¿¡æ¯ï¼Œæ‰€åæ˜ çš„æ–¹æ³•å¯èƒ½æ˜¯ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•ï¼ˆåŒ…æ‹¬æŠ½è±¡æ–¹æ³•ï¼‰ã€‚ ä¸‹é¢æ˜¯Classç±»è·å–Methodå¯¹è±¡ç›¸å…³çš„æ–¹æ³•ï¼š æ–¹æ³•è¿”å›å€¼ æ–¹æ³•åç§° æ–¹æ³•è¯´æ˜ Method getDeclaredMethod(String name, Class&lt;?&gt;â€¦ parameterTypes) è¿”å›ä¸€ä¸ªæŒ‡å®šå‚æ•°çš„Methodå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åæ˜ æ­¤ Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£çš„æŒ‡å®šå·²å£°æ˜æ–¹æ³•ã€‚ Method[] getDeclaredMethods() è¿”å› Method å¯¹è±¡çš„ä¸€ä¸ªæ•°ç»„ï¼Œè¿™äº›å¯¹è±¡åæ˜ æ­¤ Class å¯¹è±¡è¡¨ç¤ºçš„ç±»æˆ–æ¥å£å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰æ–¹æ³•ï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚ Method getMethod(String name, Class&lt;?&gt;â€¦ parameterTypes) è¿”å›ä¸€ä¸ª Method å¯¹è±¡ï¼Œå®ƒåæ˜ æ­¤ Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£çš„æŒ‡å®šå…¬å…±æˆå‘˜æ–¹æ³•ã€‚ Method[] getMethods() è¿”å›ä¸€ä¸ªåŒ…å«æŸäº› Method å¯¹è±¡çš„æ•°ç»„ï¼Œè¿™äº›å¯¹è±¡åæ˜ æ­¤ Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£ï¼ˆåŒ…æ‹¬é‚£äº›ç”±è¯¥ç±»æˆ–æ¥å£å£°æ˜çš„ä»¥åŠä»è¶…ç±»å’Œè¶…æ¥å£ç»§æ‰¿çš„é‚£äº›çš„ç±»æˆ–æ¥å£ï¼‰çš„å…¬å…± member æ–¹æ³•ã€‚ åŒæ ·é€šè¿‡æ¡ˆä¾‹æ¼”ç¤ºä¸Šè¿°æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import java.lang.reflect.Method;public class ReflectMethod &#123; public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException &#123; Class clazz = Class.forName(&quot;reflect.Circle&quot;); //æ ¹æ®å‚æ•°è·å–publicçš„Method,åŒ…å«ç»§æ‰¿è‡ªçˆ¶ç±»çš„æ–¹æ³• Method method = clazz.getMethod(&quot;draw&quot;,int.class,String.class); System.out.println(&quot;method:&quot;+method); //è·å–æ‰€æœ‰publicçš„æ–¹æ³•: Method[] methods =clazz.getMethods(); for (Method m:methods)&#123; System.out.println(&quot;m::&quot;+m); &#125; System.out.println(&quot;=========================================&quot;); //è·å–å½“å‰ç±»çš„æ–¹æ³•åŒ…å«private,è¯¥æ–¹æ³•æ— æ³•è·å–ç»§æ‰¿è‡ªçˆ¶ç±»çš„method Method method1 = clazz.getDeclaredMethod(&quot;drawCircle&quot;); System.out.println(&quot;method1::&quot;+method1); //è·å–å½“å‰ç±»çš„æ‰€æœ‰æ–¹æ³•åŒ…å«private,è¯¥æ–¹æ³•æ— æ³•è·å–ç»§æ‰¿è‡ªçˆ¶ç±»çš„method Method[] methods1=clazz.getDeclaredMethods(); for (Method m:methods1)&#123; System.out.println(&quot;m1::&quot;+m); &#125; &#125;&#125;class Shape &#123; public void draw()&#123; System.out.println(&quot;draw&quot;); &#125; public void draw(int count , String name)&#123; System.out.println(&quot;draw &quot;+ name +&quot;,count=&quot;+count); &#125;&#125;class Circle extends Shape&#123; private void drawCircle()&#123; System.out.println(&quot;drawCircle&quot;); &#125; public int getAllCount()&#123; return 100; &#125;&#125; è¾“å‡ºç»“æœ: 1234567891011121314151617181920method:public void reflect.Shape.draw(int,java.lang.String)m::public int reflect.Circle.getAllCount()m::public void reflect.Shape.draw()m::public void reflect.Shape.draw(int,java.lang.String)m::public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedExceptionm::public final native void java.lang.Object.wait(long) throws java.lang.InterruptedExceptionm::public final void java.lang.Object.wait() throws java.lang.InterruptedExceptionm::public boolean java.lang.Object.equals(java.lang.Object)m::public java.lang.String java.lang.Object.toString()m::public native int java.lang.Object.hashCode()m::public final native java.lang.Class java.lang.Object.getClass()m::public final native void java.lang.Object.notify()m::public final native void java.lang.Object.notifyAll()=========================================method1::private void reflect.Circle.drawCircle()m1::public int reflect.Circle.getAllCount()m1::private void reflect.Circle.drawCircle() åœ¨é€šè¿‡getMethodsæ–¹æ³•è·å–Methodå¯¹è±¡æ—¶ï¼Œä¼šæŠŠçˆ¶ç±»çš„æ–¹æ³•ä¹Ÿè·å–åˆ°ï¼Œå¦‚ä¸Šçš„è¾“å‡ºç»“æœï¼ŒæŠŠObjectç±»çš„æ–¹æ³•éƒ½æ‰“å°å‡ºæ¥äº†ã€‚è€ŒgetDeclaredMethod/getDeclaredMethodsæ–¹æ³•éƒ½åªèƒ½è·å–å½“å‰ç±»çš„æ–¹æ³•ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶æ ¹æ®æƒ…å†µé€‰æ‹©å³å¯ã€‚ä¸‹é¢å°†æ¼”ç¤ºé€šè¿‡Methodå¯¹è±¡è°ƒç”¨æŒ‡å®šç±»çš„æ–¹æ³•ï¼š 1234567891011121314151617181920Class clazz = Class.forName(&quot;reflect.Circle&quot;);//åˆ›å»ºå¯¹è±¡Circle circle = (Circle) clazz.newInstance();//è·å–æŒ‡å®šå‚æ•°çš„æ–¹æ³•å¯¹è±¡MethodMethod method = clazz.getMethod(&quot;draw&quot;,int.class,String.class);//é€šè¿‡Methodå¯¹è±¡çš„invoke(Object obj,Object... args)æ–¹æ³•è°ƒç”¨method.invoke(circle,15,&quot;åœˆåœˆ&quot;);//å¯¹ç§æœ‰æ— å‚æ–¹æ³•çš„æ“ä½œMethod method1 = clazz.getDeclaredMethod(&quot;drawCircle&quot;);//ä¿®æ”¹ç§æœ‰æ–¹æ³•çš„è®¿é—®æ ‡è¯†method1.setAccessible(true);method1.invoke(circle);//å¯¹æœ‰è¿”å›å€¼å¾—æ–¹æ³•æ“ä½œMethod method2 =clazz.getDeclaredMethod(&quot;getAllCount&quot;);Integer count = (Integer) method2.invoke(circle);System.out.println(&quot;count:&quot;+count); è¾“å‡ºç»“æœ 123draw åœˆåœˆ,count=15drawCirclecount:100 åœ¨ä¸Šè¿°ä»£ç ä¸­è°ƒç”¨æ–¹æ³•ï¼Œä½¿ç”¨äº†Methodç±»çš„invoke(Object obj,Object... args)ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨è°ƒç”¨çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„è°ƒç”¨æ–¹æ³•çš„å‚æ•°ã€‚è¿™æ ·å°±å®Œæˆäº†ç±»æ–¹æ³•çš„åŠ¨æ€è°ƒç”¨ã€‚ æ–¹æ³•è¿”å›å€¼ æ–¹æ³•åç§° æ–¹æ³•è¯´æ˜ Object invoke(Object obj, Objectâ€¦ args) å¯¹å¸¦æœ‰æŒ‡å®šå‚æ•°çš„æŒ‡å®šå¯¹è±¡è°ƒç”¨ç”±æ­¤ Method å¯¹è±¡è¡¨ç¤ºçš„åº•å±‚æ–¹æ³•ã€‚ Class&lt;?&gt; getReturnType() è¿”å›ä¸€ä¸ª Class å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æè¿°äº†æ­¤ Method å¯¹è±¡æ‰€è¡¨ç¤ºçš„æ–¹æ³•çš„æ­£å¼è¿”å›ç±»å‹,å³æ–¹æ³•çš„è¿”å›ç±»å‹ Type getGenericReturnType() è¿”å›è¡¨ç¤ºç”±æ­¤ Method å¯¹è±¡æ‰€è¡¨ç¤ºæ–¹æ³•çš„æ­£å¼è¿”å›ç±»å‹çš„ Type å¯¹è±¡ï¼Œä¹Ÿæ˜¯æ–¹æ³•çš„è¿”å›ç±»å‹ã€‚ Class&lt;?&gt;[] getParameterTypes() æŒ‰ç…§å£°æ˜é¡ºåºè¿”å› Class å¯¹è±¡çš„æ•°ç»„ï¼Œè¿™äº›å¯¹è±¡æè¿°äº†æ­¤ Method å¯¹è±¡æ‰€è¡¨ç¤ºçš„æ–¹æ³•çš„å½¢å‚ç±»å‹ã€‚å³è¿”å›æ–¹æ³•çš„å‚æ•°ç±»å‹ç»„æˆçš„æ•°ç»„ Type[] getGenericParameterTypes() æŒ‰ç…§å£°æ˜é¡ºåºè¿”å› Type å¯¹è±¡çš„æ•°ç»„ï¼Œè¿™äº›å¯¹è±¡æè¿°äº†æ­¤ Method å¯¹è±¡æ‰€è¡¨ç¤ºçš„æ–¹æ³•çš„å½¢å‚ç±»å‹çš„ï¼Œä¹Ÿæ˜¯è¿”å›æ–¹æ³•çš„å‚æ•°ç±»å‹ String getName() ä»¥ String å½¢å¼è¿”å›æ­¤ Method å¯¹è±¡è¡¨ç¤ºçš„æ–¹æ³•åç§°ï¼Œå³è¿”å›æ–¹æ³•çš„åç§° boolean isVarArgs() åˆ¤æ–­æ–¹æ³•æ˜¯å¦å¸¦å¯å˜å‚æ•°ï¼Œå¦‚æœå°†æ­¤æ–¹æ³•å£°æ˜ä¸ºå¸¦æœ‰å¯å˜æ•°é‡çš„å‚æ•°ï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™ï¼Œè¿”å› falseã€‚ String toGenericString() è¿”å›æè¿°æ­¤ Method çš„å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬ç±»å‹å‚æ•°ã€‚ getReturnTypeæ–¹æ³•/getGenericReturnTypeæ–¹æ³•éƒ½æ˜¯è·å–Methodå¯¹è±¡è¡¨ç¤ºçš„æ–¹æ³•çš„è¿”å›ç±»å‹ï¼Œåªä¸è¿‡å‰è€…è¿”å›çš„Classç±»å‹åè€…è¿”å›çš„Type(å‰é¢å·²åˆ†æè¿‡)ï¼ŒTypeå°±æ˜¯ä¸€ä¸ªæ¥å£è€Œå·²ï¼Œåœ¨Java8ä¸­æ–°å¢ä¸€ä¸ªé»˜è®¤çš„æ–¹æ³•å®ç°ï¼Œè¿”å›çš„å°±å‚æ•°ç±»å‹ä¿¡æ¯ 123456public interface Type &#123; //1.8æ–°å¢ default String getTypeName() &#123; return toString(); &#125;&#125; è€ŒgetParameterTypes/getGenericParameterTypesä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œéƒ½æ˜¯è·å–Methodå¯¹è±¡æ‰€è¡¨ç¤ºçš„æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼Œå…¶ä»–æ–¹æ³•ä¸å‰é¢çš„Fieldå’ŒConstructoræ˜¯ç±»ä¼¼çš„ã€‚ åå°„æœºåˆ¶æ‰§è¡Œçš„æµç¨‹ è¿™éƒ¨åˆ†ä¸»è¦å‚è€ƒè‡ªhttps://www.cnblogs.com/yougewe/p/10125073.html å…ˆçœ‹ä¸ªä¾‹å­ 12345678910111213141516171819202122232425262728public class HelloReflect &#123; public static void main(String[] args) &#123; try &#123; // 1. ä½¿ç”¨å¤–éƒ¨é…ç½®çš„å®ç°ï¼Œè¿›è¡ŒåŠ¨æ€åŠ è½½ç±» TempFunctionTest test = (TempFunctionTest)Class.forName(&quot;com.tester.HelloReflect&quot;).newInstance(); test.sayHello(&quot;call directly&quot;); // 2. æ ¹æ®é…ç½®çš„å‡½æ•°åï¼Œè¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼ˆä¸éœ€è¦é€šç”¨çš„æ¥å£æŠ½è±¡ï¼‰ Object t2 = new TempFunctionTest(); Method method = t2.getClass().getDeclaredMethod(&quot;sayHello&quot;, String.class); method.invoke(test, &quot;method invoke&quot;); &#125; catch (ClassNotFoundException e) &#123; e.printStackTrace(); &#125; catch (InstantiationException e) &#123; e.printStackTrace(); &#125; catch (IllegalAccessException e) &#123; e.printStackTrace(); &#125; catch (NoSuchMethodException e ) &#123; e.printStackTrace(); &#125; catch (InvocationTargetException e) &#123; e.printStackTrace(); &#125; &#125; public void sayHello(String word) &#123; System.out.println(&quot;hello,&quot; + word); &#125;&#125; æ¥çœ‹æ‰§è¡Œæµç¨‹ åå°„è·å–ç±»å®ä¾‹é¦–å…ˆè°ƒç”¨äº† java.lang.Class çš„é™æ€æ–¹æ³•ï¼Œè·å–ç±»ä¿¡æ¯ã€‚ 12345678@CallerSensitivepublic static Class&lt;?&gt; forName(String className) throws ClassNotFoundException &#123; // å…ˆé€šè¿‡åå°„ï¼Œè·å–è°ƒç”¨è¿›æ¥çš„ç±»ä¿¡æ¯ï¼Œä»è€Œè·å–å½“å‰çš„ classLoader Class&lt;?&gt; caller = Reflection.getCallerClass(); // è°ƒç”¨nativeæ–¹æ³•è¿›è¡Œè·å–classä¿¡æ¯ return forName0(className, true, ClassLoader.getClassLoader(caller), caller);&#125; forName()åå°„è·å–ç±»ä¿¡æ¯ï¼Œå¹¶æ²¡æœ‰å°†å®ç°ç•™ç»™äº†java,è€Œæ˜¯äº¤ç»™äº†jvmå»åŠ è½½ã€‚ ä¸»è¦æ˜¯å…ˆè·å– ClassLoader, ç„¶åè°ƒç”¨ native æ–¹æ³•ï¼Œè·å–ä¿¡æ¯ï¼ŒåŠ è½½ç±»åˆ™æ˜¯å›è°ƒ java.lang.ClassLoader. æœ€åï¼Œjvmåˆä¼šå›è°ƒ ClassLoader è¿›ç±»åŠ è½½ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091// public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException &#123; return loadClass(name, false);&#125; // sun.misc.Launcher public Class&lt;?&gt; loadClass(String var1, boolean var2) throws ClassNotFoundException &#123; int var3 = var1.lastIndexOf(46); if(var3 != -1) &#123; SecurityManager var4 = System.getSecurityManager(); if(var4 != null) &#123; var4.checkPackageAccess(var1.substring(0, var3)); &#125; &#125; if(this.ucp.knownToNotExist(var1)) &#123; Class var5 = this.findLoadedClass(var1); if(var5 != null) &#123; if(var2) &#123; this.resolveClass(var5); &#125; return var5; &#125; else &#123; throw new ClassNotFoundException(var1); &#125; &#125; else &#123; return super.loadClass(var1, var2); &#125; &#125;// java.lang.ClassLoaderprotected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException&#123; // å…ˆè·å–é” synchronized (getClassLoadingLock(name)) &#123; // First, check if the class has already been loaded // å¦‚æœå·²ç»åŠ è½½äº†çš„è¯ï¼Œå°±ä¸ç”¨å†åŠ è½½äº† Class&lt;?&gt; c = findLoadedClass(name); if (c == null) &#123; long t0 = System.nanoTime(); try &#123; // åŒäº²å§”æ‰˜åŠ è½½ if (parent != null) &#123; c = parent.loadClass(name, false); &#125; else &#123; c = findBootstrapClassOrNull(name); &#125; &#125; catch (ClassNotFoundException e) &#123; // ClassNotFoundException thrown if class not found // from the non-null parent class loader &#125; // çˆ¶ç±»æ²¡æœ‰åŠ è½½åˆ°æ—¶ï¼Œå†è‡ªå·±åŠ è½½ if (c == null) &#123; // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); c = findClass(name); // this is the defining class loader; record the stats sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0); sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); &#125; &#125; if (resolve) &#123; resolveClass(c); &#125; return c; &#125;&#125;protected Object getClassLoadingLock(String className) &#123; Object lock = this; if (parallelLockMap != null) &#123; // ä½¿ç”¨ ConcurrentHashMapæ¥ä¿å­˜é” Object newLock = new Object(); lock = parallelLockMap.putIfAbsent(className, newLock); if (lock == null) &#123; lock = newLock; &#125; &#125; return lock;&#125;protected final Class&lt;?&gt; findLoadedClass(String name) &#123; if (!checkName(name)) return null; return findLoadedClass0(name);&#125; ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ newInstance() çš„å®ç°æ–¹å¼ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162// é¦–å…ˆè‚¯å®šæ˜¯ Class.newInstance@CallerSensitivepublic T newInstance() throws InstantiationException, IllegalAccessException&#123; if (System.getSecurityManager() != null) &#123; checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), false); &#125; // NOTE: the following code may not be strictly correct under // the current Java memory model. // Constructor lookup // newInstance() å…¶å®ç›¸å½“äºè°ƒç”¨ç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ï¼Œé¦–å…ˆè¦æ‰¾åˆ°å…¶æ— å‚æ„é€ å™¨ if (cachedConstructor == null) &#123; if (this == Class.class) &#123; // ä¸å…è®¸è°ƒç”¨ Class çš„ newInstance() æ–¹æ³• throw new IllegalAccessException( &quot;Can not call newInstance() on the Class for java.lang.Class&quot; ); &#125; try &#123; // è·å–æ— å‚æ„é€ å™¨ Class&lt;?&gt;[] empty = &#123;&#125;; final Constructor&lt;T&gt; c = getConstructor0(empty, Member.DECLARED); // Disable accessibility checks on the constructor // since we have to do the security check here anyway // (the stack depth is wrong for the Constructor&#x27;s // security check to work) java.security.AccessController.doPrivileged( new java.security.PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; c.setAccessible(true); return null; &#125; &#125;); cachedConstructor = c; &#125; catch (NoSuchMethodException e) &#123; throw (InstantiationException) new InstantiationException(getName()).initCause(e); &#125; &#125; Constructor&lt;T&gt; tmpConstructor = cachedConstructor; // Security check (same as in java.lang.reflect.Constructor) int modifiers = tmpConstructor.getModifiers(); if (!Reflection.quickCheckMemberAccess(this, modifiers)) &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); if (newInstanceCallerCache != caller) &#123; Reflection.ensureMemberAccess(caller, this, null, modifiers); newInstanceCallerCache = caller; &#125; &#125; // Run constructor try &#123; // è°ƒç”¨æ— å‚æ„é€ å™¨ return tmpConstructor.newInstance((Object[])null); &#125; catch (InvocationTargetException e) &#123; Unsafe.getUnsafe().throwException(e.getTargetException()); // Not reached return null; &#125;&#125; newInstance() ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š æƒé™æ£€æµ‹ï¼Œå¦‚æœä¸é€šè¿‡ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼› æŸ¥æ‰¾æ— å‚æ„é€ å™¨ï¼Œå¹¶å°†å…¶ç¼“å­˜èµ·æ¥ï¼› è°ƒç”¨å…·ä½“æ–¹æ³•çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œç”Ÿæˆå®ä¾‹å¹¶è¿”å›ï¼› ä¸‹é¢æ˜¯è·å–æ„é€ å™¨çš„è¿‡ç¨‹ï¼š 12345678910111213private Constructor&lt;T&gt; getConstructor0(Class&lt;?&gt;[] parameterTypes, int which) throws NoSuchMethodException&#123; // è·å–æ‰€æœ‰æ„é€ å™¨ Constructor&lt;T&gt;[] constructors = privateGetDeclaredConstructors((which == Member.PUBLIC)); for (Constructor&lt;T&gt; constructor : constructors) &#123; if (arrayContentsEq(parameterTypes, constructor.getParameterTypes())) &#123; return getReflectionFactory().copyConstructor(constructor); &#125; &#125; throw new NoSuchMethodException(getName() + &quot;.&lt;init&gt;&quot; + argumentTypesToString(parameterTypes));&#125; getConstructor0() ä¸ºè·å–åŒ¹é…çš„æ„é€ æ–¹å™¨ï¼›åˆ†ä¸‰æ­¥ï¼š å…ˆè·å–æ‰€æœ‰çš„constructors, ç„¶åé€šè¿‡è¿›è¡Œå‚æ•°ç±»å‹æ¯”è¾ƒï¼› æ‰¾åˆ°åŒ¹é…åï¼Œé€šè¿‡ ReflectionFactory copyä¸€ä»½constructorè¿”å›ï¼› å¦åˆ™æŠ›å‡º NoSuchMethodException; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172// è·å–å½“å‰ç±»æ‰€æœ‰çš„æ„é€ æ–¹æ³•ï¼Œé€šè¿‡jvmæˆ–è€…ç¼“å­˜// Returns an array of &quot;root&quot; constructors. These Constructor// objects must NOT be propagated to the outside world, but must// instead be copied via ReflectionFactory.copyConstructor.private Constructor&lt;T&gt;[] privateGetDeclaredConstructors(boolean publicOnly) &#123; checkInitted(); Constructor&lt;T&gt;[] res; // è°ƒç”¨ reflectionData(), è·å–ä¿å­˜çš„ä¿¡æ¯ï¼Œä½¿ç”¨è½¯å¼•ç”¨ä¿å­˜ï¼Œä»è€Œä½¿å†…å­˜ä¸å¤Ÿå¯ä»¥å›æ”¶ ReflectionData&lt;T&gt; rd = reflectionData(); if (rd != null) &#123; res = publicOnly ? rd.publicConstructors : rd.declaredConstructors; // å­˜åœ¨ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å› if (res != null) return res; &#125; // No cached value available; request value from VM if (isInterface()) &#123; @SuppressWarnings(&quot;unchecked&quot;) Constructor&lt;T&gt;[] temporaryRes = (Constructor&lt;T&gt;[]) new Constructor&lt;?&gt;[0]; res = temporaryRes; &#125; else &#123; // ä½¿ç”¨nativeæ–¹æ³•ä»jvmè·å–æ„é€ å™¨ res = getDeclaredConstructors0(publicOnly); &#125; if (rd != null) &#123; // æœ€åï¼Œå°†ä»jvmä¸­è¯»å–çš„å†…å®¹ï¼Œå­˜å…¥ç¼“å­˜ if (publicOnly) &#123; rd.publicConstructors = res; &#125; else &#123; rd.declaredConstructors = res; &#125; &#125; return res;&#125;// Lazily create and cache ReflectionDataprivate ReflectionData&lt;T&gt; reflectionData() &#123; SoftReference&lt;ReflectionData&lt;T&gt;&gt; reflectionData = this.reflectionData; int classRedefinedCount = this.classRedefinedCount; ReflectionData&lt;T&gt; rd; if (useCaches &amp;&amp; reflectionData != null &amp;&amp; (rd = reflectionData.get()) != null &amp;&amp; rd.redefinedCount == classRedefinedCount) &#123; return rd; &#125; // else no SoftReference or cleared SoftReference or stale ReflectionData // -&gt; create and replace new instance return newReflectionData(reflectionData, classRedefinedCount);&#125;// æ–°åˆ›å»ºç¼“å­˜ï¼Œä¿å­˜åå°„ä¿¡æ¯private ReflectionData&lt;T&gt; newReflectionData(SoftReference&lt;ReflectionData&lt;T&gt;&gt; oldReflectionData, int classRedefinedCount) &#123; if (!useCaches) return null; // ä½¿ç”¨casä¿è¯æ›´æ–°çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œæ‰€ä»¥åå°„æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„ while (true) &#123; ReflectionData&lt;T&gt; rd = new ReflectionData&lt;&gt;(classRedefinedCount); // try to CAS it... if (Atomic.casReflectionData(this, oldReflectionData, new SoftReference&lt;&gt;(rd))) &#123; return rd; &#125; // å…ˆä½¿ç”¨CASæ›´æ–°ï¼Œå¦‚æœæ›´æ–°æˆåŠŸï¼Œåˆ™ç«‹å³è¿”å›ï¼Œå¦åˆ™æµ‹æŸ¥å½“å‰å·²è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°çš„æƒ…å†µï¼Œå¦‚æœå’Œè‡ªå·±æƒ³è¦æ›´æ–°çš„çŠ¶æ€ä¸€è‡´ï¼Œåˆ™ä¹Ÿç®—æ˜¯æˆåŠŸäº† oldReflectionData = this.reflectionData; classRedefinedCount = this.classRedefinedCount; if (oldReflectionData != null &amp;&amp; (rd = oldReflectionData.get()) != null &amp;&amp; rd.redefinedCount == classRedefinedCount) &#123; return rd; &#125; &#125;&#125; å¦‚ä¸Šï¼ŒprivateGetDeclaredConstructors(), è·å–æ‰€æœ‰çš„æ„é€ å™¨ä¸»è¦æ­¥éª¤ï¼› å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼› å¦‚æœç¼“å­˜æ²¡æœ‰ï¼Œåˆ™ä»jvmä¸­é‡æ–°è·å–ï¼Œå¹¶å­˜å…¥ç¼“å­˜ï¼Œç¼“å­˜ä½¿ç”¨è½¯å¼•ç”¨è¿›è¡Œä¿å­˜ï¼Œä¿è¯å†…å­˜å¯ç”¨ï¼› å¦å¤–ï¼Œä½¿ç”¨ relactionData() è¿›è¡Œç¼“å­˜ä¿å­˜ï¼›ReflectionData çš„æ•°æ®ç»“æ„å¦‚ä¸‹ã€‚ 1234567891011121314151617181920// reflection data that might get invalidated when JVM TI RedefineClasses() is calledprivate static class ReflectionData&lt;T&gt; &#123; volatile Field[] declaredFields; volatile Field[] publicFields; volatile Method[] declaredMethods; volatile Method[] publicMethods; volatile Constructor&lt;T&gt;[] declaredConstructors; volatile Constructor&lt;T&gt;[] publicConstructors; // Intermediate results for getFields and getMethods volatile Field[] declaredPublicFields; volatile Method[] declaredPublicMethods; volatile Class&lt;?&gt;[] interfaces; // Value of classRedefinedCount when we created this ReflectionData instance final int redefinedCount; ReflectionData(int redefinedCount) &#123; this.redefinedCount = redefinedCount; &#125;&#125; å…¶ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªç‚¹ï¼Œå°±æ˜¯å¦‚ä½•æ¯”è¾ƒæ„é€ æ˜¯å¦æ˜¯è¦æŸ¥æ‰¾æ„é€ å™¨ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç±»å‹å®Œæˆç›¸ç­‰å°±å®Œäº†ï¼Œæœ‰ä¸€ä¸ªä¸ç›¸ç­‰åˆ™è¿”å›falseã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253private static boolean arrayContentsEq(Object[] a1, Object[] a2) &#123; if (a1 == null) &#123; return a2 == null || a2.length == 0; &#125; if (a2 == null) &#123; return a1.length == 0; &#125; if (a1.length != a2.length) &#123; return false; &#125; for (int i = 0; i &lt; a1.length; i++) &#123; if (a1[i] != a2[i]) &#123; return false; &#125; &#125; return true;&#125;// sun.reflect.ReflectionFactory/** Makes a copy of the passed constructor. The returned constructor is a &quot;child&quot; of the passed one; see the comments in Constructor.java for details. */public &lt;T&gt; Constructor&lt;T&gt; copyConstructor(Constructor&lt;T&gt; arg) &#123; return langReflectAccess().copyConstructor(arg);&#125;// java.lang.reflect.Constructor, copy å…¶å®å°±æ˜¯æ–°newä¸€ä¸ª Constructor å‡ºæ¥Constructor&lt;T&gt; copy() &#123; // This routine enables sharing of ConstructorAccessor objects // among Constructor objects which refer to the same underlying // method in the VM. (All of this contortion is only necessary // because of the &quot;accessibility&quot; bit in AccessibleObject, // which implicitly requires that new java.lang.reflect // objects be fabricated for each reflective call on Class // objects.) if (this.root != null) throw new IllegalArgumentException(&quot;Can not copy a non-root Constructor&quot;); Constructor&lt;T&gt; res = new Constructor&lt;&gt;(clazz, parameterTypes, exceptionTypes, modifiers, slot, signature, annotations, parameterAnnotations); // root æŒ‡å‘å½“å‰ constructor res.root = this; // Might as well eagerly propagate this if already present res.constructorAccessor = constructorAccessor; return res;&#125; é€šè¿‡ä¸Šé¢ï¼Œè·å–åˆ° Constructor äº†ã€‚ æ¥ä¸‹æ¥å°±åªéœ€è°ƒç”¨å…¶ç›¸åº”æ„é€ å™¨çš„ newInstance()ï¼Œå³è¿”å›å®ä¾‹äº†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354// return tmpConstructor.newInstance((Object[])null); // java.lang.reflect.Constructor@CallerSensitivepublic T newInstance(Object ... initargs) throws InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException&#123; if (!override) &#123; if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, null, modifiers); &#125; &#125; if ((clazz.getModifiers() &amp; Modifier.ENUM) != 0) throw new IllegalArgumentException(&quot;Cannot reflectively create enum objects&quot;); ConstructorAccessor ca = constructorAccessor; // read volatile if (ca == null) &#123; ca = acquireConstructorAccessor(); &#125; @SuppressWarnings(&quot;unchecked&quot;) T inst = (T) ca.newInstance(initargs); return inst;&#125;// sun.reflect.DelegatingConstructorAccessorImplpublic Object newInstance(Object[] args) throws InstantiationException, IllegalArgumentException, InvocationTargetException&#123; return delegate.newInstance(args);&#125;// sun.reflect.NativeConstructorAccessorImplpublic Object newInstance(Object[] args) throws InstantiationException, IllegalArgumentException, InvocationTargetException&#123; // We can&#x27;t inflate a constructor belonging to a vm-anonymous class // because that kind of class can&#x27;t be referred to by name, hence can&#x27;t // be found from the generated bytecode. if (++numInvocations &gt; ReflectionFactory.inflationThreshold() &amp;&amp; !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())) &#123; ConstructorAccessorImpl acc = (ConstructorAccessorImpl) new MethodAccessorGenerator(). generateConstructor(c.getDeclaringClass(), c.getParameterTypes(), c.getExceptionTypes(), c.getModifiers()); parent.setDelegate(acc); &#125; // è°ƒç”¨nativeæ–¹æ³•ï¼Œè¿›è¡Œè°ƒç”¨ constructor return newInstance0(c, args);&#125; è¿”å›æ„é€ å™¨çš„å®ä¾‹åï¼Œå¯ä»¥æ ¹æ®å¤–éƒ¨è¿›è¡Œè¿›è¡Œç±»å‹è½¬æ¢ï¼Œä»è€Œä½¿ç”¨æ¥å£æˆ–æ–¹æ³•è¿›è¡Œè°ƒç”¨å®ä¾‹åŠŸèƒ½äº†ã€‚ åå°„è·å–æ–¹æ³• ç¬¬ä¸€æ­¥ï¼Œå…ˆè·å– Method; 1234567891011// java.lang.Class@CallerSensitivepublic Method getDeclaredMethod(String name, Class&lt;?&gt;... parameterTypes) throws NoSuchMethodException, SecurityException &#123; checkMemberAccess(Member.DECLARED, Reflection.getCallerClass(), true); Method method = searchMethods(privateGetDeclaredMethods(false), name, parameterTypes); if (method == null) &#123; throw new NoSuchMethodException(getName() + &quot;.&quot; + name + argumentTypesToString(parameterTypes)); &#125; return method;&#125; å¿½ç•¥ç¬¬ä¸€ä¸ªæ£€æŸ¥æƒé™ï¼Œå‰©ä¸‹å°±åªæœ‰ä¸¤ä¸ªåŠ¨ä½œäº†ã€‚ è·å–æ‰€æœ‰æ–¹æ³•åˆ—è¡¨ï¼› æ ¹æ®æ–¹æ³•åç§°å’Œæ–¹æ³•åˆ—è¡¨ï¼Œé€‰å‡ºç¬¦åˆè¦æ±‚çš„æ–¹æ³•ï¼› å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åº”æ–¹æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™è¿”å›å¯¹åº”æ–¹æ³•ï¼› æ‰€ä»¥ï¼Œå…ˆçœ‹ä¸€ä¸‹æ€æ ·è·å–ç±»å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼Ÿ 12345678910111213141516171819202122// Returns an array of &quot;root&quot; methods. These Method objects must NOT// be propagated to the outside world, but must instead be copied// via ReflectionFactory.copyMethod.private Method[] privateGetDeclaredMethods(boolean publicOnly) &#123; checkInitted(); Method[] res; ReflectionData&lt;T&gt; rd = reflectionData(); if (rd != null) &#123; res = publicOnly ? rd.declaredPublicMethods : rd.declaredMethods; if (res != null) return res; &#125; // No cached value available; request value from VM res = Reflection.filterMethods(this, getDeclaredMethods0(publicOnly)); if (rd != null) &#123; if (publicOnly) &#123; rd.declaredPublicMethods = res; &#125; else &#123; rd.declaredMethods = res; &#125; &#125; return res;&#125; å¾ˆç›¸ä¼¼ï¼Œå’Œè·å–æ‰€æœ‰æ„é€ å™¨çš„æ–¹æ³•å¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯å…ˆä»ç¼“å­˜ä¸­è·å–æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»jvmä¸­è·å–ã€‚ ä¸åŒçš„æ˜¯ï¼Œæ–¹æ³•åˆ—è¡¨éœ€è¦è¿›è¡Œè¿‡æ»¤ Reflection.filterMethods;å½“ç„¶åé¢çœ‹æ¥ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šæ´¾ä¸Šç”¨åœºã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243// sun.misc.Reflectionpublic static Method[] filterMethods(Class&lt;?&gt; containingClass, Method[] methods) &#123; if (methodFilterMap == null) &#123; // Bootstrapping return methods; &#125; return (Method[])filter(methods, methodFilterMap.get(containingClass));&#125;// å¯ä»¥è¿‡æ»¤æŒ‡å®šçš„æ–¹æ³•ï¼Œä¸€èˆ¬ä¸ºç©ºï¼Œå¦‚æœè¦æŒ‡å®šè¿‡æ»¤ï¼Œå¯ä»¥è°ƒç”¨ registerMethodsToFilter(), æˆ–è€…...private static Member[] filter(Member[] members, String[] filteredNames) &#123; if ((filteredNames == null) || (members.length == 0)) &#123; return members; &#125; int numNewMembers = 0; for (Member member : members) &#123; boolean shouldSkip = false; for (String filteredName : filteredNames) &#123; if (member.getName() == filteredName) &#123; shouldSkip = true; break; &#125; &#125; if (!shouldSkip) &#123; ++numNewMembers; &#125; &#125; Member[] newMembers = (Member[])Array.newInstance(members[0].getClass(), numNewMembers); int destIdx = 0; for (Member member : members) &#123; boolean shouldSkip = false; for (String filteredName : filteredNames) &#123; if (member.getName() == filteredName) &#123; shouldSkip = true; break; &#125; &#125; if (!shouldSkip) &#123; newMembers[destIdx++] = member; &#125; &#125; return newMembers;&#125; ç¬¬äºŒæ­¥ï¼Œæ ¹æ®æ–¹æ³•åå’Œå‚æ•°ç±»å‹è¿‡æ»¤æŒ‡å®šæ–¹æ³•è¿”å›ï¼š 123456789101112131415161718private static Method searchMethods(Method[] methods, String name, Class&lt;?&gt;[] parameterTypes)&#123; Method res = null; // ä½¿ç”¨å¸¸é‡æ± ï¼Œé¿å…é‡å¤åˆ›å»ºString String internedName = name.intern(); for (int i = 0; i &lt; methods.length; i++) &#123; Method m = methods[i]; if (m.getName() == internedName &amp;&amp; arrayContentsEq(parameterTypes, m.getParameterTypes()) &amp;&amp; (res == null || res.getReturnType().isAssignableFrom(m.getReturnType()))) res = m; &#125; return (res == null ? res : getReflectionFactory().copyMethod(res));&#125; å¤§æ¦‚æ„æ€çœ‹å¾—æ˜ç™½ï¼Œå°±æ˜¯åŒ¹é…åˆ°æ–¹æ³•åï¼Œç„¶åå‚æ•°ç±»å‹åŒ¹é…ï¼Œæ‰å¯ä»¥ã€‚ ä½†æ˜¯å¯ä»¥çœ‹åˆ°ï¼ŒåŒ¹é…åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶æ²¡æœ‰é€€å‡ºforå¾ªç¯ï¼Œè€Œæ˜¯ç»§ç»­è¿›è¡ŒåŒ¹é…ã€‚ è¿™é‡Œæ˜¯åŒ¹é…æœ€ç²¾ç¡®çš„å­ç±»è¿›è¡Œè¿”å›ï¼ˆæœ€ä¼˜åŒ¹é…ï¼‰ æœ€åï¼Œè¿˜æ˜¯é€šè¿‡ ReflectionFactory, copy æ–¹æ³•åè¿”å›ã€‚ è°ƒç”¨ method.invoke() æ–¹æ³•1234567891011121314151617@CallerSensitivepublic Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException&#123; if (!override) &#123; if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, obj, modifiers); &#125; &#125; MethodAccessor ma = methodAccessor; // read volatile if (ma == null) &#123; ma = acquireMethodAccessor(); &#125; return ma.invoke(obj, args);&#125; invokeæ—¶ï¼Œæ˜¯é€šè¿‡ MethodAccessor è¿›è¡Œè°ƒç”¨çš„ï¼Œè€Œ MethodAccessor æ˜¯ä¸ªæ¥å£ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ—¶è°ƒç”¨ acquireMethodAccessor() è¿›è¡Œæ–°åˆ›å»ºã€‚ 1234567891011121314151617181920212223242526272829303132333435363738// probably make the implementation more scalable.private MethodAccessor acquireMethodAccessor() &#123; // First check to see if one has been created yet, and take it // if so MethodAccessor tmp = null; if (root != null) tmp = root.getMethodAccessor(); if (tmp != null) &#123; // å­˜åœ¨ç¼“å­˜æ—¶ï¼Œå­˜å…¥ methodAccessorï¼Œå¦åˆ™è°ƒç”¨ ReflectionFactory åˆ›å»ºæ–°çš„ MethodAccessor methodAccessor = tmp; &#125; else &#123; // Otherwise fabricate one and propagate it up to the root tmp = reflectionFactory.newMethodAccessor(this); setMethodAccessor(tmp); &#125; return tmp;&#125;// sun.reflect.ReflectionFactorypublic MethodAccessor newMethodAccessor(Method method) &#123; checkInitted(); if (noInflation &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123; return new MethodAccessorGenerator(). generateMethod(method.getDeclaringClass(), method.getName(), method.getParameterTypes(), method.getReturnType(), method.getExceptionTypes(), method.getModifiers()); &#125; else &#123; NativeMethodAccessorImpl acc = new NativeMethodAccessorImpl(method); DelegatingMethodAccessorImpl res = new DelegatingMethodAccessorImpl(acc); acc.setParent(res); return res; &#125;&#125; ä¸¤ä¸ªAccessorè¯¦æƒ…ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455// NativeMethodAccessorImpl / DelegatingMethodAccessorImplclass NativeMethodAccessorImpl extends MethodAccessorImpl &#123; private final Method method; private DelegatingMethodAccessorImpl parent; private int numInvocations; NativeMethodAccessorImpl(Method method) &#123; this.method = method; &#125; public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException &#123; // We can&#x27;t inflate methods belonging to vm-anonymous classes because // that kind of class can&#x27;t be referred to by name, hence can&#x27;t be // found from the generated bytecode. if (++numInvocations &gt; ReflectionFactory.inflationThreshold() &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123; MethodAccessorImpl acc = (MethodAccessorImpl) new MethodAccessorGenerator(). generateMethod(method.getDeclaringClass(), method.getName(), method.getParameterTypes(), method.getReturnType(), method.getExceptionTypes(), method.getModifiers()); parent.setDelegate(acc); &#125; return invoke0(method, obj, args); &#125; void setParent(DelegatingMethodAccessorImpl parent) &#123; this.parent = parent; &#125; private static native Object invoke0(Method m, Object obj, Object[] args);&#125;class DelegatingMethodAccessorImpl extends MethodAccessorImpl &#123; private MethodAccessorImpl delegate; DelegatingMethodAccessorImpl(MethodAccessorImpl delegate) &#123; setDelegate(delegate); &#125; public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException &#123; return delegate.invoke(obj, args); &#125; void setDelegate(MethodAccessorImpl delegate) &#123; this.delegate = delegate; &#125;&#125; è¿›è¡Œ ma.invoke(obj, args); è°ƒç”¨æ—¶ï¼Œè°ƒç”¨ DelegatingMethodAccessorImpl.invoke(); æœ€åè¢«å§”æ‰˜åˆ° NativeMethodAccessorImpl.invoke(), å³ï¼š 12345678910111213141516171819202122public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException&#123; // We can&#x27;t inflate methods belonging to vm-anonymous classes because // that kind of class can&#x27;t be referred to by name, hence can&#x27;t be // found from the generated bytecode. if (++numInvocations &gt; ReflectionFactory.inflationThreshold() &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123; MethodAccessorImpl acc = (MethodAccessorImpl) new MethodAccessorGenerator(). generateMethod(method.getDeclaringClass(), method.getName(), method.getParameterTypes(), method.getReturnType(), method.getExceptionTypes(), method.getModifiers()); parent.setDelegate(acc); &#125; // invoke0 æ˜¯ä¸ª native æ–¹æ³•ï¼Œç”±jvmè¿›è¡Œè°ƒç”¨ä¸šåŠ¡æ–¹æ³•ã€‚ä»è€Œå®Œæˆåå°„è°ƒç”¨åŠŸèƒ½ã€‚ return invoke0(method, obj, args);&#125; å…¶ä¸­ï¼Œ generateMethod() æ˜¯ç”Ÿæˆå…·ä½“ç±»çš„æ–¹æ³•ï¼š 123456789101112131415161718/** This routine is not thread-safe */public MethodAccessor generateMethod(Class&lt;?&gt; declaringClass, String name, Class&lt;?&gt;[] parameterTypes, Class&lt;?&gt; returnType, Class&lt;?&gt;[] checkedExceptions, int modifiers)&#123; return (MethodAccessor) generate(declaringClass, name, parameterTypes, returnType, checkedExceptions, modifiers, false, false, null);&#125; generate() æˆ³è¯¦æƒ…ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287/** This routine is not thread-safe */private MagicAccessorImpl generate(final Class&lt;?&gt; declaringClass, String name, Class&lt;?&gt;[] parameterTypes, Class&lt;?&gt; returnType, Class&lt;?&gt;[] checkedExceptions, int modifiers, boolean isConstructor, boolean forSerialization, Class&lt;?&gt; serializationTargetClass)&#123; ByteVector vec = ByteVectorFactory.create(); asm = new ClassFileAssembler(vec); this.declaringClass = declaringClass; this.parameterTypes = parameterTypes; this.returnType = returnType; this.modifiers = modifiers; this.isConstructor = isConstructor; this.forSerialization = forSerialization; asm.emitMagicAndVersion(); // Constant pool entries: // ( * = Boxing information: optional) // (+ = Shared entries provided by AccessorGenerator) // (^ = Only present if generating SerializationConstructorAccessor) // [UTF-8] [This class&#x27;s name] // [CONSTANT_Class_info] for above // [UTF-8] &quot;sun/reflect/&#123;MethodAccessorImpl,ConstructorAccessorImpl,SerializationConstructorAccessorImpl&#125;&quot; // [CONSTANT_Class_info] for above // [UTF-8] [Target class&#x27;s name] // [CONSTANT_Class_info] for above // ^ [UTF-8] [Serialization: Class&#x27;s name in which to invoke constructor] // ^ [CONSTANT_Class_info] for above // [UTF-8] target method or constructor name // [UTF-8] target method or constructor signature // [CONSTANT_NameAndType_info] for above // [CONSTANT_Methodref_info or CONSTANT_InterfaceMethodref_info] for target method // [UTF-8] &quot;invoke&quot; or &quot;newInstance&quot; // [UTF-8] invoke or newInstance descriptor // [UTF-8] descriptor for type of non-primitive parameter 1 // [CONSTANT_Class_info] for type of non-primitive parameter 1 // ... // [UTF-8] descriptor for type of non-primitive parameter n // [CONSTANT_Class_info] for type of non-primitive parameter n // + [UTF-8] &quot;java/lang/Exception&quot; // + [CONSTANT_Class_info] for above // + [UTF-8] &quot;java/lang/ClassCastException&quot; // + [CONSTANT_Class_info] for above // + [UTF-8] &quot;java/lang/NullPointerException&quot; // + [CONSTANT_Class_info] for above // + [UTF-8] &quot;java/lang/IllegalArgumentException&quot; // + [CONSTANT_Class_info] for above // + [UTF-8] &quot;java/lang/InvocationTargetException&quot; // + [CONSTANT_Class_info] for above // + [UTF-8] &quot;&lt;init&gt;&quot; // + [UTF-8] &quot;()V&quot; // + [CONSTANT_NameAndType_info] for above // + [CONSTANT_Methodref_info] for NullPointerException&#x27;s constructor // + [CONSTANT_Methodref_info] for IllegalArgumentException&#x27;s constructor // + [UTF-8] &quot;(Ljava/lang/String;)V&quot; // + [CONSTANT_NameAndType_info] for &quot;&lt;init&gt;(Ljava/lang/String;)V&quot; // + [CONSTANT_Methodref_info] for IllegalArgumentException&#x27;s constructor taking a String // + [UTF-8] &quot;(Ljava/lang/Throwable;)V&quot; // + [CONSTANT_NameAndType_info] for &quot;&lt;init&gt;(Ljava/lang/Throwable;)V&quot; // + [CONSTANT_Methodref_info] for InvocationTargetException&#x27;s constructor // + [CONSTANT_Methodref_info] for &quot;super()&quot; // + [UTF-8] &quot;java/lang/Object&quot; // + [CONSTANT_Class_info] for above // + [UTF-8] &quot;toString&quot; // + [UTF-8] &quot;()Ljava/lang/String;&quot; // + [CONSTANT_NameAndType_info] for &quot;toString()Ljava/lang/String;&quot; // + [CONSTANT_Methodref_info] for Object&#x27;s toString method // + [UTF-8] &quot;Code&quot; // + [UTF-8] &quot;Exceptions&quot; // * [UTF-8] &quot;java/lang/Boolean&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(Z)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;booleanValue&quot; // * [UTF-8] &quot;()Z&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;java/lang/Byte&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(B)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;byteValue&quot; // * [UTF-8] &quot;()B&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;java/lang/Character&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(C)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;charValue&quot; // * [UTF-8] &quot;()C&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;java/lang/Double&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(D)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;doubleValue&quot; // * [UTF-8] &quot;()D&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;java/lang/Float&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(F)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;floatValue&quot; // * [UTF-8] &quot;()F&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;java/lang/Integer&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(I)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;intValue&quot; // * [UTF-8] &quot;()I&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;java/lang/Long&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(J)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;longValue&quot; // * [UTF-8] &quot;()J&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;java/lang/Short&quot; // * [CONSTANT_Class_info] for above // * [UTF-8] &quot;(S)V&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above // * [UTF-8] &quot;shortValue&quot; // * [UTF-8] &quot;()S&quot; // * [CONSTANT_NameAndType_info] for above // * [CONSTANT_Methodref_info] for above short numCPEntries = NUM_BASE_CPOOL_ENTRIES + NUM_COMMON_CPOOL_ENTRIES; boolean usesPrimitives = usesPrimitiveTypes(); if (usesPrimitives) &#123; numCPEntries += NUM_BOXING_CPOOL_ENTRIES; &#125; if (forSerialization) &#123; numCPEntries += NUM_SERIALIZATION_CPOOL_ENTRIES; &#125; // Add in variable-length number of entries to be able to describe // non-primitive parameter types and checked exceptions. numCPEntries += (short) (2 * numNonPrimitiveParameterTypes()); asm.emitShort(add(numCPEntries, S1)); final String generatedName = generateName(isConstructor, forSerialization); asm.emitConstantPoolUTF8(generatedName); asm.emitConstantPoolClass(asm.cpi()); thisClass = asm.cpi(); if (isConstructor) &#123; if (forSerialization) &#123; asm.emitConstantPoolUTF8 (&quot;sun/reflect/SerializationConstructorAccessorImpl&quot;); &#125; else &#123; asm.emitConstantPoolUTF8(&quot;sun/reflect/ConstructorAccessorImpl&quot;); &#125; &#125; else &#123; asm.emitConstantPoolUTF8(&quot;sun/reflect/MethodAccessorImpl&quot;); &#125; asm.emitConstantPoolClass(asm.cpi()); superClass = asm.cpi(); asm.emitConstantPoolUTF8(getClassName(declaringClass, false)); asm.emitConstantPoolClass(asm.cpi()); targetClass = asm.cpi(); short serializationTargetClassIdx = (short) 0; if (forSerialization) &#123; asm.emitConstantPoolUTF8(getClassName(serializationTargetClass, false)); asm.emitConstantPoolClass(asm.cpi()); serializationTargetClassIdx = asm.cpi(); &#125; asm.emitConstantPoolUTF8(name); asm.emitConstantPoolUTF8(buildInternalSignature()); asm.emitConstantPoolNameAndType(sub(asm.cpi(), S1), asm.cpi()); if (isInterface()) &#123; asm.emitConstantPoolInterfaceMethodref(targetClass, asm.cpi()); &#125; else &#123; if (forSerialization) &#123; asm.emitConstantPoolMethodref(serializationTargetClassIdx, asm.cpi()); &#125; else &#123; asm.emitConstantPoolMethodref(targetClass, asm.cpi()); &#125; &#125; targetMethodRef = asm.cpi(); if (isConstructor) &#123; asm.emitConstantPoolUTF8(&quot;newInstance&quot;); &#125; else &#123; asm.emitConstantPoolUTF8(&quot;invoke&quot;); &#125; invokeIdx = asm.cpi(); if (isConstructor) &#123; asm.emitConstantPoolUTF8(&quot;([Ljava/lang/Object;)Ljava/lang/Object;&quot;); &#125; else &#123; asm.emitConstantPoolUTF8 (&quot;(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;&quot;); &#125; invokeDescriptorIdx = asm.cpi(); // Output class information for non-primitive parameter types nonPrimitiveParametersBaseIdx = add(asm.cpi(), S2); for (int i = 0; i &lt; parameterTypes.length; i++) &#123; Class&lt;?&gt; c = parameterTypes[i]; if (!isPrimitive(c)) &#123; asm.emitConstantPoolUTF8(getClassName(c, false)); asm.emitConstantPoolClass(asm.cpi()); &#125; &#125; // Entries common to FieldAccessor, MethodAccessor and ConstructorAccessor emitCommonConstantPoolEntries(); // Boxing entries if (usesPrimitives) &#123; emitBoxingContantPoolEntries(); &#125; if (asm.cpi() != numCPEntries) &#123; throw new InternalError(&quot;Adjust this code (cpi = &quot; + asm.cpi() + &quot;, numCPEntries = &quot; + numCPEntries + &quot;)&quot;); &#125; // Access flags asm.emitShort(ACC_PUBLIC); // This class asm.emitShort(thisClass); // Superclass asm.emitShort(superClass); // Interfaces count and interfaces asm.emitShort(S0); // Fields count and fields asm.emitShort(S0); // Methods count and methods asm.emitShort(NUM_METHODS); emitConstructor(); emitInvoke(); // Additional attributes (none) asm.emitShort(S0); // Load class vec.trim(); final byte[] bytes = vec.getData(); // Note: the class loader is the only thing that really matters // here -- it&#x27;s important to get the generated code into the // same namespace as the target class. Since the generated code // is privileged anyway, the protection domain probably doesn&#x27;t // matter. return AccessController.doPrivileged( new PrivilegedAction&lt;MagicAccessorImpl&gt;() &#123; public MagicAccessorImpl run() &#123; try &#123; return (MagicAccessorImpl) ClassDefiner.defineClass (generatedName, bytes, 0, bytes.length, declaringClass.getClassLoader()).newInstance(); &#125; catch (InstantiationException | IllegalAccessException e) &#123; throw new InternalError(e); &#125; &#125; &#125;);&#125; å’±ä»¬ä¸»è¦çœ‹è¿™ä¸€å¥ï¼šClassDefiner.defineClass(xx, declaringClass.getClassLoader()).newInstance(); åœ¨ClassDefiner.defineClassæ–¹æ³•å®ç°ä¸­ï¼Œæ¯è¢«è°ƒç”¨ä¸€æ¬¡éƒ½ä¼šç”Ÿæˆä¸€ä¸ªDelegatingClassLoaderç±»åŠ è½½å™¨å¯¹è±¡ ï¼Œè¿™é‡Œæ¯æ¬¡éƒ½ç”Ÿæˆæ–°çš„ç±»åŠ è½½å™¨ï¼Œæ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥å¸è½½è¿™äº›ç”Ÿæˆçš„ç±»ï¼Œå› ä¸ºç±»çš„å¸è½½æ˜¯åªæœ‰åœ¨ç±»åŠ è½½å™¨å¯ä»¥è¢«å›æ”¶çš„æƒ…å†µä¸‹æ‰ä¼šè¢«å›æ”¶çš„ï¼Œå¦‚æœç”¨äº†åŸæ¥çš„ç±»åŠ è½½å™¨ï¼Œé‚£å¯èƒ½å¯¼è‡´è¿™äº›æ–°åˆ›å»ºçš„ç±»ä¸€ç›´æ— æ³•è¢«å¸è½½ã€‚ è€Œåå°„ç”Ÿæˆçš„ç±»ï¼Œæœ‰æ—¶å€™å¯èƒ½ç”¨äº†å°±å¯ä»¥å¸è½½äº†ï¼Œæ‰€ä»¥ä½¿ç”¨å…¶ç‹¬ç«‹çš„ç±»åŠ è½½å™¨ï¼Œä»è€Œä½¿å¾—æ›´å®¹æ˜“æ§åˆ¶åå°„ç±»çš„ç”Ÿå‘½å‘¨æœŸã€‚ åå°„è°ƒç”¨æµç¨‹å°ç»“æœ€åï¼Œç”¨å‡ å¥è¯æ€»ç»“åå°„çš„å®ç°åŸç†ï¼š åå°„ç±»åŠåå°„æ–¹æ³•çš„è·å–ï¼Œéƒ½æ˜¯é€šè¿‡ä»åˆ—è¡¨ä¸­æœå¯»æŸ¥æ‰¾åŒ¹é…çš„æ–¹æ³•ï¼Œæ‰€ä»¥æŸ¥æ‰¾æ€§èƒ½ä¼šéšç±»çš„å¤§å°æ–¹æ³•å¤šå°‘è€Œå˜åŒ–ï¼› æ¯ä¸ªç±»éƒ½ä¼šæœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„Classå®ä¾‹ï¼Œä»è€Œæ¯ä¸ªç±»éƒ½å¯ä»¥è·å–methodåå°„æ–¹æ³•ï¼Œå¹¶ä½œç”¨åˆ°å…¶ä»–å®ä¾‹èº«ä¸Šï¼› åå°„ä¹Ÿæ˜¯è€ƒè™‘äº†çº¿ç¨‹å®‰å…¨çš„ï¼Œæ”¾å¿ƒä½¿ç”¨ï¼› åå°„ä½¿ç”¨è½¯å¼•ç”¨relectionDataç¼“å­˜classä¿¡æ¯ï¼Œé¿å…æ¯æ¬¡é‡æ–°ä»jvmè·å–å¸¦æ¥çš„å¼€é”€ï¼› åå°„è°ƒç”¨å¤šæ¬¡ç”Ÿæˆæ–°ä»£ç†Accessor, è€Œé€šè¿‡å­—èŠ‚ç ç”Ÿå­˜çš„åˆ™è€ƒè™‘äº†å¸è½½åŠŸèƒ½ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨ç‹¬ç«‹çš„ç±»åŠ è½½å™¨ï¼› å½“æ‰¾åˆ°éœ€è¦çš„æ–¹æ³•ï¼Œéƒ½ä¼šcopyä¸€ä»½å‡ºæ¥ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åŸæ¥çš„å®ä¾‹ï¼Œä»è€Œä¿è¯æ•°æ®éš”ç¦»ï¼› è°ƒåº¦åå°„æ–¹æ³•ï¼Œæœ€ç»ˆæ˜¯ç”±jvmæ‰§è¡Œinvoke0()æ‰§è¡Œï¼› å‚è€ƒæ–‡ç«  https://www.codercto.com/a/46094.html https://blog.csdn.net/sinat_38259539/article/details/71799078 https://blog.csdn.net/qq_40896997/article/details/94483820 https://www.cnblogs.com/zhaoguhong/p/6937364.html https://juejin.im/post/5c160420e51d452a60684431 https://blog.csdn.net/mcryeasy/java/article/details/52344729","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"6.Java åŸºç¡€ - å¼‚å¸¸æœºåˆ¶è¯¦è§£","path":"/2023/12/25/6.Java-åŸºç¡€-å¼‚å¸¸æœºåˆ¶è¯¦è§£/","content":"Javaå¼‚å¸¸æ˜¯Javaæä¾›çš„ä¸€ç§è¯†åˆ«åŠå“åº”é”™è¯¯çš„ä¸€è‡´æ€§æœºåˆ¶ï¼Œjavaå¼‚å¸¸æœºåˆ¶å¯ä»¥ä½¿ç¨‹åºä¸­å¼‚å¸¸å¤„ç†ä»£ç å’Œæ­£å¸¸ä¸šåŠ¡ä»£ç åˆ†ç¦»ï¼Œä¿è¯ç¨‹åºä»£ç æ›´åŠ ä¼˜é›…ï¼Œå¹¶æé«˜ç¨‹åºå¥å£®æ€§ã€‚æœ¬æ–‡ç»¼åˆå¤šç¯‡æ–‡ç« åï¼Œæ€»ç»“äº†Java å¼‚å¸¸çš„ç›¸å…³çŸ¥è¯†ï¼Œå¸Œæœ›å¯ä»¥æå‡ä½ å¯¹Javaä¸­å¼‚å¸¸çš„è®¤çŸ¥æ•ˆç‡ã€‚ å¼‚å¸¸çš„å±‚æ¬¡ç»“æ„å¼‚å¸¸æŒ‡ä¸æœŸè€Œè‡³çš„å„ç§çŠ¶å†µï¼Œå¦‚ï¼šæ–‡ä»¶æ‰¾ä¸åˆ°ã€ç½‘ç»œè¿æ¥å¤±è´¥ã€éæ³•å‚æ•°ç­‰ã€‚å¼‚å¸¸æ˜¯ä¸€ä¸ªäº‹ä»¶ï¼Œå®ƒå‘ç”Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œå¹²æ‰°äº†æ­£å¸¸çš„æŒ‡ä»¤æµç¨‹ã€‚Javaé€š è¿‡APIä¸­Throwableç±»çš„ä¼—å¤šå­ç±»æè¿°å„ç§ä¸åŒçš„å¼‚å¸¸ã€‚å› è€Œï¼ŒJavaå¼‚å¸¸éƒ½æ˜¯å¯¹è±¡ï¼Œæ˜¯Throwableå­ç±»çš„å®ä¾‹ï¼Œæè¿°äº†å‡ºç°åœ¨ä¸€æ®µç¼–ç ä¸­çš„ é”™è¯¯æ¡ä»¶ã€‚å½“æ¡ä»¶ç”Ÿæˆæ—¶ï¼Œé”™è¯¯å°†å¼•å‘å¼‚å¸¸ã€‚ Javaå¼‚å¸¸ç±»å±‚æ¬¡ç»“æ„å›¾ï¼š ThrowableThrowable æ˜¯ Java è¯­è¨€ä¸­æ‰€æœ‰é”™è¯¯ä¸å¼‚å¸¸çš„è¶…ç±»ã€‚ Throwable åŒ…å«ä¸¤ä¸ªå­ç±»ï¼šErrorï¼ˆé”™è¯¯ï¼‰å’Œ Exceptionï¼ˆå¼‚å¸¸ï¼‰ï¼Œå®ƒä»¬é€šå¸¸ç”¨äºæŒ‡ç¤ºå‘ç”Ÿäº†å¼‚å¸¸æƒ…å†µã€‚ Throwable åŒ…å«äº†å…¶çº¿ç¨‹åˆ›å»ºæ—¶çº¿ç¨‹æ‰§è¡Œå †æ ˆçš„å¿«ç…§ï¼Œå®ƒæä¾›äº† printStackTrace() ç­‰æ¥å£ç”¨äºè·å–å †æ ˆè·Ÿè¸ªæ•°æ®ç­‰ä¿¡æ¯ã€‚ Errorï¼ˆé”™è¯¯ï¼‰Error ç±»åŠå…¶å­ç±»ï¼šç¨‹åºä¸­æ— æ³•å¤„ç†çš„é”™è¯¯ï¼Œè¡¨ç¤ºè¿è¡Œåº”ç”¨ç¨‹åºä¸­å‡ºç°äº†ä¸¥é‡çš„é”™è¯¯ã€‚ æ­¤ç±»é”™è¯¯ä¸€èˆ¬è¡¨ç¤ºä»£ç è¿è¡Œæ—¶ JVM å‡ºç°é—®é¢˜ã€‚é€šå¸¸æœ‰ VirtualMachineErrorï¼ˆè™šæ‹Ÿæœºè¿è¡Œé”™è¯¯ï¼‰ã€NoClassDefFoundErrorï¼ˆç±»å®šä¹‰é”™è¯¯ï¼‰ç­‰ã€‚æ¯”å¦‚ OutOfMemoryErrorï¼šå†…å­˜ä¸è¶³é”™è¯¯ï¼›StackOverflowErrorï¼šæ ˆæº¢å‡ºé”™è¯¯ã€‚æ­¤ç±»é”™è¯¯å‘ç”Ÿæ—¶ï¼ŒJVM å°†ç»ˆæ­¢çº¿ç¨‹ã€‚ è¿™äº›é”™è¯¯æ˜¯ä¸å—æ£€å¼‚å¸¸ï¼Œéä»£ç æ€§é”™è¯¯ã€‚å› æ­¤ï¼Œå½“æ­¤ç±»é”™è¯¯å‘ç”Ÿæ—¶ï¼Œåº”ç”¨ç¨‹åºä¸åº”è¯¥å»å¤„ç†æ­¤ç±»é”™è¯¯ã€‚æŒ‰ç…§Javaæƒ¯ä¾‹ï¼Œæˆ‘ä»¬æ˜¯ä¸åº”è¯¥å®ç°ä»»ä½•æ–°çš„Errorå­ç±»çš„ï¼ Exceptionï¼ˆå¼‚å¸¸ï¼‰ç¨‹åºæœ¬èº«å¯ä»¥æ•è·å¹¶ä¸”å¯ä»¥å¤„ç†çš„å¼‚å¸¸ã€‚Exception è¿™ç§å¼‚å¸¸åˆåˆ†ä¸ºä¸¤ç±»ï¼šè¿è¡Œæ—¶å¼‚å¸¸å’Œç¼–è¯‘æ—¶å¼‚å¸¸ã€‚ è¿è¡Œæ—¶å¼‚å¸¸ éƒ½æ˜¯RuntimeExceptionç±»åŠå…¶å­ç±»å¼‚å¸¸ï¼Œå¦‚NullPointerException(ç©ºæŒ‡é’ˆå¼‚å¸¸)ã€IndexOutOfBoundsException(ä¸‹æ ‡è¶Šç•Œå¼‚å¸¸)ç­‰ï¼Œè¿™äº›å¼‚å¸¸æ˜¯ä¸æ£€æŸ¥å¼‚å¸¸ï¼Œç¨‹åºä¸­å¯ä»¥é€‰æ‹©æ•è·å¤„ç†ï¼Œä¹Ÿå¯ä»¥ä¸å¤„ç†ã€‚è¿™äº›å¼‚å¸¸ä¸€èˆ¬æ˜¯ç”±ç¨‹åºé€»è¾‘é”™è¯¯å¼•èµ·çš„ï¼Œç¨‹åºåº”è¯¥ä»é€»è¾‘è§’åº¦å°½å¯èƒ½é¿å…è¿™ç±»å¼‚å¸¸çš„å‘ç”Ÿã€‚ è¿è¡Œæ—¶å¼‚å¸¸çš„ç‰¹ç‚¹æ˜¯Javaç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥å®ƒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç¨‹åºä¸­å¯èƒ½å‡ºç°è¿™ç±»å¼‚å¸¸ï¼Œå³ä½¿æ²¡æœ‰ç”¨try-catchè¯­å¥æ•è·å®ƒï¼Œä¹Ÿæ²¡æœ‰ç”¨throwså­å¥å£°æ˜æŠ›å‡ºå®ƒï¼Œä¹Ÿä¼šç¼–è¯‘é€šè¿‡ã€‚ éè¿è¡Œæ—¶å¼‚å¸¸ ï¼ˆç¼–è¯‘å¼‚å¸¸ï¼‰ æ˜¯RuntimeExceptionä»¥å¤–çš„å¼‚å¸¸ï¼Œç±»å‹ä¸Šéƒ½å±äºExceptionç±»åŠå…¶å­ç±»ã€‚ä»ç¨‹åºè¯­æ³•è§’åº¦è®²æ˜¯å¿…é¡»è¿›è¡Œå¤„ç†çš„å¼‚å¸¸ï¼Œå¦‚æœä¸å¤„ç†ï¼Œç¨‹åºå°±ä¸èƒ½ç¼–è¯‘é€šè¿‡ã€‚å¦‚IOExceptionã€SQLExceptionç­‰ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰çš„Exceptionå¼‚å¸¸ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸è‡ªå®šä¹‰æ£€æŸ¥å¼‚å¸¸ã€‚ å¯æŸ¥çš„å¼‚å¸¸ï¼ˆchecked exceptionsï¼‰å’Œä¸å¯æŸ¥çš„å¼‚å¸¸ï¼ˆunchecked exceptionsï¼‰ å¯æŸ¥å¼‚å¸¸ï¼ˆç¼–è¯‘å™¨è¦æ±‚å¿…é¡»å¤„ç½®çš„å¼‚å¸¸ï¼‰ï¼š æ­£ç¡®çš„ç¨‹åºåœ¨è¿è¡Œä¸­ï¼Œå¾ˆå®¹æ˜“å‡ºç°çš„ã€æƒ…ç†å¯å®¹çš„å¼‚å¸¸çŠ¶å†µã€‚å¯æŸ¥å¼‚å¸¸è™½ç„¶æ˜¯å¼‚å¸¸çŠ¶å†µï¼Œä½†åœ¨ä¸€å®šç¨‹åº¦ä¸Šå®ƒçš„å‘ç”Ÿæ˜¯å¯ä»¥é¢„è®¡çš„ï¼Œè€Œä¸”ä¸€æ—¦å‘ç”Ÿè¿™ç§å¼‚å¸¸çŠ¶å†µï¼Œå°±å¿…é¡»é‡‡å–æŸç§æ–¹å¼è¿›è¡Œå¤„ç†ã€‚ é™¤äº†RuntimeExceptionåŠå…¶å­ç±»ä»¥å¤–ï¼Œå…¶ä»–çš„Exceptionç±»åŠå…¶å­ç±»éƒ½å±äºå¯æŸ¥å¼‚å¸¸ã€‚è¿™ç§å¼‚å¸¸çš„ç‰¹ç‚¹æ˜¯Javaç¼–è¯‘å™¨ä¼šæ£€æŸ¥å®ƒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç¨‹åºä¸­å¯èƒ½å‡ºç°è¿™ç±»å¼‚å¸¸ï¼Œè¦ä¹ˆç”¨try-catchè¯­å¥æ•è·å®ƒï¼Œè¦ä¹ˆç”¨throwså­å¥å£°æ˜æŠ›å‡ºå®ƒï¼Œå¦åˆ™ç¼–è¯‘ä¸ä¼šé€šè¿‡ã€‚ ä¸å¯æŸ¥å¼‚å¸¸(ç¼–è¯‘å™¨ä¸è¦æ±‚å¼ºåˆ¶å¤„ç½®çš„å¼‚å¸¸) åŒ…æ‹¬è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆRuntimeExceptionä¸å…¶å­ç±»ï¼‰å’Œé”™è¯¯ï¼ˆErrorï¼‰ã€‚ å¼‚å¸¸åŸºç¡€æç¤º æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å¼‚å¸¸ä½¿ç”¨çš„åŸºç¡€ã€‚ å¼‚å¸¸å…³é”®å­— try â€“ ç”¨äºç›‘å¬ã€‚å°†è¦è¢«ç›‘å¬çš„ä»£ç (å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç )æ”¾åœ¨tryè¯­å¥å—ä¹‹å†…ï¼Œå½“tryè¯­å¥å—å†…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å°±è¢«æŠ›å‡ºã€‚ catch â€“ ç”¨äºæ•è·å¼‚å¸¸ã€‚catchç”¨æ¥æ•è·tryè¯­å¥å—ä¸­å‘ç”Ÿçš„å¼‚å¸¸ã€‚ finally â€“ finallyè¯­å¥å—æ€»æ˜¯ä¼šè¢«æ‰§è¡Œã€‚å®ƒä¸»è¦ç”¨äºå›æ”¶åœ¨tryå—é‡Œæ‰“å¼€çš„ç‰©åŠ›èµ„æº(å¦‚æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥å’Œç£ç›˜æ–‡ä»¶)ã€‚åªæœ‰finallyå—ï¼Œæ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰ä¼šå›æ¥æ‰§è¡Œtryæˆ–è€…catchå—ä¸­çš„returnæˆ–è€…throwè¯­å¥ï¼Œå¦‚æœfinallyä¸­ä½¿ç”¨äº†returnæˆ–è€…throwç­‰ç»ˆæ­¢æ–¹æ³•çš„è¯­å¥ï¼Œåˆ™å°±ä¸ä¼šè·³å›æ‰§è¡Œï¼Œç›´æ¥åœæ­¢ã€‚ throw â€“ ç”¨äºæŠ›å‡ºå¼‚å¸¸ã€‚ throws â€“ ç”¨åœ¨æ–¹æ³•ç­¾åä¸­ï¼Œç”¨äºå£°æ˜è¯¥æ–¹æ³•å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ã€‚ å¼‚å¸¸çš„ç”³æ˜(throws)åœ¨Javaä¸­ï¼Œå½“å‰æ‰§è¡Œçš„è¯­å¥å¿…å±äºæŸä¸ªæ–¹æ³•ï¼ŒJavaè§£é‡Šå™¨è°ƒç”¨mainæ–¹æ³•æ‰§è¡Œå¼€å§‹æ‰§è¡Œç¨‹åºã€‚è‹¥æ–¹æ³•ä¸­å­˜åœ¨æ£€æŸ¥å¼‚å¸¸ï¼Œå¦‚æœä¸å¯¹å…¶æ•è·ï¼Œé‚£å¿…é¡»åœ¨æ–¹æ³•å¤´ä¸­æ˜¾å¼å£°æ˜è¯¥å¼‚å¸¸ï¼Œä»¥ä¾¿äºå‘ŠçŸ¥æ–¹æ³•è°ƒç”¨è€…æ­¤æ–¹æ³•æœ‰å¼‚å¸¸ï¼Œéœ€è¦è¿›è¡Œå¤„ç†ã€‚ åœ¨æ–¹æ³•ä¸­å£°æ˜ä¸€ä¸ªå¼‚å¸¸ï¼Œæ–¹æ³•å¤´ä¸­ä½¿ç”¨å…³é”®å­—throwsï¼Œåé¢æ¥ä¸Šè¦å£°æ˜çš„å¼‚å¸¸ã€‚è‹¥å£°æ˜å¤šä¸ªå¼‚å¸¸ï¼Œåˆ™ä½¿ç”¨é€—å·åˆ†å‰²ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š 123public static void method() throws IOException, FileNotFoundException&#123; //something statements&#125; æ³¨æ„ï¼šè‹¥æ˜¯çˆ¶ç±»çš„æ–¹æ³•æ²¡æœ‰å£°æ˜å¼‚å¸¸ï¼Œåˆ™å­ç±»ç»§æ‰¿æ–¹æ³•åï¼Œä¹Ÿä¸èƒ½å£°æ˜å¼‚å¸¸ã€‚ é€šå¸¸ï¼Œåº”è¯¥æ•è·é‚£äº›çŸ¥é“å¦‚ä½•å¤„ç†çš„å¼‚å¸¸ï¼Œå°†ä¸çŸ¥é“å¦‚ä½•å¤„ç†çš„å¼‚å¸¸ç»§ç»­ä¼ é€’ä¸‹å»ã€‚ä¼ é€’å¼‚å¸¸å¯ä»¥åœ¨æ–¹æ³•ç­¾åå¤„ä½¿ç”¨ throws å…³é”®å­—å£°æ˜å¯èƒ½ä¼šæŠ›å‡ºçš„å¼‚å¸¸ã€‚ 123456789private static void readFile(String filePath) throws IOException &#123; File file = new File(filePath); String result; BufferedReader reader = new BufferedReader(new FileReader(file)); while((result = reader.readLine())!=null) &#123; System.out.println(result); &#125; reader.close();&#125; ThrowsæŠ›å‡ºå¼‚å¸¸çš„è§„åˆ™ï¼š å¦‚æœæ˜¯ä¸å¯æŸ¥å¼‚å¸¸ï¼ˆunchecked exceptionï¼‰ï¼Œå³Errorã€RuntimeExceptionæˆ–å®ƒä»¬çš„å­ç±»ï¼Œé‚£ä¹ˆå¯ä»¥ä¸ä½¿ç”¨throwså…³é”®å­—æ¥å£°æ˜è¦æŠ›å‡ºçš„å¼‚å¸¸ï¼Œç¼–è¯‘ä»èƒ½é¡ºåˆ©é€šè¿‡ï¼Œä½†åœ¨è¿è¡Œæ—¶ä¼šè¢«ç³»ç»ŸæŠ›å‡ºã€‚ å¿…é¡»å£°æ˜æ–¹æ³•å¯æŠ›å‡ºçš„ä»»ä½•å¯æŸ¥å¼‚å¸¸ï¼ˆchecked exceptionï¼‰ã€‚å³å¦‚æœä¸€ä¸ªæ–¹æ³•å¯èƒ½å‡ºç°å—å¯æŸ¥å¼‚å¸¸ï¼Œè¦ä¹ˆç”¨try-catchè¯­å¥æ•è·ï¼Œè¦ä¹ˆç”¨throwså­å¥å£°æ˜å°†å®ƒæŠ›å‡ºï¼Œå¦åˆ™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ ä»…å½“æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè¯¥æ–¹æ³•çš„è°ƒç”¨è€…æ‰å¿…é¡»å¤„ç†æˆ–è€…é‡æ–°æŠ›å‡ºè¯¥å¼‚å¸¸ã€‚å½“æ–¹æ³•çš„è°ƒç”¨è€…æ— åŠ›å¤„ç†è¯¥å¼‚å¸¸çš„æ—¶å€™ï¼Œåº”è¯¥ç»§ç»­æŠ›å‡ºï¼Œè€Œä¸æ˜¯å›«å›µåæ£ã€‚ è°ƒç”¨æ–¹æ³•å¿…é¡»éµå¾ªä»»ä½•å¯æŸ¥å¼‚å¸¸çš„å¤„ç†å’Œå£°æ˜è§„åˆ™ã€‚è‹¥è¦†ç›–ä¸€ä¸ªæ–¹æ³•ï¼Œåˆ™ä¸èƒ½å£°æ˜ä¸è¦†ç›–æ–¹æ³•ä¸åŒçš„å¼‚å¸¸ã€‚å£°æ˜çš„ä»»ä½•å¼‚å¸¸å¿…é¡»æ˜¯è¢«è¦†ç›–æ–¹æ³•æ‰€å£°æ˜å¼‚å¸¸çš„åŒç±»æˆ–å­ç±»ã€‚ å¼‚å¸¸çš„æŠ›å‡º(throw)å¦‚æœä»£ç å¯èƒ½ä¼šå¼•å‘æŸç§é”™è¯¯ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªåˆé€‚çš„å¼‚å¸¸ç±»å®ä¾‹å¹¶æŠ›å‡ºå®ƒï¼Œè¿™å°±æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š 123456public static double method(int value) &#123; if(value == 0) &#123; throw new ArithmeticException(&quot;å‚æ•°ä¸èƒ½ä¸º0&quot;); //æŠ›å‡ºä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ &#125; return 5.0 / value;&#125; å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½ä¸éœ€è¦æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºJavaçš„å¤§éƒ¨åˆ†æ–¹æ³•è¦ä¹ˆå·²ç»å¤„ç†å¼‚å¸¸ï¼Œè¦ä¹ˆå·²å£°æ˜å¼‚å¸¸ã€‚æ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯æ•è·å¼‚å¸¸æˆ–è€…å†å¾€ä¸ŠæŠ›ã€‚ æœ‰æ—¶æˆ‘ä»¬ä¼šä» catch ä¸­æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œç›®çš„æ˜¯ä¸ºäº†æ”¹å˜å¼‚å¸¸çš„ç±»å‹ã€‚å¤šç”¨äºåœ¨å¤šç³»ç»Ÿé›†æˆæ—¶ï¼Œå½“æŸä¸ªå­ç³»ç»Ÿæ•…éšœï¼Œå¼‚å¸¸ç±»å‹å¯èƒ½æœ‰å¤šç§ï¼Œå¯ä»¥ç”¨ç»Ÿä¸€çš„å¼‚å¸¸ç±»å‹å‘å¤–æš´éœ²ï¼Œä¸éœ€æš´éœ²å¤ªå¤šå†…éƒ¨å¼‚å¸¸ç»†èŠ‚ã€‚ 123456789private static void readFile(String filePath) throws MyException &#123; try &#123; // code &#125; catch (IOException e) &#123; MyException ex = new MyException(&quot;read file failed.&quot;); ex.initCause(e); throw ex; &#125;&#125; å¼‚å¸¸çš„è‡ªå®šä¹‰ä¹ æƒ¯ä¸Šï¼Œå®šä¹‰ä¸€ä¸ªå¼‚å¸¸ç±»åº”åŒ…å«ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°å’Œä¸€ä¸ªå¸¦æœ‰è¯¦ç»†æè¿°ä¿¡æ¯çš„æ„é€ å‡½æ•°ï¼ˆThrowable çš„ toString æ–¹æ³•ä¼šæ‰“å°è¿™äº›è¯¦ç»†ä¿¡æ¯ï¼Œè°ƒè¯•æ—¶å¾ˆæœ‰ç”¨ï¼‰, æ¯”å¦‚ä¸Šé¢ç”¨åˆ°çš„è‡ªå®šä¹‰MyExceptionï¼š 1234567public class MyException extends Exception &#123; public MyException()&#123; &#125; public MyException(String msg)&#123; super(msg); &#125; // ...&#125; å¼‚å¸¸çš„æ•è·å¼‚å¸¸æ•è·å¤„ç†çš„æ–¹æ³•é€šå¸¸æœ‰ï¼š try-catch try-catch-finally try-finally try-with-resource try-catchåœ¨ä¸€ä¸ª try-catch è¯­å¥å—ä¸­å¯ä»¥æ•è·å¤šä¸ªå¼‚å¸¸ç±»å‹ï¼Œå¹¶å¯¹ä¸åŒç±»å‹çš„å¼‚å¸¸åšå‡ºä¸åŒçš„å¤„ç† 123456789private static void readFile(String filePath) &#123; try &#123; // code &#125; catch (FileNotFoundException e) &#123; // handle FileNotFoundException &#125; catch (IOException e)&#123; // handle IOException &#125;&#125; åŒä¸€ä¸ª catch ä¹Ÿå¯ä»¥æ•è·å¤šç§ç±»å‹å¼‚å¸¸ï¼Œç”¨ | éš”å¼€ 123456789private static void readFile(String filePath) &#123; try &#123; // code &#125; catch (FileNotFoundException | UnknownHostException e) &#123; // handle FileNotFoundException or UnknownHostException &#125; catch (IOException e)&#123; // handle IOException &#125;&#125; try-catch-finally å¸¸è§„è¯­æ³• 1234567try &#123; //æ‰§è¡Œç¨‹åºä»£ç ï¼Œå¯èƒ½ä¼šå‡ºç°å¼‚å¸¸ &#125; catch(Exception e) &#123; //æ•è·å¼‚å¸¸å¹¶å¤„ç† &#125; finally &#123; //å¿…æ‰§è¡Œçš„ä»£ç &#125; æ‰§è¡Œçš„é¡ºåº å½“tryæ²¡æœ‰æ•è·åˆ°å¼‚å¸¸æ—¶ï¼štryè¯­å¥å—ä¸­çš„è¯­å¥é€ä¸€è¢«æ‰§è¡Œï¼Œç¨‹åºå°†è·³è¿‡catchè¯­å¥å—ï¼Œæ‰§è¡Œfinallyè¯­å¥å—å’Œå…¶åçš„è¯­å¥ï¼› å½“tryæ•è·åˆ°å¼‚å¸¸ï¼Œcatchè¯­å¥å—é‡Œæ²¡æœ‰å¤„ç†æ­¤å¼‚å¸¸çš„æƒ…å†µï¼šå½“tryè¯­å¥å—é‡Œçš„æŸæ¡è¯­å¥å‡ºç°å¼‚å¸¸æ—¶ï¼Œè€Œæ²¡æœ‰å¤„ç†æ­¤å¼‚å¸¸çš„catchè¯­å¥å—æ—¶ï¼Œæ­¤å¼‚å¸¸å°†ä¼šæŠ›ç»™JVMå¤„ç†ï¼Œfinallyè¯­å¥å—é‡Œçš„è¯­å¥è¿˜æ˜¯ä¼šè¢«æ‰§è¡Œï¼Œä½†finallyè¯­å¥å—åçš„è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œï¼› å½“tryæ•è·åˆ°å¼‚å¸¸ï¼Œcatchè¯­å¥å—é‡Œæœ‰å¤„ç†æ­¤å¼‚å¸¸çš„æƒ…å†µï¼šåœ¨tryè¯­å¥å—ä¸­æ˜¯æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œçš„ï¼Œå½“æ‰§è¡Œåˆ°æŸä¸€æ¡è¯­å¥å‡ºç°å¼‚å¸¸æ—¶ï¼Œç¨‹åºå°†è·³åˆ°catchè¯­å¥å—ï¼Œå¹¶ä¸catchè¯­å¥å—é€ä¸€åŒ¹é…ï¼Œæ‰¾åˆ°ä¸ä¹‹å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œå…¶ä»–çš„catchè¯­å¥å—å°†ä¸ä¼šè¢«æ‰§è¡Œï¼Œè€Œtryè¯­å¥å—ä¸­ï¼Œå‡ºç°å¼‚å¸¸ä¹‹åçš„è¯­å¥ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œï¼Œcatchè¯­å¥å—æ‰§è¡Œå®Œåï¼Œæ‰§è¡Œfinallyè¯­å¥å—é‡Œçš„è¯­å¥ï¼Œæœ€åæ‰§è¡Œfinallyè¯­å¥å—åçš„è¯­å¥ï¼› ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ 12345678910111213141516171819202122232425private static void readFile(String filePath) throws MyException &#123; File file = new File(filePath); String result; BufferedReader reader = null; try &#123; reader = new BufferedReader(new FileReader(file)); while((result = reader.readLine())!=null) &#123; System.out.println(result); &#125; &#125; catch (IOException e) &#123; System.out.println(&quot;readFile method catch block.&quot;); MyException ex = new MyException(&quot;read file failed.&quot;); ex.initCause(e); throw ex; &#125; finally &#123; System.out.println(&quot;readFile method finally block.&quot;); if (null != reader) &#123; try &#123; reader.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; try-finally å¯ä»¥ç›´æ¥ç”¨try-finallyå—ï¼Ÿ å¯ä»¥ã€‚ tryå—ä¸­å¼•èµ·å¼‚å¸¸ï¼Œå¼‚å¸¸ä»£ç ä¹‹åçš„è¯­å¥ä¸å†æ‰§è¡Œï¼Œç›´æ¥æ‰§è¡Œfinallyè¯­å¥ã€‚ tryå—æ²¡æœ‰å¼•å‘å¼‚å¸¸ï¼Œåˆ™æ‰§è¡Œå®Œtryå—å°±æ‰§è¡Œfinallyè¯­å¥ã€‚ try-finallyå¯ç”¨åœ¨ä¸éœ€è¦æ•è·å¼‚å¸¸çš„ä»£ç ï¼Œå¯ä»¥ä¿è¯èµ„æºåœ¨ä½¿ç”¨åè¢«å…³é—­ã€‚ä¾‹å¦‚IOæµä¸­æ‰§è¡Œå®Œç›¸åº”æ“ä½œåï¼Œå…³é—­ç›¸åº”èµ„æºï¼›ä½¿ç”¨Lockå¯¹è±¡ä¿è¯çº¿ç¨‹åŒæ­¥ï¼Œé€šè¿‡finallyå¯ä»¥ä¿è¯é”ä¼šè¢«é‡Šæ”¾ï¼›æ•°æ®åº“è¿æ¥ä»£ç æ—¶ï¼Œå…³é—­è¿æ¥æ“ä½œç­‰ç­‰ã€‚ 1234567//ä»¥LockåŠ é”ä¸ºä¾‹ï¼Œæ¼”ç¤ºtry-finallyReentrantLock lock = new ReentrantLock();try &#123; //éœ€è¦åŠ é”çš„ä»£ç &#125; finally &#123; lock.unlock(); //ä¿è¯é”ä¸€å®šè¢«é‡Šæ”¾&#125; finallyé‡è§å¦‚ä¸‹æƒ…å†µä¸ä¼šæ‰§è¡Œ åœ¨å‰é¢çš„ä»£ç ä¸­ç”¨äº†System.exit()é€€å‡ºç¨‹åºã€‚ finallyè¯­å¥å—ä¸­å‘ç”Ÿäº†å¼‚å¸¸ã€‚ ç¨‹åºæ‰€åœ¨çš„çº¿ç¨‹æ­»äº¡ã€‚ å…³é—­CPUã€‚ try-with-resource try-with-resourceæ˜¯Java 7ä¸­å¼•å…¥çš„ï¼Œå¾ˆå®¹æ˜“è¢«å¿½ç•¥ã€‚ ä¸Šé¢ä¾‹å­ä¸­ï¼Œfinally ä¸­çš„ close æ–¹æ³•ä¹Ÿå¯èƒ½æŠ›å‡º IOException, ä»è€Œè¦†ç›–äº†åŸå§‹å¼‚å¸¸ã€‚JAVA 7 æä¾›äº†æ›´ä¼˜é›…çš„æ–¹å¼æ¥å®ç°èµ„æºçš„è‡ªåŠ¨é‡Šæ”¾ï¼Œè‡ªåŠ¨é‡Šæ”¾çš„èµ„æºéœ€è¦æ˜¯å®ç°äº† AutoCloseable æ¥å£çš„ç±»ã€‚ ä»£ç å®ç° 1234567private static void tryWithResourceTest()&#123; try (Scanner scanner = new Scanner(new FileInputStream(&quot;c:/abc&quot;),&quot;UTF-8&quot;))&#123; // code &#125; catch (IOException e)&#123; // handle exception &#125;&#125; çœ‹ä¸‹Scanner 123456public final class Scanner implements Iterator&lt;String&gt;, Closeable &#123; // ...&#125;public interface Closeable extends AutoCloseable &#123; public void close() throws IOException;&#125; try ä»£ç å—é€€å‡ºæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ scanner.close æ–¹æ³•ï¼Œå’ŒæŠŠ scanner.close æ–¹æ³•æ”¾åœ¨ finally ä»£ç å—ä¸­ä¸åŒçš„æ˜¯ï¼Œè‹¥ scanner.close æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ä¼šè¢«æŠ‘åˆ¶ï¼ŒæŠ›å‡ºçš„ä»ç„¶ä¸ºåŸå§‹å¼‚å¸¸ã€‚è¢«æŠ‘åˆ¶çš„å¼‚å¸¸ä¼šç”± addSusppressed æ–¹æ³•æ·»åŠ åˆ°åŸæ¥çš„å¼‚å¸¸ï¼Œå¦‚æœæƒ³è¦è·å–è¢«æŠ‘åˆ¶çš„å¼‚å¸¸åˆ—è¡¨ï¼Œå¯ä»¥è°ƒç”¨ getSuppressed æ–¹æ³•æ¥è·å–ã€‚ å¼‚å¸¸åŸºç¡€æ€»ç»“ tryã€catchå’Œfinallyéƒ½ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œåªèƒ½æ˜¯try-catchã€try-finallyæˆ–è€…try-catch-finallyã€‚ tryè¯­å¥å—ç›‘æ§ä»£ç ï¼Œå‡ºç°å¼‚å¸¸å°±åœæ­¢æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œç„¶åå°†å¼‚å¸¸ç§»äº¤ç»™catchè¯­å¥å—æ¥å¤„ç†ã€‚ finallyè¯­å¥å—ä¸­çš„ä»£ç ä¸€å®šä¼šè¢«æ‰§è¡Œï¼Œå¸¸ç”¨äºå›æ”¶èµ„æº ã€‚ throwsï¼šå£°æ˜ä¸€ä¸ªå¼‚å¸¸ï¼Œå‘ŠçŸ¥æ–¹æ³•è°ƒç”¨è€…ã€‚ throw ï¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè‡³äºè¯¥å¼‚å¸¸è¢«æ•è·è¿˜æ˜¯ç»§ç»­æŠ›å‡ºéƒ½ä¸å®ƒæ— å…³ã€‚ Javaç¼–ç¨‹æ€æƒ³ä¸€ä¹¦ä¸­ï¼Œå¯¹å¼‚å¸¸çš„æ€»ç»“ã€‚ åœ¨æ°å½“çš„çº§åˆ«å¤„ç†é—®é¢˜ã€‚ï¼ˆåœ¨çŸ¥é“è¯¥å¦‚ä½•å¤„ç†çš„æƒ…å†µä¸‹äº†æ•è·å¼‚å¸¸ã€‚ï¼‰ è§£å†³é—®é¢˜å¹¶ä¸”é‡æ–°è°ƒç”¨äº§ç”Ÿå¼‚å¸¸çš„æ–¹æ³•ã€‚ è¿›è¡Œå°‘è®¸ä¿®è¡¥ï¼Œç„¶åç»•è¿‡å¼‚å¸¸å‘ç”Ÿçš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚ ç”¨åˆ«çš„æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œä»¥ä»£æ›¿æ–¹æ³•é¢„è®¡ä¼šè¿”å›çš„å€¼ã€‚ æŠŠå½“å‰è¿è¡Œç¯å¢ƒä¸‹èƒ½åšçš„äº‹å°½é‡åšå®Œï¼Œç„¶åæŠŠç›¸åŒçš„å¼‚å¸¸é‡æŠ›åˆ°æ›´é«˜å±‚ã€‚ æŠŠå½“å‰è¿è¡Œç¯å¢ƒä¸‹èƒ½åšçš„äº‹å°½é‡åšå®Œï¼Œç„¶åæŠŠä¸åŒçš„å¼‚å¸¸æŠ›åˆ°æ›´é«˜å±‚ã€‚ ç»ˆæ­¢ç¨‹åºã€‚ è¿›è¡Œç®€åŒ–ï¼ˆå¦‚æœä½ çš„å¼‚å¸¸æ¨¡å¼ä½¿é—®é¢˜å˜å¾—å¤ªå¤æ‚ï¼Œé‚£ä¹ˆç”¨èµ·æ¥ä¼šéå¸¸ç—›è‹¦ï¼‰ã€‚ è®©ç±»åº“å’Œç¨‹åºæ›´å®‰å…¨ã€‚ å¸¸ç”¨çš„å¼‚å¸¸åœ¨Javaä¸­æä¾›äº†ä¸€äº›å¼‚å¸¸ç”¨æ¥æè¿°ç»å¸¸å‘ç”Ÿçš„é”™è¯¯ï¼Œå¯¹äºè¿™äº›å¼‚å¸¸ï¼Œæœ‰çš„éœ€è¦ç¨‹åºå‘˜è¿›è¡Œæ•è·å¤„ç†æˆ–å£°æ˜æŠ›å‡ºï¼Œæœ‰çš„æ˜¯ç”±Javaè™šæ‹Ÿæœºè‡ªåŠ¨è¿›è¡Œæ•è·å¤„ç†ã€‚Javaä¸­å¸¸è§çš„å¼‚å¸¸ç±»: RuntimeException java.lang.ArrayIndexOutOfBoundsException æ•°ç»„ç´¢å¼•è¶Šç•Œå¼‚å¸¸ã€‚å½“å¯¹æ•°ç»„çš„ç´¢å¼•å€¼ä¸ºè´Ÿæ•°æˆ–å¤§äºç­‰äºæ•°ç»„å¤§å°æ—¶æŠ›å‡ºã€‚ java.lang.ArithmeticException ç®—æœ¯æ¡ä»¶å¼‚å¸¸ã€‚è­¬å¦‚ï¼šæ•´æ•°é™¤é›¶ç­‰ã€‚ java.lang.NullPointerException ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚å½“åº”ç”¨è¯•å›¾åœ¨è¦æ±‚ä½¿ç”¨å¯¹è±¡çš„åœ°æ–¹ä½¿ç”¨äº†nullæ—¶ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚è­¬å¦‚ï¼šè°ƒç”¨nullå¯¹è±¡çš„å®ä¾‹æ–¹æ³•ã€è®¿é—®nullå¯¹è±¡çš„å±æ€§ã€è®¡ç®—nullå¯¹è±¡çš„é•¿åº¦ã€ä½¿ç”¨throwè¯­å¥æŠ›å‡ºnullç­‰ç­‰ java.lang.ClassNotFoundException æ‰¾ä¸åˆ°ç±»å¼‚å¸¸ã€‚å½“åº”ç”¨è¯•å›¾æ ¹æ®å­—ç¬¦ä¸²å½¢å¼çš„ç±»åæ„é€ ç±»ï¼Œè€Œåœ¨éå†CLASSPAHä¹‹åæ‰¾ä¸åˆ°å¯¹åº”åç§°çš„classæ–‡ä»¶æ—¶ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚ java.lang.NegativeArraySizeException æ•°ç»„é•¿åº¦ä¸ºè´Ÿå¼‚å¸¸ java.lang.ArrayStoreException æ•°ç»„ä¸­åŒ…å«ä¸å…¼å®¹çš„å€¼æŠ›å‡ºçš„å¼‚å¸¸ java.lang.SecurityException å®‰å…¨æ€§å¼‚å¸¸ java.lang.IllegalArgumentException éæ³•å‚æ•°å¼‚å¸¸ IOException IOExceptionï¼šæ“ä½œè¾“å…¥æµå’Œè¾“å‡ºæµæ—¶å¯èƒ½å‡ºç°çš„å¼‚å¸¸ã€‚ EOFException æ–‡ä»¶å·²ç»“æŸå¼‚å¸¸ FileNotFoundException æ–‡ä»¶æœªæ‰¾åˆ°å¼‚å¸¸ å…¶ä»– ClassCastException ç±»å‹è½¬æ¢å¼‚å¸¸ç±» ArrayStoreException æ•°ç»„ä¸­åŒ…å«ä¸å…¼å®¹çš„å€¼æŠ›å‡ºçš„å¼‚å¸¸ SQLException æ“ä½œæ•°æ®åº“å¼‚å¸¸ç±» NoSuchFieldException å­—æ®µæœªæ‰¾åˆ°å¼‚å¸¸ NoSuchMethodException æ–¹æ³•æœªæ‰¾åˆ°æŠ›å‡ºçš„å¼‚å¸¸ NumberFormatException å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—æŠ›å‡ºçš„å¼‚å¸¸ StringIndexOutOfBoundsException å­—ç¬¦ä¸²ç´¢å¼•è¶…å‡ºèŒƒå›´æŠ›å‡ºçš„å¼‚å¸¸ IllegalAccessException ä¸å…è®¸è®¿é—®æŸç±»å¼‚å¸¸ InstantiationException å½“åº”ç”¨ç¨‹åºè¯•å›¾ä½¿ç”¨Classç±»ä¸­çš„newInstance()æ–¹æ³•åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œè€ŒæŒ‡å®šçš„ç±»å¯¹è±¡æ— æ³•è¢«å®ä¾‹åŒ–æ—¶ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸ å¼‚å¸¸å®è·µæç¤º åœ¨ Java ä¸­å¤„ç†å¼‚å¸¸å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„äº‹æƒ…ã€‚ä¸ä»…ä»…åˆå­¦è€…å¾ˆéš¾ç†è§£ï¼Œå³ä½¿ä¸€äº›æœ‰ç»éªŒçš„å¼€å‘è€…ä¹Ÿéœ€è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´æ¥æ€è€ƒå¦‚ä½•å¤„ç†å¼‚å¸¸ï¼ŒåŒ…æ‹¬éœ€è¦å¤„ç†å“ªäº›å¼‚å¸¸ï¼Œæ€æ ·å¤„ç†ç­‰ç­‰ã€‚è¿™ä¹Ÿæ˜¯ç»å¤§å¤šæ•°å¼€å‘å›¢é˜Ÿéƒ½ä¼šåˆ¶å®šä¸€äº›è§„åˆ™æ¥è§„èŒƒè¿›è¡Œå¼‚å¸¸å¤„ç†çš„åŸå› ã€‚ å½“ä½ æŠ›å‡ºæˆ–æ•è·å¼‚å¸¸çš„æ—¶å€™ï¼Œæœ‰å¾ˆå¤šä¸åŒçš„æƒ…å†µéœ€è¦è€ƒè™‘ï¼Œè€Œä¸”å¤§éƒ¨åˆ†äº‹æƒ…éƒ½æ˜¯ä¸ºäº†æ”¹å–„ä»£ç çš„å¯è¯»æ€§æˆ–è€… API çš„å¯ç”¨æ€§ã€‚ å¼‚å¸¸ä¸ä»…ä»…æ˜¯ä¸€ä¸ªé”™è¯¯æ§åˆ¶æœºåˆ¶ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé€šä¿¡åª’ä»‹ã€‚å› æ­¤ï¼Œä¸ºäº†å’ŒåŒäº‹æ›´å¥½çš„åˆä½œï¼Œä¸€ä¸ªå›¢é˜Ÿå¿…é¡»è¦åˆ¶å®šå‡ºä¸€ä¸ªæœ€ä½³å®è·µå’Œè§„åˆ™ï¼Œåªæœ‰è¿™æ ·ï¼Œå›¢é˜Ÿæˆå‘˜æ‰èƒ½ç†è§£è¿™äº›é€šç”¨æ¦‚å¿µï¼ŒåŒæ—¶åœ¨å·¥ä½œä¸­ä½¿ç”¨å®ƒã€‚ è¿™é‡Œç»™å‡ºå‡ ä¸ªè¢«å¾ˆå¤šå›¢é˜Ÿä½¿ç”¨çš„å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µã€‚ åªé’ˆå¯¹ä¸æ­£å¸¸çš„æƒ…å†µæ‰ä½¿ç”¨å¼‚å¸¸ å¼‚å¸¸åªåº”è¯¥è¢«ç”¨äºä¸æ­£å¸¸çš„æ¡ä»¶ï¼Œå®ƒä»¬æ°¸è¿œä¸åº”è¯¥è¢«ç”¨äºæ­£å¸¸çš„æ§åˆ¶æµã€‚ã€Šé˜¿é‡Œæ‰‹å†Œã€‹ä¸­ï¼šã€å¼ºåˆ¶ã€‘Java ç±»åº“ä¸­å®šä¹‰çš„å¯ä»¥é€šè¿‡é¢„æ£€æŸ¥æ–¹å¼è§„é¿çš„RuntimeExceptionå¼‚å¸¸ä¸åº”è¯¥é€šè¿‡catch çš„æ–¹å¼æ¥å¤„ç†ï¼Œæ¯”å¦‚ï¼šNullPointerExceptionï¼ŒIndexOutOfBoundsExceptionç­‰ç­‰ã€‚ æ¯”å¦‚ï¼Œåœ¨è§£æå­—ç¬¦ä¸²å½¢å¼çš„æ•°å­—æ—¶ï¼Œå¯èƒ½å­˜åœ¨æ•°å­—æ ¼å¼é”™è¯¯ï¼Œä¸å¾—é€šè¿‡catch Exceptionæ¥å®ç° ä»£ç 1 123if (obj != null) &#123; //...&#125; ä»£ç 2 12345try &#123; obj.method(); &#125; catch (NullPointerException e) &#123; //...&#125; ä¸»è¦åŸå› æœ‰ä¸‰ç‚¹ï¼š å¼‚å¸¸æœºåˆ¶çš„è®¾è®¡åˆè¡·æ˜¯ç”¨äºä¸æ­£å¸¸çš„æƒ…å†µï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šä¼šJVMå®ç°è¯•å›¾å¯¹å®ƒä»¬çš„æ€§èƒ½è¿›è¡Œä¼˜åŒ–ã€‚æ‰€ä»¥ï¼Œåˆ›å»ºã€æŠ›å‡ºå’Œæ•è·å¼‚å¸¸çš„å¼€é”€æ˜¯å¾ˆæ˜‚è´µçš„ã€‚ æŠŠä»£ç æ”¾åœ¨try-catchä¸­è¿”å›é˜»æ­¢äº†JVMå®ç°æœ¬æ¥å¯èƒ½è¦æ‰§è¡Œçš„æŸäº›ç‰¹å®šçš„ä¼˜åŒ–ã€‚ å¯¹æ•°ç»„è¿›è¡Œéå†çš„æ ‡å‡†æ¨¡å¼å¹¶ä¸ä¼šå¯¼è‡´å†—ä½™çš„æ£€æŸ¥ï¼Œæœ‰äº›ç°ä»£çš„JVMå®ç°ä¼šå°†å®ƒä»¬ä¼˜åŒ–æ‰ã€‚ åœ¨ finally å—ä¸­æ¸…ç†èµ„æºæˆ–è€…ä½¿ç”¨ try-with-resource è¯­å¥å½“ä½¿ç”¨ç±»ä¼¼InputStreamè¿™ç§éœ€è¦ä½¿ç”¨åå…³é—­çš„èµ„æºæ—¶ï¼Œä¸€ä¸ªå¸¸è§çš„é”™è¯¯å°±æ˜¯åœ¨tryå—çš„æœ€åå…³é—­èµ„æºã€‚ é”™è¯¯ç¤ºä¾‹ 1234567891011121314public void doNotCloseResourceInTry() &#123; FileInputStream inputStream = null; try &#123; File file = new File(&quot;./tmp.txt&quot;); inputStream = new FileInputStream(file); // use the inputStream to read a file // do NOT do this inputStream.close(); &#125; catch (FileNotFoundException e) &#123; log.error(e); &#125; catch (IOException e) &#123; log.error(e); &#125;&#125; é—®é¢˜å°±æ˜¯ï¼Œåªæœ‰æ²¡æœ‰å¼‚å¸¸æŠ›å‡ºçš„æ—¶å€™ï¼Œè¿™æ®µä»£ç æ‰å¯ä»¥æ­£å¸¸å·¥ä½œã€‚try ä»£ç å—å†…ä»£ç ä¼šæ­£å¸¸æ‰§è¡Œï¼Œå¹¶ä¸”èµ„æºå¯ä»¥æ­£å¸¸å…³é—­ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨ try ä»£ç å—æ˜¯æœ‰åŸå› çš„ï¼Œä¸€èˆ¬è°ƒç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•ï¼Œè€Œä¸”ï¼Œä½ è‡ªå·±ä¹Ÿå¯èƒ½ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™æ„å‘³ç€ä»£ç å¯èƒ½ä¸ä¼šæ‰§è¡Œåˆ° try ä»£ç å—çš„æœ€åéƒ¨åˆ†ã€‚ç»“æœå°±æ˜¯ï¼Œä½ å¹¶æ²¡æœ‰å…³é—­èµ„æºã€‚ æ‰€ä»¥ï¼Œä½ åº”è¯¥æŠŠæ¸…ç†å·¥ä½œçš„ä»£ç æ”¾åˆ° finally é‡Œå»ï¼Œæˆ–è€…ä½¿ç”¨ try-with-resource ç‰¹æ€§ã€‚ æ–¹æ³•ä¸€ï¼šä½¿ç”¨ finally ä»£ç å— ä¸å‰é¢å‡ è¡Œ try ä»£ç å—ä¸åŒï¼Œfinally ä»£ç å—æ€»æ˜¯ä¼šè¢«æ‰§è¡Œã€‚ä¸ç®¡ try ä»£ç å—æˆåŠŸæ‰§è¡Œä¹‹åè¿˜æ˜¯ä½ åœ¨ catch ä»£ç å—ä¸­å¤„ç†å®Œå¼‚å¸¸åéƒ½ä¼šæ‰§è¡Œã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç¡®ä¿ä½ æ¸…ç†äº†æ‰€æœ‰æ‰“å¼€çš„èµ„æºã€‚ 123456789101112131415161718public void closeResourceInFinally() &#123; FileInputStream inputStream = null; try &#123; File file = new File(&quot;./tmp.txt&quot;); inputStream = new FileInputStream(file); // use the inputStream to read a file &#125; catch (FileNotFoundException e) &#123; log.error(e); &#125; finally &#123; if (inputStream != null) &#123; try &#123; inputStream.close(); &#125; catch (IOException e) &#123; log.error(e); &#125; &#125; &#125;&#125; æ–¹æ³•äºŒï¼šJava 7 çš„ try-with-resource è¯­æ³• å¦‚æœä½ çš„èµ„æºå®ç°äº† AutoCloseable æ¥å£ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªè¯­æ³•ã€‚å¤§å¤šæ•°çš„ Java æ ‡å‡†èµ„æºéƒ½ç»§æ‰¿äº†è¿™ä¸ªæ¥å£ã€‚å½“ä½ åœ¨ try å­å¥ä¸­æ‰“å¼€èµ„æºï¼Œèµ„æºä¼šåœ¨ try ä»£ç å—æ‰§è¡Œåæˆ–å¼‚å¸¸å¤„ç†åè‡ªåŠ¨å…³é—­ã€‚ 12345678910public void automaticallyCloseResource() &#123; File file = new File(&quot;./tmp.txt&quot;); try (FileInputStream inputStream = new FileInputStream(file);) &#123; // use the inputStream to read a file &#125; catch (FileNotFoundException e) &#123; log.error(e); &#125; catch (IOException e) &#123; log.error(e); &#125;&#125; å°½é‡ä½¿ç”¨æ ‡å‡†çš„å¼‚å¸¸ ä»£ç é‡ç”¨æ˜¯å€¼å¾—æå€¡çš„ï¼Œè¿™æ˜¯ä¸€æ¡é€šç”¨è§„åˆ™ï¼Œå¼‚å¸¸ä¹Ÿä¸ä¾‹å¤–ã€‚ é‡ç”¨ç°æœ‰çš„å¼‚å¸¸æœ‰å‡ ä¸ªå¥½å¤„ï¼š å®ƒä½¿å¾—ä½ çš„APIæ›´åŠ æ˜“äºå­¦ä¹ å’Œä½¿ç”¨ï¼Œå› ä¸ºå®ƒä¸ç¨‹åºå‘˜åŸæ¥å·²ç»ç†Ÿæ‚‰çš„ä¹ æƒ¯ç”¨æ³•æ˜¯ä¸€è‡´çš„ã€‚ å¯¹äºç”¨åˆ°è¿™äº›APIçš„ç¨‹åºè€Œè¨€ï¼Œå®ƒä»¬çš„å¯è¯»æ€§æ›´å¥½ï¼Œå› ä¸ºå®ƒä»¬ä¸ä¼šå……æ–¥ç€ç¨‹åºå‘˜ä¸ç†Ÿæ‚‰çš„å¼‚å¸¸ã€‚ å¼‚å¸¸ç±»è¶Šå°‘ï¼Œæ„å‘³ç€å†…å­˜å ç”¨è¶Šå°ï¼Œå¹¶ä¸”è½¬è½½è¿™äº›ç±»çš„æ—¶é—´å¼€é”€ä¹Ÿè¶Šå°ã€‚ Javaæ ‡å‡†å¼‚å¸¸ä¸­æœ‰å‡ ä¸ªæ˜¯ç»å¸¸è¢«ä½¿ç”¨çš„å¼‚å¸¸ã€‚å¦‚ä¸‹è¡¨æ ¼ï¼š å¼‚å¸¸ ä½¿ç”¨åœºåˆ IllegalArgumentException å‚æ•°çš„å€¼ä¸åˆé€‚ IllegalStateException å‚æ•°çš„çŠ¶æ€ä¸åˆé€‚ NullPointerException åœ¨nullè¢«ç¦æ­¢çš„æƒ…å†µä¸‹å‚æ•°å€¼ä¸ºnull IndexOutOfBoundsException ä¸‹æ ‡è¶Šç•Œ ConcurrentModificationException åœ¨ç¦æ­¢å¹¶å‘ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œå¯¹è±¡æ£€æµ‹åˆ°å¹¶å‘ä¿®æ”¹ UnsupportedOperationException å¯¹è±¡ä¸æ”¯æŒå®¢æˆ·è¯·æ±‚çš„æ–¹æ³• è™½ç„¶å®ƒä»¬æ˜¯Javaå¹³å°åº“è¿„ä»Šä¸ºæ­¢æœ€å¸¸è¢«é‡ç”¨çš„å¼‚å¸¸ï¼Œä½†æ˜¯ï¼Œåœ¨è®¸å¯çš„æ¡ä»¶ä¸‹ï¼Œå…¶å®ƒçš„å¼‚å¸¸ä¹Ÿå¯ä»¥è¢«é‡ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è¦å®ç°è¯¸å¦‚å¤æ•°æˆ–è€…çŸ©é˜µä¹‹ç±»çš„ç®—æœ¯å¯¹è±¡ï¼Œé‚£ä¹ˆé‡ç”¨ArithmeticExceptionå’ŒNumberFormatExceptionå°†æ˜¯éå¸¸åˆé€‚çš„ã€‚å¦‚æœä¸€ä¸ªå¼‚å¸¸æ»¡è¶³ä½ çš„éœ€è¦ï¼Œåˆ™ä¸è¦çŠ¹è±«ï¼Œä½¿ç”¨å°±å¯ä»¥ï¼Œä¸è¿‡ä½ ä¸€å®šè¦ç¡®ä¿æŠ›å‡ºå¼‚å¸¸çš„æ¡ä»¶ä¸è¯¥å¼‚å¸¸çš„æ–‡æ¡£ä¸­æè¿°çš„æ¡ä»¶ä¸€è‡´ã€‚è¿™ç§é‡ç”¨å¿…é¡»å»ºç«‹åœ¨è¯­ä¹‰çš„åŸºç¡€ä¸Šï¼Œè€Œä¸æ˜¯åå­—çš„åŸºç¡€ä¸Šã€‚ æœ€åï¼Œä¸€å®šè¦æ¸…æ¥šï¼Œé€‰æ‹©é‡ç”¨å“ªä¸€ç§å¼‚å¸¸å¹¶æ²¡æœ‰å¿…é¡»éµå¾ªçš„è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘çº¸ç‰Œå¯¹è±¡çš„æƒ…å½¢ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç”¨äºå‘ç‰Œæ“ä½œçš„æ–¹æ³•ï¼Œå®ƒçš„å‚æ•°(handSize)æ˜¯å‘ä¸€æ‰‹ç‰Œçš„çº¸ç‰Œå¼ æ•°ã€‚å‡è®¾è°ƒç”¨è€…åœ¨è¿™ä¸ªå‚æ•°ä¸­ä¼ é€’çš„å€¼å¤§äºæ•´å‰¯ç‰Œçš„å‰©ä½™å¼ æ•°ã€‚é‚£ä¹ˆè¿™ç§æƒ…å½¢æ—¢å¯ä»¥è¢«è§£é‡Šä¸ºIllegalArgumentException(handSizeçš„å€¼å¤ªå¤§)ï¼Œä¹Ÿå¯ä»¥è¢«è§£é‡Šä¸ºIllegalStateException(ç›¸å¯¹å®¢æˆ·çš„è¯·æ±‚è€Œè¨€ï¼Œçº¸ç‰Œå¯¹è±¡çš„çº¸ç‰Œå¤ªå°‘)ã€‚ å¯¹å¼‚å¸¸è¿›è¡Œæ–‡æ¡£è¯´æ˜ å½“åœ¨æ–¹æ³•ä¸Šå£°æ˜æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œä¹Ÿéœ€è¦è¿›è¡Œæ–‡æ¡£è¯´æ˜ã€‚ç›®çš„æ˜¯ä¸ºäº†ç»™è°ƒç”¨è€…æä¾›å°½å¯èƒ½å¤šçš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥æ›´å¥½åœ°é¿å…æˆ–å¤„ç†å¼‚å¸¸ã€‚ åœ¨ Javadoc æ·»åŠ  @throws å£°æ˜ï¼Œå¹¶ä¸”æè¿°æŠ›å‡ºå¼‚å¸¸çš„åœºæ™¯ã€‚ 12345678/*** Method description* * @throws MyBusinessException - businuess exception description*/public void doSomething(String input) throws MyBusinessException &#123; // ...&#125; åŒæ—¶ï¼Œåœ¨æŠ›å‡ºMyBusinessException å¼‚å¸¸æ—¶ï¼Œéœ€è¦å°½å¯èƒ½ç²¾ç¡®åœ°æè¿°é—®é¢˜å’Œç›¸å…³ä¿¡æ¯ï¼Œè¿™æ ·æ— è®ºæ˜¯æ‰“å°åˆ°æ—¥å¿—ä¸­è¿˜æ˜¯åœ¨ç›‘æ§å·¥å…·ä¸­ï¼Œéƒ½èƒ½å¤Ÿæ›´å®¹æ˜“è¢«äººé˜…è¯»ï¼Œä»è€Œå¯ä»¥æ›´å¥½åœ°å®šä½å…·ä½“é”™è¯¯ä¿¡æ¯ã€é”™è¯¯çš„ä¸¥é‡ç¨‹åº¦ç­‰ã€‚ ä¼˜å…ˆæ•è·æœ€å…·ä½“çš„å¼‚å¸¸ å¤§å¤šæ•° IDE éƒ½å¯ä»¥å¸®åŠ©ä½ å®ç°è¿™ä¸ªæœ€ä½³å®è·µã€‚å½“ä½ å°è¯•é¦–å…ˆæ•è·è¾ƒä¸å…·ä½“çš„å¼‚å¸¸æ—¶ï¼Œå®ƒä»¬ä¼šæŠ¥å‘Šæ— æ³•è®¿é—®çš„ä»£ç å—ã€‚ ä½†é—®é¢˜åœ¨äºï¼Œåªæœ‰åŒ¹é…å¼‚å¸¸çš„ç¬¬ä¸€ä¸ª catch å—ä¼šè¢«æ‰§è¡Œã€‚ å› æ­¤ï¼Œå¦‚æœé¦–å…ˆæ•è· IllegalArgumentException ï¼Œåˆ™æ°¸è¿œä¸ä¼šåˆ°è¾¾åº”è¯¥å¤„ç†æ›´å…·ä½“çš„ NumberFormatException çš„ catch å—ï¼Œå› ä¸ºå®ƒæ˜¯ IllegalArgumentException çš„å­ç±»ã€‚ æ€»æ˜¯ä¼˜å…ˆæ•è·æœ€å…·ä½“çš„å¼‚å¸¸ç±»ï¼Œå¹¶å°†ä¸å¤ªå…·ä½“çš„ catch å—æ·»åŠ åˆ°åˆ—è¡¨çš„æœ«å°¾ã€‚ ä½ å¯ä»¥åœ¨ä¸‹é¢çš„ä»£ç ç‰‡æ–­ä¸­çœ‹åˆ°è¿™æ ·ä¸€ä¸ª try-catch è¯­å¥çš„ä¾‹å­ã€‚ ç¬¬ä¸€ä¸ª catch å—å¤„ç†æ‰€æœ‰ NumberFormatException å¼‚å¸¸ï¼Œç¬¬äºŒä¸ªå¤„ç†æ‰€æœ‰é NumberFormatException å¼‚å¸¸çš„IllegalArgumentException å¼‚å¸¸ã€‚ 123456789public void catchMostSpecificExceptionFirst() &#123; try &#123; doSomething(&quot;A message&quot;); &#125; catch (NumberFormatException e) &#123; log.error(e); &#125; catch (IllegalArgumentException e) &#123; log.error(e) &#125;&#125; ä¸è¦æ•è· Throwable ç±» Throwable æ˜¯æ‰€æœ‰å¼‚å¸¸å’Œé”™è¯¯çš„è¶…ç±»ã€‚ä½ å¯ä»¥åœ¨ catch å­å¥ä¸­ä½¿ç”¨å®ƒï¼Œä½†æ˜¯ä½ æ°¸è¿œä¸åº”è¯¥è¿™æ ·åšï¼ å¦‚æœåœ¨ catch å­å¥ä¸­ä½¿ç”¨ Throwable ï¼Œå®ƒä¸ä»…ä¼šæ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œä¹Ÿå°†æ•è·æ‰€æœ‰çš„é”™è¯¯ã€‚JVM æŠ›å‡ºé”™è¯¯ï¼ŒæŒ‡å‡ºä¸åº”è¯¥ç”±åº”ç”¨ç¨‹åºå¤„ç†çš„ä¸¥é‡é—®é¢˜ã€‚ å…¸å‹çš„ä¾‹å­æ˜¯ OutOfMemoryError æˆ–è€… StackOverflowError ã€‚ä¸¤è€…éƒ½æ˜¯ç”±åº”ç”¨ç¨‹åºæ§åˆ¶ä¹‹å¤–çš„æƒ…å†µå¼•èµ·çš„ï¼Œæ— æ³•å¤„ç†ã€‚ æ‰€ä»¥ï¼Œæœ€å¥½ä¸è¦æ•è· Throwable ï¼Œé™¤éä½ ç¡®å®šè‡ªå·±å¤„äºä¸€ç§ç‰¹æ®Šçš„æƒ…å†µä¸‹èƒ½å¤Ÿå¤„ç†é”™è¯¯ã€‚ 1234567public void doNotCatchThrowable() &#123; try &#123; // do something &#125; catch (Throwable t) &#123; // don&#x27;t do this! &#125;&#125; ä¸è¦å¿½ç•¥å¼‚å¸¸ å¾ˆå¤šæ—¶å€™ï¼Œå¼€å‘è€…å¾ˆæœ‰è‡ªä¿¡ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤å†™äº†ä¸€ä¸ªcatchå—ï¼Œä½†æ˜¯æ²¡æœ‰åšä»»ä½•å¤„ç†æˆ–è€…è®°å½•æ—¥å¿—ã€‚ 1234567public void doNotIgnoreExceptions() &#123; try &#123; // do something &#125; catch (NumberFormatException e) &#123; // this will never happen &#125;&#125; ä½†ç°å®æ˜¯ç»å¸¸ä¼šå‡ºç°æ— æ³•é¢„æ–™çš„å¼‚å¸¸ï¼Œæˆ–è€…æ— æ³•ç¡®å®šè¿™é‡Œçš„ä»£ç æœªæ¥æ˜¯ä¸æ˜¯ä¼šæ”¹åŠ¨(åˆ é™¤äº†é˜»æ­¢å¼‚å¸¸æŠ›å‡ºçš„ä»£ç )ï¼Œè€Œæ­¤æ—¶ç”±äºå¼‚å¸¸è¢«æ•è·ï¼Œä½¿å¾—æ— æ³•æ‹¿åˆ°è¶³å¤Ÿçš„é”™è¯¯ä¿¡æ¯æ¥å®šä½é—®é¢˜ã€‚ åˆç†çš„åšæ³•æ˜¯è‡³å°‘è¦è®°å½•å¼‚å¸¸çš„ä¿¡æ¯ã€‚ 1234567public void logAnException() &#123; try &#123; // do something &#125; catch (NumberFormatException e) &#123; log.error(&quot;This should never happen: &quot; + e); // see this line &#125;&#125; ä¸è¦è®°å½•å¹¶æŠ›å‡ºå¼‚å¸¸ è¿™å¯èƒ½æ˜¯æœ¬æ–‡ä¸­æœ€å¸¸è¢«å¿½ç•¥çš„æœ€ä½³å®è·µã€‚ å¯ä»¥å‘ç°å¾ˆå¤šä»£ç ç”šè‡³ç±»åº“ä¸­éƒ½ä¼šæœ‰æ•è·å¼‚å¸¸ã€è®°å½•æ—¥å¿—å¹¶å†æ¬¡æŠ›å‡ºçš„é€»è¾‘ã€‚å¦‚ä¸‹ï¼š 123456try &#123; new Long(&quot;xyz&quot;);&#125; catch (NumberFormatException e) &#123; log.error(e); throw e;&#125; è¿™ä¸ªå¤„ç†é€»è¾‘çœ‹ç€æ˜¯åˆç†çš„ã€‚ä½†è¿™ç»å¸¸ä¼šç»™åŒä¸€ä¸ªå¼‚å¸¸è¾“å‡ºå¤šæ¡æ—¥å¿—ã€‚å¦‚ä¸‹ï¼š 123456717:44:28,945 ERROR TestExceptionHandling:65 - java.lang.NumberFormatException: For input string: &quot;xyz&quot;Exception in thread &quot;main&quot; java.lang.NumberFormatException: For input string: &quot;xyz&quot;at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65)at java.lang.Long.parseLong(Long.java:589)at java.lang.Long.(Long.java:965)at com.stackify.example.TestExceptionHandling.logAndThrowException(TestExceptionHandling.java:63)at com.stackify.example.TestExceptionHandling.main(TestExceptionHandling.java:58) å¦‚ä¸Šæ‰€ç¤ºï¼Œåé¢çš„æ—¥å¿—ä¹Ÿæ²¡æœ‰é™„åŠ æ›´æœ‰ç”¨çš„ä¿¡æ¯ã€‚å¦‚æœæƒ³è¦æä¾›æ›´åŠ æœ‰ç”¨çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥å°†å¼‚å¸¸åŒ…è£…ä¸ºè‡ªå®šä¹‰å¼‚å¸¸ã€‚ 1234567public void wrapException(String input) throws MyBusinessException &#123; try &#123; // do something &#125; catch (NumberFormatException e) &#123; throw new MyBusinessException(&quot;A message that describes the error.&quot;, e); &#125;&#125; å› æ­¤ï¼Œä»…ä»…å½“æƒ³è¦å¤„ç†å¼‚å¸¸æ—¶æ‰å»æ•è·ï¼Œå¦åˆ™åªéœ€è¦åœ¨æ–¹æ³•ç­¾åä¸­å£°æ˜è®©è°ƒç”¨è€…å»å¤„ç†ã€‚ åŒ…è£…å¼‚å¸¸æ—¶ä¸è¦æŠ›å¼ƒåŸå§‹çš„å¼‚å¸¸æ•è·æ ‡å‡†å¼‚å¸¸å¹¶åŒ…è£…ä¸ºè‡ªå®šä¹‰å¼‚å¸¸æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„åšæ³•ã€‚è¿™æ ·å¯ä»¥æ·»åŠ æ›´ä¸ºå…·ä½“çš„å¼‚å¸¸ä¿¡æ¯å¹¶èƒ½å¤Ÿåšé’ˆå¯¹çš„å¼‚å¸¸å¤„ç†ã€‚ åœ¨ä½ è¿™æ ·åšæ—¶ï¼Œè¯·ç¡®ä¿å°†åŸå§‹å¼‚å¸¸è®¾ç½®ä¸ºåŸå› ï¼ˆæ³¨ï¼šå‚è€ƒä¸‹æ–¹ä»£ç  NumberFormatException e ä¸­çš„åŸå§‹å¼‚å¸¸ e ï¼‰ã€‚Exception ç±»æä¾›äº†ç‰¹æ®Šçš„æ„é€ å‡½æ•°æ–¹æ³•ï¼Œå®ƒæ¥å—ä¸€ä¸ª Throwable ä½œä¸ºå‚æ•°ã€‚å¦åˆ™ï¼Œä½ å°†ä¼šä¸¢å¤±å †æ ˆè·Ÿè¸ªå’ŒåŸå§‹å¼‚å¸¸çš„æ¶ˆæ¯ï¼Œè¿™å°†ä¼šä½¿åˆ†æå¯¼è‡´å¼‚å¸¸çš„å¼‚å¸¸äº‹ä»¶å˜å¾—å›°éš¾ã€‚ 1234567public void wrapException(String input) throws MyBusinessException &#123; try &#123; // do something &#125; catch (NumberFormatException e) &#123; throw new MyBusinessException(&quot;A message that describes the error.&quot;, e); &#125;&#125; ä¸è¦ä½¿ç”¨å¼‚å¸¸æ§åˆ¶ç¨‹åºçš„æµç¨‹ä¸åº”è¯¥ä½¿ç”¨å¼‚å¸¸æ§åˆ¶åº”ç”¨çš„æ‰§è¡Œæµç¨‹ï¼Œä¾‹å¦‚ï¼Œæœ¬åº”è¯¥ä½¿ç”¨ifè¯­å¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­çš„æƒ…å†µä¸‹ï¼Œä½ å´ä½¿ç”¨å¼‚å¸¸å¤„ç†ï¼Œè¿™æ˜¯éå¸¸ä¸å¥½çš„ä¹ æƒ¯ï¼Œä¼šä¸¥é‡å½±å“åº”ç”¨çš„æ€§èƒ½ã€‚ ä¸è¦åœ¨finallyå—ä¸­ä½¿ç”¨returnã€‚tryå—ä¸­çš„returnè¯­å¥æ‰§è¡ŒæˆåŠŸåï¼Œå¹¶ä¸é©¬ä¸Šè¿”å›ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œfinallyå—ä¸­çš„è¯­å¥ï¼Œå¦‚æœæ­¤å¤„å­˜åœ¨returnè¯­å¥ï¼Œåˆ™åœ¨æ­¤ç›´æ¥è¿”å›ï¼Œæ— æƒ…ä¸¢å¼ƒæ‰tryå—ä¸­çš„è¿”å›ç‚¹ã€‚ å¦‚ä¸‹æ˜¯ä¸€ä¸ªåä¾‹ï¼š 12345678910private int x = 0;public int checkReturn() &#123; try &#123; // xç­‰äº1ï¼Œæ­¤å¤„ä¸è¿”å› return ++x; &#125; finally &#123; // è¿”å›çš„ç»“æœæ˜¯2 return ++x; &#125;&#125; æ·±å…¥ç†è§£å¼‚å¸¸ æç¤º æˆ‘ä»¬å†æ·±å…¥ç†è§£ä¸‹å¼‚å¸¸ï¼Œçœ‹ä¸‹åº•å±‚å®ç°ã€‚ JVMå¤„ç†å¼‚å¸¸çš„æœºåˆ¶ï¼Ÿæåˆ°JVMå¤„ç†å¼‚å¸¸çš„æœºåˆ¶ï¼Œå°±éœ€è¦æåŠException Tableï¼Œä»¥ä¸‹ç§°ä¸ºå¼‚å¸¸è¡¨ã€‚æˆ‘ä»¬æš‚ä¸”ä¸æ€¥äºä»‹ç»å¼‚å¸¸è¡¨ï¼Œå…ˆçœ‹ä¸€ä¸ªç®€å•çš„ Java å¤„ç†å¼‚å¸¸çš„å°ä¾‹å­ã€‚ 1234567public static void simpleTryCatch() &#123; try &#123; testNPE(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125;&#125; ä¸Šé¢çš„ä»£ç æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œç”¨æ¥æ•è·å¤„ç†ä¸€ä¸ªæ½œåœ¨çš„ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ å½“ç„¶å¦‚æœåªæ˜¯çœ‹ç®€ç®€å•å•çš„ä»£ç ï¼Œæˆ‘ä»¬å¾ˆéš¾çœ‹å‡ºä»€ä¹ˆé«˜æ·±ä¹‹å¤„ï¼Œæ›´æ²¡æœ‰äº†ä»Šå¤©æ–‡ç« è¦è°ˆè®ºçš„å†…å®¹ã€‚ æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€æŠŠç¥å…µåˆ©å™¨ï¼Œå®ƒå°±æ˜¯javap,ä¸€ä¸ªç”¨æ¥æ‹†è§£classæ–‡ä»¶çš„å·¥å…·ï¼Œå’Œjavacä¸€æ ·ç”±JDKæä¾›ã€‚ ç„¶åæˆ‘ä»¬ä½¿ç”¨javapæ¥åˆ†æè¿™æ®µä»£ç ï¼ˆéœ€è¦å…ˆä½¿ç”¨javacç¼–è¯‘ï¼‰ 123456789101112//javap -c Main public static void simpleTryCatch(); Code: 0: invokestatic #3 // Method testNPE:()V 3: goto 11 6: astore_0 7: aload_0 8: invokevirtual #5 // Method java/lang/Exception.printStackTrace:()V 11: return Exception table: from to target type 0 3 6 Class java/lang/Exception çœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼Œåº”è¯¥ä¼šæœ‰ä¼šå¿ƒä¸€ç¬‘ï¼Œå› ä¸ºç»ˆäºçœ‹åˆ°äº†Exception tableï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦ç ”ç©¶çš„å¼‚å¸¸è¡¨ã€‚ å¼‚å¸¸è¡¨ä¸­åŒ…å«äº†ä¸€ä¸ªæˆ–å¤šä¸ªå¼‚å¸¸å¤„ç†è€…(Exception Handler)çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åŒ…å«å¦‚ä¸‹ from å¯èƒ½å‘ç”Ÿå¼‚å¸¸çš„èµ·å§‹ç‚¹ to å¯èƒ½å‘ç”Ÿå¼‚å¸¸çš„ç»“æŸç‚¹ target ä¸Šè¿°fromå’Œtoä¹‹å‰å‘ç”Ÿå¼‚å¸¸åçš„å¼‚å¸¸å¤„ç†è€…çš„ä½ç½® type å¼‚å¸¸å¤„ç†è€…å¤„ç†çš„å¼‚å¸¸çš„ç±»ä¿¡æ¯ é‚£ä¹ˆå¼‚å¸¸è¡¨ç”¨åœ¨ä»€ä¹ˆæ—¶å€™å‘¢ ç­”æ¡ˆæ˜¯å¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œå½“ä¸€ä¸ªå¼‚å¸¸å‘ç”Ÿæ—¶ 1.JVMä¼šåœ¨å½“å‰å‡ºç°å¼‚å¸¸çš„æ–¹æ³•ä¸­ï¼ŒæŸ¥æ‰¾å¼‚å¸¸è¡¨ï¼Œæ˜¯å¦æœ‰åˆé€‚çš„å¤„ç†è€…æ¥å¤„ç† 2.å¦‚æœå½“å‰æ–¹æ³•å¼‚å¸¸è¡¨ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å¼‚å¸¸ç¬¦åˆå¤„ç†è€…çš„fromå’ŒtoèŠ‚ç‚¹ï¼Œå¹¶ä¸”typeä¹ŸåŒ¹é…ï¼Œåˆ™JVMè°ƒç”¨ä½äºtargetçš„è°ƒç”¨è€…æ¥å¤„ç†ã€‚ 3.å¦‚æœä¸Šä¸€æ¡æœªæ‰¾åˆ°åˆç†çš„å¤„ç†è€…ï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾å¼‚å¸¸è¡¨ä¸­çš„å‰©ä½™æ¡ç›® 4.å¦‚æœå½“å‰æ–¹æ³•çš„å¼‚å¸¸è¡¨æ— æ³•å¤„ç†ï¼Œåˆ™å‘ä¸ŠæŸ¥æ‰¾ï¼ˆå¼¹æ ˆå¤„ç†ï¼‰åˆšåˆšè°ƒç”¨è¯¥æ–¹æ³•çš„è°ƒç”¨å¤„ï¼Œå¹¶é‡å¤ä¸Šé¢çš„æ“ä½œã€‚ 5.å¦‚æœæ‰€æœ‰çš„æ ˆå¸§è¢«å¼¹å‡ºï¼Œä»ç„¶æ²¡æœ‰å¤„ç†ï¼Œåˆ™æŠ›ç»™å½“å‰çš„Threadï¼ŒThreadåˆ™ä¼šç»ˆæ­¢ã€‚ 6.å¦‚æœå½“å‰Threadä¸ºæœ€åä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹ï¼Œä¸”æœªå¤„ç†å¼‚å¸¸ï¼Œåˆ™ä¼šå¯¼è‡´JVMç»ˆæ­¢è¿è¡Œã€‚ ä»¥ä¸Šå°±æ˜¯JVMå¤„ç†å¼‚å¸¸çš„ä¸€äº›æœºåˆ¶ã€‚ try-catch -finally é™¤äº†ç®€å•çš„try-catchå¤–ï¼Œæˆ‘ä»¬è¿˜å¸¸å¸¸å’Œfinallyåšç»“åˆä½¿ç”¨ã€‚æ¯”å¦‚è¿™æ ·çš„ä»£ç  123456789public static void simpleTryCatchFinally() &#123; try &#123; testNPE(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; System.out.println(&quot;Finally&quot;); &#125;&#125; åŒæ ·æˆ‘ä»¬ä½¿ç”¨javapåˆ†æä¸€ä¸‹ä»£ç  1234567891011121314151617181920212223242526public static void simpleTryCatchFinally(); Code: 0: invokestatic #3 // Method testNPE:()V 3: getstatic #6 // Field java/lang/System.out:Ljava/io/PrintStream; 6: ldc #7 // String Finally 8: invokevirtual #8 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 11: goto 41 14: astore_0 15: aload_0 16: invokevirtual #5 // Method java/lang/Exception.printStackTrace:()V 19: getstatic #6 // Field java/lang/System.out:Ljava/io/PrintStream; 22: ldc #7 // String Finally 24: invokevirtual #8 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 27: goto 41 30: astore_1 31: getstatic #6 // Field java/lang/System.out:Ljava/io/PrintStream; 34: ldc #7 // String Finally 36: invokevirtual #8 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 39: aload_1 40: athrow 41: return Exception table: from to target type 0 3 14 Class java/lang/Exception 0 3 30 any 14 19 30 any å’Œä¹‹å‰æœ‰æ‰€ä¸åŒï¼Œè¿™æ¬¡å¼‚å¸¸è¡¨ä¸­ï¼Œæœ‰ä¸‰æ¡æ•°æ®ï¼Œè€Œæˆ‘ä»¬ä»…ä»…æ•è·äº†ä¸€ä¸ªException, å¼‚å¸¸è¡¨çš„åä¸¤ä¸ªitemçš„typeä¸ºany; ä¸Šé¢çš„ä¸‰æ¡å¼‚å¸¸è¡¨itemçš„æ„æ€ä¸º: å¦‚æœ0åˆ°3ä¹‹é—´ï¼Œå‘ç”Ÿäº†Exceptionç±»å‹çš„å¼‚å¸¸ï¼Œè°ƒç”¨14ä½ç½®çš„å¼‚å¸¸å¤„ç†è€…ã€‚ å¦‚æœ0åˆ°3ä¹‹é—´ï¼Œæ— è®ºå‘ç”Ÿä»€ä¹ˆå¼‚å¸¸ï¼Œéƒ½è°ƒç”¨30ä½ç½®çš„å¤„ç†è€… å¦‚æœ14åˆ°19ä¹‹é—´ï¼ˆå³catchéƒ¨åˆ†ï¼‰ï¼Œä¸è®ºå‘ç”Ÿä»€ä¹ˆå¼‚å¸¸ï¼Œéƒ½è°ƒç”¨30ä½ç½®çš„å¤„ç†è€…ã€‚ å†æ¬¡åˆ†æä¸Šé¢çš„Javaä»£ç ï¼Œfinallyé‡Œé¢çš„éƒ¨åˆ†å·²ç»è¢«æå–åˆ°äº†tryéƒ¨åˆ†å’Œcatchéƒ¨åˆ†ã€‚æˆ‘ä»¬å†æ¬¡è°ƒä¸€ä¸‹ä»£ç æ¥çœ‹ä¸€ä¸‹ 1234567891011121314151617181920212223242526public static void simpleTryCatchFinally(); Code: //try éƒ¨åˆ†æå–finallyä»£ç ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸å‘ç”Ÿï¼Œåˆ™æ‰§è¡Œè¾“å‡ºfinallyæ“ä½œï¼Œç›´è‡³gotoåˆ°41ä½ç½®ï¼Œæ‰§è¡Œè¿”å›æ“ä½œã€‚ 0: invokestatic #3 // Method testNPE:()V 3: getstatic #6 // Field java/lang/System.out:Ljava/io/PrintStream; 6: ldc #7 // String Finally 8: invokevirtual #8 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 11: goto 41 //catchéƒ¨åˆ†æå–finallyä»£ç ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸å‘ç”Ÿï¼Œåˆ™æ‰§è¡Œè¾“å‡ºfinallyæ“ä½œï¼Œç›´è‡³æ‰§è¡Œgotåˆ°41ä½ç½®ï¼Œæ‰§è¡Œè¿”å›æ“ä½œã€‚ 14: astore_0 15: aload_0 16: invokevirtual #5 // Method java/lang/Exception.printStackTrace:()V 19: getstatic #6 // Field java/lang/System.out:Ljava/io/PrintStream; 22: ldc #7 // String Finally 24: invokevirtual #8 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 27: goto 41 //finallyéƒ¨åˆ†çš„ä»£ç å¦‚æœè¢«è°ƒç”¨ï¼Œæœ‰å¯èƒ½æ˜¯tryéƒ¨åˆ†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯catchéƒ¨åˆ†å‘ç”Ÿå¼‚å¸¸ã€‚ 30: astore_1 31: getstatic #6 // Field java/lang/System.out:Ljava/io/PrintStream; 34: ldc #7 // String Finally 36: invokevirtual #8 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 39: aload_1 40: athrow //å¦‚æœå¼‚å¸¸æ²¡æœ‰è¢«catchæ•è·ï¼Œè€Œæ˜¯åˆ°äº†è¿™é‡Œï¼Œæ‰§è¡Œå®Œfinallyçš„è¯­å¥åï¼Œä»ç„¶è¦æŠŠè¿™ä¸ªå¼‚å¸¸æŠ›å‡ºå»ï¼Œä¼ é€’ç»™è°ƒç”¨å¤„ã€‚ 41: return Catchå…ˆåé¡ºåºçš„é—®é¢˜ æˆ‘ä»¬åœ¨ä»£ç ä¸­çš„catchçš„é¡ºåºå†³å®šäº†å¼‚å¸¸å¤„ç†è€…åœ¨å¼‚å¸¸è¡¨çš„ä½ç½®ï¼Œæ‰€ä»¥ï¼Œè¶Šæ˜¯å…·ä½“çš„å¼‚å¸¸è¦å…ˆå¤„ç†ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸‹é¢çš„é—®é¢˜ 123456789private static void misuseCatchException() &#123; try &#123; testNPE(); &#125; catch (Throwable t) &#123; t.printStackTrace(); &#125; catch (Exception e) &#123; //error occurs during compilings with tips Exception Java.lang.Exception has already benn caught. e.printStackTrace(); &#125;&#125; è¿™æ®µä»£ç ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥ï¼Œå› ä¸ºå…ˆæ•è·Throwableåæ•è·Exceptionï¼Œä¼šå¯¼è‡´åé¢çš„catchæ°¸è¿œæ— æ³•è¢«æ‰§è¡Œã€‚ Return å’Œfinallyçš„é—®é¢˜ è¿™ç®—æ˜¯æˆ‘ä»¬æ‰©å±•çš„ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒæç«¯çš„é—®é¢˜ï¼Œå°±æ˜¯ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼Œæ—¢æœ‰returnï¼Œåˆæœ‰finallyï¼Œé‚£ä¹ˆfinallyå¯¼è‡´ä¼šä¸ä¼šæ‰§è¡Œ 12345678910public static String tryCatchReturn() &#123; try &#123; testNPE(); return &quot;OK&quot;; &#125; catch (Exception e) &#123; return &quot;ERROR&quot;; &#125; finally &#123; System.out.println(&quot;tryCatchReturn&quot;); &#125;&#125; ç­”æ¡ˆæ˜¯finallyä¼šæ‰§è¡Œï¼Œé‚£ä¹ˆè¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆfinallyä¼šæ‰§è¡Œã€‚ 123456789101112131415161718192021222324public static java.lang.String tryCatchReturn(); Code: 0: invokestatic #3 // Method testNPE:()V 3: ldc #6 // String OK 5: astore_0 6: getstatic #7 // Field java/lang/System.out:Ljava/io/PrintStream; 9: ldc #8 // String tryCatchReturn 11: invokevirtual #9 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 14: aload_0 15: areturn è¿”å›OKå­—ç¬¦ä¸²ï¼Œareturnæ„æ€ä¸ºreturn a reference from a method 16: astore_0 17: ldc #10 // String ERROR 19: astore_1 20: getstatic #7 // Field java/lang/System.out:Ljava/io/PrintStream; 23: ldc #8 // String tryCatchReturn 25: invokevirtual #9 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 28: aload_1 29: areturn //è¿”å›ERRORå­—ç¬¦ä¸² 30: astore_2 31: getstatic #7 // Field java/lang/System.out:Ljava/io/PrintStream; 34: ldc #8 // String tryCatchReturn 36: invokevirtual #9 // Method java/io/PrintStream.println:(Ljava/lang/String;)V 39: aload_2 40: athrow å¦‚æœcatchæœ‰æœªå¤„ç†çš„å¼‚å¸¸ï¼ŒæŠ›å‡ºå»ã€‚ å¼‚å¸¸æ˜¯å¦è€—æ—¶ï¼Ÿä¸ºä»€ä¹ˆä¼šè€—æ—¶ï¼Ÿè¯´ç”¨å¼‚å¸¸æ…¢ï¼Œé¦–å…ˆæ¥çœ‹çœ‹å¼‚å¸¸æ…¢åœ¨å“ªé‡Œï¼Ÿæœ‰å¤šæ…¢ï¼Ÿä¸‹é¢çš„æµ‹è¯•ç”¨ä¾‹ç®€å•çš„æµ‹è¯•äº†å»ºç«‹å¯¹è±¡ã€å»ºç«‹å¼‚å¸¸å¯¹è±¡ã€æŠ›å‡ºå¹¶æ¥ä½å¼‚å¸¸å¯¹è±¡ä¸‰è€…çš„è€—æ—¶å¯¹æ¯”ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public class ExceptionTest &#123; private int testTimes; public ExceptionTest(int testTimes) &#123; this.testTimes = testTimes; &#125; public void newObject() &#123; long l = System.nanoTime(); for (int i = 0; i &lt; testTimes; i++) &#123; new Object(); &#125; System.out.println(&quot;å»ºç«‹å¯¹è±¡ï¼š&quot; + (System.nanoTime() - l)); &#125; public void newException() &#123; long l = System.nanoTime(); for (int i = 0; i &lt; testTimes; i++) &#123; new Exception(); &#125; System.out.println(&quot;å»ºç«‹å¼‚å¸¸å¯¹è±¡ï¼š&quot; + (System.nanoTime() - l)); &#125; public void catchException() &#123; long l = System.nanoTime(); for (int i = 0; i &lt; testTimes; i++) &#123; try &#123; throw new Exception(); &#125; catch (Exception e) &#123; &#125; &#125; System.out.println(&quot;å»ºç«‹ã€æŠ›å‡ºå¹¶æ¥ä½å¼‚å¸¸å¯¹è±¡ï¼š&quot; + (System.nanoTime() - l)); &#125; public static void main(String[] args) &#123; ExceptionTest test = new ExceptionTest(10000); test.newObject(); test.newException(); test.catchException(); &#125; &#125; è¿è¡Œç»“æœï¼š 123å»ºç«‹å¯¹è±¡ï¼š575817 å»ºç«‹å¼‚å¸¸å¯¹è±¡ï¼š9589080 å»ºç«‹ã€æŠ›å‡ºå¹¶æ¥ä½å¼‚å¸¸å¯¹è±¡ï¼š47394475 å»ºç«‹ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œæ˜¯å»ºç«‹ä¸€ä¸ªæ™®é€šObjectè€—æ—¶çš„çº¦20å€ï¼ˆå®é™…ä¸Šå·®è·ä¼šæ¯”è¿™ä¸ªæ•°å­—æ›´å¤§ä¸€äº›ï¼Œå› ä¸ºå¾ªç¯ä¹Ÿå ç”¨äº†æ—¶é—´ï¼Œè¿½æ±‚ç²¾ç¡®çš„è¯»è€…å¯ä»¥å†æµ‹ä¸€ä¸‹ç©ºå¾ªç¯çš„è€—æ—¶ç„¶ååœ¨å¯¹æ¯”å‰å‡æ‰è¿™éƒ¨åˆ†ï¼‰ï¼Œè€ŒæŠ›å‡ºã€æ¥ä½ä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œæ‰€èŠ±è´¹æ—¶é—´å¤§çº¦æ˜¯å»ºç«‹å¼‚å¸¸å¯¹è±¡çš„4å€ã€‚ é‚£å ç”¨æ—¶é—´çš„â€œå¤§å¤´â€ï¼šæŠ›å‡ºã€æ¥ä½å¼‚å¸¸ï¼Œç³»ç»Ÿåˆ°åº•åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿè¯·å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š https://www.iteye.com/blog/icyfenix-857722 å‚è€ƒæ–‡ç«  https://blog.csdn.net/MacWx/article/details/90204111 https://blog.csdn.net/hguisu/article/details/6155636 https://blog.csdn.net/ThinkWon/article/details/101681073 https://www.cnblogs.com/skywang12345/p/3544287.html https://www.codercto.com/a/33350.html","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"5.Java åŸºç¡€ - æ³¨è§£æœºåˆ¶è¯¦è§£","path":"/2023/12/25/5.Java-åŸºç¡€-æ³¨è§£æœºåˆ¶è¯¦è§£/","content":"æ³¨è§£æ˜¯JDK1.5ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºå¯¹ä»£ç è¿›è¡Œè¯´æ˜ï¼Œå¯ä»¥å¯¹åŒ…ã€ç±»ã€æ¥å£ã€å­—æ®µã€æ–¹æ³•å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰è¿›è¡Œæ³¨è§£ã€‚å®ƒæ˜¯æ¡†æ¶å­¦ä¹ å’Œè®¾è®¡è€…å¿…é¡»æŒæ¡çš„åŸºç¡€ã€‚ æ³¨è§£åŸºç¡€æ³¨è§£æ˜¯JDK1.5ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºå¯¹ä»£ç è¿›è¡Œè¯´æ˜ï¼Œå¯ä»¥å¯¹åŒ…ã€ç±»ã€æ¥å£ã€å­—æ®µã€æ–¹æ³•å‚æ•°ã€å±€éƒ¨å˜é‡ç­‰è¿›è¡Œæ³¨è§£ã€‚å®ƒä¸»è¦çš„ä½œç”¨æœ‰ä»¥ä¸‹å››æ–¹é¢ï¼š ç”Ÿæˆæ–‡æ¡£ï¼Œé€šè¿‡ä»£ç é‡Œæ ‡è¯†çš„å…ƒæ•°æ®ç”Ÿæˆjavadocæ–‡æ¡£ã€‚ ç¼–è¯‘æ£€æŸ¥ï¼Œé€šè¿‡ä»£ç é‡Œæ ‡è¯†çš„å…ƒæ•°æ®è®©ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´è¿›è¡Œæ£€æŸ¥éªŒè¯ã€‚ ç¼–è¯‘æ—¶åŠ¨æ€å¤„ç†ï¼Œç¼–è¯‘æ—¶é€šè¿‡ä»£ç é‡Œæ ‡è¯†çš„å…ƒæ•°æ®åŠ¨æ€å¤„ç†ï¼Œä¾‹å¦‚åŠ¨æ€ç”Ÿæˆä»£ç ã€‚ è¿è¡Œæ—¶åŠ¨æ€å¤„ç†ï¼Œè¿è¡Œæ—¶é€šè¿‡ä»£ç é‡Œæ ‡è¯†çš„å…ƒæ•°æ®åŠ¨æ€å¤„ç†ï¼Œä¾‹å¦‚ä½¿ç”¨åå°„æ³¨å…¥å®ä¾‹ã€‚ è¿™ä¹ˆæ¥è¯´æ˜¯æ¯”è¾ƒæŠ½è±¡çš„ï¼Œæˆ‘ä»¬å…·ä½“çœ‹ä¸‹æ³¨è§£çš„å¸¸è§åˆ†ç±»ï¼š Javaè‡ªå¸¦çš„æ ‡å‡†æ³¨è§£ï¼ŒåŒ…æ‹¬@Overrideã€@Deprecatedå’Œ@SuppressWarningsï¼Œåˆ†åˆ«ç”¨äºæ ‡æ˜é‡å†™æŸä¸ªæ–¹æ³•ã€æ ‡æ˜æŸä¸ªç±»æˆ–æ–¹æ³•è¿‡æ—¶ã€æ ‡æ˜è¦å¿½ç•¥çš„è­¦å‘Šï¼Œç”¨è¿™äº›æ³¨è§£æ ‡æ˜åç¼–è¯‘å™¨å°±ä¼šè¿›è¡Œæ£€æŸ¥ã€‚ å…ƒæ³¨è§£ï¼Œå…ƒæ³¨è§£æ˜¯ç”¨äºå®šä¹‰æ³¨è§£çš„æ³¨è§£ï¼ŒåŒ…æ‹¬@Retentionã€@Targetã€@Inheritedã€@Documentedï¼Œ@Retentionç”¨äºæ ‡æ˜æ³¨è§£è¢«ä¿ç•™çš„é˜¶æ®µï¼Œ@Targetç”¨äºæ ‡æ˜æ³¨è§£ä½¿ç”¨çš„èŒƒå›´ï¼Œ@Inheritedç”¨äºæ ‡æ˜æ³¨è§£å¯ç»§æ‰¿ï¼Œ@Documentedç”¨äºæ ‡æ˜æ˜¯å¦ç”Ÿæˆjavadocæ–‡æ¡£ã€‚ è‡ªå®šä¹‰æ³¨è§£ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šä¹‰æ³¨è§£ï¼Œå¹¶å¯ç”¨å…ƒæ³¨è§£å¯¹è‡ªå®šä¹‰æ³¨è§£è¿›è¡Œæ³¨è§£ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡è¿™ä¸ªåˆ†ç±»è§’åº¦æ¥ç†è§£æ³¨è§£ã€‚ Javaå†…ç½®æ³¨è§£æˆ‘ä»¬ä»æœ€ä¸ºå¸¸è§çš„Javaå†…ç½®çš„æ³¨è§£å¼€å§‹è¯´èµ·ï¼Œå…ˆçœ‹ä¸‹ä¸‹é¢çš„ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233class A&#123; public void test() &#123; &#125;&#125;class B extends A&#123; /** * é‡è½½çˆ¶ç±»çš„testæ–¹æ³• */ @Override public void test() &#123; &#125; /** * è¢«å¼ƒç”¨çš„æ–¹æ³• */ @Deprecated public void oldMethod() &#123; &#125; /** * å¿½ç•¥å‘Šè­¦ * * @return */ @SuppressWarnings(&quot;rawtypes&quot;) public List processList() &#123; List list = new ArrayList(); return list; &#125;&#125; Java 1.5å¼€å§‹è‡ªå¸¦çš„æ ‡å‡†æ³¨è§£ï¼ŒåŒ…æ‹¬@Overrideã€@Deprecatedå’Œ@SuppressWarningsï¼š @Overrideï¼šè¡¨ç¤ºå½“å‰çš„æ–¹æ³•å®šä¹‰å°†è¦†ç›–çˆ¶ç±»ä¸­çš„æ–¹æ³• @Deprecatedï¼šè¡¨ç¤ºä»£ç è¢«å¼ƒç”¨ï¼Œå¦‚æœä½¿ç”¨äº†è¢«@Deprecatedæ³¨è§£çš„ä»£ç åˆ™ç¼–è¯‘å™¨å°†å‘å‡ºè­¦å‘Š @SuppressWarningsï¼šè¡¨ç¤ºå…³é—­ç¼–è¯‘å™¨è­¦å‘Šä¿¡æ¯ æˆ‘ä»¬å†å…·ä½“çœ‹ä¸‹è¿™å‡ ä¸ªå†…ç½®æ³¨è§£ï¼ŒåŒæ—¶é€šè¿‡è¿™å‡ ä¸ªå†…ç½®æ³¨è§£ä¸­çš„å…ƒæ³¨è§£çš„å®šä¹‰æ¥å¼•å‡ºå…ƒæ³¨è§£ã€‚ å†…ç½®æ³¨è§£ - @Overrideæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ³¨è§£ç±»å‹çš„å®šä¹‰ï¼š 1234@Target(ElementType.METHOD)@Retention(RetentionPolicy.SOURCE)public @interface Override &#123;&#125; ä»å®ƒçš„å®šä¹‰æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ³¨è§£å¯ä»¥è¢«ç”¨æ¥ä¿®é¥°æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒåªåœ¨ç¼–è¯‘æ—¶æœ‰æ•ˆï¼Œåœ¨ç¼–è¯‘åçš„classæ–‡ä»¶ä¸­ä¾¿ä¸å†å­˜åœ¨ã€‚è¿™ä¸ªæ³¨è§£çš„ä½œç”¨æˆ‘ä»¬å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œé‚£å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨è¢«ä¿®é¥°çš„æ–¹æ³•æ˜¯é‡å†™çš„çˆ¶ç±»çš„ä¸­çš„ç›¸åŒç­¾åçš„æ–¹æ³•ï¼Œç¼–è¯‘å™¨ä¼šå¯¹æ­¤åšå‡ºæ£€æŸ¥ï¼Œè‹¥å‘ç°çˆ¶ç±»ä¸­ä¸å­˜åœ¨è¿™ä¸ªæ–¹æ³•æˆ–æ˜¯å­˜åœ¨çš„æ–¹æ³•ç­¾åä¸åŒï¼Œåˆ™ä¼šæŠ¥é”™ã€‚ å†…ç½®æ³¨è§£ - @Deprecatedè¿™ä¸ªæ³¨è§£çš„å®šä¹‰å¦‚ä¸‹ï¼š 12345@Documented@Retention(RetentionPolicy.RUNTIME)@Target(value=&#123;CONSTRUCTOR, FIELD, LOCAL_VARIABLE, METHOD, PACKAGE, PARAMETER, TYPE&#125;)public @interface Deprecated &#123;&#125; ä»å®ƒçš„å®šä¹‰æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå®ƒä¼šè¢«æ–‡æ¡£åŒ–ï¼Œèƒ½å¤Ÿä¿ç•™åˆ°è¿è¡Œæ—¶ï¼Œèƒ½å¤Ÿä¿®é¥°æ„é€ æ–¹æ³•ã€å±æ€§ã€å±€éƒ¨å˜é‡ã€æ–¹æ³•ã€åŒ…ã€å‚æ•°ã€ç±»å‹ã€‚è¿™ä¸ªæ³¨è§£çš„ä½œç”¨æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨è¢«ä¿®é¥°çš„ç¨‹åºå…ƒç´ å·²è¢«â€œåºŸå¼ƒâ€ï¼Œä¸å†å»ºè®®ç”¨æˆ·ä½¿ç”¨ã€‚ å†…ç½®æ³¨è§£ - @SuppressWarningsè¿™ä¸ªæ³¨è§£æˆ‘ä»¬ä¹Ÿæ¯”è¾ƒå¸¸ç”¨åˆ°ï¼Œå…ˆæ¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼š 12345@Target(&#123;TYPE, FIELD, METHOD, PARAMETER, CONSTRUCTOR, LOCAL_VARIABLE&#125;)@Retention(RetentionPolicy.SOURCE)public @interface SuppressWarnings &#123; String[] value();&#125; å®ƒèƒ½å¤Ÿä¿®é¥°çš„ç¨‹åºå…ƒç´ åŒ…æ‹¬ç±»å‹ã€å±æ€§ã€æ–¹æ³•ã€å‚æ•°ã€æ„é€ å™¨ã€å±€éƒ¨å˜é‡ï¼Œåªèƒ½å­˜æ´»åœ¨æºç æ—¶ï¼Œå–å€¼ä¸ºString[]ã€‚å®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨å¿½ç•¥æŒ‡å®šçš„è­¦å‘Šä¿¡æ¯ï¼Œå®ƒå¯ä»¥å–çš„å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š å‚æ•° ä½œç”¨ åŸæè¿° all æŠ‘åˆ¶æ‰€æœ‰è­¦å‘Š to suppress all warnings boxing æŠ‘åˆ¶è£…ç®±ã€æ‹†ç®±æ“ä½œæ—¶å€™çš„è­¦å‘Š to suppress warnings relative to boxing&#x2F;unboxing operations cast æŠ‘åˆ¶æ˜ å°„ç›¸å…³çš„è­¦å‘Š to suppress warnings relative to cast operations dep-ann æŠ‘åˆ¶å¯ç”¨æ³¨é‡Šçš„è­¦å‘Š to suppress warnings relative to deprecated annotation deprecation æŠ‘åˆ¶è¿‡æœŸæ–¹æ³•è­¦å‘Š to suppress warnings relative to deprecation fallthrough æŠ‘åˆ¶ç¡®åœ¨switchä¸­ç¼ºå¤±breaksçš„è­¦å‘Š to suppress warnings relative to missing breaks in switch statements finally æŠ‘åˆ¶finallyæ¨¡å—æ²¡æœ‰è¿”å›çš„è­¦å‘Š to suppress warnings relative to finally block that donâ€™t return hiding æŠ‘åˆ¶ä¸éšè—å˜æ•°çš„åŒºåŸŸå˜æ•°ç›¸å…³çš„è­¦å‘Š to suppress warnings relative to locals that hide variableï¼ˆï¼‰ incomplete-switch å¿½ç•¥æ²¡æœ‰å®Œæ•´çš„switchè¯­å¥ to suppress warnings relative to missing entries in a switch statement (enum case) nls å¿½ç•¥énlsæ ¼å¼çš„å­—ç¬¦ to suppress warnings relative to non-nls string literals null å¿½ç•¥å¯¹nullçš„æ“ä½œ to suppress warnings relative to null analysis rawtype ä½¿ç”¨genericsæ—¶å¿½ç•¥æ²¡æœ‰æŒ‡å®šç›¸åº”çš„ç±»å‹ to suppress warnings relative to un-specific types when using restriction æŠ‘åˆ¶ä¸ä½¿ç”¨ä¸å»ºè®®æˆ–ç¦æ­¢å‚ç…§ç›¸å…³çš„è­¦å‘Š to suppress warnings relative to usage of discouraged or serial å¿½ç•¥åœ¨serializableç±»ä¸­æ²¡æœ‰å£°æ˜serialVersionUIDå˜é‡ to suppress warnings relative to missing serialVersionUID field for a serializable class static-access æŠ‘åˆ¶ä¸æ­£ç¡®çš„é™æ€è®¿é—®æ–¹å¼è­¦å‘Š to suppress warnings relative to incorrect static access synthetic-access æŠ‘åˆ¶å­ç±»æ²¡æœ‰æŒ‰æœ€ä¼˜æ–¹æ³•è®¿é—®å†…éƒ¨ç±»çš„è­¦å‘Š to suppress warnings relative to unoptimized access from inner classes unchecked æŠ‘åˆ¶æ²¡æœ‰è¿›è¡Œç±»å‹æ£€æŸ¥æ“ä½œçš„è­¦å‘Š to suppress warnings relative to unchecked operations unqualified-field-access æŠ‘åˆ¶æ²¡æœ‰æƒé™è®¿é—®çš„åŸŸçš„è­¦å‘Š to suppress warnings relative to field access unqualified unused æŠ‘åˆ¶æ²¡è¢«ä½¿ç”¨è¿‡çš„ä»£ç çš„è­¦å‘Š to suppress warnings relative to unused code å…ƒæ³¨è§£ä¸Šè¿°å†…ç½®æ³¨è§£çš„å®šä¹‰ä¸­ä½¿ç”¨äº†ä¸€äº›å…ƒæ³¨è§£ï¼ˆæ³¨è§£ç±»å‹è¿›è¡Œæ³¨è§£çš„æ³¨è§£ç±»ï¼‰ï¼Œåœ¨JDK 1.5ä¸­æä¾›äº†4ä¸ªæ ‡å‡†çš„å…ƒæ³¨è§£ï¼š@Targetï¼Œ@Retentionï¼Œ@Documentedï¼Œ@Inherited, åœ¨JDK 1.8ä¸­æä¾›äº†ä¸¤ä¸ªå…ƒæ³¨è§£ @Repeatableå’Œ@Nativeã€‚ å…ƒæ³¨è§£ - @Target Targetæ³¨è§£çš„ä½œç”¨æ˜¯ï¼šæè¿°æ³¨è§£çš„ä½¿ç”¨èŒƒå›´ï¼ˆå³ï¼šè¢«ä¿®é¥°çš„æ³¨è§£å¯ä»¥ç”¨åœ¨ä»€ä¹ˆåœ°æ–¹ï¼‰ ã€‚ Targetæ³¨è§£ç”¨æ¥è¯´æ˜é‚£äº›è¢«å®ƒæ‰€æ³¨è§£çš„æ³¨è§£ç±»å¯ä¿®é¥°çš„å¯¹è±¡èŒƒå›´ï¼šæ³¨è§£å¯ä»¥ç”¨äºä¿®é¥° packagesã€typesï¼ˆç±»ã€æ¥å£ã€æšä¸¾ã€æ³¨è§£ç±»ï¼‰ã€ç±»æˆå‘˜ï¼ˆæ–¹æ³•ã€æ„é€ æ–¹æ³•ã€æˆå‘˜å˜é‡ã€æšä¸¾å€¼ï¼‰ã€æ–¹æ³•å‚æ•°å’Œæœ¬åœ°å˜é‡ï¼ˆå¦‚å¾ªç¯å˜é‡ã€catchå‚æ•°ï¼‰ï¼Œåœ¨å®šä¹‰æ³¨è§£ç±»æ—¶ä½¿ç”¨äº†@Target èƒ½å¤Ÿæ›´åŠ æ¸…æ™°çš„çŸ¥é“å®ƒèƒ½å¤Ÿè¢«ç”¨æ¥ä¿®é¥°å“ªäº›å¯¹è±¡ï¼Œå®ƒçš„å–å€¼èŒƒå›´å®šä¹‰åœ¨ElementType æšä¸¾ä¸­ã€‚ 1234567891011121314151617181920212223public enum ElementType &#123; TYPE, // ç±»ã€æ¥å£ã€æšä¸¾ç±» FIELD, // æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬ï¼šæšä¸¾å¸¸é‡ï¼‰ METHOD, // æˆå‘˜æ–¹æ³• PARAMETER, // æ–¹æ³•å‚æ•° CONSTRUCTOR, // æ„é€ æ–¹æ³• LOCAL_VARIABLE, // å±€éƒ¨å˜é‡ ANNOTATION_TYPE, // æ³¨è§£ç±» PACKAGE, // å¯ç”¨äºä¿®é¥°ï¼šåŒ… TYPE_PARAMETER, // ç±»å‹å‚æ•°ï¼ŒJDK 1.8 æ–°å¢ TYPE_USE // ä½¿ç”¨ç±»å‹çš„ä»»ä½•åœ°æ–¹ï¼ŒJDK 1.8 æ–°å¢ &#125; å…ƒæ³¨è§£ - @Retention &amp; @RetentionTarget Retenitonæ³¨è§£çš„ä½œç”¨æ˜¯ï¼šæè¿°æ³¨è§£ä¿ç•™çš„æ—¶é—´èŒƒå›´ï¼ˆå³ï¼šè¢«æè¿°çš„æ³¨è§£åœ¨å®ƒæ‰€ä¿®é¥°çš„ç±»ä¸­å¯ä»¥è¢«ä¿ç•™åˆ°ä½•æ—¶ï¼‰ ã€‚ Retenitonæ³¨è§£ç”¨æ¥é™å®šé‚£äº›è¢«å®ƒæ‰€æ³¨è§£çš„æ³¨è§£ç±»åœ¨æ³¨è§£åˆ°å…¶ä»–ç±»ä¸Šä»¥åï¼Œå¯è¢«ä¿ç•™åˆ°ä½•æ—¶ï¼Œä¸€å…±æœ‰ä¸‰ç§ç­–ç•¥ï¼Œå®šä¹‰åœ¨RetentionPolicyæšä¸¾ä¸­ã€‚ 123456public enum RetentionPolicy &#123; SOURCE, // æºæ–‡ä»¶ä¿ç•™ CLASS, // ç¼–è¯‘æœŸä¿ç•™ï¼Œé»˜è®¤å€¼ RUNTIME // è¿è¡ŒæœŸä¿ç•™ï¼Œå¯é€šè¿‡åå°„å»è·å–æ³¨è§£ä¿¡æ¯&#125; ä¸ºäº†éªŒè¯åº”ç”¨äº†è¿™ä¸‰ç§ç­–ç•¥çš„æ³¨è§£ç±»æœ‰ä½•åŒºåˆ«ï¼Œåˆ†åˆ«ä½¿ç”¨ä¸‰ç§ç­–ç•¥å„å®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»åšæµ‹è¯•ã€‚ 123456789101112@Retention(RetentionPolicy.SOURCE)public @interface SourcePolicy &#123; &#125;@Retention(RetentionPolicy.CLASS)public @interface ClassPolicy &#123; &#125;@Retention(RetentionPolicy.RUNTIME)public @interface RuntimePolicy &#123; &#125; ç”¨å®šä¹‰å¥½çš„ä¸‰ä¸ªæ³¨è§£ç±»åˆ†åˆ«å»æ³¨è§£ä¸€ä¸ªæ–¹æ³•ã€‚ 1234567891011121314public class RetentionTest &#123; @SourcePolicy\tpublic void sourcePolicy() &#123;\t&#125; @ClassPolicy\tpublic void classPolicy() &#123;\t&#125; @RuntimePolicy\tpublic void runtimePolicy() &#123;\t&#125;&#125; é€šè¿‡æ‰§è¡Œ javap -verbose RetentionTestå‘½ä»¤è·å–åˆ°çš„RetentionTest çš„ class å­—èŠ‚ç å†…å®¹å¦‚ä¸‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839&#123; public retention.RetentionTest(); flags: ACC_PUBLIC Code: stack=1, locals=1, args_size=1 0: aload_0 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V 4: return LineNumberTable: line 3: 0 public void sourcePolicy(); flags: ACC_PUBLIC Code: stack=0, locals=1, args_size=1 0: return LineNumberTable: line 7: 0 public void classPolicy(); flags: ACC_PUBLIC Code: stack=0, locals=1, args_size=1 0: return LineNumberTable: line 11: 0 RuntimeInvisibleAnnotations: 0: #11() public void runtimePolicy(); flags: ACC_PUBLIC Code: stack=0, locals=1, args_size=1 0: return LineNumberTable: line 15: 0 RuntimeVisibleAnnotations: 0: #14()&#125; ä» RetentionTest çš„å­—èŠ‚ç å†…å®¹æˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹ä¸¤ç‚¹ç»“è®ºï¼š ç¼–è¯‘å™¨å¹¶æ²¡æœ‰è®°å½•ä¸‹ sourcePolicy() æ–¹æ³•çš„æ³¨è§£ä¿¡æ¯ï¼› ç¼–è¯‘å™¨åˆ†åˆ«ä½¿ç”¨äº† RuntimeInvisibleAnnotations å’Œ RuntimeVisibleAnnotations å±æ€§å»è®°å½•äº†classPolicy()æ–¹æ³• å’Œ runtimePolicy()æ–¹æ³• çš„æ³¨è§£ä¿¡æ¯ï¼› å…ƒæ³¨è§£ - @Documented Documentedæ³¨è§£çš„ä½œç”¨æ˜¯ï¼šæè¿°åœ¨ä½¿ç”¨ javadoc å·¥å…·ä¸ºç±»ç”Ÿæˆå¸®åŠ©æ–‡æ¡£æ—¶æ˜¯å¦è¦ä¿ç•™å…¶æ³¨è§£ä¿¡æ¯ã€‚ ä»¥ä¸‹ä»£ç åœ¨ä½¿ç”¨Javadocå·¥å…·å¯ä»¥ç”Ÿæˆ@TestDocAnnotationæ³¨è§£ä¿¡æ¯ã€‚ 1234567891011121314import java.lang.annotation.Documented;import java.lang.annotation.ElementType;import java.lang.annotation.Target; @Documented@Target(&#123;ElementType.TYPE,ElementType.METHOD&#125;)public @interface TestDocAnnotation &#123; public String value() default &quot;default&quot;;&#125;@TestDocAnnotation(&quot;myMethodDoc&quot;)public void testDoc() &#123;&#125; å…ƒæ³¨è§£ - @Inherited Inheritedæ³¨è§£çš„ä½œç”¨ï¼šè¢«å®ƒä¿®é¥°çš„Annotationå°†å…·æœ‰ç»§æ‰¿æ€§ã€‚å¦‚æœæŸä¸ªç±»ä½¿ç”¨äº†è¢«@Inheritedä¿®é¥°çš„Annotationï¼Œåˆ™å…¶å­ç±»å°†è‡ªåŠ¨å…·æœ‰è¯¥æ³¨è§£ã€‚ æˆ‘ä»¬æ¥æµ‹è¯•ä¸‹è¿™ä¸ªæ³¨è§£ï¼š å®šä¹‰@Inheritedæ³¨è§£ï¼š 1234567@Inherited@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE,ElementType.METHOD&#125;)public @interface TestInheritedAnnotation &#123; String [] values(); int number();&#125; ä½¿ç”¨è¿™ä¸ªæ³¨è§£ 1234567891011121314@TestInheritedAnnotation(values = &#123;&quot;value&quot;&#125;, number = 10)public class Person &#123;&#125;class Student extends Person&#123;\t@Test public void test()&#123; Class clazz = Student.class; Annotation[] annotations = clazz.getAnnotations(); for (Annotation annotation : annotations) &#123; System.out.println(annotation.toString()); &#125; &#125;&#125; è¾“å‡º 1xxxxxxx.TestInheritedAnnotation(values=[value], number=10) å³ä½¿Studentç±»æ²¡æœ‰æ˜¾ç¤ºåœ°è¢«æ³¨è§£@TestInheritedAnnotationï¼Œä½†æ˜¯å®ƒçš„çˆ¶ç±»Personè¢«æ³¨è§£ï¼Œè€Œä¸”@TestInheritedAnnotationè¢«@Inheritedæ³¨è§£ï¼Œå› æ­¤Studentç±»è‡ªåŠ¨æœ‰äº†è¯¥æ³¨è§£ã€‚ å…ƒæ³¨è§£ - @Repeatable (Java8)@Repeatableè¯·å‚è€ƒJava 8 - é‡å¤æ³¨è§£ å…ƒæ³¨è§£ - @Native (Java8)ä½¿ç”¨ @Native æ³¨è§£ä¿®é¥°æˆå‘˜å˜é‡ï¼Œåˆ™è¡¨ç¤ºè¿™ä¸ªå˜é‡å¯ä»¥è¢«æœ¬åœ°ä»£ç å¼•ç”¨ï¼Œå¸¸å¸¸è¢«ä»£ç ç”Ÿæˆå·¥å…·ä½¿ç”¨ã€‚å¯¹äº @Native æ³¨è§£ä¸å¸¸ä½¿ç”¨ï¼Œäº†è§£å³å¯ æ³¨è§£ä¸åå°„æ¥å£ å®šä¹‰æ³¨è§£åï¼Œå¦‚ä½•è·å–æ³¨è§£ä¸­çš„å†…å®¹å‘¢ï¼Ÿåå°„åŒ…java.lang.reflectä¸‹çš„AnnotatedElementæ¥å£æä¾›è¿™äº›æ–¹æ³•ã€‚è¿™é‡Œæ³¨æ„ï¼šåªæœ‰æ³¨è§£è¢«å®šä¹‰ä¸ºRUNTIMEåï¼Œè¯¥æ³¨è§£æ‰èƒ½æ˜¯è¿è¡Œæ—¶å¯è§ï¼Œå½“classæ–‡ä»¶è¢«è£…è½½æ—¶è¢«ä¿å­˜åœ¨classæ–‡ä»¶ä¸­çš„Annotationæ‰ä¼šè¢«è™šæ‹Ÿæœºè¯»å–ã€‚ AnnotatedElement æ¥å£æ˜¯æ‰€æœ‰ç¨‹åºå…ƒç´ ï¼ˆClassã€Methodå’ŒConstructorï¼‰çš„çˆ¶æ¥å£ï¼Œæ‰€ä»¥ç¨‹åºé€šè¿‡åå°„è·å–äº†æŸä¸ªç±»çš„AnnotatedElementå¯¹è±¡ä¹‹åï¼Œç¨‹åºå°±å¯ä»¥è°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•æ¥è®¿é—®Annotationä¿¡æ¯ã€‚æˆ‘ä»¬çœ‹ä¸‹å…·ä½“çš„å…ˆå…³æ¥å£ boolean isAnnotationPresent(Class&lt;?extends Annotation&gt; annotationClass) åˆ¤æ–­è¯¥ç¨‹åºå…ƒç´ ä¸Šæ˜¯å¦åŒ…å«æŒ‡å®šç±»å‹çš„æ³¨è§£ï¼Œå­˜åœ¨åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¼šå¿½ç•¥æ³¨è§£å¯¹åº”çš„æ³¨è§£å®¹å™¨ã€‚ &lt;T extends Annotation&gt; T getAnnotation(Class&lt;T&gt; annotationClass) è¿”å›è¯¥ç¨‹åºå…ƒç´ ä¸Šå­˜åœ¨çš„ã€æŒ‡å®šç±»å‹çš„æ³¨è§£ï¼Œå¦‚æœè¯¥ç±»å‹æ³¨è§£ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›nullã€‚ Annotation[] getAnnotations() è¿”å›è¯¥ç¨‹åºå…ƒç´ ä¸Šå­˜åœ¨çš„æ‰€æœ‰æ³¨è§£ï¼Œè‹¥æ²¡æœ‰æ³¨è§£ï¼Œè¿”å›é•¿åº¦ä¸º0çš„æ•°ç»„ã€‚ &lt;T extends Annotation&gt; T[] getAnnotationsByType(Class&lt;T&gt; annotationClass) è¿”å›è¯¥ç¨‹åºå…ƒç´ ä¸Šå­˜åœ¨çš„ã€æŒ‡å®šç±»å‹çš„æ³¨è§£æ•°ç»„ã€‚æ²¡æœ‰æ³¨è§£å¯¹åº”ç±»å‹çš„æ³¨è§£æ—¶ï¼Œè¿”å›é•¿åº¦ä¸º0çš„æ•°ç»„ã€‚è¯¥æ–¹æ³•çš„è°ƒç”¨è€…å¯ä»¥éšæ„ä¿®æ”¹è¿”å›çš„æ•°ç»„ï¼Œè€Œä¸ä¼šå¯¹å…¶ä»–è°ƒç”¨è€…è¿”å›çš„æ•°ç»„äº§ç”Ÿä»»ä½•å½±å“ã€‚getAnnotationsByTypeæ–¹æ³•ä¸ getAnnotationçš„åŒºåˆ«åœ¨äºï¼ŒgetAnnotationsByTypeä¼šæ£€æµ‹æ³¨è§£å¯¹åº”çš„é‡å¤æ³¨è§£å®¹å™¨ã€‚è‹¥ç¨‹åºå…ƒç´ ä¸ºç±»ï¼Œå½“å‰ç±»ä¸Šæ‰¾ä¸åˆ°æ³¨è§£ï¼Œä¸”è¯¥æ³¨è§£ä¸ºå¯ç»§æ‰¿çš„ï¼Œåˆ™ä¼šå»çˆ¶ç±»ä¸Šæ£€æµ‹å¯¹åº”çš„æ³¨è§£ã€‚ &lt;T extends Annotation&gt; T getDeclaredAnnotation(Class&lt;T&gt; annotationClass) è¿”å›ç›´æ¥å­˜åœ¨äºæ­¤å…ƒç´ ä¸Šçš„æ‰€æœ‰æ³¨è§£ã€‚ä¸æ­¤æ¥å£ä¸­çš„å…¶ä»–æ–¹æ³•ä¸åŒï¼Œè¯¥æ–¹æ³•å°†å¿½ç•¥ç»§æ‰¿çš„æ³¨é‡Šã€‚å¦‚æœæ²¡æœ‰æ³¨é‡Šç›´æ¥å­˜åœ¨äºæ­¤å…ƒç´ ä¸Šï¼Œåˆ™è¿”å›null &lt;T extends Annotation&gt; T[] getDeclaredAnnotationsByType(Class&lt;T&gt; annotationClass) è¿”å›ç›´æ¥å­˜åœ¨äºæ­¤å…ƒç´ ä¸Šçš„æ‰€æœ‰æ³¨è§£ã€‚ä¸æ­¤æ¥å£ä¸­çš„å…¶ä»–æ–¹æ³•ä¸åŒï¼Œè¯¥æ–¹æ³•å°†å¿½ç•¥ç»§æ‰¿çš„æ³¨é‡Š Annotation[] getDeclaredAnnotations() è¿”å›ç›´æ¥å­˜åœ¨äºæ­¤å…ƒç´ ä¸Šçš„æ‰€æœ‰æ³¨è§£åŠæ³¨è§£å¯¹åº”çš„é‡å¤æ³¨è§£å®¹å™¨ã€‚ä¸æ­¤æ¥å£ä¸­çš„å…¶ä»–æ–¹æ³•ä¸åŒï¼Œè¯¥æ–¹æ³•å°†å¿½ç•¥ç»§æ‰¿çš„æ³¨è§£ã€‚å¦‚æœæ²¡æœ‰æ³¨é‡Šç›´æ¥å­˜åœ¨äºæ­¤å…ƒç´ ä¸Šï¼Œåˆ™è¿”å›é•¿åº¦ä¸ºé›¶çš„ä¸€ä¸ªæ•°ç»„ã€‚è¯¥æ–¹æ³•çš„è°ƒç”¨è€…å¯ä»¥éšæ„ä¿®æ”¹è¿”å›çš„æ•°ç»„ï¼Œè€Œä¸ä¼šå¯¹å…¶ä»–è°ƒç”¨è€…è¿”å›çš„æ•°ç»„äº§ç”Ÿä»»ä½•å½±å“ã€‚ è‡ªå®šä¹‰æ³¨è§£ å½“æˆ‘ä»¬ç†è§£äº†å†…ç½®æ³¨è§£, å…ƒæ³¨è§£å’Œè·å–æ³¨è§£çš„åå°„æ¥å£åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¼€å§‹è‡ªå®šä¹‰æ³¨è§£äº†ã€‚è¿™ä¸ªä¾‹å­æˆ‘æŠŠä¸Šè¿°çš„çŸ¥è¯†ç‚¹å…¨éƒ¨èå…¥è¿›æ¥, ä»£ç å¾ˆç®€å•ï¼š å®šä¹‰è‡ªå·±çš„æ³¨è§£ 12345678910111213141516package com.pdai.java.annotation;import java.lang.annotation.ElementType;import java.lang.annotation.Retention;import java.lang.annotation.RetentionPolicy;import java.lang.annotation.Target;@Target(ElementType.METHOD)@Retention(RetentionPolicy.RUNTIME)public @interface MyMethodAnnotation &#123; public String title() default &quot;&quot;; public String description() default &quot;&quot;;&#125; ä½¿ç”¨æ³¨è§£ 123456789101112131415161718192021222324252627282930package com.pdai.java.annotation;import java.io.FileNotFoundException;import java.lang.annotation.Annotation;import java.lang.reflect.Method;import java.util.ArrayList;import java.util.List;public class TestMethodAnnotation &#123; @Override @MyMethodAnnotation(title = &quot;toStringMethod&quot;, description = &quot;override toString method&quot;) public String toString() &#123; return &quot;Override toString method&quot;; &#125; @Deprecated @MyMethodAnnotation(title = &quot;old static method&quot;, description = &quot;deprecated old static method&quot;) public static void oldMethod() &#123; System.out.println(&quot;old method, don&#x27;t use it.&quot;); &#125; @SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;deprecation&quot;&#125;) @MyMethodAnnotation(title = &quot;test method&quot;, description = &quot;suppress warning static method&quot;) public static void genericsTest() throws FileNotFoundException &#123; List l = new ArrayList(); l.add(&quot;abc&quot;); oldMethod(); &#125;&#125; ç”¨åå°„æ¥å£è·å–æ³¨è§£ä¿¡æ¯ åœ¨TestMethodAnnotationä¸­æ·»åŠ Mainæ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼š 123456789101112131415161718192021222324252627282930313233public static void main(String[] args) &#123; try &#123; // è·å–æ‰€æœ‰methods Method[] methods = TestMethodAnnotation.class.getClassLoader() .loadClass((&quot;com.pdai.java.annotation.TestMethodAnnotation&quot;)) .getMethods(); // éå† for (Method method : methods) &#123; // æ–¹æ³•ä¸Šæ˜¯å¦æœ‰MyMethodAnnotationæ³¨è§£ if (method.isAnnotationPresent(MyMethodAnnotation.class)) &#123; try &#123; // è·å–å¹¶éå†æ–¹æ³•ä¸Šçš„æ‰€æœ‰æ³¨è§£ for (Annotation anno : method.getDeclaredAnnotations()) &#123; System.out.println(&quot;Annotation in Method &#x27;&quot; + method + &quot;&#x27; : &quot; + anno); &#125; // è·å–MyMethodAnnotationå¯¹è±¡ä¿¡æ¯ MyMethodAnnotation methodAnno = method .getAnnotation(MyMethodAnnotation.class); System.out.println(methodAnno.title()); &#125; catch (Throwable ex) &#123; ex.printStackTrace(); &#125; &#125; &#125; &#125; catch (SecurityException | ClassNotFoundException e) &#123; e.printStackTrace(); &#125;&#125; æµ‹è¯•çš„è¾“å‡º 1234567Annotation in Method &#x27;public static void com.pdai.java.annotation.TestMethodAnnotation.oldMethod()&#x27; : @java.lang.Deprecated()Annotation in Method &#x27;public static void com.pdai.java.annotation.TestMethodAnnotation.oldMethod()&#x27; : @com.pdai.java.annotation.MyMethodAnnotation(title=old static method, description=deprecated old static method)old static methodAnnotation in Method &#x27;public static void com.pdai.java.annotation.TestMethodAnnotation.genericsTest() throws java.io.FileNotFoundException&#x27; : @com.pdai.java.annotation.MyMethodAnnotation(title=test method, description=suppress warning static method)test methodAnnotation in Method &#x27;public java.lang.String com.pdai.java.annotation.TestMethodAnnotation.toString()&#x27; : @com.pdai.java.annotation.MyMethodAnnotation(title=toStringMethod, description=override toString method)toStringMethod æ·±å…¥ç†è§£æ³¨è§£æç¤º æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»å…¶å®ƒè§’åº¦æ·±å…¥ç†è§£æ³¨è§£ Java8æä¾›äº†å“ªäº›æ–°çš„æ³¨è§£ï¼Ÿ @Repeatable è¯·å‚è€ƒJava 8 - é‡å¤æ³¨è§£ ElementType.TYPE_USE è¯·å‚è€ƒJava 8 - ç±»å‹æ³¨è§£ ElementType.TYPE_PARAMETER ElementType.TYPE_USE(æ­¤ç±»å‹åŒ…æ‹¬ç±»å‹å£°æ˜å’Œç±»å‹å‚æ•°å£°æ˜ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿è®¾è®¡è€…è¿›è¡Œç±»å‹æ£€æŸ¥)åŒ…å«äº†ElementType.TYPE(ç±»ã€æ¥å£ï¼ˆåŒ…æ‹¬æ³¨è§£ç±»å‹ï¼‰å’Œæšä¸¾çš„å£°æ˜)å’ŒElementType.TYPE_PARAMETER(ç±»å‹å‚æ•°å£°æ˜), ä¸å¦¨å†çœ‹ä¸ªä¾‹å­ 123456789101112131415161718192021222324252627// è‡ªå®šä¹‰ElementType.TYPE_PARAMETERæ³¨è§£@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.TYPE_PARAMETER)public @interface MyNotEmpty &#123;&#125;// è‡ªå®šä¹‰ElementType.TYPE_USEæ³¨è§£@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.TYPE_USE)public @interface MyNotNull &#123;&#125;// æµ‹è¯•ç±»public class TypeParameterAndTypeUseAnnotation&lt;@MyNotEmpty T&gt;&#123; //ä½¿ç”¨TYPE_PARAMETERç±»å‹ï¼Œä¼šç¼–è¯‘ä¸é€šè¿‡// public @MyNotEmpty T test(@MyNotEmpty T a)&#123;// new ArrayList&lt;@MyNotEmpty String&gt;();// return a;// &#125; //ä½¿ç”¨TYPE_USEç±»å‹ï¼Œç¼–è¯‘é€šè¿‡ public @MyNotNull T test2(@MyNotNull T a)&#123; new ArrayList&lt;@MyNotNull String&gt;(); return a; &#125;&#125; æ³¨è§£æ”¯æŒç»§æ‰¿å—ï¼Ÿ æ³¨è§£æ˜¯ä¸æ”¯æŒç»§æ‰¿çš„ ä¸èƒ½ä½¿ç”¨å…³é”®å­—extendsæ¥ç»§æ‰¿æŸä¸ª@interfaceï¼Œä½†æ³¨è§£åœ¨ç¼–è¯‘åï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç»§æ‰¿java.lang.annotation.Annotationæ¥å£. è™½ç„¶åç¼–è¯‘åå‘ç°æ³¨è§£ç»§æ‰¿äº†Annotationæ¥å£ï¼Œè¯·è®°ä½ï¼Œå³ä½¿Javaçš„æ¥å£å¯ä»¥å®ç°å¤šç»§æ‰¿ï¼Œä½†å®šä¹‰æ³¨è§£æ—¶ä¾ç„¶æ— æ³•ä½¿ç”¨extendså…³é”®å­—ç»§æ‰¿@interfaceã€‚ åŒºåˆ«äºæ³¨è§£çš„ç»§æ‰¿ï¼Œè¢«æ³¨è§£çš„å­ç±»ç»§æ‰¿çˆ¶ç±»æ³¨è§£å¯ä»¥ç”¨@Inheritedï¼š å¦‚æœæŸä¸ªç±»ä½¿ç”¨äº†è¢«@Inheritedä¿®é¥°çš„Annotationï¼Œåˆ™å…¶å­ç±»å°†è‡ªåŠ¨å…·æœ‰è¯¥æ³¨è§£ã€‚ æ³¨è§£å®ç°çš„åŸç†ï¼Ÿ ç½‘ä¸Šå¾ˆå¤šæ ‡æ³¨è§£çš„åŸç†æ–‡ç« æ ¹æœ¬æ²¡æœ‰è¯´åˆ°ç‚¹å­ä¸Šã€‚ è¿™é‡Œæ¨èä½ ä¸¤ç¯‡æ–‡ç« ï¼š https://blog.csdn.net/qq_20009015/article/details/106038023 https://www.race604.com/annotation-processing/ æ³¨è§£çš„åº”ç”¨åœºæ™¯æç¤º æœ€åæˆ‘ä»¬å†çœ‹çœ‹å®é™…å¼€å‘ä¸­æ³¨è§£çš„ä¸€äº›åº”ç”¨åœºæ™¯ã€‚@pdai é…ç½®åŒ–åˆ°æ³¨è§£åŒ– - æ¡†æ¶çš„æ¼”è¿›Spring æ¡†æ¶ é…ç½®åŒ–åˆ°æ³¨è§£åŒ–çš„è½¬å˜ã€‚ ç»§æ‰¿å®ç°åˆ°æ³¨è§£å®ç° - Junit3åˆ°Junit4 ä¸€ä¸ªæ¨¡å—çš„å°è£…å¤§å¤šæ•°äººéƒ½æ˜¯é€šè¿‡ç»§æ‰¿å’Œç»„åˆç­‰æ¨¡å¼æ¥å®ç°çš„ï¼Œä½†æ˜¯å¦‚æœç»“åˆæ³¨è§£å°†å¯ä»¥æå¤§ç¨‹åº¦æé«˜å®ç°çš„ä¼˜é›…åº¦ï¼ˆé™ä½è€¦åˆåº¦ï¼‰ã€‚è€ŒJunit3 åˆ°Junit4çš„æ¼”åŒ–å°±æ˜¯æœ€å¥½çš„ä¸€ä¸ªä¾‹å­ã€‚ è¢«æµ‹è¯•ç±» 12345678910111213141516public class HelloWorld &#123; public void sayHello()&#123; System.out.println(&quot;hello....&quot;); throw new NumberFormatException(); &#125; public void sayWorld()&#123; System.out.println(&quot;world....&quot;); &#125; public String say()&#123; return &quot;hello world!&quot;; &#125; &#125; Junit3 å®ç°UT é€šè¿‡ç»§æ‰¿ TestCaseæ¥å®ç°ï¼Œåˆå§‹åŒ–æ˜¯é€šè¿‡Overrideçˆ¶ç±»æ–¹æ³•æ¥è¿›è¡Œï¼Œæµ‹è¯•æ–¹å¼é€šè¿‡testçš„å‰ç¼€æ–¹æ³•è·å–ã€‚ 12345678910111213141516171819202122232425262728293031323334353637public class HelloWorldTest extends TestCase&#123; private HelloWorld hw; @Override protected void setUp() throws Exception &#123; super.setUp(); hw=new HelloWorld(); &#125; //1.æµ‹è¯•æ²¡æœ‰è¿”å›å€¼ public void testHello()&#123; try &#123; hw.sayHello(); &#125; catch (Exception e) &#123; System.out.println(&quot;å‘ç”Ÿå¼‚å¸¸.....&quot;); &#125; &#125; public void testWorld()&#123; hw.sayWorld(); &#125; //2.æµ‹è¯•æœ‰è¿”å›å€¼çš„æ–¹æ³• // è¿”å›å­—ç¬¦ä¸² public void testSay()&#123; assertEquals(&quot;æµ‹è¯•å¤±è´¥&quot;, hw.say(), &quot;hello world!&quot;); &#125; //è¿”å›å¯¹è±¡ public void testObj()&#123; assertNull(&quot;æµ‹è¯•å¯¹è±¡ä¸ä¸ºç©º&quot;, null); assertNotNull(&quot;æµ‹è¯•å¯¹è±¡ä¸ºç©º&quot;,new String()); &#125; @Override protected void tearDown() throws Exception &#123; super.tearDown(); hw=null; &#125;\t&#125; Junit4 å®ç°UT é€šè¿‡å®šä¹‰@Beforeï¼Œ@Testï¼Œ@Afterç­‰ç­‰æ³¨è§£æ¥å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738public class HelloWorldTest &#123; private HelloWorld hw; @Before public void setUp() &#123; hw = new HelloWorld(); &#125; @Test(expected=NumberFormatException.class) // 1.æµ‹è¯•æ²¡æœ‰è¿”å›å€¼,æœ‰åˆ«äºjunit3çš„ä½¿ç”¨ï¼Œæ›´åŠ æ–¹ä¾¿ public void testHello() &#123; hw.sayHello(); &#125; @Test public void testWorld() &#123; hw.sayWorld(); &#125; @Test // 2.æµ‹è¯•æœ‰è¿”å›å€¼çš„æ–¹æ³• // è¿”å›å­—ç¬¦ä¸² public void testSay() &#123; assertEquals(&quot;æµ‹è¯•å¤±è´¥&quot;, hw.say(), &quot;hello world!&quot;); &#125; @Test // è¿”å›å¯¹è±¡ public void testObj() &#123; assertNull(&quot;æµ‹è¯•å¯¹è±¡ä¸ä¸ºç©º&quot;, null); assertNotNull(&quot;æµ‹è¯•å¯¹è±¡ä¸ºç©º&quot;, new String()); &#125; @After public void tearDown() throws Exception &#123; hw = null; &#125; &#125; è¿™é‡Œæˆ‘ä»¬å‘ç°é€šè¿‡æ³¨è§£çš„æ–¹å¼ï¼Œæˆ‘ä»¬å®ç°å•å…ƒæµ‹è¯•æ—¶å°†æ›´ä¸ºä¼˜é›…ã€‚å¦‚æœä½ è¿˜æœŸæœ›äº†è§£Junit4æ˜¯å¦‚ä½•å®ç°è¿è¡Œçš„å‘¢ï¼Ÿå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼šJUnit4æºç åˆ†æè¿è¡ŒåŸç†åœ¨æ–°çª—å£æ‰“å¼€ã€‚ è‡ªå®šä¹‰æ³¨è§£å’ŒAOP - é€šè¿‡åˆ‡é¢å®ç°è§£è€¦ æœ€ä¸ºå¸¸è§çš„å°±æ˜¯ä½¿ç”¨Spring AOPåˆ‡é¢å®ç°ç»Ÿä¸€çš„æ“ä½œæ—¥å¿—ç®¡ç†ï¼Œæˆ‘è¿™é‡Œæ‰¾äº†ä¸€ä¸ªå¼€æºé¡¹ç›®ä¸­çš„ä¾‹å­ï¼ˆåªå±•ç¤ºä¸»è¦ä»£ç ï¼‰ï¼Œç»™ä½ å±•ç¤ºä¸‹å¦‚ä½•é€šè¿‡æ³¨è§£å®ç°è§£è€¦çš„ã€‚ è‡ªå®šä¹‰Logæ³¨è§£ 123456789101112131415161718192021222324@Target(&#123; ElementType.PARAMETER, ElementType.METHOD &#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface Log &#123; /** * æ¨¡å— */ public String title() default &quot;&quot;; /** * åŠŸèƒ½ */ public BusinessType businessType() default BusinessType.OTHER; /** * æ“ä½œäººç±»åˆ« */ public OperatorType operatorType() default OperatorType.MANAGE; /** * æ˜¯å¦ä¿å­˜è¯·æ±‚çš„å‚æ•° */ public boolean isSaveRequestData() default true;&#125; å®ç°æ—¥å¿—çš„åˆ‡é¢, å¯¹è‡ªå®šä¹‰æ³¨è§£Logä½œåˆ‡ç‚¹è¿›è¡Œæ‹¦æˆª å³å¯¹æ³¨è§£äº†@Logçš„æ–¹æ³•è¿›è¡Œåˆ‡ç‚¹æ‹¦æˆªï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133@Aspect@Componentpublic class LogAspect &#123; private static final Logger log = LoggerFactory.getLogger(LogAspect.class); /** * é…ç½®ç»‡å…¥ç‚¹ - è‡ªå®šä¹‰æ³¨è§£çš„åŒ…è·¯å¾„ * */ @Pointcut(&quot;@annotation(com.xxx.aspectj.lang.annotation.Log)&quot;) public void logPointCut() &#123; &#125; /** * å¤„ç†å®Œè¯·æ±‚åæ‰§è¡Œ * * @param joinPoint åˆ‡ç‚¹ */ @AfterReturning(pointcut = &quot;logPointCut()&quot;, returning = &quot;jsonResult&quot;) public void doAfterReturning(JoinPoint joinPoint, Object jsonResult) &#123; handleLog(joinPoint, null, jsonResult); &#125; /** * æ‹¦æˆªå¼‚å¸¸æ“ä½œ * * @param joinPoint åˆ‡ç‚¹ * @param e å¼‚å¸¸ */ @AfterThrowing(value = &quot;logPointCut()&quot;, throwing = &quot;e&quot;) public void doAfterThrowing(JoinPoint joinPoint, Exception e) &#123; handleLog(joinPoint, e, null); &#125; protected void handleLog(final JoinPoint joinPoint, final Exception e, Object jsonResult) &#123; try &#123; // è·å¾—æ³¨è§£ Log controllerLog = getAnnotationLog(joinPoint); if (controllerLog == null) &#123; return; &#125; // è·å–å½“å‰çš„ç”¨æˆ· User currentUser = ShiroUtils.getSysUser(); // *========æ•°æ®åº“æ—¥å¿—=========*// OperLog operLog = new OperLog(); operLog.setStatus(BusinessStatus.SUCCESS.ordinal()); // è¯·æ±‚çš„åœ°å€ String ip = ShiroUtils.getIp(); operLog.setOperIp(ip); // è¿”å›å‚æ•° operLog.setJsonResult(JSONObject.toJSONString(jsonResult)); operLog.setOperUrl(ServletUtils.getRequest().getRequestURI()); if (currentUser != null) &#123; operLog.setOperName(currentUser.getLoginName()); if (StringUtils.isNotNull(currentUser.getDept()) &amp;&amp; StringUtils.isNotEmpty(currentUser.getDept().getDeptName())) &#123; operLog.setDeptName(currentUser.getDept().getDeptName()); &#125; &#125; if (e != null) &#123; operLog.setStatus(BusinessStatus.FAIL.ordinal()); operLog.setErrorMsg(StringUtils.substring(e.getMessage(), 0, 2000)); &#125; // è®¾ç½®æ–¹æ³•åç§° String className = joinPoint.getTarget().getClass().getName(); String methodName = joinPoint.getSignature().getName(); operLog.setMethod(className + &quot;.&quot; + methodName + &quot;()&quot;); // è®¾ç½®è¯·æ±‚æ–¹å¼ operLog.setRequestMethod(ServletUtils.getRequest().getMethod()); // å¤„ç†è®¾ç½®æ³¨è§£ä¸Šçš„å‚æ•° getControllerMethodDescription(controllerLog, operLog); // ä¿å­˜æ•°æ®åº“ AsyncManager.me().execute(AsyncFactory.recordOper(operLog)); &#125; catch (Exception exp) &#123; // è®°å½•æœ¬åœ°å¼‚å¸¸æ—¥å¿— log.error(&quot;==å‰ç½®é€šçŸ¥å¼‚å¸¸==&quot;); log.error(&quot;å¼‚å¸¸ä¿¡æ¯:&#123;&#125;&quot;, exp.getMessage()); exp.printStackTrace(); &#125; &#125; /** * è·å–æ³¨è§£ä¸­å¯¹æ–¹æ³•çš„æè¿°ä¿¡æ¯ ç”¨äºControllerå±‚æ³¨è§£ * * @param log æ—¥å¿— * @param operLog æ“ä½œæ—¥å¿— * @throws Exception */ public void getControllerMethodDescription(Log log, OperLog operLog) throws Exception &#123; // è®¾ç½®actionåŠ¨ä½œ operLog.setBusinessType(log.businessType().ordinal()); // è®¾ç½®æ ‡é¢˜ operLog.setTitle(log.title()); // è®¾ç½®æ“ä½œäººç±»åˆ« operLog.setOperatorType(log.operatorType().ordinal()); // æ˜¯å¦éœ€è¦ä¿å­˜requestï¼Œå‚æ•°å’Œå€¼ if (log.isSaveRequestData()) &#123; // è·å–å‚æ•°çš„ä¿¡æ¯ï¼Œä¼ å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ setRequestValue(operLog); &#125; &#125; /** * è·å–è¯·æ±‚çš„å‚æ•°ï¼Œæ”¾åˆ°logä¸­ * * @param operLog * @param request */ private void setRequestValue(OperLog operLog) &#123; Map&lt;String, String[]&gt; map = ServletUtils.getRequest().getParameterMap(); String params = JSONObject.toJSONString(map); operLog.setOperParam(StringUtils.substring(params, 0, 2000)); &#125; /** * æ˜¯å¦å­˜åœ¨æ³¨è§£ï¼Œå¦‚æœå­˜åœ¨å°±è·å– */ private Log getAnnotationLog(JoinPoint joinPoint) throws Exception &#123; Signature signature = joinPoint.getSignature(); MethodSignature methodSignature = (MethodSignature) signature; Method method = methodSignature.getMethod(); if (method != null) &#123; return method.getAnnotation(Log.class); &#125; return null; &#125;&#125; ä½¿ç”¨@Logæ³¨è§£ ä»¥ä¸€ä¸ªç®€å•çš„CRUDæ“ä½œä¸ºä¾‹, è¿™é‡Œå±•ç¤ºéƒ¨åˆ†ä»£ç ï¼šæ¯å¯¹â€œéƒ¨é—¨â€è¿›è¡Œæ“ä½œå°±ä¼šäº§ç”Ÿä¸€æ¡æ“ä½œæ—¥å¿—å­˜å…¥æ•°æ®åº“ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657@Controller@RequestMapping(&quot;/system/dept&quot;)public class DeptController extends BaseController &#123; private String prefix = &quot;system/dept&quot;; @Autowired private IDeptService deptService; /** * æ–°å¢ä¿å­˜éƒ¨é—¨ */ @Log(title = &quot;éƒ¨é—¨ç®¡ç†&quot;, businessType = BusinessType.INSERT) @RequiresPermissions(&quot;system:dept:add&quot;) @PostMapping(&quot;/add&quot;) @ResponseBody public AjaxResult addSave(@Validated Dept dept) &#123; if (UserConstants.DEPT_NAME_NOT_UNIQUE.equals(deptService.checkDeptNameUnique(dept))) &#123; return error(&quot;æ–°å¢éƒ¨é—¨&#x27;&quot; + dept.getDeptName() + &quot;&#x27;å¤±è´¥ï¼Œéƒ¨é—¨åç§°å·²å­˜åœ¨&quot;); &#125; return toAjax(deptService.insertDept(dept)); &#125; /** * ä¿å­˜ */ @Log(title = &quot;éƒ¨é—¨ç®¡ç†&quot;, businessType = BusinessType.UPDATE) @RequiresPermissions(&quot;system:dept:edit&quot;) @PostMapping(&quot;/edit&quot;) @ResponseBody public AjaxResult editSave(@Validated Dept dept) &#123; if (UserConstants.DEPT_NAME_NOT_UNIQUE.equals(deptService.checkDeptNameUnique(dept))) &#123; return error(&quot;ä¿®æ”¹éƒ¨é—¨&#x27;&quot; + dept.getDeptName() + &quot;&#x27;å¤±è´¥ï¼Œéƒ¨é—¨åç§°å·²å­˜åœ¨&quot;); &#125; else if(dept.getParentId().equals(dept.getDeptId())) &#123; return error(&quot;ä¿®æ”¹éƒ¨é—¨&#x27;&quot; + dept.getDeptName() + &quot;&#x27;å¤±è´¥ï¼Œä¸Šçº§éƒ¨é—¨ä¸èƒ½æ˜¯è‡ªå·±&quot;); &#125; return toAjax(deptService.updateDept(dept)); &#125; /** * åˆ é™¤ */ @Log(title = &quot;éƒ¨é—¨ç®¡ç†&quot;, businessType = BusinessType.DELETE) @RequiresPermissions(&quot;system:dept:remove&quot;) @GetMapping(&quot;/remove/&#123;deptId&#125;&quot;) @ResponseBody public AjaxResult remove(@PathVariable(&quot;deptId&quot;) Long deptId) &#123; if (deptService.selectDeptCount(deptId) &gt; 0) &#123; return AjaxResult.warn(&quot;å­˜åœ¨ä¸‹çº§éƒ¨é—¨,ä¸å…è®¸åˆ é™¤&quot;); &#125; if (deptService.checkDeptExistUser(deptId)) &#123; return AjaxResult.warn(&quot;éƒ¨é—¨å­˜åœ¨ç”¨æˆ·,ä¸å…è®¸åˆ é™¤&quot;); &#125; return toAjax(deptService.deleteDeptById(deptId)); &#125; // ...&#125; åŒæ ·çš„ï¼Œä½ ä¹Ÿå¯ä»¥çœ‹åˆ°æƒé™ç®¡ç†ä¹Ÿæ˜¯é€šè¿‡ç±»ä¼¼çš„æ³¨è§£ï¼ˆ@RequiresPermissionsï¼‰æœºåˆ¶æ¥å®ç°çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æ³¨è§£+AOPæœ€ç»ˆçš„ç›®æ ‡æ˜¯ä¸ºäº†å®ç°æ¨¡å—çš„è§£è€¦ã€‚ å‚è€ƒæ–‡ç«  https://blog.csdn.net/javazejian/article/details/71860633 https://blog.csdn.net/qq_20009015/article/details/106038023 https://www.zhihu.com/question/47449512 https://www.race604.com/annotation-processing/ https://www.runoob.com/w3cnote/java-annotation.html","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"4.Java åŸºç¡€ - æ³›å‹æœºåˆ¶è¯¦è§£","path":"/2023/12/25/4.Java-åŸºç¡€-æ³›å‹æœºåˆ¶è¯¦è§£/","content":"Javaæ³›å‹è¿™ä¸ªç‰¹æ€§æ˜¯ä»JDK 1.5æ‰å¼€å§‹åŠ å…¥çš„ï¼Œå› æ­¤ä¸ºäº†å…¼å®¹ä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒJavaæ³›å‹çš„å®ç°é‡‡å–äº†â€œä¼ªæ³›å‹â€çš„ç­–ç•¥ï¼Œå³Javaåœ¨è¯­æ³•ä¸Šæ”¯æŒæ³›å‹ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µä¼šè¿›è¡Œæ‰€è°“çš„â€œç±»å‹æ“¦é™¤â€ï¼ˆType Erasureï¼‰ï¼Œå°†æ‰€æœ‰çš„æ³›å‹è¡¨ç¤ºï¼ˆå°–æ‹¬å·ä¸­çš„å†…å®¹ï¼‰éƒ½æ›¿æ¢ä¸ºå…·ä½“çš„ç±»å‹ï¼ˆå…¶å¯¹åº”çš„åŸç”Ÿæ€ç±»å‹ï¼‰ï¼Œå°±åƒå®Œå…¨æ²¡æœ‰æ³›å‹ä¸€æ ·ã€‚æœ¬æ–‡ç»¼åˆå¤šç¯‡æ–‡ç« åï¼Œæ€»ç»“äº†Java æ³›å‹çš„ç›¸å…³çŸ¥è¯†ï¼Œå¸Œæœ›å¯ä»¥æå‡ä½ å¯¹Javaä¸­æ³›å‹çš„è®¤çŸ¥æ•ˆç‡ã€‚ ä¸ºä»€ä¹ˆä¼šå¼•å…¥æ³›å‹ æ³›å‹çš„æœ¬è´¨æ˜¯ä¸ºäº†å‚æ•°åŒ–ç±»å‹ï¼ˆåœ¨ä¸åˆ›å»ºæ–°çš„ç±»å‹çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ³›å‹æŒ‡å®šçš„ä¸åŒç±»å‹æ¥æ§åˆ¶å½¢å‚å…·ä½“é™åˆ¶çš„ç±»å‹ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨æ³›å‹ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæ“ä½œçš„æ•°æ®ç±»å‹è¢«æŒ‡å®šä¸ºä¸€ä¸ªå‚æ•°ï¼Œè¿™ç§å‚æ•°ç±»å‹å¯ä»¥ç”¨åœ¨ç±»ã€æ¥å£å’Œæ–¹æ³•ä¸­ï¼Œåˆ†åˆ«è¢«ç§°ä¸ºæ³›å‹ç±»ã€æ³›å‹æ¥å£ã€æ³›å‹æ–¹æ³•ã€‚ å¼•å…¥æ³›å‹çš„æ„ä¹‰åœ¨äºï¼š é€‚ç”¨äºå¤šç§æ•°æ®ç±»å‹æ‰§è¡Œç›¸åŒçš„ä»£ç ï¼ˆä»£ç å¤ç”¨ï¼‰ æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥é˜è¿°ï¼Œå…ˆçœ‹ä¸‹ä¸‹é¢çš„ä»£ç ï¼š 1234567891011121314private static int add(int a, int b) &#123; System.out.println(a + &quot;+&quot; + b + &quot;=&quot; + (a + b)); return a + b;&#125;private static float add(float a, float b) &#123; System.out.println(a + &quot;+&quot; + b + &quot;=&quot; + (a + b)); return a + b;&#125;private static double add(double a, double b) &#123; System.out.println(a + &quot;+&quot; + b + &quot;=&quot; + (a + b)); return a + b;&#125; å¦‚æœæ²¡æœ‰æ³›å‹ï¼Œè¦å®ç°ä¸åŒç±»å‹çš„åŠ æ³•ï¼Œæ¯ç§ç±»å‹éƒ½éœ€è¦é‡è½½ä¸€ä¸ªaddæ–¹æ³•ï¼›é€šè¿‡æ³›å‹ï¼Œæˆ‘ä»¬å¯ä»¥å¤ç”¨ä¸ºä¸€ä¸ªæ–¹æ³•ï¼š 1234private static &lt;T extends Number&gt; double add(T a, T b) &#123; System.out.println(a + &quot;+&quot; + b + &quot;=&quot; + (a.doubleValue() + b.doubleValue())); return a.doubleValue() + b.doubleValue();&#125; æ³›å‹ä¸­çš„ç±»å‹åœ¨ä½¿ç”¨æ—¶æŒ‡å®šï¼Œä¸éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ˆç±»å‹å®‰å…¨ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥ç±»å‹ï¼‰ çœ‹ä¸‹è¿™ä¸ªä¾‹å­ï¼š 1234List list = new ArrayList();list.add(&quot;xxString&quot;);list.add(100d);list.add(new Person()); æˆ‘ä»¬åœ¨ä½¿ç”¨ä¸Šè¿°listä¸­ï¼Œlistä¸­çš„å…ƒç´ éƒ½æ˜¯Objectç±»å‹ï¼ˆæ— æ³•çº¦æŸå…¶ä¸­çš„ç±»å‹ï¼‰ï¼Œæ‰€ä»¥åœ¨å–å‡ºé›†åˆå…ƒç´ æ—¶éœ€è¦äººä¸ºçš„å¼ºåˆ¶ç±»å‹è½¬åŒ–åˆ°å…·ä½“çš„ç›®æ ‡ç±»å‹ï¼Œä¸”å¾ˆå®¹æ˜“å‡ºç°java.lang.ClassCastExceptionå¼‚å¸¸ã€‚ å¼•å…¥æ³›å‹ï¼Œå®ƒå°†æä¾›ç±»å‹çš„çº¦æŸï¼Œæä¾›ç¼–è¯‘å‰çš„æ£€æŸ¥ï¼š 123List&lt;String&gt; list = new ArrayList&lt;String&gt;();// listä¸­åªèƒ½æ”¾String, ä¸èƒ½æ”¾å…¶å®ƒç±»å‹çš„å…ƒç´  æ³›å‹çš„åŸºæœ¬ä½¿ç”¨ æç¤º æˆ‘ä»¬é€šè¿‡ä¸€äº›ä¾‹å­æ¥å­¦ä¹ æ³›å‹çš„ä½¿ç”¨ï¼›æ³›å‹æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºï¼šæ³›å‹ç±»ã€æ³›å‹æ¥å£ã€æ³›å‹æ–¹æ³•ã€‚ä¸€äº›ä¾‹å­å¯ä»¥å‚è€ƒã€Šæå…´å - Javaå®æˆ˜ç»å…¸ã€‹ã€‚ æ³›å‹ç±» ä»ä¸€ä¸ªç®€å•çš„æ³›å‹ç±»çœ‹èµ·ï¼š 12345678910111213141516class Point&lt;T&gt;&#123; // æ­¤å¤„å¯ä»¥éšä¾¿å†™æ ‡è¯†ç¬¦å·ï¼ŒTæ˜¯typeçš„ç®€ç§° private T var ; // varçš„ç±»å‹ç”±TæŒ‡å®šï¼Œå³ï¼šç”±å¤–éƒ¨æŒ‡å®š public T getVar()&#123; // è¿”å›å€¼çš„ç±»å‹ç”±å¤–éƒ¨å†³å®š return var ; &#125; public void setVar(T var)&#123; // è®¾ç½®çš„ç±»å‹ä¹Ÿç”±å¤–éƒ¨å†³å®š this.var = var ; &#125; &#125; public class GenericsDemo06&#123; public static void main(String args[])&#123; Point&lt;String&gt; p = new Point&lt;String&gt;() ; // é‡Œé¢çš„varç±»å‹ä¸ºStringç±»å‹ p.setVar(&quot;it&quot;) ; // è®¾ç½®å­—ç¬¦ä¸² System.out.println(p.getVar().length()) ; // å–å¾—å­—ç¬¦ä¸²çš„é•¿åº¦ &#125; &#125; å¤šå…ƒæ³›å‹ 123456789101112131415161718192021222324252627class Notepad&lt;K,V&gt;&#123; // æ­¤å¤„æŒ‡å®šäº†ä¸¤ä¸ªæ³›å‹ç±»å‹ private K key ; // æ­¤å˜é‡çš„ç±»å‹ç”±å¤–éƒ¨å†³å®š private V value ; // æ­¤å˜é‡çš„ç±»å‹ç”±å¤–éƒ¨å†³å®š public K getKey()&#123; return this.key ; &#125; public V getValue()&#123; return this.value ; &#125; public void setKey(K key)&#123; this.key = key ; &#125; public void setValue(V value)&#123; this.value = value ; &#125; &#125; public class GenericsDemo09&#123; public static void main(String args[])&#123; Notepad&lt;String,Integer&gt; t = null ; // å®šä¹‰ä¸¤ä¸ªæ³›å‹ç±»å‹çš„å¯¹è±¡ t = new Notepad&lt;String,Integer&gt;() ; // é‡Œé¢çš„keyä¸ºStringï¼Œvalueä¸ºInteger t.setKey(&quot;æ±¤å§†&quot;) ; // è®¾ç½®ç¬¬ä¸€ä¸ªå†…å®¹ t.setValue(20) ; // è®¾ç½®ç¬¬äºŒä¸ªå†…å®¹ System.out.print(&quot;å§“åï¼›&quot; + t.getKey()) ; // å–å¾—ä¿¡æ¯ System.out.print(&quot;ï¼Œå¹´é¾„ï¼›&quot; + t.getValue()) ; // å–å¾—ä¿¡æ¯ &#125; &#125; æ³›å‹æ¥å£ ç®€å•çš„æ³›å‹æ¥å£ 12345678910111213141516171819202122interface Info&lt;T&gt;&#123; // åœ¨æ¥å£ä¸Šå®šä¹‰æ³›å‹ public T getVar() ; // å®šä¹‰æŠ½è±¡æ–¹æ³•ï¼ŒæŠ½è±¡æ–¹æ³•çš„è¿”å›å€¼å°±æ˜¯æ³›å‹ç±»å‹ &#125; class InfoImpl&lt;T&gt; implements Info&lt;T&gt;&#123; // å®šä¹‰æ³›å‹æ¥å£çš„å­ç±» private T var ; // å®šä¹‰å±æ€§ public InfoImpl(T var)&#123; // é€šè¿‡æ„é€ æ–¹æ³•è®¾ç½®å±æ€§å†…å®¹ this.setVar(var) ; &#125; public void setVar(T var)&#123; this.var = var ; &#125; public T getVar()&#123; return this.var ; &#125; &#125; public class GenericsDemo24&#123; public static void main(String arsg[])&#123; Info&lt;String&gt; i = null; // å£°æ˜æ¥å£å¯¹è±¡ i = new InfoImpl&lt;String&gt;(&quot;æ±¤å§†&quot;) ; // é€šè¿‡å­ç±»å®ä¾‹åŒ–å¯¹è±¡ System.out.println(&quot;å†…å®¹ï¼š&quot; + i.getVar()) ; &#125; &#125; æ³›å‹æ–¹æ³•æ³›å‹æ–¹æ³•ï¼Œæ˜¯åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™æŒ‡æ˜æ³›å‹çš„å…·ä½“ç±»å‹ã€‚é‡ç‚¹çœ‹ä¸‹æ³›å‹çš„æ–¹æ³•ï¼ˆå›¾å‚è€ƒè‡ªï¼šhttps://www.cnblogs.com/iyangyuan/archive/2013/04/09/3011274.htmlï¼‰ å®šä¹‰æ³›å‹æ–¹æ³•è¯­æ³•æ ¼å¼ è°ƒç”¨æ³›å‹æ–¹æ³•è¯­æ³•æ ¼å¼ è¯´æ˜ä¸€ä¸‹ï¼Œå®šä¹‰æ³›å‹æ–¹æ³•æ—¶ï¼Œå¿…é¡»åœ¨è¿”å›å€¼å‰è¾¹åŠ ä¸€ä¸ª&lt;T&gt;ï¼Œæ¥å£°æ˜è¿™æ˜¯ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼ŒæŒæœ‰ä¸€ä¸ªæ³›å‹Tï¼Œç„¶åæ‰å¯ä»¥ç”¨æ³›å‹Tä½œä¸ºæ–¹æ³•çš„è¿”å›å€¼ã€‚ Class&lt;T&gt;çš„ä½œç”¨å°±æ˜¯æŒ‡æ˜æ³›å‹çš„å…·ä½“ç±»å‹ï¼Œè€ŒClass&lt;T&gt;ç±»å‹çš„å˜é‡cï¼Œå¯ä»¥ç”¨æ¥åˆ›å»ºæ³›å‹ç±»çš„å¯¹è±¡ã€‚ ä¸ºä»€ä¹ˆè¦ç”¨å˜é‡cæ¥åˆ›å»ºå¯¹è±¡å‘¢ï¼Ÿæ—¢ç„¶æ˜¯æ³›å‹æ–¹æ³•ï¼Œå°±ä»£è¡¨ç€æˆ‘ä»¬ä¸çŸ¥é“å…·ä½“çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œä¹Ÿä¸çŸ¥é“æ„é€ æ–¹æ³•å¦‚ä½•ï¼Œå› æ­¤æ²¡æœ‰åŠæ³•å»newä¸€ä¸ªå¯¹è±¡ï¼Œä½†å¯ä»¥åˆ©ç”¨å˜é‡cçš„newInstanceæ–¹æ³•å»åˆ›å»ºå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨åå°„åˆ›å»ºå¯¹è±¡ã€‚ æ³›å‹æ–¹æ³•è¦æ±‚çš„å‚æ•°æ˜¯Class&lt;T&gt;ç±»å‹ï¼Œè€ŒClass.forName()æ–¹æ³•çš„è¿”å›å€¼ä¹Ÿæ˜¯Class&lt;T&gt;ï¼Œå› æ­¤å¯ä»¥ç”¨Class.forName()ä½œä¸ºå‚æ•°ã€‚å…¶ä¸­ï¼ŒforName()æ–¹æ³•ä¸­çš„å‚æ•°æ˜¯ä½•ç§ç±»å‹ï¼Œè¿”å›çš„Class&lt;T&gt;å°±æ˜¯ä½•ç§ç±»å‹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼ŒforName()æ–¹æ³•ä¸­ä¼ å…¥çš„æ˜¯Userç±»çš„å®Œæ•´è·¯å¾„ï¼Œå› æ­¤è¿”å›çš„æ˜¯Class&lt;User&gt;ç±»å‹çš„å¯¹è±¡ï¼Œå› æ­¤è°ƒç”¨æ³›å‹æ–¹æ³•æ—¶ï¼Œå˜é‡cçš„ç±»å‹å°±æ˜¯Class&lt;User&gt;ï¼Œå› æ­¤æ³›å‹æ–¹æ³•ä¸­çš„æ³›å‹Tå°±è¢«æŒ‡æ˜ä¸ºUserï¼Œå› æ­¤å˜é‡objçš„ç±»å‹ä¸ºUserã€‚ å½“ç„¶ï¼Œæ³›å‹æ–¹æ³•ä¸æ˜¯ä»…ä»…å¯ä»¥æœ‰ä¸€ä¸ªå‚æ•°Class&lt;T&gt;ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–å‚æ•°ã€‚ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ³›å‹æ–¹æ³•å‘¢ï¼Ÿå› ä¸ºæ³›å‹ç±»è¦åœ¨å®ä¾‹åŒ–çš„æ—¶å€™å°±æŒ‡æ˜ç±»å‹ï¼Œå¦‚æœæƒ³æ¢ä¸€ç§ç±»å‹ï¼Œä¸å¾—ä¸é‡æ–°newä¸€æ¬¡ï¼Œå¯èƒ½ä¸å¤Ÿçµæ´»ï¼›è€Œæ³›å‹æ–¹æ³•å¯ä»¥åœ¨è°ƒç”¨çš„æ—¶å€™æŒ‡æ˜ç±»å‹ï¼Œæ›´åŠ çµæ´»ã€‚ æ³›å‹çš„ä¸Šä¸‹é™ å…ˆçœ‹ä¸‹å¦‚ä¸‹çš„ä»£ç ï¼Œå¾ˆæ˜æ˜¾æ˜¯ä¼šæŠ¥é”™çš„ ï¼ˆå…·ä½“é”™è¯¯åŸå› è¯·å‚è€ƒåæ–‡ï¼‰ã€‚ 1234567891011121314151617181920class A&#123;&#125;class B extends A &#123;&#125;// å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ä¸ä¼šæŠ¥é”™public static void funA(A a) &#123; // ... &#125;public static void funB(B b) &#123; funA(b); // ... &#125;// å¦‚ä¸‹funDæ–¹æ³•ä¼šæŠ¥é”™public static void funC(List&lt;A&gt; listA) &#123; // ... &#125;public static void funD(List&lt;B&gt; listB) &#123; funC(listB); // Unresolved compilation problem: The method doPrint(List&lt;A&gt;) in the type test is not applicable for the arguments (List&lt;B&gt;) // ... &#125; é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿ ä¸ºäº†è§£å†³æ³›å‹ä¸­éšå«çš„è½¬æ¢é—®é¢˜ï¼ŒJavaæ³›å‹åŠ å…¥äº†ç±»å‹å‚æ•°çš„ä¸Šä¸‹è¾¹ç•Œæœºåˆ¶ã€‚&lt;? extends A&gt;è¡¨ç¤ºè¯¥ç±»å‹å‚æ•°å¯ä»¥æ˜¯A(ä¸Šè¾¹ç•Œ)æˆ–è€…Açš„å­ç±»ç±»å‹ã€‚ç¼–è¯‘æ—¶æ“¦é™¤åˆ°ç±»å‹Aï¼Œå³ç”¨Aç±»å‹ä»£æ›¿ç±»å‹å‚æ•°ã€‚è¿™ç§æ–¹æ³•å¯ä»¥è§£å†³å¼€å§‹é‡åˆ°çš„é—®é¢˜ï¼Œç¼–è¯‘å™¨çŸ¥é“ç±»å‹å‚æ•°çš„èŒƒå›´ï¼Œå¦‚æœä¼ å…¥çš„å®ä¾‹ç±»å‹Bæ˜¯åœ¨è¿™ä¸ªèŒƒå›´å†…çš„è¯å…è®¸è½¬æ¢ï¼Œè¿™æ—¶åªè¦ä¸€æ¬¡ç±»å‹è½¬æ¢å°±å¯ä»¥äº†ï¼Œè¿è¡Œæ—¶ä¼šæŠŠå¯¹è±¡å½“åšAçš„å®ä¾‹çœ‹å¾…ã€‚ 1234567public static void funC(List&lt;? extends A&gt; listA) &#123; // ... &#125;public static void funD(List&lt;B&gt; listB) &#123; funC(listB); // OK // ... &#125; æ³›å‹ä¸Šä¸‹é™çš„å¼•å…¥ åœ¨ä½¿ç”¨æ³›å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¼ å…¥çš„æ³›å‹ç±»å‹å®å‚è¿›è¡Œä¸Šä¸‹è¾¹ç•Œçš„é™åˆ¶ï¼Œå¦‚ï¼šç±»å‹å®å‚åªå‡†ä¼ å…¥æŸç§ç±»å‹çš„çˆ¶ç±»æˆ–æŸç§ç±»å‹çš„å­ç±»ã€‚ ä¸Šé™ 1234567891011121314151617class Info&lt;T extends Number&gt;&#123; // æ­¤å¤„æ³›å‹åªèƒ½æ˜¯æ•°å­—ç±»å‹ private T var ; // å®šä¹‰æ³›å‹å˜é‡ public void setVar(T var)&#123; this.var = var ; &#125; public T getVar()&#123; return this.var ; &#125; public String toString()&#123; // ç›´æ¥æ‰“å° return this.var.toString() ; &#125;&#125;public class demo1&#123; public static void main(String args[])&#123; Info&lt;Integer&gt; i1 = new Info&lt;Integer&gt;() ; // å£°æ˜Integerçš„æ³›å‹å¯¹è±¡ &#125;&#125; ä¸‹é™ 12345678910111213141516171819202122232425class Info&lt;T&gt;&#123; private T var ; // å®šä¹‰æ³›å‹å˜é‡ public void setVar(T var)&#123; this.var = var ; &#125; public T getVar()&#123; return this.var ; &#125; public String toString()&#123; // ç›´æ¥æ‰“å° return this.var.toString() ; &#125;&#125;public class GenericsDemo21&#123; public static void main(String args[])&#123; Info&lt;String&gt; i1 = new Info&lt;String&gt;() ; // å£°æ˜Stringçš„æ³›å‹å¯¹è±¡ Info&lt;Object&gt; i2 = new Info&lt;Object&gt;() ; // å£°æ˜Objectçš„æ³›å‹å¯¹è±¡ i1.setVar(&quot;hello&quot;) ; i2.setVar(new Object()) ; fun(i1) ; fun(i2) ; &#125; public static void fun(Info&lt;? super String&gt; temp)&#123; // åªèƒ½æ¥æ”¶Stringæˆ–Objectç±»å‹çš„æ³›å‹ï¼ŒStringç±»çš„çˆ¶ç±»åªæœ‰Objectç±» System.out.print(temp + &quot;, &quot;) ; &#125;&#125; å°ç»“ 123456789&lt;?&gt; æ— é™åˆ¶é€šé…ç¬¦&lt;? extends E&gt; extends å…³é”®å­—å£°æ˜äº†ç±»å‹çš„ä¸Šç•Œï¼Œè¡¨ç¤ºå‚æ•°åŒ–çš„ç±»å‹å¯èƒ½æ˜¯æ‰€æŒ‡å®šçš„ç±»å‹ï¼Œæˆ–è€…æ˜¯æ­¤ç±»å‹çš„å­ç±»&lt;? super E&gt; super å…³é”®å­—å£°æ˜äº†ç±»å‹çš„ä¸‹ç•Œï¼Œè¡¨ç¤ºå‚æ•°åŒ–çš„ç±»å‹å¯èƒ½æ˜¯æŒ‡å®šçš„ç±»å‹ï¼Œæˆ–è€…æ˜¯æ­¤ç±»å‹çš„çˆ¶ç±»// ä½¿ç”¨åŸåˆ™ã€ŠEffictive Javaã€‹// ä¸ºäº†è·å¾—æœ€å¤§é™åº¦çš„çµæ´»æ€§ï¼Œè¦åœ¨è¡¨ç¤º ç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€… çš„è¾“å…¥å‚æ•°ä¸Šä½¿ç”¨é€šé…ç¬¦ï¼Œä½¿ç”¨çš„è§„åˆ™å°±æ˜¯ï¼šç”Ÿäº§è€…æœ‰ä¸Šé™ã€æ¶ˆè´¹è€…æœ‰ä¸‹é™1. å¦‚æœå‚æ•°åŒ–ç±»å‹è¡¨ç¤ºä¸€ä¸ª T çš„ç”Ÿäº§è€…ï¼Œä½¿ç”¨ &lt; ? extends T&gt;;2. å¦‚æœå®ƒè¡¨ç¤ºä¸€ä¸ª T çš„æ¶ˆè´¹è€…ï¼Œå°±ä½¿ç”¨ &lt; ? super T&gt;ï¼›3. å¦‚æœæ—¢æ˜¯ç”Ÿäº§åˆæ˜¯æ¶ˆè´¹ï¼Œé‚£ä½¿ç”¨é€šé…ç¬¦å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ï¼Œå› ä¸ºä½ éœ€è¦çš„æ˜¯ç²¾ç¡®çš„å‚æ•°ç±»å‹ã€‚ å†çœ‹ä¸€ä¸ªå®é™…ä¾‹å­ï¼ŒåŠ æ·±å°è±¡ 123456789101112131415private &lt;E extends Comparable&lt;? super E&gt;&gt; E max(List&lt;? extends E&gt; e1) &#123; if (e1 == null)&#123; return null; &#125; //è¿­ä»£å™¨è¿”å›çš„å…ƒç´ å±äº E çš„æŸä¸ªå­ç±»å‹ Iterator&lt;? extends E&gt; iterator = e1.iterator(); E result = iterator.next(); while (iterator.hasNext())&#123; E next = iterator.next(); if (next.compareTo(result) &gt; 0)&#123; result = next; &#125; &#125; return result;&#125; ä¸Šè¿°ä»£ç ä¸­çš„ç±»å‹å‚æ•° E çš„èŒƒå›´æ˜¯&lt;E extends Comparable&lt;? super E&gt;&gt;ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æ­¥æŸ¥çœ‹ï¼š è¦è¿›è¡Œæ¯”è¾ƒï¼Œæ‰€ä»¥ E éœ€è¦æ˜¯å¯æ¯”è¾ƒçš„ç±»ï¼Œå› æ­¤éœ€è¦ extends Comparable&lt;â€¦&gt;ï¼ˆæ³¨æ„è¿™é‡Œä¸è¦å’Œç»§æ‰¿çš„ extends ææ··äº†ï¼Œä¸ä¸€æ ·ï¼‰ Comparable&lt; ? super E&gt; è¦å¯¹ E è¿›è¡Œæ¯”è¾ƒï¼Œå³ E çš„æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥éœ€è¦ç”¨ super è€Œå‚æ•° List&lt; ? extends E&gt; è¡¨ç¤ºè¦æ“ä½œçš„æ•°æ®æ˜¯ E çš„å­ç±»çš„åˆ—è¡¨ï¼ŒæŒ‡å®šä¸Šé™ï¼Œè¿™æ ·å®¹å™¨æ‰å¤Ÿå¤§ å¤šä¸ªé™åˆ¶ ä½¿ç”¨&amp;ç¬¦å· 1234567891011public class Client &#123; //å·¥èµ„ä½äº2500å…ƒçš„ä¸Šæ–‘æ—å¹¶ä¸”ç«™ç«‹çš„ä¹˜å®¢è½¦ç¥¨æ‰“8æŠ˜ public static &lt;T extends Staff &amp; Passenger&gt; void discount(T t)&#123; if(t.getSalary()&lt;2500 &amp;&amp; t.isStanding())&#123; System.out.println(&quot;æ­å–œä½ ï¼æ‚¨çš„è½¦ç¥¨æ‰“å…«æŠ˜ï¼&quot;); &#125; &#125; public static void main(String[] args) &#123; discount(new Me()); &#125;&#125; æ³›å‹æ•°ç»„ å…·ä½“å¯ä»¥å‚è€ƒä¸‹æ–‡ä¸­å…³äºæ³›å‹æ•°ç»„çš„ç†è§£ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æ³›å‹æ•°ç»„ç›¸å…³çš„ç”³æ˜ï¼š 123456List&lt;String&gt;[] list11 = new ArrayList&lt;String&gt;[10]; //ç¼–è¯‘é”™è¯¯ï¼Œéæ³•åˆ›å»º List&lt;String&gt;[] list12 = new ArrayList&lt;?&gt;[10]; //ç¼–è¯‘é”™è¯¯ï¼Œéœ€è¦å¼ºè½¬ç±»å‹ List&lt;String&gt;[] list13 = (List&lt;String&gt;[]) new ArrayList&lt;?&gt;[10]; //OKï¼Œä½†æ˜¯ä¼šæœ‰è­¦å‘Š List&lt;?&gt;[] list14 = new ArrayList&lt;String&gt;[10]; //ç¼–è¯‘é”™è¯¯ï¼Œéæ³•åˆ›å»º List&lt;?&gt;[] list15 = new ArrayList&lt;?&gt;[10]; //OK List&lt;String&gt;[] list6 = new ArrayList[10]; //OKï¼Œä½†æ˜¯ä¼šæœ‰è­¦å‘Š é‚£ä¹ˆé€šå¸¸æˆ‘ä»¬å¦‚ä½•ç”¨å‘¢ï¼Ÿ è®¨å·§çš„ä½¿ç”¨åœºæ™¯ 123456789101112131415public class GenericsDemo30&#123; public static void main(String args[])&#123; Integer i[] = fun1(1,2,3,4,5,6) ; // è¿”å›æ³›å‹æ•°ç»„ fun2(i) ; &#125; public static &lt;T&gt; T[] fun1(T...arg)&#123; // æ¥æ”¶å¯å˜å‚æ•° return arg ; // è¿”å›æ³›å‹æ•°ç»„ &#125; public static &lt;T&gt; void fun2(T param[])&#123; // è¾“å‡º System.out.print(&quot;æ¥æ”¶æ³›å‹æ•°ç»„ï¼š&quot;) ; for(T t:param)&#123; System.out.print(t + &quot;ã€&quot;) ; &#125; &#125; &#125; åˆç†ä½¿ç”¨ 123public ArrayWithTypeToken(Class&lt;T&gt; type, int size) &#123; array = (T[]) Array.newInstance(type, size);&#125; å…·ä½“å¯ä»¥æŸ¥çœ‹åæ–‡è§£é‡Šã€‚ æ·±å…¥ç†è§£æ³›å‹ æç¤º æˆ‘ä»¬é€šè¿‡æ³›å‹èƒŒåçš„ç±»å‹æ“¦é™¤ä»¥åŠç›¸å…³çš„é—®é¢˜æ¥è¿›ä¸€æ­¥ç†è§£æ³›å‹ã€‚ å¦‚ä½•ç†è§£Javaä¸­çš„æ³›å‹æ˜¯ä¼ªæ³›å‹ï¼Ÿæ³›å‹ä¸­ç±»å‹æ“¦é™¤ Javaæ³›å‹è¿™ä¸ªç‰¹æ€§æ˜¯ä»JDK 1.5æ‰å¼€å§‹åŠ å…¥çš„ï¼Œå› æ­¤ä¸ºäº†å…¼å®¹ä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒJavaæ³›å‹çš„å®ç°é‡‡å–äº†â€œä¼ªæ³›å‹â€çš„ç­–ç•¥ï¼Œå³Javaåœ¨è¯­æ³•ä¸Šæ”¯æŒæ³›å‹ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µä¼šè¿›è¡Œæ‰€è°“çš„â€œç±»å‹æ“¦é™¤â€ï¼ˆType Erasureï¼‰ï¼Œå°†æ‰€æœ‰çš„æ³›å‹è¡¨ç¤ºï¼ˆå°–æ‹¬å·ä¸­çš„å†…å®¹ï¼‰éƒ½æ›¿æ¢ä¸ºå…·ä½“çš„ç±»å‹ï¼ˆå…¶å¯¹åº”çš„åŸç”Ÿæ€ç±»å‹ï¼‰ï¼Œå°±åƒå®Œå…¨æ²¡æœ‰æ³›å‹ä¸€æ ·ã€‚ç†è§£ç±»å‹æ“¦é™¤å¯¹äºç”¨å¥½æ³›å‹æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›çœ‹èµ·æ¥â€œç–‘éš¾æ‚ç—‡â€çš„é—®é¢˜ï¼Œå¼„æ˜ç™½äº†ç±»å‹æ“¦é™¤ä¹Ÿå°±è¿åˆƒè€Œè§£äº†ã€‚ æ³›å‹çš„ç±»å‹æ“¦é™¤åŸåˆ™æ˜¯ï¼š æ¶ˆé™¤ç±»å‹å‚æ•°å£°æ˜ï¼Œå³åˆ é™¤&lt;&gt;åŠå…¶åŒ…å›´çš„éƒ¨åˆ†ã€‚ æ ¹æ®ç±»å‹å‚æ•°çš„ä¸Šä¸‹ç•Œæ¨æ–­å¹¶æ›¿æ¢æ‰€æœ‰çš„ç±»å‹å‚æ•°ä¸ºåŸç”Ÿæ€ç±»å‹ï¼šå¦‚æœç±»å‹å‚æ•°æ˜¯æ— é™åˆ¶é€šé…ç¬¦æˆ–æ²¡æœ‰ä¸Šä¸‹ç•Œé™å®šåˆ™æ›¿æ¢ä¸ºObjectï¼Œå¦‚æœå­˜åœ¨ä¸Šä¸‹ç•Œé™å®šåˆ™æ ¹æ®å­ç±»æ›¿æ¢åŸåˆ™å–ç±»å‹å‚æ•°çš„æœ€å·¦è¾¹é™å®šç±»å‹ï¼ˆå³çˆ¶ç±»ï¼‰ã€‚ ä¸ºäº†ä¿è¯ç±»å‹å®‰å…¨ï¼Œå¿…è¦æ—¶æ’å…¥å¼ºåˆ¶ç±»å‹è½¬æ¢ä»£ç ã€‚ è‡ªåŠ¨äº§ç”Ÿâ€œæ¡¥æ¥æ–¹æ³•â€ä»¥ä¿è¯æ“¦é™¤ç±»å‹åçš„ä»£ç ä»ç„¶å…·æœ‰æ³›å‹çš„â€œå¤šæ€æ€§â€ã€‚ é‚£ä¹ˆå¦‚ä½•è¿›è¡Œæ“¦é™¤çš„å‘¢ï¼Ÿ å‚è€ƒè‡ªï¼šhttp://softlab.sdut.edu.cn/blog/subaochen/2017/01/generics-type-erasure/ æ“¦é™¤ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•° - æ— é™åˆ¶ç±»å‹æ“¦é™¤ å½“ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°æ²¡æœ‰ä»»ä½•é™åˆ¶æ—¶ï¼Œåœ¨ç±»å‹æ“¦é™¤ä¸­ç›´æ¥è¢«æ›¿æ¢ä¸ºObjectï¼Œå³å½¢å¦‚&lt;T&gt;å’Œ&lt;?&gt;çš„ç±»å‹å‚æ•°éƒ½è¢«æ›¿æ¢ä¸ºObjectã€‚ æ“¦é™¤ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•° - æœ‰é™åˆ¶ç±»å‹æ“¦é™¤ å½“ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°å­˜åœ¨é™åˆ¶ï¼ˆä¸Šä¸‹ç•Œï¼‰æ—¶ï¼Œåœ¨ç±»å‹æ“¦é™¤ä¸­æ›¿æ¢ä¸ºç±»å‹å‚æ•°çš„ä¸Šç•Œæˆ–è€…ä¸‹ç•Œï¼Œæ¯”å¦‚å½¢å¦‚&lt;T extends Number&gt;å’Œ&lt;? extends Number&gt;çš„ç±»å‹å‚æ•°è¢«æ›¿æ¢ä¸ºNumberï¼Œ&lt;? super Number&gt;è¢«æ›¿æ¢ä¸ºObjectã€‚ æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„ç±»å‹å‚æ•° æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°åŸåˆ™å’Œæ“¦é™¤ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä»…ä»¥æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„æœ‰é™åˆ¶ç±»å‹å‚æ•°ä¸ºä¾‹ã€‚ å¦‚ä½•è¯æ˜ç±»å‹çš„æ“¦é™¤å‘¢ï¼Ÿ æˆ‘ä»¬é€šè¿‡ä¸¤ä¸ªä¾‹å­è¯æ˜Javaç±»å‹çš„ç±»å‹æ“¦é™¤ åŸå§‹ç±»å‹ç›¸ç­‰ 12345678910111213public class Test &#123; public static void main(String[] args) &#123; ArrayList&lt;String&gt; list1 = new ArrayList&lt;String&gt;(); list1.add(&quot;abc&quot;); ArrayList&lt;Integer&gt; list2 = new ArrayList&lt;Integer&gt;(); list2.add(123); System.out.println(list1.getClass() == list2.getClass()); // true &#125;&#125; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªArrayListæ•°ç»„ï¼Œä¸è¿‡ä¸€ä¸ªæ˜¯ArrayList&lt;String&gt;æ³›å‹ç±»å‹çš„ï¼Œåªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼›ä¸€ä¸ªæ˜¯ArrayList&lt;Integer&gt;æ³›å‹ç±»å‹çš„ï¼Œåªèƒ½å­˜å‚¨æ•´æ•°ï¼Œæœ€åï¼Œæˆ‘ä»¬é€šè¿‡list1å¯¹è±¡å’Œlist2å¯¹è±¡çš„getClass()æ–¹æ³•è·å–ä»–ä»¬çš„ç±»çš„ä¿¡æ¯ï¼Œæœ€åå‘ç°ç»“æœä¸ºtrueã€‚è¯´æ˜æ³›å‹ç±»å‹Stringå’ŒIntegeréƒ½è¢«æ“¦é™¤æ‰äº†ï¼Œåªå‰©ä¸‹åŸå§‹ç±»å‹ã€‚ é€šè¿‡åå°„æ·»åŠ å…¶å®ƒç±»å‹å…ƒç´  12345678910111213141516public class Test &#123; public static void main(String[] args) throws Exception &#123; ArrayList&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;(); list.add(1); //è¿™æ ·è°ƒç”¨ add æ–¹æ³•åªèƒ½å­˜å‚¨æ•´å½¢ï¼Œå› ä¸ºæ³›å‹ç±»å‹çš„å®ä¾‹ä¸º Integer list.getClass().getMethod(&quot;add&quot;, Object.class).invoke(list, &quot;asd&quot;); for (int i = 0; i &lt; list.size(); i++) &#123; System.out.println(list.get(i)); &#125; &#125;&#125; åœ¨ç¨‹åºä¸­å®šä¹‰äº†ä¸€ä¸ªArrayListæ³›å‹ç±»å‹å®ä¾‹åŒ–ä¸ºIntegerå¯¹è±¡ï¼Œå¦‚æœç›´æ¥è°ƒç”¨add()æ–¹æ³•ï¼Œé‚£ä¹ˆåªèƒ½å­˜å‚¨æ•´æ•°æ•°æ®ï¼Œä¸è¿‡å½“æˆ‘ä»¬åˆ©ç”¨åå°„è°ƒç”¨add()æ–¹æ³•çš„æ—¶å€™ï¼Œå´å¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²ï¼Œè¿™è¯´æ˜äº†Integeræ³›å‹å®ä¾‹åœ¨ç¼–è¯‘ä¹‹åè¢«æ“¦é™¤æ‰äº†ï¼Œåªä¿ç•™äº†åŸå§‹ç±»å‹ã€‚ å¦‚ä½•ç†è§£ç±»å‹æ“¦é™¤åä¿ç•™çš„åŸå§‹ç±»å‹? åœ¨ä¸Šé¢ï¼Œä¸¤æ¬¡æåˆ°äº†åŸå§‹ç±»å‹ï¼Œä»€ä¹ˆæ˜¯åŸå§‹ç±»å‹ï¼Ÿ åŸå§‹ç±»å‹ å°±æ˜¯æ“¦é™¤å»äº†æ³›å‹ä¿¡æ¯ï¼Œæœ€ååœ¨å­—èŠ‚ç ä¸­çš„ç±»å‹å˜é‡çš„çœŸæ­£ç±»å‹ï¼Œæ— è®ºä½•æ—¶å®šä¹‰ä¸€ä¸ªæ³›å‹ï¼Œç›¸åº”çš„åŸå§‹ç±»å‹éƒ½ä¼šè¢«è‡ªåŠ¨æä¾›ï¼Œç±»å‹å˜é‡æ“¦é™¤ï¼Œå¹¶ä½¿ç”¨å…¶é™å®šç±»å‹ï¼ˆæ— é™å®šçš„å˜é‡ç”¨Objectï¼‰æ›¿æ¢ã€‚ åŸå§‹ç±»å‹Object 123456789class Pair&lt;T&gt; &#123; private T value; public T getValue() &#123; return value; &#125; public void setValue(T value) &#123; this.value = value; &#125; &#125; Pairçš„åŸå§‹ç±»å‹ä¸º: 123456789class Pair &#123; private Object value; public Object getValue() &#123; return value; &#125; public void setValue(Object value) &#123; this.value = value; &#125; &#125; å› ä¸ºåœ¨Pair&lt;T&gt;ä¸­ï¼ŒT æ˜¯ä¸€ä¸ªæ— é™å®šçš„ç±»å‹å˜é‡ï¼Œæ‰€ä»¥ç”¨Objectæ›¿æ¢ï¼Œå…¶ç»“æœå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œå¦‚åŒæ³›å‹åŠ å…¥Javaè¯­è¨€ä¹‹å‰çš„å·²ç»å®ç°çš„æ ·å­ã€‚åœ¨ç¨‹åºä¸­å¯ä»¥åŒ…å«ä¸åŒç±»å‹çš„Pairï¼Œå¦‚Pair&lt;String&gt;æˆ–Pair&lt;Integer&gt;ï¼Œä½†æ˜¯æ“¦é™¤ç±»å‹åä»–ä»¬çš„å°±æˆä¸ºåŸå§‹çš„Pairç±»å‹äº†ï¼ŒåŸå§‹ç±»å‹éƒ½æ˜¯Objectã€‚ ä»ä¸Šé¢ç« èŠ‚ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ˜ç™½ArrayListè¢«æ“¦é™¤ç±»å‹åï¼ŒåŸå§‹ç±»å‹ä¹Ÿå˜ä¸ºObjectï¼Œæ‰€ä»¥é€šè¿‡åå°„æˆ‘ä»¬å°±å¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²äº†ã€‚ å¦‚æœç±»å‹å˜é‡æœ‰é™å®šï¼Œé‚£ä¹ˆåŸå§‹ç±»å‹å°±ç”¨ç¬¬ä¸€ä¸ªè¾¹ç•Œçš„ç±»å‹å˜é‡ç±»æ›¿æ¢ã€‚ æ¯”å¦‚: Pairè¿™æ ·å£°æ˜çš„è¯ 1public class Pair&lt;T extends Comparable&gt; &#123;&#125; é‚£ä¹ˆåŸå§‹ç±»å‹å°±æ˜¯Comparableã€‚ è¦åŒºåˆ†åŸå§‹ç±»å‹å’Œæ³›å‹å˜é‡çš„ç±»å‹ã€‚ åœ¨è°ƒç”¨æ³›å‹æ–¹æ³•æ—¶ï¼Œå¯ä»¥æŒ‡å®šæ³›å‹ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šæ³›å‹: åœ¨ä¸æŒ‡å®šæ³›å‹çš„æƒ…å†µä¸‹ï¼Œæ³›å‹å˜é‡çš„ç±»å‹ä¸ºè¯¥æ–¹æ³•ä¸­çš„å‡ ç§ç±»å‹çš„åŒä¸€çˆ¶ç±»çš„æœ€å°çº§ï¼Œç›´åˆ°Object åœ¨æŒ‡å®šæ³›å‹çš„æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•çš„å‡ ç§ç±»å‹å¿…é¡»æ˜¯è¯¥æ³›å‹çš„å®ä¾‹çš„ç±»å‹æˆ–è€…å…¶å­ç±» 12345678910111213141516171819public class Test &#123; public static void main(String[] args) &#123; /**ä¸æŒ‡å®šæ³›å‹çš„æ—¶å€™*/ int i = Test.add(1, 2); //è¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯Integerï¼Œæ‰€ä»¥Tä¸ºIntegerç±»å‹ Number f = Test.add(1, 1.2); //è¿™ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯Integerï¼Œä¸€ä¸ªæ˜¯Floatï¼Œæ‰€ä»¥å–åŒä¸€çˆ¶ç±»çš„æœ€å°çº§ï¼Œä¸ºNumber Object o = Test.add(1, &quot;asd&quot;); //è¿™ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯Integerï¼Œä¸€ä¸ªæ˜¯Stringï¼Œæ‰€ä»¥å–åŒä¸€çˆ¶ç±»çš„æœ€å°çº§ï¼Œä¸ºObject /**æŒ‡å®šæ³›å‹çš„æ—¶å€™*/ int a = Test.&lt;Integer&gt;add(1, 2); //æŒ‡å®šäº†Integerï¼Œæ‰€ä»¥åªèƒ½ä¸ºIntegerç±»å‹æˆ–è€…å…¶å­ç±» int b = Test.&lt;Integer&gt;add(1, 2.2); //ç¼–è¯‘é”™è¯¯ï¼ŒæŒ‡å®šäº†Integerï¼Œä¸èƒ½ä¸ºFloat Number c = Test.&lt;Number&gt;add(1, 2.2); //æŒ‡å®šä¸ºNumberï¼Œæ‰€ä»¥å¯ä»¥ä¸ºIntegerå’ŒFloat &#125; //è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ³›å‹æ–¹æ³• public static &lt;T&gt; T add(T x,T y)&#123; return y; &#125; &#125; å…¶å®åœ¨æ³›å‹ç±»ä¸­ï¼Œä¸æŒ‡å®šæ³›å‹çš„æ—¶å€™ï¼Œä¹Ÿå·®ä¸å¤šï¼Œåªä¸è¿‡è¿™ä¸ªæ—¶å€™çš„æ³›å‹ä¸ºObjectï¼Œå°±æ¯”å¦‚ArrayListä¸­ï¼Œå¦‚æœä¸æŒ‡å®šæ³›å‹ï¼Œé‚£ä¹ˆè¿™ä¸ªArrayListå¯ä»¥å­˜å‚¨ä»»æ„çš„å¯¹è±¡ã€‚ Objectæ³›å‹ 123456public static void main(String[] args) &#123; ArrayList list = new ArrayList(); list.add(1); list.add(&quot;121&quot;); list.add(new Date()); &#125; å¦‚ä½•ç†è§£æ³›å‹çš„ç¼–è¯‘æœŸæ£€æŸ¥ï¼Ÿ æ—¢ç„¶è¯´ç±»å‹å˜é‡ä¼šåœ¨ç¼–è¯‘çš„æ—¶å€™æ“¦é™¤æ‰ï¼Œé‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬å¾€ ArrayList åˆ›å»ºçš„å¯¹è±¡ä¸­æ·»åŠ æ•´æ•°ä¼šæŠ¥é”™å‘¢ï¼Ÿä¸æ˜¯è¯´æ³›å‹å˜é‡Stringä¼šåœ¨ç¼–è¯‘çš„æ—¶å€™å˜ä¸ºObjectç±»å‹å—ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½å­˜åˆ«çš„ç±»å‹å‘¢ï¼Ÿæ—¢ç„¶ç±»å‹æ“¦é™¤äº†ï¼Œå¦‚ä½•ä¿è¯æˆ‘ä»¬åªèƒ½ä½¿ç”¨æ³›å‹å˜é‡é™å®šçš„ç±»å‹å‘¢ï¼Ÿ Javaç¼–è¯‘å™¨æ˜¯é€šè¿‡å…ˆæ£€æŸ¥ä»£ç ä¸­æ³›å‹çš„ç±»å‹ï¼Œç„¶ååœ¨è¿›è¡Œç±»å‹æ“¦é™¤ï¼Œå†è¿›è¡Œç¼–è¯‘ã€‚ ä¾‹å¦‚ï¼š 123456public static void main(String[] args) &#123; ArrayList&lt;String&gt; list = new ArrayList&lt;String&gt;(); list.add(&quot;123&quot;); list.add(123);//ç¼–è¯‘é”™è¯¯ &#125; åœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œä½¿ç”¨addæ–¹æ³•æ·»åŠ ä¸€ä¸ªæ•´å‹ï¼Œåœ¨IDEä¸­ï¼Œç›´æ¥ä¼šæŠ¥é”™ï¼Œè¯´æ˜è¿™å°±æ˜¯åœ¨ç¼–è¯‘ä¹‹å‰çš„æ£€æŸ¥ï¼Œå› ä¸ºå¦‚æœæ˜¯åœ¨ç¼–è¯‘ä¹‹åæ£€æŸ¥ï¼Œç±»å‹æ“¦é™¤åï¼ŒåŸå§‹ç±»å‹ä¸ºObjectï¼Œæ˜¯åº”è¯¥å…è®¸ä»»æ„å¼•ç”¨ç±»å‹æ·»åŠ çš„ã€‚å¯å®é™…ä¸Šå´ä¸æ˜¯è¿™æ ·çš„ï¼Œè¿™æ°æ°è¯´æ˜äº†å…³äºæ³›å‹å˜é‡çš„ä½¿ç”¨ï¼Œæ˜¯ä¼šåœ¨ç¼–è¯‘ä¹‹å‰æ£€æŸ¥çš„ã€‚ é‚£ä¹ˆï¼Œè¿™ä¸ªç±»å‹æ£€æŸ¥æ˜¯é’ˆå¯¹è°çš„å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹çœ‹å‚æ•°åŒ–ç±»å‹å’ŒåŸå§‹ç±»å‹çš„å…¼å®¹ã€‚ ä»¥ ArrayListä¸¾ä¾‹å­ï¼Œä»¥å‰çš„å†™æ³•: 1ArrayList list = new ArrayList(); ç°åœ¨çš„å†™æ³•: 1ArrayList&lt;String&gt; list = new ArrayList&lt;String&gt;(); å¦‚æœæ˜¯ä¸ä»¥å‰çš„ä»£ç å…¼å®¹ï¼Œå„ç§å¼•ç”¨ä¼ å€¼ä¹‹é—´ï¼Œå¿…ç„¶ä¼šå‡ºç°å¦‚ä¸‹çš„æƒ…å†µï¼š 12ArrayList&lt;String&gt; list1 = new ArrayList(); //ç¬¬ä¸€ç§ æƒ…å†µArrayList list2 = new ArrayList&lt;String&gt;(); //ç¬¬äºŒç§ æƒ…å†µ è¿™æ ·æ˜¯æ²¡æœ‰é”™è¯¯çš„ï¼Œä¸è¿‡ä¼šæœ‰ä¸ªç¼–è¯‘æ—¶è­¦å‘Šã€‚ ä¸è¿‡åœ¨ç¬¬ä¸€ç§æƒ…å†µï¼Œå¯ä»¥å®ç°ä¸å®Œå…¨ä½¿ç”¨æ³›å‹å‚æ•°ä¸€æ ·çš„æ•ˆæœï¼Œç¬¬äºŒç§åˆ™æ²¡æœ‰æ•ˆæœã€‚ å› ä¸ºç±»å‹æ£€æŸ¥å°±æ˜¯ç¼–è¯‘æ—¶å®Œæˆçš„ï¼Œnew ArrayList()åªæ˜¯åœ¨å†…å­˜ä¸­å¼€è¾Ÿäº†ä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œå¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹å¯¹è±¡ï¼Œè€ŒçœŸæ­£æ¶‰åŠç±»å‹æ£€æŸ¥çš„æ˜¯å®ƒçš„å¼•ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä½¿ç”¨å®ƒå¼•ç”¨list1æ¥è°ƒç”¨å®ƒçš„æ–¹æ³•ï¼Œæ¯”å¦‚è¯´è°ƒç”¨addæ–¹æ³•ï¼Œæ‰€ä»¥list1å¼•ç”¨èƒ½å®Œæˆæ³›å‹ç±»å‹çš„æ£€æŸ¥ã€‚è€Œå¼•ç”¨list2æ²¡æœ‰ä½¿ç”¨æ³›å‹ï¼Œæ‰€ä»¥ä¸è¡Œã€‚ ä¸¾ä¾‹å­ï¼š 1234567891011121314151617181920public class Test &#123; public static void main(String[] args) &#123; ArrayList&lt;String&gt; list1 = new ArrayList(); list1.add(&quot;1&quot;); //ç¼–è¯‘é€šè¿‡ list1.add(1); //ç¼–è¯‘é”™è¯¯ String str1 = list1.get(0); //è¿”å›ç±»å‹å°±æ˜¯String ArrayList list2 = new ArrayList&lt;String&gt;(); list2.add(&quot;1&quot;); //ç¼–è¯‘é€šè¿‡ list2.add(1); //ç¼–è¯‘é€šè¿‡ Object object = list2.get(0); //è¿”å›ç±»å‹å°±æ˜¯Object new ArrayList&lt;String&gt;().add(&quot;11&quot;); //ç¼–è¯‘é€šè¿‡ new ArrayList&lt;String&gt;().add(22); //ç¼–è¯‘é”™è¯¯ String str2 = new ArrayList&lt;String&gt;().get(0); //è¿”å›ç±»å‹å°±æ˜¯String &#125; &#125; é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½ï¼Œç±»å‹æ£€æŸ¥å°±æ˜¯é’ˆå¯¹å¼•ç”¨çš„ï¼Œè°æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œç”¨è¿™ä¸ªå¼•ç”¨è°ƒç”¨æ³›å‹æ–¹æ³•ï¼Œå°±ä¼šå¯¹è¿™ä¸ªå¼•ç”¨è°ƒç”¨çš„æ–¹æ³•è¿›è¡Œç±»å‹æ£€æµ‹ï¼Œè€Œæ— å…³å®ƒçœŸæ­£å¼•ç”¨çš„å¯¹è±¡ã€‚ æ³›å‹ä¸­å‚æ•°è¯ç±»å‹ä¸ºä»€ä¹ˆä¸è€ƒè™‘ç»§æ‰¿å…³ç³»ï¼Ÿ åœ¨Javaä¸­ï¼Œåƒä¸‹é¢å½¢å¼çš„å¼•ç”¨ä¼ é€’æ˜¯ä¸å…è®¸çš„: 12ArrayList&lt;String&gt; list1 = new ArrayList&lt;Object&gt;(); //ç¼–è¯‘é”™è¯¯ ArrayList&lt;Object&gt; list2 = new ArrayList&lt;String&gt;(); //ç¼–è¯‘é”™è¯¯ æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€ç§æƒ…å†µï¼Œå°†ç¬¬ä¸€ç§æƒ…å†µæ‹“å±•æˆä¸‹é¢çš„å½¢å¼ï¼š 1234ArrayList&lt;Object&gt; list1 = new ArrayList&lt;Object&gt;(); list1.add(new Object()); list1.add(new Object()); ArrayList&lt;String&gt; list2 = list1; //ç¼–è¯‘é”™è¯¯ å®é™…ä¸Šï¼Œåœ¨ç¬¬4è¡Œä»£ç çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰ç¼–è¯‘é”™è¯¯ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å…ˆå‡è®¾å®ƒç¼–è¯‘æ²¡é”™ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬ä½¿ç”¨list2å¼•ç”¨ç”¨get()æ–¹æ³•å–å€¼çš„æ—¶å€™ï¼Œè¿”å›çš„éƒ½æ˜¯Stringç±»å‹çš„å¯¹è±¡ï¼ˆä¸Šé¢æåˆ°äº†ï¼Œç±»å‹æ£€æµ‹æ˜¯æ ¹æ®å¼•ç”¨æ¥å†³å®šçš„ï¼‰ï¼Œå¯æ˜¯å®ƒé‡Œé¢å®é™…ä¸Šå·²ç»è¢«æˆ‘ä»¬å­˜æ”¾äº†Objectç±»å‹çš„å¯¹è±¡ï¼Œè¿™æ ·å°±ä¼šæœ‰ClassCastExceptionäº†ã€‚æ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§ææ˜“å‡ºç°çš„é”™è¯¯ï¼ŒJavaä¸å…è®¸è¿›è¡Œè¿™æ ·çš„å¼•ç”¨ä¼ é€’ã€‚ï¼ˆè¿™ä¹Ÿæ˜¯æ³›å‹å‡ºç°çš„åŸå› ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³ç±»å‹è½¬æ¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸èƒ½è¿èƒŒå®ƒçš„åˆè¡·ï¼‰ã€‚ å†çœ‹ç¬¬äºŒç§æƒ…å†µï¼Œå°†ç¬¬äºŒç§æƒ…å†µæ‹“å±•æˆä¸‹é¢çš„å½¢å¼ï¼š 12345ArrayList&lt;String&gt; list1 = new ArrayList&lt;String&gt;(); list1.add(new String()); list1.add(new String());ArrayList&lt;Object&gt; list2 = list1; //ç¼–è¯‘é”™è¯¯ æ²¡é”™ï¼Œè¿™æ ·çš„æƒ…å†µæ¯”ç¬¬ä¸€ç§æƒ…å†µå¥½çš„å¤šï¼Œæœ€èµ·ç ï¼Œåœ¨æˆ‘ä»¬ç”¨list2å–å€¼çš„æ—¶å€™ä¸ä¼šå‡ºç°ClassCastExceptionï¼Œå› ä¸ºæ˜¯ä»Stringè½¬æ¢ä¸ºObjectã€‚å¯æ˜¯ï¼Œè¿™æ ·åšæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Œæ³›å‹å‡ºç°çš„åŸå› ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³ç±»å‹è½¬æ¢çš„é—®é¢˜ã€‚ æˆ‘ä»¬ä½¿ç”¨äº†æ³›å‹ï¼Œåˆ°å¤´æ¥ï¼Œè¿˜æ˜¯è¦è‡ªå·±å¼ºè½¬ï¼Œè¿èƒŒäº†æ³›å‹è®¾è®¡çš„åˆè¡·ã€‚æ‰€ä»¥javaä¸å…è®¸è¿™ä¹ˆå¹²ã€‚å†è¯´ï¼Œä½ å¦‚æœåˆç”¨list2å¾€é‡Œé¢add()æ–°çš„å¯¹è±¡ï¼Œé‚£ä¹ˆåˆ°æ—¶å€™å–å¾—æ—¶å€™ï¼Œæˆ‘æ€ä¹ˆçŸ¥é“æˆ‘å–å‡ºæ¥çš„åˆ°åº•æ˜¯Stringç±»å‹çš„ï¼Œè¿˜æ˜¯Objectç±»å‹çš„å‘¢ï¼Ÿ æ‰€ä»¥ï¼Œè¦æ ¼å¤–æ³¨æ„ï¼Œæ³›å‹ä¸­çš„å¼•ç”¨ä¼ é€’çš„é—®é¢˜ã€‚ å¦‚ä½•ç†è§£æ³›å‹çš„å¤šæ€ï¼Ÿæ³›å‹çš„æ¡¥æ¥æ–¹æ³• ç±»å‹æ“¦é™¤ä¼šé€ æˆå¤šæ€çš„å†²çªï¼Œè€ŒJVMè§£å†³æ–¹æ³•å°±æ˜¯æ¡¥æ¥æ–¹æ³•ã€‚ ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªæ³›å‹ç±»ï¼š 123456789101112class Pair&lt;T&gt; &#123; private T value; public T getValue() &#123; return value; &#125; public void setValue(T value) &#123; this.value = value; &#125; &#125; ç„¶åæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå­ç±»ç»§æ‰¿å®ƒã€‚ 123456789101112class DateInter extends Pair&lt;Date&gt; &#123; @Override public void setValue(Date value) &#123; super.setValue(value); &#125; @Override public Date getValue() &#123; return super.getValue(); &#125; &#125; åœ¨è¿™ä¸ªå­ç±»ä¸­ï¼Œæˆ‘ä»¬è®¾å®šçˆ¶ç±»çš„æ³›å‹ç±»å‹ä¸ºPair&lt;Date&gt;ï¼Œåœ¨å­ç±»ä¸­ï¼Œæˆ‘ä»¬è¦†ç›–äº†çˆ¶ç±»çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬çš„åŸæ„æ˜¯è¿™æ ·çš„ï¼šå°†çˆ¶ç±»çš„æ³›å‹ç±»å‹é™å®šä¸ºDateï¼Œé‚£ä¹ˆçˆ¶ç±»é‡Œé¢çš„ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°éƒ½ä¸ºDateç±»å‹ã€‚ 1234567public Date getValue() &#123; return value; &#125; public void setValue(Date value) &#123; this.value = value; &#125; æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å­ç±»ä¸­é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•ä¸€ç‚¹é—®é¢˜ä¹Ÿæ²¡æœ‰ï¼Œå®é™…ä¸Šï¼Œä»ä»–ä»¬çš„@Overrideæ ‡ç­¾ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸€ç‚¹é—®é¢˜ä¹Ÿæ²¡æœ‰ï¼Œå®é™…ä¸Šæ˜¯è¿™æ ·çš„å—ï¼Ÿ åˆ†æï¼šå®é™…ä¸Šï¼Œç±»å‹æ“¦é™¤åï¼Œçˆ¶ç±»çš„çš„æ³›å‹ç±»å‹å…¨éƒ¨å˜ä¸ºäº†åŸå§‹ç±»å‹Objectï¼Œæ‰€ä»¥çˆ¶ç±»ç¼–è¯‘ä¹‹åä¼šå˜æˆä¸‹é¢çš„æ ·å­ï¼š 1234567891011class Pair &#123; private Object value; public Object getValue() &#123; return value; &#125; public void setValue(Object value) &#123; this.value = value; &#125; &#125; å†çœ‹å­ç±»çš„ä¸¤ä¸ªé‡å†™çš„æ–¹æ³•çš„ç±»å‹ï¼š 12345678@Override public void setValue(Date value) &#123; super.setValue(value); &#125; @Override public Date getValue() &#123; return super.getValue(); &#125; å…ˆæ¥åˆ†æsetValueæ–¹æ³•ï¼Œçˆ¶ç±»çš„ç±»å‹æ˜¯Objectï¼Œè€Œå­ç±»çš„ç±»å‹æ˜¯Dateï¼Œå‚æ•°ç±»å‹ä¸ä¸€æ ·ï¼Œè¿™å¦‚æœå®åœ¨æ™®é€šçš„ç»§æ‰¿å…³ç³»ä¸­ï¼Œæ ¹æœ¬å°±ä¸ä¼šæ˜¯é‡å†™ï¼Œè€Œæ˜¯é‡è½½ã€‚ æˆ‘ä»¬åœ¨ä¸€ä¸ªmainæ–¹æ³•æµ‹è¯•ä¸€ä¸‹ï¼š 12345public static void main(String[] args) throws ClassNotFoundException &#123; DateInter dateInter = new DateInter(); dateInter.setValue(new Date()); dateInter.setValue(new Object()); //ç¼–è¯‘é”™è¯¯ &#125; å¦‚æœæ˜¯é‡è½½ï¼Œé‚£ä¹ˆå­ç±»ä¸­ä¸¤ä¸ªsetValueæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å‚æ•°Objectç±»å‹ï¼Œä¸€ä¸ªæ˜¯Dateç±»å‹ï¼Œå¯æ˜¯æˆ‘ä»¬å‘ç°ï¼Œæ ¹æœ¬å°±æ²¡æœ‰è¿™æ ·çš„ä¸€ä¸ªå­ç±»ç»§æ‰¿è‡ªçˆ¶ç±»çš„Objectç±»å‹å‚æ•°çš„æ–¹æ³•ã€‚æ‰€ä»¥è¯´ï¼Œå´æ˜¯æ˜¯é‡å†™äº†ï¼Œè€Œä¸æ˜¯é‡è½½äº†ã€‚ ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ åŸå› æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬ä¼ å…¥çˆ¶ç±»çš„æ³›å‹ç±»å‹æ˜¯Dateï¼ŒPair&lt;Date&gt;ï¼Œæˆ‘ä»¬çš„æœ¬æ„æ˜¯å°†æ³›å‹ç±»å˜ä¸ºå¦‚ä¸‹ï¼š 123456789class Pair &#123; private Date value; public Date getValue() &#123; return value; &#125; public void setValue(Date value) &#123; this.value = value; &#125; &#125; ç„¶åå†å­ç±»ä¸­é‡å†™å‚æ•°ç±»å‹ä¸ºDateçš„é‚£ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ç°ç»§æ‰¿ä¸­çš„å¤šæ€ã€‚ å¯æ˜¯ç”±äºç§ç§åŸå› ï¼Œè™šæ‹Ÿæœºå¹¶ä¸èƒ½å°†æ³›å‹ç±»å‹å˜ä¸ºDateï¼Œåªèƒ½å°†ç±»å‹æ“¦é™¤æ‰ï¼Œå˜ä¸ºåŸå§‹ç±»å‹Objectã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„æœ¬æ„æ˜¯è¿›è¡Œé‡å†™ï¼Œå®ç°å¤šæ€ã€‚å¯æ˜¯ç±»å‹æ“¦é™¤åï¼Œåªèƒ½å˜ä¸ºäº†é‡è½½ã€‚è¿™æ ·ï¼Œç±»å‹æ“¦é™¤å°±å’Œå¤šæ€æœ‰äº†å†²çªã€‚JVMçŸ¥é“ä½ çš„æœ¬æ„å—ï¼ŸçŸ¥é“ï¼ï¼ï¼å¯æ˜¯å®ƒèƒ½ç›´æ¥å®ç°å—ï¼Œä¸èƒ½ï¼ï¼ï¼å¦‚æœçœŸçš„ä¸èƒ½çš„è¯ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆå»é‡å†™æˆ‘ä»¬æƒ³è¦çš„Dateç±»å‹å‚æ•°çš„æ–¹æ³•å•Šã€‚ äºæ˜¯JVMé‡‡ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•ï¼Œæ¥å®Œæˆè¿™é¡¹åŠŸèƒ½ï¼Œé‚£å°±æ˜¯æ¡¥æ–¹æ³•ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ç”¨javap -c classNameçš„æ–¹å¼åç¼–è¯‘ä¸‹DateInterå­ç±»çš„å­—èŠ‚ç ï¼Œç»“æœå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435class com.tao.test.DateInter extends com.tao.test.Pair&lt;java.util.Date&gt; &#123; com.tao.test.DateInter(); Code: 0: aload_0 1: invokespecial #8 // Method com/tao/test/Pair.&quot;&lt;init&gt;&quot;:()V 4: return public void setValue(java.util.Date); //æˆ‘ä»¬é‡å†™çš„setValueæ–¹æ³• Code: 0: aload_0 1: aload_1 2: invokespecial #16 // Method com/tao/test/Pair.setValue:(Ljava/lang/Object;)V 5: return public java.util.Date getValue(); //æˆ‘ä»¬é‡å†™çš„getValueæ–¹æ³• Code: 0: aload_0 1: invokespecial #23 // Method com/tao/test/Pair.getValue:()Ljava/lang/Object; 4: checkcast #26 // class java/util/Date 7: areturn public java.lang.Object getValue(); //ç¼–è¯‘æ—¶ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„æ¡¥æ–¹æ³• Code: 0: aload_0 1: invokevirtual #28 // Method getValue:()Ljava/util/Date å»è°ƒç”¨æˆ‘ä»¬é‡å†™çš„getValueæ–¹æ³•; 4: areturn public void setValue(java.lang.Object); //ç¼–è¯‘æ—¶ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„æ¡¥æ–¹æ³• Code: 0: aload_0 1: aload_1 2: checkcast #26 // class java/util/Date 5: invokevirtual #30 // Method setValue:(Ljava/util/Date; å»è°ƒç”¨æˆ‘ä»¬é‡å†™çš„setValueæ–¹æ³•)V 8: return &#125; ä»ç¼–è¯‘çš„ç»“æœæ¥çœ‹ï¼Œæˆ‘ä»¬æœ¬æ„é‡å†™setValueå’ŒgetValueæ–¹æ³•çš„å­ç±»ï¼Œç«Ÿç„¶æœ‰4ä¸ªæ–¹æ³•ï¼Œå…¶å®ä¸ç”¨æƒŠå¥‡ï¼Œæœ€åçš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ç¼–è¯‘å™¨è‡ªå·±ç”Ÿæˆçš„æ¡¥æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°æ¡¥æ–¹æ³•çš„å‚æ•°ç±»å‹éƒ½æ˜¯Objectï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå­ç±»ä¸­çœŸæ­£è¦†ç›–çˆ¶ç±»ä¸¤ä¸ªæ–¹æ³•çš„å°±æ˜¯è¿™ä¸¤ä¸ªæˆ‘ä»¬çœ‹ä¸åˆ°çš„æ¡¥æ–¹æ³•ã€‚è€Œæ‰“åœ¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„setvalueå’ŒgetValueæ–¹æ³•ä¸Šé¢çš„@Oveerrideåªä¸è¿‡æ˜¯å‡è±¡ã€‚è€Œæ¡¥æ–¹æ³•çš„å†…éƒ¨å®ç°ï¼Œå°±åªæ˜¯å»è°ƒç”¨æˆ‘ä»¬è‡ªå·±é‡å†™çš„é‚£ä¸¤ä¸ªæ–¹æ³•ã€‚ æ‰€ä»¥ï¼Œè™šæ‹Ÿæœºå·§å¦™çš„ä½¿ç”¨äº†æ¡¥æ–¹æ³•ï¼Œæ¥è§£å†³äº†ç±»å‹æ“¦é™¤å’Œå¤šæ€çš„å†²çªã€‚ ä¸è¿‡ï¼Œè¦æåˆ°ä¸€ç‚¹ï¼Œè¿™é‡Œé¢çš„setValueå’ŒgetValueè¿™ä¸¤ä¸ªæ¡¥æ–¹æ³•çš„æ„ä¹‰åˆæœ‰ä¸åŒã€‚ setValueæ–¹æ³•æ˜¯ä¸ºäº†è§£å†³ç±»å‹æ“¦é™¤ä¸å¤šæ€ä¹‹é—´çš„å†²çªã€‚ è€ŒgetValueå´æœ‰æ™®éçš„æ„ä¹‰ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œå¦‚æœè¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„ç»§æ‰¿å…³ç³»ï¼š é‚£ä¹ˆçˆ¶ç±»çš„getValueæ–¹æ³•å¦‚ä¸‹ï¼š 123public Object getValue() &#123; return super.getValue(); &#125; è€Œå­ç±»é‡å†™çš„æ–¹æ³•æ˜¯ï¼š 123public Date getValue() &#123; return super.getValue(); &#125; å…¶å®è¿™åœ¨æ™®é€šçš„ç±»ç»§æ‰¿ä¸­ä¹Ÿæ˜¯æ™®éå­˜åœ¨çš„é‡å†™ï¼Œè¿™å°±æ˜¯åå˜ã€‚ å¹¶ä¸”ï¼Œè¿˜æœ‰ä¸€ç‚¹ä¹Ÿè®¸ä¼šæœ‰ç–‘é—®ï¼Œå­ç±»ä¸­çš„æ¡¥æ–¹æ³•Object getValue()å’ŒDate getValue()æ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œå¯æ˜¯å¦‚æœæ˜¯å¸¸è§„çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œä»–ä»¬çš„æ–¹æ³•ç­¾åæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è™šæ‹Ÿæœºæ ¹æœ¬ä¸èƒ½åˆ†åˆ«è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚å¦‚æœæ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™Javaä»£ç ï¼Œè¿™æ ·çš„ä»£ç æ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘å™¨çš„æ£€æŸ¥çš„ï¼Œä½†æ˜¯è™šæ‹Ÿæœºå´æ˜¯å…è®¸è¿™æ ·åšçš„ï¼Œå› ä¸ºè™šæ‹Ÿæœºé€šè¿‡å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹æ¥ç¡®å®šä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸ºäº†å®ç°æ³›å‹çš„å¤šæ€å…è®¸è‡ªå·±åšè¿™ä¸ªçœ‹èµ·æ¥â€œä¸åˆæ³•â€çš„äº‹æƒ…ï¼Œç„¶åäº¤ç»™è™šæ‹Ÿå™¨å»åŒºåˆ«ã€‚ å¦‚ä½•ç†è§£åŸºæœ¬ç±»å‹ä¸èƒ½ä½œä¸ºæ³›å‹ç±»å‹ï¼Ÿ æ¯”å¦‚ï¼Œæˆ‘ä»¬æ²¡æœ‰ArrayList&lt;int&gt;ï¼Œåªæœ‰ArrayList&lt;Integer&gt;, ä¸ºä½•ï¼Ÿ å› ä¸ºå½“ç±»å‹æ“¦é™¤åï¼ŒArrayListçš„åŸå§‹ç±»å‹å˜ä¸ºObjectï¼Œä½†æ˜¯Objectç±»å‹ä¸èƒ½å­˜å‚¨intå€¼ï¼Œåªèƒ½å¼•ç”¨Integerçš„å€¼ã€‚ å¦å¤–éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨list.add(1)æ˜¯å› ä¸ºJavaåŸºç¡€ç±»å‹çš„è‡ªåŠ¨è£…ç®±æ‹†ç®±æ“ä½œã€‚ å¦‚ä½•ç†è§£æ³›å‹ç±»å‹ä¸èƒ½å®ä¾‹åŒ–ï¼Ÿ ä¸èƒ½å®ä¾‹åŒ–æ³›å‹ç±»å‹, è¿™æœ¬è´¨ä¸Šæ˜¯ç”±äºç±»å‹æ“¦é™¤å†³å®šçš„ï¼š æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ä¼šåœ¨ç¼–è¯‘å™¨ä¸­æŠ¥é”™ï¼š 1T test = new T(); // ERROR å› ä¸ºåœ¨ Java ç¼–è¯‘æœŸæ²¡æ³•ç¡®å®šæ³›å‹å‚æ•°åŒ–ç±»å‹ï¼Œä¹Ÿå°±æ‰¾ä¸åˆ°å¯¹åº”çš„ç±»å­—èŠ‚ç æ–‡ä»¶ï¼Œæ‰€ä»¥è‡ªç„¶å°±ä¸è¡Œäº†ï¼Œæ­¤å¤–ç”±äºT è¢«æ“¦é™¤ä¸º Objectï¼Œå¦‚æœå¯ä»¥ new T() åˆ™å°±å˜æˆäº† new Object()ï¼Œå¤±å»äº†æœ¬æ„ã€‚ å¦‚æœæˆ‘ä»¬ç¡®å®éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªæ³›å‹ï¼Œåº”è¯¥å¦‚ä½•åšå‘¢ï¼Ÿå¯ä»¥é€šè¿‡åå°„å®ç°ï¼š 1234static &lt;T&gt; T newTclass (Class &lt; T &gt; clazz) throws InstantiationException, IllegalAccessException &#123; T obj = clazz.newInstance(); return obj;&#125; æ³›å‹æ•°ç»„ï¼šèƒ½ä¸èƒ½é‡‡ç”¨å…·ä½“çš„æ³›å‹ç±»å‹è¿›è¡Œåˆå§‹åŒ–ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Oracleå®˜ç½‘æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼š 1234567List&lt;String&gt;[] lsa = new List&lt;String&gt;[10]; // Not really allowed.Object o = lsa;Object[] oa = (Object[]) o;List&lt;Integer&gt; li = new ArrayList&lt;Integer&gt;();li.add(new Integer(3));oa[1] = li; // Unsound, but passes run time store checkString s = lsa[1].get(0); // Run-time error ClassCastException. ç”±äº JVM æ³›å‹çš„æ“¦é™¤æœºåˆ¶ï¼Œæ‰€ä»¥ä¸Šé¢ä»£ç å¯ä»¥ç»™ oa[1] èµ‹å€¼ä¸º ArrayList ä¹Ÿä¸ä¼šå‡ºç°å¼‚å¸¸ï¼Œä½†æ˜¯åœ¨å–å‡ºæ•°æ®çš„æ—¶å€™å´è¦åšä¸€æ¬¡ç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç° ClassCastExceptionï¼Œå¦‚æœå¯ä»¥è¿›è¡Œæ³›å‹æ•°ç»„çš„å£°æ˜åˆ™ä¸Šé¢è¯´çš„è¿™ç§æƒ…å†µåœ¨ç¼–è¯‘æœŸä¸ä¼šå‡ºç°ä»»ä½•è­¦å‘Šå’Œé”™è¯¯ï¼Œåªæœ‰åœ¨è¿è¡Œæ—¶æ‰ä¼šå‡ºé”™ï¼Œä½†æ˜¯æ³›å‹çš„å‡ºç°å°±æ˜¯ä¸ºäº†æ¶ˆç­ ClassCastExceptionï¼Œæ‰€ä»¥å¦‚æœ Java æ”¯æŒæ³›å‹æ•°ç»„åˆå§‹åŒ–æ“ä½œå°±æ˜¯æ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„šã€‚ è€Œå¯¹äºä¸‹é¢çš„ä»£ç æ¥è¯´æ˜¯æˆç«‹çš„ï¼š 1234567List&lt;?&gt;[] lsa = new List&lt;?&gt;[10]; // OK, array of unbounded wildcard type.Object o = lsa;Object[] oa = (Object[]) o;List&lt;Integer&gt; li = new ArrayList&lt;Integer&gt;();li.add(new Integer(3));oa[1] = li; // Correct.Integer i = (Integer) lsa[1].get(0); // OK æ‰€ä»¥è¯´é‡‡ç”¨é€šé…ç¬¦çš„æ–¹å¼åˆå§‹åŒ–æ³›å‹æ•°ç»„æ˜¯å…è®¸çš„ï¼Œå› ä¸ºå¯¹äºé€šé…ç¬¦çš„æ–¹å¼æœ€åå–å‡ºæ•°æ®æ˜¯è¦åšæ˜¾å¼ç±»å‹è½¬æ¢çš„ï¼Œç¬¦åˆé¢„æœŸé€»è¾‘ã€‚ç»¼è¿°å°±æ˜¯è¯´Java çš„æ³›å‹æ•°ç»„åˆå§‹åŒ–æ—¶æ•°ç»„ç±»å‹ä¸èƒ½æ˜¯å…·ä½“çš„æ³›å‹ç±»å‹ï¼Œåªèƒ½æ˜¯é€šé…ç¬¦çš„å½¢å¼ï¼Œå› ä¸ºå…·ä½“ç±»å‹ä¼šå¯¼è‡´å¯å­˜å…¥ä»»æ„ç±»å‹å¯¹è±¡ï¼Œåœ¨å–å‡ºæ—¶ä¼šå‘ç”Ÿç±»å‹è½¬æ¢å¼‚å¸¸ï¼Œä¼šä¸æ³›å‹çš„è®¾è®¡æ€æƒ³å†²çªï¼Œè€Œé€šé…ç¬¦å½¢å¼æœ¬æ¥å°±éœ€è¦è‡ªå·±å¼ºè½¬ï¼Œç¬¦åˆé¢„æœŸã€‚ Oracle å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.oracle.com/javase/tutorial/extra/generics/fineprint.htmlåœ¨æ–°çª—å£æ‰“å¼€ æ›´è¿›ä¸€æ­¥çš„ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä¸‹çš„ä»£ç ï¼š 123456List&lt;String&gt;[] list11 = new ArrayList&lt;String&gt;[10]; //ç¼–è¯‘é”™è¯¯ï¼Œéæ³•åˆ›å»º List&lt;String&gt;[] list12 = new ArrayList&lt;?&gt;[10]; //ç¼–è¯‘é”™è¯¯ï¼Œéœ€è¦å¼ºè½¬ç±»å‹ List&lt;String&gt;[] list13 = (List&lt;String&gt;[]) new ArrayList&lt;?&gt;[10]; //OKï¼Œä½†æ˜¯ä¼šæœ‰è­¦å‘Š List&lt;?&gt;[] list14 = new ArrayList&lt;String&gt;[10]; //ç¼–è¯‘é”™è¯¯ï¼Œéæ³•åˆ›å»º List&lt;?&gt;[] list15 = new ArrayList&lt;?&gt;[10]; //OK List&lt;String&gt;[] list6 = new ArrayList[10]; //OKï¼Œä½†æ˜¯ä¼šæœ‰è­¦å‘Š å› ä¸ºåœ¨ Java ä¸­æ˜¯ä¸èƒ½åˆ›å»ºä¸€ä¸ªç¡®åˆ‡çš„æ³›å‹ç±»å‹çš„æ•°ç»„çš„ï¼Œé™¤éæ˜¯é‡‡ç”¨é€šé…ç¬¦çš„æ–¹å¼ä¸”è¦åšæ˜¾å¼ç±»å‹è½¬æ¢æ‰å¯ä»¥ã€‚ æ³›å‹æ•°ç»„ï¼šå¦‚ä½•æ­£ç¡®çš„åˆå§‹åŒ–æ³›å‹æ•°ç»„å®ä¾‹ï¼Ÿ è¿™ä¸ªæ— è®ºæˆ‘ä»¬é€šè¿‡new ArrayList[10] çš„å½¢å¼è¿˜æ˜¯é€šè¿‡æ³›å‹é€šé…ç¬¦çš„å½¢å¼åˆå§‹åŒ–æ³›å‹æ•°ç»„å®ä¾‹éƒ½æ˜¯å­˜åœ¨è­¦å‘Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…ä»…è¯­æ³•åˆæ ¼ï¼Œè¿è¡Œæ—¶æ½œåœ¨çš„é£é™©éœ€è¦æˆ‘ä»¬è‡ªå·±æ¥æ‰¿æ‹…ï¼Œå› æ­¤é‚£äº›æ–¹å¼åˆå§‹åŒ–æ³›å‹æ•°ç»„éƒ½ä¸æ˜¯æœ€ä¼˜é›…çš„æ–¹å¼ã€‚ æˆ‘ä»¬åœ¨ä½¿ç”¨åˆ°æ³›å‹æ•°ç»„çš„åœºæ™¯ä¸‹åº”è¯¥å°½é‡ä½¿ç”¨åˆ—è¡¨é›†åˆæ›¿æ¢ï¼Œæ­¤å¤–ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ java.lang.reflect.Array.newInstance(Class&lt;T&gt; componentType, int length) æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šç±»å‹å’Œç»´åº¦çš„æ•°ç»„ï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223public class ArrayWithTypeToken&lt;T&gt; &#123; private T[] array; public ArrayWithTypeToken(Class&lt;T&gt; type, int size) &#123; array = (T[]) Array.newInstance(type, size); &#125; public void put(int index, T item) &#123; array[index] = item; &#125; public T get(int index) &#123; return array[index]; &#125; public T[] create() &#123; return array; &#125;&#125;//...ArrayWithTypeToken&lt;Integer&gt; arrayToken = new ArrayWithTypeToken&lt;Integer&gt;(Integer.class, 100);Integer[] array = arrayToken.create(); æ‰€ä»¥ä½¿ç”¨åå°„æ¥åˆå§‹åŒ–æ³›å‹æ•°ç»„ç®—æ˜¯ä¼˜é›…å®ç°ï¼Œå› ä¸ºæ³›å‹ç±»å‹ Tåœ¨è¿è¡Œæ—¶æ‰èƒ½è¢«ç¡®å®šä¸‹æ¥ï¼Œæˆ‘ä»¬èƒ½åˆ›å»ºæ³›å‹æ•°ç»„ä¹Ÿå¿…ç„¶æ˜¯åœ¨ Java è¿è¡Œæ—¶æƒ³åŠæ³•ï¼Œè€Œè¿è¡Œæ—¶èƒ½èµ·ä½œç”¨çš„æŠ€æœ¯æœ€å¥½çš„å°±æ˜¯åå°„äº†ã€‚ å¦‚ä½•ç†è§£æ³›å‹ç±»ä¸­çš„é™æ€æ–¹æ³•å’Œé™æ€å˜é‡ï¼Ÿ æ³›å‹ç±»ä¸­çš„é™æ€æ–¹æ³•å’Œé™æ€å˜é‡ä¸å¯ä»¥ä½¿ç”¨æ³›å‹ç±»æ‰€å£°æ˜çš„æ³›å‹ç±»å‹å‚æ•° ä¸¾ä¾‹è¯´æ˜ï¼š 123456public class Test2&lt;T&gt; &#123; public static T one; //ç¼–è¯‘é”™è¯¯ public static T show(T one)&#123; //ç¼–è¯‘é”™è¯¯ return null; &#125; &#125; å› ä¸ºæ³›å‹ç±»ä¸­çš„æ³›å‹å‚æ•°çš„å®ä¾‹åŒ–æ˜¯åœ¨å®šä¹‰å¯¹è±¡çš„æ—¶å€™æŒ‡å®šçš„ï¼Œè€Œé™æ€å˜é‡å’Œé™æ€æ–¹æ³•ä¸éœ€è¦ä½¿ç”¨å¯¹è±¡æ¥è°ƒç”¨ã€‚å¯¹è±¡éƒ½æ²¡æœ‰åˆ›å»ºï¼Œå¦‚ä½•ç¡®å®šè¿™ä¸ªæ³›å‹å‚æ•°æ˜¯ä½•ç§ç±»å‹ï¼Œæ‰€ä»¥å½“ç„¶æ˜¯é”™è¯¯çš„ã€‚ ä½†æ˜¯è¦æ³¨æ„åŒºåˆ†ä¸‹é¢çš„ä¸€ç§æƒ…å†µï¼š 123456public class Test2&lt;T&gt; &#123; public static &lt;T &gt;T show(T one)&#123; //è¿™æ˜¯æ­£ç¡®çš„ return null; &#125; &#125; å› ä¸ºè¿™æ˜¯ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œåœ¨æ³›å‹æ–¹æ³•ä¸­ä½¿ç”¨çš„Tæ˜¯è‡ªå·±åœ¨æ–¹æ³•ä¸­å®šä¹‰çš„ Tï¼Œè€Œä¸æ˜¯æ³›å‹ç±»ä¸­çš„Tã€‚ å¦‚ä½•ç†è§£å¼‚å¸¸ä¸­ä½¿ç”¨æ³›å‹ï¼Ÿ ä¸èƒ½æŠ›å‡ºä¹Ÿä¸èƒ½æ•è·æ³›å‹ç±»çš„å¯¹è±¡ã€‚äº‹å®ä¸Šï¼Œæ³›å‹ç±»æ‰©å±•Throwableéƒ½ä¸åˆæ³•ã€‚ä¾‹å¦‚ï¼šä¸‹é¢çš„å®šä¹‰å°†ä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼š 123public class Problem&lt;T&gt; extends Exception &#123;&#125; ä¸ºä»€ä¹ˆä¸èƒ½æ‰©å±•Throwableï¼Œå› ä¸ºå¼‚å¸¸éƒ½æ˜¯åœ¨è¿è¡Œæ—¶æ•è·å’ŒæŠ›å‡ºçš„ï¼Œè€Œåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œæ³›å‹ä¿¡æ¯å…¨éƒ½ä¼šè¢«æ“¦é™¤æ‰ï¼Œé‚£ä¹ˆï¼Œå‡è®¾ä¸Šé¢çš„ç¼–è¯‘å¯è¡Œï¼Œé‚£ä¹ˆï¼Œåœ¨çœ‹ä¸‹é¢çš„å®šä¹‰ï¼š 1234567try&#123;&#125; catch(Problem&lt;Integer&gt; e1) &#123;&#125; catch(Problem&lt;Number&gt; e2) &#123;&#125; ç±»å‹ä¿¡æ¯è¢«æ“¦é™¤åï¼Œé‚£ä¹ˆä¸¤ä¸ªåœ°æ–¹çš„catchéƒ½å˜ä¸ºåŸå§‹ç±»å‹Objectï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸¤ä¸ªåœ°æ–¹çš„catchå˜çš„ä¸€æ¨¡ä¸€æ ·,å°±ç›¸å½“äºä¸‹é¢çš„è¿™æ · 1234567try&#123;&#125; catch(Problem&lt;Object&gt; e1) &#123;&#125; catch(Problem&lt;Object&gt; e2) &#123;&#125; è¿™ä¸ªå½“ç„¶å°±æ˜¯ä¸è¡Œçš„ã€‚ ä¸èƒ½å†catchå­å¥ä¸­ä½¿ç”¨æ³›å‹å˜é‡ 1234567public static &lt;T extends Throwable&gt; void doWork(Class&lt;T&gt; t) &#123; try &#123; ... &#125; catch(T e) &#123; //ç¼–è¯‘é”™è¯¯ ... &#125;&#125; å› ä¸ºæ³›å‹ä¿¡æ¯åœ¨ç¼–è¯‘çš„æ—¶å€™å·²ç»å˜ä¸ºåŸå§‹ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„Tä¼šå˜ä¸ºåŸå§‹ç±»å‹Throwableï¼Œé‚£ä¹ˆå¦‚æœå¯ä»¥å†catchå­å¥ä¸­ä½¿ç”¨æ³›å‹å˜é‡ï¼Œé‚£ä¹ˆï¼Œä¸‹é¢çš„å®šä¹‰å‘¢ï¼š 123456789public static &lt;T extends Throwable&gt; void doWork(Class&lt;T&gt; t)&#123; try &#123; &#125; catch(T e) &#123; //ç¼–è¯‘é”™è¯¯ &#125; catch(IndexOutOfBounds e) &#123; &#125; &#125; æ ¹æ®å¼‚å¸¸æ•è·çš„åŸåˆ™ï¼Œä¸€å®šæ˜¯å­ç±»åœ¨å‰é¢ï¼Œçˆ¶ç±»åœ¨åé¢ï¼Œé‚£ä¹ˆä¸Šé¢å°±è¿èƒŒäº†è¿™ä¸ªåŸåˆ™ã€‚å³ä½¿ä½ åœ¨ä½¿ç”¨è¯¥é™æ€æ–¹æ³•çš„ä½¿ç”¨Tæ˜¯ArrayIndexOutofBoundsï¼Œåœ¨ç¼–è¯‘ä¹‹åè¿˜æ˜¯ä¼šå˜æˆThrowableï¼ŒArrayIndexOutofBoundsæ˜¯IndexOutofBoundsçš„å­ç±»ï¼Œè¿èƒŒäº†å¼‚å¸¸æ•è·çš„åŸåˆ™ã€‚æ‰€ä»¥javaä¸ºäº†é¿å…è¿™æ ·çš„æƒ…å†µï¼Œç¦æ­¢åœ¨catchå­å¥ä¸­ä½¿ç”¨æ³›å‹å˜é‡ã€‚ ä½†æ˜¯åœ¨å¼‚å¸¸å£°æ˜ä¸­å¯ä»¥ä½¿ç”¨ç±»å‹å˜é‡ã€‚ä¸‹é¢æ–¹æ³•æ˜¯åˆæ³•çš„ã€‚ 12345678public static&lt;T extends Throwable&gt; void doWork(T t) throws T &#123; try&#123; ... &#125; catch(Throwable realCause) &#123; t.initCause(realCause); throw t; &#125;&#125; ä¸Šé¢çš„è¿™æ ·ä½¿ç”¨æ˜¯æ²¡é—®é¢˜çš„ã€‚ å¦‚ä½•è·å–æ³›å‹çš„å‚æ•°ç±»å‹ï¼Ÿ æ—¢ç„¶ç±»å‹è¢«æ“¦é™¤äº†ï¼Œé‚£ä¹ˆå¦‚ä½•è·å–æ³›å‹çš„å‚æ•°ç±»å‹å‘¢ï¼Ÿå¯ä»¥é€šè¿‡åå°„ï¼ˆjava.lang.reflect.Typeï¼‰è·å–æ³›å‹ java.lang.reflect.Typeæ˜¯Javaä¸­æ‰€æœ‰ç±»å‹çš„å…¬å…±é«˜çº§æ¥å£, ä»£è¡¨äº†Javaä¸­çš„æ‰€æœ‰ç±»å‹. Typeä½“ç³»ä¸­ç±»å‹çš„åŒ…æ‹¬ï¼šæ•°ç»„ç±»å‹(GenericArrayType)ã€å‚æ•°åŒ–ç±»å‹(ParameterizedType)ã€ç±»å‹å˜é‡(TypeVariable)ã€é€šé…ç¬¦ç±»å‹(WildcardType)ã€åŸå§‹ç±»å‹(Class)ã€åŸºæœ¬ç±»å‹(Class), ä»¥ä¸Šè¿™äº›ç±»å‹éƒ½å®ç°Typeæ¥å£ã€‚ 12345678910111213141516171819public class GenericType&lt;T&gt; &#123; private T data; public T getData() &#123; return data; &#125; public void setData(T data) &#123; this.data = data; &#125; public static void main(String[] args) &#123; GenericType&lt;String&gt; genericType = new GenericType&lt;String&gt;() &#123;&#125;; Type superclass = genericType.getClass().getGenericSuperclass(); //getActualTypeArguments è¿”å›ç¡®åˆ‡çš„æ³›å‹å‚æ•°, å¦‚Map&lt;String, Integer&gt;è¿”å›[String, Integer] Type type = ((ParameterizedType) superclass).getActualTypeArguments()[0]; System.out.println(type);//class java.lang.String &#125;&#125; å…¶ä¸­ ParameterizedType: 12345678910public interface ParameterizedType extends Type &#123; // è¿”å›ç¡®åˆ‡çš„æ³›å‹å‚æ•°, å¦‚Map&lt;String, Integer&gt;è¿”å›[String, Integer] Type[] getActualTypeArguments(); //è¿”å›å½“å‰classæˆ–interfaceå£°æ˜çš„ç±»å‹, å¦‚List&lt;?&gt;è¿”å›List Type getRawType(); //è¿”å›æ‰€å±ç±»å‹. å¦‚,å½“å‰ç±»å‹ä¸ºO&lt;T&gt;.I&lt;S&gt;, åˆ™è¿”å›O&lt;T&gt;. é¡¶çº§ç±»å‹å°†è¿”å›null Type getOwnerType();&#125; å‚è€ƒæ–‡ç«  æ³›å‹ä½œä¸ºJavaåŸºç¡€çŸ¥è¯†ç‚¹ä¹‹ä¸€ï¼Œç½‘ä¸ŠçŸ¥è¯†ç‚¹æ¯”è¾ƒå¤šä¹Ÿæ¯”è¾ƒæ•£ï¼Œæœ¬æ–‡ä¸»è¦ç»¼åˆäº†ç½‘ç»œä¸Šæ¯”è¾ƒå¥½çš„æ–‡ç« ï¼Œæ–¹ä¾¿ä½ å¿«é€Ÿå­¦ä¹ ã€‚ï¼ˆä»¥ä¸‹æ˜¯ä¸€éƒ¨åˆ†æˆ‘å‚è€ƒçš„é“¾æ¥ï¼‰ https://blog.csdn.net/sunxianghuang/article/details/51982979 https://blog.csdn.net/LonelyRoamer/article/details/7868820 https://docs.oracle.com/javase/tutorial/extra/generics/index.html https://blog.csdn.net/s10461/article/details/53941091 https://www.cnblogs.com/iyangyuan/archive/2013/04/09/3011274.html https://www.cnblogs.com/rudy-laura/articles/3391013.html https://www.jianshu.com/p/986f732ed2f1 https://blog.csdn.net/u011240877/article/details/53545041","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"3.Java åŸºç¡€ - å›¾è°± & Q/A","path":"/2023/12/25/3.Java-åŸºç¡€-å›¾è°±-Q-A/","content":"æœ¬æ–‡ä¸»è¦å¯¹JavaåŸºç¡€çŸ¥è¯†ä½“ç³»å°ç»“ï¼ŒåŒæ—¶ç»“åˆä¸€äº›Q&amp;Aè¿›è¡Œç†è§£ã€‚ å‚è€ƒæ–‡æ¡£ Thinking in Java (Java ç¼–ç¨‹æ€æƒ³) Gitbookä¸­æ–‡æ–‡æ¡£ https://java.quanke.name/ Thinking in Java (Java ç¼–ç¨‹æ€æƒ³) Github https://github.com/quanke/think-in-java Thinking in Java (Java ç¼–ç¨‹æ€æƒ³) Gitbook2 https://www.gitbook.com/book/wizardforcel/thinking-in-java/details çŸ¥è¯†ä½“ç³» Q&amp;AJava ä¸­åº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ•°æ®ç±»å‹æ¥ä»£è¡¨ä»·æ ¼?å¦‚æœä¸æ˜¯ç‰¹åˆ«å…³å¿ƒå†…å­˜å’Œæ€§èƒ½çš„è¯ï¼Œä½¿ç”¨BigDecimalï¼Œå¦åˆ™ä½¿ç”¨é¢„å®šä¹‰ç²¾åº¦çš„ double ç±»å‹ã€‚ æ€ä¹ˆå°† byte è½¬æ¢ä¸º String?å¯ä»¥ä½¿ç”¨ String æ¥æ”¶ byte[] å‚æ•°çš„æ„é€ å™¨æ¥è¿›è¡Œè½¬æ¢ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯è¦ä½¿ç”¨çš„æ­£ç¡®çš„ç¼–ç ï¼Œå¦åˆ™ä¼šä½¿ç”¨å¹³å°é»˜è®¤ç¼–ç ï¼Œè¿™ä¸ªç¼–ç å¯èƒ½è·ŸåŸæ¥çš„ç¼–ç ç›¸åŒï¼Œä¹Ÿå¯èƒ½ä¸åŒã€‚ Java ä¸­æ€æ ·å°† bytes è½¬æ¢ä¸º long ç±»å‹?Stringæ¥æ”¶bytesçš„æ„é€ å™¨è½¬æˆStringï¼Œå†Long.parseLong() æˆ‘ä»¬èƒ½å°† int å¼ºåˆ¶è½¬æ¢ä¸º byte ç±»å‹çš„å˜é‡å—? å¦‚æœè¯¥å€¼å¤§äº byte ç±»å‹çš„èŒƒå›´ï¼Œå°†ä¼šå‡ºç°ä»€ä¹ˆç°è±¡?æ˜¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥åšå¼ºåˆ¶è½¬æ¢ï¼Œä½†æ˜¯ Java ä¸­ int æ˜¯ 32 ä½çš„ï¼Œè€Œ byte æ˜¯ 8 ä½çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æœå¼ºåˆ¶è½¬åŒ–æ˜¯ï¼Œint ç±»å‹çš„é«˜ 24 ä½å°†ä¼šè¢«ä¸¢å¼ƒï¼Œbyte ç±»å‹çš„èŒƒå›´æ˜¯ä» -128 åˆ° 127ã€‚ å­˜åœ¨ä¸¤ä¸ªç±»ï¼ŒB ç»§æ‰¿ Aï¼ŒC ç»§æ‰¿ Bï¼Œæˆ‘ä»¬èƒ½å°† B è½¬æ¢ä¸º C ä¹ˆ? å¦‚ C &#x3D; (C) Bï¼›å¯ä»¥ï¼Œå‘ä¸‹è½¬å‹ã€‚ä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨ï¼Œå®¹æ˜“å‡ºç°ç±»å‹è½¬å‹å¼‚å¸¸. å“ªä¸ªç±»åŒ…å« clone æ–¹æ³•? æ˜¯ Cloneable è¿˜æ˜¯ Object?java.lang.Cloneable æ˜¯ä¸€ä¸ªæ ‡ç¤ºæ€§æ¥å£ï¼Œä¸åŒ…å«ä»»ä½•æ–¹æ³•ï¼Œclone æ–¹æ³•åœ¨ object ç±»ä¸­å®šä¹‰ã€‚å¹¶ä¸”éœ€è¦çŸ¥é“ clone() æ–¹æ³•æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯ç”± c æˆ– c++ æˆ– å…¶ä»–æœ¬åœ°è¯­è¨€å®ç°çš„ã€‚ Java ä¸­ ++ æ“ä½œç¬¦æ˜¯çº¿ç¨‹å®‰å…¨çš„å—?ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„æ“ä½œã€‚å®ƒæ¶‰åŠåˆ°å¤šä¸ªæŒ‡ä»¤ï¼Œå¦‚è¯»å–å˜é‡å€¼ï¼Œå¢åŠ ï¼Œç„¶åå­˜å‚¨å›å†…å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹äº¤å·®ã€‚è¿˜ä¼šå­˜åœ¨ç«æ€æ¡ä»¶(è¯»å–-ä¿®æ”¹-å†™å…¥)ã€‚ a &#x3D; a + b ä¸ a +&#x3D; b çš„åŒºåˆ«+= éšå¼çš„å°†åŠ æ“ä½œçš„ç»“æœç±»å‹å¼ºåˆ¶è½¬æ¢ä¸ºæŒæœ‰ç»“æœçš„ç±»å‹ã€‚å¦‚æœä¸¤ä¸ªæ•´å‹ç›¸åŠ ï¼Œå¦‚ byteã€short æˆ–è€… intï¼Œé¦–å…ˆä¼šå°†å®ƒä»¬æå‡åˆ° int ç±»å‹ï¼Œç„¶ååœ¨æ‰§è¡ŒåŠ æ³•æ“ä½œã€‚ 1234byte a = 127;byte b = 127;b = a + b; // error : cannot convert from int to byteb += a; // ok (å› ä¸º a+b æ“ä½œä¼šå°† aã€b æå‡ä¸º int ç±»å‹ï¼Œæ‰€ä»¥å°† int ç±»å‹èµ‹å€¼ç»™ byte å°±ä¼šç¼–è¯‘å‡ºé”™) æˆ‘èƒ½åœ¨ä¸è¿›è¡Œå¼ºåˆ¶è½¬æ¢çš„æƒ…å†µä¸‹å°†ä¸€ä¸ª double å€¼èµ‹å€¼ç»™ long ç±»å‹çš„å˜é‡å—?ä¸è¡Œï¼Œä½ ä¸èƒ½åœ¨æ²¡æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢çš„å‰æä¸‹å°†ä¸€ä¸ª double å€¼èµ‹å€¼ç»™ long ç±»å‹çš„å˜é‡ï¼Œå› ä¸º double ç±»å‹çš„èŒƒå›´æ¯” long ç±»å‹æ›´å¹¿ï¼Œæ‰€ä»¥å¿…é¡»è¦è¿›è¡Œå¼ºåˆ¶è½¬æ¢ã€‚ 3*0.1 &#x3D;&#x3D; 0.3 å°†ä¼šè¿”å›ä»€ä¹ˆ? true è¿˜æ˜¯ false?falseï¼Œå› ä¸ºæœ‰äº›æµ®ç‚¹æ•°ä¸èƒ½å®Œå…¨ç²¾ç¡®çš„è¡¨ç¤ºå‡ºæ¥ã€‚ int å’Œ Integer å“ªä¸ªä¼šå ç”¨æ›´å¤šçš„å†…å­˜?Integer å¯¹è±¡ä¼šå ç”¨æ›´å¤šçš„å†…å­˜ã€‚Integer æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦å­˜å‚¨å¯¹è±¡çš„å…ƒæ•°æ®ã€‚ä½†æ˜¯ int æ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥å ç”¨çš„ç©ºé—´æ›´å°‘ã€‚ ä¸ºä»€ä¹ˆ Java ä¸­çš„ String æ˜¯ä¸å¯å˜çš„(Immutable)?Java ä¸­çš„ String ä¸å¯å˜æ˜¯å› ä¸º Java çš„è®¾è®¡è€…è®¤ä¸ºå­—ç¬¦ä¸²ä½¿ç”¨éå¸¸é¢‘ç¹ï¼Œå°†å­—ç¬¦ä¸²è®¾ç½®ä¸ºä¸å¯å˜å¯ä»¥å…è®¸å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´å…±äº«ç›¸åŒçš„å­—ç¬¦ä¸²ã€‚æ›´è¯¦ç»†çš„å†…å®¹å‚è§ç­”æ¡ˆã€‚ æˆ‘ä»¬èƒ½åœ¨ Switch ä¸­ä½¿ç”¨ String å—?ä» Java 7 å¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ switch case ä¸­ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œä½†è¿™ä»…ä»…æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ã€‚å†…éƒ¨å®ç°åœ¨ switch ä¸­ä½¿ç”¨å­—ç¬¦ä¸²çš„ hash codeã€‚ Java ä¸­çš„æ„é€ å™¨é“¾æ˜¯ä»€ä¹ˆ?å½“ä½ ä»ä¸€ä¸ªæ„é€ å™¨ä¸­è°ƒç”¨å¦ä¸€ä¸ªæ„é€ å™¨ï¼Œå°±æ˜¯Java ä¸­çš„æ„é€ å™¨é“¾ã€‚è¿™ç§æƒ…å†µåªåœ¨é‡è½½äº†ç±»çš„æ„é€ å™¨çš„æ—¶å€™æ‰ä¼šå‡ºç°ã€‚ æšä¸¾ç±»JDK1.5å‡ºç° æ¯ä¸ªæšä¸¾å€¼éƒ½éœ€è¦è°ƒç”¨ä¸€æ¬¡æ„é€ å‡½æ•° ä»€ä¹ˆæ˜¯ä¸å¯å˜å¯¹è±¡(immutable object)? Java ä¸­æ€ä¹ˆåˆ›å»ºä¸€ä¸ªä¸å¯å˜å¯¹è±¡?ä¸å¯å˜å¯¹è±¡æŒ‡å¯¹è±¡ä¸€æ—¦è¢«åˆ›å»ºï¼ŒçŠ¶æ€å°±ä¸èƒ½å†æ”¹å˜ã€‚ä»»ä½•ä¿®æ”¹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¦‚ Stringã€IntegeråŠå…¶å®ƒåŒ…è£…ç±»ã€‚ å¦‚ä½•åœ¨Javaä¸­å†™å‡ºImmutableçš„ç±»? è¦å†™å‡ºè¿™æ ·çš„ç±»ï¼Œéœ€è¦éµå¾ªä»¥ä¸‹å‡ ä¸ªåŸåˆ™: 1)immutableå¯¹è±¡çš„çŠ¶æ€åœ¨åˆ›å»ºä¹‹åå°±ä¸èƒ½å‘ç”Ÿæ”¹å˜ï¼Œä»»ä½•å¯¹å®ƒçš„æ”¹å˜éƒ½åº”è¯¥äº§ç”Ÿä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚ 2)Immutableç±»çš„æ‰€æœ‰çš„å±æ€§éƒ½åº”è¯¥æ˜¯finalçš„ã€‚ 3)å¯¹è±¡å¿…é¡»è¢«æ­£ç¡®çš„åˆ›å»ºï¼Œæ¯”å¦‚: å¯¹è±¡å¼•ç”¨åœ¨å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ä¸­ä¸èƒ½æ³„éœ²(leak)ã€‚ 4)å¯¹è±¡åº”è¯¥æ˜¯finalçš„ï¼Œä»¥æ­¤æ¥é™åˆ¶å­ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œä»¥é¿å…å­ç±»æ”¹å˜äº†çˆ¶ç±»çš„immutableç‰¹æ€§ã€‚ 5)å¦‚æœç±»ä¸­åŒ…å«mutableç±»å¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›ç»™å®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ä¸€ä¸ªæ‹·è´ï¼Œè€Œä¸æ˜¯è¯¥å¯¹è±¡æœ¬èº«(è¯¥æ¡å¯ä»¥å½’ä¸ºç¬¬ä¸€æ¡ä¸­çš„ä¸€ä¸ªç‰¹ä¾‹) æˆ‘ä»¬èƒ½åˆ›å»ºä¸€ä¸ªåŒ…å«å¯å˜å¯¹è±¡çš„ä¸å¯å˜å¯¹è±¡å—?æ˜¯çš„ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒ…å«å¯å˜å¯¹è±¡çš„ä¸å¯å˜å¯¹è±¡çš„ï¼Œä½ åªéœ€è¦è°¨æ…ä¸€ç‚¹ï¼Œä¸è¦å…±äº«å¯å˜å¯¹è±¡çš„å¼•ç”¨å°±å¯ä»¥äº†ï¼Œå¦‚æœéœ€è¦å˜åŒ–æ—¶ï¼Œå°±è¿”å›åŸå¯¹è±¡çš„ä¸€ä¸ªæ‹·è´ã€‚æœ€å¸¸è§çš„ä¾‹å­å°±æ˜¯å¯¹è±¡ä¸­åŒ…å«ä¸€ä¸ªæ—¥æœŸå¯¹è±¡çš„å¼•ç”¨ã€‚ æœ‰æ²¡æœ‰å¯èƒ½ä¸¤ä¸ªä¸ç›¸ç­‰çš„å¯¹è±¡æœ‰ç›¸åŒçš„ hashcode?æœ‰å¯èƒ½ï¼Œä¸¤ä¸ªä¸ç›¸ç­‰çš„å¯¹è±¡å¯èƒ½ä¼šæœ‰ç›¸åŒçš„ hashcode å€¼ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ hashmap ä¸­ä¼šæœ‰å†²çªã€‚ç›¸ç­‰ hashcode å€¼çš„è§„å®šåªæ˜¯è¯´å¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œå¿…é¡»æœ‰ç›¸åŒçš„hashcode å€¼ï¼Œä½†æ˜¯æ²¡æœ‰å…³äºä¸ç›¸ç­‰å¯¹è±¡çš„ä»»ä½•è§„å®šã€‚ ä¸¤ä¸ªç›¸åŒçš„å¯¹è±¡ä¼šæœ‰ä¸åŒçš„ hashcode å—?ä¸èƒ½ï¼Œæ ¹æ® hashcode çš„è§„å®šï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨ hashcode() ä¸­ä½¿ç”¨éšæœºæ•°å­—å—?ä¸è¡Œï¼Œå› ä¸ºå¯¹è±¡çš„ hashcode å€¼å¿…é¡»æ˜¯ç›¸åŒçš„ã€‚ Java ä¸­ï¼ŒComparator ä¸ Comparable æœ‰ä»€ä¹ˆä¸åŒ?Comparable æ¥å£ç”¨äºå®šä¹‰å¯¹è±¡çš„è‡ªç„¶é¡ºåºï¼Œè€Œ comparator é€šå¸¸ç”¨äºå®šä¹‰ç”¨æˆ·å®šåˆ¶çš„é¡ºåºã€‚Comparable æ€»æ˜¯åªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯å¯ä»¥æœ‰å¤šä¸ª comparator æ¥å®šä¹‰å¯¹è±¡çš„é¡ºåºã€‚ ä¸ºä»€ä¹ˆåœ¨é‡å†™ equals æ–¹æ³•çš„æ—¶å€™éœ€è¦é‡å†™ hashCode æ–¹æ³•?å› ä¸ºæœ‰å¼ºåˆ¶çš„è§„èŒƒæŒ‡å®šéœ€è¦åŒæ—¶é‡å†™ hashcode ä¸ equals æ˜¯æ–¹æ³•ï¼Œè®¸å¤šå®¹å™¨ç±»ï¼Œå¦‚ HashMapã€HashSet éƒ½ä¾èµ–äº hashcode ä¸ equals çš„è§„å®šã€‚ â€œa&#x3D;&#x3D;bâ€å’Œâ€a.equals(b)â€æœ‰ä»€ä¹ˆåŒºåˆ«?å¦‚æœ a å’Œ b éƒ½æ˜¯å¯¹è±¡ï¼Œåˆ™ a&#x3D;&#x3D;b æ˜¯æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œåªæœ‰å½“ a å’Œ b æŒ‡å‘çš„æ˜¯å †ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡æ‰ä¼šè¿”å› trueï¼Œè€Œ a.equals(b) æ˜¯è¿›è¡Œé€»è¾‘æ¯”è¾ƒï¼Œæ‰€ä»¥é€šå¸¸éœ€è¦é‡å†™è¯¥æ–¹æ³•æ¥æä¾›é€»è¾‘ä¸€è‡´æ€§çš„æ¯”è¾ƒã€‚ä¾‹å¦‚ï¼ŒString ç±»é‡å†™ equals() æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥ç”¨äºä¸¤ä¸ªä¸åŒå¯¹è±¡ï¼Œä½†æ˜¯åŒ…å«çš„å­—æ¯ç›¸åŒçš„æ¯”è¾ƒã€‚ a.hashCode() æœ‰ä»€ä¹ˆç”¨? ä¸ a.equals(b) æœ‰ä»€ä¹ˆå…³ç³»?ç®€ä»‹: hashCode() æ–¹æ³•æ˜¯ç›¸åº”å¯¹è±¡æ•´å‹çš„ hash å€¼ã€‚å®ƒå¸¸ç”¨äºåŸºäº hash çš„é›†åˆç±»ï¼Œå¦‚ Hashtableã€HashMapã€LinkedHashMapç­‰ç­‰ã€‚å®ƒä¸ equals() æ–¹æ³•å…³ç³»ç‰¹åˆ«ç´§å¯†ã€‚æ ¹æ® Java è§„èŒƒï¼Œä¸¤ä¸ªä½¿ç”¨ equals() æ–¹æ³•æ¥åˆ¤æ–­ç›¸ç­‰çš„å¯¹è±¡ï¼Œå¿…é¡»å…·æœ‰ç›¸åŒçš„ hashcodeã€‚ 1ã€hashcodeçš„ä½œç”¨ Listå’ŒSetï¼Œå¦‚ä½•ä¿è¯Setä¸é‡å¤å‘¢? é€šè¿‡è¿­ä»£ä½¿ç”¨equalsæ–¹æ³•æ¥åˆ¤æ–­ï¼Œæ•°æ®é‡å°è¿˜å¯ä»¥æ¥å—ï¼Œæ•°æ®é‡å¤§æ€ä¹ˆè§£å†³? å¼•å…¥hashcodeï¼Œå®é™…ä¸Šhashcodeæ‰®æ¼”çš„è§’è‰²å°±æ˜¯å¯»å€ï¼Œå¤§å¤§å‡å°‘æŸ¥è¯¢åŒ¹é…æ¬¡æ•°ã€‚ 2ã€hashcodeé‡è¦å— å¯¹äºæ•°ç»„ã€Listé›†åˆå°±æ˜¯ä¸€ä¸ªç´¯èµ˜ã€‚è€Œå¯¹äºhashmap, hashset, hashtableå°±å¼‚å¸¸é‡è¦äº†ã€‚ 3ã€equalsæ–¹æ³•éµå¾ªçš„åŸåˆ™ å¯¹ç§°æ€§ è‹¥x.equals(y)ä¸ºtrueï¼Œåˆ™y.equals(x)ä¸ºtrue è‡ªåæ€§ x.equals(x)å¿…é¡»true ä¼ é€’æ€§ è‹¥x.equals(y)ä¸ºtrue,y.equals(z)ä¸ºtrue,åˆ™x.equals(z)å¿…ä¸ºtrue ä¸€è‡´æ€§ åªè¦x,yå†…å®¹ä¸å˜ï¼Œæ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ç»“æœä¸å˜ å…¶ä»– x.equals(null) æ°¸è¿œfalseï¼Œx.equals(å’Œxæ•°æ®ç±»å‹ä¸åŒ)å§‹ç»ˆfalse finalã€finalize å’Œ finally çš„ä¸åŒä¹‹å¤„? final æ˜¯ä¸€ä¸ªä¿®é¥°ç¬¦ï¼Œå¯ä»¥ä¿®é¥°å˜é‡ã€æ–¹æ³•å’Œç±»ã€‚å¦‚æœ final ä¿®é¥°å˜é‡ï¼Œæ„å‘³ç€è¯¥å˜é‡çš„å€¼åœ¨åˆå§‹åŒ–åä¸èƒ½è¢«æ”¹å˜ã€‚ Java æŠ€æœ¯å…è®¸ä½¿ç”¨ finalize() æ–¹æ³•åœ¨åƒåœ¾æ”¶é›†å™¨å°†å¯¹è±¡ä»å†…å­˜ä¸­æ¸…é™¤å‡ºå»ä¹‹å‰åšå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ç”±åƒåœ¾æ”¶é›†å™¨åœ¨ç¡®å®šè¿™ä¸ªå¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨æ—¶å¯¹è¿™ä¸ªå¯¹è±¡è°ƒç”¨çš„ï¼Œä½†æ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨ finalize æ²¡æœ‰ä¿è¯ã€‚ finally æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œä¸ try å’Œ catch ä¸€èµ·ç”¨äºå¼‚å¸¸çš„å¤„ç†ã€‚finally å—ä¸€å®šä¼šè¢«æ‰§è¡Œï¼Œæ— è®ºåœ¨ try å—ä¸­æ˜¯å¦æœ‰å‘ç”Ÿå¼‚å¸¸ã€‚ Java ä¸­çš„ç¼–è¯‘æœŸå¸¸é‡æ˜¯ä»€ä¹ˆ? ä½¿ç”¨å®ƒåˆä»€ä¹ˆé£é™©?å˜é‡ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç¼–è¯‘æœŸå¸¸é‡ï¼Œè¿™é‡Œçš„ public å¯é€‰çš„ã€‚å®é™…ä¸Šè¿™äº›å˜é‡åœ¨ç¼–è¯‘æ—¶ä¼šè¢«æ›¿æ¢æ‰ï¼Œå› ä¸ºç¼–è¯‘å™¨çŸ¥é“è¿™äº›å˜é‡çš„å€¼ï¼Œå¹¶ä¸”çŸ¥é“è¿™äº›å˜é‡åœ¨è¿è¡Œæ—¶ä¸èƒ½æ”¹å˜ã€‚è¿™ç§æ–¹å¼å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ä½ ä½¿ç”¨äº†ä¸€ä¸ªå†…éƒ¨çš„æˆ–ç¬¬ä¸‰æ–¹åº“ä¸­çš„å…¬æœ‰ç¼–è¯‘æ—¶å¸¸é‡ï¼Œä½†æ˜¯è¿™ä¸ªå€¼åé¢è¢«å…¶ä»–äººæ”¹å˜äº†ï¼Œä½†æ˜¯ä½ çš„å®¢æˆ·ç«¯ä»ç„¶åœ¨ä½¿ç”¨è€çš„å€¼ï¼Œç”šè‡³ä½ å·²ç»éƒ¨ç½²äº†ä¸€ä¸ªæ–°çš„jarã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå½“ä½ åœ¨æ›´æ–°ä¾èµ– JAR æ–‡ä»¶æ—¶ï¼Œç¡®ä¿é‡æ–°ç¼–è¯‘ä½ çš„ç¨‹åºã€‚ é™æ€å†…éƒ¨ç±»ä¸é¡¶çº§ç±»æœ‰ä»€ä¹ˆåŒºåˆ«?ä¸€ä¸ªå…¬å…±çš„é¡¶çº§ç±»çš„æºæ–‡ä»¶åç§°ä¸ç±»åç›¸åŒï¼Œè€ŒåµŒå¥—é™æ€ç±»æ²¡æœ‰è¿™ä¸ªè¦æ±‚ã€‚ä¸€ä¸ªåµŒå¥—ç±»ä½äºé¡¶çº§ç±»å†…éƒ¨ï¼Œéœ€è¦ä½¿ç”¨é¡¶çº§ç±»çš„åç§°æ¥å¼•ç”¨åµŒå¥—é™æ€ç±»ï¼Œå¦‚ HashMap.Entry æ˜¯ä¸€ä¸ªåµŒå¥—é™æ€ç±»ï¼ŒHashMap æ˜¯ä¸€ä¸ªé¡¶çº§ç±»ï¼ŒEntryæ˜¯ä¸€ä¸ªåµŒå¥—é™æ€ç±»ã€‚ Java ä¸­ï¼ŒSerializable ä¸ Externalizable çš„åŒºåˆ«?Serializable æ¥å£æ˜¯ä¸€ä¸ªåºåˆ—åŒ– Java ç±»çš„æ¥å£ï¼Œä»¥ä¾¿äºå®ƒä»¬å¯ä»¥åœ¨ç½‘ç»œä¸Šä¼ è¾“æˆ–è€…å¯ä»¥å°†å®ƒä»¬çš„çŠ¶æ€ä¿å­˜åœ¨ç£ç›˜ä¸Šï¼Œæ˜¯ JVM å†…åµŒçš„é»˜è®¤åºåˆ—åŒ–æ–¹å¼ï¼Œæˆæœ¬é«˜ã€è„†å¼±è€Œä¸”ä¸å®‰å…¨ã€‚Externalizable å…è®¸ä½ æ§åˆ¶æ•´ä¸ªåºåˆ—åŒ–è¿‡ç¨‹ï¼ŒæŒ‡å®šç‰¹å®šçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¢åŠ å®‰å…¨æœºåˆ¶ã€‚ è¯´å‡º JDK 1.7 ä¸­çš„ä¸‰ä¸ªæ–°ç‰¹æ€§?è™½ç„¶ JDK 1.7 ä¸åƒ JDK 5 å’Œ 8 ä¸€æ ·çš„å¤§ç‰ˆæœ¬ï¼Œä½†æ˜¯ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šæ–°çš„ç‰¹æ€§ï¼Œå¦‚ try-with-resource è¯­å¥ï¼Œè¿™æ ·ä½ åœ¨ä½¿ç”¨æµæˆ–è€…èµ„æºçš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦æ‰‹åŠ¨å…³é—­ï¼ŒJava ä¼šè‡ªåŠ¨å…³é—­ã€‚Fork-Join æ± æŸç§ç¨‹åº¦ä¸Šå®ç° Java ç‰ˆçš„ Map-reduceã€‚å…è®¸ Switch ä¸­æœ‰ String å˜é‡å’Œæ–‡æœ¬ã€‚è±å½¢æ“ä½œç¬¦(&lt;&gt;)ç”¨äºæ³›å‹æ¨æ–­ï¼Œä¸å†éœ€è¦åœ¨å˜é‡å£°æ˜çš„å³è¾¹ç”³æ˜æ³›å‹ï¼Œå› æ­¤å¯ä»¥å†™å‡ºå¯è¯»å†™æ›´å¼ºã€æ›´ç®€æ´çš„ä»£ç ã€‚å¦ä¸€ä¸ªå€¼å¾—ä¸€æçš„ç‰¹æ€§æ˜¯æ”¹å–„å¼‚å¸¸å¤„ç†ï¼Œå¦‚å…è®¸åœ¨åŒä¸€ä¸ª catch å—ä¸­æ•è·å¤šä¸ªå¼‚å¸¸ã€‚ è¯´å‡º 5 ä¸ª JDK 1.8 å¼•å…¥çš„æ–°ç‰¹æ€§?Java 8 åœ¨ Java å†å²ä¸Šæ˜¯ä¸€ä¸ªå¼€åˆ›æ–°çš„ç‰ˆæœ¬ï¼Œä¸‹é¢ JDK 8 ä¸­ 5 ä¸ªä¸»è¦çš„ç‰¹æ€§: Lambda è¡¨è¾¾å¼ï¼Œå…è®¸åƒå¯¹è±¡ä¸€æ ·ä¼ é€’åŒ¿åå‡½æ•° Stream APIï¼Œå……åˆ†åˆ©ç”¨ç°ä»£å¤šæ ¸ CPUï¼Œå¯ä»¥å†™å‡ºå¾ˆç®€æ´çš„ä»£ç  Date ä¸ Time APIï¼Œæœ€ç»ˆï¼Œæœ‰ä¸€ä¸ªç¨³å®šã€ç®€å•çš„æ—¥æœŸå’Œæ—¶é—´åº“å¯ä¾›ä½ ä½¿ç”¨ æ‰©å±•æ–¹æ³•ï¼Œç°åœ¨ï¼Œæ¥å£ä¸­å¯ä»¥æœ‰é™æ€ã€é»˜è®¤æ–¹æ³•ã€‚ é‡å¤æ³¨è§£ï¼Œç°åœ¨ä½ å¯ä»¥å°†ç›¸åŒçš„æ³¨è§£åœ¨åŒä¸€ç±»å‹ä¸Šä½¿ç”¨å¤šæ¬¡ã€‚ ä¸‹è¿°åŒ…å« Java é¢è¯•è¿‡ç¨‹ä¸­å…³äº SOLID çš„è®¾è®¡åŸåˆ™ï¼ŒOOP åŸºç¡€ï¼Œå¦‚ç±»ï¼Œå¯¹è±¡ï¼Œæ¥å£ï¼Œç»§æ‰¿ï¼Œå¤šæ€ï¼Œå°è£…ï¼ŒæŠ½è±¡ä»¥åŠæ›´é«˜çº§çš„ä¸€äº›æ¦‚å¿µï¼Œå¦‚ç»„åˆã€èšåˆåŠå…³è”ã€‚ä¹ŸåŒ…å«äº† GOF è®¾è®¡æ¨¡å¼çš„é—®é¢˜ã€‚ æ¥å£æ˜¯ä»€ä¹ˆ? ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ¥å£è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨å…·ä½“ç±»?æ¥å£ç”¨äºå®šä¹‰ APIã€‚å®ƒå®šä¹‰äº†ç±»å¿…é¡»å¾—éµå¾ªçš„è§„åˆ™ã€‚åŒæ—¶ï¼Œå®ƒæä¾›äº†ä¸€ç§æŠ½è±¡ï¼Œå› ä¸ºå®¢æˆ·ç«¯åªä½¿ç”¨æ¥å£ï¼Œè¿™æ ·å¯ä»¥æœ‰å¤šé‡å®ç°ï¼Œå¦‚ List æ¥å£ï¼Œä½ å¯ä»¥ä½¿ç”¨å¯éšæœºè®¿é—®çš„ ArrayListï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–¹ä¾¿æ’å…¥å’Œåˆ é™¤çš„ LinkedListã€‚æ¥å£ä¸­ä¸å…è®¸æ™®é€šæ–¹æ³•ï¼Œä»¥æ­¤æ¥ä¿è¯æŠ½è±¡ï¼Œä½†æ˜¯ Java 8 ä¸­ä½ å¯ä»¥åœ¨æ¥å£å£°æ˜é™æ€æ–¹æ³•å’Œé»˜è®¤æ™®é€šæ–¹æ³•ã€‚ Java ä¸­ï¼ŒæŠ½è±¡ç±»ä¸æ¥å£ä¹‹é—´æœ‰ä»€ä¹ˆä¸åŒ?Java ä¸­ï¼ŒæŠ½è±¡ç±»å’Œæ¥å£æœ‰å¾ˆå¤šä¸åŒä¹‹å¤„ï¼Œä½†æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªæ˜¯ Java ä¸­é™åˆ¶ä¸€ä¸ªç±»åªèƒ½ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œä½†æ˜¯å¯ä»¥å®ç°å¤šä¸ªæ¥å£ã€‚æŠ½è±¡ç±»å¯ä»¥å¾ˆå¥½çš„å®šä¹‰ä¸€ä¸ªå®¶æ—ç±»çš„é»˜è®¤è¡Œä¸ºï¼Œè€Œæ¥å£èƒ½æ›´å¥½çš„å®šä¹‰ç±»å‹ï¼Œæœ‰åŠ©äºåé¢å®ç°å¤šæ€æœºåˆ¶ å‚è§ç¬¬å…­æ¡ã€‚ Objectæœ‰å“ªäº›å…¬ç”¨æ–¹æ³•?clone equals hashcode wait notify notifyall finalize toString getClass é™¤äº†cloneå’Œfinalizeå…¶ä»–å‡ä¸ºå…¬å…±æ–¹æ³•ã€‚ 11ä¸ªæ–¹æ³•ï¼Œwaitè¢«é‡è½½äº†ä¸¤æ¬¡ equalsä¸&#x3D;&#x3D;çš„åŒºåˆ«åŒºåˆ«1. ==æ˜¯ä¸€ä¸ªè¿ç®—ç¬¦ equalsæ˜¯Objectç±»çš„æ–¹æ³• åŒºåˆ«2. æ¯”è¾ƒæ—¶çš„åŒºåˆ« ç”¨äºåŸºæœ¬ç±»å‹çš„å˜é‡æ¯”è¾ƒæ—¶: ==ç”¨äºæ¯”è¾ƒå€¼æ˜¯å¦ç›¸ç­‰ï¼Œequalsä¸èƒ½ç›´æ¥ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹çš„æ¯”è¾ƒï¼Œéœ€è¦è½¬æ¢ä¸ºå…¶å¯¹åº”çš„åŒ…è£…ç±»å‹ã€‚ ç”¨äºå¼•ç”¨ç±»å‹çš„æ¯”è¾ƒæ—¶ã€‚==å’Œequalséƒ½æ˜¯æ¯”è¾ƒæ ˆå†…å­˜ä¸­çš„åœ°å€æ˜¯å¦ç›¸ç­‰ ã€‚ç›¸ç­‰ä¸ºtrue å¦åˆ™ä¸ºfalseã€‚ä½†æ˜¯é€šå¸¸ä¼šé‡å†™equalsæ–¹æ³•å»å®ç°å¯¹è±¡å†…å®¹çš„æ¯”è¾ƒã€‚ Stringã€StringBufferä¸StringBuilderçš„åŒºåˆ«ç¬¬ä¸€ç‚¹: å¯å˜å’Œé€‚ç”¨èŒƒå›´ã€‚Stringå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œè€ŒStringBufferå’ŒStringBuilderæ˜¯å¯å˜å­—ç¬¦åºåˆ—ã€‚æ¯æ¬¡å¯¹Stringçš„æ“ä½œç›¸å½“äºç”Ÿæˆä¸€ä¸ªæ–°çš„Stringå¯¹è±¡ï¼Œè€Œå¯¹StringBufferå’ŒStringBuilderçš„æ“ä½œæ˜¯å¯¹å¯¹è±¡æœ¬èº«çš„æ“ä½œï¼Œè€Œä¸ä¼šç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹äºé¢‘ç¹æ”¹å˜å†…å®¹çš„å­—ç¬¦ä¸²é¿å…ä½¿ç”¨Stringï¼Œå› ä¸ºé¢‘ç¹çš„ç”Ÿæˆå¯¹è±¡å°†ä¼šå¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿå½±å“ã€‚ ç¬¬äºŒç‚¹: çº¿ç¨‹å®‰å…¨ã€‚Stringç”±äºæœ‰finalä¿®é¥°ï¼Œæ˜¯immutableçš„ï¼Œå®‰å…¨æ€§æ˜¯ç®€å•è€Œçº¯ç²¹çš„ã€‚StringBuilderå’ŒStringBufferçš„åŒºåˆ«åœ¨äºStringBuilderä¸ä¿è¯åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœéœ€è¦çº¿ç¨‹å®‰å…¨éœ€è¦ä½¿ç”¨StringBufferï¼Œä¸éœ€è¦åŒæ­¥çš„StringBuilderæ•ˆç‡æ›´é«˜ã€‚ switchèƒ½å¦ç”¨Stringåšå‚æ•°Java1.7å¼€å§‹æ”¯æŒï¼Œä½†å®é™…è¿™æ˜¯ä¸€é¢—Javaè¯­æ³•ç³–ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œbyteï¼Œshortï¼Œintï¼Œæšä¸¾å‡å¯ç”¨äºswitchï¼Œè€Œbooleanå’Œæµ®ç‚¹å‹ä¸å¯ä»¥ã€‚ æ¥å£ä¸æŠ½è±¡ç±» ä¸€ä¸ªå­ç±»åªèƒ½ç»§æ‰¿ä¸€ä¸ªæŠ½è±¡ç±», ä½†èƒ½å®ç°å¤šä¸ªæ¥å£ æŠ½è±¡ç±»å¯ä»¥æœ‰æ„é€ æ–¹æ³•, æ¥å£æ²¡æœ‰æ„é€ æ–¹æ³• æŠ½è±¡ç±»å¯ä»¥æœ‰æ™®é€šæˆå‘˜å˜é‡, æ¥å£æ²¡æœ‰æ™®é€šæˆå‘˜å˜é‡ æŠ½è±¡ç±»å’Œæ¥å£éƒ½å¯æœ‰é™æ€æˆå‘˜å˜é‡, æŠ½è±¡ç±»ä¸­é™æ€æˆå‘˜å˜é‡è®¿é—®ç±»å‹ä»»æ„ï¼Œæ¥å£åªèƒ½public static final(é»˜è®¤) æŠ½è±¡ç±»å¯ä»¥æ²¡æœ‰æŠ½è±¡æ–¹æ³•, æŠ½è±¡ç±»å¯ä»¥æœ‰æ™®é€šæ–¹æ³•ï¼›æ¥å£åœ¨JDK8ä¹‹å‰éƒ½æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œåœ¨JDK8å¯ä»¥æœ‰defaultæ–¹æ³•ï¼Œåœ¨JDK9ä¸­å…è®¸æœ‰ç§æœ‰æ™®é€šæ–¹æ³• æŠ½è±¡ç±»å¯ä»¥æœ‰é™æ€æ–¹æ³•ï¼›æ¥å£åœ¨JDK8ä¹‹å‰ä¸èƒ½æœ‰é™æ€æ–¹æ³•ï¼Œåœ¨JDK8ä¸­å¯ä»¥æœ‰é™æ€æ–¹æ³•ï¼Œä¸”åªèƒ½è¢«æ¥å£ç±»ç›´æ¥è°ƒç”¨ï¼ˆä¸èƒ½è¢«å®ç°ç±»çš„å¯¹è±¡è°ƒç”¨ï¼‰ æŠ½è±¡ç±»ä¸­çš„æ–¹æ³•å¯ä»¥æ˜¯publicã€protected; æ¥å£æ–¹æ³•åœ¨JDK8ä¹‹å‰åªæœ‰public abstractï¼Œåœ¨JDK8å¯ä»¥æœ‰defaultæ–¹æ³•ï¼Œåœ¨JDK9ä¸­å…è®¸æœ‰privateæ–¹æ³• æŠ½è±¡ç±»å’Œæœ€ç»ˆç±»æŠ½è±¡ç±»å¯ä»¥æ²¡æœ‰æŠ½è±¡æ–¹æ³•, æœ€ç»ˆç±»å¯ä»¥æ²¡æœ‰æœ€ç»ˆæ–¹æ³• æœ€ç»ˆç±»ä¸èƒ½è¢«ç»§æ‰¿, æœ€ç»ˆæ–¹æ³•ä¸èƒ½è¢«é‡å†™(å¯ä»¥é‡è½½) å¼‚å¸¸ç›¸å…³çš„å…³é”®å­— throwã€throwsã€try...catchã€finally throws ç”¨åœ¨æ–¹æ³•ç­¾åä¸Š, ä»¥ä¾¿æŠ›å‡ºçš„å¼‚å¸¸å¯ä»¥è¢«è°ƒç”¨è€…å¤„ç† throw æ–¹æ³•å†…éƒ¨é€šè¿‡throwæŠ›å‡ºå¼‚å¸¸ try ç”¨äºæ£€æµ‹åŒ…ä½çš„è¯­å¥å—, è‹¥æœ‰å¼‚å¸¸, catchå­å¥æ•è·å¹¶æ‰§è¡Œcatchå— å…³äºfinally finallyä¸ç®¡æœ‰æ²¡æœ‰å¼‚å¸¸éƒ½è¦å¤„ç† å½“tryå’Œcatchä¸­æœ‰returnæ—¶ï¼Œfinallyä»ç„¶ä¼šæ‰§è¡Œï¼Œfinallyæ¯”returnå…ˆæ‰§è¡Œ ä¸ç®¡æœ‰æœ¨æœ‰å¼‚å¸¸æŠ›å‡º, finallyåœ¨returnè¿”å›å‰æ‰§è¡Œ finallyæ˜¯åœ¨returnåé¢çš„è¡¨è¾¾å¼è¿ç®—åæ‰§è¡Œçš„(æ­¤æ—¶å¹¶æ²¡æœ‰è¿”å›è¿ç®—åçš„å€¼ï¼Œè€Œæ˜¯å…ˆæŠŠè¦è¿”å›çš„å€¼ä¿å­˜èµ·æ¥ï¼Œç®¡finallyä¸­çš„ä»£ç æ€ä¹ˆæ ·ï¼Œè¿”å›çš„å€¼éƒ½ä¸ä¼šæ”¹å˜ï¼Œä»ç„¶æ˜¯ä¹‹å‰ä¿å­˜çš„å€¼)ï¼Œæ‰€ä»¥å‡½æ•°è¿”å›å€¼æ˜¯åœ¨finallyæ‰§è¡Œå‰ç¡®å®šçš„ æ³¨æ„: finallyä¸­æœ€å¥½ä¸è¦åŒ…å«returnï¼Œå¦åˆ™ç¨‹åºä¼šæå‰é€€å‡ºï¼Œè¿”å›å€¼ä¸æ˜¯tryæˆ–catchä¸­ä¿å­˜çš„è¿”å›å€¼ finallyä¸æ‰§è¡Œçš„å‡ ç§æƒ…å†µ: ç¨‹åºæå‰ç»ˆæ­¢å¦‚è°ƒç”¨äº†System.exit, ç—…æ¯’ï¼Œæ–­ç”µ å—æ£€æŸ¥å¼‚å¸¸å’Œè¿è¡Œæ—¶å¼‚å¸¸ å—æ£€æŸ¥çš„å¼‚å¸¸(checked exceptions),å…¶å¿…é¡»è¢«try...catchè¯­å¥å—æ‰€æ•è·, æˆ–è€…åœ¨æ–¹æ³•ç­¾åé‡Œé€šè¿‡throwså­å¥å£°æ˜ã€‚å—æ£€æŸ¥çš„å¼‚å¸¸å¿…é¡»åœ¨ç¼–è¯‘æ—¶è¢«æ•æ‰å¤„ç†,å‘½åä¸ºChecked Exceptionæ˜¯å› ä¸ºJavaç¼–è¯‘å™¨è¦è¿›è¡Œæ£€æŸ¥, Javaè™šæ‹Ÿæœºä¹Ÿè¦è¿›è¡Œæ£€æŸ¥, ä»¥ç¡®ä¿è¿™ä¸ªè§„åˆ™å¾—åˆ°éµå®ˆã€‚ å¸¸è§çš„checked exception: ClassNotFoundException IOException FileNotFoundException EOFException è¿è¡Œæ—¶å¼‚å¸¸(runtime exceptions), éœ€è¦ç¨‹åºå‘˜è‡ªå·±åˆ†æä»£ç å†³å®šæ˜¯å¦æ•è·å’Œå¤„ç†,æ¯”å¦‚ç©ºæŒ‡é’ˆ,è¢«0é™¤â€¦ å¸¸è§çš„runtime exception: NullPointerException ArithmeticException ClassCastException IllegalArgumentException IllegalStateException IndexOutOfBoundsException NoSuchElementException Errorçš„ï¼Œåˆ™å±äºä¸¥é‡é”™è¯¯ï¼Œå¦‚ç³»ç»Ÿå´©æºƒã€è™šæ‹Ÿæœºé”™è¯¯ã€åŠ¨æ€é“¾æ¥å¤±è´¥ç­‰ï¼Œè¿™äº›é”™è¯¯æ— æ³•æ¢å¤æˆ–è€…ä¸å¯èƒ½æ•æ‰ï¼Œå°†å¯¼è‡´åº”ç”¨ç¨‹åºä¸­æ–­ï¼ŒErrorä¸éœ€è¦æ•è·ã€‚ superå‡ºç°åœ¨çˆ¶ç±»çš„å­ç±»ä¸­ã€‚æœ‰ä¸‰ç§å­˜åœ¨æ–¹å¼ super.xxx(xxxä¸ºå˜é‡åæˆ–å¯¹è±¡å)æ„æ€æ˜¯è·å–çˆ¶ç±»ä¸­xxxçš„å˜é‡æˆ–å¼•ç”¨ super.xxx(); (xxxä¸ºæ–¹æ³•å)æ„æ€æ˜¯ç›´æ¥è®¿é—®å¹¶è°ƒç”¨çˆ¶ç±»ä¸­çš„æ–¹æ³• super() è°ƒç”¨çˆ¶ç±»æ„é€  æ³¨: superåªèƒ½æŒ‡ä»£å…¶ç›´æ¥çˆ¶ç±» this() &amp; super()åœ¨æ„é€ æ–¹æ³•ä¸­çš„åŒºåˆ« è°ƒç”¨super()å¿…é¡»å†™åœ¨å­ç±»æ„é€ æ–¹æ³•çš„ç¬¬ä¸€è¡Œ, å¦åˆ™ç¼–è¯‘ä¸é€šè¿‡ superä»å­ç±»è°ƒç”¨çˆ¶ç±»æ„é€ , thisåœ¨åŒä¸€ç±»ä¸­è°ƒç”¨å…¶ä»–æ„é€ å‡éœ€è¦æ”¾åœ¨ç¬¬ä¸€è¡Œ å°½ç®¡å¯ä»¥ç”¨thisè°ƒç”¨ä¸€ä¸ªæ„é€ å™¨, å´ä¸èƒ½è°ƒç”¨2ä¸ª thiså’Œsuperä¸èƒ½å‡ºç°åœ¨åŒä¸€ä¸ªæ„é€ å™¨ä¸­, å¦åˆ™ç¼–è¯‘ä¸é€šè¿‡ this()ã€super()éƒ½æŒ‡çš„å¯¹è±¡,ä¸å¯ä»¥åœ¨staticç¯å¢ƒä¸­ä½¿ç”¨ æœ¬è´¨thisæŒ‡å‘æœ¬å¯¹è±¡çš„æŒ‡é’ˆã€‚superæ˜¯ä¸€ä¸ªå…³é”®å­— æ„é€ å†…éƒ¨ç±»å’Œé™æ€å†…éƒ¨ç±»å¯¹è±¡12345678910111213public class Enclosingone &#123;\tpublic class Insideone &#123;&#125;\tpublic static class Insideone&#123;&#125;&#125;public class Test &#123;\tpublic static void main(String[] args) &#123;\t// æ„é€ å†…éƒ¨ç±»å¯¹è±¡éœ€è¦å¤–éƒ¨ç±»çš„å¼•ç”¨\tEnclosingone.Insideone obj1 = new Enclosingone().new Insideone();\t// æ„é€ é™æ€å†…éƒ¨ç±»çš„å¯¹è±¡\tEnclosingone.Insideone obj2 = new Enclosingone.Insideone();\t&#125;&#125; é™æ€å†…éƒ¨ç±»ä¸éœ€è¦æœ‰æŒ‡å‘å¤–éƒ¨ç±»çš„å¼•ç”¨ã€‚ä½†éé™æ€å†…éƒ¨ç±»éœ€è¦æŒæœ‰å¯¹å¤–éƒ¨ç±»çš„å¼•ç”¨ã€‚éé™æ€å†…éƒ¨ç±»èƒ½å¤Ÿè®¿é—®å¤–éƒ¨ç±»çš„é™æ€å’Œéé™æ€æˆå‘˜ã€‚é™æ€å†…éƒ¨ç±»ä¸èƒ½è®¿é—®å¤–éƒ¨ç±»çš„éé™æ€æˆå‘˜ï¼Œåªèƒ½è®¿é—®å¤–éƒ¨ç±»çš„é™æ€æˆå‘˜ã€‚ åºåˆ—åŒ–å£°æ˜ä¸ºstaticå’Œtransientç±»å‹çš„æ•°æ®ä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œ ååºåˆ—åŒ–éœ€è¦ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•° Javaç§»ä½è¿ç®—ç¬¦javaä¸­æœ‰ä¸‰ç§ç§»ä½è¿ç®—ç¬¦ &lt;&lt; :å·¦ç§»è¿ç®—ç¬¦,x &lt;&lt; 1,ç›¸å½“äºxä¹˜ä»¥2(ä¸æº¢å‡ºçš„æƒ…å†µä¸‹),ä½ä½è¡¥0 &gt;&gt; :å¸¦ç¬¦å·å³ç§»,x &gt;&gt; 1,ç›¸å½“äºxé™¤ä»¥2,æ­£æ•°é«˜ä½è¡¥0,è´Ÿæ•°é«˜ä½è¡¥1 &gt;&gt;&gt; :æ— ç¬¦å·å³ç§»,å¿½ç•¥ç¬¦å·ä½,ç©ºä½éƒ½ä»¥0è¡¥é½ å½¢å‚&amp;å®å‚å½¢å¼å‚æ•°å¯è¢«è§†ä¸ºlocal variable.å½¢å‚å’Œå±€éƒ¨å˜é‡ä¸€æ ·éƒ½ä¸èƒ½ç¦»å¼€æ–¹æ³•ã€‚åªæœ‰åœ¨æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œä¸ä¼šåœ¨æ–¹æ³•å¤–å¯è§ã€‚ å½¢å¼å‚æ•°åªèƒ½ç”¨finalä¿®é¥°ç¬¦ï¼Œå…¶å®ƒä»»ä½•ä¿®é¥°ç¬¦éƒ½ä¼šå¼•èµ·ç¼–è¯‘å™¨é”™è¯¯ã€‚ä½†æ˜¯ç”¨è¿™ä¸ªä¿®é¥°ç¬¦ä¹Ÿæœ‰ä¸€å®šçš„é™åˆ¶ï¼Œå°±æ˜¯åœ¨æ–¹æ³•ä¸­ä¸èƒ½å¯¹å‚æ•°åšä»»ä½•ä¿®æ”¹ã€‚ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ–¹æ³•çš„å½¢å‚ä¸ç”¨finalä¿®é¥°ã€‚åªæœ‰åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œé‚£å°±æ˜¯: æ–¹æ³•å†…éƒ¨ç±»ã€‚ä¸€ä¸ªæ–¹æ³•å†…çš„å†…éƒ¨ç±»å¦‚æœä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•çš„å‚æ•°æˆ–è€…å±€éƒ¨å˜é‡çš„è¯ï¼Œè¿™ä¸ªå‚æ•°æˆ–å±€éƒ¨å˜é‡åº”è¯¥æ˜¯finalã€‚ å½¢å‚çš„å€¼åœ¨è°ƒç”¨æ—¶æ ¹æ®è°ƒç”¨è€…æ›´æ”¹ï¼Œå®å‚åˆ™ç”¨è‡ªèº«çš„å€¼æ›´æ”¹å½¢å‚çš„å€¼(æŒ‡é’ˆã€å¼•ç”¨çš†åœ¨æ­¤åˆ—)ï¼Œä¹Ÿå°±æ˜¯è¯´çœŸæ­£è¢«ä¼ é€’çš„æ˜¯å®å‚ã€‚ å±€éƒ¨å˜é‡ä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–å±€éƒ¨å˜é‡æ˜¯æŒ‡ç±»æ–¹æ³•ä¸­çš„å˜é‡ï¼Œå¿…é¡»åˆå§‹åŒ–ã€‚å±€éƒ¨å˜é‡è¿è¡Œæ—¶è¢«åˆ†é…åœ¨æ ˆä¸­ï¼Œé‡å¤§ï¼Œç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œå¦‚æœè™šæ‹Ÿæœºç»™æ¯ä¸ªå±€éƒ¨å˜é‡éƒ½åˆå§‹åŒ–ä¸€ä¸‹ï¼Œæ˜¯ä¸€ç¬”å¾ˆå¤§çš„å¼€é”€ï¼Œä½†å˜é‡ä¸åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼å°±ä½¿ç”¨æ˜¯ä¸å®‰å…¨çš„ã€‚å‡ºäºé€Ÿåº¦å’Œå®‰å…¨æ€§ä¸¤ä¸ªæ–¹é¢çš„ç»¼åˆè€ƒè™‘ï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯è™šæ‹Ÿæœºä¸åˆå§‹åŒ–ï¼Œä½†è¦æ±‚ç¼–å†™è€…ä¸€å®šè¦åœ¨ä½¿ç”¨å‰ç»™å˜é‡èµ‹å€¼ã€‚ Javaè¯­è¨€çš„é²æ£’æ€§Javaåœ¨ç¼–è¯‘å’Œè¿è¡Œç¨‹åºæ—¶ï¼Œéƒ½è¦å¯¹å¯èƒ½å‡ºç°çš„é—®é¢˜è¿›è¡Œæ£€æŸ¥ï¼Œä»¥æ¶ˆé™¤é”™è¯¯çš„äº§ç”Ÿã€‚å®ƒæä¾›è‡ªåŠ¨åƒåœ¾æ”¶é›†æ¥è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œé˜²æ­¢ç¨‹åºå‘˜åœ¨ç®¡ç†å†…å­˜æ—¶å®¹æ˜“äº§ç”Ÿçš„é”™è¯¯ã€‚é€šè¿‡é›†æˆçš„é¢å‘å¯¹è±¡çš„ä¾‹å¤–å¤„ç†æœºåˆ¶ï¼Œåœ¨ç¼–è¯‘æ—¶ï¼ŒJavaæ­ç¤ºå‡ºå¯èƒ½å‡ºç°ä½†æœªè¢«å¤„ç†çš„å¼‚å¸¸ï¼Œå¸®åŠ©ç¨‹åºå‘˜æ­£ç¡®åœ°è¿›è¡Œé€‰æ‹©ä»¥é˜²æ­¢ç³»ç»Ÿçš„å´©æºƒã€‚å¦å¤–ï¼ŒJavaåœ¨ç¼–è¯‘æ—¶è¿˜å¯æ•è·ç±»å‹å£°æ˜ä¸­çš„è®¸å¤šå¸¸è§é”™è¯¯ï¼Œé˜²æ­¢åŠ¨æ€è¿è¡Œæ—¶ä¸åŒ¹é…é—®é¢˜çš„å‡ºç°ã€‚","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"2.Java åŸºç¡€ - çŸ¥è¯†ç‚¹","path":"/2023/12/25/2.Java-åŸºç¡€-çŸ¥è¯†ç‚¹/","content":"æœ¬æ–‡ä¸»è¦å¯¹JavaåŸºç¡€çŸ¥è¯†ç‚¹è¿›è¡Œæ€»ç»“ã€‚ æ•°æ®ç±»å‹åŒ…è£…ç±»å‹å…«ä¸ªåŸºæœ¬ç±»å‹: boolean&#x2F;1 byte&#x2F;8 char&#x2F;16 short&#x2F;16 int&#x2F;32 float&#x2F;32 long&#x2F;64 double&#x2F;64 åŸºæœ¬ç±»å‹éƒ½æœ‰å¯¹åº”çš„åŒ…è£…ç±»å‹ï¼ŒåŸºæœ¬ç±»å‹ä¸å…¶å¯¹åº”çš„åŒ…è£…ç±»å‹ä¹‹é—´çš„èµ‹å€¼ä½¿ç”¨è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±å®Œæˆã€‚ 12Integer x = 2; // è£…ç®±int y = x; // æ‹†ç®± ç¼“å­˜æ± new Integer(123) ä¸ Integer.valueOf(123) çš„åŒºåˆ«åœ¨äº: new Integer(123) æ¯æ¬¡éƒ½ä¼šæ–°å»ºä¸€ä¸ªå¯¹è±¡ Integer.valueOf(123) ä¼šä½¿ç”¨ç¼“å­˜æ± ä¸­çš„å¯¹è±¡ï¼Œå¤šæ¬¡è°ƒç”¨ä¼šå–å¾—åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚ 123456Integer x = new Integer(123);Integer y = new Integer(123);System.out.println(x == y); // falseInteger z = Integer.valueOf(123);Integer k = Integer.valueOf(123);System.out.println(z == k); // true valueOf() æ–¹æ³•çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å…ˆåˆ¤æ–­å€¼æ˜¯å¦åœ¨ç¼“å­˜æ± ä¸­ï¼Œå¦‚æœåœ¨çš„è¯å°±ç›´æ¥è¿”å›ç¼“å­˜æ± çš„å†…å®¹ã€‚ 12345public static Integer valueOf(int i) &#123; if (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high) return IntegerCache.cache[i + (-IntegerCache.low)]; return new Integer(i);&#125; åœ¨ Java 8 ä¸­ï¼ŒInteger ç¼“å­˜æ± çš„å¤§å°é»˜è®¤ä¸º -128~127ã€‚ 1234567891011121314151617181920212223242526272829static final int low = -128;static final int high;static final Integer cache[];static &#123; // high value may be configured by property int h = 127; String integerCacheHighPropValue = sun.misc.VM.getSavedProperty(&quot;java.lang.Integer.IntegerCache.high&quot;); if (integerCacheHighPropValue != null) &#123; try &#123; int i = parseInt(integerCacheHighPropValue); i = Math.max(i, 127); // Maximum array size is Integer.MAX_VALUE h = Math.min(i, Integer.MAX_VALUE - (-low) -1); &#125; catch( NumberFormatException nfe) &#123; // If the property cannot be parsed into an int, ignore it. &#125; &#125; high = h; cache = new Integer[(high - low) + 1]; int j = low; for(int k = 0; k &lt; cache.length; k++) cache[k] = new Integer(j++); // range [-128, 127] must be interned (JLS7 5.1.7) assert IntegerCache.high &gt;= 127;&#125; ç¼–è¯‘å™¨ä¼šåœ¨ç¼“å†²æ± èŒƒå›´å†…çš„åŸºæœ¬ç±»å‹è‡ªåŠ¨è£…ç®±è¿‡ç¨‹è°ƒç”¨ valueOf() æ–¹æ³•ï¼Œå› æ­¤å¤šä¸ª Integer å®ä¾‹ä½¿ç”¨è‡ªåŠ¨è£…ç®±æ¥åˆ›å»ºå¹¶ä¸”å€¼ç›¸åŒï¼Œé‚£ä¹ˆå°±ä¼šå¼•ç”¨ç›¸åŒçš„å¯¹è±¡ã€‚ 123Integer m = 123;Integer n = 123;System.out.println(m == n); // true åŸºæœ¬ç±»å‹å¯¹åº”çš„ç¼“å†²æ± å¦‚ä¸‹: boolean values true and false all byte values short values between -128 and 127 int values between -128 and 127 char in the range \\u0000 to \\u007F åœ¨ä½¿ç”¨è¿™äº›åŸºæœ¬ç±»å‹å¯¹åº”çš„åŒ…è£…ç±»å‹æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ç¼“å†²æ± ä¸­çš„å¯¹è±¡ã€‚ å¦‚æœåœ¨ç¼“å†²æ± ä¹‹å¤–ï¼š 123Integer m = 323;Integer n = 323;System.out.println(m == n); // false Stringæ¦‚è§ˆString è¢«å£°æ˜ä¸º finalï¼Œå› æ­¤å®ƒä¸å¯è¢«ç»§æ‰¿ã€‚ å†…éƒ¨ä½¿ç”¨ char æ•°ç»„å­˜å‚¨æ•°æ®**(Java 9 ä¹‹åï¼ŒString ç±»çš„å®ç°æ”¹ç”¨ byte æ•°ç»„å­˜å‚¨å­—ç¬¦ä¸²)**ï¼Œè¯¥æ•°ç»„è¢«å£°æ˜ä¸º finalï¼Œè¿™æ„å‘³ç€ value æ•°ç»„åˆå§‹åŒ–ä¹‹åå°±ä¸èƒ½å†å¼•ç”¨å…¶å®ƒæ•°ç»„ã€‚å¹¶ä¸” String å†…éƒ¨æ²¡æœ‰æ”¹å˜ value æ•°ç»„çš„æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥ä¿è¯ String ä¸å¯å˜ã€‚ 1234public final class String implements java.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123; /** The value is used for character storage. */ private final char value[]; ä¸å¯å˜çš„å¥½å¤„1. å¯ä»¥ç¼“å­˜ hash å€¼ å› ä¸º String çš„ hash å€¼ç»å¸¸è¢«ä½¿ç”¨ï¼Œä¾‹å¦‚ String ç”¨åš HashMap çš„ keyã€‚ä¸å¯å˜çš„ç‰¹æ€§å¯ä»¥ä½¿å¾— hash å€¼ä¹Ÿä¸å¯å˜ï¼Œå› æ­¤åªéœ€è¦è¿›è¡Œä¸€æ¬¡è®¡ç®—ã€‚ 2. String Pool çš„éœ€è¦ å¦‚æœä¸€ä¸ª String å¯¹è±¡å·²ç»è¢«åˆ›å»ºè¿‡äº†ï¼Œé‚£ä¹ˆå°±ä¼šä» String Pool ä¸­å–å¾—å¼•ç”¨ã€‚åªæœ‰ String æ˜¯ä¸å¯å˜çš„ï¼Œæ‰å¯èƒ½ä½¿ç”¨ String Poolã€‚ 3. å®‰å…¨æ€§ String ç»å¸¸ä½œä¸ºå‚æ•°ï¼ŒString ä¸å¯å˜æ€§å¯ä»¥ä¿è¯å‚æ•°ä¸å¯å˜ã€‚ä¾‹å¦‚åœ¨ä½œä¸ºç½‘ç»œè¿æ¥å‚æ•°çš„æƒ…å†µä¸‹å¦‚æœ String æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆåœ¨ç½‘ç»œè¿æ¥è¿‡ç¨‹ä¸­ï¼ŒString è¢«æ”¹å˜ï¼Œæ”¹å˜ String å¯¹è±¡çš„é‚£ä¸€æ–¹ä»¥ä¸ºç°åœ¨è¿æ¥çš„æ˜¯å…¶å®ƒä¸»æœºï¼Œè€Œå®é™…æƒ…å†µå´ä¸ä¸€å®šæ˜¯ã€‚ 4. çº¿ç¨‹å®‰å…¨ String ä¸å¯å˜æ€§å¤©ç”Ÿå…·å¤‡çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å®‰å…¨åœ°ä½¿ç”¨ã€‚ Program Creek : Why String is immutable in Java? String, StringBuffer and StringBuilder1. å¯å˜æ€§ String ä¸å¯å˜ StringBuffer å’Œ StringBuilder å¯å˜ 2. çº¿ç¨‹å®‰å…¨ String ä¸å¯å˜ï¼Œå› æ­¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ StringBuilder ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ StringBuffer æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå†…éƒ¨ä½¿ç”¨ synchronized è¿›è¡ŒåŒæ­¥ StackOverflow : String, StringBuffer, and StringBuilder String.intern()ä½¿ç”¨ String.intern() å¯ä»¥ä¿è¯ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²å˜é‡å¼•ç”¨åŒä¸€çš„å†…å­˜å¯¹è±¡ã€‚ ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œs1 å’Œ s2 é‡‡ç”¨ new String() çš„æ–¹å¼æ–°å»ºäº†ä¸¤ä¸ªä¸åŒå¯¹è±¡ï¼Œè€Œ s3 æ˜¯é€šè¿‡ s1.intern() æ–¹æ³•å–å¾—ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ã€‚intern() é¦–å…ˆæŠŠ s1 å¼•ç”¨çš„å¯¹è±¡æ”¾åˆ° String Pool(å­—ç¬¦ä¸²å¸¸é‡æ± )ä¸­ï¼Œç„¶åè¿”å›è¿™ä¸ªå¯¹è±¡å¼•ç”¨ã€‚å› æ­¤ s3 å’Œ s1 å¼•ç”¨çš„æ˜¯åŒä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ± çš„å¯¹è±¡ã€‚ 12345String s1 = new String(&quot;aaa&quot;);String s2 = new String(&quot;aaa&quot;);System.out.println(s1 == s2); // falseString s3 = s1.intern();System.out.println(s1.intern() == s3); // true å¦‚æœæ˜¯é‡‡ç”¨ â€œbbbâ€ è¿™ç§ä½¿ç”¨åŒå¼•å·çš„å½¢å¼åˆ›å»ºå­—ç¬¦ä¸²å®ä¾‹ï¼Œä¼šè‡ªåŠ¨åœ°å°†æ–°å»ºçš„å¯¹è±¡æ”¾å…¥ String Pool ä¸­ã€‚ 123String s4 = &quot;bbb&quot;;String s5 = &quot;bbb&quot;;System.out.println(s4 == s5); // true HotSpotä¸­å­—ç¬¦ä¸²å¸¸é‡æ± ä¿å­˜å“ªé‡Œï¼Ÿæ°¸ä¹…ä»£ï¼Ÿæ–¹æ³•åŒºè¿˜æ˜¯å †åŒºï¼Ÿ è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯è™šæ‹Ÿæœºè§„èŒƒä¸­æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åŠ è½½ç±»å’Œç»“æ„åˆ°è™šæ‹Ÿæœºåï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼›è€Œå­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­å¸¸é‡å­—ç¬¦ä¸²çš„å­˜æ”¾ä½ç½®ã€‚æ‰€ä»¥ä»è¿™ä¸ªè§’åº¦ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å±äºè™šæ‹Ÿæœºè§„èŒƒä¸­çš„æ–¹æ³•åŒºï¼Œå®ƒæ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼›è€Œå †åŒºï¼Œæ°¸ä¹…ä»£ä»¥åŠå…ƒç©ºé—´æ˜¯å®é™…çš„å­˜æ”¾ä½ç½®ã€‚ ä¸åŒçš„è™šæ‹Ÿæœºå¯¹è™šæ‹Ÿæœºçš„è§„èŒƒï¼ˆæ¯”å¦‚æ–¹æ³•åŒºï¼‰æ˜¯ä¸ä¸€æ ·çš„ï¼Œåªæœ‰ HotSpot æ‰æœ‰æ°¸ä¹…ä»£çš„æ¦‚å¿µã€‚ HotSpotä¹Ÿæ˜¯å‘å±•çš„ï¼Œç”±äºä¸€äº›é—®é¢˜åœ¨æ–°çª—å£æ‰“å¼€çš„å­˜åœ¨ï¼ŒHotSpotè€ƒè™‘é€æ¸å»æ°¸ä¹…ä»£ï¼Œå¯¹äºä¸åŒç‰ˆæœ¬çš„JDKï¼Œå®é™…çš„å­˜å‚¨ä½ç½®æ˜¯æœ‰å·®å¼‚çš„ï¼Œå…·ä½“çœ‹å¦‚ä¸‹è¡¨æ ¼ï¼š JDKç‰ˆæœ¬ æ˜¯å¦æœ‰æ°¸ä¹…ä»£ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ”¾åœ¨å“ªé‡Œï¼Ÿ æ–¹æ³•åŒºé€»è¾‘ä¸Šè§„èŒƒï¼Œç”±å“ªäº›å®é™…çš„éƒ¨åˆ†å®ç°çš„ï¼Ÿ jdk1.6åŠä¹‹å‰ æœ‰æ°¸ä¹…ä»£ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²å¸¸é‡æ± ï¼‰ï¼Œé™æ€å˜é‡å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸Š è¿™ä¸ªæ—¶æœŸæ–¹æ³•åŒºåœ¨HotSpotä¸­æ˜¯ç”±æ°¸ä¹…ä»£æ¥å®ç°çš„ï¼Œä»¥è‡³äºè¿™ä¸ªæ—¶æœŸè¯´æ–¹æ³•åŒºå°±æ˜¯æŒ‡æ°¸ä¹…ä»£ jdk1.7 æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥â€œå»æ°¸ä¹…ä»£â€ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­ï¼› è¿™ä¸ªæ—¶æœŸæ–¹æ³•åŒºåœ¨HotSpotä¸­ç”±æ°¸ä¹…ä»£ï¼ˆç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ï¼‰å’Œå †ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ï¼‰å…±åŒå®ç° jdk1.8åŠä¹‹å å–æ¶ˆæ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ä¿å­˜åœ¨æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼Œä½†å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»åœ¨å †ä¸­ è¿™ä¸ªæ—¶æœŸæ–¹æ³•åŒºåœ¨HotSpotä¸­ç”±æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼ˆç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ï¼‰å’Œå †ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ï¼‰å…±åŒå®ç° è¿ç®—å‚æ•°ä¼ é€’Java çš„å‚æ•°æ˜¯ä»¥å€¼ä¼ é€’çš„å½¢å¼ä¼ å…¥æ–¹æ³•ä¸­ï¼Œè€Œä¸æ˜¯å¼•ç”¨ä¼ é€’ã€‚ ä»¥ä¸‹ä»£ç ä¸­ Dog dog çš„ dog æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå­˜å‚¨çš„æ˜¯å¯¹è±¡çš„åœ°å€ã€‚åœ¨å°†ä¸€ä¸ªå‚æ•°ä¼ å…¥ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å°†å¯¹è±¡çš„åœ°å€ä»¥å€¼çš„æ–¹å¼ä¼ é€’åˆ°å½¢å‚ä¸­ã€‚å› æ­¤åœ¨æ–¹æ³•ä¸­æ”¹å˜æŒ‡é’ˆå¼•ç”¨çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæŒ‡é’ˆæ­¤æ—¶æŒ‡å‘çš„æ˜¯å®Œå…¨ä¸åŒçš„å¯¹è±¡ï¼Œä¸€æ–¹æ”¹å˜å…¶æ‰€æŒ‡å‘å¯¹è±¡çš„å†…å®¹å¯¹å¦ä¸€æ–¹æ²¡æœ‰å½±å“ã€‚ 1234567891011121314151617181920212223242526272829303132333435public class Dog &#123; String name; Dog(String name) &#123; this.name = name; &#125; String getName() &#123; return this.name; &#125; void setName(String name) &#123; this.name = name; &#125; String getObjectAddress() &#123; return super.toString(); &#125;&#125;public class PassByValueExample &#123; public static void main(String[] args) &#123; Dog dog = new Dog(&quot;A&quot;); System.out.println(dog.getObjectAddress()); // Dog@4554617c func(dog); System.out.println(dog.getObjectAddress()); // Dog@4554617c System.out.println(dog.getName()); // A &#125; private static void func(Dog dog) &#123; System.out.println(dog.getObjectAddress()); // Dog@4554617c dog = new Dog(&quot;B&quot;); System.out.println(dog.getObjectAddress()); // Dog@74a14482 System.out.println(dog.getName()); // B &#125;&#125; ä½†æ˜¯å¦‚æœåœ¨æ–¹æ³•ä¸­æ”¹å˜å¯¹è±¡çš„å­—æ®µå€¼ä¼šæ”¹å˜åŸå¯¹è±¡è¯¥å­—æ®µå€¼ï¼Œå› ä¸ºæ”¹å˜çš„æ˜¯åŒä¸€ä¸ªåœ°å€æŒ‡å‘çš„å†…å®¹ã€‚ 1234567891011class PassByValueExample &#123; public static void main(String[] args) &#123; Dog dog = new Dog(&quot;A&quot;); func(dog); System.out.println(dog.getName()); // B &#125; private static void func(Dog dog) &#123; dog.setName(&quot;B&quot;); &#125;&#125; StackOverflow: Is Java â€œpass-by-referenceâ€ or â€œpass-by-valueâ€? float ä¸ double1.1 å­—é¢é‡å±äº double ç±»å‹ï¼Œä¸èƒ½ç›´æ¥å°† 1.1 ç›´æ¥èµ‹å€¼ç»™ float å˜é‡ï¼Œå› ä¸ºè¿™æ˜¯å‘ä¸‹è½¬å‹ã€‚Java ä¸èƒ½éšå¼æ‰§è¡Œå‘ä¸‹è½¬å‹ï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—ç²¾åº¦é™ä½ã€‚ 1// float f = 1.1; 1.1f å­—é¢é‡æ‰æ˜¯ float ç±»å‹ã€‚ 1float f = 1.1f; éšå¼ç±»å‹è½¬æ¢å› ä¸ºå­—é¢é‡ 1 æ˜¯ int ç±»å‹ï¼Œå®ƒæ¯” short ç±»å‹ç²¾åº¦è¦é«˜ï¼Œå› æ­¤ä¸èƒ½éšå¼åœ°å°† int ç±»å‹ä¸‹è½¬å‹ä¸º short ç±»å‹ã€‚ 12short s1 = 1;// s1 = s1 + 1; ä½†æ˜¯ä½¿ç”¨ += è¿ç®—ç¬¦å¯ä»¥æ‰§è¡Œéšå¼ç±»å‹è½¬æ¢ã€‚ 1s1 += 1; ä¸Šé¢çš„è¯­å¥ç›¸å½“äºå°† s1 + 1 çš„è®¡ç®—ç»“æœè¿›è¡Œäº†å‘ä¸‹è½¬å‹: 1s1 = (short) (s1 + 1); StackOverflow : Why donâ€™t Javaâ€™s +&#x3D;, -&#x3D;, *&#x3D;, &#x2F;&#x3D; compound assignment operators require casting? switchä» Java 7 å¼€å§‹ï¼Œå¯ä»¥åœ¨ switch æ¡ä»¶åˆ¤æ–­è¯­å¥ä¸­ä½¿ç”¨ String å¯¹è±¡ã€‚ 123456789String s = &quot;a&quot;;switch (s) &#123; case &quot;a&quot;: System.out.println(&quot;aaa&quot;); break; case &quot;b&quot;: System.out.println(&quot;bbb&quot;); break;&#125; switch ä¸æ”¯æŒ longï¼Œæ˜¯å› ä¸º switch çš„è®¾è®¡åˆè¡·æ˜¯å¯¹é‚£äº›åªæœ‰å°‘æ•°çš„å‡ ä¸ªå€¼è¿›è¡Œç­‰å€¼åˆ¤æ–­ï¼Œå¦‚æœå€¼è¿‡äºå¤æ‚ï¼Œé‚£ä¹ˆè¿˜æ˜¯ç”¨ if æ¯”è¾ƒåˆé€‚ã€‚ 123456789// long x = 111;// switch (x) &#123; // Incompatible types. Found: &#x27;long&#x27;, required: &#x27;char, byte, short, int, Character, Byte, Short, Integer, String, or an enum&#x27;// case 111:// System.out.println(111);// break;// case 222:// System.out.println(222);// break;// &#125; StackOverflow : Why canâ€™t your switch statement data type be long, Java? ç»§æ‰¿è®¿é—®æƒé™Java ä¸­æœ‰ä¸‰ä¸ªè®¿é—®æƒé™ä¿®é¥°ç¬¦: privateã€protected ä»¥åŠ publicï¼Œå¦‚æœä¸åŠ è®¿é—®ä¿®é¥°ç¬¦ï¼Œè¡¨ç¤ºåŒ…çº§å¯è§ã€‚ å¯ä»¥å¯¹ç±»æˆ–ç±»ä¸­çš„æˆå‘˜(å­—æ®µä»¥åŠæ–¹æ³•)åŠ ä¸Šè®¿é—®ä¿®é¥°ç¬¦ã€‚ ç±»å¯è§è¡¨ç¤ºå…¶å®ƒç±»å¯ä»¥ç”¨è¿™ä¸ªç±»åˆ›å»ºå®ä¾‹å¯¹è±¡ã€‚ æˆå‘˜å¯è§è¡¨ç¤ºå…¶å®ƒç±»å¯ä»¥ç”¨è¿™ä¸ªç±»çš„å®ä¾‹å¯¹è±¡è®¿é—®åˆ°è¯¥æˆå‘˜ï¼› protected ç”¨äºä¿®é¥°æˆå‘˜ï¼Œè¡¨ç¤ºåœ¨ç»§æ‰¿ä½“ç³»ä¸­æˆå‘˜å¯¹äºå­ç±»å¯è§ï¼Œä½†æ˜¯è¿™ä¸ªè®¿é—®ä¿®é¥°ç¬¦å¯¹äºç±»æ²¡æœ‰æ„ä¹‰ã€‚ è®¾è®¡è‰¯å¥½çš„æ¨¡å—ä¼šéšè—æ‰€æœ‰çš„å®ç°ç»†èŠ‚ï¼ŒæŠŠå®ƒçš„ API ä¸å®ƒçš„å®ç°æ¸…æ™°åœ°éš”ç¦»å¼€æ¥ã€‚æ¨¡å—ä¹‹é—´åªé€šè¿‡å®ƒä»¬çš„ API è¿›è¡Œé€šä¿¡ï¼Œä¸€ä¸ªæ¨¡å—ä¸éœ€è¦çŸ¥é“å…¶ä»–æ¨¡å—çš„å†…éƒ¨å·¥ä½œæƒ…å†µï¼Œè¿™ä¸ªæ¦‚å¿µè¢«ç§°ä¸ºä¿¡æ¯éšè—æˆ–å°è£…ã€‚å› æ­¤è®¿é—®æƒé™åº”å½“å°½å¯èƒ½åœ°ä½¿æ¯ä¸ªç±»æˆ–è€…æˆå‘˜ä¸è¢«å¤–ç•Œè®¿é—®ã€‚ å¦‚æœå­ç±»çš„æ–¹æ³•é‡å†™äº†çˆ¶ç±»çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå­ç±»ä¸­è¯¥æ–¹æ³•çš„è®¿é—®çº§åˆ«ä¸å…è®¸ä½äºçˆ¶ç±»çš„è®¿é—®çº§åˆ«ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿å¯ä»¥ä½¿ç”¨çˆ¶ç±»å®ä¾‹çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨å­ç±»å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ç¡®ä¿æ»¡è¶³é‡Œæ°æ›¿æ¢åŸåˆ™ã€‚ å­—æ®µå†³ä¸èƒ½æ˜¯å…¬æœ‰çš„ï¼Œå› ä¸ºè¿™ä¹ˆåšçš„è¯å°±å¤±å»äº†å¯¹è¿™ä¸ªå­—æ®µä¿®æ”¹è¡Œä¸ºçš„æ§åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥å¯¹å…¶éšæ„ä¿®æ”¹ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼ŒAccessExample æ‹¥æœ‰ id å…±æœ‰å­—æ®µï¼Œå¦‚æœåœ¨æŸä¸ªæ—¶åˆ»ï¼Œæˆ‘ä»¬æƒ³è¦ä½¿ç”¨ int å»å­˜å‚¨ id å­—æ®µï¼Œé‚£ä¹ˆå°±éœ€è¦å»ä¿®æ”¹æ‰€æœ‰çš„å®¢æˆ·ç«¯ä»£ç ã€‚ 123public class AccessExample &#123; public String id;&#125; å¯ä»¥ä½¿ç”¨å…¬æœ‰çš„ getter å’Œ setter æ–¹æ³•æ¥æ›¿æ¢å…¬æœ‰å­—æ®µï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥æ§åˆ¶å¯¹å­—æ®µçš„ä¿®æ”¹è¡Œä¸ºã€‚ 123456789101112public class AccessExample &#123; private int id; public String getId() &#123; return id + &quot;&quot;; &#125; public void setId(String id) &#123; this.id = Integer.valueOf(id); &#125;&#125; ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå¦‚æœæ˜¯åŒ…çº§ç§æœ‰çš„ç±»æˆ–è€…ç§æœ‰çš„åµŒå¥—ç±»ï¼Œé‚£ä¹ˆç›´æ¥æš´éœ²æˆå‘˜ä¸ä¼šæœ‰ç‰¹åˆ«å¤§çš„å½±å“ã€‚ 123456789101112131415public class AccessWithInnerClassExample &#123; private class InnerClass &#123; int x; &#125; private InnerClass innerClass; public AccessWithInnerClassExample() &#123; innerClass = new InnerClass(); &#125; public int getValue() &#123; return innerClass.x; // ç›´æ¥è®¿é—® &#125;&#125; æŠ½è±¡ç±»ä¸æ¥å£1. æŠ½è±¡ç±» æŠ½è±¡ç±»å’ŒæŠ½è±¡æ–¹æ³•éƒ½ä½¿ç”¨ abstract å…³é”®å­—è¿›è¡Œå£°æ˜ã€‚æŠ½è±¡ç±»ä¸€èˆ¬ä¼šåŒ…å«æŠ½è±¡æ–¹æ³•ï¼ŒæŠ½è±¡æ–¹æ³•ä¸€å®šä½äºæŠ½è±¡ç±»ä¸­ã€‚ æŠ½è±¡ç±»å’Œæ™®é€šç±»æœ€å¤§çš„åŒºåˆ«æ˜¯ï¼ŒæŠ½è±¡ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œéœ€è¦ç»§æ‰¿æŠ½è±¡ç±»æ‰èƒ½å®ä¾‹åŒ–å…¶å­ç±»ã€‚ 1234567891011121314151617181920public abstract class AbstractClassExample &#123; protected int x; private int y; public abstract void func1(); public void func2() &#123; System.out.println(&quot;func2&quot;); &#125;&#125;public class AbstractExtendClassExample extends AbstractClassExample &#123; @Override public void func1() &#123; System.out.println(&quot;func1&quot;); &#125;&#125;// AbstractClassExample ac1 = new AbstractClassExample(); // &#x27;AbstractClassExample&#x27; is abstract; cannot be instantiatedAbstractClassExample ac2 = new AbstractExtendClassExample();ac2.func1(); 2. æ¥å£ æ¥å£æ˜¯æŠ½è±¡ç±»çš„å»¶ä¼¸ï¼Œåœ¨ Java 8 ä¹‹å‰ï¼Œå®ƒå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå®Œå…¨æŠ½è±¡çš„ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½æœ‰ä»»ä½•çš„æ–¹æ³•å®ç°ã€‚ ä» Java 8 å¼€å§‹ï¼Œæ¥å£ä¹Ÿå¯ä»¥æ‹¥æœ‰é»˜è®¤çš„æ–¹æ³•å®ç°ï¼Œè¿™æ˜¯å› ä¸ºä¸æ”¯æŒé»˜è®¤æ–¹æ³•çš„æ¥å£çš„ç»´æŠ¤æˆæœ¬å¤ªé«˜äº†ã€‚åœ¨ Java 8 ä¹‹å‰ï¼Œå¦‚æœä¸€ä¸ªæ¥å£æƒ³è¦æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œé‚£ä¹ˆè¦ä¿®æ”¹æ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„ç±»ã€‚ æ¥å£çš„æˆå‘˜(å­—æ®µ + æ–¹æ³•)é»˜è®¤éƒ½æ˜¯ public çš„ï¼Œå¹¶ä¸”ä¸å…è®¸å®šä¹‰ä¸º private æˆ–è€… protectedã€‚ æ¥å£çš„å­—æ®µé»˜è®¤éƒ½æ˜¯ static å’Œ final çš„ã€‚ 123456789101112131415161718192021222324public interface InterfaceExample &#123; void func1(); default void func2()&#123; System.out.println(&quot;func2&quot;); &#125; int x = 123; // int y; // Variable &#x27;y&#x27; might not have been initialized public int z = 0; // Modifier &#x27;public&#x27; is redundant for interface fields // private int k = 0; // Modifier &#x27;private&#x27; not allowed here // protected int l = 0; // Modifier &#x27;protected&#x27; not allowed here // private void fun3(); // Modifier &#x27;private&#x27; not allowed here&#125;public class InterfaceImplementExample implements InterfaceExample &#123; @Override public void func1() &#123; System.out.println(&quot;func1&quot;); &#125;&#125;// InterfaceExample ie1 = new InterfaceExample(); // &#x27;InterfaceExample&#x27; is abstract; cannot be instantiatedInterfaceExample ie2 = new InterfaceImplementExample();ie2.func1();System.out.println(InterfaceExample.x); 3. æ¯”è¾ƒ ä»è®¾è®¡å±‚é¢ä¸Šçœ‹ï¼ŒæŠ½è±¡ç±»æä¾›äº†ä¸€ç§ IS-A å…³ç³»ï¼Œé‚£ä¹ˆå°±å¿…é¡»æ»¡è¶³é‡Œå¼æ›¿æ¢åŸåˆ™ï¼Œå³å­ç±»å¯¹è±¡å¿…é¡»èƒ½å¤Ÿæ›¿æ¢æ‰æ‰€æœ‰çˆ¶ç±»å¯¹è±¡ã€‚è€Œæ¥å£æ›´åƒæ˜¯ä¸€ç§ LIKE-A å…³ç³»ï¼Œå®ƒåªæ˜¯æä¾›ä¸€ç§æ–¹æ³•å®ç°å¥‘çº¦ï¼Œå¹¶ä¸è¦æ±‚æ¥å£å’Œå®ç°æ¥å£çš„ç±»å…·æœ‰ IS-A å…³ç³»ã€‚ ä»ä½¿ç”¨ä¸Šæ¥çœ‹ï¼Œä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œä½†æ˜¯ä¸èƒ½ç»§æ‰¿å¤šä¸ªæŠ½è±¡ç±»ã€‚ æ¥å£çš„å­—æ®µåªèƒ½æ˜¯ static å’Œ final ç±»å‹çš„ï¼Œè€ŒæŠ½è±¡ç±»çš„å­—æ®µæ²¡æœ‰è¿™ç§é™åˆ¶ã€‚ æ¥å£çš„æˆå‘˜åªèƒ½æ˜¯ public çš„ï¼Œè€ŒæŠ½è±¡ç±»çš„æˆå‘˜å¯ä»¥æœ‰å¤šç§è®¿é—®æƒé™ã€‚ 4. ä½¿ç”¨é€‰æ‹© ä½¿ç”¨æ¥å£: éœ€è¦è®©ä¸ç›¸å…³çš„ç±»éƒ½å®ç°ä¸€ä¸ªæ–¹æ³•ï¼Œä¾‹å¦‚ä¸ç›¸å…³çš„ç±»éƒ½å¯ä»¥å®ç° Compareable æ¥å£ä¸­çš„ compareTo() æ–¹æ³•ï¼› éœ€è¦ä½¿ç”¨å¤šé‡ç»§æ‰¿ã€‚ ä½¿ç”¨æŠ½è±¡ç±»: éœ€è¦åœ¨å‡ ä¸ªç›¸å…³çš„ç±»ä¸­å…±äº«ä»£ç ã€‚ éœ€è¦èƒ½æ§åˆ¶ç»§æ‰¿æ¥çš„æˆå‘˜çš„è®¿é—®æƒé™ï¼Œè€Œä¸æ˜¯éƒ½ä¸º publicã€‚ éœ€è¦ç»§æ‰¿éé™æ€å’Œéå¸¸é‡å­—æ®µã€‚ åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæ¥å£ä¼˜å…ˆäºæŠ½è±¡ç±»ï¼Œå› ä¸ºæ¥å£æ²¡æœ‰æŠ½è±¡ç±»ä¸¥æ ¼çš„ç±»å±‚æ¬¡ç»“æ„è¦æ±‚ï¼Œå¯ä»¥çµæ´»åœ°ä¸ºä¸€ä¸ªç±»æ·»åŠ è¡Œä¸ºã€‚å¹¶ä¸”ä» Java 8 å¼€å§‹ï¼Œæ¥å£ä¹Ÿå¯ä»¥æœ‰é»˜è®¤çš„æ–¹æ³•å®ç°ï¼Œä½¿å¾—ä¿®æ”¹æ¥å£çš„æˆæœ¬ä¹Ÿå˜çš„å¾ˆä½ã€‚ æ·±å…¥ç†è§£ abstract class å’Œ interface When to Use Abstract Class and Interface super è®¿é—®çˆ¶ç±»çš„æ„é€ å‡½æ•°: å¯ä»¥ä½¿ç”¨ super() å‡½æ•°è®¿é—®çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œä»è€Œå§”æ‰˜çˆ¶ç±»å®Œæˆä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œã€‚ è®¿é—®çˆ¶ç±»çš„æˆå‘˜: å¦‚æœå­ç±»é‡å†™äº†çˆ¶ç±»çš„ä¸­æŸä¸ªæ–¹æ³•çš„å®ç°ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ super å…³é”®å­—æ¥å¼•ç”¨çˆ¶ç±»çš„æ–¹æ³•å®ç°ã€‚ 12345678910111213141516171819202122232425262728293031public class SuperExample &#123; protected int x; protected int y; public SuperExample(int x, int y) &#123; this.x = x; this.y = y; &#125; public void func() &#123; System.out.println(&quot;SuperExample.func()&quot;); &#125;&#125;public class SuperExtendExample extends SuperExample &#123; private int z; public SuperExtendExample(int x, int y, int z) &#123; super(x, y); this.z = z; &#125; @Override public void func() &#123; super.func(); System.out.println(&quot;SuperExtendExample.func()&quot;); &#125;&#125;SuperExample e = new SuperExtendExample(1, 2, 3);e.func();SuperExample.func()SuperExtendExample.func() Using the Keyword super é‡å†™ä¸é‡è½½1. é‡å†™(Override) å­˜åœ¨äºç»§æ‰¿ä½“ç³»ä¸­ï¼ŒæŒ‡å­ç±»å®ç°äº†ä¸€ä¸ªä¸çˆ¶ç±»åœ¨æ–¹æ³•å£°æ˜ä¸Šå®Œå…¨ç›¸åŒçš„ä¸€ä¸ªæ–¹æ³•ã€‚ ä¸ºäº†æ»¡è¶³é‡Œå¼æ›¿æ¢åŸåˆ™ï¼Œé‡å†™æœ‰ä»¥ä¸‹ä¸¤ä¸ªé™åˆ¶: å­ç±»æ–¹æ³•çš„è®¿é—®æƒé™å¿…é¡»å¤§äºç­‰äºçˆ¶ç±»æ–¹æ³•ï¼› å­ç±»æ–¹æ³•çš„è¿”å›ç±»å‹å¿…é¡»æ˜¯çˆ¶ç±»æ–¹æ³•è¿”å›ç±»å‹æˆ–ä¸ºå…¶å­ç±»å‹ã€‚ ä½¿ç”¨ @Override æ³¨è§£ï¼Œå¯ä»¥è®©ç¼–è¯‘å™¨å¸®å¿™æ£€æŸ¥æ˜¯å¦æ»¡è¶³ä¸Šé¢çš„ä¸¤ä¸ªé™åˆ¶æ¡ä»¶ã€‚ 2. é‡è½½(Overload) å­˜åœ¨äºåŒä¸€ä¸ªç±»ä¸­ï¼ŒæŒ‡ä¸€ä¸ªæ–¹æ³•ä¸å·²ç»å­˜åœ¨çš„æ–¹æ³•åç§°ä¸Šç›¸åŒï¼Œä½†æ˜¯å‚æ•°ç±»å‹ã€ä¸ªæ•°ã€é¡ºåºè‡³å°‘æœ‰ä¸€ä¸ªä¸åŒã€‚ åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œè¿”å›å€¼ä¸åŒï¼Œå…¶å®ƒéƒ½ç›¸åŒä¸ç®—æ˜¯é‡è½½ã€‚ Object é€šç”¨æ–¹æ³•æ¦‚è§ˆ123456789101112131415161718192021public final native Class&lt;?&gt; getClass()public native int hashCode()public boolean equals(Object obj)protected native Object clone() throws CloneNotSupportedExceptionpublic String toString()public final native void notify()public final native void notifyAll()public final native void wait(long timeout) throws InterruptedExceptionpublic final void wait(long timeout, int nanos) throws InterruptedExceptionpublic final void wait() throws InterruptedExceptionprotected void finalize() throws Throwable &#123;&#125; equals()1. ç­‰ä»·å…³ç³» (ä¸€)è‡ªåæ€§ 1x.equals(x); // true (äºŒ)å¯¹ç§°æ€§ 1x.equals(y) == y.equals(x); // true (ä¸‰)ä¼ é€’æ€§ 12if (x.equals(y) &amp;&amp; y.equals(z)) x.equals(z); // true; (å››)ä¸€è‡´æ€§ å¤šæ¬¡è°ƒç”¨ equals() æ–¹æ³•ç»“æœä¸å˜ 1x.equals(y) == x.equals(y); // true (äº”)ä¸ null çš„æ¯”è¾ƒ å¯¹ä»»ä½•ä¸æ˜¯ null çš„å¯¹è±¡ x è°ƒç”¨ x.equals(null) ç»“æœéƒ½ä¸º false 1x.equals(null); // false; 2. equals() ä¸ == å¯¹äºåŸºæœ¬ç±»å‹ï¼Œ== åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼ŒåŸºæœ¬ç±»å‹æ²¡æœ‰ equals() æ–¹æ³•ã€‚ å¯¹äºå¼•ç”¨ç±»å‹ï¼Œ== åˆ¤æ–­ä¸¤ä¸ªå˜é‡æ˜¯å¦å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼Œè€Œ equals() åˆ¤æ–­å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦ç­‰ä»·ã€‚ 1234Integer x = new Integer(1);Integer y = new Integer(1);System.out.println(x.equals(y)); // trueSystem.out.println(x == y); // false 3. å®ç° æ£€æŸ¥æ˜¯å¦ä¸ºåŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå¦‚æœæ˜¯ç›´æ¥è¿”å› trueï¼› æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªç±»å‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å› falseï¼› å°† Object å¯¹è±¡è¿›è¡Œè½¬å‹ï¼› åˆ¤æ–­æ¯ä¸ªå…³é”®åŸŸæ˜¯å¦ç›¸ç­‰ã€‚ 1234567891011121314151617181920212223public class EqualExample &#123; private int x; private int y; private int z; public EqualExample(int x, int y, int z) &#123; this.x = x; this.y = y; this.z = z; &#125; @Override public boolean equals(Object o) &#123; if (this == o) return true; if (o == null || getClass() != o.getClass()) return false; EqualExample that = (EqualExample) o; if (x != that.x) return false; if (y != that.y) return false; return z == that.z; &#125;&#125; hashCode()hashCode() è¿”å›æ•£åˆ—å€¼ï¼Œè€Œ equals() æ˜¯ç”¨æ¥åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç­‰ä»·ã€‚ç­‰ä»·çš„ä¸¤ä¸ªå¯¹è±¡æ•£åˆ—å€¼ä¸€å®šç›¸åŒï¼Œä½†æ˜¯æ•£åˆ—å€¼ç›¸åŒçš„ä¸¤ä¸ªå¯¹è±¡ä¸ä¸€å®šç­‰ä»·ã€‚ åœ¨è¦†ç›– equals() æ–¹æ³•æ—¶åº”å½“æ€»æ˜¯è¦†ç›– hashCode() æ–¹æ³•ï¼Œä¿è¯ç­‰ä»·çš„ä¸¤ä¸ªå¯¹è±¡æ•£åˆ—å€¼ä¹Ÿç›¸ç­‰ã€‚ ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæ–°å»ºäº†ä¸¤ä¸ªç­‰ä»·çš„å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ° HashSet ä¸­ã€‚æˆ‘ä»¬å¸Œæœ›å°†è¿™ä¸¤ä¸ªå¯¹è±¡å½“æˆä¸€æ ·çš„ï¼Œåªåœ¨é›†åˆä¸­æ·»åŠ ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯å› ä¸º EqualExample æ²¡æœ‰å®ç° hasCode() æ–¹æ³•ï¼Œå› æ­¤è¿™ä¸¤ä¸ªå¯¹è±¡çš„æ•£åˆ—å€¼æ˜¯ä¸åŒçš„ï¼Œæœ€ç»ˆå¯¼è‡´é›†åˆæ·»åŠ äº†ä¸¤ä¸ªç­‰ä»·çš„å¯¹è±¡ã€‚ 1234567EqualExample e1 = new EqualExample(1, 1, 1);EqualExample e2 = new EqualExample(1, 1, 1);System.out.println(e1.equals(e2)); // trueHashSet&lt;EqualExample&gt; set = new HashSet&lt;&gt;();set.add(e1);set.add(e2);System.out.println(set.size()); // 2 ç†æƒ³çš„æ•£åˆ—å‡½æ•°åº”å½“å…·æœ‰å‡åŒ€æ€§ï¼Œå³ä¸ç›¸ç­‰çš„å¯¹è±¡åº”å½“å‡åŒ€åˆ†å¸ƒåˆ°æ‰€æœ‰å¯èƒ½çš„æ•£åˆ—å€¼ä¸Šã€‚è¿™å°±è¦æ±‚äº†æ•£åˆ—å‡½æ•°è¦æŠŠæ‰€æœ‰åŸŸçš„å€¼éƒ½è€ƒè™‘è¿›æ¥ï¼Œå¯ä»¥å°†æ¯ä¸ªåŸŸéƒ½å½“æˆ R è¿›åˆ¶çš„æŸä¸€ä½ï¼Œç„¶åç»„æˆä¸€ä¸ª R è¿›åˆ¶çš„æ•´æ•°ã€‚R ä¸€èˆ¬å– 31ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¥‡ç´ æ•°ï¼Œå¦‚æœæ˜¯å¶æ•°çš„è¯ï¼Œå½“å‡ºç°ä¹˜æ³•æº¢å‡ºï¼Œä¿¡æ¯å°±ä¼šä¸¢å¤±ï¼Œå› ä¸ºä¸ 2 ç›¸ä¹˜ç›¸å½“äºå‘å·¦ç§»ä¸€ä½ã€‚ ä¸€ä¸ªæ•°ä¸ 31 ç›¸ä¹˜å¯ä»¥è½¬æ¢æˆç§»ä½å’Œå‡æ³•: 31*x == (x&lt;&lt;5)-xï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨è¿›è¡Œè¿™ä¸ªä¼˜åŒ–ã€‚ 12345678@Overridepublic int hashCode() &#123; int result = 17; result = 31 * result + x; result = 31 * result + y; result = 31 * result + z; return result;&#125; toString()é»˜è®¤è¿”å› ToStringExample@4554617c è¿™ç§å½¢å¼ï¼Œå…¶ä¸­ @ åé¢çš„æ•°å€¼ä¸ºæ•£åˆ—ç çš„æ— ç¬¦å·åå…­è¿›åˆ¶è¡¨ç¤ºã€‚ 12345678910public class ToStringExample &#123; private int number; public ToStringExample(int number) &#123; this.number = number; &#125;&#125;ToStringExample example = new ToStringExample(123);System.out.println(example.toString());ToStringExample@4554617c clone()1. cloneable clone() æ˜¯ Object çš„ protected æ–¹æ³•ï¼Œå®ƒä¸æ˜¯ publicï¼Œä¸€ä¸ªç±»ä¸æ˜¾å¼å»é‡å†™ clone()ï¼Œå…¶å®ƒç±»å°±ä¸èƒ½ç›´æ¥å»è°ƒç”¨è¯¥ç±»å®ä¾‹çš„ clone() æ–¹æ³•ã€‚ 123456public class CloneExample &#123; private int a; private int b;&#125;CloneExample e1 = new CloneExample();// CloneExample e2 = e1.clone(); // &#x27;clone()&#x27; has protected access in &#x27;java.lang.Object&#x27; é‡å†™ clone() å¾—åˆ°ä»¥ä¸‹å®ç°: 12345678910111213141516public class CloneExample &#123; private int a; private int b; @Override protected CloneExample clone() throws CloneNotSupportedException &#123; return (CloneExample)super.clone(); &#125;&#125;CloneExample e1 = new CloneExample();try &#123; CloneExample e2 = e1.clone();&#125; catch (CloneNotSupportedException e) &#123; e.printStackTrace();&#125;java.lang.CloneNotSupportedException: CloneExample ä»¥ä¸ŠæŠ›å‡ºäº† CloneNotSupportedExceptionï¼Œè¿™æ˜¯å› ä¸º CloneExample æ²¡æœ‰å®ç° Cloneable æ¥å£ã€‚ åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œclone() æ–¹æ³•å¹¶ä¸æ˜¯ Cloneable æ¥å£çš„æ–¹æ³•ï¼Œè€Œæ˜¯ Object çš„ä¸€ä¸ª protected æ–¹æ³•ã€‚Cloneable æ¥å£åªæ˜¯è§„å®šï¼Œå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰å®ç° Cloneable æ¥å£åˆè°ƒç”¨äº† clone() æ–¹æ³•ï¼Œå°±ä¼šæŠ›å‡º CloneNotSupportedExceptionã€‚ 123456789public class CloneExample implements Cloneable &#123; private int a; private int b; @Override protected Object clone() throws CloneNotSupportedException &#123; return super.clone(); &#125;&#125; 2. æµ…æ‹·è´ æ‹·è´å¯¹è±¡å’ŒåŸå§‹å¯¹è±¡çš„å¼•ç”¨ç±»å‹å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡ã€‚ 1234567891011121314151617181920212223242526272829303132public class ShallowCloneExample implements Cloneable &#123; private int[] arr; public ShallowCloneExample() &#123; arr = new int[10]; for (int i = 0; i &lt; arr.length; i++) &#123; arr[i] = i; &#125; &#125; public void set(int index, int value) &#123; arr[index] = value; &#125; public int get(int index) &#123; return arr[index]; &#125; @Override protected ShallowCloneExample clone() throws CloneNotSupportedException &#123; return (ShallowCloneExample) super.clone(); &#125;&#125;ShallowCloneExample e1 = new ShallowCloneExample();ShallowCloneExample e2 = null;try &#123; e2 = e1.clone();&#125; catch (CloneNotSupportedException e) &#123; e.printStackTrace();&#125;e1.set(2, 222);System.out.println(e2.get(2)); // 222 3. æ·±æ‹·è´ æ‹·è´å¯¹è±¡å’ŒåŸå§‹å¯¹è±¡çš„å¼•ç”¨ç±»å‹å¼•ç”¨ä¸åŒå¯¹è±¡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637public class DeepCloneExample implements Cloneable &#123; private int[] arr; public DeepCloneExample() &#123; arr = new int[10]; for (int i = 0; i &lt; arr.length; i++) &#123; arr[i] = i; &#125; &#125; public void set(int index, int value) &#123; arr[index] = value; &#125; public int get(int index) &#123; return arr[index]; &#125; @Override protected DeepCloneExample clone() throws CloneNotSupportedException &#123; DeepCloneExample result = (DeepCloneExample) super.clone(); result.arr = new int[arr.length]; for (int i = 0; i &lt; arr.length; i++) &#123; result.arr[i] = arr[i]; &#125; return result; &#125;&#125;DeepCloneExample e1 = new DeepCloneExample();DeepCloneExample e2 = null;try &#123; e2 = e1.clone();&#125; catch (CloneNotSupportedException e) &#123; e.printStackTrace();&#125;e1.set(2, 222);System.out.println(e2.get(2)); // 2 4. clone() çš„æ›¿ä»£æ–¹æ¡ˆ ä½¿ç”¨ clone() æ–¹æ³•æ¥æ‹·è´ä¸€ä¸ªå¯¹è±¡å³å¤æ‚åˆæœ‰é£é™©ï¼Œå®ƒä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸”è¿˜éœ€è¦ç±»å‹è½¬æ¢ã€‚Effective Java ä¹¦ä¸Šè®²åˆ°ï¼Œæœ€å¥½ä¸è¦å»ä½¿ç”¨ clone()ï¼Œå¯ä»¥ä½¿ç”¨æ‹·è´æ„é€ å‡½æ•°æˆ–è€…æ‹·è´å·¥å‚æ¥æ‹·è´ä¸€ä¸ªå¯¹è±¡ã€‚ 1234567891011121314151617181920212223242526272829public class CloneConstructorExample &#123; private int[] arr; public CloneConstructorExample() &#123; arr = new int[10]; for (int i = 0; i &lt; arr.length; i++) &#123; arr[i] = i; &#125; &#125; public CloneConstructorExample(CloneConstructorExample original) &#123; arr = new int[original.arr.length]; for (int i = 0; i &lt; original.arr.length; i++) &#123; arr[i] = original.arr[i]; &#125; &#125; public void set(int index, int value) &#123; arr[index] = value; &#125; public int get(int index) &#123; return arr[index]; &#125;&#125;CloneConstructorExample e1 = new CloneConstructorExample();CloneConstructorExample e2 = new CloneConstructorExample(e1);e1.set(2, 222);System.out.println(e2.get(2)); // 2 å…³é”®å­—final1. æ•°æ® å£°æ˜æ•°æ®ä¸ºå¸¸é‡ï¼Œå¯ä»¥æ˜¯ç¼–è¯‘æ—¶å¸¸é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨è¿è¡Œæ—¶è¢«åˆå§‹åŒ–åä¸èƒ½è¢«æ”¹å˜çš„å¸¸é‡ã€‚ å¯¹äºåŸºæœ¬ç±»å‹ï¼Œfinal ä½¿æ•°å€¼ä¸å˜ï¼› å¯¹äºå¼•ç”¨ç±»å‹ï¼Œfinal ä½¿å¼•ç”¨ä¸å˜ï¼Œä¹Ÿå°±ä¸èƒ½å¼•ç”¨å…¶å®ƒå¯¹è±¡ï¼Œä½†æ˜¯è¢«å¼•ç”¨çš„å¯¹è±¡æœ¬èº«æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚ 1234final int x = 1;// x = 2; // cannot assign value to final variable &#x27;x&#x27;final A y = new A();y.a = 1; 2. æ–¹æ³• å£°æ˜æ–¹æ³•ä¸èƒ½è¢«å­ç±»é‡å†™ã€‚ private æ–¹æ³•éšå¼åœ°è¢«æŒ‡å®šä¸º finalï¼Œå¦‚æœåœ¨å­ç±»ä¸­å®šä¹‰çš„æ–¹æ³•å’ŒåŸºç±»ä¸­çš„ä¸€ä¸ª private æ–¹æ³•ç­¾åç›¸åŒï¼Œæ­¤æ—¶å­ç±»çš„æ–¹æ³•ä¸æ˜¯é‡å†™åŸºç±»æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨å­ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªæ–°çš„æ–¹æ³•ã€‚ 3. ç±» å£°æ˜ç±»ä¸å…è®¸è¢«ç»§æ‰¿ã€‚ static1. é™æ€å˜é‡ é™æ€å˜é‡: åˆç§°ä¸ºç±»å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå˜é‡å±äºç±»çš„ï¼Œç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å…±äº«é™æ€å˜é‡ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ç±»åæ¥è®¿é—®å®ƒï¼›é™æ€å˜é‡åœ¨å†…å­˜ä¸­åªå­˜åœ¨ä¸€ä»½ã€‚ å®ä¾‹å˜é‡: æ¯åˆ›å»ºä¸€ä¸ªå®ä¾‹å°±ä¼šäº§ç”Ÿä¸€ä¸ªå®ä¾‹å˜é‡ï¼Œå®ƒä¸è¯¥å®ä¾‹åŒç”Ÿå…±æ­»ã€‚ 1234567891011public class A &#123; private int x; // å®ä¾‹å˜é‡ private static int y; // é™æ€å˜é‡ public static void main(String[] args) &#123; // int x = A.x; // Non-static field &#x27;x&#x27; cannot be referenced from a static context A a = new A(); int x = a.x; int y = A.y; &#125;&#125; 2. é™æ€æ–¹æ³• é™æ€æ–¹æ³•åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±å­˜åœ¨äº†ï¼Œå®ƒä¸ä¾èµ–äºä»»ä½•å®ä¾‹ã€‚æ‰€ä»¥é™æ€æ–¹æ³•å¿…é¡»æœ‰å®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸èƒ½æ˜¯æŠ½è±¡æ–¹æ³•(abstract)ã€‚ 12345public abstract class A &#123; public static void func1()&#123; &#125; // public abstract static void func2(); // Illegal combination of modifiers: &#x27;abstract&#x27; and &#x27;static&#x27;&#125; åªèƒ½è®¿é—®æ‰€å±ç±»çš„é™æ€å­—æ®µå’Œé™æ€æ–¹æ³•ï¼Œæ–¹æ³•ä¸­ä¸èƒ½æœ‰ this å’Œ super å…³é”®å­—ã€‚ 12345678910public class A &#123; private static int x; private int y; public static void func1()&#123; int a = x; // int b = y; // Non-static field &#x27;y&#x27; cannot be referenced from a static context // int b = this.y; // &#x27;A.this&#x27; cannot be referenced from a static context &#125;&#125; 3. é™æ€è¯­å¥å— é™æ€è¯­å¥å—åœ¨ç±»åˆå§‹åŒ–æ—¶è¿è¡Œä¸€æ¬¡ã€‚ 1234567891011public class A &#123; static &#123; System.out.println(&quot;123&quot;); &#125; public static void main(String[] args) &#123; A a1 = new A(); A a2 = new A(); &#125;&#125;123 4. é™æ€å†…éƒ¨ç±» éé™æ€å†…éƒ¨ç±»ä¾èµ–äºå¤–éƒ¨ç±»çš„å®ä¾‹ï¼Œè€Œé™æ€å†…éƒ¨ç±»ä¸éœ€è¦ã€‚ 1234567891011121314public class OuterClass &#123; class InnerClass &#123; &#125; static class StaticInnerClass &#123; &#125; public static void main(String[] args) &#123; // InnerClass innerClass = new InnerClass(); // &#x27;OuterClass.this&#x27; cannot be referenced from a static context OuterClass outerClass = new OuterClass(); InnerClass innerClass = outerClass.new InnerClass(); StaticInnerClass staticInnerClass = new StaticInnerClass(); &#125;&#125; é™æ€å†…éƒ¨ç±»ä¸èƒ½è®¿é—®å¤–éƒ¨ç±»çš„éé™æ€çš„å˜é‡å’Œæ–¹æ³•ã€‚ 5. é™æ€å¯¼åŒ… åœ¨ä½¿ç”¨é™æ€å˜é‡å’Œæ–¹æ³•æ—¶ä¸ç”¨å†æŒ‡æ˜ ClassNameï¼Œä»è€Œç®€åŒ–ä»£ç ï¼Œä½†å¯è¯»æ€§å¤§å¤§é™ä½ã€‚ 1import static com.xxx.ClassName.* 6. åˆå§‹åŒ–é¡ºåº é™æ€å˜é‡å’Œé™æ€è¯­å¥å—ä¼˜å…ˆäºå®ä¾‹å˜é‡å’Œæ™®é€šè¯­å¥å—ï¼Œé™æ€å˜é‡å’Œé™æ€è¯­å¥å—çš„åˆå§‹åŒ–é¡ºåºå–å†³äºå®ƒä»¬åœ¨ä»£ç ä¸­çš„é¡ºåºã€‚ 12345678public static String staticField = &quot;é™æ€å˜é‡&quot;;static &#123; System.out.println(&quot;é™æ€è¯­å¥å—&quot;);&#125;public String field = &quot;å®ä¾‹å˜é‡&quot;;&#123; System.out.println(&quot;æ™®é€šè¯­å¥å—&quot;);&#125; æœ€åæ‰æ˜¯æ„é€ å‡½æ•°çš„åˆå§‹åŒ–ã€‚ 123public InitialOrderTest() &#123; System.out.println(&quot;æ„é€ å‡½æ•°&quot;);&#125; å­˜åœ¨ç»§æ‰¿çš„æƒ…å†µä¸‹ï¼Œåˆå§‹åŒ–é¡ºåºä¸º: çˆ¶ç±»(é™æ€å˜é‡ã€é™æ€è¯­å¥å—) å­ç±»(é™æ€å˜é‡ã€é™æ€è¯­å¥å—) çˆ¶ç±»(å®ä¾‹å˜é‡ã€æ™®é€šè¯­å¥å—) çˆ¶ç±»(æ„é€ å‡½æ•°) å­ç±»(å®ä¾‹å˜é‡ã€æ™®é€šè¯­å¥å—) å­ç±»(æ„é€ å‡½æ•°) åå°„æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ª Class å¯¹è±¡ï¼ŒåŒ…å«äº†ä¸ç±»æœ‰å…³çš„ä¿¡æ¯ã€‚å½“ç¼–è¯‘ä¸€ä¸ªæ–°ç±»æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªåŒåçš„ .class æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å†…å®¹ä¿å­˜ç€ Class å¯¹è±¡ã€‚ ç±»åŠ è½½ç›¸å½“äº Class å¯¹è±¡çš„åŠ è½½ã€‚ç±»åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰åŠ¨æ€åŠ è½½åˆ° JVM ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ Class.forName(&quot;com.mysql.jdbc.Driver&quot;) è¿™ç§æ–¹å¼æ¥æ§åˆ¶ç±»çš„åŠ è½½ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Class å¯¹è±¡ã€‚ åå°„å¯ä»¥æä¾›è¿è¡Œæ—¶çš„ç±»ä¿¡æ¯ï¼Œå¹¶ä¸”è¿™ä¸ªç±»å¯ä»¥åœ¨è¿è¡Œæ—¶æ‰åŠ è½½è¿›æ¥ï¼Œç”šè‡³åœ¨ç¼–è¯‘æ—¶æœŸè¯¥ç±»çš„ .class ä¸å­˜åœ¨ä¹Ÿå¯ä»¥åŠ è½½è¿›æ¥ã€‚ Class å’Œ java.lang.reflect ä¸€èµ·å¯¹åå°„æä¾›äº†æ”¯æŒï¼Œjava.lang.reflect ç±»åº“ä¸»è¦åŒ…å«äº†ä»¥ä¸‹ä¸‰ä¸ªç±»: Field : å¯ä»¥ä½¿ç”¨ get() å’Œ set() æ–¹æ³•è¯»å–å’Œä¿®æ”¹ Field å¯¹è±¡å…³è”çš„å­—æ®µï¼› Method : å¯ä»¥ä½¿ç”¨ invoke() æ–¹æ³•è°ƒç”¨ä¸ Method å¯¹è±¡å…³è”çš„æ–¹æ³•ï¼› Constructor : å¯ä»¥ç”¨ Constructor åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚ Advantages of Using Reflection: Extensibility Features : An application may make use of external, user-defined classes by creating instances of extensibility objects using their fully-qualified names. Class Browsers and Visual Development Environments : A class browser needs to be able to enumerate the members of classes. Visual development environments can benefit from making use of type information available in reflection to aid the developer in writing correct code. Debuggers and Test Tools : Debuggers need to be able to examine private members on classes. Test harnesses can make use of reflection to systematically call a discoverable set APIs defined on a class, to insure a high level of code coverage in a test suite. Drawbacks of Reflection: Reflection is powerful, but should not be used indiscriminately. If it is possible to perform an operation without using reflection, then it is preferable to avoid using it. The following concerns should be kept in mind when accessing code via reflection. Performance Overhead : Because reflection involves types that are dynamically resolved, certain Java virtual machine optimizations can not be performed. Consequently, reflective operations have slower performance than their non-reflective counterparts, and should be avoided in sections of code which are called frequently in performance-sensitive applications. Security Restrictions : Reflection requires a runtime permission which may not be present when running under a security manager. This is in an important consideration for code which has to run in a restricted security context, such as in an Applet. Exposure of Internals :Since reflection allows code to perform operations that would be illegal in non-reflective code, such as accessing private fields and methods, the use of reflection can result in unexpected side-effects, which may render code dysfunctional and may destroy portability. Reflective code breaks abstractions and therefore may change behavior with upgrades of the platform. ç›¸å…³æ–‡ç« ï¼šJava åŸºç¡€ - åå°„æœºåˆ¶è¯¦è§£ å¼‚å¸¸Throwable å¯ä»¥ç”¨æ¥è¡¨ç¤ºä»»ä½•å¯ä»¥ä½œä¸ºå¼‚å¸¸æŠ›å‡ºçš„ç±»ï¼Œåˆ†ä¸ºä¸¤ç§: Error å’Œ Exceptionã€‚å…¶ä¸­ Error ç”¨æ¥è¡¨ç¤º JVM æ— æ³•å¤„ç†çš„é”™è¯¯ï¼ŒException åˆ†ä¸ºä¸¤ç§: å—æ£€å¼‚å¸¸ : éœ€è¦ç”¨ try...catch... è¯­å¥æ•è·å¹¶è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥ä»å¼‚å¸¸ä¸­æ¢å¤ï¼› éå—æ£€å¼‚å¸¸ : æ˜¯ç¨‹åºè¿è¡Œæ—¶é”™è¯¯ï¼Œä¾‹å¦‚é™¤ 0 ä¼šå¼•å‘ ArithmeticExceptionï¼Œæ­¤æ—¶ç¨‹åºå´©æºƒå¹¶ä¸”æ— æ³•æ¢å¤ã€‚ ç›¸å…³æ–‡ç« ï¼šJava åŸºç¡€ - å¼‚å¸¸æœºåˆ¶è¯¦è§£ æ³›å‹123456public class Box&lt;T&gt; &#123; // T stands for &quot;Type&quot; private T t; public void set(T t) &#123; this.t = t; &#125; public T get() &#123; return t; &#125;&#125; ç›¸å…³æ–‡ç« ï¼šJava åŸºç¡€ - æ³›å‹æœºåˆ¶è¯¦è§£ æ³¨è§£Java æ³¨è§£æ˜¯é™„åŠ åœ¨ä»£ç ä¸­çš„ä¸€äº›å…ƒä¿¡æ¯ï¼Œç”¨äºä¸€äº›å·¥å…·åœ¨ç¼–è¯‘ã€è¿è¡Œæ—¶è¿›è¡Œè§£æå’Œä½¿ç”¨ï¼Œèµ·åˆ°è¯´æ˜ã€é…ç½®çš„åŠŸèƒ½ã€‚æ³¨è§£ä¸ä¼šä¹Ÿä¸èƒ½å½±å“ä»£ç çš„å®é™…é€»è¾‘ï¼Œä»…ä»…èµ·åˆ°è¾…åŠ©æ€§çš„ä½œç”¨ã€‚ ç›¸å…³æ–‡ç« ï¼šJava åŸºç¡€ - æ³¨è§£æœºåˆ¶è¯¦è§£ ç‰¹æ€§Java å„ç‰ˆæœ¬çš„æ–°ç‰¹æ€§New highlights in Java SE 8 Lambda Expressions Pipelines and Streams Date and Time API Default Methods Type Annotations Nashhorn JavaScript Engine Concurrent Accumulators Parallel operations PermGen Error Removed New highlights in Java SE 7 Strings in Switch Statement Type Inference for Generic Instance Creation Multiple Exception Handling Support for Dynamic Languages Try with Resources Java nio Package Binary Literals, Underscore in literals Diamond Syntax Difference between Java 1.8 and Java 1.7?åœ¨æ–°çª—å£æ‰“å¼€ Java 8 ç‰¹æ€§åœ¨æ–°çª—å£æ‰“å¼€ Java ä¸ C++ çš„åŒºåˆ« Java æ˜¯çº¯ç²¹çš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½ç»§æ‰¿è‡ª java.lang.Objectï¼ŒC++ ä¸ºäº†å…¼å®¹ C å³æ”¯æŒé¢å‘å¯¹è±¡ä¹Ÿæ”¯æŒé¢å‘è¿‡ç¨‹ã€‚ Java é€šè¿‡è™šæ‹Ÿæœºä»è€Œå®ç°è·¨å¹³å°ç‰¹æ€§ï¼Œä½†æ˜¯ C++ ä¾èµ–äºç‰¹å®šçš„å¹³å°ã€‚ Java æ²¡æœ‰æŒ‡é’ˆï¼Œå®ƒçš„å¼•ç”¨å¯ä»¥ç†è§£ä¸ºå®‰å…¨æŒ‡é’ˆï¼Œè€Œ C++ å…·æœ‰å’Œ C ä¸€æ ·çš„æŒ‡é’ˆã€‚ Java æ”¯æŒè‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œè€Œ C++ éœ€è¦æ‰‹åŠ¨å›æ”¶ã€‚ Java ä¸æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œåªèƒ½é€šè¿‡å®ç°å¤šä¸ªæ¥å£æ¥è¾¾åˆ°ç›¸åŒç›®çš„ï¼Œè€Œ C++ æ”¯æŒå¤šé‡ç»§æ‰¿ã€‚ Java ä¸æ”¯æŒæ“ä½œç¬¦é‡è½½ï¼Œè™½ç„¶å¯ä»¥å¯¹ä¸¤ä¸ª String å¯¹è±¡æ”¯æŒåŠ æ³•è¿ç®—ï¼Œä½†æ˜¯è¿™æ˜¯è¯­è¨€å†…ç½®æ”¯æŒçš„æ“ä½œï¼Œä¸å±äºæ“ä½œç¬¦é‡è½½ï¼Œè€Œ C++ å¯ä»¥ã€‚ Java çš„ goto æ˜¯ä¿ç•™å­—ï¼Œä½†æ˜¯ä¸å¯ç”¨ï¼ŒC++ å¯ä»¥ä½¿ç”¨ gotoã€‚ Java ä¸æ”¯æŒæ¡ä»¶ç¼–è¯‘ï¼ŒC++ é€šè¿‡ #ifdef #ifndef ç­‰é¢„å¤„ç†å‘½ä»¤ä»è€Œå®ç°æ¡ä»¶ç¼–è¯‘ã€‚ What are the main differences between Java and C++? JRE or JDK JRE is the JVM program, Java application need to run on JRE. JDK is a superset of JRE, JRE + tools for developing java programs. e.g, it provides the compiler â€œjavacâ€ å‚è€ƒèµ„æ–™ Eckel B. Java ç¼–ç¨‹æ€æƒ³[M]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2002. Bloch J. Effective java[M]. Addison-Wesley Professional, 2017.","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"1.Java åŸºç¡€ - é¢å‘å¯¹è±¡","path":"/2023/12/25/1.Java-åŸºç¡€-é¢å‘å¯¹è±¡/","content":"æœ¬æ–‡ä¸»è¦ä»‹ç»Java OOP é¢å‘å¯¹è±¡åŸºç¡€å’Œç›¸å…³ç±»å›¾ã€‚ ä¸‰å¤§ç‰¹æ€§å°è£…åˆ©ç”¨æŠ½è±¡æ•°æ®ç±»å‹å°†æ•°æ®å’ŒåŸºäºæ•°æ®çš„æ“ä½œå°è£…åœ¨ä¸€èµ·ï¼Œä½¿å…¶æ„æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„ç‹¬ç«‹å®ä½“ã€‚æ•°æ®è¢«ä¿æŠ¤åœ¨æŠ½è±¡æ•°æ®ç±»å‹çš„å†…éƒ¨ï¼Œå°½å¯èƒ½åœ°éšè—å†…éƒ¨çš„ç»†èŠ‚ï¼Œåªä¿ç•™ä¸€äº›å¯¹å¤–æ¥å£ä½¿ä¹‹ä¸å¤–éƒ¨å‘ç”Ÿè”ç³»ã€‚ç”¨æˆ·æ— éœ€çŸ¥é“å¯¹è±¡å†…éƒ¨çš„ç»†èŠ‚ï¼Œä½†å¯ä»¥é€šè¿‡å¯¹è±¡å¯¹å¤–æä¾›çš„æ¥å£æ¥è®¿é—®è¯¥å¯¹è±¡ã€‚ ä¼˜ç‚¹: å‡å°‘è€¦åˆ: å¯ä»¥ç‹¬ç«‹åœ°å¼€å‘ã€æµ‹è¯•ã€ä¼˜åŒ–ã€ä½¿ç”¨ã€ç†è§£å’Œä¿®æ”¹ å‡è½»ç»´æŠ¤çš„è´Ÿæ‹…: å¯ä»¥æ›´å®¹æ˜“è¢«ç¨‹åºå‘˜ç†è§£ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•çš„æ—¶å€™å¯ä»¥ä¸å½±å“å…¶ä»–æ¨¡å— æœ‰æ•ˆåœ°è°ƒèŠ‚æ€§èƒ½: å¯ä»¥é€šè¿‡å‰–æç¡®å®šå“ªäº›æ¨¡å—å½±å“äº†ç³»ç»Ÿçš„æ€§èƒ½ æé«˜è½¯ä»¶çš„å¯é‡ç”¨æ€§ é™ä½äº†æ„å»ºå¤§å‹ç³»ç»Ÿçš„é£é™©: å³ä½¿æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ï¼Œä½†æ˜¯è¿™äº›ç‹¬ç«‹çš„æ¨¡å—å´æœ‰å¯èƒ½æ˜¯å¯ç”¨çš„ ä»¥ä¸‹ Person ç±»å°è£… nameã€genderã€age ç­‰å±æ€§ï¼Œå¤–ç•Œåªèƒ½é€šè¿‡ get() æ–¹æ³•è·å–ä¸€ä¸ª Person å¯¹è±¡çš„ name å±æ€§å’Œ gender å±æ€§ï¼Œè€Œæ— æ³•è·å– age å±æ€§ï¼Œä½†æ˜¯ age å±æ€§å¯ä»¥ä¾› work() æ–¹æ³•ä½¿ç”¨ã€‚ æ³¨æ„åˆ° gender å±æ€§ä½¿ç”¨ int æ•°æ®ç±»å‹è¿›è¡Œå­˜å‚¨ï¼Œå°è£…ä½¿å¾—ç”¨æˆ·æ³¨æ„ä¸åˆ°è¿™ç§å®ç°ç»†èŠ‚ã€‚å¹¶ä¸”åœ¨éœ€è¦ä¿®æ”¹ gender å±æ€§ä½¿ç”¨çš„æ•°æ®ç±»å‹æ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸å½±å“å®¢æˆ·ç«¯ä»£ç çš„æƒ…å†µä¸‹è¿›è¡Œã€‚ 12345678910111213141516171819202122public class Person &#123; private String name; private int gender; private int age; public String getName() &#123; return name; &#125; public String getGender() &#123; return gender == 0 ? &quot;man&quot; : &quot;woman&quot;; &#125; public void work() &#123; if (18 &lt;= age &amp;&amp; age &lt;= 50) &#123; System.out.println(name + &quot; is working very hard!&quot;); &#125; else &#123; System.out.println(name + &quot; can&#x27;t work any more!&quot;); &#125; &#125;&#125; ç»§æ‰¿ç»§æ‰¿å®ç°äº† IS-A å…³ç³»ï¼Œä¾‹å¦‚ Cat å’Œ Animal å°±æ˜¯ä¸€ç§ IS-A å…³ç³»ï¼Œå› æ­¤ Cat å¯ä»¥ç»§æ‰¿è‡ª Animalï¼Œä»è€Œè·å¾— Animal é private çš„å±æ€§å’Œæ–¹æ³•ã€‚ ç»§æ‰¿åº”è¯¥éµå¾ªé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œå­ç±»å¯¹è±¡å¿…é¡»èƒ½å¤Ÿæ›¿æ¢æ‰æ‰€æœ‰çˆ¶ç±»å¯¹è±¡ã€‚ Cat å¯ä»¥å½“åš Animal æ¥ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥ä½¿ç”¨ Animal å¼•ç”¨ Cat å¯¹è±¡ã€‚çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡ç§°ä¸º å‘ä¸Šè½¬å‹ ã€‚ 1Animal animal = new Cat(); å¤šæ€å¤šæ€åˆ†ä¸ºç¼–è¯‘æ—¶å¤šæ€å’Œè¿è¡Œæ—¶å¤šæ€: ç¼–è¯‘æ—¶å¤šæ€ä¸»è¦æŒ‡æ–¹æ³•çš„é‡è½½ è¿è¡Œæ—¶å¤šæ€æŒ‡ç¨‹åºä¸­å®šä¹‰çš„å¯¹è±¡å¼•ç”¨æ‰€æŒ‡å‘çš„å…·ä½“ç±»å‹åœ¨è¿è¡ŒæœŸé—´æ‰ç¡®å®š è¿è¡Œæ—¶å¤šæ€æœ‰ä¸‰ä¸ªæ¡ä»¶: ç»§æ‰¿ è¦†ç›–(é‡å†™) å‘ä¸Šè½¬å‹ ä¸‹é¢çš„ä»£ç ä¸­ï¼Œä¹å™¨ç±»(Instrument)æœ‰ä¸¤ä¸ªå­ç±»: Wind å’Œ Percussionï¼Œå®ƒä»¬éƒ½è¦†ç›–äº†çˆ¶ç±»çš„ play() æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨ main() æ–¹æ³•ä¸­ä½¿ç”¨çˆ¶ç±» Instrument æ¥å¼•ç”¨ Wind å’Œ Percussion å¯¹è±¡ã€‚åœ¨ Instrument å¼•ç”¨è°ƒç”¨ play() æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œå®é™…å¼•ç”¨å¯¹è±¡æ‰€åœ¨ç±»çš„ play() æ–¹æ³•ï¼Œè€Œä¸æ˜¯ Instrument ç±»çš„æ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728public class Instrument &#123; public void play() &#123; System.out.println(&quot;Instrument is playing...&quot;); &#125;&#125;public class Wind extends Instrument &#123; public void play() &#123; System.out.println(&quot;Wind is playing...&quot;); &#125;&#125;public class Percussion extends Instrument &#123; public void play() &#123; System.out.println(&quot;Percussion is playing...&quot;); &#125;&#125;public class Music &#123; public static void main(String[] args) &#123; List&lt;Instrument&gt; instruments = new ArrayList&lt;&gt;(); instruments.add(new Wind()); instruments.add(new Percussion()); for(Instrument instrument : instruments) &#123; instrument.play(); &#125; &#125;&#125; ç±»å›¾ä»¥ä¸‹ç±»å›¾ä½¿ç”¨ PlantUMLåœ¨æ–°çª—å£æ‰“å¼€ ç»˜åˆ¶ï¼Œæ›´å¤šè¯­æ³•åŠä½¿ç”¨è¯·å‚è€ƒ: http://plantuml.com/ ã€‚ æ³›åŒ–å…³ç³» (Generalization)ç”¨æ¥æè¿°ç»§æ‰¿å…³ç³»ï¼Œåœ¨ Java ä¸­ä½¿ç”¨ extends å…³é”®å­—ã€‚ 123456789101112@startumltitle Generalizationclass Vehicalclass Carclass TruckVehical &lt;|-- CarVehical &lt;|-- Truck@enduml å®ç°å…³ç³» (Realization)ç”¨æ¥å®ç°ä¸€ä¸ªæ¥å£ï¼Œåœ¨ Java ä¸­ä½¿ç”¨ implements å…³é”®å­—ã€‚ 123456789101112@startumltitle Realizationinterface MoveBehaviorclass Flyclass RunMoveBehavior &lt;|.. FlyMoveBehavior &lt;|.. Run@enduml èšåˆå…³ç³» (Aggregation)è¡¨ç¤ºæ•´ä½“ç”±éƒ¨åˆ†ç»„æˆï¼Œä½†æ˜¯æ•´ä½“å’Œéƒ¨åˆ†ä¸æ˜¯å¼ºä¾èµ–çš„ï¼Œæ•´ä½“ä¸å­˜åœ¨äº†éƒ¨åˆ†è¿˜æ˜¯ä¼šå­˜åœ¨ã€‚ 1234567891011121314@startumltitle Aggregationclass Computerclass Keyboardclass Mouseclass ScreenComputer o-- KeyboardComputer o-- MouseComputer o-- Screen@enduml ç»„åˆå…³ç³» (Composition)å’Œèšåˆä¸åŒï¼Œç»„åˆä¸­æ•´ä½“å’Œéƒ¨åˆ†æ˜¯å¼ºä¾èµ–çš„ï¼Œæ•´ä½“ä¸å­˜åœ¨äº†éƒ¨åˆ†ä¹Ÿä¸å­˜åœ¨äº†ã€‚æ¯”å¦‚å…¬å¸å’Œéƒ¨é—¨ï¼Œå…¬å¸æ²¡äº†éƒ¨é—¨å°±ä¸å­˜åœ¨äº†ã€‚ä½†æ˜¯å…¬å¸å’Œå‘˜å·¥å°±å±äºèšåˆå…³ç³»äº†ï¼Œå› ä¸ºå…¬å¸æ²¡äº†å‘˜å·¥è¿˜åœ¨ã€‚ 123456789101112@startumltitle Compositionclass Companyclass DepartmentAclass DepartmentBCompany *-- DepartmentACompany *-- DepartmentB@enduml å…³è”å…³ç³» (Association)è¡¨ç¤ºä¸åŒç±»å¯¹è±¡ä¹‹é—´æœ‰å…³è”ï¼Œè¿™æ˜¯ä¸€ç§é™æ€å…³ç³»ï¼Œä¸è¿è¡Œè¿‡ç¨‹çš„çŠ¶æ€æ— å…³ï¼Œåœ¨æœ€å¼€å§‹å°±å¯ä»¥ç¡®å®šã€‚å› æ­¤ä¹Ÿå¯ä»¥ç”¨ 1 å¯¹ 1ã€å¤šå¯¹ 1ã€å¤šå¯¹å¤šè¿™ç§å…³è”å…³ç³»æ¥è¡¨ç¤ºã€‚æ¯”å¦‚å­¦ç”Ÿå’Œå­¦æ ¡å°±æ˜¯ä¸€ç§å…³è”å…³ç³»ï¼Œä¸€ä¸ªå­¦æ ¡å¯ä»¥æœ‰å¾ˆå¤šå­¦ç”Ÿï¼Œä½†æ˜¯ä¸€ä¸ªå­¦ç”Ÿåªå±äºä¸€ä¸ªå­¦æ ¡ï¼Œå› æ­¤è¿™æ˜¯ä¸€ç§å¤šå¯¹ä¸€çš„å…³ç³»ï¼Œåœ¨è¿è¡Œå¼€å§‹ä¹‹å‰å°±å¯ä»¥ç¡®å®šã€‚ 12345678910@startumltitle Associationclass Schoolclass StudentSchool &quot;1&quot; - &quot;n&quot; Student@enduml ä¾èµ–å…³ç³» (Dependency)å’Œå…³è”å…³ç³»ä¸åŒçš„æ˜¯ï¼Œä¾èµ–å…³ç³»æ˜¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­èµ·ä½œç”¨çš„ã€‚A ç±»å’Œ B ç±»æ˜¯ä¾èµ–å…³ç³»ä¸»è¦æœ‰ä¸‰ç§å½¢å¼: A ç±»æ˜¯ B ç±»ä¸­çš„(æŸä¸­æ–¹æ³•çš„)å±€éƒ¨å˜é‡ï¼› A ç±»æ˜¯ B ç±»æ–¹æ³•å½“ä¸­çš„ä¸€ä¸ªå‚æ•°ï¼› A ç±»å‘ B ç±»å‘é€æ¶ˆæ¯ï¼Œä»è€Œå½±å“ B ç±»å‘ç”Ÿå˜åŒ–ï¼› 12345678910111213141516171819@startumltitle Dependencyclass Vehicle &#123; move(MoveBehavior)&#125;interface MoveBehavior &#123; move()&#125;note &quot;MoveBehavior.move()&quot; as NVehicle ..&gt; MoveBehaviorVehicle .. N@enduml # å‚è€ƒèµ„æ–™ Java ç¼–ç¨‹æ€æƒ³ æ•æ·è½¯ä»¶å¼€å‘: åŸåˆ™ã€æ¨¡å¼ä¸å®è·µ é¢å‘å¯¹è±¡è®¾è®¡çš„ SOLID åŸåˆ™åœ¨æ–°çª—å£æ‰“å¼€ çœ‹æ‡‚ UML ç±»å›¾å’Œæ—¶åºå›¾åœ¨æ–°çª—å£æ‰“å¼€ UML ç³»åˆ—â€”â€”æ—¶åºå›¾(é¡ºåºå›¾)sequence diagramåœ¨æ–°çª—å£æ‰“å¼€ é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸‰å¤§ç‰¹æ€§ â€”â€” å°è£…ã€ç»§æ‰¿ã€å¤šæ€åœ¨æ–°çª—å£æ‰“å¼€ javaoopåŸºç¡€çŸ¥è¯†æ€»ç»“ https://blog.csdn.net/weixin_38173324/article/details/70037927 Javaå®ç°OOP(é¢å‘å¯¹è±¡ç¼–ç¨‹) https://www.cnblogs.com/AlanLee/p/6475334.html Java æŠ½è±¡ç±»ä¸oopä¸‰å¤§ç‰¹å¾ http://www.cnblogs.com/wujing-hubei/p/6012105.html","tags":["Java","JavaåŸºç¡€"],"categories":["Java","JavaåŸºç¡€"]},{"title":"Spring Boot æ— ä¾µå…¥å¼ å®ç° API æ¥å£ç»Ÿä¸€ JSON æ ¼å¼è¿”å›","path":"/2023/12/25/Spring-Boot-æ— ä¾µå…¥å¼-å®ç°-API-æ¥å£ç»Ÿä¸€-JSON-æ ¼å¼è¿”å›/","content":"æ— ä¾µå…¥å¼ ç»Ÿä¸€è¿”å›JSONæ ¼å¼å…¶å®æœ¬æ²¡æœ‰æ²¡æ‰“ç®—å†™è¿™ç¯‡åšå®¢çš„ï¼Œä½†è¿˜æ˜¯è¦å†™ä¸€ä¸‹å†™è¿™ç¯‡åšå®¢çš„èµ·å› æ˜¯å› ä¸ºï¼Œç°åœ¨å‘†ç€çš„è¿™å®¶å…¬å¸å±…ç„¶æ²¡æœ‰ç»Ÿä¸€çš„APIè¿”å›æ ¼å¼?ï¼Œè¯¢é—®ä¸»ç®¡ä»–å±…ç„¶å‘Šè¯‰æˆ‘ç”¨HTTPçŠ¶æ€ç å°±å¤Ÿç”¨äº†ï¼ˆfxxkï¼‰ï¼Œå¤©å“ªHTTPçŠ¶æ€ç çœŸçš„å¤Ÿç”¨å—ï¼Ÿ åœ¨ä»”ç»†çš„é˜…è¯»äº†é¡¹ç›®æºç åå‘ç°ï¼Œåœ¨APIè¯·æ±‚çš„æ˜¯å±…ç„¶æ²¡æœ‰ä¸šåŠ¡å¼‚å¸¸ï¼ˆé»‘äººé—®å¥½ï¼‰ã€‚å¥½å§ å±…ç„¶å…¥å‘äº†åªèƒ½éµç…§é¡¹ç›®é£æ ¼äº†ï¼Œæ‡’å¾—åæ§½äº†ã€‚ å› ä¸ºé¡¹ç›®å·²ç»å¼€å‘äº†åŠå¹´å¤šäº†, è¦æ˜¯å…¨éƒ¨æ¥å£éƒ½åšä¿®æ”¹å·¥ä½œé‡è¿˜æ˜¯æŒºå¤§çš„, åªèƒ½ç”¨è¿™ç§æ— ä¾µå…¥å¼çš„æ–¹æ¡ˆæ¥è§£å†³. é¡¹ç›®æºä»£ç : https://github.com/469753862/galaxy-blogs/tree/master/code/responseResult å®šä¹‰JSONæ ¼å¼å®šä¹‰è¿”å›JSONæ ¼å¼åç«¯è¿”å›ç»™å‰ç«¯ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨JSONæ ¼å¼, å®šä¹‰å¦‚ä¸‹ 1234567&#123; &quot;code&quot;: 200, &quot;message&quot;: &quot;OK&quot;, &quot;data&quot;: &#123; &#125;&#125; code: è¿”å›çŠ¶æ€ç  message: è¿”å›ä¿¡æ¯çš„æè¿° data: è¿”å›å€¼ å®šä¹‰JavaBeanå­—æ®µå®šä¹‰çŠ¶æ€ç æšä¸¾ç±»123456789101112131415161718192021@ToString@Getterpublic enum ResultStatus &#123; SUCCESS(HttpStatus.OK, 200, &quot;OK&quot;), BAD_REQUEST(HttpStatus.BAD_REQUEST, 400, &quot;Bad Request&quot;), INTERNAL_SERVER_ERROR(HttpStatus.INTERNAL_SERVER_ERROR, 500, &quot;Internal Server Error&quot;),; /** è¿”å›çš„HTTPçŠ¶æ€ç , ç¬¦åˆhttpè¯·æ±‚ */ private HttpStatus httpStatus; /** ä¸šåŠ¡å¼‚å¸¸ç  */ private Integer code; /** ä¸šåŠ¡å¼‚å¸¸ä¿¡æ¯æè¿° */ private String message; ResultStatus(HttpStatus httpStatus, Integer code, String message) &#123; this.httpStatus = httpStatus; this.code = code; this.message = message; &#125;&#125; çŠ¶æ€ç å’Œä¿¡æ¯ä»¥åŠhttpçŠ¶æ€ç å°±èƒ½ä¸€ä¸€å¯¹åº”äº†ä¾¿äºç»´æŠ¤, æœ‰åŒå­¦æœ‰ç–‘é—®äº†ä¸ºä»€ä¹ˆè¦ç”¨åˆ°httpçŠ¶æ€ç å‘€,å› ä¸ºæˆ‘è¦å…¼å®¹é¡¹ç›®ä»¥å‰çš„ä»£ç , æ²¡æœ‰å…¶ä»–åŸå› , å½“ç„¶å…¶ä»–åŒå­¦ä¸å–œæ¬¢httpçŠ¶æ€ç çš„å¯ä»¥å§æºç ä¸­HttpStatusç»™åˆ é™¤äº† å®šä¹‰è¿”å›ä½“ç±»12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152@Getter@ToStringpublic class Result&lt;T&gt; &#123; /** ä¸šåŠ¡é”™è¯¯ç  */ private Integer code; /** ä¿¡æ¯æè¿° */ private String message; /** è¿”å›å‚æ•° */ private T data; private Result(ResultStatus resultStatus, T data) &#123; this.code = resultStatus.getCode(); this.message = resultStatus.getMessage(); this.data = data; &#125; /** ä¸šåŠ¡æˆåŠŸè¿”å›ä¸šåŠ¡ä»£ç å’Œæè¿°ä¿¡æ¯ */ public static Result&lt;Void&gt; success() &#123; return new Result&lt;Void&gt;(ResultStatus.SUCCESS, null); &#125; /** ä¸šåŠ¡æˆåŠŸè¿”å›ä¸šåŠ¡ä»£ç ,æè¿°å’Œè¿”å›çš„å‚æ•° */ public static &lt;T&gt; Result&lt;T&gt; success(T data) &#123; return new Result&lt;T&gt;(ResultStatus.SUCCESS, data); &#125; /** ä¸šåŠ¡æˆåŠŸè¿”å›ä¸šåŠ¡ä»£ç ,æè¿°å’Œè¿”å›çš„å‚æ•° */ public static &lt;T&gt; Result&lt;T&gt; success(ResultStatus resultStatus, T data) &#123; if (resultStatus == null) &#123; return success(data); &#125; return new Result&lt;T&gt;(resultStatus, data); &#125; /** ä¸šåŠ¡å¼‚å¸¸è¿”å›ä¸šåŠ¡ä»£ç å’Œæè¿°ä¿¡æ¯ */ public static &lt;T&gt; Result&lt;T&gt; failure() &#123; return new Result&lt;T&gt;(ResultStatus.INTERNAL_SERVER_ERROR, null); &#125; /** ä¸šåŠ¡å¼‚å¸¸è¿”å›ä¸šåŠ¡ä»£ç ,æè¿°å’Œè¿”å›çš„å‚æ•° */ public static &lt;T&gt; Result&lt;T&gt; failure(ResultStatus resultStatus) &#123; return failure(resultStatus, null); &#125; /** ä¸šåŠ¡å¼‚å¸¸è¿”å›ä¸šåŠ¡ä»£ç ,æè¿°å’Œè¿”å›çš„å‚æ•° */ public static &lt;T&gt; Result&lt;T&gt; failure(ResultStatus resultStatus, T data) &#123; if (resultStatus == null) &#123; return new Result&lt;T&gt;(ResultStatus.INTERNAL_SERVER_ERROR, null); &#125; return new Result&lt;T&gt;(resultStatus, data); &#125;&#125; å› ä¸ºä½¿ç”¨æ„é€ æ–¹æ³•è¿›è¡Œåˆ›å»ºå¯¹è±¡å¤ªéº»çƒ¦äº†, æˆ‘ä»¬ä½¿ç”¨é™æ€æ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡è¿™æ ·ç®€å•æ˜äº† Resultå®ä½“è¿”å›æµ‹è¯•1234567891011121314151617181920212223@RestController@RequestMapping(&quot;/hello&quot;)public class HelloController &#123; private static final HashMap&lt;String, Object&gt; INFO; static &#123; INFO = new HashMap&lt;&gt;(); INFO.put(&quot;name&quot;, &quot;galaxy&quot;); INFO.put(&quot;age&quot;, &quot;70&quot;); &#125; @GetMapping(&quot;/hello&quot;) public Map&lt;String, Object&gt; hello() &#123; return INFO; &#125; @GetMapping(&quot;/result&quot;) @ResponseBody public Result&lt;Map&lt;String, Object&gt;&gt; helloResult() &#123; return Result.success(INFO); &#125;&#125; åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»ç®€å•çš„å®ç°äº†ç»Ÿä¸€JSONæ ¼å¼äº†, ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå‘ç°äº†ä¸€ä¸ªé—®é¢˜äº†,æƒ³è¦è¿”å›ç»Ÿä¸€çš„JSONæ ¼å¼éœ€è¦è¿”å›Result&lt;Object&gt;æ‰å¯ä»¥, æˆ‘æ˜æ˜è¿”å›Objectå¯ä»¥äº†, ä¸ºä»€ä¹ˆè¦é‡å¤åŠ³åŠ¨, æœ‰æ²¡æœ‰è§£å†³æ–¹æ³•, å½“ç„¶æ˜¯æœ‰çš„å•¦, ä¸‹é¢æˆ‘ä»¬å¼€å§‹ä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç å§ ç»Ÿä¸€è¿”å›JSONæ ¼å¼è¿›é˜¶-å…¨å±€å¤„ç†(@RestControllerAdvice)æˆ‘å¸ˆå‚…ç»å¸¸å‘Šè¯‰æˆ‘çš„ä¸€å¥è¯: â€œä½ å°±æ˜¯ä¸€ä¸ªå°å±å­©, ä½ é‡åˆ°çš„é—®é¢˜éƒ½å·²ç»ä¸çŸ¥é“æœ‰å¤šå°‘äººé‡åˆ°è¿‡äº†, ä½ ä¼šæƒ³åˆ°çš„é—®é¢˜, å·²ç»æœ‰å‰è¾ˆæƒ³åˆ°è¿‡äº†. ä½ å‡†å¤‡è§£å†³çš„é—®é¢˜, å·²ç»æœ‰äººæŠŠå‘å¡«äº†â€ã€‚æ˜¯ä¸æ˜¯å¾ˆé¸¡æ±¤, æ˜¯ä¸æ˜¯å¾ˆåŠ±å¿—, è®©æˆ‘å¯¹å‰è¾ˆä»¬å……æ»¡ç€å´‡æ‹œ, äº‹å®ä¸Šä»–å¯¹æˆ‘è¯´çš„æ˜¯: â€œè‡ªå·±å»ç™¾åº¦â€, è¿™äº”ä¸ªå¤§å­—, å…¶å®è¿™äº”ä¸ªå¤§å­—å·²ç»è¯´æ˜ä¸Šæ˜çš„Bè¯äº†, é€šè¿‡ä¸æ–­çš„ç™¾åº¦å’ŒGoogleå‘ç°äº†å¾ˆå¤šçš„è§£å†³æ–¹æ¡ˆ. æˆ‘ä»¬éƒ½çŸ¥é“ä½¿ç”¨@ResponseBodyæ³¨è§£ä¼šæŠŠè¿”å›Objectåºåˆ—åŒ–æˆJSONå­—ç¬¦ä¸²,å°±å…ˆä»è¿™ä¸ªå…¥æ‰‹å§, å¤§è‡´å°±æ˜¯åœ¨åºåˆ—åŒ–å‰æŠŠObjectèµ‹å€¼ç»™Result&lt;Object&gt;å°±å¯ä»¥äº†, å¤§å®¶å¯ä»¥è§‚æ‘©org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdviceå’Œorg.springframework.web.bind.annotation.ResponseBody @ResponseBodyç»§æ‰¿ç±»æˆ‘ä»¬å·²ç»å†³å®šä»@ResponseBodyæ³¨è§£å…¥æ‰‹äº†å°±åˆ›å»ºä¸€ä¸ªæ³¨è§£ç±»ç»§æ‰¿@ResponseBody, å¾ˆå¹²å‡€ä»€ä¹ˆéƒ½æ²¡æœ‰å“ˆå“ˆ,@ResponseResultBody å¯ä»¥æ ‡è®°åœ¨ç±»å’Œæ–¹æ³•ä¸Šè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·Ÿè‡ªç”±çš„è¿›è¡Œä½¿ç”¨äº† 1234567@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)@Documented@ResponseBodypublic @interface ResponseResultBody &#123;&#125; ResponseBodyAdviceç»§æ‰¿ç±»12345678910111213141516171819202122232425@RestControllerAdvicepublic class ResponseResultBodyAdvice implements ResponseBodyAdvice&lt;Object&gt; &#123; private static final Class&lt;? extends Annotation&gt; ANNOTATION_TYPE = ResponseResultBody.class; /** * åˆ¤æ–­ç±»æˆ–è€…æ–¹æ³•æ˜¯å¦ä½¿ç”¨äº† @ResponseResultBody */ @Override public boolean supports(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType) &#123; return AnnotatedElementUtils.hasAnnotation(returnType.getContainingClass(), ANNOTATION_TYPE) || returnType.hasMethodAnnotation(ANNOTATION_TYPE); &#125; /** * å½“ç±»æˆ–è€…æ–¹æ³•ä½¿ç”¨äº† @ResponseResultBody å°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³• */ @Override public Object beforeBodyWrite(Object body, MethodParameter returnType, MediaType selectedContentType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType, ServerHttpRequest request, ServerHttpResponse response) &#123; // é˜²æ­¢é‡å¤åŒ…è£¹çš„é—®é¢˜å‡ºç° if (body instanceof Result) &#123; return body; &#125; return Result.success(body); &#125;&#125; RestControllerAdviceè¿”å›æµ‹è¯•12345678910111213141516171819202122232425262728293031323334@RestController@RequestMapping(&quot;/helloResult&quot;)@ResponseResultBodypublic class HelloResultController &#123; private static final HashMap&lt;String, Object&gt; INFO; static &#123; INFO = new HashMap&lt;String, Object&gt;(); INFO.put(&quot;name&quot;, &quot;galaxy&quot;); INFO.put(&quot;age&quot;, &quot;70&quot;); &#125; @GetMapping(&quot;hello&quot;) public HashMap&lt;String, Object&gt; hello() &#123; return INFO; &#125; /** æµ‹è¯•é‡å¤åŒ…è£¹ */ @GetMapping(&quot;result&quot;) public Result&lt;Map&lt;String, Object&gt;&gt; helloResult() &#123; return Result.success(INFO); &#125; @GetMapping(&quot;helloError&quot;) public HashMap&lt;String, Object&gt; helloError() throws Exception &#123; throw new Exception(&quot;helloError&quot;); &#125; @GetMapping(&quot;helloMyError&quot;) public HashMap&lt;String, Object&gt; helloMyError() throws Exception &#123; throw new ResultException(); &#125;&#125; æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡, ç›´æ¥è¿”å›Objectå°±å¯ä»¥ç»Ÿä¸€JSONæ ¼å¼äº†, å°±ä¸ç”¨æ¯ä¸ªè¿”å›éƒ½è¿”å›Result&lt;T&gt;å¯¹è±¡äº†,ç›´æ¥è®©SpringMVCå¸®åŠ©æˆ‘ä»¬è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†, ç®€ç›´å®Œç¾ åªæƒ³çœ‹æ¥å£å“¦, helloErrorå’ŒhelloMyErroræ˜¯ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸çš„æ¥å£,æˆ‘å¥½åƒæ²¡æœ‰å¯¹å¼‚å¸¸è¿”å›è¿›è¡Œç»Ÿä¸€çš„å¤„ç†å“¦ ç»Ÿä¸€è¿”å›JSONæ ¼å¼è¿›é˜¶-å¼‚å¸¸å¤„ç†(@ExceptionHandler))å§æ§½, å¼‚å¸¸å¤„ç†, å·®ç‚¹æŠŠè¿™èŒ¬ç»™å¿˜äº†, è¿™ä¸ªå¼‚å¸¸å¤„ç†å°±æœ‰å¾ˆå¤šæ–¹æ³•äº†,å…ˆçœ‹çœ‹æˆ‘å¸ˆå‚…çš„å¤„ç†æ–¹å¼, æˆ‘åˆšæ‹¿åˆ°è¿™ä¸ªä»£ç çš„æ—¶å€™å¾ˆæƒ³åæ§½, å¯¹å¼‚å¸¸ç±»çš„å¤„ç†è¿™ä¹ˆæ®‹æš´çš„å—, ç›´æ¥ç”¨PrintWriterç›´æ¥è¾“å‡ºç»“æœ, æœç„¶æ˜¯è€å¸ˆå‚…, æˆ‘è¦æ˜¯æœ‰100ä¸ªå¼‚å¸¸ç±», ä¸å¾—è¦å†™100ä¸ª if elseäº†. èµ¶ç´§æ”¹æ”¹ç¡å§ 1234567891011121314151617181920212223242526272829@Configurationpublic class MyExceptionHandler implements HandlerExceptionResolver &#123; public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) &#123; PrintWriter out = getPrintWrite(response); if (ex instanceof XXXException) &#123; out.write(JsonUtil.formatJson(ResultEnum.PAY_ERROR.getCode(), ex.getMessage())); &#125; else &#123; out.write(JsonUtil.formatJson(ResultEnum.FAIL.getCode(), &quot;æœåŠ¡å™¨å¼‚å¸¸&quot;)); &#125; if (null != out) &#123; out.close(); &#125; return mav; &#125; private PrintWriter getPrintWrite(HttpServletResponse response) &#123; PrintWriter out = null; try &#123; response.setHeader(&quot;Content-type&quot;, &quot;text/html;charset=UTF-8&quot;); response.setCharacterEncoding(&quot;UTF-8&quot;); out = response.getWriter(); &#125; catch (IOException e) &#123; log.error(&quot;PrintWriter is exception&quot;, e); &#125; return out; &#125;&#125; ä¸Šé¢çš„ä»£ç çœ‹çœ‹è¿˜æ˜¯æ²¡æœ‰é—®é¢˜çš„, åˆ«å­¦è¿‡å»å“¦, å¼‚å¸¸å¤„ç†@ResponseStatus(ä¸æ¨è)@ResponseStatusç”¨æ³•å¦‚ä¸‹,å¯ç”¨åœ¨Controllerç±»å’ŒControlleræ–¹æ³•ä¸Šä»¥åŠExceptionç±»ä¸Šä½†æ˜¯è¿™æ ·çš„å·¥ä½œé‡è¿˜æ˜¯æŒºå¤§çš„ 12345678910111213141516171819202122232425262728293031323334@RestController@RequestMapping(&quot;/error&quot;)@ResponseStatus(value = HttpStatus.INTERNAL_SERVER_ERROR, reason = &quot;Javaçš„å¼‚å¸¸&quot;)public class HelloExceptionController &#123; private static final HashMap&lt;String, Object&gt; INFO; static &#123; INFO = new HashMap&lt;String, Object&gt;(); INFO.put(&quot;name&quot;, &quot;galaxy&quot;); INFO.put(&quot;age&quot;, &quot;70&quot;); &#125; @GetMapping() public HashMap&lt;String, Object&gt; helloError() throws Exception &#123; throw new Exception(&quot;helloError&quot;); &#125; @GetMapping(&quot;helloJavaError&quot;) @ResponseStatus(value = HttpStatus.INTERNAL_SERVER_ERROR, reason = &quot;Javaçš„å¼‚å¸¸&quot;) public HashMap&lt;String, Object&gt; helloJavaError() throws Exception &#123; throw new Exception(&quot;helloError&quot;); &#125; @GetMapping(&quot;helloMyError&quot;) public HashMap&lt;String, Object&gt; helloMyError() throws Exception &#123; throw new MyException(); &#125;&#125;@ResponseStatus(value = HttpStatus.INTERNAL_SERVER_ERROR, reason = &quot;è‡ªå·±å®šä¹‰çš„å¼‚å¸¸&quot;)class MyException extends Exception &#123;&#125; å…¨å±€å¼‚å¸¸å¤„ç†@ExceptionHandler(æ¨è)æŠŠResponseResultBodyAdviceç±»è¿›è¡Œæ”¹é€ ä¸€ä¸‹,ä»£ç æœ‰ç‚¹å¤šäº† ä¸»è¦å‚è€ƒäº†org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler#handleException()æ–¹æ³•, æœ‰ç©ºå¯ä»¥çœ‹ä¸€ä¸‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970@Slf4j@RestControllerAdvicepublic class ResponseResultBodyAdvice implements ResponseBodyAdvice&lt;Object&gt; &#123; private static final Class&lt;? extends Annotation&gt; ANNOTATION_TYPE = ResponseResultBody.class; /** åˆ¤æ–­ç±»æˆ–è€…æ–¹æ³•æ˜¯å¦ä½¿ç”¨äº† @ResponseResultBody */ @Override public boolean supports(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType) &#123; return AnnotatedElementUtils.hasAnnotation(returnType.getContainingClass(), ANNOTATION_TYPE) || returnType.hasMethodAnnotation(ANNOTATION_TYPE); &#125; /** å½“ç±»æˆ–è€…æ–¹æ³•ä½¿ç”¨äº† @ResponseResultBody å°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³• */ @Override public Object beforeBodyWrite(Object body, MethodParameter returnType, MediaType selectedContentType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType, ServerHttpRequest request, ServerHttpResponse response) &#123; if (body instanceof Result) &#123; return body; &#125; return Result.success(body); &#125; /** * æä¾›å¯¹æ ‡å‡†Spring MVCå¼‚å¸¸çš„å¤„ç† * * @param ex the target exception * @param request the current request */ @ExceptionHandler(Exception.class) public final ResponseEntity&lt;Result&lt;?&gt;&gt; exceptionHandler(Exception ex, WebRequest request) &#123; log.error(&quot;ExceptionHandler: &#123;&#125;&quot;, ex.getMessage()); HttpHeaders headers = new HttpHeaders(); if (ex instanceof ResultException) &#123; return this.handleResultException((ResultException) ex, headers, request); &#125; // TODO: 2019/10/05 galaxy è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰å…¶ä»–çš„å¼‚å¸¸æ‹¦æˆª return this.handleException(ex, headers, request); &#125; /** å¯¹ResultExceptionç±»è¿”å›è¿”å›ç»“æœçš„å¤„ç† */ protected ResponseEntity&lt;Result&lt;?&gt;&gt; handleResultException(ResultException ex, HttpHeaders headers, WebRequest request) &#123; Result&lt;?&gt; body = Result.failure(ex.getResultStatus()); HttpStatus status = ex.getResultStatus().getHttpStatus(); return this.handleExceptionInternal(ex, body, headers, status, request); &#125; /** å¼‚å¸¸ç±»çš„ç»Ÿä¸€å¤„ç† */ protected ResponseEntity&lt;Result&lt;?&gt;&gt; handleException(Exception ex, HttpHeaders headers, WebRequest request) &#123; Result&lt;?&gt; body = Result.failure(); HttpStatus status = HttpStatus.INTERNAL_SERVER_ERROR; return this.handleExceptionInternal(ex, body, headers, status, request); &#125; /** * org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler#handleExceptionInternal(java.lang.Exception, java.lang.Object, org.springframework.http.HttpHeaders, org.springframework.http.HttpStatus, org.springframework.web.context.request.WebRequest) * &lt;p&gt; * A single place to customize the response body of all exception types. * &lt;p&gt;The default implementation sets the &#123;@link WebUtils#ERROR_EXCEPTION_ATTRIBUTE&#125; * request attribute and creates a &#123;@link ResponseEntity&#125; from the given * body, headers, and status. */ protected ResponseEntity&lt;Result&lt;?&gt;&gt; handleExceptionInternal( Exception ex, Result&lt;?&gt; body, HttpHeaders headers, HttpStatus status, WebRequest request) &#123; if (HttpStatus.INTERNAL_SERVER_ERROR.equals(status)) &#123; request.setAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE, ex, WebRequest.SCOPE_REQUEST); &#125; return new ResponseEntity&lt;&gt;(body, headers, status); &#125;&#125;","tags":["æ¡†æ¶","Spring","åˆ†å¸ƒå¼","å¾®æœåŠ¡","SpringBoot"],"categories":["æ¡†æ¶","Spring","SpringBoot"]},{"title":"Redis åˆ†å¸ƒå¼é”ä½¿ç”¨ä¸å½“ï¼Œé…¿æˆä¸€ä¸ªé‡å¤§äº‹æ•…","path":"/2023/12/25/Redis-åˆ†å¸ƒå¼é”ä½¿ç”¨ä¸å½“ï¼Œé…¿æˆä¸€ä¸ªé‡å¤§äº‹æ•…/","content":"åŸºäºRedisä½¿ç”¨åˆ†å¸ƒå¼é”åœ¨å½“ä»Šå·²ç»ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹äº†ã€‚ æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯åŸºäºæˆ‘ä»¬å®é™…é¡¹ç›®ä¸­å› ä¸ºredisåˆ†å¸ƒå¼é”é€ æˆçš„äº‹æ•…åˆ†æåŠè§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬é¡¹ç›®ä¸­çš„æŠ¢è´­è®¢å•é‡‡ç”¨çš„æ˜¯åˆ†å¸ƒå¼é”æ¥è§£å†³çš„ï¼Œæœ‰ä¸€æ¬¡ï¼Œè¿è¥åšäº†ä¸€ä¸ªé£å¤©èŒ…å°çš„æŠ¢è´­æ´»åŠ¨ï¼Œåº“å­˜100ç“¶ï¼Œä½†æ˜¯å´è¶…å–äº†100ç“¶ï¼è¦çŸ¥é“ï¼Œè¿™ä¸ªåœ°çƒä¸Šé£å¤©èŒ…å°çš„ç¨€ç¼ºæ€§å•Šï¼ï¼ï¼ äº‹æ•…å®šä¸ºP0çº§é‡å¤§äº‹æ•…â€¦åªèƒ½å¦ç„¶æ¥å—ã€‚æ•´ä¸ªé¡¹ç›®ç»„è¢«æ‰£ç»©æ•ˆäº†~~äº‹æ•…å‘ç”Ÿåï¼ŒCTOæŒ‡åç‚¹å§“è®©æˆ‘å¸¦å¤´å†²é”‹æ¥å¤„ç†ã€‚ å¥½å§ï¼Œå†²~ äº‹æ•…ç°åœºç»è¿‡ä¸€ç•ªäº†è§£åï¼Œå¾—çŸ¥è¿™ä¸ªæŠ¢è´­æ´»åŠ¨æ¥å£ä»¥å‰ä»æ¥æ²¡æœ‰å‡ºç°è¿‡è¿™ç§æƒ…å†µï¼Œä½†æ˜¯è¿™æ¬¡ä¸ºä»€ä¹ˆä¼šè¶…å–å‘¢ï¼Ÿ åŸå› åœ¨äºï¼šä¹‹å‰çš„æŠ¢è´­å•†å“éƒ½ä¸æ˜¯ä»€ä¹ˆç¨€ç¼ºæ€§å•†å“ï¼Œè€Œè¿™æ¬¡æ´»åŠ¨å±…ç„¶æ˜¯é£å¤©èŒ…å°ï¼Œé€šè¿‡åŸ‹ç‚¹æ•°æ®åˆ†æï¼Œå„é¡¹æ•°æ®åŸºæœ¬éƒ½æ˜¯æˆå€å¢é•¿ï¼Œæ´»åŠ¨çƒ­çƒˆç¨‹åº¦å¯æƒ³è€ŒçŸ¥ï¼è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šæ ¸å¿ƒä»£ç ï¼Œæœºå¯†éƒ¨åˆ†åšäº†ä¼ªä»£ç å¤„ç†ã€‚ã€‚ã€‚ 12345678910111213141516171819202122232425262728public SeckillActivityRequestVO seckillHandle(SeckillActivityRequestVO request) &#123; SeckillActivityRequestVO response; String key = &quot;key:&quot; + request.getSeckillId; try &#123; Boolean lockFlag = redisTemplate.opsForValue().setIfAbsent(key, &quot;val&quot;, 10, TimeUnit.SECONDS); if (lockFlag) &#123; // HTTPè¯·æ±‚ç”¨æˆ·æœåŠ¡è¿›è¡Œç”¨æˆ·ç›¸å…³çš„æ ¡éªŒ // ç”¨æˆ·æ´»åŠ¨æ ¡éªŒ // åº“å­˜æ ¡éªŒ Object stock = redisTemplate.opsForHash().get(key+&quot;:info&quot;, &quot;stock&quot;); assert stock != null; if (Integer.parseInt(stock.toString()) &lt;= 0) &#123; // ä¸šåŠ¡å¼‚å¸¸ &#125; else &#123; redisTemplate.opsForHash().increment(key+&quot;:info&quot;, &quot;stock&quot;, -1); // ç”Ÿæˆè®¢å• // å‘å¸ƒè®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶ // æ„å»ºå“åº”VO &#125; &#125; &#125; finally &#123; // é‡Šæ”¾é” stringRedisTemplate.delete(&quot;key&quot;); // æ„å»ºå“åº”VO &#125; return response;&#125; ä»¥ä¸Šä»£ç ï¼Œé€šè¿‡åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´æœ‰æ•ˆæœŸ10sæ¥ä¿éšœä¸šåŠ¡é€»è¾‘æœ‰è¶³å¤Ÿçš„æ‰§è¡Œæ—¶é—´ï¼›é‡‡ç”¨try-finallyè¯­å¥å—ä¿è¯é”ä¸€å®šä¼šåŠæ—¶é‡Šæ”¾ã€‚ä¸šåŠ¡ä»£ç å†…éƒ¨ä¹Ÿå¯¹åº“å­˜è¿›è¡Œäº†æ ¡éªŒã€‚çœ‹èµ·æ¥å¾ˆå®‰å…¨å•Š~ åˆ«æ€¥ï¼Œç»§ç»­åˆ†æã€‚ã€‚ã€‚ äº‹æ•…åŸå› é£å¤©èŒ…å°æŠ¢è´­æ´»åŠ¨å¸å¼•äº†å¤§é‡æ–°ç”¨æˆ·ä¸‹è½½æ³¨å†Œæˆ‘ä»¬çš„APPï¼Œå…¶ä¸­ï¼Œä¸ä¹å¾ˆå¤šç¾Šæ¯›å…šï¼Œé‡‡ç”¨ä¸“ä¸šçš„æ‰‹æ®µæ¥æ³¨å†Œæ–°ç”¨æˆ·æ¥è–…ç¾Šæ¯›å’Œåˆ·å•ã€‚å½“ç„¶æˆ‘ä»¬çš„ç”¨æˆ·ç³»ç»Ÿæå‰åšå¥½äº†é˜²å¤‡ï¼Œæ¥å…¥é˜¿é‡Œäº‘äººæœºéªŒè¯ã€ä¸‰è¦ç´ è®¤è¯ä»¥åŠè‡ªç ”çš„é£æ§ç³»ç»Ÿç­‰å„ç§åå…«èˆ¬æ­¦è‰ºï¼ŒæŒ¡ä½äº†å¤§é‡çš„éæ³•ç”¨æˆ·ã€‚æ­¤å¤„ä¸ç¦ç‚¹ä¸ªèµ~ ä½†ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œè®©ç”¨æˆ·æœåŠ¡ä¸€ç›´å¤„äºè¾ƒé«˜çš„è¿è¡Œè´Ÿè½½ä¸­ã€‚ æŠ¢è´­æ´»åŠ¨å¼€å§‹çš„ä¸€ç¬é—´ï¼Œå¤§é‡çš„ç”¨æˆ·æ ¡éªŒè¯·æ±‚æ‰“åˆ°äº†ç”¨æˆ·æœåŠ¡ã€‚å¯¼è‡´ç”¨æˆ·æœåŠ¡ç½‘å…³å‡ºç°äº†çŸ­æš‚çš„å“åº”å»¶è¿Ÿï¼Œæœ‰äº›è¯·æ±‚çš„å“åº”æ—¶é•¿è¶…è¿‡äº†10sï¼Œä½†ç”±äºHTTPè¯·æ±‚çš„å“åº”è¶…æ—¶æˆ‘ä»¬è®¾ç½®çš„æ˜¯30sï¼Œè¿™å°±å¯¼è‡´æ¥å£ä¸€ç›´é˜»å¡åœ¨ç”¨æˆ·æ ¡éªŒé‚£é‡Œï¼Œ10såï¼Œåˆ†å¸ƒå¼é”å·²ç»å¤±æ•ˆäº†ï¼Œæ­¤æ—¶æœ‰æ–°çš„è¯·æ±‚è¿›æ¥æ˜¯å¯ä»¥æ‹¿åˆ°é”çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é”è¢«è¦†ç›–äº†ã€‚è¿™äº›é˜»å¡çš„æ¥å£æ‰§è¡Œå®Œä¹‹åï¼Œåˆä¼šæ‰§è¡Œé‡Šæ”¾é”çš„é€»è¾‘ï¼Œè¿™å°±æŠŠå…¶ä»–çº¿ç¨‹çš„é”é‡Šæ”¾äº†ï¼Œå¯¼è‡´æ–°çš„è¯·æ±‚ä¹Ÿå¯ä»¥ç«äº‰åˆ°é”~è¿™çœŸæ˜¯ä¸€ä¸ªæå…¶æ¶åŠ£çš„å¾ªç¯ã€‚è¿™ä¸ªæ—¶å€™åªèƒ½ä¾èµ–åº“å­˜æ ¡éªŒï¼Œä½†æ˜¯åååº“å­˜æ ¡éªŒä¸æ˜¯éåŸå­æ€§çš„ï¼Œé‡‡ç”¨çš„æ˜¯get and compare çš„æ–¹å¼ï¼Œè¶…å–çš„æ‚²å‰§å°±è¿™æ ·å‘ç”Ÿäº†~~~ äº‹æ•…åˆ†æä»”ç»†åˆ†æä¸‹æ¥ï¼Œå¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæŠ¢è´­æ¥å£åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ˜¯æœ‰ä¸¥é‡çš„å®‰å…¨éšæ‚£çš„ï¼Œä¸»è¦é›†ä¸­åœ¨ä¸‰ä¸ªåœ°æ–¹ï¼š æ²¡æœ‰å…¶ä»–ç³»ç»Ÿé£é™©å®¹é”™å¤„ç† ç”±äºç”¨æˆ·æœåŠ¡åƒç´§ï¼Œç½‘å…³å“åº”å»¶è¿Ÿï¼Œä½†æ²¡æœ‰ä»»ä½•åº”å¯¹æ–¹å¼ï¼Œè¿™æ˜¯è¶…å–çš„å¯¼ç«ç´¢ã€‚ çœ‹ä¼¼å®‰å…¨çš„åˆ†å¸ƒå¼é”å…¶å®ä¸€ç‚¹éƒ½ä¸å®‰å…¨ è™½ç„¶é‡‡ç”¨äº†set key value [EX seconds] [PX milliseconds] [NX|XX]çš„æ–¹å¼ï¼Œä½†æ˜¯å¦‚æœçº¿ç¨‹Aæ‰§è¡Œçš„æ—¶é—´è¾ƒé•¿æ²¡æœ‰æ¥å¾—åŠé‡Šæ”¾ï¼Œé”å°±è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹Bæ˜¯å¯ä»¥è·å–åˆ°é”çš„ã€‚å½“çº¿ç¨‹Aæ‰§è¡Œå®Œæˆä¹‹åï¼Œé‡Šæ”¾é”ï¼Œå®é™…ä¸Šå°±æŠŠçº¿ç¨‹Bçš„é”é‡Šæ”¾æ‰äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œçº¿ç¨‹Cåˆæ˜¯å¯ä»¥è·å–åˆ°é”çš„ï¼Œè€Œæ­¤æ—¶å¦‚æœçº¿ç¨‹Bæ‰§è¡Œå®Œé‡Šæ”¾é”å®é™…ä¸Šå°±æ˜¯é‡Šæ”¾çš„çº¿ç¨‹Cè®¾ç½®çš„é”ã€‚è¿™æ˜¯è¶…å–çš„ç›´æ¥åŸå› ã€‚ éåŸå­æ€§çš„åº“å­˜æ ¡éªŒ éåŸå­æ€§çš„åº“å­˜æ ¡éªŒå¯¼è‡´åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œåº“å­˜æ ¡éªŒçš„ç»“æœä¸å‡†ç¡®ã€‚è¿™æ˜¯è¶…å–çš„æ ¹æœ¬åŸå› ã€‚ é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› åœ¨äºåº“å­˜æ ¡éªŒä¸¥é‡ä¾èµ–äº†åˆ†å¸ƒå¼é”ã€‚å› ä¸ºåœ¨åˆ†å¸ƒå¼é”æ­£å¸¸setã€delçš„æƒ…å†µä¸‹ï¼Œåº“å­˜æ ¡éªŒæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯ï¼Œå½“åˆ†å¸ƒå¼é”ä¸å®‰å…¨å¯é çš„æ—¶å€™ï¼Œåº“å­˜æ ¡éªŒå°±æ²¡æœ‰ç”¨äº†ã€‚ è§£å†³æ–¹æ¡ˆçŸ¥é“äº†åŸå› ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ç—‡ä¸‹è¯äº†ã€‚ å®ç°ç›¸å¯¹å®‰å…¨çš„åˆ†å¸ƒå¼é”ç›¸å¯¹å®‰å…¨çš„å®šä¹‰ï¼šsetã€delæ˜¯ä¸€ä¸€æ˜ å°„çš„ï¼Œä¸ä¼šå‡ºç°æŠŠå…¶ä»–ç°æˆçš„é”delçš„æƒ…å†µã€‚ä»å®é™…æƒ…å†µçš„è§’åº¦æ¥çœ‹ï¼Œå³ä½¿èƒ½åšåˆ°setã€delä¸€ä¸€æ˜ å°„ï¼Œä¹Ÿæ— æ³•ä¿éšœä¸šåŠ¡çš„ç»å¯¹å®‰å…¨ã€‚å› ä¸ºé”çš„è¿‡æœŸæ—¶é—´å§‹ç»ˆæ˜¯æœ‰ç•Œçš„ï¼Œé™¤éä¸è®¾ç½®è¿‡æœŸæ—¶é—´æˆ–è€…æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®çš„å¾ˆé•¿ï¼Œä½†è¿™æ ·åšä¹Ÿä¼šå¸¦æ¥å…¶ä»–é—®é¢˜ã€‚æ•…æ²¡æœ‰æ„ä¹‰ã€‚è¦æƒ³å®ç°ç›¸å¯¹å®‰å…¨çš„åˆ†å¸ƒå¼é”ï¼Œå¿…é¡»ä¾èµ–keyçš„valueå€¼ã€‚åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œé€šè¿‡valueå€¼çš„å”¯ä¸€æ€§æ¥ä¿è¯ä¸ä¼šå‹¿åˆ ã€‚æˆ‘ä»¬åŸºäºLUAè„šæœ¬å®ç°åŸå­æ€§çš„get and compareï¼Œå¦‚ä¸‹ï¼š 12345public void safedUnLock(String key, String val) &#123; String luaScript = &quot;local in = ARGV[1] local curr=redis.call(&#x27;get&#x27;, KEYS[1]) if in==curr then redis.call(&#x27;del&#x27;, KEYS[1]) end return &#x27;OK&#x27;&quot;&quot;; RedisScript&lt;String&gt; redisScript = RedisScript.of(luaScript); redisTemplate.execute(redisScript, Collections.singletonList(key), Collections.singleton(val));&#125; æˆ‘ä»¬é€šè¿‡LUAè„šæœ¬æ¥å®ç°å®‰å…¨åœ°è§£é”ã€‚ å®ç°å®‰å…¨çš„åº“å­˜æ ¡éªŒå¦‚æœæˆ‘ä»¬å¯¹äºå¹¶å‘æœ‰æ¯”è¾ƒæ·±å…¥çš„äº†è§£çš„è¯ï¼Œä¼šå‘ç°æƒ³ get and compare&#x2F; read and save ç­‰æ“ä½œï¼Œéƒ½æ˜¯éåŸå­æ€§çš„ã€‚å¦‚æœè¦å®ç°åŸå­æ€§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©LUAè„šæœ¬æ¥å®ç°ã€‚ä½†å°±æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”±äºæŠ¢è´­æ´»åŠ¨ä¸€å•åªèƒ½ä¸‹1ç“¶ï¼Œå› æ­¤å¯ä»¥ä¸ç”¨åŸºäºLUAè„šæœ¬å®ç°è€Œæ˜¯åŸºäºredisæœ¬èº«çš„åŸå­æ€§ã€‚åŸå› åœ¨äºï¼š 12// redisä¼šè¿”å›æ“ä½œä¹‹åçš„ç»“æœï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­æ€§çš„Long currStock = redisTemplate.opsForHash().increment(&quot;key&quot;, &quot;stock&quot;, -1); å‘ç°æ²¡æœ‰ï¼Œä»£ç ä¸­çš„åº“å­˜æ ¡éªŒå®Œå…¨æ˜¯â€œç”»è›‡æ·»è¶³â€ã€‚ æ”¹è¿›ä¹‹åçš„ä»£ç ç»è¿‡ä»¥ä¸Šçš„åˆ†æä¹‹åï¼Œæˆ‘ä»¬å†³å®šæ–°å»ºä¸€ä¸ªDistributedLockerç±»ä¸“é—¨ç”¨äºå¤„ç†åˆ†å¸ƒå¼é”ã€‚ 123456789101112131415161718192021222324252627public SeckillActivityRequestVO seckillHandle(SeckillActivityRequestVO request) &#123; SeckillActivityRequestVO response; String key = &quot;key:&quot; + request.getSeckillId(); String val = UUID.randomUUID().toString(); try &#123; Boolean lockFlag = distributedLocker.lock(key, val, 10, TimeUnit.SECONDS); if (!lockFlag) &#123; // ä¸šåŠ¡å¼‚å¸¸ &#125; // ç”¨æˆ·æ´»åŠ¨æ ¡éªŒ // åº“å­˜æ ¡éªŒï¼ŒåŸºäºredisæœ¬èº«çš„åŸå­æ€§æ¥ä¿è¯ Long currStock = stringRedisTemplate.opsForHash().increment(key + &quot;:info&quot;, &quot;stock&quot;, -1); if (currStock &lt; 0) &#123; // è¯´æ˜åº“å­˜å·²ç»æ‰£å‡å®Œäº†ã€‚ // ä¸šåŠ¡å¼‚å¸¸ã€‚ log.error(&quot;[æŠ¢è´­ä¸‹å•] æ— åº“å­˜&quot;); &#125; else &#123; // ç”Ÿæˆè®¢å• // å‘å¸ƒè®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶ // æ„å»ºå“åº” &#125; &#125; finally &#123; distributedLocker.safedUnLock(key, val); // æ„å»ºå“åº” &#125; return response;&#125; æ·±åº¦æ€è€ƒåˆ†å¸ƒå¼é”æœ‰å¿…è¦ä¹ˆæ”¹è¿›ä¹‹åï¼Œå…¶å®å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬å€ŸåŠ©äºredisæœ¬èº«çš„åŸå­æ€§æ‰£å‡åº“å­˜ï¼Œä¹Ÿæ˜¯å¯ä»¥ä¿è¯ä¸ä¼šè¶…å–çš„ã€‚å¯¹çš„ã€‚ä½†æ˜¯å¦‚æœæ²¡æœ‰è¿™ä¸€å±‚é”çš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰è¯·æ±‚è¿›æ¥éƒ½ä¼šèµ°ä¸€éä¸šåŠ¡é€»è¾‘ï¼Œç”±äºä¾èµ–äº†å…¶ä»–ç³»ç»Ÿï¼Œæ­¤æ—¶å°±ä¼šé€ æˆå¯¹å…¶ä»–ç³»ç»Ÿçš„å‹åŠ›å¢å¤§ã€‚è¿™ä¼šå¢åŠ çš„æ€§èƒ½æŸè€—å’ŒæœåŠ¡ä¸ç¨³å®šæ€§ï¼Œå¾—ä¸å¿å¤±ã€‚åŸºäºåˆ†å¸ƒå¼é”å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ‹¦æˆªä¸€äº›æµé‡ã€‚ åˆ†å¸ƒå¼é”çš„é€‰å‹æœ‰äººæå‡ºç”¨RedLockæ¥å®ç°åˆ†å¸ƒå¼é”ã€‚RedLockçš„å¯é æ€§æ›´é«˜ï¼Œä½†å…¶ä»£ä»·æ˜¯ç‰ºç‰²ä¸€å®šçš„æ€§èƒ½ã€‚åœ¨æœ¬åœºæ™¯ï¼Œè¿™ç‚¹å¯é æ€§çš„æå‡è¿œä¸å¦‚æ€§èƒ½çš„æå‡å¸¦æ¥çš„æ€§ä»·æ¯”é«˜ã€‚å¦‚æœå¯¹äºå¯é æ€§æé«˜è¦æ±‚çš„åœºæ™¯ï¼Œåˆ™å¯ä»¥é‡‡ç”¨RedLockæ¥å®ç°ã€‚ å†æ¬¡æ€è€ƒåˆ†å¸ƒå¼é”æœ‰å¿…è¦ä¹ˆç”±äºbugéœ€è¦ç´§æ€¥ä¿®å¤ä¸Šçº¿ï¼Œå› æ­¤æˆ‘ä»¬å°†å…¶ä¼˜åŒ–å¹¶åœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œäº†å‹æµ‹ä¹‹åï¼Œå°±ç«‹é©¬çƒ­éƒ¨ç½²ä¸Šçº¿äº†ã€‚å®é™…è¯æ˜ï¼Œè¿™ä¸ªä¼˜åŒ–æ˜¯æˆåŠŸçš„ï¼Œæ€§èƒ½æ–¹é¢ç•¥å¾®æå‡äº†ä¸€äº›ï¼Œå¹¶åœ¨åˆ†å¸ƒå¼é”å¤±æ•ˆçš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰å‡ºç°è¶…å–çš„æƒ…å†µã€‚ç„¶è€Œï¼Œè¿˜æœ‰æ²¡æœ‰ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿæœ‰çš„ï¼ç”±äºæœåŠ¡æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œæˆ‘ä»¬å¯ä»¥å°†åº“å­˜å‡æ‘Šåˆ°é›†ç¾¤ä¸­çš„æ¯ä¸ªæœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡å¹¿æ’­é€šçŸ¥åˆ°é›†ç¾¤çš„å„ä¸ªæœåŠ¡å™¨ã€‚ç½‘å…³å±‚åŸºäºç”¨æˆ·IDåšhashç®—æ³•æ¥å†³å®šè¯·æ±‚åˆ°å“ªä¸€å°æœåŠ¡å™¨ã€‚è¿™æ ·å°±å¯ä»¥åŸºäºåº”ç”¨ç¼“å­˜æ¥å®ç°åº“å­˜çš„æ‰£å‡å’Œåˆ¤æ–­ã€‚æ€§èƒ½åˆè¿›ä¸€æ­¥æå‡äº†ï¼ 12345678910111213141516171819202122232425// é€šè¿‡æ¶ˆæ¯æå‰åˆå§‹åŒ–å¥½ï¼Œå€ŸåŠ©ConcurrentHashMapå®ç°é«˜æ•ˆçº¿ç¨‹å®‰å…¨private static ConcurrentHashMap&lt;Long, Boolean&gt; SECKILL_FLAG_MAP = new ConcurrentHashMap&lt;&gt;();// é€šè¿‡æ¶ˆæ¯æå‰è®¾ç½®å¥½ã€‚ç”±äºAtomicIntegeræœ¬èº«å…·å¤‡åŸå­æ€§ï¼Œå› æ­¤è¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨HashMapprivate static Map&lt;Long, AtomicInteger&gt; SECKILL_STOCK_MAP = new HashMap&lt;&gt;();...public SeckillActivityRequestVO seckillHandle(SeckillActivityRequestVO request) &#123; SeckillActivityRequestVO response; Long seckillId = request.getSeckillId(); if(!SECKILL_FLAG_MAP.get(requestseckillId)) &#123; // ä¸šåŠ¡å¼‚å¸¸ &#125; // ç”¨æˆ·æ´»åŠ¨æ ¡éªŒ // åº“å­˜æ ¡éªŒ if(SECKILL_STOCK_MAP.get(seckillId).decrementAndGet() &lt; 0) &#123; SECKILL_FLAG_MAP.put(seckillId, false); // ä¸šåŠ¡å¼‚å¸¸ &#125; // ç”Ÿæˆè®¢å• // å‘å¸ƒè®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶ // æ„å»ºå“åº” return response;&#125; é€šè¿‡ä»¥ä¸Šçš„æ”¹é€ ï¼Œæˆ‘ä»¬å°±å®Œå…¨ä¸éœ€è¦ä¾èµ–redisäº†ã€‚æ€§èƒ½å’Œå®‰å…¨æ€§ä¸¤æ–¹é¢éƒ½èƒ½è¿›ä¸€æ­¥å¾—åˆ°æå‡ï¼å½“ç„¶ï¼Œæ­¤æ–¹æ¡ˆæ²¡æœ‰è€ƒè™‘åˆ°æœºå™¨çš„åŠ¨æ€æ‰©å®¹ã€ç¼©å®¹ç­‰å¤æ‚åœºæ™¯ï¼Œå¦‚æœè¿˜è¦è€ƒè™‘è¿™äº›è¯ï¼Œåˆ™ä¸å¦‚ç›´æ¥è€ƒè™‘åˆ†å¸ƒå¼é”çš„è§£å†³æ–¹æ¡ˆã€‚ æ€»ç»“ç¨€ç¼ºå•†å“è¶…å–ç»å¯¹æ˜¯é‡å¤§äº‹æ•…ã€‚å¦‚æœè¶…å–æ•°é‡å¤šçš„è¯ï¼Œç”šè‡³ä¼šç»™å¹³å°å¸¦æ¥éå¸¸ä¸¥é‡çš„ç»è¥å½±å“å’Œç¤¾ä¼šå½±å“ã€‚ç»è¿‡æœ¬æ¬¡äº‹æ•…ï¼Œè®©æˆ‘æ„è¯†åˆ°å¯¹äºé¡¹ç›®ä¸­çš„ä»»ä½•ä¸€è¡Œä»£ç éƒ½ä¸èƒ½æ‰ä»¥è½»å¿ƒï¼Œå¦åˆ™åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè¿™äº›æ­£å¸¸å·¥ä½œçš„ä»£ç å°±ä¼šå˜æˆè‡´å‘½æ€æ‰‹ï¼å¯¹äºä¸€ä¸ªå¼€å‘è€…è€Œè¨€ï¼Œåˆ™è®¾è®¡å¼€å‘æ–¹æ¡ˆæ—¶ï¼Œä¸€å®šè¦å°†æ–¹æ¡ˆè€ƒè™‘å‘¨å…¨ã€‚æ€æ ·æ‰èƒ½å°†æ–¹æ¡ˆè€ƒè™‘å‘¨å…¨ï¼Ÿå”¯æœ‰æŒç»­ä¸æ–­åœ°å­¦ä¹ ï¼","tags":["Redis","NoSQL","åˆ†å¸ƒå¼é”"],"categories":["DataBase","NoSQL"]},{"title":"Javaä¸­å¦‚ä½•æ›´ä¼˜é›…çš„å¤„ç†ç©ºå€¼","path":"/2023/12/25/Javaä¸­å¦‚ä½•æ›´ä¼˜é›…çš„å¤„ç†ç©ºå€¼/","content":"å¯¼è¯­åœ¨ç¬”è€…å‡ å¹´çš„å¼€å‘ç»éªŒä¸­ï¼Œç»å¸¸çœ‹åˆ°é¡¹ç›®ä¸­å­˜åœ¨åˆ°å¤„ç©ºå€¼åˆ¤æ–­çš„æƒ…å†µï¼Œè¿™äº›åˆ¤æ–­ï¼Œä¼šè®©äººè§‰å¾—æ‘¸ä¸ç€å¤´ç»ªï¼Œå®ƒçš„å‡ºç°å¾ˆæœ‰å¯èƒ½å’Œå½“å‰çš„ä¸šåŠ¡é€»è¾‘å¹¶æ²¡æœ‰å…³ç³»ã€‚ä½†å®ƒä¼šè®©ä½ å¾ˆå¤´ç–¼ã€‚ æœ‰æ—¶å€™ï¼Œæ›´å¯æ€•çš„æ˜¯ç³»ç»Ÿå› ä¸ºè¿™äº›ç©ºå€¼çš„æƒ…å†µï¼Œä¼šæŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå¯¼è‡´ä¸šåŠ¡ç³»ç»Ÿå‘ç”Ÿé—®é¢˜ã€‚ æ­¤ç¯‡æ–‡ç« ï¼Œæˆ‘æ€»ç»“äº†å‡ ç§å…³äºç©ºå€¼çš„å¤„ç†æ‰‹æ³•ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰å¸®åŠ©ã€‚ ä¸šåŠ¡ä¸­çš„ç©ºå€¼åœºæ™¯å­˜åœ¨ä¸€ä¸ªUserSearchServiceç”¨æ¥æä¾›ç”¨æˆ·æŸ¥è¯¢çš„åŠŸèƒ½: 12345public interface UserSearchService&#123; List&lt;User&gt; listUser(); User get(Integer id); &#125; é—®é¢˜ç°åœºå¯¹äºé¢å‘å¯¹è±¡è¯­è¨€æ¥è®²ï¼ŒæŠ½è±¡å±‚çº§ç‰¹åˆ«çš„é‡è¦ã€‚å°¤å…¶æ˜¯å¯¹æ¥å£çš„æŠ½è±¡ï¼Œå®ƒåœ¨è®¾è®¡å’Œå¼€å‘ä¸­å å¾ˆå¤§çš„æ¯”é‡ï¼Œæˆ‘ä»¬åœ¨å¼€å‘æ—¶å¸Œæœ›å°½é‡é¢å‘æ¥å£ç¼–ç¨‹ã€‚ å¯¹äºä»¥ä¸Šæè¿°çš„æ¥å£æ–¹æ³•æ¥çœ‹ï¼Œå¤§æ¦‚å¯ä»¥æ¨æ–­å‡ºå¯èƒ½å®ƒåŒ…å«äº†ä»¥ä¸‹ä¸¤ä¸ªå«ä¹‰: listUser(): æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ get(Integer id): æŸ¥è¯¢å•ä¸ªç”¨æˆ· åœ¨æ‰€æœ‰çš„å¼€å‘ä¸­ï¼ŒXPæ¨å´‡çš„TDDæ¨¡å¼å¯ä»¥å¾ˆå¥½çš„å¼•å¯¼æˆ‘ä»¬å¯¹æ¥å£çš„å®šä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†TDDä½œä¸ºå¼€å‘ä»£ç çš„â€æ¨åŠ¨è€…â€ã€‚ å¯¹äºä»¥ä¸Šçš„æ¥å£ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨TDDè¿›è¡Œæµ‹è¯•ç”¨ä¾‹å…ˆè¡Œæ—¶ï¼Œå‘ç°äº†æ½œåœ¨çš„é—®é¢˜ï¼š listUser() å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé‚£å®ƒæ˜¯è¿”å›ç©ºé›†åˆè¿˜æ˜¯nullå‘¢ï¼Ÿ get(Integer id) å¦‚æœæ²¡æœ‰è¿™ä¸ªå¯¹è±¡ï¼Œæ˜¯æŠ›å¼‚å¸¸è¿˜æ˜¯è¿”å›nullå‘¢ï¼Ÿ æ·±å…¥listUserç ”ç©¶æˆ‘ä»¬å…ˆæ¥è®¨è®º 1listUser() è¿™ä¸ªæ¥å£ï¼Œæˆ‘ç»å¸¸çœ‹åˆ°å¦‚ä¸‹å®ç°: 1234567public List&lt;User&gt; listUser()&#123; List&lt;User&gt; userList = userListRepostity.selectByExample(new UserExample()); if(CollectionUtils.isEmpty(userList))&#123;//spring utilå·¥å…·ç±» return null; &#125; return userList; &#125; è¿™æ®µä»£ç è¿”å›æ˜¯null,ä»æˆ‘å¤šå¹´çš„å¼€å‘ç»éªŒæ¥è®²ï¼Œå¯¹äºé›†åˆè¿™æ ·è¿”å›å€¼ï¼Œæœ€å¥½ä¸è¦è¿”å›nullï¼Œå› ä¸ºå¦‚æœè¿”å›äº†nullï¼Œä¼šç»™è°ƒç”¨è€…å¸¦æ¥å¾ˆå¤šéº»çƒ¦ã€‚ä½ å°†ä¼šæŠŠè¿™ç§è°ƒç”¨é£é™©äº¤ç»™è°ƒç”¨è€…æ¥æ§åˆ¶ã€‚ å¦‚æœè°ƒç”¨è€…æ˜¯ä¸€ä¸ªè°¨æ…çš„äººï¼Œä»–ä¼šè¿›è¡Œæ˜¯å¦ä¸ºnullçš„æ¡ä»¶åˆ¤æ–­ã€‚å¦‚æœä»–å¹¶éè°¨æ…ï¼Œæˆ–è€…ä»–æ˜¯ä¸€ä¸ªé¢å‘æ¥å£ç¼–ç¨‹çš„ç‹‚çƒ­åˆ†å­(å½“ç„¶ï¼Œé¢å‘æ¥å£ç¼–ç¨‹æ˜¯æ­£ç¡®çš„æ–¹å‘)ï¼Œä»–ä¼šæŒ‰ç…§è‡ªå·±çš„ç†è§£å»è°ƒç”¨æ¥å£ï¼Œè€Œä¸è¿›è¡Œæ˜¯å¦ä¸ºnullçš„æ¡ä»¶åˆ¤æ–­ï¼Œå¦‚æœè¿™æ ·çš„è¯ï¼Œæ˜¯éå¸¸å±é™©çš„ï¼Œå®ƒå¾ˆæœ‰å¯èƒ½å‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ æ ¹æ®å¢¨è²å®šå¾‹æ¥åˆ¤æ–­: â€œå¾ˆæœ‰å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œåœ¨å°†æ¥ä¸€å®šä¼šå‡ºç°!â€ åŸºäºæ­¤ï¼Œæˆ‘ä»¬å°†å®ƒè¿›è¡Œä¼˜åŒ–: 1234567public List&lt;User&gt; listUser()&#123; List&lt;User&gt; userList = userListRepostity.selectByExample(new UserExample()); if(CollectionUtils.isEmpty(userList))&#123; return Lists.newArrayList();//guavaç±»åº“æä¾›çš„æ–¹å¼ &#125; return userList; &#125; å¯¹äºæ¥å£(List listUser())ï¼Œå®ƒä¸€å®šä¼šè¿”å›Listï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ï¼Œå®ƒä»ç„¶ä¼šè¿”å›Listï¼ˆé›†åˆä¸­æ²¡æœ‰ä»»ä½•å…ƒç´ ï¼‰; é€šè¿‡ä»¥ä¸Šçš„ä¿®æ”¹ï¼Œæˆ‘ä»¬æˆåŠŸçš„é¿å…äº†æœ‰å¯èƒ½å‘ç”Ÿçš„ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œè¿™æ ·çš„å†™æ³•æ›´å®‰å…¨ï¼ æ·±å…¥ç ”ç©¶getæ–¹æ³•å¯¹äºæ¥å£ 1User get(Integer id) ä½ èƒ½çœ‹åˆ°çš„ç°è±¡æ˜¯ï¼Œæˆ‘ç»™å‡ºidï¼Œå®ƒä¸€å®šä¼šç»™æˆ‘è¿”å›User.ä½†äº‹å®çœŸçš„å¾ˆæœ‰å¯èƒ½ä¸æ˜¯è¿™æ ·çš„ã€‚ æˆ‘çœ‹åˆ°è¿‡çš„å®ç°: 123public User get(Integer id)&#123; return userRepository.selectByPrimaryKey(id);//ä»æ•°æ®åº“ä¸­é€šè¿‡idç›´æ¥è·å–å®ä½“å¯¹è±¡ &#125; ç›¸ä¿¡å¾ˆå¤šäººä¹Ÿéƒ½ä¼šè¿™æ ·å†™ã€‚ é€šè¿‡ä»£ç çš„æ—¶å€™å¾—çŸ¥å®ƒçš„è¿”å›å€¼å¾ˆæœ‰å¯èƒ½æ˜¯null! ä½†æˆ‘ä»¬é€šè¿‡çš„æ¥å£æ˜¯åˆ†è¾¨ä¸å‡ºæ¥çš„! è¿™ä¸ªæ˜¯ä¸ªéå¸¸å±é™©çš„äº‹æƒ…ã€‚å°¤å…¶å¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼ æˆ‘ç»™å‡ºçš„å»ºè®®æ˜¯ï¼Œéœ€è¦åœ¨æ¥å£æ˜æ˜æ—¶è¡¥å……æ–‡æ¡£,æ¯”å¦‚å¯¹äºå¼‚å¸¸çš„è¯´æ˜,ä½¿ç”¨æ³¨è§£@exception: 1234567891011public interface UserSearchService&#123; /** * æ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·ä¿¡æ¯ * @param id ç”¨æˆ·id * @return ç”¨æˆ·å®ä½“ * @exception UserNotFoundException */ User get(Integer id); &#125; æˆ‘ä»¬æŠŠæ¥å£å®šä¹‰åŠ ä¸Šäº†è¯´æ˜ä¹‹åï¼Œè°ƒç”¨è€…ä¼šçœ‹åˆ°ï¼Œå¦‚æœè°ƒç”¨æ­¤æ¥å£ï¼Œå¾ˆæœ‰å¯èƒ½æŠ›å‡ºâ€œUserNotFoundException(æ‰¾ä¸åˆ°ç”¨æˆ·)â€è¿™æ ·çš„å¼‚å¸¸ã€‚ è¿™ç§æ–¹å¼å¯ä»¥åœ¨è°ƒç”¨è€…è°ƒç”¨æ¥å£çš„æ—¶å€™çœ‹åˆ°æ¥å£çš„å®šä¹‰ï¼Œä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼æ˜¯â€å¼±æç¤ºâ€çš„ï¼ å¦‚æœè°ƒç”¨è€…å¿½ç•¥äº†æ³¨é‡Šï¼Œæœ‰å¯èƒ½å°±å¯¹ä¸šåŠ¡ç³»ç»Ÿäº§ç”Ÿäº†é£é™©ï¼Œè¿™ä¸ªé£é™©æœ‰å¯èƒ½å¯¼è‡´ä¸€ä¸ªäº¿ï¼ é™¤äº†ä»¥ä¸Šè¿™ç§â€å¼±æç¤ºâ€çš„æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ï¼Œè¿”å›å€¼æ˜¯æœ‰å¯èƒ½ä¸ºç©ºçš„ã€‚é‚£è¦æ€ä¹ˆåŠå‘¢ï¼Ÿ æˆ‘è®¤ä¸ºæˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥æè¿°è¿™ç§åœºæ™¯. å¼•å…¥jdk8çš„Optional,æˆ–è€…ä½¿ç”¨guavaçš„Optional.çœ‹å¦‚ä¸‹å®šä¹‰: 123456789public interface UserSearchService&#123; /** * æ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·ä¿¡æ¯ * @param id ç”¨æˆ·id * @return ç”¨æˆ·å®ä½“,æ­¤å®ä½“æœ‰å¯èƒ½æ˜¯ç¼ºçœå€¼ */ Optional&lt;User&gt; getOptional(Integer id); &#125; Optionalæœ‰ä¸¤ä¸ªå«ä¹‰: å­˜åœ¨ or ç¼ºçœã€‚ é‚£ä¹ˆé€šè¿‡é˜…è¯»æ¥å£getOptional()ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„äº†è§£è¿”å›å€¼çš„æ„å›¾ï¼Œè¿™ä¸ªå…¶å®æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„ï¼Œå®ƒå»é™¤äº†äºŒä¹‰æ€§ã€‚ å®ƒçš„å®ç°å¯ä»¥å†™æˆ: 123public Optional&lt;User&gt; getOptional(Integer id)&#123; return Optional.ofNullable(userRepository.selectByPrimaryKey(id)); &#125; æ·±å…¥å…¥å‚é€šè¿‡ä¸Šè¿°çš„æ‰€æœ‰æ¥å£çš„æè¿°ï¼Œä½ èƒ½ç¡®å®šå…¥å‚idä¸€å®šæ˜¯å¿…ä¼ çš„å—ï¼Ÿæˆ‘è§‰å¾—ç­”æ¡ˆåº”è¯¥æ˜¯ï¼šä¸èƒ½ç¡®å®šã€‚é™¤éæ¥å£çš„æ–‡æ¡£æ³¨é‡Šä¸ŠåŠ ä»¥è¯´æ˜ã€‚ é‚£å¦‚ä½•çº¦æŸå…¥å‚å‘¢? æˆ‘ç»™å¤§å®¶æ¨èä¸¤ç§æ–¹å¼ï¼š å¼ºåˆ¶çº¦æŸ æ–‡æ¡£æ€§çº¦æŸï¼ˆå¼±æç¤ºï¼‰ 1.å¼ºåˆ¶çº¦æŸï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡jsr 303è¿›è¡Œä¸¥æ ¼çš„çº¦æŸå£°æ˜: 12345678910111213141516public interface UserSearchService&#123; /** * æ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·ä¿¡æ¯ * @param id ç”¨æˆ·id * @return ç”¨æˆ·å®ä½“ * @exception UserNotFoundException */ User get(@NotNull Integer id); /** * æ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·ä¿¡æ¯ * @param id ç”¨æˆ·id * @return ç”¨æˆ·å®ä½“,æ­¤å®ä½“æœ‰å¯èƒ½æ˜¯ç¼ºçœå€¼ */ Optional&lt;User&gt; getOptional(@NotNull Integer id); &#125; å½“ç„¶ï¼Œè¿™æ ·å†™ï¼Œè¦é…åˆAOPçš„æ“ä½œè¿›è¡ŒéªŒè¯ï¼Œä½†è®©springå·²ç»æä¾›äº†å¾ˆå¥½çš„é›†æˆæ–¹æ¡ˆï¼Œåœ¨æ­¤æˆ‘å°±ä¸åœ¨èµ˜è¿°äº†ã€‚ 2.æ–‡æ¡£æ€§çº¦æŸ åœ¨å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°é—ç•™ä»£ç ï¼Œå¯¹äºé—ç•™ä»£ç ï¼Œæ•´ä½“æ€§æ”¹é€ çš„å¯èƒ½æ€§å¾ˆå°ã€‚ æˆ‘ä»¬æ›´å¸Œæœ›é€šè¿‡é˜…è¯»æ¥å£çš„å®ç°ï¼Œæ¥è¿›è¡Œæ¥å£çš„è¯´æ˜ã€‚ jsr 305è§„èŒƒï¼Œç»™äº†æˆ‘ä»¬ä¸€ä¸ªæè¿°æ¥å£å…¥å‚çš„ä¸€ä¸ªæ–¹å¼(éœ€è¦å¼•å…¥åº“ com.google.code.findbugs:jsr305): å¯ä»¥ä½¿ç”¨æ³¨è§£: @Nullable @Nonnull @CheckForNull è¿›è¡Œæ¥å£è¯´æ˜ã€‚æ¯”å¦‚: 1234567891011121314151617public interface UserSearchService&#123; /** * æ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·ä¿¡æ¯ * @param id ç”¨æˆ·id * @return ç”¨æˆ·å®ä½“ * @exception UserNotFoundException */ @CheckForNull User get(@NonNull Integer id); /** * æ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·ä¿¡æ¯ * @param id ç”¨æˆ·id * @return ç”¨æˆ·å®ä½“,æ­¤å®ä½“æœ‰å¯èƒ½æ˜¯ç¼ºçœå€¼ */ Optional&lt;User&gt; getOptional(@NonNull Integer id); &#125; å°ç»“é€šè¿‡ ç©ºé›†åˆè¿”å›å€¼,Optional,jsr 303ï¼Œjsr 305è¿™å‡ ç§æ–¹å¼ï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„ä»£ç å¯è¯»æ€§æ›´å¼ºï¼Œå‡ºé”™ç‡æ›´ä½ï¼ ç©ºé›†åˆè¿”å›å€¼ ï¼šå¦‚æœæœ‰é›†åˆè¿™æ ·è¿”å›å€¼æ—¶ï¼Œé™¤éçœŸçš„æœ‰è¯´æœè‡ªå·±çš„ç†ç”±ï¼Œå¦åˆ™ï¼Œä¸€å®šè¦è¿”å›ç©ºé›†åˆï¼Œè€Œä¸æ˜¯null Optional: å¦‚æœä½ çš„ä»£ç æ˜¯jdk8ï¼Œå°±å¼•å…¥å®ƒï¼å¦‚æœä¸æ˜¯ï¼Œåˆ™ä½¿ç”¨Guavaçš„Optional,æˆ–è€…å‡çº§jdkç‰ˆæœ¬ï¼å®ƒå¾ˆå¤§ç¨‹åº¦çš„èƒ½å¢åŠ äº†æ¥å£çš„å¯è¯»æ€§ï¼ jsr 303: å¦‚æœæ–°çš„é¡¹ç›®æ­£åœ¨å¼€å‘ï¼Œä¸é˜²åŠ ä¸Šè¿™ä¸ªè¯•è¯•ï¼ä¸€å®šæœ‰ä¸€ç§ç‰¹åˆ«çˆ½çš„æ„Ÿè§‰! jsr 305: å¦‚æœè€çš„é¡¹ç›®åœ¨ä½ çš„æ‰‹ä¸Šï¼Œä½ å¯ä»¥å°è¯•çš„åŠ ä¸Šè¿™ç§æ–‡æ¡£å‹æ³¨è§£ï¼Œæœ‰åŠ©äºä½ åæœŸçš„é‡æ„ï¼Œæˆ–è€…æ–°åŠŸèƒ½å¢åŠ äº†ï¼Œå¯¹äºè€æ¥å£çš„ç†è§£! ç©ºå¯¹è±¡æ¨¡å¼åœºæ™¯æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªDTOè½¬åŒ–çš„åœºæ™¯ï¼Œå¯¹è±¡: 1234567891011@Data static class PersonDTO&#123; private String dtoName; private String dtoAge; &#125; @Data static class Person&#123; private String name; private String age; &#125; éœ€æ±‚æ˜¯å°†Personå¯¹è±¡è½¬åŒ–æˆPersonDTOï¼Œç„¶åè¿›è¡Œè¿”å›ã€‚ å½“ç„¶å¯¹äºå®é™…æ“ä½œæ¥è®²ï¼Œè¿”å›å¦‚æœPersonä¸ºç©ºï¼Œå°†è¿”å›null,ä½†æ˜¯PersonDTOæ˜¯ä¸èƒ½è¿”å›nullçš„ï¼ˆå°¤å…¶Restæ¥å£è¿”å›çš„è¿™ç§DTOï¼‰ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªå…³æ³¨è½¬åŒ–æ“ä½œï¼Œçœ‹å¦‚ä¸‹ä»£ç : 1234567891011121314@Test public void shouldConvertDTO()&#123; PersonDTO personDTO = new PersonDTO(); Person person = new Person(); if(!Objects.isNull(person))&#123; personDTO.setDtoAge(person.getAge()); personDTO.setDtoName(person.getName()); &#125;else&#123; personDTO.setDtoAge(&quot;&quot;); personDTO.setDtoName(&quot;&quot;); &#125; &#125; ä¼˜åŒ–ä¿®æ”¹è¿™æ ·çš„æ•°æ®è½¬åŒ–ï¼Œæˆ‘ä»¬è®¤è¯†å¯è¯»æ€§éå¸¸å·®ï¼Œæ¯ä¸ªå­—æ®µçš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ç©ºå°±è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²(â€œâ€) æ¢ä¸€ç§æ€ç»´æ–¹å¼è¿›è¡Œæ€è€ƒï¼Œæˆ‘ä»¬æ˜¯æ‹¿åˆ°Personè¿™ä¸ªç±»çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œèµ‹å€¼æ“ä½œ(setXXX),å…¶å®æ˜¯ä¸å…³ç³»Personçš„å…·ä½“å®ç°æ˜¯è°çš„ã€‚ é‚£æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªPersonå­ç±»: 1234567891011static class NullPerson extends Person&#123; @Override public String getAge() &#123; return &quot;&quot;; &#125; @Override public String getName() &#123; return &quot;&quot;; &#125; &#125; å®ƒä½œä¸ºPersonçš„ä¸€ç§ç‰¹ä¾‹è€Œå­˜åœ¨ï¼Œå¦‚æœå½“Personä¸ºç©ºçš„æ—¶å€™ï¼Œåˆ™è¿”å›ä¸€äº›get*çš„é»˜è®¤è¡Œä¸º. æ‰€ä»¥ä»£ç å¯ä»¥ä¿®æ”¹ä¸º: 12345678910111213@Test public void shouldConvertDTO()&#123; PersonDTO personDTO = new PersonDTO(); Person person = getPerson(); personDTO.setDtoAge(person.getAge()); personDTO.setDtoName(person.getName()); &#125; private Person getPerson()&#123; return new NullPerson();//å¦‚æœPersonæ˜¯null ,åˆ™è¿”å›ç©ºå¯¹è±¡ &#125; å…¶ä¸­getPerson()æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥æ ¹æ®ä¸šåŠ¡é€»è¾‘è·å–Personæœ‰å¯èƒ½çš„å¯¹è±¡ï¼ˆå¯¹å½“å‰ä¾‹å­æ¥è®²ï¼Œå¦‚æœPersonä¸å­˜åœ¨ï¼Œè¿”å›Personçš„çš„ç‰¹ä¾‹NUllPersonï¼‰ï¼Œå¦‚æœä¿®æ”¹æˆè¿™æ ·ï¼Œä»£ç çš„å¯è¯»æ€§å°±ä¼šå˜çš„å¾ˆå¼ºäº†ã€‚ ä½¿ç”¨Optionalå¯ä»¥è¿›è¡Œä¼˜åŒ–ç©ºå¯¹è±¡æ¨¡å¼ï¼Œå®ƒçš„å¼Šç«¯åœ¨äºéœ€è¦åˆ›å»ºä¸€ä¸ªç‰¹ä¾‹å¯¹è±¡ï¼Œä½†æ˜¯å¦‚æœç‰¹ä¾‹çš„æƒ…å†µæ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯éœ€è¦åˆ›å»ºå¤šä¸ªç‰¹ä¾‹å¯¹è±¡å‘¢ï¼Œè™½ç„¶æˆ‘ä»¬ä¹Ÿä½¿ç”¨äº†é¢å‘å¯¹è±¡çš„å¤šæ€ç‰¹æ€§ï¼Œä½†æ˜¯ï¼Œä¸šåŠ¡çš„å¤æ‚æ€§å¦‚æœçœŸçš„è®©æˆ‘ä»¬åˆ›å»ºå¤šä¸ªç‰¹ä¾‹å¯¹è±¡ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å†ä¸‰è€ƒè™‘ä¸€ä¸‹è¿™ç§æ¨¡å¼ï¼Œå®ƒå¯èƒ½ä¼šå¸¦æ¥ä»£ç çš„å¤æ‚æ€§ã€‚ å¯¹äºä¸Šè¿°ä»£ç ï¼Œè¿˜å¯ä»¥ä½¿ç”¨Optionalè¿›è¡Œä¼˜åŒ–ã€‚ 1234567891011121314@Test public void shouldConvertDTO()&#123; PersonDTO personDTO = new PersonDTO(); Optional.ofNullable(getPerson()).ifPresent(person -&gt; &#123; personDTO.setDtoAge(person.getAge()); personDTO.setDtoName(person.getName()); &#125;); &#125; private Person getPerson()&#123; return null; &#125; Optionalå¯¹ç©ºå€¼çš„ä½¿ç”¨ï¼Œæˆ‘è§‰å¾—æ›´ä¸ºè´´åˆ‡ï¼Œå®ƒåªé€‚ç”¨äºâ€æ˜¯å¦å­˜åœ¨â€çš„åœºæ™¯ã€‚ å¦‚æœåªå¯¹æ§åˆ¶çš„å­˜åœ¨åˆ¤æ–­ï¼Œæˆ‘å»ºè®®ä½¿ç”¨Optional. Optioanlçš„æ­£ç¡®ä½¿ç”¨Optionalå¦‚æ­¤å¼ºå¤§ï¼Œå®ƒè¡¨è¾¾äº†è®¡ç®—æœºæœ€åŸå§‹çš„ç‰¹æ€§(0 or 1),é‚£å®ƒå¦‚ä½•æ­£ç¡®çš„è¢«ä½¿ç”¨å‘¢! Optionalä¸è¦ä½œä¸ºå‚æ•°å¦‚æœä½ å†™äº†ä¸€ä¸ªpublicæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è§„å®šäº†ä¸€äº›è¾“å…¥å‚æ•°ï¼Œè¿™äº›å‚æ•°ä¸­æœ‰ä¸€äº›æ˜¯å¯ä»¥ä¼ å…¥nullçš„ï¼Œé‚£è¿™æ—¶å€™æ˜¯å¦å¯ä»¥ä½¿ç”¨Optionalå‘¢ï¼Ÿ æˆ‘ç»™çš„å»ºè®®æ˜¯: ä¸€å®šä¸è¦è¿™æ ·ä½¿ç”¨! ä¸¾ä¸ªä¾‹å­: 123public interface UserService&#123; List&lt;User&gt; listUser(Optional&lt;String&gt; username); &#125; è¿™ä¸ªä¾‹å­çš„æ–¹æ³• listUser,å¯èƒ½åœ¨å‘Šè¯‰æˆ‘ä»¬éœ€è¦æ ¹æ®usernameæŸ¥è¯¢æ‰€æœ‰æ•°æ®é›†åˆï¼Œå¦‚æœusernameæ˜¯ç©ºï¼Œä¹Ÿè¦è¿”å›æ‰€æœ‰çš„ç”¨æˆ·é›†åˆ. å½“æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè§‰å¾—æœ‰ä¸€äº›æ­§ä¹‰: â€œå¦‚æœusernameæ˜¯absent,æ˜¯è¿”å›ç©ºé›†åˆå—ï¼Ÿè¿˜æ˜¯è¿”å›å…¨éƒ¨çš„ç”¨æˆ·æ•°æ®é›†åˆï¼Ÿâ€ Optioanlæ˜¯ä¸€ç§åˆ†æ”¯çš„åˆ¤æ–­ï¼Œé‚£æˆ‘ä»¬ç©¶ç«Ÿæ˜¯å…³æ³¨ Optionalè¿˜æ˜¯Optional.get()å‘¢ï¼Ÿ æˆ‘ç»™å¤§å®¶çš„å»ºè®®æ˜¯ï¼Œå¦‚æœä¸æƒ³è¦è¿™æ ·çš„æ­§ä¹‰ï¼Œå°±ä¸è¦ä½¿ç”¨å®ƒï¼ å¦‚æœä½ çœŸçš„æƒ³è¡¨è¾¾ä¸¤ä¸ªå«ä¹‰ï¼Œå°±çµ¦å®ƒæ‹†åˆ†å‡ºä¸¤ä¸ªæ¥å£: 1234public interface UserService&#123; List&lt;User&gt; listUser(String username); List&lt;User&gt; listUser(); &#125; æˆ‘è§‰å¾—è¿™æ ·çš„è¯­ä¹‰æ›´å¼ºï¼Œå¹¶ä¸”æ›´èƒ½æ»¡è¶³ è½¯ä»¶è®¾è®¡åŸåˆ™ä¸­çš„ â€œå•ä¸€èŒè´£â€ã€‚ å¦‚æœä½ è§‰å¾—ä½ çš„å…¥å‚çœŸçš„æœ‰å¿…è¦å¯èƒ½ä¼ null,é‚£è¯·ä½¿ç”¨jsr 303æˆ–è€…jsr 305è¿›è¡Œè¯´æ˜å’ŒéªŒè¯! è¯·è®°ä½! Optionalä¸èƒ½ä½œä¸ºå…¥å‚çš„å‚æ•°! Optionalä½œä¸ºè¿”å›å€¼å½“ä¸ªå®ä½“çš„è¿”å›é‚£Optioanlå¯ä»¥åšä¸ºè¿”å›å€¼å—ï¼Ÿ å…¶å®å®ƒæ˜¯éå¸¸æ»¡è¶³æ˜¯å¦å­˜åœ¨è¿™ä¸ªè¯­ä¹‰çš„ã€‚ ä½ å¦‚è¯´ï¼Œä½ è¦æ ¹æ®idè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™ä¸ªç”¨æˆ·æœ‰å¯èƒ½å­˜åœ¨æˆ–è€…ä¸å­˜åœ¨ã€‚ ä½ å¯ä»¥è¿™æ ·ä½¿ç”¨: 123public interface UserService&#123; Optional&lt;User&gt; get(Integer id); &#125; å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œè°ƒç”¨è€…å¾ˆæ¸…æ¥šgetæ–¹æ³•è¿”å›çš„æ•°æ®ï¼Œæœ‰å¯èƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·å¯ä»¥åšä¸€äº›æ›´åˆç†çš„åˆ¤æ–­ï¼Œæ›´å¥½çš„é˜²æ­¢ç©ºæŒ‡é’ˆçš„é”™è¯¯ï¼ å½“ç„¶ï¼Œå¦‚æœä¸šåŠ¡æ–¹çœŸçš„éœ€è¦æ ¹æ®idå¿…é¡»æŸ¥è¯¢å‡ºUserçš„è¯ï¼Œå°±ä¸è¦è¿™æ ·ä½¿ç”¨äº†ï¼Œè¯·è¯´æ˜ï¼Œä½ è¦æŠ›å‡ºçš„å¼‚å¸¸. åªæœ‰å½“è€ƒè™‘å®ƒè¿”å›nullæ˜¯åˆç†çš„æƒ…å†µä¸‹ï¼Œæ‰è¿›è¡ŒOptionalçš„è¿”å› é›†åˆå®ä½“çš„è¿”å›ä¸æ˜¯æ‰€æœ‰çš„è¿”å›å€¼éƒ½å¯ä»¥è¿™æ ·ç”¨çš„ï¼å¦‚æœä½ è¿”å›çš„æ˜¯é›†åˆï¼š 123public interface UserService&#123; Optional&lt;List&lt;User&gt;&gt; listUser(); &#125; è¿™æ ·çš„è¿”å›ç»“æœï¼Œä¼šè®©è°ƒç”¨è€…ä¸çŸ¥æ‰€æªï¼Œæ˜¯å¦æˆ‘åˆ¤æ–­Optionalä¹‹åï¼Œè¿˜ç”¨è¿›è¡ŒisEmptyçš„åˆ¤æ–­å‘¢ï¼Ÿ è¿™æ ·å¸¦æ¥çš„è¿”å›å€¼æ­§ä¹‰ï¼æˆ‘è®¤ä¸ºæ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚ æˆ‘ä»¬è¦çº¦å®šï¼Œå¯¹äºListè¿™ç§é›†åˆè¿”å›å€¼ï¼Œå¦‚æœé›†åˆçœŸçš„æ˜¯nullçš„ï¼Œè¯·è¿”å›ç©ºé›†åˆ(Lists.newArrayList); ä½¿ç”¨Optionalå˜é‡1Optional&lt;User&gt; userOpt = ... å¦‚æœæœ‰è¿™æ ·çš„å˜é‡userOpt,è¯·è®°ä½ ï¼š ä¸€å®šä¸èƒ½ç›´æ¥ä½¿ç”¨get ï¼Œå¦‚æœè¿™æ ·ç”¨ï¼Œå°±ä¸§å¤±äº†Optionalæœ¬èº«çš„å«ä¹‰ ï¼ˆ æ¯”å¦‚userOp.get() ï¼‰ ä¸è¦ç›´æ¥ä½¿ç”¨getOrThrow ,å¦‚æœä½ æœ‰è¿™æ ·çš„éœ€æ±‚ï¼šè·å–ä¸åˆ°å°±æŠ›å¼‚å¸¸ã€‚é‚£å°±è¦è€ƒè™‘ï¼Œæ˜¯å¦æ˜¯è°ƒç”¨çš„æ¥å£è®¾è®¡çš„æ˜¯å¦åˆç† getterä¸­çš„ä½¿ç”¨å¯¹äºä¸€ä¸ªjava bean,æ‰€æœ‰çš„å±æ€§éƒ½æœ‰å¯èƒ½è¿”å›null,é‚£æ˜¯å¦éœ€è¦æ”¹å†™æ‰€æœ‰çš„getteræˆä¸ºOptionalç±»å‹å‘¢ï¼Ÿ æˆ‘ç»™å¤§å®¶çš„å»ºè®®æ˜¯ï¼Œä¸è¦è¿™æ ·æ»¥ç”¨Optional. å³ä¾¿ æˆ‘java beanä¸­çš„getteræ˜¯ç¬¦åˆOptionalçš„ï¼Œä½†æ˜¯å› ä¸ºjava bean å¤ªå¤šäº†ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä½ çš„ä»£ç æœ‰50%ä»¥ä¸Šè¿›è¡ŒOptinalçš„åˆ¤æ–­ï¼Œè¿™æ ·ä¾¿æ±¡æŸ“äº†ä»£ç ã€‚(æˆ‘æƒ³è¯´ï¼Œå…¶å®ä½ çš„å®ä½“ä¸­çš„å­—æ®µåº”è¯¥éƒ½æ˜¯ç”±ä¸šåŠ¡å«ä¹‰çš„ï¼Œä¼šè®¤çœŸçš„æ€è€ƒè¿‡å®ƒå­˜åœ¨çš„ä»·å€¼çš„ï¼Œä¸èƒ½å› ä¸ºOptionalçš„å­˜åœ¨è€Œæ»¥ç”¨) æˆ‘ä»¬åº”è¯¥æ›´å…³æ³¨äºä¸šåŠ¡ï¼Œè€Œä¸åªæ˜¯ç©ºå€¼çš„åˆ¤æ–­ã€‚ è¯·ä¸è¦åœ¨getterä¸­æ»¥ç”¨Optional. å°ç»“å¯ä»¥è¿™æ ·æ€»ç»“Optionalçš„ä½¿ç”¨ï¼š å½“ä½¿ç”¨å€¼ä¸ºç©ºçš„æƒ…å†µï¼Œå¹¶éæºäºé”™è¯¯æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Optional! Optionalä¸è¦ç”¨äºé›†åˆæ“ä½œ! ä¸è¦æ»¥ç”¨Optional,æ¯”å¦‚åœ¨java beançš„getterä¸­!","tags":["Java"],"categories":["Java"]},{"title":"Java æ€§èƒ½ä¼˜åŒ–ï¼š35 ä¸ªå°ç»†èŠ‚ï¼Œæå‡ä½ çš„ Java ä»£ç è¿è¡Œæ•ˆç‡","path":"/2023/12/25/Java-æ€§èƒ½ä¼˜åŒ–ï¼š35-ä¸ªå°ç»†èŠ‚ï¼Œæå‡ä½ çš„-Java-ä»£ç è¿è¡Œæ•ˆç‡/","content":"å‰è¨€ä»£ç ä¼˜åŒ– ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„è¯¾é¢˜ã€‚å¯èƒ½æœ‰äº›äººè§‰å¾—æ²¡ç”¨ï¼Œä¸€äº›ç»†å°çš„åœ°æ–¹æœ‰ä»€ä¹ˆå¥½ä¿®æ”¹çš„ï¼Œæ”¹ä¸ä¸æ”¹å¯¹äºä»£ç çš„è¿è¡Œæ•ˆç‡æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜æˆ‘æ˜¯è¿™ä¹ˆè€ƒè™‘çš„ï¼Œå°±åƒå¤§æµ·é‡Œé¢çš„é²¸é±¼ä¸€æ ·ï¼Œå®ƒåƒä¸€æ¡å°è™¾ç±³æœ‰ç”¨å—ï¼Ÿæ²¡ç”¨ï¼Œä½†æ˜¯ï¼Œåƒçš„å°è™¾ç±³ä¸€å¤šä¹‹åï¼Œé²¸é±¼å°±è¢«å–‚é¥±äº†ã€‚ ä»£ç ä¼˜åŒ–ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¦‚æœé¡¹ç›®ç€çœ¼äºå°½å¿«æ— BUGä¸Šçº¿ï¼Œé‚£ä¹ˆæ­¤æ—¶å¯ä»¥æŠ“å¤§æ”¾å°ï¼Œä»£ç çš„ç»†èŠ‚å¯ä»¥ä¸ç²¾æ‰“ç»†ç£¨ï¼›ä½†æ˜¯å¦‚æœæœ‰è¶³å¤Ÿçš„æ—¶é—´å¼€å‘ã€ç»´æŠ¤ä»£ç ï¼Œè¿™æ—¶å€™å°±å¿…é¡»è€ƒè™‘æ¯ä¸ªå¯ä»¥ä¼˜åŒ–çš„ç»†èŠ‚äº†ï¼Œä¸€ä¸ªä¸€ä¸ªç»†å°çš„ä¼˜åŒ–ç‚¹ç´¯ç§¯èµ·æ¥ï¼Œå¯¹äºä»£ç çš„è¿è¡Œæ•ˆç‡ç»å¯¹æ˜¯æœ‰æå‡çš„ã€‚ ä»£ç ä¼˜åŒ–çš„ç›®æ ‡æ˜¯ 1.å‡å°ä»£ç çš„ä½“ç§¯ 2.æé«˜ä»£ç è¿è¡Œçš„æ•ˆç‡ ä»£ç ä¼˜åŒ–ç»†èŠ‚1ã€å°½é‡æŒ‡å®šç±»ã€æ–¹æ³•çš„finalä¿®é¥°ç¬¦ å¸¦æœ‰finalä¿®é¥°ç¬¦çš„ç±»æ˜¯ä¸å¯æ´¾ç”Ÿçš„ã€‚åœ¨Javaæ ¸å¿ƒAPIä¸­ï¼Œæœ‰è®¸å¤šåº”ç”¨finalçš„ä¾‹å­ï¼Œä¾‹å¦‚java.lang.Stringï¼Œæ•´ä¸ªç±»éƒ½æ˜¯finalçš„ã€‚ä¸ºç±»æŒ‡å®šfinalä¿®é¥°ç¬¦å¯ä»¥è®©ç±»ä¸å¯ä»¥è¢«ç»§æ‰¿ï¼Œä¸ºæ–¹æ³•æŒ‡å®šfinalä¿®é¥°ç¬¦å¯ä»¥è®©æ–¹æ³•ä¸å¯ä»¥è¢«é‡å†™ã€‚å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªç±»ä¸ºfinalï¼Œåˆ™è¯¥ç±»æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯finalçš„ã€‚Javaç¼–è¯‘å™¨ä¼šå¯»æ‰¾æœºä¼šå†…è”æ‰€æœ‰çš„finalæ–¹æ³•ï¼Œå†…è”å¯¹äºæå‡Javaè¿è¡Œæ•ˆç‡ä½œç”¨é‡å¤§ï¼Œå…·ä½“å‚è§Javaè¿è¡ŒæœŸä¼˜åŒ–ã€‚ æ­¤ä¸¾èƒ½å¤Ÿä½¿æ€§èƒ½å¹³å‡æé«˜50% ã€‚ 2ã€å°½é‡é‡ç”¨å¯¹è±¡ ç‰¹åˆ«æ˜¯Stringå¯¹è±¡çš„ä½¿ç”¨ï¼Œå‡ºç°å­—ç¬¦ä¸²è¿æ¥æ—¶åº”è¯¥ä½¿ç”¨StringBuilder&#x2F;StringBufferä»£æ›¿ã€‚ç”±äºJavaè™šæ‹Ÿæœºä¸ä»…è¦èŠ±æ—¶é—´ç”Ÿæˆå¯¹è±¡ï¼Œä»¥åå¯èƒ½è¿˜éœ€è¦èŠ±æ—¶é—´å¯¹è¿™äº›å¯¹è±¡è¿›è¡Œåƒåœ¾å›æ”¶å’Œå¤„ç†ï¼Œå› æ­¤ï¼Œç”Ÿæˆè¿‡å¤šçš„å¯¹è±¡å°†ä¼šç»™ç¨‹åºçš„æ€§èƒ½å¸¦æ¥å¾ˆå¤§çš„å½±å“ã€‚ 3ã€å°½å¯èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡ è°ƒç”¨æ–¹æ³•æ—¶ä¼ é€’çš„å‚æ•°ä»¥åŠåœ¨è°ƒç”¨ä¸­åˆ›å»ºçš„ä¸´æ—¶å˜é‡éƒ½ä¿å­˜åœ¨æ ˆä¸­é€Ÿåº¦è¾ƒå¿«ï¼Œå…¶ä»–å˜é‡ï¼Œå¦‚é™æ€å˜é‡ã€å®ä¾‹å˜é‡ç­‰ï¼Œéƒ½åœ¨å †ä¸­åˆ›å»ºï¼Œé€Ÿåº¦è¾ƒæ…¢ã€‚å¦å¤–ï¼Œæ ˆä¸­åˆ›å»ºçš„å˜é‡ï¼Œéšç€æ–¹æ³•çš„è¿è¡Œç»“æŸï¼Œè¿™äº›å†…å®¹å°±æ²¡äº†ï¼Œä¸éœ€è¦é¢å¤–çš„åƒåœ¾å›æ”¶ã€‚ 4ã€åŠæ—¶å…³é—­æµ Javaç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œè¿›è¡Œæ•°æ®åº“è¿æ¥ã€I&#x2F;Oæµæ“ä½œæ—¶åŠ¡å¿…å°å¿ƒï¼Œåœ¨ä½¿ç”¨å®Œæ¯•åï¼ŒåŠæ—¶å…³é—­ä»¥é‡Šæ”¾èµ„æºã€‚å› ä¸ºå¯¹è¿™äº›å¤§å¯¹è±¡çš„æ“ä½œä¼šé€ æˆç³»ç»Ÿå¤§çš„å¼€é”€ï¼Œç¨æœ‰ä¸æ…ï¼Œå°†ä¼šå¯¼è‡´ä¸¥é‡çš„åæœã€‚ 5ã€å°½é‡å‡å°‘å¯¹å˜é‡çš„é‡å¤è®¡ç®— æ˜ç¡®ä¸€ä¸ªæ¦‚å¿µï¼Œå¯¹æ–¹æ³•çš„è°ƒç”¨ï¼Œå³ä½¿æ–¹æ³•ä¸­åªæœ‰ä¸€å¥è¯­å¥ï¼Œä¹Ÿæ˜¯æœ‰æ¶ˆè€—çš„ï¼ŒåŒ…æ‹¬åˆ›å»ºæ ˆå¸§ã€è°ƒç”¨æ–¹æ³•æ—¶ä¿æŠ¤ç°åœºã€è°ƒç”¨æ–¹æ³•å®Œæ¯•æ—¶æ¢å¤ç°åœºç­‰ã€‚æ‰€ä»¥ä¾‹å¦‚ä¸‹é¢çš„æ“ä½œï¼š 123for (int i = 0; i &lt; list.size(); i++) &#123; // todo ...&#125; å»ºè®®æ›¿æ¢ä¸ºï¼š 123for (int i = 0, int length = list.size(); i &lt; length; i++) &#123; // todo ...&#125; è¿™æ ·ï¼Œåœ¨list.size()å¾ˆå¤§çš„æ—¶å€™ï¼Œå°±å‡å°‘äº†å¾ˆå¤šçš„æ¶ˆè€— 6ã€å°½é‡é‡‡ç”¨æ‡’åŠ è½½çš„ç­–ç•¥ï¼Œå³åœ¨éœ€è¦çš„æ—¶å€™æ‰åˆ›å»º ä¾‹å¦‚ï¼š 1234String str = &quot;aaa&quot;;if (i == 1) &#123;\tlist.add(str);&#125; å»ºè®®æ›¿æ¢ä¸ºï¼š 1234if (i == 1) &#123;\tString str = &quot;aaa&quot;;\tlist.add(str);&#125; 7ã€æ…ç”¨å¼‚å¸¸ å¼‚å¸¸å¯¹æ€§èƒ½ä¸åˆ©ã€‚æŠ›å‡ºå¼‚å¸¸é¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ŒThrowableæ¥å£çš„æ„é€ å‡½æ•°è°ƒç”¨åä¸ºfillInStackTrace()çš„æœ¬åœ°åŒæ­¥æ–¹æ³•ï¼ŒfillInStackTrace()æ–¹æ³•æ£€æŸ¥å †æ ˆï¼Œæ”¶é›†è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ã€‚åªè¦æœ‰å¼‚å¸¸è¢«æŠ›å‡ºï¼ŒJavaè™šæ‹Ÿæœºå°±å¿…é¡»è°ƒæ•´è°ƒç”¨å †æ ˆï¼Œå› ä¸ºåœ¨å¤„ç†è¿‡ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚å¼‚å¸¸åªèƒ½ç”¨äºé”™è¯¯å¤„ç†ï¼Œä¸åº”è¯¥ç”¨æ¥æ§åˆ¶ç¨‹åºæµç¨‹ã€‚ 8ã€ä¸è¦åœ¨å¾ªç¯ä¸­ä½¿ç”¨tryâ€¦catchâ€¦ï¼Œåº”è¯¥æŠŠå…¶æ”¾åœ¨æœ€å¤–å±‚ é™¤éä¸å¾—å·²ã€‚å¦‚æœæ¯«æ— ç†ç”±åœ°è¿™ä¹ˆå†™äº†ï¼Œåªè¦ä½ çš„é¢†å¯¼èµ„æ·±ä¸€ç‚¹ã€æœ‰å¼ºè¿«ç—‡ä¸€ç‚¹ï¼Œå…«æˆå°±è¦éª‚ä½ ä¸ºä»€ä¹ˆå†™å‡ºè¿™ç§åƒåœ¾ä»£ç æ¥äº†ã€‚ 9ã€å¦‚æœèƒ½ä¼°è®¡åˆ°å¾…æ·»åŠ çš„å†…å®¹é•¿åº¦ï¼Œä¸ºåº•å±‚ä»¥æ•°ç»„æ–¹å¼å®ç°çš„é›†åˆã€å·¥å…·ç±»æŒ‡å®šåˆå§‹é•¿åº¦ æ¯”å¦‚ArrayListã€LinkedLlistã€StringBuilderã€StringBufferã€HashMapã€HashSetç­‰ç­‰ï¼Œä»¥StringBuilderä¸ºä¾‹ï¼š ï¼ˆ1ï¼‰StringBuilder() &#x2F;&#x2F; é»˜è®¤åˆ†é…16ä¸ªå­—ç¬¦çš„ç©ºé—´ ï¼ˆ2ï¼‰StringBuilder(int size) &#x2F;&#x2F; é»˜è®¤åˆ†é…sizeä¸ªå­—ç¬¦çš„ç©ºé—´ ï¼ˆ3ï¼‰StringBuilder(String str) &#x2F;&#x2F; é»˜è®¤åˆ†é…16ä¸ªå­—ç¬¦+str.length()ä¸ªå­—ç¬¦ç©ºé—´ å¯ä»¥é€šè¿‡ç±»ï¼ˆè¿™é‡ŒæŒ‡çš„ä¸ä»…ä»…æ˜¯ä¸Šé¢çš„StringBuilderï¼‰çš„æ¥è®¾å®šå®ƒçš„åˆå§‹åŒ–å®¹é‡ï¼Œè¿™æ ·å¯ä»¥æ˜æ˜¾åœ°æå‡æ€§èƒ½ã€‚æ¯”å¦‚StringBuilderå§ï¼Œlengthè¡¨ç¤ºå½“å‰çš„StringBuilderèƒ½ä¿æŒçš„å­—ç¬¦æ•°é‡ã€‚å› ä¸ºå½“StringBuilderè¾¾åˆ°æœ€å¤§å®¹é‡çš„æ—¶å€™ï¼Œå®ƒä¼šå°†è‡ªèº«å®¹é‡å¢åŠ åˆ°å½“å‰çš„2å€å†åŠ 2ï¼Œæ— è®ºä½•æ—¶åªè¦StringBuilderè¾¾åˆ°å®ƒçš„æœ€å¤§å®¹é‡ï¼Œå®ƒå°±ä¸å¾—ä¸åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦æ•°ç»„ç„¶åå°†æ—§çš„å­—ç¬¦æ•°ç»„å†…å®¹æ‹·è´åˆ°æ–°å­—ç¬¦æ•°ç»„ä¸­â€”-è¿™æ˜¯ååˆ†è€—è´¹æ€§èƒ½çš„ä¸€ä¸ªæ“ä½œã€‚è¯•æƒ³ï¼Œå¦‚æœèƒ½é¢„ä¼°åˆ°å­—ç¬¦æ•°ç»„ä¸­å¤§æ¦‚è¦å­˜æ”¾5000ä¸ªå­—ç¬¦è€Œä¸æŒ‡å®šé•¿åº¦ï¼Œæœ€æ¥è¿‘5000çš„2æ¬¡å¹‚æ˜¯4096ï¼Œæ¯æ¬¡æ‰©å®¹åŠ çš„2ä¸ç®¡ï¼Œé‚£ä¹ˆï¼š ï¼ˆ1ï¼‰åœ¨4096 çš„åŸºç¡€ä¸Šï¼Œå†ç”³è¯·8194ä¸ªå¤§å°çš„å­—ç¬¦æ•°ç»„ï¼ŒåŠ èµ·æ¥ç›¸å½“äºä¸€æ¬¡ç”³è¯·äº†12290ä¸ªå¤§å°çš„å­—ç¬¦æ•°ç»„ï¼Œå¦‚æœä¸€å¼€å§‹èƒ½æŒ‡å®š5000ä¸ªå¤§å°çš„å­—ç¬¦æ•°ç»„ï¼Œå°±èŠ‚çœäº†ä¸€å€ä»¥ä¸Šçš„ç©ºé—´ï¼› ï¼ˆ2ï¼‰æŠŠåŸæ¥çš„4096ä¸ªå­—ç¬¦æ‹·è´åˆ°æ–°çš„çš„å­—ç¬¦æ•°ç»„ä¸­å»ã€‚ è¿™æ ·ï¼Œæ—¢æµªè´¹å†…å­˜ç©ºé—´åˆé™ä½ä»£ç è¿è¡Œæ•ˆç‡ã€‚æ‰€ä»¥ï¼Œç»™åº•å±‚ä»¥æ•°ç»„å®ç°çš„é›†åˆã€å·¥å…·ç±»è®¾ç½®ä¸€ä¸ªåˆç†çš„åˆå§‹åŒ–å®¹é‡æ˜¯é”™ä¸äº†çš„ï¼Œè¿™ä¼šå¸¦æ¥ç«‹ç«¿è§å½±çš„æ•ˆæœã€‚ä½†æ˜¯ï¼Œæ³¨æ„ï¼ŒåƒHashMapè¿™ç§æ˜¯ä»¥æ•°ç»„+é“¾è¡¨å®ç°çš„é›†åˆï¼Œåˆ«æŠŠåˆå§‹å¤§å°å’Œä½ ä¼°è®¡çš„å¤§å°è®¾ç½®å¾—ä¸€æ ·ï¼Œå› ä¸ºä¸€ä¸ªtableä¸Šåªè¿æ¥ä¸€ä¸ªå¯¹è±¡çš„å¯èƒ½æ€§å‡ ä¹ä¸º0ã€‚åˆå§‹å¤§å°å»ºè®®è®¾ç½®ä¸º2çš„Næ¬¡å¹‚ï¼Œå¦‚æœèƒ½ä¼°è®¡åˆ°æœ‰2000ä¸ªå…ƒç´ ï¼Œè®¾ç½®æˆnew HashMap(128)ã€new HashMap(256)éƒ½å¯ä»¥ã€‚ 10ã€å½“å¤åˆ¶å¤§é‡æ•°æ®æ—¶ï¼Œä½¿ç”¨System.arraycopy()å‘½ä»¤ 11ã€ä¹˜æ³•å’Œé™¤æ³•ä½¿ç”¨ç§»ä½æ“ä½œ ä¾‹å¦‚ï¼š 1234for (val = 0; val &lt; 100000; val += 5) &#123;\ta = val * 8;\tb = val / 2;&#125; ç”¨ç§»ä½æ“ä½œå¯ä»¥æå¤§åœ°æé«˜æ€§èƒ½ï¼Œå› ä¸ºåœ¨è®¡ç®—æœºåº•å±‚ï¼Œå¯¹ä½çš„æ“ä½œæ˜¯æœ€æ–¹ä¾¿ã€æœ€å¿«çš„ï¼Œå› æ­¤å»ºè®®ä¿®æ”¹ä¸ºï¼š 1234for (val = 0; val &lt; 100000; val += 5) &#123;\ta = val &lt;&lt; 3;\tb = val &gt;&gt; 1;&#125; ç§»ä½æ“ä½œè™½ç„¶å¿«ï¼Œä½†æ˜¯å¯èƒ½ä¼šä½¿ä»£ç ä¸å¤ªå¥½ç†è§£ï¼Œå› æ­¤æœ€å¥½åŠ ä¸Šç›¸åº”çš„æ³¨é‡Šã€‚ 12ã€å¾ªç¯å†…ä¸è¦ä¸æ–­åˆ›å»ºå¯¹è±¡å¼•ç”¨ ä¾‹å¦‚ï¼š 123for (int i = 1; i &lt;= count; i++) &#123;\tObject obj = new Object();&#125; è¿™ç§åšæ³•ä¼šå¯¼è‡´å†…å­˜ä¸­æœ‰countä»½Objectå¯¹è±¡å¼•ç”¨å­˜åœ¨ï¼Œcountå¾ˆå¤§çš„è¯ï¼Œå°±è€—è´¹å†…å­˜äº†ï¼Œå»ºè®®ä¸ºæ”¹ä¸ºï¼š 1234Object obj = null;for (int i = 0; i &lt;= count; i++) &#123; obj = new Object(); &#125; è¿™æ ·çš„è¯ï¼Œå†…å­˜ä¸­åªæœ‰ä¸€ä»½Objectå¯¹è±¡å¼•ç”¨ï¼Œæ¯æ¬¡new Object()çš„æ—¶å€™ï¼ŒObjectå¯¹è±¡å¼•ç”¨æŒ‡å‘ä¸åŒçš„Objectç½¢äº†ï¼Œä½†æ˜¯å†…å­˜ä¸­åªæœ‰ä¸€ä»½ï¼Œè¿™æ ·å°±å¤§å¤§èŠ‚çœäº†å†…å­˜ç©ºé—´äº†ã€‚ 13ã€åŸºäºæ•ˆç‡å’Œç±»å‹æ£€æŸ¥çš„è€ƒè™‘ï¼Œåº”è¯¥å°½å¯èƒ½ä½¿ç”¨arrayï¼Œæ— æ³•ç¡®å®šæ•°ç»„å¤§å°æ—¶æ‰ä½¿ç”¨ArrayList 14ã€å°½é‡ä½¿ç”¨HashMapã€ArrayListã€StringBuilderï¼Œé™¤éçº¿ç¨‹å®‰å…¨éœ€è¦ï¼Œå¦åˆ™ä¸æ¨èä½¿ç”¨Hashtableã€Vectorã€StringBufferï¼Œåä¸‰è€…ç”±äºä½¿ç”¨åŒæ­¥æœºåˆ¶è€Œå¯¼è‡´äº†æ€§èƒ½å¼€é”€ 15ã€ä¸è¦å°†æ•°ç»„å£°æ˜ä¸ºpublic static final å› ä¸ºè¿™æ¯«æ— æ„ä¹‰ï¼Œè¿™æ ·åªæ˜¯å®šä¹‰äº†å¼•ç”¨ä¸ºstatic finalï¼Œæ•°ç»„çš„å†…å®¹è¿˜æ˜¯å¯ä»¥éšæ„æ”¹å˜çš„ï¼Œå°†æ•°ç»„å£°æ˜ä¸ºpublicæ›´æ˜¯ä¸€ä¸ªå®‰å…¨æ¼æ´ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªæ•°ç»„å¯ä»¥è¢«å¤–éƒ¨ç±»æ‰€æ”¹å˜ã€‚ 16ã€å°½é‡åœ¨åˆé€‚çš„åœºåˆä½¿ç”¨å•ä¾‹ ä½¿ç”¨å•ä¾‹å¯ä»¥å‡è½»åŠ è½½çš„è´Ÿæ‹…ã€ç¼©çŸ­åŠ è½½çš„æ—¶é—´ã€æé«˜åŠ è½½çš„æ•ˆç‡ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰åœ°æ–¹éƒ½é€‚ç”¨äºå•ä¾‹ï¼Œç®€å•æ¥è¯´ï¼Œå•ä¾‹ä¸»è¦é€‚ç”¨äºä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š ï¼ˆ1ï¼‰æ§åˆ¶èµ„æºçš„ä½¿ç”¨ï¼Œé€šè¿‡çº¿ç¨‹åŒæ­¥æ¥æ§åˆ¶èµ„æºçš„å¹¶å‘è®¿é—® ï¼ˆ2ï¼‰æ§åˆ¶å®ä¾‹çš„äº§ç”Ÿï¼Œä»¥è¾¾åˆ°èŠ‚çº¦èµ„æºçš„ç›®çš„ ï¼ˆ3ï¼‰æ§åˆ¶æ•°æ®çš„å…±äº«ï¼Œåœ¨ä¸å»ºç«‹ç›´æ¥å…³è”çš„æ¡ä»¶ä¸‹ï¼Œè®©å¤šä¸ªä¸ç›¸å…³çš„è¿›ç¨‹æˆ–çº¿ç¨‹ä¹‹é—´å®ç°é€šä¿¡ 17ã€å°½é‡é¿å…éšæ„ä½¿ç”¨é™æ€å˜é‡ è¦çŸ¥é“ï¼Œå½“æŸä¸ªå¯¹è±¡è¢«å®šä¹‰ä¸ºstaticçš„å˜é‡æ‰€å¼•ç”¨ï¼Œé‚£ä¹ˆgcé€šå¸¸æ˜¯ä¸ä¼šå›æ”¶è¿™ä¸ªå¯¹è±¡æ‰€å æœ‰çš„å †å†…å­˜çš„ï¼Œå¦‚ï¼š 123public class A &#123;\tprivate static B b = new B();&#125; æ­¤æ—¶é™æ€å˜é‡bçš„ç”Ÿå‘½å‘¨æœŸä¸Aç±»ç›¸åŒï¼Œå¦‚æœAç±»ä¸è¢«å¸è½½ï¼Œé‚£ä¹ˆå¼•ç”¨BæŒ‡å‘çš„Bå¯¹è±¡ä¼šå¸¸é©»å†…å­˜ï¼Œç›´åˆ°ç¨‹åºç»ˆæ­¢ 18ã€åŠæ—¶æ¸…é™¤ä¸å†éœ€è¦çš„ä¼šè¯ ä¸ºäº†æ¸…é™¤ä¸å†æ´»åŠ¨çš„ä¼šè¯ï¼Œè®¸å¤šåº”ç”¨æœåŠ¡å™¨éƒ½æœ‰é»˜è®¤çš„ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œä¸€èˆ¬ä¸º30åˆ†é’Ÿã€‚å½“åº”ç”¨æœåŠ¡å™¨éœ€è¦ä¿å­˜æ›´å¤šçš„ä¼šè¯æ—¶ï¼Œå¦‚æœå†…å­˜ä¸è¶³ï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿä¼šæŠŠéƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç£ç›˜ï¼Œåº”ç”¨æœåŠ¡å™¨ä¹Ÿå¯èƒ½æ ¹æ®MRUï¼ˆæœ€è¿‘æœ€é¢‘ç¹ä½¿ç”¨ï¼‰ç®—æ³•æŠŠéƒ¨åˆ†ä¸æ´»è·ƒçš„ä¼šè¯è½¬å‚¨åˆ°ç£ç›˜ï¼Œç”šè‡³å¯èƒ½æŠ›å‡ºå†…å­˜ä¸è¶³çš„å¼‚å¸¸ã€‚å¦‚æœä¼šè¯è¦è¢«è½¬å‚¨åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆå¿…é¡»è¦å…ˆè¢«åºåˆ—åŒ–ï¼Œåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­ï¼Œå¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–çš„ä»£ä»·æ˜¯å¾ˆæ˜‚è´µçš„ã€‚å› æ­¤ï¼Œå½“ä¼šè¯ä¸å†éœ€è¦æ—¶ï¼Œåº”å½“åŠæ—¶è°ƒç”¨HttpSessionçš„invalidate()æ–¹æ³•æ¸…é™¤ä¼šè¯ã€‚ 19ã€å®ç°RandomAccessæ¥å£çš„é›†åˆæ¯”å¦‚ArrayListï¼Œåº”å½“ä½¿ç”¨æœ€æ™®é€šçš„forå¾ªç¯è€Œä¸æ˜¯foreachå¾ªç¯æ¥éå† è¿™æ˜¯JDKæ¨èç»™ç”¨æˆ·çš„ã€‚JDK APIå¯¹äºRandomAccessæ¥å£çš„è§£é‡Šæ˜¯ï¼šå®ç°RandomAccessæ¥å£ç”¨æ¥è¡¨æ˜å…¶æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼Œæ­¤æ¥å£çš„ä¸»è¦ç›®çš„æ˜¯å…è®¸ä¸€èˆ¬çš„ç®—æ³•æ›´æ”¹å…¶è¡Œä¸ºï¼Œä»è€Œå°†å…¶åº”ç”¨åˆ°éšæœºæˆ–è¿ç»­è®¿é—®åˆ—è¡¨æ—¶èƒ½æä¾›è‰¯å¥½çš„æ€§èƒ½ã€‚å®é™…ç»éªŒè¡¨æ˜ï¼Œå®ç°RandomAccessæ¥å£çš„ç±»å®ä¾‹ï¼Œå‡å¦‚æ˜¯éšæœºè®¿é—®çš„ï¼Œä½¿ç”¨æ™®é€šforå¾ªç¯æ•ˆç‡å°†é«˜äºä½¿ç”¨foreachå¾ªç¯ï¼›åè¿‡æ¥ï¼Œå¦‚æœæ˜¯é¡ºåºè®¿é—®çš„ï¼Œåˆ™ä½¿ç”¨Iteratorä¼šæ•ˆç‡æ›´é«˜ã€‚å¯ä»¥ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹çš„ä»£ç ä½œåˆ¤æ–­ 12345678910if (list instanceof RandomAccess) &#123; for (int i = 0; i &lt; list.size(); i++) &#123; &#125;&#125; else &#123; Iterator&lt;?&gt; iterator = list.iterable(); while (iterator.hasNext()) &#123; iterator.next() &#125;&#125; foreachå¾ªç¯çš„åº•å±‚å®ç°åŸç†å°±æ˜¯è¿­ä»£å™¨Iteratorï¼Œå‚è§Javaè¯­æ³•ç³–1ï¼šå¯å˜é•¿åº¦å‚æ•°ä»¥åŠforeachå¾ªç¯åŸç†ã€‚æ‰€ä»¥ååŠå¥â€åè¿‡æ¥ï¼Œå¦‚æœæ˜¯é¡ºåºè®¿é—®çš„ï¼Œåˆ™ä½¿ç”¨Iteratorä¼šæ•ˆç‡æ›´é«˜â€çš„æ„æ€å°±æ˜¯é¡ºåºè®¿é—®çš„é‚£äº›ç±»å®ä¾‹ï¼Œä½¿ç”¨foreachå¾ªç¯å»éå†ã€‚ 20ã€ä½¿ç”¨åŒæ­¥ä»£ç å—æ›¿ä»£åŒæ­¥æ–¹æ³• è¿™ç‚¹åœ¨å¤šçº¿ç¨‹æ¨¡å—ä¸­çš„synchronizedé”æ–¹æ³•å—ä¸€æ–‡ä¸­å·²ç»è®²å¾—å¾ˆæ¸…æ¥šäº†ï¼Œé™¤éèƒ½ç¡®å®šä¸€æ•´ä¸ªæ–¹æ³•éƒ½æ˜¯éœ€è¦è¿›è¡ŒåŒæ­¥çš„ï¼Œå¦åˆ™å°½é‡ä½¿ç”¨åŒæ­¥ä»£ç å—ï¼Œé¿å…å¯¹é‚£äº›ä¸éœ€è¦è¿›è¡ŒåŒæ­¥çš„ä»£ç ä¹Ÿè¿›è¡Œäº†åŒæ­¥ï¼Œå½±å“äº†ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚ 21ã€å°†å¸¸é‡å£°æ˜ä¸ºstatic finalï¼Œå¹¶ä»¥å¤§å†™å‘½å è¿™æ ·åœ¨ç¼–è¯‘æœŸé—´å°±å¯ä»¥æŠŠè¿™äº›å†…å®¹æ”¾å…¥å¸¸é‡æ± ä¸­ï¼Œé¿å…è¿è¡ŒæœŸé—´è®¡ç®—ç”Ÿæˆå¸¸é‡çš„å€¼ã€‚å¦å¤–ï¼Œå°†å¸¸é‡çš„åå­—ä»¥å¤§å†™å‘½åä¹Ÿå¯ä»¥æ–¹ä¾¿åŒºåˆ†å‡ºå¸¸é‡ä¸å˜é‡ 22ã€ä¸è¦åˆ›å»ºä¸€äº›ä¸ä½¿ç”¨çš„å¯¹è±¡ï¼Œä¸è¦å¯¼å…¥ä¸€äº›ä¸ä½¿ç”¨çš„ç±» è¿™æ¯«æ— æ„ä¹‰ï¼Œå¦‚æœä»£ç ä¸­å‡ºç°â€The value of the local variable i is not usedâ€ã€â€The import java.util is never usedâ€ï¼Œé‚£ä¹ˆè¯·åˆ é™¤è¿™äº›æ— ç”¨çš„å†…å®¹ 23ã€ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­é¿å…ä½¿ç”¨åå°„ å…³äºï¼Œè¯·å‚è§åå°„ã€‚åå°„æ˜¯Javaæä¾›ç»™ç”¨æˆ·ä¸€ä¸ªå¾ˆå¼ºå¤§çš„åŠŸèƒ½ï¼ŒåŠŸèƒ½å¼ºå¤§å¾€å¾€æ„å‘³ç€æ•ˆç‡ä¸é«˜ã€‚ä¸å»ºè®®åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨å°¤å…¶æ˜¯é¢‘ç¹ä½¿ç”¨åå°„æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯Methodçš„invokeæ–¹æ³•ï¼Œå¦‚æœç¡®å®æœ‰å¿…è¦ï¼Œä¸€ç§å»ºè®®æ€§çš„åšæ³•æ˜¯å°†é‚£äº›éœ€è¦é€šè¿‡åå°„åŠ è½½çš„ç±»åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™é€šè¿‡åå°„å®ä¾‹åŒ–å‡ºä¸€ä¸ªå¯¹è±¡å¹¶æ”¾å…¥å†…å­˜â€”-ç”¨æˆ·åªå…³å¿ƒå’Œå¯¹ç«¯äº¤äº’çš„æ—¶å€™è·å–æœ€å¿«çš„å“åº”é€Ÿåº¦ï¼Œå¹¶ä¸å…³å¿ƒå¯¹ç«¯çš„é¡¹ç›®å¯åŠ¨èŠ±å¤šä¹…æ—¶é—´ã€‚ 24ã€ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± å’Œçº¿ç¨‹æ±  è¿™ä¸¤ä¸ªæ± éƒ½æ˜¯ç”¨äºé‡ç”¨å¯¹è±¡çš„ï¼Œå‰è€…å¯ä»¥é¿å…é¢‘ç¹åœ°æ‰“å¼€å’Œå…³é—­è¿æ¥ï¼Œåè€…å¯ä»¥é¿å…é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ 25ã€ä½¿ç”¨å¸¦ç¼“å†²çš„è¾“å…¥è¾“å‡ºæµè¿›è¡ŒIOæ“ä½œ å¸¦ç¼“å†²çš„è¾“å…¥è¾“å‡ºæµï¼Œå³BufferedReaderã€BufferedWriterã€BufferedInputStreamã€BufferedOutputStreamï¼Œè¿™å¯ä»¥æå¤§åœ°æå‡IOæ•ˆç‡ 26ã€é¡ºåºæ’å…¥å’Œéšæœºè®¿é—®æ¯”è¾ƒå¤šçš„åœºæ™¯ä½¿ç”¨ArrayListï¼Œå…ƒç´ åˆ é™¤å’Œä¸­é—´æ’å…¥æ¯”è¾ƒå¤šçš„åœºæ™¯ä½¿ç”¨LinkedListè¿™ä¸ªï¼Œç†è§£ArrayListå’ŒLinkedListçš„åŸç†å°±çŸ¥é“äº† 27ã€ä¸è¦è®©publicæ–¹æ³•ä¸­æœ‰å¤ªå¤šçš„å½¢å‚ publicæ–¹æ³•å³å¯¹å¤–æä¾›çš„æ–¹æ³•ï¼Œå¦‚æœç»™è¿™äº›æ–¹æ³•å¤ªå¤šå½¢å‚çš„è¯ä¸»è¦æœ‰ä¸¤ç‚¹åå¤„ï¼š 1ã€è¿åäº†é¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³ï¼ŒJavaè®²æ±‚ä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼Œå¤ªå¤šçš„å½¢å‚ï¼Œå’Œé¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³å¹¶ä¸å¥‘åˆ 2ã€å‚æ•°å¤ªå¤šåŠ¿å¿…å¯¼è‡´æ–¹æ³•è°ƒç”¨çš„å‡ºé”™æ¦‚ç‡å¢åŠ  è‡³äºè¿™ä¸ªâ€å¤ªå¤šâ€æŒ‡çš„æ˜¯å¤šå°‘ä¸ªï¼Œ3ã€4ä¸ªå§ã€‚æ¯”å¦‚æˆ‘ä»¬ç”¨JDBCå†™ä¸€ä¸ªinsertStudentInfoæ–¹æ³•ï¼Œæœ‰10ä¸ªå­¦ç”Ÿä¿¡æ¯å­—æ®µè¦æ’å¦‚Studentè¡¨ä¸­ï¼Œå¯ä»¥æŠŠè¿™10ä¸ªå‚æ•°å°è£…åœ¨ä¸€ä¸ªå®ä½“ç±»ä¸­ï¼Œä½œä¸ºinsertæ–¹æ³•çš„å½¢å‚ã€‚ 28ã€å­—ç¬¦ä¸²å˜é‡å’Œå­—ç¬¦ä¸²å¸¸é‡equalsçš„æ—¶å€™å°†å­—ç¬¦ä¸²å¸¸é‡å†™åœ¨å‰é¢ è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„å°æŠ€å·§äº†ï¼Œå¦‚æœæœ‰ä»¥ä¸‹ä»£ç ï¼š 12345678String str = &quot;123&quot;;if (str.equals(&quot;123&quot;)) &#123; // todo...&#125;// å»ºè®®ä¿®æ”¹ä¸ºï¼šString str = &quot;123&quot;;if (&quot;123&quot;.equals(str)) &#123; // todo ...&#125; è¿™ä¹ˆåšä¸»è¦æ˜¯å¯ä»¥é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸ 29ã€è¯·çŸ¥é“ï¼Œåœ¨javaä¸­if (i &#x3D;&#x3D; 1)å’Œif (1 &#x3D;&#x3D; i)æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œä½†ä»é˜…è¯»ä¹ æƒ¯ä¸Šè®²ï¼Œå»ºè®®ä½¿ç”¨å‰è€… å¹³æ—¶æœ‰äººé—®ï¼Œâ€if (i &#x3D;&#x3D; 1)â€å’Œâ€if (1&#x3D;&#x3D; i)â€æœ‰æ²¡æœ‰åŒºåˆ«ï¼Œè¿™å°±è¦ä»C&#x2F;C++è®²èµ·ã€‚ åœ¨C&#x2F;C++ä¸­ï¼Œâ€if (i &#x3D;&#x3D; 1)â€åˆ¤æ–­æ¡ä»¶æˆç«‹ï¼Œæ˜¯ä»¥0ä¸é0ä¸ºåŸºå‡†çš„ï¼Œ0è¡¨ç¤ºfalseï¼Œé0è¡¨ç¤ºtrueï¼Œå¦‚æœæœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š 123456int i = 2;if (i == 1) &#123; // todo ...&#125; else &#123;\t// todo ...&#125; C&#x2F;C++åˆ¤æ–­â€i&#x3D;&#x3D;1â€³ä¸æˆç«‹ï¼Œæ‰€ä»¥ä»¥0è¡¨ç¤ºï¼Œå³falseã€‚ä½†æ˜¯å¦‚æœï¼š 123456int i = 2;if (i = 1) &#123; // todo ... &#125; else &#123; // todo ... &#125; ä¸‡ä¸€ç¨‹åºå‘˜ä¸€ä¸ªä¸å°å¿ƒï¼ŒæŠŠâ€if (i &#x3D;&#x3D; 1)â€å†™æˆâ€if (i &#x3D; 1)â€ï¼Œè¿™æ ·å°±æœ‰é—®é¢˜äº†ã€‚åœ¨ifä¹‹å†…å°†ièµ‹å€¼ä¸º1ï¼Œifåˆ¤æ–­é‡Œé¢çš„å†…å®¹é0ï¼Œè¿”å›çš„å°±æ˜¯trueäº†ï¼Œä½†æ˜¯æ˜æ˜iä¸º2ï¼Œæ¯”è¾ƒçš„å€¼æ˜¯1ï¼Œåº”è¯¥è¿”å›çš„falseã€‚è¿™ç§æƒ…å†µåœ¨C&#x2F;C++çš„å¼€å‘ä¸­æ˜¯å¾ˆå¯èƒ½å‘ç”Ÿçš„å¹¶ä¸”ä¼šå¯¼è‡´ä¸€äº›éš¾ä»¥ç†è§£çš„é”™è¯¯äº§ç”Ÿï¼Œæ‰€ä»¥ï¼Œä¸ºäº†é¿å…å¼€å‘è€…åœ¨ifè¯­å¥ä¸­ä¸æ­£ç¡®çš„èµ‹å€¼æ“ä½œï¼Œå»ºè®®å°†ifè¯­å¥å†™ä¸ºï¼š 123456int i = 2;if (1 == i) &#123; // todo ... &#125; else &#123; // todo ... &#125; è¿™æ ·ï¼Œå³ä½¿å¼€å‘è€…ä¸å°å¿ƒå†™æˆäº†â€1 &#x3D; iâ€ï¼ŒC&#x2F;C++ç¼–è¯‘å™¨ä¹Ÿå¯ä»¥ç¬¬ä¸€æ—¶é—´æ£€æŸ¥å‡ºæ¥ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å¯¹ä¸€ä¸ªå˜é‡èµ‹å€¼iä¸º1ï¼Œä½†æ˜¯ä¸èƒ½å¯¹ä¸€ä¸ªå¸¸é‡èµ‹å€¼1ä¸ºiã€‚ ä½†æ˜¯ï¼Œåœ¨Javaä¸­ï¼ŒC&#x2F;C++è¿™ç§â€if (i &#x3D; 1)â€çš„è¯­æ³•æ˜¯ä¸å¯èƒ½å‡ºç°çš„ï¼Œå› ä¸ºä¸€æ—¦å†™äº†è¿™ç§è¯­æ³•ï¼ŒJavaå°±ä¼šç¼–è¯‘æŠ¥é”™â€Type mismatch: cannot convert from int to booleanâ€ã€‚ä½†æ˜¯ï¼Œå°½ç®¡Javaçš„â€if (i &#x3D;&#x3D; 1)â€å’Œâ€if (1 &#x3D;&#x3D; i)â€åœ¨è¯­ä¹‰ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä½†æ˜¯ä»é˜…è¯»ä¹ æƒ¯ä¸Šè®²ï¼Œå»ºè®®ä½¿ç”¨å‰è€…ä¼šæ›´å¥½äº›ã€‚ 30ã€ä¸è¦å¯¹æ•°ç»„ä½¿ç”¨toString()æ–¹æ³• çœ‹ä¸€ä¸‹å¯¹æ•°ç»„ä½¿ç”¨toString()æ‰“å°å‡ºæ¥çš„æ˜¯ä»€ä¹ˆï¼š 1234public static void main(String[] args) &#123; int[] is = new int[]&#123;1, 2, 3&#125;;\tSystem.out.println(is.toString());&#125; ç»“æœæ˜¯ï¼š 1[I@18a992f æœ¬æ„æ˜¯æƒ³æ‰“å°å‡ºæ•°ç»„å†…å®¹ï¼Œå´æœ‰å¯èƒ½å› ä¸ºæ•°ç»„å¼•ç”¨isä¸ºç©ºè€Œå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ä¸è¿‡è™½ç„¶å¯¹æ•°ç»„toString()æ²¡æœ‰æ„ä¹‰ï¼Œä½†æ˜¯å¯¹é›†åˆtoString()æ˜¯å¯ä»¥æ‰“å°å‡ºé›†åˆé‡Œé¢çš„å†…å®¹çš„ï¼Œå› ä¸ºé›†åˆçš„çˆ¶ç±»AbstractCollectionsé‡å†™äº†Objectçš„toString()æ–¹æ³•ã€‚ 31ã€ä¸è¦å¯¹è¶…å‡ºèŒƒå›´çš„åŸºæœ¬æ•°æ®ç±»å‹åšå‘ä¸‹å¼ºåˆ¶è½¬å‹ è¿™ç»ä¸ä¼šå¾—åˆ°æƒ³è¦çš„ç»“æœï¼š 12345public static void main(String[] args) &#123; long l = 12345678901234L; int i = (int)l; System.out.println(i);&#125; æˆ‘ä»¬å¯èƒ½æœŸæœ›å¾—åˆ°å…¶ä¸­çš„æŸå‡ ä½ï¼Œä½†æ˜¯ç»“æœå´æ˜¯ï¼š 11942892530 è§£é‡Šä¸€ä¸‹ã€‚Javaä¸­longæ˜¯8ä¸ªå­—èŠ‚64ä½çš„ï¼Œæ‰€ä»¥12345678901234åœ¨è®¡ç®—æœºä¸­çš„è¡¨ç¤ºåº”è¯¥æ˜¯ï¼š 10000 0000 0000 0000 0000 1011 0011 1010 0111 0011 1100 1110 0010 1111 1111 0010 ä¸€ä¸ªintå‹æ•°æ®æ˜¯4ä¸ªå­—èŠ‚32ä½çš„ï¼Œä»ä½ä½å–å‡ºä¸Šé¢è¿™ä¸²äºŒè¿›åˆ¶æ•°æ®çš„å‰32ä½æ˜¯ï¼š 10111 0011 1100 1110 0010 1111 1111 0010 è¿™ä¸²äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºåè¿›åˆ¶1942892530ï¼Œæ‰€ä»¥å°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„æ§åˆ¶å°ä¸Šè¾“å‡ºçš„å†…å®¹ã€‚ä»è¿™ä¸ªä¾‹å­ä¸Šè¿˜èƒ½é¡ºä¾¿å¾—åˆ°ä¸¤ä¸ªç»“è®º 1ã€æ•´å‹é»˜è®¤çš„æ•°æ®ç±»å‹æ˜¯intï¼Œlong l &#x3D; 12345678901234Lï¼Œè¿™ä¸ªæ•°å­—å·²ç»è¶…å‡ºäº†intçš„èŒƒå›´äº†ï¼Œæ‰€ä»¥æœ€åæœ‰ä¸€ä¸ªLï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªlongå‹æ•°ã€‚é¡ºä¾¿ï¼Œæµ®ç‚¹å‹çš„é»˜è®¤ç±»å‹æ˜¯doubleï¼Œæ‰€ä»¥å®šä¹‰floatçš„æ—¶å€™è¦å†™æˆâ€â€float f &#x3D; 3.5fâ€ 2ã€æ¥ä¸‹æ¥å†å†™ä¸€å¥â€int ii &#x3D; l + i;â€ä¼šæŠ¥é”™ï¼Œå› ä¸ºlong + intæ˜¯ä¸€ä¸ªlongï¼Œä¸èƒ½èµ‹å€¼ç»™int 32ã€å…¬ç”¨çš„é›†åˆç±»ä¸­ä¸ä½¿ç”¨çš„æ•°æ®ä¸€å®šè¦åŠæ—¶removeæ‰ å¦‚æœä¸€ä¸ªé›†åˆç±»æ˜¯å…¬ç”¨çš„ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯æ–¹æ³•é‡Œé¢çš„å±æ€§ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªé›†åˆé‡Œé¢çš„å…ƒç´ æ˜¯ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾çš„ï¼Œå› ä¸ºå§‹ç»ˆæœ‰å¼•ç”¨æŒ‡å‘å®ƒä»¬ã€‚æ‰€ä»¥ï¼Œå¦‚æœå…¬ç”¨é›†åˆé‡Œé¢çš„æŸäº›æ•°æ®ä¸ä½¿ç”¨è€Œä¸å»removeæ‰å®ƒä»¬ï¼Œé‚£ä¹ˆå°†ä¼šé€ æˆè¿™ä¸ªå…¬ç”¨é›†åˆä¸æ–­å¢å¤§ï¼Œä½¿å¾—ç³»ç»Ÿæœ‰å†…å­˜æ³„éœ²çš„éšæ‚£ã€‚ 33ã€æŠŠä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹è½¬ä¸ºå­—ç¬¦ä¸²ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹.toString()æ˜¯æœ€å¿«çš„æ–¹å¼ã€String.valueOf(æ•°æ®)æ¬¡ä¹‹ã€æ•°æ®+â€â€æœ€æ…¢ æŠŠä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹è½¬ä¸ºä¸€èˆ¬æœ‰ä¸‰ç§æ–¹å¼ï¼Œæˆ‘æœ‰ä¸€ä¸ªIntegerå‹æ•°æ®iï¼Œå¯ä»¥ä½¿ç”¨i.toString()ã€String.valueOf(i)ã€i+â€â€ä¸‰ç§æ–¹å¼ï¼Œä¸‰ç§æ–¹å¼çš„æ•ˆç‡å¦‚ä½•ï¼Œçœ‹ä¸€ä¸ªæµ‹è¯•ï¼š 12345678910111213141516171819202122public static void main(String[] args) &#123; int loopTime = 50000;\tInteger i = 0;\tlong startTime = System.currentTimeMillis(); for (int j = 0; j &lt; loopTime; j++) &#123; String str = String.valueOf(i); &#125;\tSystem.out.println(&quot;String.valueOf()ï¼š&quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;); startTime = System.currentTimeMillis(); for (int j = 0; j &lt; loopTime; j++) &#123;\tString str = i.toString();\t&#125;\tSystem.out.println(&quot;Integer.toString()ï¼š&quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;); startTime = System.currentTimeMillis(); for (int j = 0; j &lt; loopTime; j++) &#123; String str = i + &quot;&quot;;\t&#125;\tSystem.out.println(&quot;i + \\&quot;\\&quot;ï¼š&quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;);&#125; è¿è¡Œç»“æœä¸ºï¼š 123String.valueOf()ï¼š11ms Integer.toString()ï¼š5ms i + &quot;&quot;ï¼š25ms æ‰€ä»¥ä»¥åé‡åˆ°æŠŠä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹è½¬ä¸ºStringçš„æ—¶å€™ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨toString()æ–¹æ³•ã€‚è‡³äºä¸ºä»€ä¹ˆï¼Œå¾ˆç®€å•ï¼š 1ã€String.valueOf()æ–¹æ³•åº•å±‚è°ƒç”¨äº†Integer.toString()æ–¹æ³•ï¼Œä½†æ˜¯ä¼šåœ¨è°ƒç”¨å‰åšç©ºåˆ¤æ–­ 2ã€Integer.toString()æ–¹æ³•å°±ä¸è¯´äº†ï¼Œç›´æ¥è°ƒç”¨äº† 3ã€i + â€œâ€åº•å±‚ä½¿ç”¨äº†StringBuilderå®ç°ï¼Œå…ˆç”¨appendæ–¹æ³•æ‹¼æ¥ï¼Œå†ç”¨toString()æ–¹æ³•è·å–å­—ç¬¦ä¸² ä¸‰è€…å¯¹æ¯”ä¸‹æ¥ï¼Œæ˜æ˜¾æ˜¯2æœ€å¿«ã€1æ¬¡ä¹‹ã€3æœ€æ…¢ 34ã€ä½¿ç”¨æœ€æœ‰æ•ˆç‡çš„æ–¹å¼å»éå†Map éå†Mapçš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œé€šå¸¸åœºæ™¯ä¸‹æˆ‘ä»¬éœ€è¦çš„æ˜¯éå†Mapä¸­çš„Keyå’ŒValueï¼Œé‚£ä¹ˆæ¨èä½¿ç”¨çš„ã€æ•ˆç‡æœ€é«˜çš„æ–¹å¼æ˜¯ï¼š 1234567891011public static void main(String[] args) &#123;\tHashMap&lt;String, String&gt; hm = new HashMap&lt;String, String&gt;(); hm.put(&quot;111&quot;, &quot;222&quot;); Set&lt;Map.Entry&lt;String, String&gt;&gt; entrySet = hm.entrySet(); Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iter = entrySet.iterator(); while (iter.hasNext()) &#123; Map.Entry&lt;String, String&gt; entry = iter.next(); System.out.println(entry.getKey() + &quot;\\t&quot; + entry.getValue());\t&#125;&#125; å¦‚æœä½ åªæ˜¯æƒ³éå†ä¸€ä¸‹è¿™ä¸ªMapçš„keyå€¼ï¼Œé‚£ç”¨â€Set keySet &#x3D; hm.keySet();â€ä¼šæ¯”è¾ƒåˆé€‚ä¸€äº› 35ã€å¯¹èµ„æºçš„close()å»ºè®®åˆ†å¼€æ“ä½œ æ„æ€æ˜¯ï¼Œæ¯”å¦‚æˆ‘æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š 123456try&#123;\tXXX.close();\tYYY.close();&#125; catch (Exception e) &#123; // todo ...&#125; å»ºè®®ä¿®æ”¹ä¸ºï¼š 1234567891011try &#123; XXX.close(); &#125; catch (Exception e) &#123; // todo ... &#125;try &#123; YYY.close(); &#125; catch (Exception e) &#123; // todo ... &#125; è™½ç„¶æœ‰äº›éº»çƒ¦ï¼Œå´èƒ½é¿å…èµ„æºæ³„éœ²ã€‚æˆ‘æƒ³ï¼Œå¦‚æœæ²¡æœ‰ä¿®æ”¹è¿‡çš„ä»£ç ï¼Œä¸‡ä¸€XXX.close()æŠ›å¼‚å¸¸äº†ï¼Œé‚£ä¹ˆå°±è¿›å…¥äº†cathå—ä¸­äº†ï¼ŒYYY.close()ä¸ä¼šæ‰§è¡Œï¼ŒYYYè¿™å—èµ„æºå°±ä¸ä¼šå›æ”¶äº†ï¼Œä¸€ç›´å ç”¨ç€ï¼Œè¿™æ ·çš„ä»£ç ä¸€å¤šï¼Œæ˜¯å¯èƒ½å¼•èµ·èµ„æºå¥æŸ„æ³„éœ²çš„ã€‚è€Œæ”¹ä¸ºä¸Šé¢çš„å†™æ³•ä¹‹åï¼Œå°±ä¿è¯äº†æ— è®ºå¦‚ä½•XXXå’ŒYYYéƒ½ä¼šè¢«closeæ‰ã€‚","tags":["Java","æ€§èƒ½ä¼˜åŒ–"],"categories":["Java"]},{"title":"ä½¿ç”¨åŸºäº SpringMVC çš„é€æ˜ RPC å¼€å‘å¾®æœåŠ¡","path":"/2023/12/25/ä½¿ç”¨åŸºäº-SpringMVC-çš„é€æ˜-RPC-å¼€å‘å¾®æœåŠ¡/","content":"æ¥æºï¼šfredal.xin&#x2F;develop-with-transparent-rpc æˆ‘å¸ç›®å‰ RPC æ¡†æ¶æ˜¯åŸºäº Java Rest çš„æ–¹å¼å¼€å‘çš„ï¼Œå½¢å¼ä¸Šå¯ä»¥å‚è€ƒ SpringCloud Feign çš„å®ç°ã€‚Rest é£æ ¼éšç€å¾®æœåŠ¡çš„æ¶æ„å…´èµ·ï¼ŒSpring MVC å‡ ä¹æˆä¸ºäº† Rest å¼€å‘çš„è§„èŒƒï¼ŒåŒæ—¶å¯¹äº Spring çš„ä½¿ç”¨è€…é—¨æ§›ä¹Ÿæ¯”è¾ƒä½ã€‚ REST ä¸ RPC é£æ ¼çš„å¼€å‘æ–¹å¼RPC æ¡†æ¶é‡‡ç”¨ç±» Feign æ–¹å¼çš„ä¸€ä¸ªç®€å•çš„å®ç°ä¾‹å­å¦‚ä¸‹ï¼š 12345@RpcClient(schemaId=&quot;hello&quot;)public interface Hello &#123; @GetMapping(&quot;/message&quot;) HelloMessage hello(@RequestParam String name);&#125; è€ŒæœåŠ¡æä¾›è€…ç›´æ¥ä½¿ç”¨ spring mvc æ¥æš´éœ²æœåŠ¡æ¥å£ï¼š 123456789101112@RestControllerpublic class HelloController &#123; @Autowired private HelloService helloService; @GetMapping(&quot;/message&quot;) public HelloMessage getMessage(@RequestParam(name=&quot;name&quot;)String name) &#123; HelloMessage hello = helloService.gen(name); return hello; &#125;&#125; åŸºäº REST é£æ ¼å¼€å‘çš„æ–¹å¼æœ‰å¾ˆå¤šä¼˜ç‚¹ã€‚ä¸€æ˜¯ä½¿ç”¨é—¨æ§›è¾ƒä½ï¼ŒæœåŠ¡ç«¯å®Œå…¨åŸºäº Spring MVCï¼Œå®¢æˆ·ç«¯ api çš„ä¹¦å†™æ–¹å¼ä¹Ÿå…¼å®¹äº†å¤§éƒ¨åˆ† Spring çš„æ³¨è§£ï¼ŒåŒ…æ‹¬@RequestParamã€@RequestBody ç­‰ã€‚äºŒæ˜¯å¸¦æ¥çš„è§£è€¦ç‰¹æ€§ï¼Œå¾®æœåŠ¡åº”ç”¨æ³¨é‡æœåŠ¡è‡ªæ²»ï¼Œå¯¹å¤–åˆ™æä¾›æ¾è€¦åˆçš„ REST æ¥å£ï¼Œè¿™ç§æ–¹å¼æ›´çµæ´»ï¼Œå¯ä»¥å‡è½»å†å²åŒ…è¢±å¸¦æ¥çš„ç—›ç‚¹ï¼ŒåŒæ—¶é™¤äº†æä¾›ç»™ç±» SDK çš„æ¶ˆè´¹è€…æœåŠ¡å¤–ï¼Œè¿˜å¯æä¾›æµè§ˆå™¨ç­‰é SDK çš„æ¶ˆè´¹è€…æœåŠ¡ã€‚ å½“ç„¶è¿™ç§æ–¹å¼åœ¨å®é™…è¿ç”¨ä¸­ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šéº»çƒ¦ã€‚é¦–å…ˆï¼Œä¸ä¸€è‡´çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ API å¸¦æ¥äº†å‡ºé”™çš„å¯èƒ½æ€§ï¼ŒController æ¥å£çš„è¿”å›å€¼ç±»å‹ä¸ RpcClient çš„è¿”å›å€¼ç±»å‹å¯èƒ½å†™çš„ä¸ä¸€è‡´ä»è€Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ã€‚å…¶æ¬¡ï¼ŒRpcClient çš„ä¹¦å†™è™½ç„¶å…¼å®¹äº† Spring çš„æ³¨è§£ï¼Œä½†å¯¹äºæŸäº›å¼€å‘åŒå­¦ä»ç„¶å­˜åœ¨ä¸å°çš„é—¨æ§›ï¼Œä¾‹å¦‚å†™ url param æ—¶@RequestParam æ³¨è§£å¸¸å¸¸å¿˜å†™ï¼Œå†™ body param æ—¶å€™@RequestBody æ³¨è§£å¿˜è®°å†™ï¼Œç”¨@RequestBody æ³¨è§£æ¥æ ‡æ³¨ String å‚æ•°ï¼Œæ–¹æ³•ç±»å‹ä¸æŒ‡å®šç­‰ç­‰ï¼ˆåŸºæœ¬ä¸Šå’Œä½¿ç”¨ Feign çš„é—¨æ§›ä¸€æ ·ï¼‰ã€‚ è¿˜æœ‰ä¸€ç‚¹ï¼Œå°±æ˜¯æ¯”èµ·å¸¸è§çš„ RPC æ–¹å¼ï¼ŒREST æ–¹å¼ç›¸å½“äºå¤šå†™äº†ä¸€å±‚ Controllerï¼Œè€Œä¸æ˜¯ç›´æ¥å°† Service æš´éœ²æˆæ¥å£ã€‚DDD å®è·µä¸­ï¼Œå°†ä¸€ä¸ªå·¨çŸ³åº”ç”¨æ‹†åˆ†æˆå„ä¸ªé™ç•Œä¸Šä¸‹æ–‡æ—¶ï¼Œå¾€å¾€æ˜¯å¯¹æ—§ä»£ç çš„ Service æ–¹æ³•è¿›è¡Œæ‹†åˆ†ï¼ŒREST é£æ ¼æ„å‘³ç€éœ€è¦å¤šå†™ Controller æ¥å…¥è¡¨ç¤ºå±‚ï¼Œè€Œåœ¨å†…éƒ¨å¾®æœåŠ¡åº”ç”¨é—´ç›¸äº’è°ƒç”¨çš„åœºæ™¯ä¸‹ï¼Œæš´éœ²åº”ç”¨æœåŠ¡å±‚ç”šè‡³é¢†åŸŸæœåŠ¡å±‚ç»™è°ƒç”¨è€…å¯èƒ½æ˜¯æ›´ç®€ä¾¿çš„æ–¹æ³•ï¼Œåœ¨æ»¡è¶³ DDD çš„åŒæ—¶æ›´ç¬¦åˆ RPC çš„è¯­ä¹‰ã€‚ é‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›èƒ½é€šè¿‡ä¸€ç§åŸºäºé€æ˜ RPC é£æ ¼çš„å¼€å‘æ–¹å¼æ¥ä¼˜é›…ç®€ä¾¿åœ°å¼€å‘å¾®æœåŠ¡ã€‚ é¦–å…ˆæˆ‘ä»¬å¸Œæœ›æœåŠ¡æ¥å£çš„å®šä¹‰èƒ½æ›´ç®€ä¾¿ï¼Œä¸ç”¨å†™å¤šä½™çš„æ³¨è§£å’Œä¿¡æ¯ï¼š 1234@RpcClient(schemaId=&quot;hello&quot;)public interface Hello &#123; HelloMessage hello(String name);&#125; ç„¶åæˆ‘ä»¬å°±å¯ä»¥å®ç°è¿™ä¸ªæœåŠ¡ï¼Œå¹¶é€šè¿‡ä½¿ç”¨æ³¨è§£çš„æ–¹å¼ç®€å•çš„å‘å¸ƒæœåŠ¡ï¼š 1234567@RpcService(schemaId=&quot;hello&quot;)public class HelloImpl implements Hello&#123; @Override HelloMessage hello(String name)&#123; return new HelloMessage(name); &#125;&#125; è¿™æ ·å®¢æˆ·ç«¯åœ¨å¼•ç”¨ Hello æ¥å£åå¯ä»¥ç›´æ¥ä½¿ç”¨é‡Œé¢çš„ hello()æ–¹æ³•è°ƒç”¨åˆ°æœåŠ¡ç«¯çš„å®ç°ç±» HelloImpl ä¸­ï¼Œä»è€Œè·å¾—ä¸€ä¸ª HelloMessage å¯¹è±¡ã€‚ç›¸æ¯”ä¹‹å‰çš„ REST å®ç°æ–¹å¼ï¼Œåœ¨ç®€æ´æ€§ä»¥åŠä¸€è‡´æ€§ä¸Šéƒ½å¾—åˆ°äº†æå‡ã€‚ éšå¼çš„æœåŠ¡å¥‘çº¦æœåŠ¡å¥‘çº¦æŒ‡å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´å¯¹äºæ¥å£çš„æè¿°å®šä¹‰ã€‚REST é£æ ¼å¼€å‘æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring MVC annotation æ¥å£°æ˜æ¥å£çš„è¯·æ±‚ã€è¿”å›å‚æ•°ã€‚ä½†æ˜¯åœ¨é€æ˜ RPC å¼€å‘æ–¹å¼ä¸­ï¼Œç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥ä¸ç”¨å†™ä»»ä½• RESTful çš„ annotation çš„ï¼Œè¿™æ—¶å€™æ€ä¹ˆå»å®šä¹‰æœåŠ¡å¥‘çº¦å‘¢ã€‚ å…¶å®è¿™é‡Œè¿ç”¨äº†éšå¼çš„æœåŠ¡å¥‘çº¦ï¼Œå¯ä»¥ä¸äº‹å…ˆå®šä¹‰å¥‘çº¦å’Œæ¥å£ï¼Œè€Œæ˜¯ç›´æ¥å®šä¹‰å®ç°ç±»ï¼Œæ ¹æ®å®ç°ç±»å»è‡ªåŠ¨ç”Ÿæˆé»˜è®¤çš„å¥‘çº¦ï¼Œæ³¨å†Œåˆ°æœåŠ¡ä¸­å¿ƒã€‚ é»˜è®¤çš„æœåŠ¡å¥‘çº¦å†…å®¹åŒ…æ‹¬æ–¹æ³•ç±»å‹çš„é€‰æ‹©ã€URL åœ°å€ä»¥åŠå‚æ•°æ³¨è§£çš„å¤„ç†ã€‚æ–¹æ³•ç±»å‹çš„åˆ¤æ–­åŸºäºå…¥å‚ç±»å‹ï¼Œå¦‚æœå…¥å‚ç±»å‹ä¸­åŒ…å«è‡ªå®šä¹‰ç±»å‹ã€Object æˆ–è€…é›†åˆç­‰é€‚åˆæ”¾åœ¨ Body ä¸­çš„ç±»å‹ï¼Œåˆ™ä¼šåˆ¤æ–­ä¸ºä½¿ç”¨ POST æ–¹æ³•ï¼Œè€Œå¦‚æœå…¥å‚ä»…æœ‰ String æˆ–è€…åŸºæœ¬ç±»å‹ç­‰ï¼Œåˆ™åˆ¤æ–­ä½¿ç”¨ GET æ–¹æ³•ã€‚POST æ–¹æ³•ä¼šå°†æ‰€æœ‰å‚æ•°ä½œä¸º Body è¿›è¡Œä¼ é€ï¼Œè€Œ GET æ–¹æ³•åˆ™å°†å‚æ•°ä½œä¸º URL PARAM è¿›è¡Œä¼ é€ã€‚URL åœ°å€çš„é»˜è®¤è§„åˆ™ä¸º/ç±»å/æ–¹æ³•ç±»å‹+æ–¹æ³•åï¼Œæœªè¢«æ³¨è§£çš„æ–¹æ³•éƒ½ä¼šæŒ‰æ­¤ URL æ³¨å†Œåˆ°æœåŠ¡ä¸­å¿ƒã€‚ æœåŠ¡ç«¯çš„ REST ç¼–ç¨‹æ¨¡å‹æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¸¤ç§å¼€å‘é£æ ¼æœ€å¤§çš„æ”¹å˜æ˜¯æœåŠ¡ç«¯ç¼–ç¨‹æ¨¡å‹çš„æ”¹å˜ï¼Œä» REST é£æ ¼çš„ SpringMVC ç¼–ç¨‹æ¨¡å‹å˜æˆäº†é€æ˜ RPC ç¼–ç¨‹æ¨¡å‹ã€‚æˆ‘ä»¬åº”è¯¥æ€æ ·å»å®ç°è¿™ä¸€æ­¥å‘¢ï¼Ÿ æˆ‘ä»¬ç›®å‰çš„è¿è¡Œæ¶æ„å¦‚ä¸Šå›¾ï¼ŒæœåŠ¡ç«¯çš„ç¼–ç¨‹æ¨¡å‹å®Œå…¨åŸºäº Spring MVCï¼Œé€šä¿¡æ¨¡å‹åˆ™æ˜¯åŸºäº servlet çš„ã€‚æˆ‘ä»¬æœŸæœ›æœåŠ¡ç«¯çš„ç¼–ç¨‹æ¨¡å‹å¯ä»¥è½¬æ¢ä¸º RPCï¼Œé‚£ä¹ˆåŠ¿å¿…éœ€è¦æˆ‘ä»¬å¯¹é€šä¿¡æ¨¡å‹åšä¸€å®šçš„æ”¹é€ ã€‚ ä» DispatcherServlet è¯´èµ·é‚£ä¹ˆé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Spring MVC å®ç°çš„ servlet è§„èŒƒ DispatcherServlet åšä¸€å®šçš„äº†è§£ï¼ŒçŸ¥é“å®ƒæ˜¯æ€ä¹ˆå¤„ç†ä¸€ä¸ªè¯·æ±‚çš„ã€‚ DispatcherServlet ä¸»è¦åŒ…å«ä¸‰éƒ¨åˆ†é€»è¾‘ï¼Œæ˜ å°„å¤„ç†å™¨(HandlerMapping)ï¼Œæ˜ å°„é€‚é…å™¨(HandlerAdapter)ï¼Œè§†å›¾å¤„ç†å™¨(ViewResolver)ã€‚DispatcherServlet é€šè¿‡ HandlerMapping æ‰¾åˆ°åˆé€‚çš„ Handlerï¼Œå†é€šè¿‡ HandlerAdapter è¿›è¡Œé€‚é…ï¼Œæœ€ç»ˆè¿”å› ModelAndView ç»ç”± ViewResolver å¤„ç†è¿”å›ç»™å‰ç«¯ã€‚ å›åˆ°ä¸»é¢˜ä¸Šï¼Œæˆ‘ä»¬æƒ³è¦æ”¹é€ è¿™éƒ¨åˆ†é€šä¿¡æ¨¡å‹ä»è€Œèƒ½å¤Ÿå®ç° RPC çš„ç¼–ç¨‹æ¨¡å‹æœ‰ä¸¤ç§åŠæ³•ï¼Œä¸€æ˜¯ç›´æ¥ç¼–å†™ä¸€ä¸ªæ–°çš„ Servletï¼Œå®ç° REST over Servlet çš„æ•ˆæœï¼Œä»è€Œå¯¹æœåŠ¡ç«¯é€šä¿¡é€»è¾‘å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„æ§åˆ¶ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä¸ºæœåŠ¡ç«¯æ·»åŠ è‡ªå®šä¹‰çš„è¿è¡Œæ¨¡å‹(æœåŠ¡ç«¯é™æµã€è°ƒç”¨é“¾å¤„ç†ç­‰)ã€‚äºŒæ˜¯ä»…ä»…ä¿®æ”¹ä¸€éƒ¨åˆ† HandlerMapping çš„ä»£ç ï¼Œå°†è¯·æ±‚æ˜ å°„å˜å¾—å¯ä»¥é€‚é… RPC çš„ç¼–ç¨‹æ¨¡å‹ã€‚ é‰´äºå·¥ä½œé‡ä¸ç°å®æ¡ä»¶ï¼Œæˆ‘ä»¬é€‰æ‹©åä¸€ç§æ–¹æ³•ï¼Œç»§ç»­æ²¿ç”¨ DispatcherServletï¼Œä½†æ”¹é€ éƒ¨åˆ† HandlerMapping çš„ä»£ç ã€‚ é¦–å…ˆæˆ‘ä»¬ä¼šé€šè¿‡ Scanner æ‰«æåˆ°æ ‡æ³¨äº†@RpcClient æ³¨è§£çš„æ¥å£ä»¥åŠå…¶å®ç°ç±»ï¼Œæˆ‘ä»¬ä¼šå°†å…¶æ³¨å†Œåˆ° HandlerMapping ä¸­ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬è¦çœ‹ HandlerMapping ä¸­æœ‰æ²¡æœ‰èƒ½æ‰©å±•æ³¨å†Œé€»è¾‘çš„åœ°æ–¹ã€‚ æ¥ç€æˆ‘ä»¬å†è€ƒè™‘å¤„ç†è¯·æ±‚çš„äº‹å„¿ï¼Œæˆ‘ä»¬éœ€è¦ HandlerMapping èƒ½å¤Ÿåšåˆ°åœ¨æ²¡æœ‰ Spring Annotation çš„æƒ…å†µä¸‹ä¹Ÿèƒ½ä¸ºä¸åŒçš„å‚æ•°é€‰æ‹©ä¸åŒçš„ argumentResolver å‚æ•°å¤„ç†å™¨ï¼Œè¿™ä¸€ç‚¹åœ¨ springMVC ä¸­æ˜¯é€šè¿‡æ ‡æ³¨æ³¨è§£æ¥åŒºåˆ†çš„(RequestMappingã€RequestBody ç­‰)ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦çœ‹çœ‹ HandlerMapping ä¸­æœ‰æ²¡æœ‰èƒ½æ‰©å±•å‚æ•°æ³¨è§£é€»è¾‘çš„åœ°æ–¹ã€‚ å¸¦ç€è¿™ä¸¤ç‚¹ç›®çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ HandlerMapping çš„é€»è¾‘ã€‚ HandlerMapping çš„åˆå§‹åŒ–HandlerMapping çš„åˆå§‹åŒ–æºç æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬ç›´æ¥ä¸€ç¬”ç•¥è¿‡ä¸æ˜¯å¾ˆé‡è¦çš„éƒ¨åˆ†äº†ã€‚é¦–å…ˆ RequestMappingHandlerMapping çš„çˆ¶ç±» AbstractHandlerMethodMapping ç±»å®ç°äº† InitializingBean æ¥å£ï¼Œåœ¨å±æ€§åˆå§‹åŒ–å®Œæˆåä¼šè°ƒç”¨ afterPropertiesSet()æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨ initHandlerMethods()è¿›è¡Œ HandlerMethod åˆå§‹åŒ–ã€‚InitHandlerMethods æ–¹æ³•ä¸­ä½¿ç”¨ detectHandlerMethods æ–¹æ³•ä» bean ä¸­æ ¹æ® bean name æŸ¥æ‰¾ handlerMethodï¼Œæ­¤æ–¹æ³•ä¸­è°ƒç”¨ registerHandlerMethod æ¥æ³¨å†Œæ­£å¸¸çš„ handlerMethodã€‚ 123protected void registerHandlerMethod(Object handler, Method method, T mapping) &#123; this.mappingRegistry.register(mapping, handler, method); &#125; æˆ‘ä»¬å‘ç°è¿™ä¸ªæ–¹æ³•æ˜¯ protected çš„ï¼Œé‚£ä¹ˆç¬¬ä¸€æ­¥æˆ‘ä»¬æ‰¾åˆ°äº†å»å“ªæ³¨å†Œæˆ‘ä»¬çš„ RPC æ–¹æ³•åˆ° RequestMappingHandlerMapping ä¸­ã€‚æ¥å£å¯ä»¥çœ‹åˆ°å…¥å‚æ˜¯ handler æ–¹æ³•ï¼Œä½†åœ¨ handlerMapping ä¸­çœŸæ­£è¢«æ³¨å†Œçš„ handlerMethod å¯¹è±¡ï¼Œæ˜¾ç„¶è¿™éƒ¨åˆ†é€»è¾‘åœ¨ mappingRegistry çš„ register æ–¹æ³•ä¸­ã€‚register æ–¹æ³•ä¸­æˆ‘ä»¬æ‰¾åˆ°äº†è½¬æ¢çš„å…³é”®æ–¹æ³•ï¼š 1HandlerMethod handlerMethod = createHandlerMethod(handler, method); æ­¤æ–¹æ³•ä¸­è°ƒç”¨äº† handlerMethod å¯¹è±¡çš„æ„é€ å™¨æ¥æ„é€ ä¸€ä¸ª handlerMethodå¯¹è±¡ã€‚handlerMethod çš„å±æ€§ä¸­åŒ…å«ä¸€ä¸ªå« parameters çš„ methodParameter å¯¹è±¡æ•°ç»„ã€‚æˆ‘ä»¬çŸ¥é“ handlerMethod å¯¹è±¡å¯¹åº”çš„æ˜¯ä¸€ä¸ªå®ç°æ–¹æ³•ï¼Œé‚£ä¹ˆ methodParameter å¯¹è±¡å¯¹åº”çš„å°±æ˜¯å…¥å‚äº†ã€‚ æ¥ç€å¾€ methodParameter å¯¹è±¡é‡Œçœ‹ï¼Œå‘ç°äº†ä¸€ä¸ªå« parameterAnnotations çš„ Annotation æ•°ç»„ï¼Œçœ‹æ ·å­è¿™å°±æ˜¯æˆ‘ä»¬ç¬¬äºŒä¸ªéœ€è¦å…³æ³¨çš„åœ°æ–¹äº†ã€‚é‚£ä¹ˆæ€»ç»“ä¸€ä¸‹ï¼Œæ»¤å»æ— éœ€å…³æ³¨çš„éƒ¨åˆ†ï¼ŒhandlerMapping çš„åˆå§‹åŒ–æ•´ä¸ªå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š HandlerAdapter çš„è¯·æ±‚å¤„ç†è¿™è¾¹ dispatcherServlet åœ¨çœŸæ­£å¤„ç†è¯·æ±‚çš„æ—¶å€™æ˜¯ç”¨ handlerAdapter å»å¤„ç†å†è¿”å› ModelAndView å¯¹è±¡çš„ï¼Œä½†æ˜¯æ‰€æœ‰ç›¸å…³å¯¹è±¡éƒ½æ˜¯æ³¨å†Œåœ¨ handlerMapping ä¸­ã€‚ æˆ‘ä»¬ç›´æ¥æ¥çœ‹çœ‹ RequestMappingHandlerAdapter çš„å¤„ç†é€»è¾‘å§ï¼ŒhandlerAdapter åœ¨ handle æ–¹æ³•ä¸­è°ƒç”¨ handleInternal æ–¹æ³•ï¼Œå¹¶è°ƒç”¨ invokeHandlerMethod æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸­ä½¿ç”¨ createInvocableHandlerMethod æ–¹æ³•å°† handlerMethod å¯¹è±¡åŒ…è£…æˆäº†ä¸€ä¸ª servletInvocableHandlerMethod å¯¹è±¡ï¼Œæ­¤å¯¹è±¡æœ€ç»ˆè°ƒç”¨ invokeAndHandle æ–¹æ³•å®Œæˆå¯¹åº”è¯·æ±‚é€»è¾‘çš„å¤„ç†ã€‚æˆ‘ä»¬åªå…³æ³¨ invokeAndHandle é‡Œé¢çš„ invokeForRequest æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½œä¸ºå¯¹å…¥å‚çš„å¤„ç†æ­£æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ã€‚æœ€ç»ˆæˆ‘ä»¬çœ‹åˆ°äº†æ­¤æ–¹æ³•ä¸­çš„ getMethodArgumentValues æ–¹æ³•ä¸­çš„ä¸€æ®µå¯¹å…¥å‚æ³¨è§£çš„å¤„ç†é€»è¾‘: 12345678910if (this.argumentResolvers.supportsParameter(parameter)) &#123; try &#123; args[i] = this.argumentResolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory); &#125; catch (Exception var9) &#123; if (this.logger.isDebugEnabled()) &#123; this.logger.debug(this.getArgumentResolutionErrorMessage(&quot;Error resolving argument&quot;, i), var9); &#125; throw var9; &#125;&#125; æ˜¾ç„¶ï¼Œè¿™é‡Œä½¿ç”¨ supportsParameter æ–¹æ³•æ¥ä½œä¸ºåˆ¤æ–­ä¾æ®é€‰æ‹© argumentResolverï¼Œé‡Œå±‚çš„é€»è¾‘å°±æ˜¯ä¸€ä¸ªç®€å•çš„éå†é€‰æ‹©çœŸæ­£æ”¯æŒå…¥å‚çš„å‚æ•°å¤„ç†å™¨ã€‚å®é™…ä¸Š RequestMappingHandlerAdapte åœ¨åˆå§‹åŒ–æ—¶å€™å°±æ³¨å†Œäº†ä¸€å †å‚æ•°å¤„ç†å™¨ï¼š 1234567891011121314151617 private List&lt;HandlerMethodReturnValueHandler&gt; getDefaultReturnValueHandlers() &#123; List&lt;HandlerMethodReturnValueHandler&gt; handlers = new ArrayList&lt;HandlerMethodReturnValueHandler&gt;(); // Single-purpose return value types handlers.add(new ModelAndViewMethodReturnValueHandler()); handlers.add(new ModelMethodProcessor()); handlers.add(new ViewMethodReturnValueHandler()); handlers.add(new ResponseBodyEmitterReturnValueHandler(getMessageConverters())); handlers.add(new StreamingResponseBodyReturnValueHandler()); handlers.add(new HttpEntityMethodProcessor(getMessageConverters(), this.contentNegotiationManager, this.requestResponseBodyAdvice)); handlers.add(new HttpHeadersReturnValueHandler()); handlers.add(new CallableMethodReturnValueHandler()); handlers.add(new DeferredResultMethodReturnValueHandler()); handlers.add(new AsyncTaskMethodReturnValueHandler(this.beanFactory));\t//...&#125; æˆ‘ä»¬è°ƒä¸ªçœ¼ç†Ÿçš„ RequestResponseBodyMethodProcessor æ¥çœ‹çœ‹å…¶ supportsParameter æ–¹æ³•: 1234@Overridepublic boolean supportsParameter(MethodParameter parameter) &#123; return parameter.hasParameterAnnotation(RequestBody.class);&#125; è¿™é‡Œç›´æ¥è°ƒç”¨äº† MethodParameter è‡ªèº«çš„ public æ–¹æ³• hasParameterAnnotation æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦æœ‰ç›¸åº”çš„æ³¨è§£ï¼Œæ¯”å¦‚æœ‰ RequestBody æ³¨è§£é‚£ä¹ˆæˆ‘ä»¬å°±é€‰ç”¨ RequestResponseBodyMethodProcessor æ¥ä½œä¸ºå…¶å‚æ•°å¤„ç†å™¨ã€‚ è¿˜æ˜¯æ»¤å»æ— ç”¨é€»è¾‘ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š æœåŠ¡ç«¯çš„ RPC ç¼–ç¨‹æ¨¡å‹ä»¥ä¸Šæˆ‘ä»¬äº†è§£äº† DispatcherServlet åœ¨ REST ç¼–ç¨‹æ¨¡å‹ä¸­æ˜¯éƒ¨åˆ†é€»è¾‘ï¼Œç°åœ¨æˆ‘ä»¬ä¾æ®ä¹‹å‰è®²çš„æ”¹é€ éƒ¨åˆ† HandlerMapping çš„ä»£ç ä»è€Œä½¿å…¶é€‚é… RPC ç¼–ç¨‹æ¨¡å‹ã€‚ RPC æ–¹æ³•æ³¨å†Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å°†æ–¹æ³•æ³¨å†Œåˆ° handlerMappingï¼Œè€Œè¿™ç‚¹ç”±ä¸Šè¿° RequestHandlerMapping çš„åˆå§‹åŒ–æµç¨‹å¾—çŸ¥ç›´æ¥è°ƒç”¨ registerHandlerMethod æ–¹æ³•å³å¯ã€‚ç»“åˆæˆ‘ä»¬çš„æ‰«æé€»è¾‘ï¼Œå¤§è‡´ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435public class RpcRequestMappingHandlerMapping extends RequestMappingHandlerMapping&#123;\tpublic void registerRpcToMvc(final String prefix) &#123; final AdvancedApiToMvcScanner scanner = new AdvancedApiToMvcScanner(RpcService.class); scanner.setBasePackage(basePackage); Map&lt;Class&lt;?&gt;, Set&lt;MethodTemplate&gt;&gt; mvcMap; //æ‰«æåˆ°æ³¨è§£äº†@RpcServiceçš„æ¥å£åŠmethodå…ƒä¿¡æ¯ try &#123; mvcMap = scanner.scan(); &#125; catch (final IOException e) &#123; throw new FatalBeanException(&quot;failed to scan&quot;); &#125; for (final Class&lt;?&gt; clazz : mvcMap.keySet()) &#123; final Set&lt;MethodTemplate&gt; methodTemplates = mvcMap.get(clazz); for (final MethodTemplate methodTemplate : methodTemplates) &#123; if (methodTemplate == null) &#123; continue; &#125; final Method method = methodTemplate.getMethod(); Http.HttpMethod httpMethod; String uriTemplate = null; //éšå¼å¥‘çº¦ï¼šæ–¹æ³•ç±»å‹å’Œurlåœ°å€ httpMethod = MvcFuncUtil.judgeMethodType(method); uriTemplate = MvcFuncUtil.genMvcFuncName(clazz, httpMethod.name(), method); final RequestMappingInfo requestMappingInfo = RequestMappingInfo .paths(this.resolveEmbeddedValuesInPatterns(new String[]&#123;uriTemplate&#125;)) .methods(RequestMethod.valueOf(httpMethod.name())) .build(); //æ³¨å†Œåˆ°spring mvc this.registerHandlerMethod(handler, method, requestMappingInfo); &#125; &#125; &#125;&#125; æˆ‘ä»¬è‡ªå®šä¹‰äº†æ³¨å†Œæ–¹æ³•ï¼Œåªéœ€åœ¨å®¹å™¨å¯åŠ¨æ—¶è°ƒç”¨å³å¯ã€‚ RPC è¯·æ±‚å¤„ç†ä»¥ä¸Šæ‰€è¯´ï¼Œå…‰å®Œæˆæ³¨å†Œæ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¥å‚æ³¨è§£åšä¸€äº›å¤„ç†ï¼Œä¾‹å¦‚æˆ‘ä»¬è™½ç„¶æ²¡æœ‰å†™æ³¨è§£@RequestBody User userï¼Œæˆ‘ä»¬ä»ç„¶å¸Œæœ› handlerAdapter åœ¨å¤„ç†çš„æ—¶å€™èƒ½å¤Ÿä»¥ä¸ºæˆ‘ä»¬å†™äº†ï¼Œå¹¶ç”¨ RequestResponseBodyMethodProcessor å‚æ•°è§£æå™¨æ¥è¿›è¡Œå¤„ç†ã€‚ æˆ‘ä»¬ç›´æ¥é‡å†™ RequestMappingHandlerMapping çš„ createHandlerMethod æ–¹æ³•ï¼š 1234567891011@Overrideprotected HandlerMethod createHandlerMethod(Object handler, Method method) &#123; HandlerMethod handlerMethod; if (handler instanceof String) &#123; String beanName = (String) handler; handlerMethod = new HandlerMethod(beanName, this.getApplicationContext().getAutowireCapableBeanFactory(), method); &#125; else &#123; handlerMethod = new HandlerMethod(handler, method); &#125; return new RpcHandlerMethod(handlerMethod);&#125; æˆ‘ä»¬è‡ªå®šä¹‰äº†è‡ªå·±çš„ HandlerMethod å¯¹è±¡ï¼š 12345678910111213141516public class RpcHandlerMethod extends HandlerMethod &#123; protected RpcHandlerMethod(HandlerMethod handlerMethod) &#123; super(handlerMethod); initMethodParameters(); &#125; private void initMethodParameters() &#123; MethodParameter[] methodParameters = super.getMethodParameters(); Annotation[][] parameterAnnotations = null; for (int i = 0; i &lt; methodParameters.length; i++) &#123; SynthesizingMethodParameter methodParameter = (SynthesizingMethodParameter) methodParameters[i]; methodParameters[i] = new RpcMethodParameter(methodParameter); &#125; &#125;&#125; å¾ˆå®¹æ˜“çœ‹åˆ°ï¼Œè¿™é‡Œçš„é‡ç‚¹æ˜¯åˆå§‹åŒ–äº†è‡ªå®šä¹‰çš„ MethodParameter å¯¹è±¡ï¼š 12345678910111213141516171819202122232425262728public class RpcMethodParameter extends SynthesizingMethodParameter &#123; private volatile Annotation[] annotations; protected RpcMethodParameter(SynthesizingMethodParameter original) &#123; super(original); this.annotations = initParameterAnnotations(); &#125; private Annotation[] initParameterAnnotations() &#123; List&lt;Annotation&gt; annotationList = new ArrayList&lt;&gt;(); final Class&lt;?&gt; parameterType = this.getParameterType(); if (MvcFuncUtil.isRequestParamClass(parameterType)) &#123; annotationList.add(MvcFuncUtil.newRequestParam(MvcFuncUtil.genMvcParamName(this.getParameterIndex()))); &#125; else if (MvcFuncUtil.isRequestBodyClass(parameterType)) &#123; annotationList.add(MvcFuncUtil.newRequestBody()); &#125; return annotationList.toArray(new Annotation[]&#123;&#125;); &#125; @Override public Annotation[] getParameterAnnotations() &#123; if (annotations != null &amp;&amp; annotations.length &gt; 0) &#123; return annotations; &#125; return super.getParameterAnnotations(); &#125;&#125; è‡ªå®šä¹‰çš„ MethodParameter å¯¹è±¡ä¸­é‡å†™äº† getParameterAnnotations æ–¹æ³•ï¼Œè€Œæ¬¡æ–¹æ³•æ­£æ˜¯ argumentResolver ç”¨æ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦é€‚åˆè¯¥å‚æ•°çš„æ–¹æ³•ã€‚æˆ‘ä»¬åšäº†äº›æ”¹é€ ä½¿å¾—åˆé€‚çš„å‚æ•°ä¼šè¢«åˆé€‚çš„å‚æ•°è§£æå™¨â€è¯¯ä»¥ä¸ºâ€åŠ äº†å¯¹åº”çš„æ³¨è§£ï¼Œä»è€Œè‡ªå·±ä¼šå»è¿›è¡Œæ­£å¸¸çš„å‚æ•°å¤„ç†é€»è¾‘ã€‚æ•´ä¸ªå¤„ç†æµç¨‹å¦‚ä¸‹ï¼Œç²‰çº¢è‰²éƒ¨åˆ†ä¹Ÿæ­£æ˜¯æˆ‘ä»¬æ‰€æ‰©å±•çš„ç‚¹äº†ï¼š RPC ç¼–ç¨‹æ¨¡å‹ç»è¿‡æ”¹é€ ä¹‹åï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å®ç°æ–‡ç« å¼€å¤´æ‰€æè¿°çš„é€æ˜ RPC æ¥å¼€å‘å¾®æœåŠ¡äº†ï¼Œæ•´ä¸ªè¿è¡Œæ¶æ„å˜æˆäº†ä¸‹é¢è¿™æ ·ï¼š","tags":["æ¡†æ¶","Spring","SpringMVC","åˆ†å¸ƒå¼","å¾®æœåŠ¡"],"categories":["æ¡†æ¶","Spring","SpringMVC"]},{"title":"å›¾æ–‡è®²è§£å“ˆå¸Œè¡¨","path":"/2023/12/25/å›¾æ–‡è®²è§£å“ˆå¸Œè¡¨/","content":"ä»Šå¤©æˆ‘ä»¬æ¥è¯´ä¸€ç§æ–°çš„æ•°æ®ç»“æ„æ•£åˆ—ï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼Œæ•£åˆ—æ˜¯åº”ç”¨éå¸¸å¹¿æ³›çš„æ•°æ®ç»“æ„ï¼Œåœ¨æˆ‘ä»¬çš„åˆ·é¢˜è¿‡ç¨‹ä¸­ï¼Œæ•£åˆ—è¡¨çš„å‡ºåœºç‡ç‰¹åˆ«é«˜ã€‚æ‰€ä»¥æˆ‘ä»¬å¿«æ¥ä¸€èµ·æŠŠæ•£åˆ—è¡¨çš„å†…äº›äº‹ç»™æ•´æ˜ç™½å§ï¼Œæ–‡ç« æ¡†æ¶å¦‚ä¸‹ã€‚ è¯´æ•£åˆ—è¡¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè®¾æƒ³ä»¥ä¸‹åœºæ™¯ã€‚ è¢å¨ç©¿è¶Šå›äº†å¤ä»£ï¼Œå‡­å€Ÿä»ç°ä»£å­¦ä¹ çš„åšé¥­æ‰‹è‰ºï¼Œå¼€äº†ä¸€ä¸ªè¢è®°èœé¦†ï¼Œæ­£å€¼å¼€ä¸šåˆæœŸï¼Œåº—é‡Œç”Ÿæ„ååˆ†ç«çˆ†ï¼Œä½†æ˜¯é¡¾å®¢ç»“è´¦æ—¶å°±çŠ¯éš¾äº†ï¼Œç”±äºèœå“å¤ªå¤šï¼Œæ¯å½“ç»“è´¦æ—¶ï¼Œè€æ¿å¨˜æ€»æ˜¯æŒ‰ç…§èœå•ä¸€ä¸ªä¸€ä¸ªæ‰¾ä»·æ ¼ï¼ˆéå†æŸ¥æ‰¾ï¼‰ï¼Œæ¯æ¬¡éƒ½è¦æ‰¾åŠå¤©ï¼Œæ‰€ä»¥ç»“è´¦çš„åœ°æ–¹æ€»æ˜¯æ’èµ·é•¿é˜Ÿï¼Œé¡¾å®¢ä»¬è¡¨ç¤ºç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚è¢å¨ä¸€æƒ³è¿™ä¸æ˜¯åŠæ³•å•Šï¼Œå¤ªæµªè´¹å¤§å®¶æ—¶é—´äº†ï¼Œæ‰€ä»¥è¢å¨å°±å…ˆæŠŠèœå•æŒ‰ç…§é¦–å­—æ¯æ’åºï¼ˆäºŒåˆ†æŸ¥æ‰¾ï¼‰ï¼Œç„¶åæŸ¥æ‰¾çš„æ—¶å€™æ ¹æ®é¦–å­—æ¯æŸ¥æ‰¾ï¼Œè¿™æ ·ç»“è´¦çš„æ—¶å€™å°±èƒ½å¤§å¤§æé«˜æ£€ç´¢æ•ˆç‡å•¦ï¼ä½†æ˜¯å‘¢ï¼Ÿå·¥ä½œæ—¥é¡¾å®¢ä¸å¤šï¼Œè€æ¿å¨˜å®Œå…¨åº”ä»˜çš„è¿‡æ¥ï¼Œä½†æ˜¯æ¯é€¢èŠ‚å‡æ—¥ï¼Œè¿˜æ˜¯ä¼šæ’èµ·é•¿é˜Ÿã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä»€ä¹ˆæ›´å¥½çš„åŠæ³•å‘¢ï¼Ÿå¯¹å‘€ï¼æˆ‘ä»¬æŠŠæ‰€æœ‰çš„ä»·æ ¼éƒ½èƒŒä¸‹æ¥ä¸å°±å¯ä»¥äº†å—ï¼Ÿæ¯ä¸ªèœçš„ä»·æ ¼æˆ‘ä»¬éƒ½äº†å¦‚æŒ‡æŒï¼Œç»“è´¦çš„æ—¶å€™æˆ‘ä»¬åªéœ€æŠŠæ¯é“èœçš„ä»·æ ¼ç›¸åŠ å³å¯ã€‚æ‰€ä»¥è¢å¨å’Œè€æ¿å¨˜åŠ ç­åŠ ç‚¹çš„è¿›è¡ŒèƒŒè¯µã€‚ä¸‹æ¬¡å†ç»“è´¦çš„æ—¶å€™ä¸€è¯´åƒäº†ä»€ä¹ˆèœï¼Œæˆ‘ä»¬ç«‹é©¬å°±çŸ¥é“ä»·æ ¼å•¦ã€‚è‡ªæ­¤ä»¥åæ”¶é“¶å°å†ä¹Ÿæ²¡æœ‰å‡ºç°è¿‡é•¿é˜Ÿå•¦ï¼Œè¢è®°èœé¦†å¼€ç€å¼€ç€ä¸€ä¸å°å¿ƒå°±æˆäº†å¤©ä¸‹ç¬¬ä¸€é¥­åº—ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¢è®°èœé¦†è€æ¿å¨˜è¿›åŒ–å²ã€‚ ä¸Šé¢çš„åæœŸç»“è´¦çš„è¿‡ç¨‹åˆ™æ¨¡æ‹Ÿäº†æˆ‘ä»¬çš„æ•£åˆ—è¡¨æŸ¥æ‰¾ï¼Œé‚£ä¹ˆåœ¨è®¡ç®—æœºä¸­æ˜¯å¦‚ä½•ä½¿ç”¨è¿›è¡ŒæŸ¥æ‰¾çš„å‘¢ï¼Ÿ æ•£åˆ—è¡¨æŸ¥æ‰¾æ­¥éª¤æ•£åˆ—è¡¨ï¼Œæœ€æœ‰ç”¨çš„åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚æ˜¯æ ¹æ®å…³é”®ç çš„å€¼ç›´æ¥è¿›è¡Œè®¿é—®çš„æ•°æ®ç»“æ„ï¼Œæ•£åˆ—è¡¨çš„å®ç°å¸¸å¸¸å«åšæ•£åˆ—ï¼ˆhasingï¼‰ã€‚æ•£åˆ—æ˜¯ä¸€ç§ç”¨äºä»¥å¸¸æ•°å¹³å‡æ—¶é—´æ‰§è¡Œæ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾çš„æŠ€æœ¯ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ•£åˆ—è¿‡ç¨‹ã€‚ æˆ‘ä»¬çš„æ•´ä¸ªæ•£åˆ—è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤æ­¥ ï¼ˆ1ï¼‰é€šè¿‡æ•£åˆ—å‡½æ•°è®¡ç®—è®°å½•çš„æ•£åˆ—åœ°å€ï¼Œå¹¶æŒ‰æ­¤æ•£åˆ—åœ°å€å­˜å‚¨è¯¥è®°å½•ã€‚å°±å¥½æ¯”éº»è¾£é±¼ï¼Œæˆ‘ä»¬å°±è®©å®ƒåœ¨å·èœåŒºï¼Œç³–é†‹é±¼ï¼Œæˆ‘ä»¬å°±è®©å®ƒåœ¨é²èœåŒºã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºä»€ä¹ˆè®°å½•æˆ‘ä»¬éƒ½éœ€è¦ç”¨åŒä¸€ä¸ªæ•£åˆ—å‡½æ•°è®¡ç®—åœ°å€ï¼Œç„¶åå†å­˜å‚¨ã€‚ ï¼ˆ2)å½“æˆ‘ä»¬æŸ¥æ‰¾æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡åŒæ ·çš„æ•£åˆ—å‡½æ•°è®¡ç®—è®°å½•çš„æ•£åˆ—åœ°å€ï¼ŒæŒ‰æ­¤æ•£åˆ—åœ°å€è®¿é—®è¯¥è®°å½•ã€‚å› ä¸ºæˆ‘ä»¬å­˜å’Œå–çš„æ—¶å€™ç”¨çš„éƒ½æ˜¯ä¸€ä¸ªæ•£åˆ—å‡½æ•°ï¼Œå› æ­¤ç»“æœè‚¯å®šç›¸åŒã€‚ åˆšæ‰æˆ‘ä»¬åœ¨æ•£åˆ—è¿‡ç¨‹ä¸­æåˆ°äº†æ•£åˆ—å‡½æ•°ï¼Œé‚£ä¹ˆæ•£åˆ—å‡½æ•°æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æˆ‘ä»¬å‡è®¾æŸä¸ªå‡½æ•°ä¸º fï¼Œä½¿å¾— å­˜å‚¨ä½ç½® &#x3D; f (key) é‚£æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡æŸ¥æ‰¾å…³é”®å­—ä¸éœ€è¦æ¯”è¾ƒå°±å¯è·å¾—éœ€è¦çš„è®°å½•çš„å­˜å‚¨ä½ç½®ã€‚è¿™ç§å­˜å‚¨æŠ€æœ¯è¢«ç§°ä¸ºæ•£åˆ—æŠ€æœ¯ã€‚æ•£åˆ—æŠ€æœ¯æ˜¯åœ¨é€šè¿‡è®°å½•çš„å­˜å‚¨ä½ç½®å’Œå®ƒçš„å…³é”®å­—ä¹‹é—´å»ºç«‹ä¸€ä¸ªç¡®å®šçš„å¯¹åº”å…³ç³» f ,ä½¿å¾—æ¯ä¸ªå…³é”®å­— key éƒ½å¯¹åº”ä¸€ä¸ªå­˜å‚¨ä½ç½® f(key)ã€‚è§ä¸‹å›¾ è¿™é‡Œçš„ f å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ•£åˆ—å‡½æ•°ï¼ˆå“ˆå¸Œï¼‰å‡½æ•°ã€‚æˆ‘ä»¬åˆ©ç”¨æ•£åˆ—æŠ€æœ¯å°†è®°å½•å­˜å‚¨åœ¨ä¸€å—è¿ç»­çš„å­˜å‚¨ç©ºé—´ä¸­ï¼Œè¿™å—è¿ç»­å­˜å‚¨ç©ºé—´å°±æ˜¯æˆ‘ä»¬æœ¬æ–‡çš„ä¸»äººå…¬â€”â€”æ•£åˆ—(å“ˆå¸Œ) ä¸Šå›¾ä¸ºæˆ‘ä»¬æè¿°äº†ç”¨æ•£åˆ—å‡½æ•°å°†å…³é”®å­—æ˜ å°„åˆ°æ•£åˆ—è¡¨ï¼Œä½†æ˜¯å¤§å®¶æœ‰æ²¡æœ‰è€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼Œé‚£å°±æ˜¯å°†å…³é”®å­—æ˜ å°„åˆ°åŒä¸€ä¸ªæ§½ä¸­çš„æƒ…å†µï¼Œå³ f(k4) &#x3D; f(k3) æ—¶ã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬å°†å…¶ç§°ä¹‹ä¸ºå†²çªï¼Œk3 å’Œ k4 åˆ™è¢«ç§°ä¹‹ä¸ºæ•£åˆ—å‡½æ•° f çš„åŒä¹‰è¯ï¼Œå¦‚æœäº§ç”Ÿè¿™ç§æƒ…å†µï¼Œåˆ™ä¼šè®©æˆ‘ä»¬æŸ¥æ‰¾é”™è¯¯ã€‚å¹¸è¿çš„æ˜¯æˆ‘ä»¬èƒ½æ‰¾åˆ°æœ‰æ•ˆçš„æ–¹æ³•è§£å†³å†²çªã€‚ é¦–å…ˆæˆ‘ä»¬å¯ä»¥å¯¹å“ˆå¸Œå‡½æ•°ä¸‹æ‰‹ï¼Œæˆ‘ä»¬å¯ä»¥ç²¾å¿ƒè®¾è®¡å“ˆå¸Œå‡½æ•°ï¼Œè®©å…¶å°½å¯èƒ½å°‘çš„äº§ç”Ÿå†²çªï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºå“ˆå¸Œå‡½æ•°æ—¶åº”éµå¾ªä»¥ä¸‹è§„åˆ™ ï¼ˆ1ï¼‰å¿…é¡»æ˜¯ä¸€è‡´çš„ï¼Œå‡è®¾ä½ è¾“å…¥è¾£å­é¸¡ä¸æ—¶å¾—åˆ°çš„æ˜¯åœ¨çœ‹ï¼Œé‚£ä¹ˆæ¯æ¬¡è¾“å…¥è¾£å­é¸¡ä¸æ—¶ï¼Œå¾—åˆ°çš„ä¹Ÿå¿…é¡»ä¸ºåœ¨çœ‹ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œæ•£åˆ—è¡¨å°†æ¯«æ— ç”¨å¤„ã€‚ ï¼ˆ2ï¼‰è®¡ç®—ç®€å•ï¼Œå‡è®¾æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªç®—æ³•ï¼Œå¯ä»¥ä¿è¯æ‰€æœ‰å…³é”®å­—éƒ½ä¸ä¼šå†²çªï¼Œä½†æ˜¯è¿™ä¸ªç®—æ³•è®¡ç®—å¤æ‚ï¼Œä¼šè€—è´¹å¾ˆå¤šæ—¶é—´ï¼Œè¿™æ ·çš„è¯å°±å¤§å¤§é™ä½äº†æŸ¥æ‰¾æ•ˆç‡ï¼Œåè€Œå¾—ä¸å¿å¤±ã€‚æ‰€ä»¥å’±ä»¬æ•£åˆ—å‡½æ•°çš„è®¡ç®—æ—¶é—´ä¸åº”è¯¥è¶…è¿‡å…¶ä»–æŸ¥æ‰¾æŠ€æœ¯ä¸å…³é”®å­—çš„æ¯”è¾ƒæ—¶é—´ï¼Œä¸ç„¶çš„è¯æˆ‘ä»¬å¹²å˜›ä¸ä½¿ç”¨å…¶ä»–æŸ¥æ‰¾æŠ€æœ¯å‘¢? ï¼ˆ3ï¼‰æ•£åˆ—åœ°å€åˆ†å¸ƒå‡åŒ€æˆ‘ä»¬åˆšæ‰è¯´äº†å†²çªçš„å¸¦æ¥çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€å¥½çš„åŠæ³•å°±æ˜¯è®©æ•£åˆ—åœ°å€å°½é‡å‡åŒ€åˆ†å¸ƒåœ¨å­˜å‚¨ç©ºé—´ä¸­ï¼Œè¿™æ ·å³ä¿è¯ç©ºé—´çš„æœ‰æ•ˆåˆ©ç”¨ï¼Œåˆå‡å°‘äº†å¤„ç†å†²çªè€Œæ¶ˆè€—çš„æ—¶é—´ã€‚ ç°åœ¨æˆ‘ä»¬å·²ç»å¯¹æ•£åˆ—è¡¨ï¼Œæ•£åˆ—å‡½æ•°ç­‰çŸ¥è¯†æœ‰æ‰€äº†è§£å•¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹å‡ ç§å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°æ„é€ æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•çš„å…±åŒç‚¹ä¸ºéƒ½æ˜¯å°†åŸæ¥çš„æ•°å­—æŒ‰æŸç§è§„å¾‹å˜æˆäº†å¦ä¸€ä¸ªæ•°å­—ã€‚æ‰€ä»¥æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ã€‚ æ•£åˆ—å‡½æ•°æ„é€ æ–¹æ³•ç›´æ¥å®šå€æ³•å¦‚æœæˆ‘ä»¬å¯¹ç›ˆåˆ©ä¸º0-9çš„èœå“è®¾è®¡å“ˆå¸Œè¡¨ï¼Œæˆ‘ä»¬åˆ™ç›´æ¥å¯ä»¥æ ¹æ®ä½œä¸ºåœ°å€ï¼Œåˆ™ f(key) &#x3D; key; å³ä¸‹é¢è¿™ç§æƒ…å†µã€‚ æœ‰æ²¡æœ‰æ„Ÿè§‰ä¸Šé¢çš„å›¾å¾ˆç†Ÿæ‚‰ï¼Œæ²¡é”™æˆ‘ä»¬ç»å¸¸ç”¨çš„æ•°ç»„å…¶å®å°±æ˜¯ä¸€å¼ å“ˆå¸Œè¡¨ï¼Œå…³é”®ç å°±æ˜¯æ•°ç»„çš„ç´¢å¼•ä¸‹æ ‡ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡ä¸‹æ ‡ç›´æ¥è®¿é—®æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ å¦å¤–æˆ‘ä»¬å‡è®¾æ¯é“èœçš„æˆæœ¬ä¸º50å—ï¼Œé‚£æˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®ç›ˆåˆ©+æˆæœ¬æ¥ä½œä¸ºåœ°å€ï¼Œé‚£ä¹ˆåˆ™ f(key) &#x3D; key + 50ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æ ¹æ®çº¿æ€§å‡½æ•°å€¼ä½œä¸ºæ•£åˆ—åœ°å€ã€‚ f(key) &#x3D; a * key + b a,bå‡ä¸ºå¸¸æ•° ä¼˜ç‚¹ï¼šç®€å•ã€å‡åŒ€ã€æ— å†²çªã€‚ åº”ç”¨åœºæ™¯ï¼šéœ€è¦äº‹å…ˆçŸ¥é“å…³é”®å­—çš„åˆ†å¸ƒæƒ…å†µï¼Œé€‚åˆæŸ¥æ‰¾è¡¨è¾ƒå°ä¸”è¿ç»­çš„æƒ…å†µ æ•°å­—åˆ†ææ³•è¯¥æ–¹æ³•ä¹Ÿæ˜¯ååˆ†ç®€å•çš„æ–¹æ³•ï¼Œå°±æ˜¯åˆ†ææˆ‘ä»¬çš„å…³é”®å­—ï¼Œå–å…¶ä¸­ä¸€æ®µï¼Œæˆ–å¯¹å…¶ä½ç§»ï¼Œå åŠ ï¼Œç”¨ä½œåœ°å€ã€‚æ¯”å¦‚æˆ‘ä»¬çš„å­¦å·ï¼Œå‰ 6 ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯åé¢ 3 ä½éƒ½ä¸ç›¸åŒï¼Œæˆ‘ä»¬åˆ™å¯ä»¥ç”¨å­¦å·ä½œä¸ºé”®ï¼Œåé¢çš„ 3 ä½åšä¸ºæˆ‘ä»¬çš„æ•£åˆ—åœ°å€ã€‚å¦‚æœæˆ‘ä»¬è¿™æ ·è¿˜æ˜¯å®¹æ˜“äº§ç”Ÿå†²çªï¼Œåˆ™å¯ä»¥å¯¹æŠ½å–æ•°å­—å†è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬çš„ç›®çš„åªæœ‰ä¸€ä¸ªï¼Œæä¾›ä¸€ä¸ªæ•£åˆ—å‡½æ•°å°†å…³é”®å­—åˆç†çš„åˆ†é…åˆ°æ•£åˆ—è¡¨çš„å„ä½ç½®ã€‚è¿™é‡Œæˆ‘ä»¬æåˆ°äº†ä¸€ç§æ–°çš„æ–¹å¼æŠ½å–ï¼Œè¿™ä¹Ÿæ˜¯åœ¨æ•£åˆ—å‡½æ•°ä¸­ç»å¸¸ç”¨åˆ°çš„æ‰‹æ®µã€‚ ä¼˜ç‚¹ï¼šç®€å•ã€å‡åŒ€ã€é€‚ç”¨äºå…³é”®å­—ä½æ•°è¾ƒå¤§çš„æƒ…å†µ åº”ç”¨åœºæ™¯ï¼šå…³é”®å­—ä½æ•°è¾ƒå¤§ï¼ŒçŸ¥é“å…³é”®å­—åˆ†å¸ƒæƒ…å†µä¸”å…³é”®å­—çš„è‹¥å¹²ä½è¾ƒå‡åŒ€ æŠ˜å æ³•å…¶å®è¿™ä¸ªæ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¹Ÿæ˜¯å¤„ç†æˆ‘ä»¬çš„å…³é”®å­—ç„¶åç”¨ä½œæˆ‘ä»¬çš„æ•£åˆ—åœ°å€ï¼Œä¸»è¦æ€è·¯æ˜¯å°†å…³é”®å­—ä»å·¦åˆ°å³åˆ†å‰²æˆä½æ•°ç›¸ç­‰çš„å‡ éƒ¨åˆ†ï¼Œç„¶åå åŠ æ±‚å’Œï¼Œå¹¶æŒ‰æ•£åˆ—è¡¨è¡¨é•¿ï¼Œå–åå‡ ä½ä½œä¸ºæ•£åˆ—åœ°å€ã€‚ æ¯”å¦‚æˆ‘ä»¬çš„å…³é”®å­—æ˜¯123456789ï¼Œåˆ™æˆ‘ä»¬åˆ†ä¸ºä¸‰éƒ¨åˆ† 123 ï¼Œ456 ï¼Œ789 ç„¶åå°†å…¶ç›¸åŠ å¾— 1368 ç„¶åæˆ‘ä»¬å†å–å…¶åä¸‰ä½ 368 ä½œä¸ºæˆ‘ä»¬çš„æ•£åˆ—åœ°å€ã€‚ ä¼˜ç‚¹ï¼šäº‹å…ˆä¸éœ€è¦çŸ¥é“å…³é”®å­—æƒ…å†µ åº”ç”¨åœºæ™¯ï¼šé€‚åˆå…³é”®å­—ä½æ•°è¾ƒå¤šçš„æƒ…å†µ é™¤æ³•æ•£åˆ—æ³•åœ¨ç”¨æ¥è®¾è®¡æ•£åˆ—å‡½æ•°çš„é™¤æ³•æ•£åˆ—æ³•ä¸­ï¼Œé€šè¿‡å– key é™¤ä»¥ p çš„ä½™æ•°ï¼Œå°†å…³é”®å­—æ˜ å°„åˆ° p ä¸ªæ§½ä¸­çš„æŸä¸€ä¸ªä¸Šï¼Œå¯¹äºæ•£åˆ—è¡¨é•¿åº¦ä¸º m çš„æ•£åˆ—å‡½æ•°å…¬å¼ä¸º f(k) &#x3D; k mod p (p &lt;&#x3D; m) ä¾‹å¦‚ï¼Œå¦‚æœæ•£åˆ—è¡¨é•¿åº¦ä¸º 12ï¼Œå³ m &#x3D; 12 ï¼Œæˆ‘ä»¬çš„å‚æ•° p ä¹Ÿè®¾ä¸º12ï¼Œé‚£ k &#x3D; 100æ—¶ f(k) &#x3D; 100 % 12 &#x3D; 4 ç”±äºåªéœ€è¦åšä¸€æ¬¡é™¤æ³•æ“ä½œï¼Œæ‰€ä»¥é™¤æ³•æ•£åˆ—æ³•æ˜¯éå¸¸å¿«çš„ã€‚ ç”±ä¸Šé¢çš„å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ–¹æ³•çš„é‡ç‚¹åœ¨äº p çš„å–å€¼ï¼Œå¦‚æœ p å€¼é€‰çš„ä¸å¥½ï¼Œå°±å¯èƒ½ä¼šå®¹æ˜“äº§ç”ŸåŒä¹‰è¯ã€‚è§ä¸‹é¢è¿™ç§æƒ…å†µã€‚æˆ‘ä»¬å“ˆå¸Œè¡¨é•¿åº¦ä¸º6ï¼Œæˆ‘ä»¬é€‰æ‹©6ä¸ºpå€¼ï¼Œåˆ™æœ‰å¯èƒ½äº§ç”Ÿè¿™ç§æƒ…å†µï¼Œæ‰€æœ‰å…³é”®å­—éƒ½å¾—åˆ°äº†0è¿™ä¸ªåœ°å€æ•°ã€‚ é‚£æˆ‘ä»¬åœ¨é€‰ç”¨é™¤æ³•æ•£åˆ—æ³•æ—¶é€‰å– p å€¼æ—¶åº”è¯¥éµå¾ªæ€æ ·çš„è§„åˆ™å‘¢ï¼Ÿ m ä¸åº”ä¸º 2 çš„å¹‚ï¼Œå› ä¸ºå¦‚æœ m &#x3D; 2^p ï¼Œåˆ™ f(k) å°±æ˜¯ k çš„ p ä¸ªæœ€ä½ä½æ•°å­—ã€‚ä¾‹ 12 % 8 &#x3D; 4 ï¼Œ12çš„äºŒè¿›åˆ¶è¡¨ç¤ºä½1100ï¼Œåä¸‰ä½ä¸º100ã€‚ è‹¥æ•£åˆ—è¡¨é•¿ä¸º m ,é€šå¸¸ p ä¸º å°äºæˆ–ç­‰äºè¡¨é•¿ï¼ˆæœ€å¥½æ¥è¿‘mï¼‰çš„æœ€å°è´¨æ•°æˆ–ä¸åŒ…å«å°äº 20 è´¨å› å­çš„åˆæ•°ã€‚ åˆæ•°ï¼šåˆæ•°æ˜¯æŒ‡åœ¨å¤§äº1çš„æ•´æ•°ä¸­é™¤äº†èƒ½è¢«1å’Œæœ¬èº«æ•´é™¤å¤–ï¼Œè¿˜èƒ½è¢«å…¶ä»–æ•°ï¼ˆ0é™¤å¤–ï¼‰æ•´é™¤çš„æ•°ã€‚ è´¨å› å­ï¼šè´¨å› å­ï¼ˆæˆ–è´¨å› æ•°ï¼‰åœ¨æ•°è®ºé‡Œæ˜¯æŒ‡èƒ½æ•´é™¤ç»™å®šæ­£æ•´æ•°çš„è´¨æ•°ã€‚ æ³¨ï¼šè¿™é‡Œçš„2ï¼Œ3ï¼Œ5ä¸ºè´¨å› å­ è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬æ ¹æ®è§„åˆ™é€‰æ‹© 5 ä¸º p å€¼ï¼Œæˆ‘ä»¬å†æ¥çœ‹ã€‚è¿™æ—¶æˆ‘ä»¬å‘ç°åªæœ‰ 6 å’Œ 36 å†²çªï¼Œç›¸å¯¹æ¥è¯´å°±å¥½äº†å¾ˆå¤šã€‚ ä¼˜ç‚¹ï¼šè®¡ç®—æ•ˆç‡é«˜ï¼Œçµæ´» åº”ç”¨åœºæ™¯ï¼šä¸çŸ¥é“å…³é”®å­—åˆ†å¸ƒæƒ…å†µ ä¹˜æ³•æ•£åˆ—æ³•æ„é€ æ•£åˆ—å‡½æ•°çš„ä¹˜æ³•æ•£åˆ—æ³•ä¸»è¦åŒ…å«ä¸¤ä¸ªæ­¥éª¤ ç”¨å…³é”®å­— k ä¹˜ä¸Šå¸¸æ•° A(0 &lt; A &lt; 1)ï¼Œå¹¶æå– k A çš„å°æ•°éƒ¨åˆ† ç”¨ m ä¹˜ä»¥è¿™ä¸ªå€¼ï¼Œå†å‘ä¸‹å–æ•´ æ•£åˆ—å‡½æ•°ä¸º f (k) &#x3D; âŒŠ m(kA mod 1) âŒ‹ è¿™é‡Œçš„ kA mod 1 çš„å«ä¹‰æ˜¯å– keyA çš„å°æ•°éƒ¨åˆ†ï¼Œå³ kA - âŒŠkAâŒ‹ ã€‚ ä¼˜ç‚¹ï¼šå¯¹ m çš„é€‰æ‹©ä¸æ˜¯ç‰¹åˆ«å…³é”®ä¸€èˆ¬é€‰æ‹©å®ƒä¸º 2 çš„æŸä¸ªå¹‚æ¬¡ï¼ˆm &#x3D; 2 ^ p ,pä¸ºæŸä¸ªæ•´æ•°ï¼‰ åº”ç”¨åœºæ™¯ï¼šä¸çŸ¥é“å…³é”®å­—æƒ…å†µ å¹³æ–¹å–ä¸­æ³•è¿™ä¸ªæ–¹æ³•å°±æ¯”è¾ƒç®€å•äº†ï¼Œå‡è®¾å…³é”®å­—æ˜¯ 321ï¼Œé‚£ä¹ˆä»–çš„å¹³æ–¹å°±æ˜¯ 103041ï¼Œå†æŠ½å–ä¸­é—´çš„ 3 ä½å°±æ˜¯ 030 æˆ– 304 ç”¨ä½œæ•£åˆ—åœ°å€ã€‚å†æ¯”å¦‚å…³é”®å­—æ˜¯ 1234 é‚£ä¹ˆå®ƒçš„å¹³æ–¹å°±æ˜¯ 1522756 ï¼ŒæŠ½å–ä¸­é—´ 3 ä½å°±æ˜¯ 227 ç”¨ä½œæ•£åˆ—åœ°å€. ä¼˜ç‚¹ï¼šçµæ´»ï¼Œé€‚ç”¨èŒƒå›´å¹¿æ³› é€‚ç”¨åœºæ™¯ï¼šä¸çŸ¥é“å…³é”®å­—åˆ†å¸ƒï¼Œè€Œä½æ•°åˆä¸æ˜¯å¾ˆå¤§çš„æƒ…å†µã€‚ éšæœºæ•°æ³•æ•…åæ€æ„ï¼Œå–å…³é”®å­—çš„éšæœºå‡½æ•°å€¼ä¸ºå®ƒçš„æ•£åˆ—åœ°å€ã€‚ä¹Ÿå°±æ˜¯ **f(key) &#x3D; random(key)**ã€‚è¿™é‡Œçš„randomæ˜¯éšæœºå‡½æ•°ã€‚ï¼ˆå…·ä½“è§£æè§éšæœºæ¢æµ‹æ³•ï¼‰ é€‚ç”¨åœºæ™¯ï¼šå…³é”®å­—çš„é•¿åº¦ä¸ç­‰æ—¶ ä¸Šé¢æˆ‘ä»¬çš„ä¾‹å­éƒ½æ˜¯é€šè¿‡æ•°å­—è¿›è¡Œä¸¾ä¾‹ï¼Œé‚£ä¹ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²å¯ä¸å¯ä»¥ä½œä¸ºé”®å‘¢ï¼Ÿå½“ç„¶ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå„ç§å„æ ·çš„ç¬¦å·æˆ‘ä»¬éƒ½å¯ä»¥è½¬æ¢æˆæŸç§æ•°å­—æ¥å¯¹å¾…ï¼Œæ¯”å¦‚æˆ‘ä»¬ç»å¸¸æ¥è§¦çš„ASCII ç ï¼Œæ‰€ä»¥æ˜¯åŒæ ·é€‚ç”¨çš„ã€‚ ä»¥ä¸Šå°±æ˜¯å¸¸ç”¨çš„æ•£åˆ—å‡½æ•°æ„é€ æ–¹æ³•ï¼Œå…¶å®ä»–ä»¬çš„ä¸­å¿ƒæ€æƒ³æ˜¯ä¸€è‡´çš„ï¼Œå°†å…³é”®å­—ç»è¿‡åŠ å·¥å¤„ç†ä¹‹åå˜æˆå¦å¤–ä¸€ä¸ªæ•°å­—ï¼Œè€Œè¿™ä¸ªæ•°å­—å°±æ˜¯æˆ‘ä»¬çš„å­˜å‚¨ä½ç½®ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€ç§é—´è°ä¼ é€’æƒ…æŠ¥çš„æ„Ÿè§‰ã€‚ ä¸€ä¸ªå¥½çš„å“ˆå¸Œå‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°½å¯èƒ½å°‘çš„äº§ç”Ÿå†²çªï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½å®Œå…¨é¿å…äº§ç”Ÿå†²çªï¼Œé‚£ä¹ˆé‡åˆ°å†²çªæ—¶åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿä¸‹é¢ç»™å¤§å®¶å¸¦æ¥å‡ ç§å¸¸ç”¨çš„å¤„ç†æ•£åˆ—å†²çªçš„æ–¹æ³•ã€‚ å¤„ç†æ•£åˆ—å†²çªçš„æ–¹æ³•æˆ‘ä»¬åœ¨ä½¿ç”¨ hash å‡½æ•°ä¹‹åå‘ç°å…³é”®å­— key1 ä¸ç­‰äº key2 ï¼Œä½†æ˜¯ f(key1) &#x3D; f(key2)ï¼Œå³æœ‰å†²çªï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸æ€¥æˆ‘ä»¬æ…¢æ…¢å¾€ä¸‹çœ‹ã€‚ å¼€æ”¾åœ°å€æ³•äº†è§£å¼€æ”¾åœ°å€æ³•ä¹‹å‰æˆ‘ä»¬å…ˆè®¾æƒ³ä»¥ä¸‹åœºæ™¯ã€‚ è¢è®°èœé¦†å†…ï¼Œé“ƒé“ƒé“ƒï¼Œé“ƒé“ƒé“ƒ ç”µè¯é“ƒå“äº† å¤§é¹ï¼šè€è¢ï¼Œç»™æˆ‘è®¢ä¸ªåŒ…é—´ï¼Œæˆ‘ä»Šå¤©è¦å»å¸¦å‡ ä¸ªå®¢æˆ·å»ä½ é‚£è°ˆç”Ÿæ„ã€‚ è¢å¨ï¼šå¤§é¹å•Šï¼Œä½ å¸¸ç”¨çš„é‚£ä¸ªåŒ…é—´è¢«äººè®¢èµ°å•¦ã€‚ å¤§é¹ï¼šè€è¢ä½ è¿™ä¸ä»—ä¹‰å‘€ï¼Œå’‹æ²¡ç»™æˆ‘ç•™ä½å‘€ï¼Œé‚£ä½ ç»™æˆ‘æ‰¾ä¸ªç©ºæˆ¿é—´å§ã€‚ è¢å¨ï¼šå¥½æ»´è€å“¥ å“¦ï¼Œç©¿è¶Šå›å¤ä»£å°±æ²¡æœ‰ç”µè¯å•¦ï¼Œé‚£çœ‹æ¥ç©¿è¶Šçš„æ—¶å€™å¾—å¸¦ç€å‡ ä¸ªæ‰‹æœºäº†ã€‚ ä¸Šé¢çš„åœºæ™¯å…¶å®å°±æ˜¯ä¸€ç§å¤„ç†å†²çªçš„æ–¹æ³•â€”â€“å¼€æ”¾åœ°å€æ³• å¼€æ”¾åœ°å€æ³•å°±æ˜¯ä¸€æ—¦å‘ç”Ÿå†²çªï¼Œå°±å»å¯»æ‰¾ä¸‹ä¸€ä¸ªç©ºçš„æ•£åˆ—åœ°å€ï¼Œåªè¦åˆ—è¡¨è¶³å¤Ÿå¤§ï¼Œç©ºçš„æ•£åˆ—åœ°å€æ€»èƒ½æ‰¾åˆ°ï¼Œå¹¶å°†è®°å½•å­˜å…¥ï¼Œä¸ºäº†ä½¿ç”¨å¼€æ”¾å¯»å€æ³•æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦è¿ç»­åœ°æ£€æŸ¥æ•£åˆ—è¡¨ï¼Œæˆ–ç§°ä¸ºæ¢æŸ¥ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æœ‰çº¿æ€§æ¢æµ‹ï¼ŒäºŒæ¬¡æ¢æµ‹ï¼Œéšæœºæ¢æµ‹ã€‚ çº¿æ€§æ¢æµ‹æ³•ä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹çº¿æ€§æ¢æµ‹ï¼Œå…¬å¼ï¼š æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬çš„å…³é”®å­—é›†åˆä¸º{12ï¼Œ67ï¼Œ56ï¼Œ16ï¼Œ25ï¼Œ37ï¼Œ22ï¼Œ29ï¼Œ15ï¼Œ47ï¼Œ48ï¼Œ21}ï¼Œè¡¨é•¿ä¸º12ï¼Œæˆ‘ä»¬å†ç”¨æ•£åˆ—å‡½æ•° f(key) &#x3D; key mod 12ã€‚ æˆ‘ä»¬æ±‚å‡ºæ¯ä¸ª key çš„ f(key)è§ä¸‹è¡¨ æˆ‘ä»¬æŸ¥çœ‹ä¸Šè¡¨å‘ç°ï¼Œå‰äº”ä½çš„ f(key) éƒ½ä¸ç›¸åŒï¼Œå³æ²¡æœ‰å†²çªï¼Œå¯ä»¥ç›´æ¥å­˜å…¥ï¼Œä½†æ˜¯åˆ°äº†ç¬¬å…­ä½ f(37) &#x3D; f(25) &#x3D; 1,é‚£æˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨ä¸Šé¢çš„å…¬å¼ f(37) &#x3D; f (f(37) + 1 ) mod 12 &#x3D; 2ï¼Œè¿™å…¶å®å°±æ˜¯æˆ‘ä»¬çš„è®¢åŒ…é—´çš„åšæ³•ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹å°†ä¸Šé¢çš„æ‰€æœ‰æ•°å­˜å…¥å“ˆå¸Œè¡¨æ˜¯ä»€ä¹ˆæƒ…å†µå§ã€‚ æ³¨ï¼šè“è‰²ä¸ºè®¡ç®—å“ˆå¸Œå€¼ï¼Œçº¢è‰²ä¸ºå­˜å…¥å“ˆå¸Œè¡¨ æˆ‘ä»¬æŠŠè¿™ç§è§£å†³å†²çªçš„å¼€æ”¾åœ°å€æ³•ç§°ä¸ºçº¿æ€§æ¢æµ‹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡è§†é¢‘æ¥æ¨¡æ‹Ÿä¸€ä¸‹çº¿æ€§æ¢æµ‹æ³•çš„å­˜å‚¨è¿‡ç¨‹ã€‚ &lt;video id&#x3D;â€videoâ€ controls&#x3D;â€â€src&#x3D;â€http://mpvideo.qpic.cn/0bf23udbgaagw4aa2n5tqrpvnxodcpoqmeya.f10002.mp4?dis_k=7098b34ae4d0d564f208a7d543987175&amp;dis_t=1609338638&amp;spec_id=MzU4MDUyMDQyNQ%3D%3D1609338634&amp;vid=wxv_1612509429344567297&amp;format_id=10002â€œ preload&#x3D;â€noneâ€&gt; å¦å¤–æˆ‘ä»¬åœ¨è§£å†³å†²çªçš„æ—¶å€™ï¼Œä¼šé‡åˆ° 48 å’Œ 37 è™½ç„¶ä¸æ˜¯åŒä¹‰è¯ï¼Œå´äº‰å¤ºä¸€ä¸ªåœ°å€çš„æƒ…å†µï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºå †ç§¯ã€‚å› ä¸ºå †ç§¯ä½¿å¾—æˆ‘ä»¬éœ€è¦ä¸æ–­çš„å¤„ç†å†²çªï¼Œæ’å…¥å’ŒæŸ¥æ‰¾æ•ˆç‡éƒ½ä¼šå¤§å¤§é™ä½ã€‚ é€šè¿‡ä¸Šé¢çš„è§†é¢‘æˆ‘ä»¬åº”è¯¥äº†è§£äº†çº¿æ€§æ¢æµ‹çš„æ‰§è¡Œè¿‡ç¨‹äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹è¿™ç§æƒ…å†µï¼Œè‹¥æ˜¯æˆ‘ä»¬çš„æœ€åä¸€ä½ä¸ä¸º21ï¼Œä¸º 34 æ—¶ä¼šæœ‰ä»€ä¹ˆäº‹æƒ…å‘ç”Ÿå‘¢ï¼Ÿ æ­¤æ—¶ä»–ç¬¬ä¸€æ¬¡ä¼šè½åœ¨ä¸‹æ ‡ä¸º 10 çš„ä½ç½®ï¼Œé‚£ä¹ˆå¦‚æœç»§ç»­ä½¿ç”¨çº¿æ€§æ¢æµ‹çš„è¯ï¼Œåˆ™éœ€è¦é€šè¿‡ä¸æ–­å–ä½™åå¾—åˆ°ç»“æœï¼Œæ•°æ®é‡å°è¿˜å¥½ï¼Œè¦æ˜¯å¾ˆå¤§çš„è¯é‚£ä¹Ÿå¤ªæ…¢äº†å§ï¼Œä½†æ˜¯æ˜æ˜ä»–çš„å‰é¢å°±æœ‰ä¸€ä¸ªç©ºæˆ¿é—´å‘€ï¼Œå¦‚æœå‘å‰ç§»åŠ¨åªéœ€ç§»åŠ¨ä¸€æ¬¡å³å¯ã€‚ä¸è¦ç€æ€¥ï¼Œå‰è¾ˆä»¬å·²ç»å¸®æˆ‘ä»¬æƒ³å¥½äº†è§£å†³æ–¹æ³• äºŒæ¬¡æ¢æµ‹æ³•å…¶å®ç†è§£äº†æˆ‘ä»¬çš„ä¸Šä¸ªä¾‹å­ä¹‹åï¼Œè¿™ä¸ªä¸€ä¸‹å°±èƒ½æ•´æ˜ç™½äº†ï¼Œæ ¹æœ¬ä¸ç”¨è´¹è„‘å­ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ›´æ”¹äº†ä¸€ä¸‹diçš„å–å€¼ æ³¨ï¼šè¿™é‡Œçš„æ˜¯ -1^2 ä¸ºè´Ÿå€¼ è€Œä¸æ˜¯ ï¼ˆ-1)^2 æ‰€ä»¥å¯¹äºæˆ‘ä»¬çš„34æ¥è¯´ï¼Œå½“di &#x3D; -1æ—¶ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç©ºä½ç½®äº†ã€‚ äºŒæ¬¡æ¢æµ‹æ³•çš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¸è®©å…³é”®å­—èšé›†åœ¨æŸä¸€å—åŒºåŸŸã€‚å¦å¤–è¿˜æœ‰ä¸€ç§æœ‰è¶£çš„æ–¹æ³•ï¼Œä½ç§»é‡é‡‡ç”¨éšæœºå‡½æ•°è®¡ç®—å¾—åˆ°ï¼Œæ¥ç€å¾€ä¸‹çœ‹å§. éšæœºæ¢æµ‹æ³•å¤§å®¶çœ‹åˆ°è¿™æ˜¯ä¸åˆæœ‰æ–°é—®é¢˜äº†ï¼Œåˆšæ‰æˆ‘ä»¬åœ¨æ•£åˆ—å‡½æ•°æ„é€ è§„åˆ™çš„ç¬¬ä¸€æ¡ä¸­è¯´ ï¼ˆ1ï¼‰å¿…é¡»æ˜¯ä¸€è‡´çš„ï¼Œå‡è®¾ä½ è¾“å…¥è¾£å­é¸¡ä¸æ—¶å¾—åˆ°çš„æ˜¯åœ¨çœ‹ï¼Œé‚£ä¹ˆæ¯æ¬¡è¾“å…¥è¾£å­é¸¡ä¸æ—¶ï¼Œå¾—åˆ°çš„ä¹Ÿå¿…é¡»ä¸ºåœ¨çœ‹ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œæ•£åˆ—è¡¨å°†æ¯«æ— ç”¨å¤„ã€‚ å’¦ï¼Ÿæ€ä¹ˆåˆæ˜¯åœ¨çœ‹å“ˆå“ˆï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬ä½¿ç”¨éšæœºæ•°ä½œä¸ºä»–çš„åç§»é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æŸ¥æ‰¾çš„æ—¶å€™å²‚ä¸æ˜¯æŸ¥ä¸åˆ°äº†ï¼Ÿå› ä¸ºæˆ‘ä»¬ di æ˜¯éšæœºç”Ÿæˆçš„å‘€ï¼Œè¿™é‡Œçš„éšæœºå…¶å®æ˜¯ä¼ªéšæœºæ•°ï¼Œä¼ªéšæœºæ•°å«ä¹‰ä¸ºï¼Œæˆ‘ä»¬è®¾ç½®éšæœºç§å­ç›¸åŒï¼Œåˆ™ä¸æ–­è°ƒç”¨éšæœºå‡½æ•°å¯ä»¥ç”Ÿæˆä¸ä¼šé‡å¤çš„æ•°åˆ—ï¼Œæˆ‘ä»¬åœ¨æŸ¥æ‰¾æ—¶ï¼Œç”¨åŒæ ·çš„éšæœºç§å­ï¼Œå®ƒæ¯æ¬¡å¾—åˆ°çš„æ•°åˆ—æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆç›¸åŒçš„ di å°±èƒ½å¾—åˆ°ç›¸åŒçš„æ•£åˆ—åœ°å€ã€‚ éšæœºç§å­ï¼ˆRandom Seedï¼‰æ˜¯è®¡ç®—æœºä¸“ä¸šæœ¯è¯­ï¼Œä¸€ç§ä»¥éšæœºæ•°ä½œä¸ºå¯¹è±¡çš„ä»¥çœŸéšæœºæ•°ï¼ˆç§å­ï¼‰ä¸ºåˆå§‹æ¡ä»¶çš„éšæœºæ•°ã€‚ä¸€èˆ¬è®¡ç®—æœºçš„éšæœºæ•°éƒ½æ˜¯ä¼ªéšæœºæ•°ï¼Œä»¥ä¸€ä¸ªçœŸéšæœºæ•°ï¼ˆç§å­ï¼‰ä½œä¸ºåˆå§‹æ¡ä»¶ï¼Œç„¶åç”¨ä¸€å®šçš„ç®—æ³•ä¸åœè¿­ä»£äº§ç”Ÿéšæœºæ•° é€šè¿‡ä¸Šé¢çš„æµ‹è¯•æ˜¯ä¸æ˜¯ä¸€ä¸‹å°±ç§’æ‡‚å•¦ï¼Œä½¿ç”¨ç›¸åŒçš„éšæœºç§å­ï¼Œç”Ÿæˆçš„æ•°åˆ—æ˜¯ç›¸åŒçš„ã€‚æ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨éšæœºæ•°ä½œä¸ºå®ƒçš„åç§»é‡ã€‚ ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å…¶ä»–çš„å‡½æ•°å¤„ç†æ•£åˆ—å†²çªçš„æ–¹æ³• å†å“ˆå¸Œæ³•è¿™ä¸ªæ–¹æ³•å…¶å®ä¹Ÿç‰¹åˆ«ç®€å•ï¼Œåˆ©ç”¨ä¸åŒçš„å“ˆå¸Œå‡½æ•°å†æ±‚å¾—ä¸€ä¸ªå“ˆå¸Œåœ°å€ï¼Œç›´åˆ°ä¸å‡ºç°å†²çªä¸ºæ­¢ã€‚ f,(key) &#x3D; RH,( key ) (i &#x3D; 1,2,3,4â€¦..k) è¿™é‡Œçš„RH,å°±æ˜¯ä¸åŒçš„æ•£åˆ—å‡½æ•°ï¼Œä½ å¯ä»¥æŠŠæˆ‘ä»¬ä¹‹å‰è¯´è¿‡çš„é‚£äº›æ•£åˆ—å‡½æ•°éƒ½ç”¨ä¸Šï¼Œæ¯å½“å‘ç”Ÿå†²çªæ—¶å°±æ¢ä¸€ä¸ªæ•£åˆ—å‡½æ•°ï¼Œç›¸ä¿¡æ€»æœ‰ä¸€ä¸ªèƒ½å¤Ÿè§£å†³å†²çªçš„ã€‚è¿™ç§æ–¹æ³•èƒ½ä½¿å…³é”®å­—ä¸äº§ç”Ÿèšé›†ï¼Œä½†æ˜¯ä»£ä»·å°±æ˜¯å¢åŠ äº†è®¡ç®—æ—¶é—´ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•å•Šã€‚ é“¾åœ°å€æ³•ä¸‹é¢æˆ‘ä»¬å†è®¾æƒ³ä»¥ä¸‹æƒ…æ™¯ã€‚ è¢è®°èœé¦†å†…ï¼Œé“ƒé“ƒé“ƒï¼Œé“ƒé“ƒé“ƒç”µè¯é“ƒåˆå“äº†ï¼Œé‚£ä¸ªå¤§é¹åˆæ¥è®¢æˆ¿é—´äº†ã€‚ å¤§é¹ï¼šè€è¢å•Šï¼Œæˆ‘ä¸€ä¼šå»ä½ é‚£åƒä¸ªé¥­ï¼Œè¿˜æ˜¯ä¸Šå›é‚£ä¸ªåŒ…é—´ è¢å¨ï¼šå¤§é¹ä½ ä¸‹å›èƒ½ä¸èƒ½æ—©ç‚¹è¯´å•Šï¼Œåˆæ²¡äººè®¢èµ°äº†ï¼Œè¿™å›æ˜¯è€ç‹è®¢çš„ å¤§é¹ï¼šè€ç‹è¿™ä¸ªè€ä¸œè¥¿å•Šï¼Œåæ­£ä¹Ÿæ˜¯ç†Ÿäººï¼Œä½ å†ç»™æˆ‘æ•´ä¸ªæ¡Œå­ï¼Œæˆ‘æ‹¼åœ¨ä»–åé¢å§ ä¸å¥½æ„æ€å•Šå„ä½åŒå­¦ï¼Œä¿¡é¸½æœ€è¿‘å¤ªè´µäº†è¿˜æ²¡æ¥å¾—åŠä¹°ã€‚ä¸Šé¢çš„æƒ…æ™¯å°±æ˜¯æ¨¡æ‹Ÿæˆ‘ä»¬çš„æ–°çš„å¤„ç†å†²çªçš„æ–¹æ³•é“¾åœ°å€æ³•ã€‚ ä¸Šé¢æˆ‘ä»¬éƒ½æ˜¯é‡åˆ°å†²çªä¹‹åï¼Œå°±æ¢åœ°æ–¹ã€‚é‚£ä¹ˆæˆ‘ä»¬æœ‰æ²¡æœ‰ä¸æ¢åœ°æ–¹çš„åŠæ³•å‘¢ï¼Ÿé‚£å°±æ˜¯æˆ‘ä»¬ç°åœ¨è¯´çš„é“¾åœ°å€æ³•ã€‚ è¿˜è®°å¾—æˆ‘ä»¬è¯´è¿‡çš„åŒä¹‰è¯å—ï¼Ÿå°±æ˜¯ key ä¸åŒ f(key) ç›¸åŒçš„æƒ…å†µï¼Œæˆ‘ä»¬å°†è¿™äº›åŒä¹‰è¯å­˜å‚¨åœ¨ä¸€ä¸ªå•é“¾è¡¨ä¸­ï¼Œè¿™ç§è¡¨å«åšåŒä¹‰è¯å­è¡¨ï¼Œæ•£åˆ—è¡¨ä¸­åªå­˜å‚¨åŒä¹‰è¯å­è¡¨çš„å¤´æŒ‡é’ˆã€‚æˆ‘ä»¬è¿˜æ˜¯ç”¨åˆšæ‰çš„ä¾‹å­ï¼Œå…³é”®å­—é›†åˆä¸º{12ï¼Œ67ï¼Œ56ï¼Œ16ï¼Œ25ï¼Œ37ï¼Œ22ï¼Œ29ï¼Œ15ï¼Œ47ï¼Œ48ï¼Œ21}ï¼Œè¡¨é•¿ä¸º12ï¼Œæˆ‘ä»¬å†ç”¨æ•£åˆ—å‡½æ•° f(key) &#x3D; key mod 12ã€‚æˆ‘ä»¬ç”¨äº†é“¾åœ°å€æ³•ä¹‹åå°±å†ä¹Ÿä¸å­˜åœ¨å†²çªäº†ï¼Œæ— è®ºæœ‰å¤šå°‘å†²çªï¼Œæˆ‘ä»¬åªéœ€åœ¨åŒä¹‰è¯å­è¡¨ä¸­æ·»åŠ ç»“ç‚¹å³å¯ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹é“¾åœ°å€æ³•çš„å­˜å‚¨æƒ…å†µã€‚ é“¾åœ°å€æ³•è™½ç„¶èƒ½å¤Ÿä¸äº§ç”Ÿå†²çªï¼Œä½†æ˜¯ä¹Ÿå¸¦æ¥äº†æŸ¥æ‰¾æ—¶éœ€è¦éå†å•é“¾è¡¨çš„æ€§èƒ½æ¶ˆè€—ï¼Œæœ‰å¾—å¿…æœ‰å¤±å˜›ã€‚ å…¬å…±æº¢å‡ºåŒºæ³•ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ç§æ–°çš„æ–¹æ³•ï¼Œè¿™å›å¤§é¹åˆè¦æ¥åƒé¥­äº†ã€‚ è¢è®°èœé¦†å†…â€¦.. è¢å¨ï¼šå‘¦ï¼Œè¿™æ˜¯ä»€ä¹ˆé£æŠŠä½ ç»™åˆ®æ¥äº†ï¼Œå’‹æ²¡å¼€ä½ çš„å¤§å¥”å•Šã€‚ å¤§é¹ï¼šå“å‘€å¦ˆå‘€ï¼Œåˆ«é‚£ä¹ˆå¤šåºŸè¯äº†ï¼Œæˆ‘å¿«é¥¿æ­»äº†ï¼Œä½ å¿«ç»™æˆ‘æ‰¾ä¸ªä½ç½®ï¼Œæˆ‘è¦åƒç‚¹é¥­ã€‚ è¢å¨ï¼šä½ æ¥çš„ï¼Œå¤ªä¸å·§äº†ï¼Œå’±ä»¬çš„åº—å·²ç»æ»¡äº†ï¼Œä½ å…ˆå»æ—è¾¹çš„å°å±‹çœ‹ä¼šç”µè§†ï¼Œç­‰æœ‰ç©ºäº†æˆ‘å†å«ä½ ã€‚å°å±‹é‡Œé¢è¿˜æœ‰å‡ ä¸ªå’Œä½ ä¸€æ ·æ¥æ™šçš„ï¼Œä½ ä»¬ä¸€èµ·çœ‹å§ã€‚ å¤§é¹ï¼šç”µè§†ï¼Ÿçœ‹ç”µè§†ï¼Ÿ ä¸Šé¢çš„æƒ…æ™¯å°±æ˜¯æ¨¡æ‹Ÿæˆ‘ä»¬çš„å…¬å…±æº¢å‡ºåŒºæ³•ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œä½ ä¸æ˜¯å†²çªå—ï¼Ÿé‚£å†²çªçš„å„ä½æˆ‘å…ˆç»™ä½ å®‰æ’ä¸ªåœ°æ–¹å‘†ç€ï¼Œè¿™æ ·ä½ å°±æœ‰åœ°æ–¹ä½äº†ã€‚æˆ‘ä»¬ä¸ºæ‰€æœ‰å†²çªçš„å…³é”®å­—å»ºç«‹äº†ä¸€ä¸ªå…¬å…±çš„æº¢å‡ºåŒºæ¥å­˜æ”¾ã€‚ é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆè¿›è¡ŒæŸ¥æ‰¾å‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆé€šè¿‡æ•£åˆ—å‡½æ•°è®¡ç®—å‡ºæ•£åˆ—åœ°å€åï¼Œå…ˆäºåŸºæœ¬è¡¨å¯¹æ¯”ï¼Œå¦‚æœä¸ç›¸ç­‰å†åˆ°æº¢å‡ºè¡¨å»é¡ºåºæŸ¥æ‰¾ã€‚è¿™ç§è§£å†³å†²çªçš„æ–¹æ³•ï¼Œå¯¹äºå†²çªå¾ˆå°‘çš„æƒ…å†µæ€§èƒ½è¿˜æ˜¯éå¸¸é«˜çš„ã€‚ æ•£åˆ—è¡¨æŸ¥æ‰¾ç®—æ³•(çº¿æ€§æ¢æµ‹æ³•)ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ•£åˆ—è¡¨æŸ¥æ‰¾ç®—æ³•çš„å®ç° é¦–å…ˆéœ€è¦å®šä¹‰æ•£åˆ—åˆ—è¡¨çš„ç»“æ„ä»¥åŠä¸€äº›ç›¸å…³å¸¸æ•°ï¼Œå…¶ä¸­elemä»£è¡¨æ•£åˆ—è¡¨æ•°æ®å­˜å‚¨æ•°ç»„ï¼Œcountä»£è¡¨çš„æ˜¯å½“å‰æ’å…¥å…ƒç´ ä¸ªæ•°ï¼Œsizeä»£è¡¨å“ˆå¸Œè¡¨å®¹é‡ï¼ŒNULLKEYæ•£åˆ—è¡¨åˆå§‹å€¼ï¼Œç„¶åæˆ‘ä»¬å¦‚æœæŸ¥æ‰¾æˆåŠŸå°±è¿”å›ç´¢å¼•ï¼Œå¦‚æœä¸å­˜åœ¨è¯¥å…ƒç´ å°±è¿”å›å…ƒç´ ä¸å­˜åœ¨ã€‚ æˆ‘ä»¬å°†å“ˆå¸Œè¡¨åˆå§‹åŒ–ï¼Œä¸ºæ•°ç»„å…ƒç´ èµ‹åˆå€¼ã€‚ æ’å…¥æ“ä½œçš„å…·ä½“æ­¥éª¤ï¼š ï¼ˆ1ï¼‰é€šè¿‡å“ˆå¸Œå‡½æ•°(é™¤æ³•æ•£åˆ—æ³•)ï¼Œå°†keyè½¬åŒ–ä¸ºæ•°ç»„ä¸‹æ ‡ ï¼ˆ2ï¼‰å¦‚æœè¯¥ä¸‹æ ‡ä¸­æ²¡æœ‰å…ƒç´ ï¼Œåˆ™æ’å…¥ï¼Œå¦åˆ™è¯´æ˜æœ‰å†²çªï¼Œåˆ™åˆ©ç”¨çº¿æ€§æ¢æµ‹æ³•å¤„ç†å†²çªã€‚è¯¦ç»†æ­¥éª¤è§æ³¨é‡Š æŸ¥æ‰¾æ“ä½œçš„å…·ä½“æ­¥éª¤ï¼š ï¼ˆ1ï¼‰é€šè¿‡å“ˆå¸Œå‡½æ•°ï¼ˆåŒæ’å…¥æ—¶ä¸€æ ·ï¼‰ï¼Œå°†keyè½¬åŒ–æˆæ•°ç»„ä¸‹æ ‡ ï¼ˆ2ï¼‰é€šè¿‡æ•°ç»„ä¸‹æ ‡æ‰¾åˆ°keyå€¼ï¼Œå¦‚æœkeyä¸€è‡´ï¼Œåˆ™æŸ¥æ‰¾æˆåŠŸï¼Œå¦åˆ™åˆ©ç”¨çº¿æ€§æ¢æµ‹æ³•ç»§ç»­æŸ¥æ‰¾ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®Œæ•´ä»£ç  æ•£åˆ—è¡¨æ€§èƒ½åˆ†æå¦‚æœæ²¡æœ‰å†²çªçš„è¯ï¼Œæ•£åˆ—æŸ¥æ‰¾æ˜¯æˆ‘ä»¬æŸ¥æ‰¾ä¸­æ•ˆç‡æœ€é«˜çš„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1),ä½†æ˜¯æ²¡æœ‰å†²çªçš„æƒ…å†µæ˜¯ä¸€ç§ç†æƒ³æƒ…å†µï¼Œé‚£ä¹ˆæ•£åˆ—æŸ¥æ‰¾çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦å–å†³äºå“ªäº›æ–¹é¢å‘¢ï¼Ÿ 1.æ•£åˆ—å‡½æ•°æ˜¯å¦å‡åŒ€æˆ‘ä»¬åœ¨ä¸Šæ–‡è¯´åˆ°ï¼Œå¯ä»¥é€šè¿‡è®¾è®¡æ•£åˆ—å‡½æ•°å‡å°‘å†²çªï¼Œä½†æ˜¯ç”±äºä¸åŒçš„æ•£åˆ—å‡½æ•°å¯¹ä¸€ç»„å…³é”®å­—äº§ç”Ÿå†²çªå¯èƒ½æ€§æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¸è€ƒè™‘å®ƒå¯¹å¹³å‡æŸ¥æ‰¾é•¿åº¦çš„å½±å“ã€‚ 2.å¤„ç†å†²çªçš„æ–¹æ³•ç›¸åŒå…³é”®å­—ï¼Œç›¸åŒæ•£åˆ—å‡½æ•°ï¼Œä¸åŒå¤„ç†å†²çªæ–¹å¼ï¼Œä¼šä½¿å¹³å‡æŸ¥æ‰¾é•¿åº¦ä¸åŒï¼Œæ¯”å¦‚æˆ‘ä»¬çº¿æ€§æ¢æµ‹æœ‰æ—¶ä¼šå †ç§¯ï¼Œåˆ™ä¸å¦‚äºŒæ¬¡æ¢æµ‹æ³•å¥½ï¼Œå› ä¸ºé“¾åœ°å€æ³•å¤„ç†å†²çªæ—¶ä¸ä¼šäº§ç”Ÿä»»ä½•å †ç§¯ï¼Œå› è€Œå…·æœ‰æœ€ä½³çš„å¹³å‡æŸ¥æ‰¾æ€§èƒ½ 3.æ•£åˆ—è¡¨çš„è£…å¡«å› å­æœ¬æ¥æƒ³åœ¨ä¸Šæ–‡ä¸­æåˆ°è£…å¡«å› å­çš„ï¼Œä½†æ˜¯åæ¥å‘ç°å³ä½¿æ²¡æœ‰è¯´æ˜ä¹Ÿä¸å½±å“æˆ‘ä»¬å¯¹å“ˆå¸Œè¡¨çš„ç†è§£ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è£…å¡«å› å­çš„æ€»ç»“ è£…å¡«å› å­ Î± &#x3D; å¡«å…¥è¡¨ä¸­çš„è®°å½•æ•° &#x2F; æ•£åˆ—è¡¨é•¿åº¦ æ•£åˆ—å› å­åˆ™ä»£è¡¨ç€æ•£åˆ—è¡¨çš„è£…æ»¡ç¨‹åº¦ï¼Œè¡¨ä¸­è®°å½•è¶Šå¤šï¼ŒÎ±å°±è¶Šå¤§ï¼Œäº§ç”Ÿå†²çªçš„æ¦‚ç‡å°±è¶Šå¤§ã€‚æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ä¾‹å­ä¸­ è¡¨çš„é•¿åº¦ä¸º12ï¼Œå¡«å…¥è®°å½•æ•°ä¸º6ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ Î± &#x3D; 6 &#x2F; 12 &#x3D; 0.5 æ‰€ä»¥è¯´å½“æˆ‘ä»¬çš„ Î± æ¯”è¾ƒå¤§æ—¶å†å¡«å…¥å…ƒç´ é‚£ä¹ˆäº§ç”Ÿå†²çªçš„å¯èƒ½æ€§å°±éå¸¸å¤§äº†ã€‚æ‰€ä»¥è¯´æ•£åˆ—è¡¨çš„å¹³å‡æŸ¥æ‰¾é•¿åº¦å–å†³äºè£…å¡«å› å­ï¼Œè€Œä¸æ˜¯å–å†³äºè®°å½•æ•°ã€‚æ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è£…å¡«å› å­ä»¥ä¾¿å°†å¹³å‡æŸ¥æ‰¾é•¿åº¦é™å®šåœ¨ä¸€ä¸ªèŒƒå›´ä¹‹å†…ã€‚","tags":["ç®—æ³•","æ•°æ®ç»“æ„","å“ˆå¸Œè¡¨"],"categories":["ç®—æ³•","æ•°æ®ç»“æ„"]},{"title":"SQLä¼˜åŒ–æœ€å¹²è´§æ€»ç»“","path":"/2023/12/25/SQLä¼˜åŒ–æœ€å¹²è´§æ€»ç»“/","content":"å‰è¨€BATJTMDç­‰å¤§å‚çš„é¢è¯•éš¾åº¦è¶Šæ¥è¶Šé«˜ï¼Œä½†æ— è®ºä»å¤§å‚è¿˜æ˜¯åˆ°å°å…¬å¸ï¼Œä¸€ç›´æœªå˜çš„ä¸€ä¸ªé‡ç‚¹å°±æ˜¯å¯¹SQLä¼˜åŒ–ç»éªŒçš„è€ƒå¯Ÿã€‚ä¸€æåˆ°æ•°æ®åº“ï¼Œå…ˆâ€œè¯´ä¸€è¯´ä½ å¯¹SQLä¼˜åŒ–çš„è§è§£å§ï¼Ÿâ€ã€‚ SQLä¼˜åŒ–å·²ç»æˆä¸ºè¡¡é‡ç¨‹åºçŒ¿ä¼˜ç§€ä¸å¦çš„ç¡¬æ€§æŒ‡æ ‡ï¼Œç”šè‡³åœ¨å„å¤§å‚æ‹›è˜å²—ä½èŒèƒ½ä¸Šéƒ½æœ‰æ˜ç æ ‡æ³¨ï¼Œå¦‚æœæ˜¯ä½ ï¼Œåœ¨è¿™ä¸ªé—®é¢˜ä¸Šèƒ½åŠæ‰“é¢è¯•å®˜è¿˜æ˜¯ä¼šè¢«åŠæ‰“å‘¢ï¼Ÿ ç›®å½• å‰è¨€ SELECTè¯­å¥ - è¯­æ³•é¡ºåºï¼š SELECTè¯­å¥ - æ‰§è¡Œé¡ºåºï¼š SQLä¼˜åŒ–ç­–ç•¥ ä¸€ã€é¿å…ä¸èµ°ç´¢å¼•çš„åœºæ™¯ äºŒã€SELECTè¯­å¥å…¶ä»–ä¼˜åŒ– ä¸‰ã€å¢åˆ æ”¹ DML è¯­å¥ä¼˜åŒ– å››ã€æŸ¥è¯¢æ¡ä»¶ä¼˜åŒ– äº”ã€å»ºè¡¨ä¼˜åŒ– æœ‰æœ‹å‹ç–‘é—®åˆ°ï¼ŒSQLä¼˜åŒ–çœŸçš„æœ‰è¿™ä¹ˆé‡è¦ä¹ˆï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒSQLä¼˜åŒ–åœ¨æå‡ç³»ç»Ÿæ€§èƒ½ä¸­æ˜¯ï¼šï¼ˆæˆæœ¬æœ€ä½ &amp;&amp; ä¼˜åŒ–æ•ˆæœæœ€æ˜æ˜¾ï¼‰ çš„é€”å¾„ã€‚å¦‚æœä½ çš„å›¢é˜Ÿåœ¨SQLä¼˜åŒ–è¿™æ–¹é¢æå¾—å¾ˆä¼˜ç§€ï¼Œå¯¹ä½ ä»¬æ•´ä¸ªå¤§å‹ç³»ç»Ÿå¯ç”¨æ€§æ–¹é¢æ— ç–‘æ˜¯ä¸€ä¸ªè´¨çš„è·¨è¶Šï¼ŒçœŸçš„èƒ½è®©ä½ ä»¬è€æ¿çœä¸‹ä¸æ­¢å‡ æ²“å­é’±ã€‚ ä¼˜åŒ–æˆæœ¬ï¼šç¡¬ä»¶&gt;ç³»ç»Ÿé…ç½®&gt;æ•°æ®åº“è¡¨ç»“æ„&gt;SQLåŠç´¢å¼•ã€‚ ä¼˜åŒ–æ•ˆæœï¼šç¡¬ä»¶&lt;ç³»ç»Ÿé…ç½®&lt;æ•°æ®åº“è¡¨ç»“æ„&lt;SQLåŠç´¢å¼•ã€‚ 123456789101112131415String result = &quot;å—¯ï¼Œä¸é”™ï¼Œ&quot;; if (&quot;SQLä¼˜åŒ–ç»éªŒè¶³&quot;) &#123; if (&quot;ç†Ÿæ‚‰äº‹åŠ¡é”&quot;) &#123; if (&quot;å¹¶å‘åœºæ™¯å¤„ç†666&quot;) &#123; if (&quot;ä¼šæ‰“ç‹è€…è£è€€&quot;) &#123; result += &quot;æ˜å¤©å…¥èŒ&quot; &#125; &#125; &#125;&#125; else &#123; result += &quot;å…ˆå›å»ç­‰æ¶ˆæ¯å§&quot;;&#125; Logger.info(&quot;é¢è¯•å®˜ï¼š&quot; + result ); åˆ«çœ‹äº†ï¼Œä¸Šé¢è¿™æ˜¯ä¸€é“é€å‘½é¢˜ã€‚ å¥½äº†æˆ‘ä»¬è¨€å½’æ­£ä¼ ï¼Œé¦–å…ˆï¼Œå¯¹äºMySQLå±‚ä¼˜åŒ–æˆ‘ä¸€èˆ¬éµä»äº”ä¸ªåŸåˆ™ï¼š å‡å°‘æ•°æ®è®¿é—®ï¼šè®¾ç½®åˆç†çš„å­—æ®µç±»å‹ï¼Œå¯ç”¨å‹ç¼©ï¼Œé€šè¿‡ç´¢å¼•è®¿é—®ç­‰å‡å°‘ç£ç›˜IO è¿”å›æ›´å°‘çš„æ•°æ®ï¼šåªè¿”å›éœ€è¦çš„å­—æ®µå’Œæ•°æ®åˆ†é¡µå¤„ç† å‡å°‘ç£ç›˜ioåŠç½‘ç»œio å‡å°‘äº¤äº’æ¬¡æ•°ï¼šæ‰¹é‡DMLæ“ä½œï¼Œå‡½æ•°å­˜å‚¨ç­‰å‡å°‘æ•°æ®è¿æ¥æ¬¡æ•° å‡å°‘æœåŠ¡å™¨CPUå¼€é”€ï¼šå°½é‡å‡å°‘æ•°æ®åº“æ’åºæ“ä½œä»¥åŠå…¨è¡¨æŸ¥è¯¢ï¼Œå‡å°‘cpu å†…å­˜å ç”¨ åˆ©ç”¨æ›´å¤šèµ„æºï¼šä½¿ç”¨è¡¨åˆ†åŒºï¼Œå¯ä»¥å¢åŠ å¹¶è¡Œæ“ä½œï¼Œæ›´å¤§é™åº¦åˆ©ç”¨cpuèµ„æº æ€»ç»“åˆ°SQLä¼˜åŒ–ä¸­ï¼Œå°±ä¸‰ç‚¹: æœ€å¤§åŒ–åˆ©ç”¨ç´¢å¼•ï¼› å°½å¯èƒ½é¿å…å…¨è¡¨æ‰«æï¼› å‡å°‘æ— æ•ˆæ•°æ®çš„æŸ¥è¯¢ï¼› ç†è§£SQLä¼˜åŒ–åŸç† ï¼Œé¦–å…ˆè¦ææ¸…æ¥šSQLæ‰§è¡Œé¡ºåºï¼š SELECTè¯­å¥ - è¯­æ³•é¡ºåºï¼š123456789101. SELECT 2. DISTINCT &lt;select_list&gt;3. FROM &lt;left_table&gt;4. &lt;join_type&gt; JOIN &lt;right_table&gt;5. ON &lt;join_condition&gt;6. WHERE &lt;where_condition&gt;7. GROUP BY &lt;group_by_list&gt;8. HAVING &lt;having_condition&gt;9. ORDER BY &lt;order_by_condition&gt;10.LIMIT &lt;limit_number&gt; SELECTè¯­å¥ - æ‰§è¡Œé¡ºåºï¼š FROM&lt;è¡¨å&gt; # é€‰å–è¡¨ï¼Œå°†å¤šä¸ªè¡¨æ•°æ®é€šè¿‡ç¬›å¡å°”ç§¯å˜æˆä¸€ä¸ªè¡¨ã€‚ON&lt;ç­›é€‰æ¡ä»¶&gt; # å¯¹ç¬›å¡å°”ç§¯çš„è™šè¡¨è¿›è¡Œç­›é€‰JOIN &lt;join, left join, right joinâ€¦&gt;&lt;joinè¡¨&gt; # æŒ‡å®šjoinï¼Œç”¨äºæ·»åŠ æ•°æ®åˆ°onä¹‹åçš„è™šè¡¨ä¸­ï¼Œä¾‹å¦‚left joinä¼šå°†å·¦è¡¨çš„å‰©ä½™æ•°æ®æ·»åŠ åˆ°è™šè¡¨ä¸­WHERE&lt;whereæ¡ä»¶&gt; # å¯¹ä¸Šè¿°è™šè¡¨è¿›è¡Œç­›é€‰GROUP BY&lt;åˆ†ç»„æ¡ä»¶&gt; # åˆ†ç»„&lt;SUM()ç­‰èšåˆå‡½æ•°&gt; # ç”¨äºhavingå­å¥è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨ä¹¦å†™ä¸Šè¿™ç±»èšåˆå‡½æ•°æ˜¯å†™åœ¨havingåˆ¤æ–­é‡Œé¢çš„HAVING&lt;åˆ†ç»„ç­›é€‰&gt; # å¯¹åˆ†ç»„åçš„ç»“æœè¿›è¡Œèšåˆç­›é€‰SELECT&lt;è¿”å›æ•°æ®åˆ—è¡¨&gt; # è¿”å›çš„å•åˆ—å¿…é¡»åœ¨group byå­å¥ä¸­ï¼Œèšåˆå‡½æ•°é™¤å¤–DISTINCT# æ•°æ®é™¤é‡ORDER BY&lt;æ’åºæ¡ä»¶&gt; # æ’åºLIMIT&lt;è¡Œæ•°é™åˆ¶&gt; SQLä¼˜åŒ–ç­–ç•¥ å£°æ˜ï¼šä»¥ä¸‹SQLä¼˜åŒ–ç­–ç•¥é€‚ç”¨äºæ•°æ®é‡è¾ƒå¤§çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœæ•°æ®é‡è¾ƒå°ï¼Œæ²¡å¿…è¦ä»¥æ­¤ä¸ºå‡†ï¼Œä»¥å…ç”»è›‡æ·»è¶³ã€‚ ä¸€ã€é¿å…ä¸èµ°ç´¢å¼•çš„åœºæ™¯1. å°½é‡é¿å…åœ¨å­—æ®µå¼€å¤´æ¨¡ç³ŠæŸ¥è¯¢ï¼Œä¼šå¯¼è‡´æ•°æ®åº“å¼•æ“æ”¾å¼ƒç´¢å¼•è¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ä¸‹ï¼š 1SELECT * FROM t WHERE username LIKE &#x27;%é™ˆ%&#x27; ä¼˜åŒ–æ–¹å¼ï¼šå°½é‡åœ¨å­—æ®µåé¢ä½¿ç”¨æ¨¡ç³ŠæŸ¥è¯¢ã€‚å¦‚ä¸‹ï¼š 1SELECT * FROM t WHERE username LIKE &#x27;é™ˆ%&#x27; å¦‚æœéœ€æ±‚æ˜¯è¦åœ¨å‰é¢ä½¿ç”¨æ¨¡ç³ŠæŸ¥è¯¢ï¼Œ ä½¿ç”¨MySQLå†…ç½®å‡½æ•°INSTR(str,substr) æ¥åŒ¹é…ï¼Œä½œç”¨ç±»ä¼¼äºjavaä¸­çš„indexOf()ï¼ŒæŸ¥è¯¢å­—ç¬¦ä¸²å‡ºç°çš„è§’æ ‡ä½ç½® ä½¿ç”¨FullTextå…¨æ–‡ç´¢å¼•ï¼Œç”¨match against æ£€ç´¢ æ•°æ®é‡è¾ƒå¤§çš„æƒ…å†µï¼Œå»ºè®®å¼•ç”¨ElasticSearchã€solrï¼Œäº¿çº§æ•°æ®é‡æ£€ç´¢é€Ÿåº¦ç§’çº§ å½“è¡¨æ•°æ®é‡è¾ƒå°‘ï¼ˆå‡ åƒæ¡å„¿é‚£ç§ï¼‰ï¼Œåˆ«æ•´èŠ±é‡Œèƒ¡å“¨çš„ï¼Œç›´æ¥ç”¨like â€˜%xx%â€™ã€‚ 2. å°½é‡é¿å…ä½¿ç”¨in å’Œnot inï¼Œä¼šå¯¼è‡´å¼•æ“èµ°å…¨è¡¨æ‰«æã€‚å¦‚ä¸‹ï¼š 1SELECT * FROM t WHERE id IN (2,3) ä¼˜åŒ–æ–¹å¼ï¼šå¦‚æœæ˜¯è¿ç»­æ•°å€¼ï¼Œå¯ä»¥ç”¨betweenä»£æ›¿ã€‚å¦‚ä¸‹ï¼š 1SELECT * FROM t WHERE id BETWEEN 2 AND 3 å¦‚æœæ˜¯å­æŸ¥è¯¢ï¼Œå¯ä»¥ç”¨existsä»£æ›¿ã€‚å¦‚ä¸‹ï¼š 1234-- ä¸èµ°ç´¢å¼•select * from A where A.id in (select id from B);-- èµ°ç´¢å¼•select * from A where exists (select * from B where B.id = A.id); 3. å°½é‡é¿å…ä½¿ç”¨ orï¼Œä¼šå¯¼è‡´æ•°æ®åº“å¼•æ“æ”¾å¼ƒç´¢å¼•è¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ä¸‹ï¼š 1SELECT * FROM t WHERE id = 1 OR id = 3 ä¼˜åŒ–æ–¹å¼ï¼šå¯ä»¥ç”¨unionä»£æ›¿orã€‚å¦‚ä¸‹ï¼š 123SELECT * FROM t WHERE id = 1 UNIONSELECT * FROM t WHERE id = 3 4. å°½é‡é¿å…è¿›è¡Œnullå€¼çš„åˆ¤æ–­ï¼Œä¼šå¯¼è‡´æ•°æ®åº“å¼•æ“æ”¾å¼ƒç´¢å¼•è¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ä¸‹ï¼š 1SELECT * FROM t WHERE score IS NULL ä¼˜åŒ–æ–¹å¼ï¼šå¯ä»¥ç»™å­—æ®µæ·»åŠ é»˜è®¤å€¼0ï¼Œå¯¹0å€¼è¿›è¡Œåˆ¤æ–­ã€‚å¦‚ä¸‹ï¼š 1SELECT * FROM t WHERE score = 0 5.å°½é‡é¿å…åœ¨whereæ¡ä»¶ä¸­ç­‰å·çš„å·¦ä¾§è¿›è¡Œè¡¨è¾¾å¼ã€å‡½æ•°æ“ä½œï¼Œä¼šå¯¼è‡´æ•°æ®åº“å¼•æ“æ”¾å¼ƒç´¢å¼•è¿›è¡Œå…¨è¡¨æ‰«æã€‚å¯ä»¥å°†è¡¨è¾¾å¼ã€å‡½æ•°æ“ä½œç§»åŠ¨åˆ°ç­‰å·å³ä¾§ã€‚å¦‚ä¸‹ï¼š 1234-- å…¨è¡¨æ‰«æSELECT * FROM T WHERE score/10 = 9-- èµ°ç´¢å¼•SELECT * FROM T WHERE score = 10*9 6. å½“æ•°æ®é‡å¤§æ—¶ï¼Œé¿å…ä½¿ç”¨where 1&#x3D;1çš„æ¡ä»¶ã€‚é€šå¸¸ä¸ºäº†æ–¹ä¾¿æ‹¼è£…æŸ¥è¯¢æ¡ä»¶ï¼Œæˆ‘ä»¬ä¼šé»˜è®¤ä½¿ç”¨è¯¥æ¡ä»¶ï¼Œæ•°æ®åº“å¼•æ“ä¼šæ”¾å¼ƒç´¢å¼•è¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ä¸‹ï¼š 1SELECT username, age, sex FROM T WHERE 1=1 ä¼˜åŒ–æ–¹å¼ï¼šç”¨ä»£ç æ‹¼è£…sqlæ—¶è¿›è¡Œåˆ¤æ–­ï¼Œæ²¡ where æ¡ä»¶å°±å»æ‰ whereï¼Œæœ‰whereæ¡ä»¶å°±åŠ  andã€‚ 7. æŸ¥è¯¢æ¡ä»¶ä¸èƒ½ç”¨ &lt;&gt; æˆ–è€… !&#x3D;ä½¿ç”¨ç´¢å¼•åˆ—ä½œä¸ºæ¡ä»¶è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œéœ€è¦é¿å…ä½¿ç”¨&lt;&gt;æˆ–è€…!&#x3D;ç­‰åˆ¤æ–­æ¡ä»¶ã€‚å¦‚ç¡®å®ä¸šåŠ¡éœ€è¦ï¼Œä½¿ç”¨åˆ°ä¸ç­‰äºç¬¦å·ï¼Œéœ€è¦åœ¨é‡æ–°è¯„ä¼°ç´¢å¼•å»ºç«‹ï¼Œé¿å…åœ¨æ­¤å­—æ®µä¸Šå»ºç«‹ç´¢å¼•ï¼Œæ”¹ç”±æŸ¥è¯¢æ¡ä»¶ä¸­å…¶ä»–ç´¢å¼•å­—æ®µä»£æ›¿ã€‚ 8. whereæ¡ä»¶ä»…åŒ…å«å¤åˆç´¢å¼•éå‰ç½®åˆ—å¦‚ä¸‹ï¼šå¤åˆï¼ˆè”åˆï¼‰ç´¢å¼•åŒ…å«key_part1ï¼Œkey_part2ï¼Œkey_part3ä¸‰åˆ—ï¼Œä½†SQLè¯­å¥æ²¡æœ‰åŒ…å«ç´¢å¼•å‰ç½®åˆ—â€key_part1â€ï¼ŒæŒ‰ç…§MySQLè”åˆç´¢å¼•çš„æœ€å·¦åŒ¹é…åŸåˆ™ï¼Œä¸ä¼šèµ°è”åˆç´¢å¼•ã€‚ 1select col1 from table where key_part2=1 and key_part3=2 9. éšå¼ç±»å‹è½¬æ¢é€ æˆä¸ä½¿ç”¨ç´¢å¼•å¦‚ä¸‹SQLè¯­å¥ç”±äºç´¢å¼•å¯¹åˆ—ç±»å‹ä¸ºvarcharï¼Œä½†ç»™å®šçš„å€¼ä¸ºæ•°å€¼ï¼Œæ¶‰åŠéšå¼ç±»å‹è½¬æ¢ï¼Œé€ æˆä¸èƒ½æ­£ç¡®èµ°ç´¢å¼•ã€‚ 1select col1 from table where col_varchar=123; 10. order by æ¡ä»¶è¦ä¸whereä¸­æ¡ä»¶ä¸€è‡´ï¼Œå¦åˆ™order byä¸ä¼šåˆ©ç”¨ç´¢å¼•è¿›è¡Œæ’åº12345-- ä¸èµ°ageç´¢å¼•SELECT * FROM t order by age; -- èµ°ageç´¢å¼•SELECT * FROM t where age &gt; 0 order by age; å¯¹äºä¸Šé¢çš„è¯­å¥ï¼Œæ•°æ®åº“çš„å¤„ç†é¡ºåºæ˜¯ï¼š ç¬¬ä¸€æ­¥ï¼šæ ¹æ®whereæ¡ä»¶å’Œç»Ÿè®¡ä¿¡æ¯ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œå¾—åˆ°æ•°æ®ã€‚ ç¬¬äºŒæ­¥ï¼šå°†å¾—åˆ°çš„æ•°æ®æ’åºã€‚å½“æ‰§è¡Œå¤„ç†æ•°æ®ï¼ˆorder byï¼‰æ—¶ï¼Œæ•°æ®åº“ä¼šå…ˆæŸ¥çœ‹ç¬¬ä¸€æ­¥çš„æ‰§è¡Œè®¡åˆ’ï¼Œçœ‹order by çš„å­—æ®µæ˜¯å¦åœ¨æ‰§è¡Œè®¡åˆ’ä¸­åˆ©ç”¨äº†ç´¢å¼•ã€‚å¦‚æœæ˜¯ï¼Œåˆ™å¯ä»¥åˆ©ç”¨ç´¢å¼•é¡ºåºè€Œç›´æ¥å–å¾—å·²ç»æ’å¥½åºçš„æ•°æ®ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™é‡æ–°è¿›è¡Œæ’åºæ“ä½œã€‚ ç¬¬ä¸‰æ­¥ï¼šè¿”å›æ’åºåçš„æ•°æ®ã€‚ å½“order by ä¸­çš„å­—æ®µå‡ºç°åœ¨whereæ¡ä»¶ä¸­æ—¶ï¼Œæ‰ä¼šåˆ©ç”¨ç´¢å¼•è€Œä¸å†äºŒæ¬¡æ’åºï¼Œæ›´å‡†ç¡®çš„è¯´ï¼Œorder by ä¸­çš„å­—æ®µåœ¨æ‰§è¡Œè®¡åˆ’ä¸­åˆ©ç”¨äº†ç´¢å¼•æ—¶ï¼Œä¸ç”¨æ’åºæ“ä½œã€‚ è¿™ä¸ªç»“è®ºä¸ä»…å¯¹order byæœ‰æ•ˆï¼Œå¯¹å…¶ä»–éœ€è¦æ’åºçš„æ“ä½œä¹Ÿæœ‰æ•ˆã€‚æ¯”å¦‚group by ã€union ã€distinctç­‰ã€‚ 11. æ­£ç¡®ä½¿ç”¨hintä¼˜åŒ–è¯­å¥MySQLä¸­å¯ä»¥ä½¿ç”¨hintæŒ‡å®šä¼˜åŒ–å™¨åœ¨æ‰§è¡Œæ—¶é€‰æ‹©æˆ–å¿½ç•¥ç‰¹å®šçš„ç´¢å¼•ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œå¤„äºç‰ˆæœ¬å˜æ›´å¸¦æ¥çš„è¡¨ç»“æ„ç´¢å¼•å˜åŒ–ï¼Œæ›´å»ºè®®é¿å…ä½¿ç”¨hintï¼Œè€Œæ˜¯é€šè¿‡Analyze tableå¤šæ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€‚ä½†åœ¨ç‰¹å®šåœºåˆä¸‹ï¼ŒæŒ‡å®šhintå¯ä»¥æ’é™¤å…¶ä»–ç´¢å¼•å¹²æ‰°è€ŒæŒ‡å®šæ›´ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚ USE INDEX åœ¨ä½ æŸ¥è¯¢è¯­å¥ä¸­è¡¨åçš„åé¢ï¼Œæ·»åŠ  USE INDEX æ¥æä¾›å¸Œæœ› MySQL å»å‚è€ƒçš„ç´¢å¼•åˆ—è¡¨ï¼Œå°±å¯ä»¥è®© MySQL ä¸å†è€ƒè™‘å…¶ä»–å¯ç”¨çš„ç´¢å¼•ã€‚ä¾‹å­: SELECT col1 FROM table USE INDEX (mod_time, name)â€¦ IGNORE INDEX å¦‚æœåªæ˜¯å•çº¯çš„æƒ³è®© MySQL å¿½ç•¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨ IGNORE INDEX ä½œä¸º Hintã€‚ä¾‹å­: SELECT col1 FROM table IGNORE INDEX (priority) â€¦ FORCE INDEX ä¸ºå¼ºåˆ¶ MySQL ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„ç´¢å¼•ï¼Œå¯åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨FORCE INDEX ä½œä¸ºHintã€‚ä¾‹å­: SELECT col1 FROM table FORCE INDEX (mod_time) â€¦ åœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ•°æ®åº“ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†ææŸ¥è¯¢è¯­å¥ï¼Œå¹¶é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„ç´¢å¼•ã€‚ä½†æ˜¯å¾ˆå¤šæ—¶å€™ï¼Œæ•°æ®åº“ç³»ç»Ÿçš„æŸ¥è¯¢ä¼˜åŒ–å™¨å¹¶ä¸ä¸€å®šæ€»æ˜¯èƒ½ä½¿ç”¨æœ€ä¼˜ç´¢å¼•ã€‚å¦‚æœæˆ‘ä»¬çŸ¥é“å¦‚ä½•é€‰æ‹©ç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨FORCE INDEXå¼ºåˆ¶æŸ¥è¯¢ä½¿ç”¨æŒ‡å®šçš„ç´¢å¼•ã€‚ ä¾‹å¦‚ï¼š 1SELECT * FROM students FORCE INDEX (idx_class_id) WHERE class_id = 1 ORDER BY id DESC; äºŒã€SELECTè¯­å¥å…¶ä»–ä¼˜åŒ–**1. é¿å…å‡ºç°select **é¦–å…ˆï¼Œselect * æ“ä½œåœ¨ä»»ä½•ç±»å‹æ•°æ®åº“ä¸­éƒ½ä¸æ˜¯ä¸€ä¸ªå¥½çš„SQLç¼–å†™ä¹ æƒ¯ã€‚ ä½¿ç”¨select * å–å‡ºå…¨éƒ¨åˆ—ï¼Œä¼šè®©ä¼˜åŒ–å™¨æ— æ³•å®Œæˆç´¢å¼•è¦†ç›–æ‰«æè¿™ç±»ä¼˜åŒ–ï¼Œä¼šå½±å“ä¼˜åŒ–å™¨å¯¹æ‰§è¡Œè®¡åˆ’çš„é€‰æ‹©ï¼Œä¹Ÿä¼šå¢åŠ ç½‘ç»œå¸¦å®½æ¶ˆè€—ï¼Œæ›´ä¼šå¸¦æ¥é¢å¤–çš„I&#x2F;O,å†…å­˜å’ŒCPUæ¶ˆè€—ã€‚ å»ºè®®æå‡ºä¸šåŠ¡å®é™…éœ€è¦çš„åˆ—æ•°ï¼Œå°†æŒ‡å®šåˆ—åä»¥å–ä»£select *ã€‚ 2. é¿å…å‡ºç°ä¸ç¡®å®šç»“æœçš„å‡½æ•°ç‰¹å®šé’ˆå¯¹ä¸»ä»å¤åˆ¶è¿™ç±»ä¸šåŠ¡åœºæ™¯ã€‚ç”±äºåŸç†ä¸Šä»åº“å¤åˆ¶çš„æ˜¯ä¸»åº“æ‰§è¡Œçš„è¯­å¥ï¼Œä½¿ç”¨å¦‚now()ã€rand()ã€sysdate()ã€current_user()ç­‰ä¸ç¡®å®šç»“æœçš„å‡½æ•°å¾ˆå®¹æ˜“å¯¼è‡´ä¸»åº“ä¸ä»åº“ç›¸åº”çš„æ•°æ®ä¸ä¸€è‡´ã€‚å¦å¤–ä¸ç¡®å®šå€¼çš„å‡½æ•°,äº§ç”Ÿçš„SQLè¯­å¥æ— æ³•åˆ©ç”¨query cacheã€‚ 3.å¤šè¡¨å…³è”æŸ¥è¯¢æ—¶ï¼Œå°è¡¨åœ¨å‰ï¼Œå¤§è¡¨åœ¨åã€‚åœ¨MySQLä¸­ï¼Œæ‰§è¡Œ from åçš„è¡¨å…³è”æŸ¥è¯¢æ˜¯ä»å·¦å¾€å³æ‰§è¡Œçš„ï¼ˆOracleç›¸åï¼‰ï¼Œç¬¬ä¸€å¼ è¡¨ä¼šæ¶‰åŠåˆ°å…¨è¡¨æ‰«æï¼Œæ‰€ä»¥å°†å°è¡¨æ”¾åœ¨å‰é¢ï¼Œå…ˆæ‰«å°è¡¨ï¼Œæ‰«æå¿«æ•ˆç‡è¾ƒé«˜ï¼Œåœ¨æ‰«æåé¢çš„å¤§è¡¨ï¼Œæˆ–è®¸åªæ‰«æå¤§è¡¨çš„å‰100è¡Œå°±ç¬¦åˆè¿”å›æ¡ä»¶å¹¶returnäº†ã€‚ ä¾‹å¦‚ï¼šè¡¨1æœ‰50æ¡æ•°æ®ï¼Œè¡¨2æœ‰30äº¿æ¡æ•°æ®ï¼›å¦‚æœå…¨è¡¨æ‰«æè¡¨2ï¼Œä½ å“ï¼Œé‚£å°±å…ˆå»åƒä¸ªé¥­å†è¯´å§æ˜¯å§ã€‚ 4. ä½¿ç”¨è¡¨çš„åˆ«åå½“åœ¨SQLè¯­å¥ä¸­è¿æ¥å¤šä¸ªè¡¨æ—¶ï¼Œè¯·ä½¿ç”¨è¡¨çš„åˆ«åå¹¶æŠŠåˆ«åå‰ç¼€äºæ¯ä¸ªåˆ—åä¸Šã€‚è¿™æ ·å°±å¯ä»¥å‡å°‘è§£æçš„æ—¶é—´å¹¶å‡å°‘å“ªäº›å‹åˆ—åæ­§ä¹‰å¼•èµ·çš„è¯­æ³•é”™è¯¯ã€‚ 5. ç”¨whereå­—å¥æ›¿æ¢HAVINGå­—å¥é¿å…ä½¿ç”¨HAVINGå­—å¥ï¼Œå› ä¸ºHAVINGåªä¼šåœ¨æ£€ç´¢å‡ºæ‰€æœ‰è®°å½•ä¹‹åæ‰å¯¹ç»“æœé›†è¿›è¡Œè¿‡æ»¤ï¼Œè€Œwhereåˆ™æ˜¯åœ¨èšåˆå‰åˆ·é€‰è®°å½•ï¼Œå¦‚æœèƒ½é€šè¿‡whereå­—å¥é™åˆ¶è®°å½•çš„æ•°ç›®ï¼Œé‚£å°±èƒ½å‡å°‘è¿™æ–¹é¢çš„å¼€é”€ã€‚HAVINGä¸­çš„æ¡ä»¶ä¸€èˆ¬ç”¨äºèšåˆå‡½æ•°çš„è¿‡æ»¤ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåº”è¯¥å°†æ¡ä»¶å†™åœ¨whereå­—å¥ä¸­ã€‚ whereå’Œhavingçš„åŒºåˆ«ï¼šwhereåé¢ä¸èƒ½ä½¿ç”¨ç»„å‡½æ•° 6.è°ƒæ•´Whereå­—å¥ä¸­çš„è¿æ¥é¡ºåºMySQLé‡‡ç”¨ä»å·¦å¾€å³ï¼Œè‡ªä¸Šè€Œä¸‹çš„é¡ºåºè§£æwhereå­å¥ã€‚æ ¹æ®è¿™ä¸ªåŸç†ï¼Œåº”å°†è¿‡æ»¤æ•°æ®å¤šçš„æ¡ä»¶å¾€å‰æ”¾ï¼Œæœ€å¿«é€Ÿåº¦ç¼©å°ç»“æœé›†ã€‚ ä¸‰ã€å¢åˆ æ”¹ DML è¯­å¥ä¼˜åŒ–1. å¤§æ‰¹é‡æ’å…¥æ•°æ®å¦‚æœåŒæ—¶æ‰§è¡Œå¤§é‡çš„æ’å…¥ï¼Œå»ºè®®ä½¿ç”¨å¤šä¸ªå€¼çš„INSERTè¯­å¥(æ–¹æ³•äºŒ)ã€‚è¿™æ¯”ä½¿ç”¨åˆ†å¼€INSERTè¯­å¥å¿«ï¼ˆæ–¹æ³•ä¸€ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ‰¹é‡æ’å…¥æ•ˆç‡æœ‰å‡ å€çš„å·®åˆ«ã€‚ æ–¹æ³•ä¸€ï¼š 12345insert into T values(1,2); insert into T values(1,3); insert into T values(1,4); æ–¹æ³•äºŒï¼š 1Insert into T values(1,2),(1,3),(1,4); é€‰æ‹©åä¸€ç§æ–¹æ³•çš„åŸå› æœ‰ä¸‰ã€‚ å‡å°‘SQLè¯­å¥è§£æçš„æ“ä½œï¼ŒMySQLæ²¡æœ‰ç±»ä¼¼Oracleçš„share poolï¼Œé‡‡ç”¨æ–¹æ³•äºŒï¼Œåªéœ€è¦è§£æä¸€æ¬¡å°±èƒ½è¿›è¡Œæ•°æ®çš„æ’å…¥æ“ä½œï¼› åœ¨ç‰¹å®šåœºæ™¯å¯ä»¥å‡å°‘å¯¹DBè¿æ¥æ¬¡æ•° SQLè¯­å¥è¾ƒçŸ­ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“çš„IOã€‚ 2. é€‚å½“ä½¿ç”¨commité€‚å½“ä½¿ç”¨commitå¯ä»¥é‡Šæ”¾äº‹åŠ¡å ç”¨çš„èµ„æºè€Œå‡å°‘æ¶ˆè€—ï¼Œcommitåèƒ½é‡Šæ”¾çš„èµ„æºå¦‚ä¸‹ï¼š äº‹åŠ¡å ç”¨çš„undoæ•°æ®å—ï¼› äº‹åŠ¡åœ¨redo logä¸­è®°å½•çš„æ•°æ®å—ï¼› é‡Šæ”¾äº‹åŠ¡æ–½åŠ çš„ï¼Œå‡å°‘é”äº‰ç”¨å½±å“æ€§èƒ½ã€‚ç‰¹åˆ«æ˜¯åœ¨éœ€è¦ä½¿ç”¨deleteåˆ é™¤å¤§é‡æ•°æ®çš„æ—¶å€™ï¼Œå¿…é¡»åˆ†è§£åˆ é™¤é‡å¹¶å®šæœŸcommitã€‚ 3. é¿å…é‡å¤æŸ¥è¯¢æ›´æ–°çš„æ•°æ®é’ˆå¯¹ä¸šåŠ¡ä¸­ç»å¸¸å‡ºç°çš„æ›´æ–°è¡ŒåŒæ—¶åˆå¸Œæœ›è·å¾—æ”¹è¡Œä¿¡æ¯çš„éœ€æ±‚ï¼ŒMySQLå¹¶ä¸æ”¯æŒPostgreSQLé‚£æ ·çš„UPDATE RETURNINGè¯­æ³•ï¼Œåœ¨MySQLä¸­å¯ä»¥é€šè¿‡å˜é‡å®ç°ã€‚ ä¾‹å¦‚ï¼Œæ›´æ–°ä¸€è¡Œè®°å½•çš„æ—¶é—´æˆ³ï¼ŒåŒæ—¶å¸Œæœ›æŸ¥è¯¢å½“å‰è®°å½•ä¸­å­˜æ”¾çš„æ—¶é—´æˆ³æ˜¯ä»€ä¹ˆï¼Œç®€å•æ–¹æ³•å®ç°ï¼š 123Update t1 set time=now() where col1=1; Select time from t1 where id =1; ä½¿ç”¨å˜é‡ï¼Œå¯ä»¥é‡å†™ä¸ºä»¥ä¸‹æ–¹å¼ï¼š 123Update t1 set time=now () where col1=1 and @now: = now (); Select @now; å‰åäºŒè€…éƒ½éœ€è¦ä¸¤æ¬¡ç½‘ç»œæ¥å›ï¼Œä½†ä½¿ç”¨å˜é‡é¿å…äº†å†æ¬¡è®¿é—®æ•°æ®è¡¨ï¼Œç‰¹åˆ«æ˜¯å½“t1è¡¨æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œåè€…æ¯”å‰è€…å¿«å¾ˆå¤šã€‚ 4.æŸ¥è¯¢ä¼˜å…ˆè¿˜æ˜¯æ›´æ–°ï¼ˆinsertã€updateã€deleteï¼‰ä¼˜å…ˆMySQL è¿˜å…è®¸æ”¹å˜è¯­å¥è°ƒåº¦çš„ä¼˜å…ˆçº§ï¼Œå®ƒå¯ä»¥ä½¿æ¥è‡ªå¤šä¸ªå®¢æˆ·ç«¯çš„æŸ¥è¯¢æ›´å¥½åœ°åä½œï¼Œè¿™æ ·å•ä¸ªå®¢æˆ·ç«¯å°±ä¸ä¼šç”±äºé”å®šè€Œç­‰å¾…å¾ˆé•¿æ—¶é—´ã€‚æ”¹å˜ä¼˜å…ˆçº§è¿˜å¯ä»¥ç¡®ä¿ç‰¹å®šç±»å‹çš„æŸ¥è¯¢è¢«å¤„ç†å¾—æ›´å¿«ã€‚æˆ‘ä»¬é¦–å…ˆåº”è¯¥ç¡®å®šåº”ç”¨çš„ç±»å‹ï¼Œåˆ¤æ–­åº”ç”¨æ˜¯ä»¥æŸ¥è¯¢ä¸ºä¸»è¿˜æ˜¯ä»¥æ›´æ–°ä¸ºä¸»çš„ï¼Œæ˜¯ç¡®ä¿æŸ¥è¯¢æ•ˆç‡è¿˜æ˜¯ç¡®ä¿æ›´æ–°çš„æ•ˆç‡ï¼Œå†³å®šæ˜¯æŸ¥è¯¢ä¼˜å…ˆè¿˜æ˜¯æ›´æ–°ä¼˜å…ˆã€‚ ä¸‹é¢æˆ‘ä»¬æåˆ°çš„æ”¹å˜è°ƒåº¦ç­–ç•¥çš„æ–¹æ³•ä¸»è¦æ˜¯é’ˆå¯¹åªå­˜åœ¨è¡¨é”çš„å­˜å‚¨å¼•æ“ï¼Œæ¯”å¦‚ MyISAM ã€MEMROYã€MERGEï¼Œå¯¹äºInnodb å­˜å‚¨å¼•æ“ï¼Œè¯­å¥çš„æ‰§è¡Œæ˜¯ç”±è·å¾—è¡Œé”çš„é¡ºåºå†³å®šçš„ã€‚MySQL çš„é»˜è®¤çš„è°ƒåº¦ç­–ç•¥å¯ç”¨æ€»ç»“å¦‚ä¸‹ï¼š 1ï¼‰å†™å…¥æ“ä½œä¼˜å…ˆäºè¯»å–æ“ä½œã€‚ 2ï¼‰å¯¹æŸå¼ æ•°æ®è¡¨çš„å†™å…¥æ“ä½œæŸä¸€æ—¶åˆ»åªèƒ½å‘ç”Ÿä¸€æ¬¡ï¼Œå†™å…¥è¯·æ±‚æŒ‰ç…§å®ƒä»¬åˆ°è¾¾çš„æ¬¡åºæ¥å¤„ç†ã€‚ 3ï¼‰å¯¹æŸå¼ æ•°æ®è¡¨çš„å¤šä¸ªè¯»å–æ“ä½œå¯ä»¥åŒæ—¶åœ°è¿›è¡Œã€‚MySQL æä¾›äº†å‡ ä¸ªè¯­å¥è°ƒèŠ‚ç¬¦ï¼Œå…è®¸ä½ ä¿®æ”¹å®ƒçš„è°ƒåº¦ç­–ç•¥ï¼š LOW_PRIORITYå…³é”®å­—åº”ç”¨äºDELETEã€INSERTã€LOAD DATAã€REPLACEå’ŒUPDATEï¼› HIGH_PRIORITYå…³é”®å­—åº”ç”¨äºSELECTå’ŒINSERTè¯­å¥ï¼› DELAYEDå…³é”®å­—åº”ç”¨äºINSERTå’ŒREPLACEè¯­å¥ã€‚ å¦‚æœå†™å…¥æ“ä½œæ˜¯ä¸€ä¸ª LOW_PRIORITYï¼ˆä½ä¼˜å…ˆçº§ï¼‰è¯·æ±‚ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¸ä¼šè®¤ä¸ºå®ƒçš„ä¼˜å…ˆçº§é«˜äºè¯»å–æ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå†™å…¥è€…åœ¨ç­‰å¾…çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ªè¯»å–è€…åˆ°è¾¾äº†ï¼Œé‚£ä¹ˆå°±å…è®¸ç¬¬äºŒä¸ªè¯»å–è€…æ’åˆ°å†™å…¥è€…ä¹‹å‰ã€‚åªæœ‰åœ¨æ²¡æœ‰å…¶å®ƒçš„è¯»å–è€…çš„æ—¶å€™ï¼Œæ‰å…è®¸å†™å…¥è€…å¼€å§‹æ“ä½œã€‚è¿™ç§è°ƒåº¦ä¿®æ”¹å¯èƒ½å­˜åœ¨ LOW_PRIORITYå†™å…¥æ“ä½œæ°¸è¿œè¢«é˜»å¡çš„æƒ…å†µã€‚ SELECT æŸ¥è¯¢çš„HIGH_PRIORITYï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰å…³é”®å­—ä¹Ÿç±»ä¼¼ã€‚å®ƒå…è®¸SELECT æ’å…¥æ­£åœ¨ç­‰å¾…çš„å†™å…¥æ“ä½œä¹‹å‰ï¼Œå³ä½¿åœ¨æ­£å¸¸æƒ…å†µä¸‹å†™å…¥æ“ä½œçš„ä¼˜å…ˆçº§æ›´é«˜ã€‚å¦å¤–ä¸€ç§å½±å“æ˜¯ï¼Œé«˜ä¼˜å…ˆçº§çš„ SELECT åœ¨æ­£å¸¸çš„ SELECT è¯­å¥ä¹‹å‰æ‰§è¡Œï¼Œå› ä¸ºè¿™äº›è¯­å¥ä¼šè¢«å†™å…¥æ“ä½œé˜»å¡ã€‚å¦‚æœå¸Œæœ›æ‰€æœ‰æ”¯æŒLOW_PRIORITY é€‰é¡¹çš„è¯­å¥éƒ½é»˜è®¤åœ°æŒ‰ç…§ä½ä¼˜å…ˆçº§æ¥å¤„ç†ï¼Œé‚£ä¹ˆ è¯·ä½¿ç”¨â€“low-priority-updates é€‰é¡¹æ¥å¯åŠ¨æœåŠ¡å™¨ã€‚é€šè¿‡ä½¿ç”¨ INSERTHIGH_PRIORITY æ¥æŠŠ INSERT è¯­å¥æé«˜åˆ°æ­£å¸¸çš„å†™å…¥ä¼˜å…ˆçº§ï¼Œå¯ä»¥æ¶ˆé™¤è¯¥é€‰é¡¹å¯¹å•ä¸ªINSERTè¯­å¥çš„å½±å“ã€‚ å››ã€æŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–1. å¯¹äºå¤æ‚çš„æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨ä¸­é—´ä¸´æ—¶è¡¨ æš‚å­˜æ•°æ®2. ä¼˜åŒ–group byè¯­å¥é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQL ä¼šå¯¹GROUP BYåˆ†ç»„çš„æ‰€æœ‰å€¼è¿›è¡Œæ’åºï¼Œå¦‚ â€œGROUP BY col1ï¼Œcol2ï¼Œâ€¦.;â€ æŸ¥è¯¢çš„æ–¹æ³•å¦‚åŒåœ¨æŸ¥è¯¢ä¸­æŒ‡å®š â€œORDER BY col1ï¼Œcol2ï¼Œâ€¦;â€ å¦‚æœæ˜¾å¼åŒ…æ‹¬ä¸€ä¸ªåŒ…å«ç›¸åŒçš„åˆ—çš„ ORDER BYå­å¥ï¼ŒMySQL å¯ä»¥æ¯«ä¸å‡é€Ÿåœ°å¯¹å®ƒè¿›è¡Œä¼˜åŒ–ï¼Œå°½ç®¡ä»ç„¶è¿›è¡Œæ’åºã€‚ å› æ­¤ï¼Œå¦‚æœæŸ¥è¯¢åŒ…æ‹¬ GROUP BY ä½†ä½ å¹¶ä¸æƒ³å¯¹åˆ†ç»„çš„å€¼è¿›è¡Œæ’åºï¼Œä½ å¯ä»¥æŒ‡å®š ORDER BY NULLç¦æ­¢æ’åºã€‚ä¾‹å¦‚ï¼š 1SELECT col1, col2, COUNT(*) FROM table GROUP BY col1, col2 ORDER BY NULL ; 3. ä¼˜åŒ–joinè¯­å¥MySQLä¸­å¯ä»¥é€šè¿‡å­æŸ¥è¯¢æ¥ä½¿ç”¨ SELECT è¯­å¥æ¥åˆ›å»ºä¸€ä¸ªå•åˆ—çš„æŸ¥è¯¢ç»“æœï¼Œç„¶åæŠŠè¿™ä¸ªç»“æœä½œä¸ºè¿‡æ»¤æ¡ä»¶ç”¨åœ¨å¦ä¸€ä¸ªæŸ¥è¯¢ä¸­ã€‚ä½¿ç”¨å­æŸ¥è¯¢å¯ä»¥ä¸€æ¬¡æ€§çš„å®Œæˆå¾ˆå¤šé€»è¾‘ä¸Šéœ€è¦å¤šä¸ªæ­¥éª¤æ‰èƒ½å®Œæˆçš„ SQL æ“ä½œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…äº‹åŠ¡æˆ–è€…è¡¨é”æ­»ï¼Œå¹¶ä¸”å†™èµ·æ¥ä¹Ÿå¾ˆå®¹æ˜“ã€‚ä½†æ˜¯ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œå­æŸ¥è¯¢å¯ä»¥è¢«æ›´æœ‰æ•ˆç‡çš„è¿æ¥(JOIN)..æ›¿ä»£ã€‚ ä¾‹å­ï¼šå‡è®¾è¦å°†æ‰€æœ‰æ²¡æœ‰è®¢å•è®°å½•çš„ç”¨æˆ·å–å‡ºæ¥ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªæŸ¥è¯¢å®Œæˆï¼š 1SELECT col1 FROM customerinfo WHERE CustomerID NOT in (SELECT CustomerID FROM salesinfo ) å¦‚æœä½¿ç”¨è¿æ¥(JOIN).. æ¥å®Œæˆè¿™ä¸ªæŸ¥è¯¢å·¥ä½œï¼Œé€Ÿåº¦å°†ä¼šæœ‰æ‰€æå‡ã€‚å°¤å…¶æ˜¯å½“ salesinfoè¡¨ä¸­å¯¹ CustomerID å»ºæœ‰ç´¢å¼•çš„è¯ï¼Œæ€§èƒ½å°†ä¼šæ›´å¥½ï¼ŒæŸ¥è¯¢å¦‚ä¸‹ï¼š 123SELECT col1 FROM customerinfo LEFT JOIN salesinfoON customerinfo.CustomerID=salesinfo.CustomerID WHERE salesinfo.CustomerID IS NULL è¿æ¥(JOIN).. ä¹‹æ‰€ä»¥æ›´æœ‰æ•ˆç‡ä¸€äº›ï¼Œæ˜¯å› ä¸º MySQL ä¸éœ€è¦åœ¨å†…å­˜ä¸­åˆ›å»ºä¸´æ—¶è¡¨æ¥å®Œæˆè¿™ä¸ªé€»è¾‘ä¸Šçš„éœ€è¦ä¸¤ä¸ªæ­¥éª¤çš„æŸ¥è¯¢å·¥ä½œã€‚ 4. ä¼˜åŒ–unionæŸ¥è¯¢MySQLé€šè¿‡åˆ›å»ºå¹¶å¡«å……ä¸´æ—¶è¡¨çš„æ–¹å¼æ¥æ‰§è¡ŒunionæŸ¥è¯¢ã€‚é™¤éç¡®å®è¦æ¶ˆé™¤é‡å¤çš„è¡Œï¼Œå¦åˆ™å»ºè®®ä½¿ç”¨union allã€‚åŸå› åœ¨äºå¦‚æœæ²¡æœ‰allè¿™ä¸ªå…³é”®è¯ï¼ŒMySQLä¼šç»™ä¸´æ—¶è¡¨åŠ ä¸Šdistincté€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´å¯¹æ•´ä¸ªä¸´æ—¶è¡¨çš„æ•°æ®åšå”¯ä¸€æ€§æ ¡éªŒï¼Œè¿™æ ·åšçš„æ¶ˆè€—ç›¸å½“é«˜ã€‚ é«˜æ•ˆï¼š 12345SELECT COL1, COL2, COL3 FROM TABLE WHERE COL1 = 10 UNION ALL SELECT COL1, COL2, COL3 FROM TABLE WHERE COL3= &#x27;TEST&#x27;; ä½æ•ˆï¼š 12345SELECT COL1, COL2, COL3 FROM TABLE WHERE COL1 = 10 UNION SELECT COL1, COL2, COL3 FROM TABLE WHERE COL3= &#x27;TEST&#x27;; 5.æ‹†åˆ†å¤æ‚SQLä¸ºå¤šä¸ªå°SQLï¼Œé¿å…å¤§äº‹åŠ¡ ç®€å•çš„SQLå®¹æ˜“ä½¿ç”¨åˆ°MySQLçš„QUERY CACHEï¼› å‡å°‘é”è¡¨æ—¶é—´ç‰¹åˆ«æ˜¯ä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„è¡¨ï¼› å¯ä»¥ä½¿ç”¨å¤šæ ¸CPUã€‚ 6. ä½¿ç”¨truncateä»£æ›¿deleteå½“åˆ é™¤å…¨è¡¨ä¸­è®°å½•æ—¶ï¼Œä½¿ç”¨deleteè¯­å¥çš„æ“ä½œä¼šè¢«è®°å½•åˆ°undoå—ä¸­ï¼Œåˆ é™¤è®°å½•ä¹Ÿè®°å½•binlogï¼Œå½“ç¡®è®¤éœ€è¦åˆ é™¤å…¨è¡¨æ—¶ï¼Œä¼šäº§ç”Ÿå¾ˆå¤§é‡çš„binlogå¹¶å ç”¨å¤§é‡çš„undoæ•°æ®å—ï¼Œæ­¤æ—¶æ—¢æ²¡æœ‰å¾ˆå¥½çš„æ•ˆç‡ä¹Ÿå ç”¨äº†å¤§é‡çš„èµ„æºã€‚ ä½¿ç”¨truncateæ›¿ä»£ï¼Œä¸ä¼šè®°å½•å¯æ¢å¤çš„ä¿¡æ¯ï¼Œæ•°æ®ä¸èƒ½è¢«æ¢å¤ã€‚ä¹Ÿå› æ­¤ä½¿ç”¨truncateæ“ä½œæœ‰å…¶æå°‘çš„èµ„æºå ç”¨ä¸æå¿«çš„æ—¶é—´ã€‚å¦å¤–ï¼Œä½¿ç”¨truncateå¯ä»¥å›æ”¶è¡¨çš„æ°´ä½ï¼Œä½¿è‡ªå¢å­—æ®µå€¼å½’é›¶ã€‚ 7. ä½¿ç”¨åˆç†çš„åˆ†é¡µæ–¹å¼ä»¥æé«˜åˆ†é¡µæ•ˆç‡ä½¿ç”¨åˆç†çš„åˆ†é¡µæ–¹å¼ä»¥æé«˜åˆ†é¡µæ•ˆç‡ é’ˆå¯¹å±•ç°ç­‰åˆ†é¡µéœ€æ±‚ï¼Œåˆé€‚çš„åˆ†é¡µæ–¹å¼èƒ½å¤Ÿæé«˜åˆ†é¡µçš„æ•ˆç‡ã€‚ æ¡ˆä¾‹1ï¼š 12select * from t where thread_id = 10000 and deleted = 0 order by gmt_create asc limit 0, 15; ä¸Šè¿°ä¾‹å­é€šè¿‡ä¸€æ¬¡æ€§æ ¹æ®è¿‡æ»¤æ¡ä»¶å–å‡ºæ‰€æœ‰å­—æ®µè¿›è¡Œæ’åºè¿”å›ã€‚æ•°æ®è®¿é—®å¼€é”€&#x3D;ç´¢å¼•IO+ç´¢å¼•å…¨éƒ¨è®°å½•ç»“æœå¯¹åº”çš„è¡¨æ•°æ®IOã€‚å› æ­¤ï¼Œè¯¥ç§å†™æ³•è¶Šç¿»åˆ°åé¢æ‰§è¡Œæ•ˆç‡è¶Šå·®ï¼Œæ—¶é—´è¶Šé•¿ï¼Œå°¤å…¶è¡¨æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ã€‚ é€‚ç”¨åœºæ™¯ï¼šå½“ä¸­é—´ç»“æœé›†å¾ˆå°ï¼ˆ10000è¡Œä»¥ä¸‹ï¼‰æˆ–è€…æŸ¥è¯¢æ¡ä»¶å¤æ‚ï¼ˆæŒ‡æ¶‰åŠå¤šä¸ªä¸åŒæŸ¥è¯¢å­—æ®µæˆ–è€…å¤šè¡¨è¿æ¥ï¼‰æ—¶é€‚ç”¨ã€‚ æ¡ˆä¾‹2ï¼š 123select t.* from (select id from t where thread_id = 10000 and deleted = 0 order by gmt_create asc limit 0, 15) a, t where a.id = t.id; ä¸Šè¿°ä¾‹å­å¿…é¡»æ»¡è¶³tè¡¨ä¸»é”®æ˜¯idåˆ—ï¼Œä¸”æœ‰è¦†ç›–ç´¢å¼•secondary key:(thread_id, deleted, gmt_create)ã€‚é€šè¿‡å…ˆæ ¹æ®è¿‡æ»¤æ¡ä»¶åˆ©ç”¨è¦†ç›–ç´¢å¼•å–å‡ºä¸»é”®idè¿›è¡Œæ’åºï¼Œå†è¿›è¡Œjoinæ“ä½œå–å‡ºå…¶ä»–å­—æ®µã€‚æ•°æ®è®¿é—®å¼€é”€&#x3D;ç´¢å¼•IO+ç´¢å¼•åˆ†é¡µåç»“æœï¼ˆä¾‹å­ä¸­æ˜¯15è¡Œï¼‰å¯¹åº”çš„è¡¨æ•°æ®IOã€‚å› æ­¤ï¼Œè¯¥å†™æ³•æ¯æ¬¡ç¿»é¡µæ¶ˆè€—çš„èµ„æºå’Œæ—¶é—´éƒ½åŸºæœ¬ç›¸åŒï¼Œå°±åƒç¿»ç¬¬ä¸€é¡µä¸€æ ·ã€‚ é€‚ç”¨åœºæ™¯ï¼šå½“æŸ¥è¯¢å’Œæ’åºå­—æ®µï¼ˆå³whereå­å¥å’Œorder byå­å¥æ¶‰åŠçš„å­—æ®µï¼‰æœ‰å¯¹åº”è¦†ç›–ç´¢å¼•æ—¶ï¼Œä¸”ä¸­é—´ç»“æœé›†å¾ˆå¤§çš„æƒ…å†µæ—¶é€‚ç”¨ã€‚ äº”ã€å»ºè¡¨ä¼˜åŒ–1. åœ¨è¡¨ä¸­å»ºç«‹ç´¢å¼•ï¼Œä¼˜å…ˆè€ƒè™‘whereã€order byä½¿ç”¨åˆ°çš„å­—æ®µã€‚2. å°½é‡ä½¿ç”¨æ•°å­—å‹å­—æ®µï¼ˆå¦‚æ€§åˆ«ï¼Œç”·ï¼š1 å¥³ï¼š2ï¼‰ï¼Œè‹¥åªå«æ•°å€¼ä¿¡æ¯çš„å­—æ®µå°½é‡ä¸è¦è®¾è®¡ä¸ºå­—ç¬¦å‹ï¼Œè¿™ä¼šé™ä½æŸ¥è¯¢å’Œè¿æ¥çš„æ€§èƒ½ï¼Œå¹¶ä¼šå¢åŠ å­˜å‚¨å¼€é”€ã€‚ è¿™æ˜¯å› ä¸ºå¼•æ“åœ¨å¤„ç†æŸ¥è¯¢å’Œè¿æ¥æ—¶ä¼š é€ä¸ªæ¯”è¾ƒå­—ç¬¦ä¸²ä¸­æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œè€Œå¯¹äºæ•°å­—å‹è€Œè¨€åªéœ€è¦æ¯”è¾ƒä¸€æ¬¡å°±å¤Ÿäº†ã€‚ 3. æŸ¥è¯¢æ•°æ®é‡å¤§çš„è¡¨ ä¼šé€ æˆæŸ¥è¯¢ç¼“æ…¢ã€‚ä¸»è¦çš„åŸå› æ˜¯æ‰«æè¡Œæ•°è¿‡å¤šã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡ç¨‹åºï¼Œåˆ†æ®µåˆ†é¡µè¿›è¡ŒæŸ¥è¯¢ï¼Œå¾ªç¯éå†ï¼Œå°†ç»“æœåˆå¹¶å¤„ç†è¿›è¡Œå±•ç¤ºã€‚è¦æŸ¥è¯¢100000åˆ°100050çš„æ•°æ®ï¼Œå¦‚ä¸‹ï¼š 12SELECT * FROM (SELECT ROW_NUMBER() OVER(ORDER BY ID ASC) AS rowid,* FROM infoTab)t WHERE t.rowid &gt; 100000 AND t.rowid &lt;= 100050 4. ç”¨varchar&#x2F;nvarchar ä»£æ›¿ char&#x2F;ncharå°½å¯èƒ½çš„ä½¿ç”¨ varchar&#x2F;nvarchar ä»£æ›¿ char&#x2F;nchar ï¼Œå› ä¸ºé¦–å…ˆå˜é•¿å­—æ®µå­˜å‚¨ç©ºé—´å°ï¼Œå¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œå…¶æ¬¡å¯¹äºæŸ¥è¯¢æ¥è¯´ï¼Œåœ¨ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„å­—æ®µå†…æœç´¢æ•ˆç‡æ˜¾ç„¶è¦é«˜äº›ã€‚ ä¸è¦ä»¥ä¸º NULL ä¸éœ€è¦ç©ºé—´ï¼Œæ¯”å¦‚ï¼šchar(100) å‹ï¼Œåœ¨å­—æ®µå»ºç«‹æ—¶ï¼Œç©ºé—´å°±å›ºå®šäº†ï¼Œ ä¸ç®¡æ˜¯å¦æ’å…¥å€¼ï¼ˆNULLä¹ŸåŒ…å«åœ¨å†…ï¼‰ï¼Œéƒ½æ˜¯å ç”¨ 100ä¸ªå­—ç¬¦çš„ç©ºé—´çš„ï¼Œå¦‚æœæ˜¯varcharè¿™æ ·çš„å˜é•¿å­—æ®µï¼Œ null ä¸å ç”¨ç©ºé—´ã€‚","tags":["MySQL","DataBase","SQLä¼˜åŒ–"],"categories":["DataBase"]},{"title":"TCP/IPç®€è¿°","path":"/2023/12/25/TCP-IPç®€è¿°/","content":"ä¸€ã€TCP&#x2F;IPæ¨¡å‹TCP&#x2F;IPåè®®æ¨¡å‹ï¼ˆTransmission Control Protocol&#x2F;Internet Protocolï¼‰ï¼ŒåŒ…å«äº†ä¸€ç³»åˆ—æ„æˆäº’è”ç½‘åŸºç¡€çš„ç½‘ç»œåè®®ï¼Œæ˜¯Internetçš„æ ¸å¿ƒåè®®ã€‚ åŸºäºTCP&#x2F;IPçš„å‚è€ƒæ¨¡å‹å°†åè®®åˆ†æˆå››ä¸ªå±‚æ¬¡ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯é“¾è·¯å±‚ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚å’Œåº”ç”¨å±‚ã€‚ä¸‹å›¾è¡¨ç¤ºTCP&#x2F;IPæ¨¡å‹ä¸OSIæ¨¡å‹å„å±‚çš„å¯¹ç…§å…³ç³»ã€‚ TCP&#x2F;IPåè®®æ—æŒ‰ç…§å±‚æ¬¡ç”±ä¸Šåˆ°ä¸‹ï¼Œå±‚å±‚åŒ…è£…ã€‚æœ€ä¸Šé¢çš„æ˜¯åº”ç”¨å±‚ï¼Œè¿™é‡Œé¢æœ‰httpï¼Œftp ç­‰ç­‰æˆ‘ä»¬ç†Ÿæ‚‰çš„åè®®ã€‚è€Œç¬¬äºŒå±‚åˆ™æ˜¯ä¼ è¾“å±‚ï¼Œè‘—åçš„TCPå’ŒUDPåè®®å°±åœ¨è¿™ä¸ªå±‚æ¬¡ã€‚ç¬¬ä¸‰å±‚æ˜¯ç½‘ç»œå±‚ï¼ŒIPåè®®å°±åœ¨è¿™é‡Œï¼Œå®ƒè´Ÿè´£å¯¹æ•°æ®åŠ ä¸ŠIPåœ°å€å’Œå…¶ä»–çš„æ•°æ®ä»¥ç¡®å®šä¼ è¾“çš„ç›®æ ‡ã€‚ç¬¬å››å±‚æ˜¯æ•°æ®é“¾è·¯å±‚ï¼Œè¿™ä¸ªå±‚æ¬¡ä¸ºå¾…ä¼ é€çš„æ•°æ®åŠ å…¥ä¸€ä¸ªä»¥å¤ªç½‘åè®®å¤´ï¼Œå¹¶è¿›è¡ŒCRCç¼–ç ï¼Œä¸ºæœ€åçš„æ•°æ®ä¼ è¾“åšå‡†å¤‡ã€‚ ä¸Šå›¾æ¸…æ¥šåœ°è¡¨ç¤ºäº†TCP&#x2F;IPåè®®ä¸­æ¯ä¸ªå±‚çš„ä½œç”¨ï¼Œè€ŒTCP&#x2F;IPåè®®é€šä¿¡çš„è¿‡ç¨‹å…¶å®å°±å¯¹åº”ç€æ•°æ®å…¥æ ˆä¸å‡ºæ ˆçš„è¿‡ç¨‹ã€‚å…¥æ ˆçš„è¿‡ç¨‹ï¼Œæ•°æ®å‘é€æ–¹æ¯å±‚ä¸æ–­åœ°å°è£…é¦–éƒ¨ä¸å°¾éƒ¨ï¼Œæ·»åŠ ä¸€äº›ä¼ è¾“çš„ä¿¡æ¯ï¼Œç¡®ä¿èƒ½ä¼ è¾“åˆ°ç›®çš„åœ°ã€‚å‡ºæ ˆçš„è¿‡ç¨‹ï¼Œæ•°æ®æ¥æ”¶æ–¹æ¯å±‚ä¸æ–­åœ°æ‹†é™¤é¦–éƒ¨ä¸å°¾éƒ¨ï¼Œå¾—åˆ°æœ€ç»ˆä¼ è¾“çš„æ•°æ®ã€‚ ä¸Šå›¾ä»¥HTTPåè®®ä¸ºä¾‹ï¼Œå…·ä½“è¯´æ˜ã€‚ äºŒã€æ•°æ®é“¾è·¯å±‚ç‰©ç†å±‚è´Ÿè´£0ã€1æ¯”ç‰¹æµä¸ç‰©ç†è®¾å¤‡ç”µå‹é«˜ä½ã€å…‰çš„é—ªç­ä¹‹é—´çš„äº’æ¢ã€‚æ•°æ®é“¾è·¯å±‚è´Ÿè´£å°†0ã€1åºåˆ—åˆ’åˆ†ä¸ºæ•°æ®å¸§ä»ä¸€ä¸ªèŠ‚ç‚¹ä¼ è¾“åˆ°ä¸´è¿‘çš„å¦ä¸€ä¸ªèŠ‚ç‚¹,è¿™äº›èŠ‚ç‚¹æ˜¯é€šè¿‡MACæ¥å”¯ä¸€æ ‡è¯†çš„(MAC,ç‰©ç†åœ°å€ï¼Œä¸€ä¸ªä¸»æœºä¼šæœ‰ä¸€ä¸ªMACåœ°å€)ã€‚ å°è£…æˆå¸§: æŠŠç½‘ç»œå±‚æ•°æ®æŠ¥åŠ å¤´å’Œå°¾ï¼Œå°è£…æˆå¸§,å¸§å¤´ä¸­åŒ…æ‹¬æºMACåœ°å€å’Œç›®çš„MACåœ°å€ã€‚ é€æ˜ä¼ è¾“: é›¶æ¯”ç‰¹å¡«å……ã€è½¬ä¹‰å­—ç¬¦ã€‚ å¯é ä¼ è¾“: åœ¨å‡ºé”™ç‡å¾ˆä½çš„é“¾è·¯ä¸Šå¾ˆå°‘ç”¨ï¼Œä½†æ˜¯æ— çº¿é“¾è·¯WLANä¼šä¿è¯å¯é ä¼ è¾“ã€‚ å·®é”™æ£€æµ‹(CRC): æ¥æ”¶è€…æ£€æµ‹é”™è¯¯,å¦‚æœå‘ç°å·®é”™ï¼Œä¸¢å¼ƒè¯¥å¸§ã€‚ ä¸‰ã€ç½‘ç»œå±‚1ã€IPåè®®IPåè®®æ˜¯TCP&#x2F;IPåè®®çš„æ ¸å¿ƒï¼Œæ‰€æœ‰çš„TCPï¼ŒUDPï¼ŒIMCPï¼ŒIGMPçš„æ•°æ®éƒ½ä»¥IPæ•°æ®æ ¼å¼ä¼ è¾“ã€‚è¦æ³¨æ„çš„æ˜¯ï¼ŒIPä¸æ˜¯å¯é çš„åè®®ï¼Œè¿™æ˜¯è¯´ï¼ŒIPåè®®æ²¡æœ‰æä¾›ä¸€ç§æ•°æ®æœªä¼ è¾¾ä»¥åçš„å¤„ç†æœºåˆ¶ï¼Œè¿™è¢«è®¤ä¸ºæ˜¯ä¸Šå±‚åè®®ï¼šTCPæˆ–UDPè¦åšçš„äº‹æƒ…ã€‚ 1.1 IPåœ°å€åœ¨æ•°æ®é“¾è·¯å±‚ä¸­æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡MACåœ°å€æ¥è¯†åˆ«ä¸åŒçš„èŠ‚ç‚¹ï¼Œè€Œåœ¨IPå±‚æˆ‘ä»¬ä¹Ÿè¦æœ‰ä¸€ä¸ªç±»ä¼¼çš„åœ°å€æ ‡è¯†ï¼Œè¿™å°±æ˜¯IPåœ°å€ã€‚ 32ä½IPåœ°å€åˆ†ä¸ºç½‘ç»œä½å’Œåœ°å€ä½ï¼Œè¿™æ ·åšå¯ä»¥å‡å°‘è·¯ç”±å™¨ä¸­è·¯ç”±è¡¨è®°å½•çš„æ•°ç›®ï¼Œæœ‰äº†ç½‘ç»œåœ°å€ï¼Œå°±å¯ä»¥é™å®šæ‹¥æœ‰ç›¸åŒç½‘ç»œåœ°å€çš„ç»ˆç«¯éƒ½åœ¨åŒä¸€ä¸ªèŒƒå›´å†…ï¼Œé‚£ä¹ˆè·¯ç”±è¡¨åªéœ€è¦ç»´æŠ¤ä¸€æ¡è¿™ä¸ªç½‘ç»œåœ°å€çš„æ–¹å‘ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç›¸åº”çš„è¿™äº›ç»ˆç«¯äº†ã€‚ Aç±»IPåœ°å€: 0.0.0.0127.0.0.0Bç±»IPåœ°å€:128.0.0.1191.255.0.0Cç±»IPåœ°å€:192.168.0.0~239.255.255.0 1.2 IPåè®®å¤´ è¿™é‡Œåªä»‹ç»:å…«ä½çš„TTLå­—æ®µã€‚è¿™ä¸ªå­—æ®µè§„å®šè¯¥æ•°æ®åŒ…åœ¨ç©¿è¿‡å¤šå°‘ä¸ªè·¯ç”±ä¹‹åæ‰ä¼šè¢«æŠ›å¼ƒã€‚æŸä¸ªIPæ•°æ®åŒ…æ¯ç©¿è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼Œè¯¥æ•°æ®åŒ…çš„TTLæ•°å€¼å°±ä¼šå‡å°‘1ï¼Œå½“è¯¥æ•°æ®åŒ…çš„TTLæˆä¸ºé›¶ï¼Œå®ƒå°±ä¼šè¢«è‡ªåŠ¨æŠ›å¼ƒã€‚ è¿™ä¸ªå­—æ®µçš„æœ€å¤§å€¼ä¹Ÿå°±æ˜¯255ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªåè®®åŒ…ä¹Ÿå°±åœ¨è·¯ç”±å™¨é‡Œé¢ç©¿è¡Œ255æ¬¡å°±ä¼šè¢«æŠ›å¼ƒäº†ï¼Œæ ¹æ®ç³»ç»Ÿçš„ä¸åŒï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿä¸ä¸€æ ·ï¼Œä¸€èˆ¬æ˜¯32æˆ–è€…æ˜¯64ã€‚ 2ã€ARPåŠRARPåè®®ARP æ˜¯æ ¹æ®IPåœ°å€è·å–MACåœ°å€çš„ä¸€ç§åè®®ã€‚ ARPï¼ˆåœ°å€è§£æï¼‰åè®®æ˜¯ä¸€ç§è§£æåè®®ï¼Œæœ¬æ¥ä¸»æœºæ˜¯å®Œå…¨ä¸çŸ¥é“è¿™ä¸ªIPå¯¹åº”çš„æ˜¯å“ªä¸ªä¸»æœºçš„å“ªä¸ªæ¥å£ï¼Œå½“ä¸»æœºè¦å‘é€ä¸€ä¸ªIPåŒ…çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆæŸ¥ä¸€ä¸‹è‡ªå·±çš„ARPé«˜é€Ÿç¼“å­˜ï¼ˆå°±æ˜¯ä¸€ä¸ªIP-MACåœ°å€å¯¹åº”è¡¨ç¼“å­˜ï¼‰ã€‚ å¦‚æœæŸ¥è¯¢çš„IPï¼MACå€¼å¯¹ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆä¸»æœºå°±å‘ç½‘ç»œå‘é€ä¸€ä¸ªARPåè®®å¹¿æ’­åŒ…ï¼Œè¿™ä¸ªå¹¿æ’­åŒ…é‡Œé¢å°±æœ‰å¾…æŸ¥è¯¢çš„IPåœ°å€ï¼Œè€Œç›´æ¥æ”¶åˆ°è¿™ä»½å¹¿æ’­çš„åŒ…çš„æ‰€æœ‰ä¸»æœºéƒ½ä¼šæŸ¥è¯¢è‡ªå·±çš„IPåœ°å€ï¼Œå¦‚æœæ”¶åˆ°å¹¿æ’­åŒ…çš„æŸä¸€ä¸ªä¸»æœºå‘ç°è‡ªå·±ç¬¦åˆæ¡ä»¶ï¼Œé‚£ä¹ˆå°±å‡†å¤‡å¥½ä¸€ä¸ªåŒ…å«è‡ªå·±çš„MACåœ°å€çš„ARPåŒ…ä¼ é€ç»™å‘é€ARPå¹¿æ’­çš„ä¸»æœºã€‚ è€Œå¹¿æ’­ä¸»æœºæ‹¿åˆ°ARPåŒ…åä¼šæ›´æ–°è‡ªå·±çš„ARPç¼“å­˜ï¼ˆå°±æ˜¯å­˜æ”¾IP-MACå¯¹åº”è¡¨çš„åœ°æ–¹ï¼‰ã€‚å‘é€å¹¿æ’­çš„ä¸»æœºå°±ä¼šç”¨æ–°çš„ARPç¼“å­˜æ•°æ®å‡†å¤‡å¥½æ•°æ®é“¾è·¯å±‚çš„çš„æ•°æ®åŒ…å‘é€å·¥ä½œã€‚ RARPåè®®çš„å·¥ä½œä¸æ­¤ç›¸åï¼Œä¸åšèµ˜è¿°ã€‚ 3ã€ICMPåè®®IPåè®®å¹¶ä¸æ˜¯ä¸€ä¸ªå¯é çš„åè®®ï¼Œå®ƒä¸ä¿è¯æ•°æ®è¢«é€è¾¾ï¼Œé‚£ä¹ˆï¼Œè‡ªç„¶çš„ï¼Œä¿è¯æ•°æ®é€è¾¾çš„å·¥ä½œåº”è¯¥ç”±å…¶ä»–çš„æ¨¡å—æ¥å®Œæˆã€‚å…¶ä¸­ä¸€ä¸ªé‡è¦çš„æ¨¡å—å°±æ˜¯ICMP(ç½‘ç»œæ§åˆ¶æŠ¥æ–‡)åè®®ã€‚ICMPä¸æ˜¯é«˜å±‚åè®®ï¼Œè€Œæ˜¯IPå±‚çš„åè®®ã€‚ å½“ä¼ é€IPæ•°æ®åŒ…å‘ç”Ÿé”™è¯¯ã€‚æ¯”å¦‚ä¸»æœºä¸å¯è¾¾ï¼Œè·¯ç”±ä¸å¯è¾¾ç­‰ç­‰ï¼ŒICMPåè®®å°†ä¼šæŠŠé”™è¯¯ä¿¡æ¯å°åŒ…ï¼Œç„¶åä¼ é€å›ç»™ä¸»æœºã€‚ç»™ä¸»æœºä¸€ä¸ªå¤„ç†é”™è¯¯çš„æœºä¼šï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´å»ºç«‹åœ¨IPå±‚ä»¥ä¸Šçš„åè®®æ˜¯å¯èƒ½åšåˆ°å®‰å…¨çš„åŸå› ã€‚ å››ã€pingpingå¯ä»¥è¯´æ˜¯ICMPçš„æœ€è‘—åçš„åº”ç”¨ï¼Œæ˜¯TCP&#x2F;IPåè®®çš„ä¸€éƒ¨åˆ†ã€‚åˆ©ç”¨â€œpingâ€å‘½ä»¤å¯ä»¥æ£€æŸ¥ç½‘ç»œæ˜¯å¦è¿é€šï¼Œå¯ä»¥å¾ˆå¥½åœ°å¸®åŠ©æˆ‘ä»¬åˆ†æå’Œåˆ¤å®šç½‘ç»œæ•…éšœã€‚ ä¾‹å¦‚ï¼šå½“æˆ‘ä»¬æŸä¸€ä¸ªç½‘ç«™ä¸Šä¸å»çš„æ—¶å€™ã€‚é€šå¸¸ä¼špingä¸€ä¸‹è¿™ä¸ªç½‘ç«™ã€‚pingä¼šå›æ˜¾å‡ºä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚ä¸€èˆ¬çš„ä¿¡æ¯å¦‚ä¸‹: pingè¿™ä¸ªå•è¯æºè‡ªå£°çº³å®šä½ï¼Œè€Œè¿™ä¸ªç¨‹åºçš„ä½œç”¨ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå®ƒåˆ©ç”¨ICMPåè®®åŒ…æ¥ä¾¦æµ‹å¦ä¸€ä¸ªä¸»æœºæ˜¯å¦å¯è¾¾ã€‚åŸç†æ˜¯ç”¨ç±»å‹ç ä¸º0çš„ICMPå‘è¯·æ±‚ï¼Œå—åˆ°è¯·æ±‚çš„ä¸»æœºåˆ™ç”¨ç±»å‹ç ä¸º8çš„ICMPå›åº”ã€‚ äº”ã€TracerouteTracerouteæ˜¯ç”¨æ¥ä¾¦æµ‹ä¸»æœºåˆ°ç›®çš„ä¸»æœºä¹‹é—´æ‰€ç»è·¯ç”±æƒ…å†µçš„é‡è¦å·¥å…·ï¼Œä¹Ÿæ˜¯æœ€ä¾¿åˆ©çš„å·¥å…·ã€‚ Tracerouteçš„åŸç†æ˜¯éå¸¸éå¸¸çš„æœ‰æ„æ€ï¼Œå®ƒæ”¶åˆ°åˆ°ç›®çš„ä¸»æœºçš„IPåï¼Œé¦–å…ˆç»™ç›®çš„ä¸»æœºå‘é€ä¸€ä¸ªTTL&#x3D;1çš„UDPæ•°æ®åŒ…ï¼Œè€Œç»è¿‡çš„ç¬¬ä¸€ä¸ªè·¯ç”±å™¨æ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…ä»¥åï¼Œå°±è‡ªåŠ¨æŠŠTTLå‡1ï¼Œè€ŒTTLå˜ä¸º0ä»¥åï¼Œè·¯ç”±å™¨å°±æŠŠè¿™ä¸ªåŒ…ç»™æŠ›å¼ƒäº†ï¼Œå¹¶åŒæ—¶äº§ç”Ÿ ä¸€ä¸ªä¸»æœºä¸å¯è¾¾çš„ICMPæ•°æ®æŠ¥ç»™ä¸»æœºã€‚ä¸»æœºæ”¶åˆ°è¿™ä¸ªæ•°æ®æŠ¥ä»¥åå†å‘ä¸€ä¸ªTTL&#x3D;2çš„UDPæ•°æ®æŠ¥ç»™ç›®çš„ä¸»æœºï¼Œç„¶ååˆºæ¿€ç¬¬äºŒä¸ªè·¯ç”±å™¨ç»™ä¸»æœºå‘ICMPæ•°æ® æŠ¥ã€‚å¦‚æ­¤å¾€å¤ç›´åˆ°åˆ°è¾¾ç›®çš„ä¸»æœºã€‚è¿™æ ·ï¼Œtracerouteå°±æ‹¿åˆ°äº†æ‰€æœ‰çš„è·¯ç”±å™¨IPã€‚ å…­ã€TCP&#x2F;UDPTCP&#x2F;UDPéƒ½æ˜¯æ˜¯ä¼ è¾“å±‚åè®®ï¼Œä½†æ˜¯ä¸¤è€…å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿå…·æœ‰ä¸åŒçš„åº”ç”¨åœºæ™¯ï¼Œä¸‹é¢ä»¥å›¾è¡¨çš„å½¢å¼å¯¹æ¯”åˆ†æã€‚ é¢å‘æŠ¥æ–‡ é¢å‘æŠ¥æ–‡çš„ä¼ è¾“æ–¹å¼æ˜¯åº”ç”¨å±‚äº¤ç»™UDPå¤šé•¿çš„æŠ¥æ–‡ï¼ŒUDPå°±ç…§æ ·å‘é€ï¼Œå³ä¸€æ¬¡å‘é€ä¸€ä¸ªæŠ¥æ–‡ã€‚å› æ­¤ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»é€‰æ‹©åˆé€‚å¤§å°çš„æŠ¥æ–‡ã€‚è‹¥æŠ¥æ–‡å¤ªé•¿ï¼Œåˆ™IPå±‚éœ€è¦åˆ†ç‰‡ï¼Œé™ä½æ•ˆç‡ã€‚è‹¥å¤ªçŸ­ï¼Œä¼šæ˜¯IPå¤ªå°ã€‚ é¢å‘å­—èŠ‚æµ é¢å‘å­—èŠ‚æµçš„è¯ï¼Œè™½ç„¶åº”ç”¨ç¨‹åºå’ŒTCPçš„äº¤äº’æ˜¯ä¸€æ¬¡ä¸€ä¸ªæ•°æ®å—ï¼ˆå¤§å°ä¸ç­‰ï¼‰ï¼Œä½†TCPæŠŠåº”ç”¨ç¨‹åºçœ‹æˆæ˜¯ä¸€è¿ä¸²çš„æ— ç»“æ„çš„å­—èŠ‚æµã€‚TCPæœ‰ä¸€ä¸ªç¼“å†²ï¼Œå½“åº”ç”¨ç¨‹åºä¼ é€çš„æ•°æ®å—å¤ªé•¿ï¼ŒTCPå°±å¯ä»¥æŠŠå®ƒåˆ’åˆ†çŸ­ä¸€äº›å†ä¼ é€ã€‚ å…³äºæ‹¥å¡æ§åˆ¶ï¼Œæµé‡æ§åˆ¶ï¼Œæ˜¯TCPçš„é‡ç‚¹ï¼Œåé¢è®²è§£ã€‚ TCPå’ŒUDPåè®®çš„ä¸€äº›åº”ç”¨ ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨TCPï¼Ÿ å½“å¯¹ç½‘ç»œé€šè®¯è´¨é‡æœ‰è¦æ±‚çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼šæ•´ä¸ªæ•°æ®è¦å‡†ç¡®æ— è¯¯çš„ä¼ é€’ç»™å¯¹æ–¹ï¼Œè¿™å¾€å¾€ç”¨äºä¸€äº›è¦æ±‚å¯é çš„åº”ç”¨ï¼Œæ¯”å¦‚HTTPã€HTTPSã€FTPç­‰ä¼ è¾“æ–‡ä»¶çš„åè®®ï¼ŒPOPã€SMTPç­‰é‚®ä»¶ä¼ è¾“çš„åè®®ã€‚ ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨UDPï¼Ÿ å½“å¯¹ç½‘ç»œé€šè®¯è´¨é‡è¦æ±‚ä¸é«˜çš„æ—¶å€™ï¼Œè¦æ±‚ç½‘ç»œé€šè®¯é€Ÿåº¦èƒ½å°½é‡çš„å¿«ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨UDPã€‚ ä¸ƒã€DNSDNSï¼ˆDomain Name Systemï¼ŒåŸŸåç³»ç»Ÿï¼‰ï¼Œå› ç‰¹ç½‘ä¸Šä½œä¸ºåŸŸåå’ŒIPåœ°å€ç›¸äº’æ˜ å°„çš„ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œèƒ½å¤Ÿä½¿ç”¨æˆ·æ›´æ–¹ä¾¿çš„è®¿é—®äº’è”ç½‘ï¼Œè€Œä¸ç”¨å»è®°ä½èƒ½å¤Ÿè¢«æœºå™¨ç›´æ¥è¯»å–çš„IPæ•°ä¸²ã€‚é€šè¿‡ä¸»æœºåï¼Œæœ€ç»ˆå¾—åˆ°è¯¥ä¸»æœºåå¯¹åº”çš„IPåœ°å€çš„è¿‡ç¨‹å«åšåŸŸåè§£æï¼ˆæˆ–ä¸»æœºåè§£æï¼‰ã€‚DNSåè®®è¿è¡Œåœ¨UDPåè®®ä¹‹ä¸Šï¼Œä½¿ç”¨ç«¯å£å·53ã€‚ å…«ã€TCPè¿æ¥çš„å»ºç«‹ä¸ç»ˆæ­¢1ã€ä¸‰æ¬¡æ¡æ‰‹TCPæ˜¯é¢å‘è¿æ¥çš„ï¼Œæ— è®ºå“ªä¸€æ–¹å‘å¦ä¸€æ–¹å‘é€æ•°æ®ä¹‹å‰ï¼Œéƒ½å¿…é¡»å…ˆåœ¨åŒæ–¹ä¹‹é—´å»ºç«‹ä¸€æ¡è¿æ¥ã€‚åœ¨TCP&#x2F;IPåè®®ä¸­ï¼ŒTCPåè®®æä¾›å¯é çš„è¿æ¥æœåŠ¡ï¼Œè¿æ¥æ˜¯é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹è¿›è¡Œåˆå§‹åŒ–çš„ã€‚ä¸‰æ¬¡æ¡æ‰‹çš„ç›®çš„æ˜¯åŒæ­¥è¿æ¥åŒæ–¹çš„åºåˆ—å·å’Œç¡®è®¤å·å¹¶äº¤æ¢ TCPçª—å£å¤§å°ä¿¡æ¯ã€‚ ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå»ºç«‹è¿æ¥ã€‚å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µï¼Œå°†SYNä½ç½®ä¸º1ï¼ŒSequence Numberä¸ºxï¼›ç„¶åï¼Œå®¢æˆ·ç«¯è¿›å…¥SYN_SENDçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ï¼› ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨æ”¶åˆ°SYNæŠ¥æ–‡æ®µã€‚æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„SYNæŠ¥æ–‡æ®µï¼Œéœ€è¦å¯¹è¿™ä¸ªSYNæŠ¥æ–‡æ®µè¿›è¡Œç¡®è®¤ï¼Œè®¾ç½®Acknowledgment Numberä¸ºx+1(Sequence Number+1)ï¼›åŒæ—¶ï¼Œè‡ªå·±è‡ªå·±è¿˜è¦å‘é€SYNè¯·æ±‚ä¿¡æ¯ï¼Œå°†SYNä½ç½®ä¸º1ï¼ŒSequence Numberä¸ºyï¼›æœåŠ¡å™¨ç«¯å°†ä¸Šè¿°æ‰€æœ‰ä¿¡æ¯æ”¾åˆ°ä¸€ä¸ªæŠ¥æ–‡æ®µï¼ˆå³SYN+ACKæŠ¥æ–‡æ®µï¼‰ä¸­ï¼Œä¸€å¹¶å‘é€ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶æœåŠ¡å™¨è¿›å…¥SYN_RECVçŠ¶æ€ï¼› ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„SYN+ACKæŠ¥æ–‡æ®µã€‚ç„¶åå°†Acknowledgment Numberè®¾ç½®ä¸ºy+1ï¼Œå‘æœåŠ¡å™¨å‘é€ACKæŠ¥æ–‡æ®µï¼Œè¿™ä¸ªæŠ¥æ–‡æ®µå‘é€å®Œæ¯•ä»¥åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½è¿›å…¥ESTABLISHEDçŠ¶æ€ï¼Œå®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹ã€‚ ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ ä¸ºäº†é˜²æ­¢å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µçªç„¶åˆä¼ é€åˆ°äº†æœåŠ¡ç«¯ï¼Œå› è€Œäº§ç”Ÿé”™è¯¯ã€‚ å…·ä½“ä¾‹å­ï¼šâ€œå·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µâ€çš„äº§ç”Ÿåœ¨è¿™æ ·ä¸€ç§æƒ…å†µä¸‹ï¼šclientå‘å‡ºçš„ç¬¬ä¸€ä¸ªè¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µå¹¶æ²¡æœ‰ä¸¢å¤±ï¼Œè€Œæ˜¯åœ¨æŸä¸ªç½‘ç»œç»“ç‚¹é•¿æ—¶é—´çš„æ»ç•™äº†ï¼Œä»¥è‡´å»¶è¯¯åˆ°è¿æ¥é‡Šæ”¾ä»¥åçš„æŸä¸ªæ—¶é—´æ‰åˆ°è¾¾serverã€‚æœ¬æ¥è¿™æ˜¯ä¸€ä¸ªæ—©å·²å¤±æ•ˆçš„æŠ¥æ–‡æ®µã€‚ä½†serveræ”¶åˆ°æ­¤å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µåï¼Œå°±è¯¯è®¤ä¸ºæ˜¯clientå†æ¬¡å‘å‡ºçš„ä¸€ä¸ªæ–°çš„è¿æ¥è¯·æ±‚ã€‚ äºæ˜¯å°±å‘clientå‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ŒåŒæ„å»ºç«‹è¿æ¥ã€‚å‡è®¾ä¸é‡‡ç”¨â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼Œé‚£ä¹ˆåªè¦serverå‘å‡ºç¡®è®¤ï¼Œæ–°çš„è¿æ¥å°±å»ºç«‹äº†ã€‚ç”±äºç°åœ¨clientå¹¶æ²¡æœ‰å‘å‡ºå»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼Œå› æ­¤ä¸ä¼šç†ç¬serverçš„ç¡®è®¤ï¼Œä¹Ÿä¸ä¼šå‘serverå‘é€æ•°æ®ã€‚ä½†serverå´ä»¥ä¸ºæ–°çš„è¿è¾“è¿æ¥å·²ç»å»ºç«‹ï¼Œå¹¶ä¸€ç›´ç­‰å¾…clientå‘æ¥æ•°æ®ã€‚è¿™æ ·ï¼Œserverçš„å¾ˆå¤šèµ„æºå°±ç™½ç™½æµªè´¹æ‰äº†ã€‚é‡‡ç”¨â€œä¸‰æ¬¡æ¡æ‰‹â€çš„åŠæ³•å¯ä»¥é˜²æ­¢ä¸Šè¿°ç°è±¡å‘ç”Ÿã€‚ä¾‹å¦‚åˆšæ‰é‚£ç§æƒ…å†µï¼Œclientä¸ä¼šå‘serverçš„ç¡®è®¤å‘å‡ºç¡®è®¤ã€‚serverç”±äºæ”¶ä¸åˆ°ç¡®è®¤ï¼Œå°±çŸ¥é“clientå¹¶æ²¡æœ‰è¦æ±‚å»ºç«‹è¿æ¥ã€‚â€ 2ã€å››æ¬¡æŒ¥æ‰‹å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹äº†TCPè¿æ¥ä»¥åï¼Œå½“æ•°æ®ä¼ é€å®Œæ¯•ï¼Œè‚¯å®šæ˜¯è¦æ–­å¼€TCPè¿æ¥çš„å•Šã€‚é‚£å¯¹äºTCPçš„æ–­å¼€è¿æ¥ï¼Œè¿™é‡Œå°±æœ‰äº†ç¥ç§˜çš„â€œå››æ¬¡åˆ†æ‰‹â€ã€‚ ç¬¬ä¸€æ¬¡åˆ†æ‰‹ï¼šä¸»æœº1ï¼ˆå¯ä»¥ä½¿å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨ç«¯ï¼‰ï¼Œè®¾ç½®Sequence Numberï¼Œå‘ä¸»æœº2å‘é€ä¸€ä¸ªFINæŠ¥æ–‡æ®µï¼›æ­¤æ—¶ï¼Œä¸»æœº1è¿›å…¥FIN_WAIT_1çŠ¶æ€ï¼›è¿™è¡¨ç¤ºä¸»æœº1æ²¡æœ‰æ•°æ®è¦å‘é€ç»™ä¸»æœº2äº†ï¼› ç¬¬äºŒæ¬¡åˆ†æ‰‹ï¼šä¸»æœº2æ”¶åˆ°äº†ä¸»æœº1å‘é€çš„FINæŠ¥æ–‡æ®µï¼Œå‘ä¸»æœº1å›ä¸€ä¸ªACKæŠ¥æ–‡æ®µï¼ŒAcknowledgment Numberä¸ºSequence NumberåŠ 1ï¼›ä¸»æœº1è¿›å…¥FIN_WAIT_2çŠ¶æ€ï¼›ä¸»æœº2å‘Šè¯‰ä¸»æœº1ï¼Œæˆ‘â€œåŒæ„â€ä½ çš„å…³é—­è¯·æ±‚ï¼› ç¬¬ä¸‰æ¬¡åˆ†æ‰‹ï¼šä¸»æœº2å‘ä¸»æœº1å‘é€FINæŠ¥æ–‡æ®µï¼Œè¯·æ±‚å…³é—­è¿æ¥ï¼ŒåŒæ—¶ä¸»æœº2è¿›å…¥LAST_ACKçŠ¶æ€ï¼› ç¬¬å››æ¬¡åˆ†æ‰‹ï¼šä¸»æœº1æ”¶åˆ°ä¸»æœº2å‘é€çš„FINæŠ¥æ–‡æ®µï¼Œå‘ä¸»æœº2å‘é€ACKæŠ¥æ–‡æ®µï¼Œç„¶åä¸»æœº1è¿›å…¥TIME_WAITçŠ¶æ€ï¼›ä¸»æœº2æ”¶åˆ°ä¸»æœº1çš„ACKæŠ¥æ–‡æ®µä»¥åï¼Œå°±å…³é—­è¿æ¥ï¼›æ­¤æ—¶ï¼Œä¸»æœº1ç­‰å¾…2MSLåä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œåˆ™è¯æ˜Serverç«¯å·²æ­£å¸¸å…³é—­ï¼Œé‚£å¥½ï¼Œä¸»æœº1ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚ ä¸ºä»€ä¹ˆè¦å››æ¬¡åˆ†æ‰‹ï¼Ÿ TCPåè®®æ˜¯ä¸€ç§é¢å‘è¿æ¥çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„è¿è¾“å±‚é€šä¿¡åè®®ã€‚TCPæ˜¯å…¨åŒå·¥æ¨¡å¼ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå½“ä¸»æœº1å‘å‡ºFINæŠ¥æ–‡æ®µæ—¶ï¼Œåªæ˜¯è¡¨ç¤ºä¸»æœº1å·²ç»æ²¡æœ‰æ•°æ®è¦å‘é€äº†ï¼Œä¸»æœº1å‘Šè¯‰ä¸»æœº2ï¼Œå®ƒçš„æ•°æ®å·²ç»å…¨éƒ¨å‘é€å®Œæ¯•äº†ï¼›ä½†æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™ä¸»æœº1è¿˜æ˜¯å¯ä»¥æ¥å—æ¥è‡ªä¸»æœº2çš„æ•°æ®ï¼›å½“ä¸»æœº2è¿”å›ACKæŠ¥æ–‡æ®µæ—¶ï¼Œè¡¨ç¤ºå®ƒå·²ç»çŸ¥é“ä¸»æœº1æ²¡æœ‰æ•°æ®å‘é€äº†ï¼Œä½†æ˜¯ä¸»æœº2è¿˜æ˜¯å¯ä»¥å‘é€æ•°æ®åˆ°ä¸»æœº1çš„ï¼›å½“ä¸»æœº2ä¹Ÿå‘é€äº†FINæŠ¥æ–‡æ®µæ—¶ï¼Œè¿™ä¸ªæ—¶å€™å°±è¡¨ç¤ºä¸»æœº2ä¹Ÿæ²¡æœ‰æ•°æ®è¦å‘é€äº†ï¼Œå°±ä¼šå‘Šè¯‰ä¸»æœº1ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰æ•°æ®è¦å‘é€äº†ï¼Œä¹‹åå½¼æ­¤å°±ä¼šæ„‰å¿«çš„ä¸­æ–­è¿™æ¬¡TCPè¿æ¥ã€‚ ä¸ºä»€ä¹ˆè¦ç­‰å¾…2MSLï¼Ÿ MSLï¼šæŠ¥æ–‡æ®µæœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼Œå®ƒæ˜¯ä»»ä½•æŠ¥æ–‡æ®µè¢«ä¸¢å¼ƒå‰åœ¨ç½‘ç»œå†…çš„æœ€é•¿æ—¶é—´ã€‚åŸå› æœ‰äºŒï¼š ä¿è¯TCPåè®®çš„å…¨åŒå·¥è¿æ¥èƒ½å¤Ÿå¯é å…³é—­ ä¿è¯è¿™æ¬¡è¿æ¥çš„é‡å¤æ•°æ®æ®µä»ç½‘ç»œä¸­æ¶ˆå¤± ç¬¬ä¸€ç‚¹ï¼šå¦‚æœä¸»æœº1ç›´æ¥CLOSEDäº†ï¼Œé‚£ä¹ˆç”±äºIPåè®®çš„ä¸å¯é æ€§æˆ–è€…æ˜¯å…¶å®ƒç½‘ç»œåŸå› ï¼Œå¯¼è‡´ä¸»æœº2æ²¡æœ‰æ”¶åˆ°ä¸»æœº1æœ€åå›å¤çš„ACKã€‚é‚£ä¹ˆä¸»æœº2å°±ä¼šåœ¨è¶…æ—¶ä¹‹åç»§ç»­å‘é€FINï¼Œæ­¤æ—¶ç”±äºä¸»æœº1å·²ç»CLOSEDäº†ï¼Œå°±æ‰¾ä¸åˆ°ä¸é‡å‘çš„FINå¯¹åº”çš„è¿æ¥ã€‚æ‰€ä»¥ï¼Œä¸»æœº1ä¸æ˜¯ç›´æ¥è¿›å…¥CLOSEDï¼Œè€Œæ˜¯è¦ä¿æŒTIME_WAITï¼Œå½“å†æ¬¡æ”¶åˆ°FINçš„æ—¶å€™ï¼Œèƒ½å¤Ÿä¿è¯å¯¹æ–¹æ”¶åˆ°ACKï¼Œæœ€åæ­£ç¡®çš„å…³é—­è¿æ¥ã€‚ ç¬¬äºŒç‚¹ï¼šå¦‚æœä¸»æœº1ç›´æ¥CLOSEDï¼Œç„¶ååˆå†å‘ä¸»æœº2å‘èµ·ä¸€ä¸ªæ–°è¿æ¥ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯è¿™ä¸ªæ–°è¿æ¥ä¸åˆšå…³é—­çš„è¿æ¥çš„ç«¯å£å·æ˜¯ä¸åŒçš„ã€‚ä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½æ–°è¿æ¥å’Œè€è¿æ¥çš„ç«¯å£å·æ˜¯ç›¸åŒçš„ã€‚ä¸€èˆ¬æ¥è¯´ä¸ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç‰¹æ®Šæƒ…å†µå‡ºç°ï¼šå‡è®¾æ–°è¿æ¥å’Œå·²ç»å…³é—­çš„è€è¿æ¥ç«¯å£å·æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœå‰ä¸€æ¬¡è¿æ¥çš„æŸäº›æ•°æ®ä»ç„¶æ»ç•™åœ¨ç½‘ç»œä¸­ï¼Œè¿™äº›å»¶è¿Ÿæ•°æ®åœ¨å»ºç«‹æ–°è¿æ¥ä¹‹åæ‰åˆ°è¾¾ä¸»æœº2ï¼Œç”±äºæ–°è¿æ¥å’Œè€è¿æ¥çš„ç«¯å£å·æ˜¯ä¸€æ ·çš„ï¼ŒTCPåè®®å°±è®¤ä¸ºé‚£ä¸ªå»¶è¿Ÿçš„æ•°æ®æ˜¯å±äºæ–°è¿æ¥çš„ï¼Œè¿™æ ·å°±å’ŒçœŸæ­£çš„æ–°è¿æ¥çš„æ•°æ®åŒ…å‘ç”Ÿæ··æ·†äº†ã€‚æ‰€ä»¥TCPè¿æ¥è¿˜è¦åœ¨TIME_WAITçŠ¶æ€ç­‰å¾…2å€MSLï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ¬æ¬¡è¿æ¥çš„æ‰€æœ‰æ•°æ®éƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ã€‚ ä¹ã€TCPæµé‡æ§åˆ¶å¦‚æœå‘é€æ–¹æŠŠæ•°æ®å‘é€å¾—è¿‡å¿«ï¼Œæ¥æ”¶æ–¹å¯èƒ½ä¼šæ¥ä¸åŠæ¥æ”¶ï¼Œè¿™å°±ä¼šé€ æˆæ•°æ®çš„ä¸¢å¤±ã€‚æ‰€è°“æµé‡æ§åˆ¶å°±æ˜¯è®©å‘é€æ–¹çš„å‘é€é€Ÿç‡ä¸è¦å¤ªå¿«ï¼Œè¦è®©æ¥æ”¶æ–¹æ¥å¾—åŠæ¥æ”¶ã€‚ åˆ©ç”¨æ»‘åŠ¨çª—å£æœºåˆ¶å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨TCPè¿æ¥ä¸Šå®ç°å¯¹å‘é€æ–¹çš„æµé‡æ§åˆ¶ã€‚ è®¾Aå‘Bå‘é€æ•°æ®ã€‚åœ¨è¿æ¥å»ºç«‹æ—¶ï¼ŒBå‘Šè¯‰äº†Aï¼šâ€œæˆ‘çš„æ¥æ”¶çª—å£æ˜¯ rwnd &#x3D; 400 â€(è¿™é‡Œçš„ rwnd è¡¨ç¤º receiver window) ã€‚å› æ­¤ï¼Œå‘é€æ–¹çš„å‘é€çª—å£ä¸èƒ½è¶…è¿‡æ¥æ”¶æ–¹ç»™å‡ºçš„æ¥æ”¶çª—å£çš„æ•°å€¼ã€‚è¯·æ³¨æ„ï¼ŒTCPçš„çª—å£å•ä½æ˜¯å­—èŠ‚ï¼Œä¸æ˜¯æŠ¥æ–‡æ®µã€‚å‡è®¾æ¯ä¸€ä¸ªæŠ¥æ–‡æ®µä¸º100å­—èŠ‚é•¿ï¼Œè€Œæ•°æ®æŠ¥æ–‡æ®µåºå·çš„åˆå§‹å€¼è®¾ä¸º1ã€‚å¤§å†™ACKè¡¨ç¤ºé¦–éƒ¨ä¸­çš„ç¡®è®¤ä½ACKï¼Œå°å†™ackè¡¨ç¤ºç¡®è®¤å­—æ®µçš„å€¼ackã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBè¿›è¡Œäº†ä¸‰æ¬¡æµé‡æ§åˆ¶ã€‚ç¬¬ä¸€æ¬¡æŠŠçª—å£å‡å°‘åˆ° rwnd &#x3D; 300 ï¼Œç¬¬äºŒæ¬¡åˆå‡åˆ°äº† rwnd &#x3D; 100 ï¼Œæœ€åå‡åˆ° rwnd &#x3D; 0 ï¼Œå³ä¸å…è®¸å‘é€æ–¹å†å‘é€æ•°æ®äº†ã€‚è¿™ç§ä½¿å‘é€æ–¹æš‚åœå‘é€çš„çŠ¶æ€å°†æŒç»­åˆ°ä¸»æœºBé‡æ–°å‘å‡ºä¸€ä¸ªæ–°çš„çª—å£å€¼ä¸ºæ­¢ã€‚Bå‘Aå‘é€çš„ä¸‰ä¸ªæŠ¥æ–‡æ®µéƒ½è®¾ç½®äº† ACK &#x3D; 1 ï¼Œåªæœ‰åœ¨ACK&#x3D;1æ—¶ç¡®è®¤å·å­—æ®µæ‰æœ‰æ„ä¹‰ã€‚ TCPä¸ºæ¯ä¸€ä¸ªè¿æ¥è®¾æœ‰ä¸€ä¸ªæŒç»­è®¡æ—¶å™¨(persistence timer)ã€‚åªè¦TCPè¿æ¥çš„ä¸€æ–¹æ”¶åˆ°å¯¹æ–¹çš„é›¶çª—å£é€šçŸ¥ï¼Œå°±å¯åŠ¨æŒç»­è®¡æ—¶å™¨ã€‚è‹¥æŒç»­è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´åˆ°æœŸï¼Œå°±å‘é€ä¸€ä¸ªé›¶çª—å£æ§æµ‹æŠ¥æ–‡æ®µï¼ˆæº1å­—èŠ‚çš„æ•°æ®ï¼‰ï¼Œé‚£ä¹ˆæ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡æ®µçš„ä¸€æ–¹å°±é‡æ–°è®¾ç½®æŒç»­è®¡æ—¶å™¨ã€‚ åã€TCPæ‹¥å¡æ§åˆ¶å‘é€æ–¹ç»´æŒä¸€ä¸ªæ‹¥å¡çª—å£ cwnd ( congestion window )çš„çŠ¶æ€å˜é‡ã€‚æ‹¥å¡çª—å£çš„å¤§å°å–å†³äºç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦ï¼Œå¹¶ä¸”åŠ¨æ€åœ°åœ¨å˜åŒ–ã€‚å‘é€æ–¹è®©è‡ªå·±çš„å‘é€çª—å£ç­‰äºæ‹¥å¡çª—å£ã€‚ å‘é€æ–¹æ§åˆ¶æ‹¥å¡çª—å£çš„åŸåˆ™æ˜¯ï¼šåªè¦ç½‘ç»œæ²¡æœ‰å‡ºç°æ‹¥å¡ï¼Œæ‹¥å¡çª—å£å°±å†å¢å¤§ä¸€äº›ï¼Œä»¥ä¾¿æŠŠæ›´å¤šçš„åˆ†ç»„å‘é€å‡ºå»ã€‚ä½†åªè¦ç½‘ç»œå‡ºç°æ‹¥å¡ï¼Œæ‹¥å¡çª—å£å°±å‡å°ä¸€äº›ï¼Œä»¥å‡å°‘æ³¨å…¥åˆ°ç½‘ç»œä¸­çš„åˆ†ç»„æ•°ã€‚ æ…¢å¼€å§‹ç®—æ³•ï¼š å½“ä¸»æœºå¼€å§‹å‘é€æ•°æ®æ—¶ï¼Œå¦‚æœç«‹å³æ‰€å¤§é‡æ•°æ®å­—èŠ‚æ³¨å…¥åˆ°ç½‘ç»œï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œå› ä¸ºç°åœ¨å¹¶ä¸æ¸…æ¥šç½‘ç»œçš„è´Ÿè·æƒ…å†µã€‚å› æ­¤ï¼Œè¾ƒå¥½çš„æ–¹æ³•æ˜¯ å…ˆæ¢æµ‹ä¸€ä¸‹ï¼Œå³ç”±å°åˆ°å¤§é€æ¸å¢å¤§å‘é€çª—å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”±å°åˆ°å¤§é€æ¸å¢å¤§æ‹¥å¡çª—å£æ•°å€¼ã€‚ é€šå¸¸åœ¨åˆšåˆšå¼€å§‹å‘é€æŠ¥æ–‡æ®µæ—¶ï¼Œå…ˆæŠŠæ‹¥å¡çª—å£ cwnd è®¾ç½®ä¸ºä¸€ä¸ªæœ€å¤§æŠ¥æ–‡æ®µMSSçš„æ•°å€¼ã€‚è€Œåœ¨æ¯æ”¶åˆ°ä¸€ä¸ªå¯¹æ–°çš„æŠ¥æ–‡æ®µçš„ç¡®è®¤åï¼ŒæŠŠæ‹¥å¡çª—å£å¢åŠ è‡³å¤šä¸€ä¸ªMSSçš„æ•°å€¼ã€‚ç”¨è¿™æ ·çš„æ–¹æ³•é€æ­¥å¢å¤§å‘é€æ–¹çš„æ‹¥å¡çª—å£ cwnd ï¼Œå¯ä»¥ä½¿åˆ†ç»„æ³¨å…¥åˆ°ç½‘ç»œçš„é€Ÿç‡æ›´åŠ åˆç†ã€‚ æ¯ç»è¿‡ä¸€ä¸ªä¼ è¾“è½®æ¬¡ï¼Œæ‹¥å¡çª—å£ cwnd å°±åŠ å€ã€‚ä¸€ä¸ªä¼ è¾“è½®æ¬¡æ‰€ç»å†çš„æ—¶é—´å…¶å®å°±æ˜¯å¾€è¿”æ—¶é—´RTTã€‚ä¸è¿‡â€œä¼ è¾“è½®æ¬¡â€æ›´åŠ å¼ºè°ƒï¼šæŠŠæ‹¥å¡çª—å£cwndæ‰€å…è®¸å‘é€çš„æŠ¥æ–‡æ®µéƒ½è¿ç»­å‘é€å‡ºå»ï¼Œå¹¶æ”¶åˆ°äº†å¯¹å·²å‘é€çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„ç¡®è®¤ã€‚ å¦ï¼Œæ…¢å¼€å§‹çš„â€œæ…¢â€å¹¶ä¸æ˜¯æŒ‡cwndçš„å¢é•¿é€Ÿç‡æ…¢ï¼Œè€Œæ˜¯æŒ‡åœ¨TCPå¼€å§‹å‘é€æŠ¥æ–‡æ®µæ—¶å…ˆè®¾ç½®cwnd&#x3D;1ï¼Œä½¿å¾—å‘é€æ–¹åœ¨å¼€å§‹æ—¶åªå‘é€ä¸€ä¸ªæŠ¥æ–‡æ®µï¼ˆç›®çš„æ˜¯è¯•æ¢ä¸€ä¸‹ç½‘ç»œçš„æ‹¥å¡æƒ…å†µï¼‰ï¼Œç„¶åå†é€æ¸å¢å¤§cwndã€‚ ä¸ºäº†é˜²æ­¢æ‹¥å¡çª—å£cwndå¢é•¿è¿‡å¤§å¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ…¢å¼€å§‹é—¨é™ssthreshçŠ¶æ€å˜é‡ã€‚æ…¢å¼€å§‹é—¨é™ssthreshçš„ç”¨æ³•å¦‚ä¸‹ï¼š å½“ cwnd &lt; ssthresh æ—¶ï¼Œä½¿ç”¨ä¸Šè¿°çš„æ…¢å¼€å§‹ç®—æ³•ã€‚ å½“ cwnd &gt; ssthresh æ—¶ï¼Œåœæ­¢ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•è€Œæ”¹ç”¨æ‹¥å¡é¿å…ç®—æ³•ã€‚ å½“ cwnd &#x3D; ssthresh æ—¶ï¼Œæ—¢å¯ä½¿ç”¨æ…¢å¼€å§‹ç®—æ³•ï¼Œä¹Ÿå¯ä½¿ç”¨æ‹¥å¡æ§åˆ¶é¿å…ç®—æ³•ã€‚æ‹¥å¡é¿å… æ‹¥å¡é¿å… è®©æ‹¥å¡çª—å£cwndç¼“æ…¢åœ°å¢å¤§ï¼Œå³æ¯ç»è¿‡ä¸€ä¸ªå¾€è¿”æ—¶é—´RTTå°±æŠŠå‘é€æ–¹çš„æ‹¥å¡çª—å£cwndåŠ 1ï¼Œè€Œä¸æ˜¯åŠ å€ã€‚è¿™æ ·æ‹¥å¡çª—å£cwndæŒ‰çº¿æ€§è§„å¾‹ç¼“æ…¢å¢é•¿ï¼Œæ¯”æ…¢å¼€å§‹ç®—æ³•çš„æ‹¥å¡çª—å£å¢é•¿é€Ÿç‡ç¼“æ…¢å¾—å¤šã€‚ æ— è®ºåœ¨æ…¢å¼€å§‹é˜¶æ®µè¿˜æ˜¯åœ¨æ‹¥å¡é¿å…é˜¶æ®µï¼Œåªè¦å‘é€æ–¹åˆ¤æ–­ç½‘ç»œå‡ºç°æ‹¥å¡ï¼ˆå…¶æ ¹æ®å°±æ˜¯æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼‰ï¼Œå°±è¦æŠŠæ…¢å¼€å§‹é—¨é™ssthreshè®¾ç½®ä¸ºå‡ºç°æ‹¥å¡æ—¶çš„å‘é€ æ–¹çª—å£å€¼çš„ä¸€åŠï¼ˆä½†ä¸èƒ½å°äº2ï¼‰ã€‚ç„¶åæŠŠæ‹¥å¡çª—å£cwndé‡æ–°è®¾ç½®ä¸º1ï¼Œæ‰§è¡Œæ…¢å¼€å§‹ç®—æ³•ã€‚ è¿™æ ·åšçš„ç›®çš„å°±æ˜¯è¦è¿…é€Ÿå‡å°‘ä¸»æœºå‘é€åˆ°ç½‘ç»œä¸­çš„åˆ†ç»„æ•°ï¼Œä½¿å¾—å‘ç”Ÿ æ‹¥å¡çš„è·¯ç”±å™¨æœ‰è¶³å¤Ÿæ—¶é—´æŠŠé˜Ÿåˆ—ä¸­ç§¯å‹çš„åˆ†ç»„å¤„ç†å®Œæ¯•ã€‚ å¦‚ä¸‹å›¾ï¼Œç”¨å…·ä½“æ•°å€¼è¯´æ˜äº†ä¸Šè¿°æ‹¥å¡æ§åˆ¶çš„è¿‡ç¨‹ã€‚ç°åœ¨å‘é€çª—å£çš„å¤§å°å’Œæ‹¥å¡çª—å£ä¸€æ ·å¤§ã€‚ 2ã€å¿«é‡ä¼ å’Œå¿«æ¢å¤å¿«é‡ä¼ å¿«é‡ä¼ ç®—æ³•é¦–å…ˆè¦æ±‚æ¥æ”¶æ–¹æ¯æ”¶åˆ°ä¸€ä¸ªå¤±åºçš„æŠ¥æ–‡æ®µåå°±ç«‹å³å‘å‡ºé‡å¤ç¡®è®¤ï¼ˆä¸ºçš„æ˜¯ä½¿å‘é€æ–¹åŠæ—©çŸ¥é“æœ‰æŠ¥æ–‡æ®µæ²¡æœ‰åˆ°è¾¾å¯¹æ–¹ï¼‰è€Œä¸è¦ç­‰åˆ°è‡ªå·±å‘é€æ•°æ®æ—¶æ‰è¿›è¡Œæå¸¦ç¡®è®¤ã€‚ æ¥æ”¶æ–¹æ”¶åˆ°äº†M1å’ŒM2åéƒ½åˆ†åˆ«å‘å‡ºäº†ç¡®è®¤ã€‚ç°åœ¨å‡å®šæ¥æ”¶æ–¹æ²¡æœ‰æ”¶åˆ°M3ä½†æ¥ç€æ”¶åˆ°äº†M4ã€‚ æ˜¾ç„¶ï¼Œæ¥æ”¶æ–¹ä¸èƒ½ç¡®è®¤M4ï¼Œå› ä¸ºM4æ˜¯æ”¶åˆ°çš„å¤±åºæŠ¥æ–‡æ®µã€‚æ ¹æ® å¯é ä¼ è¾“åŸç†ï¼Œæ¥æ”¶æ–¹å¯ä»¥ä»€ä¹ˆéƒ½ä¸åšï¼Œä¹Ÿå¯ä»¥åœ¨é€‚å½“æ—¶æœºå‘é€ä¸€æ¬¡å¯¹M2çš„ç¡®è®¤ã€‚ ä½†æŒ‰ç…§å¿«é‡ä¼ ç®—æ³•çš„è§„å®šï¼Œæ¥æ”¶æ–¹åº”åŠæ—¶å‘é€å¯¹M2çš„é‡å¤ç¡®è®¤ï¼Œè¿™æ ·åšå¯ä»¥è®© å‘é€æ–¹åŠæ—©çŸ¥é“æŠ¥æ–‡æ®µM3æ²¡æœ‰åˆ°è¾¾æ¥æ”¶æ–¹ã€‚å‘é€æ–¹æ¥ç€å‘é€äº†M5å’ŒM6ã€‚æ¥æ”¶æ–¹æ”¶åˆ°è¿™ä¸¤ä¸ªæŠ¥æ–‡åï¼Œä¹Ÿè¿˜è¦å†æ¬¡å‘å‡ºå¯¹M2çš„é‡å¤ç¡®è®¤ã€‚è¿™æ ·ï¼Œå‘é€æ–¹å…±æ”¶åˆ°äº† æ¥æ”¶æ–¹çš„å››ä¸ªå¯¹M2çš„ç¡®è®¤ï¼Œå…¶ä¸­åä¸‰ä¸ªéƒ½æ˜¯é‡å¤ç¡®è®¤ã€‚ å¿«é‡ä¼ ç®—æ³•è¿˜è§„å®šï¼Œå‘é€æ–¹åªè¦ä¸€è¿æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤å°±åº”å½“ç«‹å³é‡ä¼ å¯¹æ–¹å°šæœªæ”¶åˆ°çš„æŠ¥æ–‡æ®µM3ï¼Œè€Œä¸å¿… ç»§ç»­ç­‰å¾…M3è®¾ç½®çš„é‡ä¼ è®¡æ—¶å™¨åˆ°æœŸã€‚ ç”±äºå‘é€æ–¹å°½æ—©é‡ä¼ æœªè¢«ç¡®è®¤çš„æŠ¥æ–‡æ®µï¼Œå› æ­¤é‡‡ç”¨å¿«é‡ä¼ åå¯ä»¥ä½¿æ•´ä¸ªç½‘ç»œååé‡æé«˜çº¦20%ã€‚ å¿«æ¢å¤ä¸å¿«é‡ä¼ é…åˆä½¿ç”¨çš„è¿˜æœ‰å¿«æ¢å¤ç®—æ³•ï¼Œå…¶è¿‡ç¨‹æœ‰ä»¥ä¸‹ä¸¤ä¸ªè¦ç‚¹ï¼š å½“å‘é€æ–¹è¿ç»­æ”¶åˆ°ä¸‰ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±æ‰§è¡Œâ€œä¹˜æ³•å‡å°â€ç®—æ³•ï¼ŒæŠŠæ…¢å¼€å§‹é—¨é™ssthreshå‡åŠã€‚ ä¸æ…¢å¼€å§‹ä¸åŒä¹‹å¤„æ˜¯ç°åœ¨ä¸æ‰§è¡Œæ…¢å¼€å§‹ç®—æ³•ï¼ˆå³æ‹¥å¡çª—å£cwndç°åœ¨ä¸è®¾ç½®ä¸º1ï¼‰ï¼Œè€Œæ˜¯æŠŠcwndå€¼è®¾ç½®ä¸º æ…¢å¼€å§‹é—¨é™ssthreshå‡åŠåçš„æ•°å€¼ï¼Œç„¶åå¼€å§‹æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•ï¼ˆâ€œåŠ æ³•å¢å¤§â€ï¼‰ï¼Œä½¿æ‹¥å¡çª—å£ç¼“æ…¢åœ°çº¿æ€§å¢å¤§ã€‚","tags":["è®¡ç®—æœºç½‘ç»œ","TCP/IP"],"categories":["è®¡ç®—æœºç½‘ç»œ"]},{"title":"Java æ³›å‹ Tï¼ŒEï¼ŒKï¼ŒVï¼Œ?ï¼Œå‚»å‚»åˆ†ä¸æ¸…ï¼Ÿ","path":"/2023/12/24/Java-æ³›å‹-Tï¼ŒEï¼ŒKï¼ŒVï¼Œ-ï¼Œå‚»å‚»åˆ†ä¸æ¸…ï¼Ÿ/","content":"å‰è¨€Java æ³›å‹ï¼ˆgenericsï¼‰æ˜¯ JDK 5 ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§, æ³›å‹æä¾›äº†ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨æ£€æµ‹æœºåˆ¶ï¼Œè¯¥æœºåˆ¶å…è®¸å¼€å‘è€…åœ¨ç¼–è¯‘æ—¶æ£€æµ‹åˆ°éæ³•çš„ç±»å‹ã€‚ æ³›å‹çš„æœ¬è´¨æ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æ“ä½œçš„æ•°æ®ç±»å‹è¢«æŒ‡å®šä¸ºä¸€ä¸ªå‚æ•°ã€‚ æ³›å‹å¸¦æ¥çš„å¥½å¤„åœ¨æ²¡æœ‰æ³›å‹çš„æƒ…å†µçš„ä¸‹ï¼Œé€šè¿‡å¯¹ç±»å‹ Object çš„å¼•ç”¨æ¥å®ç°å‚æ•°çš„â€œä»»æ„åŒ–â€ï¼Œâ€œä»»æ„åŒ–â€å¸¦æ¥çš„ç¼ºç‚¹æ˜¯è¦åšæ˜¾å¼çš„å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè€Œè¿™ç§è½¬æ¢æ˜¯è¦æ±‚å¼€å‘è€…å¯¹å®é™…å‚æ•°ç±»å‹å¯ä»¥é¢„çŸ¥çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚å¯¹äºå¼ºåˆ¶ç±»å‹è½¬æ¢é”™è¯¯çš„æƒ…å†µï¼Œç¼–è¯‘å™¨å¯èƒ½ä¸æç¤ºé”™è¯¯ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æ‰å‡ºç°å¼‚å¸¸ï¼Œè¿™æ˜¯æœ¬èº«å°±æ˜¯ä¸€ä¸ªå®‰å…¨éšæ‚£ã€‚ é‚£ä¹ˆæ³›å‹çš„å¥½å¤„å°±æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™èƒ½å¤Ÿæ£€æŸ¥ç±»å‹å®‰å…¨ï¼Œå¹¶ä¸”æ‰€æœ‰çš„å¼ºåˆ¶è½¬æ¢éƒ½æ˜¯è‡ªåŠ¨å’Œéšå¼çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637public class GlmapperGeneric&lt;T&gt; &#123; private T t; public void set(T t) &#123; this.t = t; &#125; public T get() &#123; return t; &#125; public static void main(String[] args) &#123; // do nothing &#125; /** * ä¸æŒ‡å®šç±»å‹ */ public void noSpecifyType() &#123; GlmapperGeneric glmapperGeneric = new GlmapperGeneric(); glmapperGeneric.set(&quot;test&quot;); // éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ String test = (String) glmapperGeneric.get(); System.out.println(test); &#125; /** * æŒ‡å®šç±»å‹ */ public void specifyType() &#123; GlmapperGeneric&lt;String&gt; glmapperGeneric = new GlmapperGeneric(); glmapperGeneric.set(&quot;test&quot;); // ä¸éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ String test = glmapperGeneric.get(); System.out.println(test); &#125;&#125; ä¸Šé¢è¿™æ®µä»£ç ä¸­çš„ specifyType æ–¹æ³•ä¸­ çœå»äº†å¼ºåˆ¶è½¬æ¢ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶å€™æ£€æŸ¥ç±»å‹å®‰å…¨ï¼Œå¯ä»¥ç”¨åœ¨ç±»ï¼Œæ–¹æ³•ï¼Œæ¥å£ä¸Šã€‚ æ³›å‹ä¸­é€šé…ç¬¦æˆ‘ä»¬åœ¨å®šä¹‰æ³›å‹ç±»ï¼Œæ³›å‹æ–¹æ³•ï¼Œæ³›å‹æ¥å£çš„æ—¶å€™ç»å¸¸ä¼šç¢°è§å¾ˆå¤šä¸åŒçš„é€šé…ç¬¦ï¼Œæ¯”å¦‚ Tï¼ŒEï¼ŒKï¼ŒV ç­‰ç­‰ï¼Œè¿™äº›é€šé…ç¬¦åˆéƒ½æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ å¸¸ç”¨çš„ Tï¼ŒEï¼ŒKï¼ŒVï¼Œï¼Ÿæœ¬è´¨ä¸Šè¿™äº›ä¸ªéƒ½æ˜¯é€šé…ç¬¦ï¼Œæ²¡å•¥åŒºåˆ«ï¼Œåªä¸è¿‡æ˜¯ç¼–ç æ—¶çš„ä¸€ç§çº¦å®šä¿—æˆçš„ä¸œè¥¿ã€‚æ¯”å¦‚ä¸Šè¿°ä»£ç ä¸­çš„ T ï¼Œæˆ‘ä»¬å¯ä»¥æ¢æˆ A-Z ä¹‹é—´çš„ä»»ä½•ä¸€ä¸ª å­—æ¯éƒ½å¯ä»¥ï¼Œå¹¶ä¸ä¼šå½±å“ç¨‹åºçš„æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯å¦‚æœæ¢æˆå…¶ä»–çš„å­—æ¯ä»£æ›¿ T ï¼Œåœ¨å¯è¯»æ€§ä¸Šå¯èƒ½ä¼šå¼±ä¸€äº›ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒTï¼ŒEï¼ŒKï¼ŒVï¼Œï¼Ÿæ˜¯è¿™æ ·çº¦å®šçš„ï¼š ï¼Ÿè¡¨ç¤ºä¸ç¡®å®šçš„ java ç±»å‹ T (type) è¡¨ç¤ºå…·ä½“çš„ä¸€ä¸ªjavaç±»å‹ K V (key value) åˆ†åˆ«ä»£è¡¨javaé”®å€¼ä¸­çš„Key Value E (element) ä»£è¡¨Element ï¼Ÿæ— ç•Œé€šé…ç¬¦å…ˆä»ä¸€ä¸ªå°ä¾‹å­çœ‹èµ· ã€‚ æˆ‘æœ‰ä¸€ä¸ªçˆ¶ç±» Animal å’Œå‡ ä¸ªå­ç±»ï¼Œå¦‚ç‹—ã€çŒ«ç­‰ï¼Œç°åœ¨æˆ‘éœ€è¦ä¸€ä¸ªåŠ¨ç‰©çš„åˆ—è¡¨ï¼Œæˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯åƒè¿™æ ·çš„ï¼š 1List&lt;Animal&gt; listAnimals ä½†æ˜¯è€æ¿çš„æƒ³æ³•ç¡®å®è¿™æ ·çš„ï¼š 1List&lt;? extends Animal&gt; listAnimals ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é€šé…ç¬¦è€Œä¸æ˜¯ç®€å•çš„æ³›å‹å‘¢ï¼Ÿé€šé…ç¬¦å…¶å®åœ¨å£°æ˜å±€éƒ¨å˜é‡æ—¶æ˜¯æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„ï¼Œä½†æ˜¯å½“ä½ ä¸ºä¸€ä¸ªæ–¹æ³•å£°æ˜ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå®ƒæ˜¯éå¸¸é‡è¦çš„ã€‚ 123456789101112131415161718192021static int countLegs (List&lt;? extends Animal &gt; animals ) &#123; int retVal = 0; for ( Animal animal : animals ) &#123; retVal += animal.countLegs(); &#125; return retVal;&#125;static int countLegs1 (List&lt; Animal &gt; animals ) &#123; int retVal = 0; for ( Animal animal : animals ) &#123; retVal += animal.countLegs(); &#125; return retVal;&#125;public static void main(String[] args) &#123; List&lt;Dog&gt; dogs = new ArrayList&lt;&gt;(); // ä¸ä¼šæŠ¥é”™ countLegs( dogs ); // æŠ¥é”™ countLegs1(dogs);&#125; å½“è°ƒç”¨ countLegs1 æ—¶ï¼Œå°±ä¼šé£˜çº¢ï¼Œæç¤ºçš„é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š æ‰€ä»¥ï¼Œå¯¹äºä¸ç¡®å®šæˆ–è€…ä¸å…³å¿ƒå®é™…è¦æ“ä½œçš„ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨æ— é™åˆ¶é€šé…ç¬¦ï¼ˆå°–æ‹¬å·é‡Œä¸€ä¸ªé—®å·ï¼Œå³ &lt;?&gt; ï¼‰ï¼Œè¡¨ç¤ºå¯ä»¥æŒæœ‰ä»»ä½•ç±»å‹ã€‚åƒ countLegs æ–¹æ³•ä¸­ï¼Œé™å®šäº†ä¸Šå±Šï¼Œä½†æ˜¯ä¸å…³å¿ƒå…·ä½“ç±»å‹æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥å¯¹äºä¼ å…¥çš„ Animal çš„æ‰€æœ‰å­ç±»éƒ½å¯ä»¥æ”¯æŒï¼Œå¹¶ä¸”ä¸ä¼šæŠ¥é”™ã€‚è€Œ countLegs1 å°±ä¸è¡Œã€‚ ä¸Šç•Œé€šé…ç¬¦ &lt; ? extends E&gt; ä¸Šç•Œï¼šç”¨ extends å…³é”®å­—å£°æ˜ï¼Œè¡¨ç¤ºå‚æ•°åŒ–çš„ç±»å‹å¯èƒ½æ˜¯æ‰€æŒ‡å®šçš„ç±»å‹ï¼Œæˆ–è€…æ˜¯æ­¤ç±»å‹çš„å­ç±»ã€‚ åœ¨ç±»å‹å‚æ•°ä¸­ä½¿ç”¨ extends è¡¨ç¤ºè¿™ä¸ªæ³›å‹ä¸­çš„å‚æ•°å¿…é¡»æ˜¯ E æˆ–è€… E çš„å­ç±»ï¼Œè¿™æ ·æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š å¦‚æœä¼ å…¥çš„ç±»å‹ä¸æ˜¯ E æˆ–è€… E çš„å­ç±»ï¼Œç¼–è¯‘ä¸æˆåŠŸ æ³›å‹ä¸­å¯ä»¥ä½¿ç”¨ E çš„æ–¹æ³•ï¼Œè¦ä¸ç„¶è¿˜å¾—å¼ºè½¬æˆ E æ‰èƒ½ä½¿ç”¨ 12345private &lt;K extends A, E extends B&gt; E test(K arg1, E arg2) &#123; E result = arg2; arg2.compareTo(arg1); //..... return result;&#125; ç±»å‹å‚æ•°åˆ—è¡¨ä¸­å¦‚æœæœ‰å¤šä¸ªç±»å‹å‚æ•°ä¸Šé™ï¼Œç”¨é€—å·åˆ†å¼€ ä¸‹ç•Œé€šé…ç¬¦ &lt; ? super E&gt; ä¸‹ç•Œ: ç”¨ super è¿›è¡Œå£°æ˜ï¼Œè¡¨ç¤ºå‚æ•°åŒ–çš„ç±»å‹å¯èƒ½æ˜¯æ‰€æŒ‡å®šçš„ç±»å‹ï¼Œæˆ–è€…æ˜¯æ­¤ç±»å‹çš„çˆ¶ç±»å‹ï¼Œç›´è‡³ Object åœ¨ç±»å‹å‚æ•°ä¸­ä½¿ç”¨ super è¡¨ç¤ºè¿™ä¸ªæ³›å‹ä¸­çš„å‚æ•°å¿…é¡»æ˜¯ E æˆ–è€… E çš„çˆ¶ç±»ã€‚ 1234567891011121314private &lt;T&gt; void test(List&lt;? super T&gt; dst, List&lt;T&gt; src) &#123; for (T t : src) &#123; dst.add(t); &#125;&#125;public static void main(String[] args) &#123; List&lt;Dog&gt; dogs = new ArrayList&lt;&gt;(); List&lt;Animal&gt; animals = new ArrayList&lt;&gt;(); new Test3().test(animals,dogs);&#125;// Dog æ˜¯ Animal çš„å­ç±»class Dog extends Animal &#123;&#125; dst ç±»å‹ â€œå¤§äºç­‰äºâ€ src çš„ç±»å‹ï¼Œè¿™é‡Œçš„â€œå¤§äºç­‰äºâ€æ˜¯æŒ‡ dst è¡¨ç¤ºçš„èŒƒå›´æ¯” src è¦å¤§ï¼Œå› æ­¤è£…å¾—ä¸‹ dst çš„å®¹å™¨ä¹Ÿå°±èƒ½è£… src ã€‚ ï¼Ÿå’Œ T çš„åŒºåˆ« ï¼Ÿå’Œ T éƒ½è¡¨ç¤ºä¸ç¡®å®šçš„ç±»å‹ï¼ŒåŒºåˆ«åœ¨äºæˆ‘ä»¬å¯ä»¥å¯¹ T è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯å¯¹ ï¼Ÿä¸è¡Œï¼Œæ¯”å¦‚å¦‚ä¸‹è¿™ç§ ï¼š 1234// å¯ä»¥T t = operate();// ä¸å¯ä»¥ï¼Ÿcar = operate(); ç®€å•æ€»ç»“ä¸‹ï¼š T æ˜¯ä¸€ä¸ª ç¡®å®šçš„ ç±»å‹ï¼Œé€šå¸¸ç”¨äºæ³›å‹ç±»å’Œæ³›å‹æ–¹æ³•çš„å®šä¹‰ï¼Œï¼Ÿæ˜¯ä¸€ä¸ª ä¸ç¡®å®š çš„ç±»å‹ï¼Œé€šå¸¸ç”¨äºæ³›å‹æ–¹æ³•çš„è°ƒç”¨ä»£ç å’Œå½¢å‚ï¼Œä¸èƒ½ç”¨äºå®šä¹‰ç±»å’Œæ³›å‹æ–¹æ³•ã€‚ åŒºåˆ«1ï¼šé€šè¿‡ T æ¥ ç¡®ä¿ æ³›å‹å‚æ•°çš„ä¸€è‡´æ€§12345// é€šè¿‡ T æ¥ ç¡®ä¿ æ³›å‹å‚æ•°çš„ä¸€è‡´æ€§public &lt;T extends Number&gt; voidtest(List&lt;T&gt; dest, List&lt;T&gt; src)//é€šé…ç¬¦æ˜¯ ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸èƒ½ä¿è¯ä¸¤ä¸ª List å…·æœ‰ç›¸åŒçš„å…ƒç´ ç±»å‹public void test(List&lt;? extends Number&gt; dest, List&lt;? extends Number&gt; src) åƒä¸‹é¢çš„ä»£ç ä¸­ï¼Œçº¦å®šçš„ T æ˜¯ Number çš„å­ç±»æ‰å¯ä»¥ï¼Œä½†æ˜¯ç”³æ˜æ—¶æ˜¯ç”¨çš„ String ï¼Œæ‰€ä»¥å°±ä¼šé£˜çº¢æŠ¥é”™ã€‚ ä¸èƒ½ä¿è¯ä¸¤ä¸ª List å…·æœ‰ç›¸åŒçš„å…ƒç´ ç±»å‹çš„æƒ…å†µ 1234GlmapperGeneric&lt;String&gt; glmapperGeneric = new GlmapperGeneric&lt;&gt;();List&lt;String&gt; dest = new ArrayList&lt;&gt;();List&lt;Number&gt; src = new ArrayList&lt;&gt;();glmapperGeneric.testNon(dest,src); ä¸Šé¢çš„ä»£ç åœ¨ç¼–è¯‘å™¨å¹¶ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯å½“è¿›å…¥åˆ° testNon æ–¹æ³•å†…éƒ¨æ“ä½œæ—¶ï¼ˆæ¯”å¦‚èµ‹å€¼ï¼‰ï¼Œå¯¹äº dest å’Œ src è€Œè¨€ï¼Œå°±è¿˜æ˜¯éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢ã€‚ åŒºåˆ«2ï¼šç±»å‹å‚æ•°å¯ä»¥å¤šé‡é™å®šè€Œé€šé…ç¬¦ä¸è¡Œ ä½¿ç”¨ &amp; ç¬¦å·è®¾å®šå¤šé‡è¾¹ç•Œï¼ˆMulti Bounds)ï¼ŒæŒ‡å®šæ³›å‹ç±»å‹ T å¿…é¡»æ˜¯ MultiLimitInterfaceA å’Œ MultiLimitInterfaceB çš„å…±æœ‰å­ç±»å‹ï¼Œæ­¤æ—¶å˜é‡ t å°±å…·æœ‰äº†æ‰€æœ‰é™å®šçš„æ–¹æ³•å’Œå±æ€§ã€‚å¯¹äºé€šé…ç¬¦æ¥è¯´ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªç¡®å®šçš„ç±»å‹ï¼Œæ‰€ä»¥ä¸èƒ½è¿›è¡Œå¤šé‡é™å®šã€‚ åŒºåˆ«3ï¼šé€šé…ç¬¦å¯ä»¥ä½¿ç”¨è¶…ç±»é™å®šè€Œç±»å‹å‚æ•°ä¸è¡Œç±»å‹å‚æ•° T åªå…·æœ‰ ä¸€ç§ ç±»å‹é™å®šæ–¹å¼ï¼š 1T extends A ä½†æ˜¯é€šé…ç¬¦ ? å¯ä»¥è¿›è¡Œ ä¸¤ç§é™å®šï¼š 1? extends A? super A ** Class å’Œ Class&lt;?&gt; åŒºåˆ«**å‰é¢ä»‹ç»äº† ï¼Ÿå’Œ T çš„åŒºåˆ«ï¼Œé‚£ä¹ˆå¯¹äºï¼ŒClass å’Œ &lt;Class åˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼ŸClass å’Œ Class æœ€å¸¸è§çš„æ˜¯åœ¨åå°„åœºæ™¯ä¸‹çš„ä½¿ç”¨ï¼Œè¿™é‡Œä»¥ç”¨ä¸€æ®µå‘å°„çš„ä»£ç æ¥è¯´æ˜ä¸‹ã€‚ 123// é€šè¿‡åå°„çš„æ–¹å¼ç”Ÿæˆ multiLimit // å¯¹è±¡ï¼Œè¿™é‡Œæ¯”è¾ƒæ˜æ˜¾çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢MultiLimit multiLimit = (MultiLimit)Class.forName(&quot;com.glmapper.bridge.boot.generic.MultiLimit&quot;).newInstance(); å¯¹äºä¸Šè¿°ä»£ç ï¼Œåœ¨è¿è¡ŒæœŸï¼Œå¦‚æœåå°„çš„ç±»å‹ä¸æ˜¯ MultiLimit ç±»ï¼Œé‚£ä¹ˆä¸€å®šä¼šæŠ¥ java.lang.ClassCastException é”™è¯¯ã€‚ å¯¹äºè¿™ç§æƒ…å†µï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥ä»£æ›¿ï¼Œä½¿å¾—åœ¨åœ¨ç¼–è¯‘æœŸå°±èƒ½ç›´æ¥ æ£€æŸ¥åˆ°ç±»å‹çš„é—®é¢˜ï¼š Class åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼ŒT è¦æ›¿æ¢æˆå…·ä½“ç±»ã€‚Class&lt;?&gt; å®ƒæ˜¯ä¸ªé€šé…æ³›å‹ï¼Œ? å¯ä»¥ä»£è¡¨ä»»ä½•ç±»å‹ï¼Œæ‰€ä»¥ä¸»è¦ç”¨äºå£°æ˜æ—¶çš„é™åˆ¶æƒ…å†µã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšç”³æ˜ï¼š 1234// å¯ä»¥public Class&lt;?&gt; clazz;// ä¸å¯ä»¥ï¼Œå› ä¸º T éœ€è¦æŒ‡å®šç±»å‹public Class&lt;T&gt; clazzT; æ‰€ä»¥å½“ä¸çŸ¥é“å®šå£°æ˜ä»€ä¹ˆç±»å‹çš„ Class çš„æ—¶å€™å¯ä»¥å®šä¹‰ä¸€ ä¸ªClass&lt;?&gt;ã€‚ é‚£å¦‚æœä¹Ÿæƒ³ public Class clazzT; è¿™æ ·çš„è¯ï¼Œå°±å¿…é¡»è®©å½“å‰çš„ç±»ä¹ŸæŒ‡å®š T ï¼Œ 123public class Test3&lt;T&gt; &#123; public Class&lt;?&gt; clazz; // ä¸ä¼šæŠ¥é”™ public Class&lt;T&gt; clazzT; å°ç»“æœ¬æ–‡é›¶ç¢æ•´ç†äº†ä¸‹ JAVA æ³›å‹ä¸­çš„ä¸€äº›ç‚¹ï¼Œä¸æ˜¯å¾ˆå…¨ï¼Œä»…ä¾›å‚è€ƒã€‚","tags":["Java","æ³›å‹"],"categories":["Java"]},{"title":"Dockerä»å…¥é—¨åˆ°å¹²æ´»ï¼Œçœ‹è¿™ä¸€ç¯‡è¶³çŸ£","path":"/2023/12/24/Dockerä»å…¥é—¨åˆ°å¹²æ´»ï¼Œçœ‹è¿™ä¸€ç¯‡è¶³çŸ£/","content":"1. å®¹å™¨ç®€ä»‹1.1. ä»€ä¹ˆæ˜¯ Linux å®¹å™¨Linuxå®¹å™¨æ˜¯ä¸ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†éš”ç¦»å¼€çš„ä¸€ç³»åˆ—è¿›ç¨‹ï¼Œä»å¦ä¸€ä¸ªé•œåƒè¿è¡Œï¼Œå¹¶ç”±è¯¥é•œåƒæä¾›æ”¯æŒè¿›ç¨‹æ‰€éœ€çš„å…¨éƒ¨æ–‡ä»¶ã€‚ å®¹å™¨æä¾›çš„é•œåƒåŒ…å«äº†åº”ç”¨çš„æ‰€æœ‰ä¾èµ–é¡¹ï¼Œå› è€Œåœ¨ä»å¼€å‘åˆ°æµ‹è¯•å†åˆ°ç”Ÿäº§çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒéƒ½å…·æœ‰å¯ç§»æ¤æ€§å’Œä¸€è‡´æ€§ã€‚ æ›´åŠ è¯¦ç»†åœ°æ¥è¯´ï¼Œè¯·æ‚¨å‡å®šæ‚¨åœ¨å¼€å‘ä¸€ä¸ªåº”ç”¨ã€‚æ‚¨ä½¿ç”¨çš„æ˜¯ä¸€å°ç¬”è®°æœ¬ç”µè„‘ï¼Œè€Œä¸”æ‚¨çš„å¼€å‘ç¯å¢ƒå…·æœ‰ç‰¹å®šçš„é…ç½®ã€‚å…¶ä»–å¼€å‘äººå‘˜èº«å¤„çš„ç¯å¢ƒé…ç½®å¯èƒ½ç¨æœ‰ä¸åŒã€‚æ‚¨æ­£åœ¨å¼€å‘çš„åº”ç”¨ä¾èµ–äºæ‚¨å½“å‰çš„é…ç½®ï¼Œè¿˜è¦ä¾èµ–äºæŸäº›ç‰¹å®šæ–‡ä»¶ã€‚ ä¸æ­¤åŒæ—¶ï¼Œæ‚¨çš„ä¼ä¸šè¿˜æ‹¥æœ‰æ ‡å‡†åŒ–çš„æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒï¼Œä¸”å…·æœ‰è‡ªèº«çš„é…ç½®å’Œä¸€ç³»åˆ—æ”¯æŒæ–‡ä»¶ã€‚ æ‚¨å¸Œæœ›å°½å¯èƒ½å¤šåœ¨æœ¬åœ°æ¨¡æ‹Ÿè¿™äº›ç¯å¢ƒï¼Œè€Œä¸äº§ç”Ÿé‡æ–°åˆ›å»ºæœåŠ¡å™¨ç¯å¢ƒçš„å¼€é”€ã€‚ å› æ­¤ï¼Œæ‚¨è¦å¦‚ä½•ç¡®ä¿åº”ç”¨èƒ½å¤Ÿåœ¨è¿™äº›ç¯å¢ƒä¸­è¿è¡Œå’Œé€šè¿‡è´¨é‡æ£€æµ‹ï¼Œå¹¶ä¸”åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸å‡ºç°ä»¤äººå¤´ç–¼çš„é—®é¢˜ï¼Œä¹Ÿæ— éœ€é‡æ–°ç¼–å†™ä»£ç å’Œè¿›è¡Œæ•…éšœä¿®å¤ï¼Ÿç­”æ¡ˆå°±æ˜¯ä½¿ç”¨å®¹å™¨ã€‚ å®¹å™¨å¯ä»¥ç¡®ä¿æ‚¨çš„åº”ç”¨æ‹¥æœ‰å¿…éœ€çš„é…ç½®å’Œæ–‡ä»¶ï¼Œä½¿å¾—è¿™äº›åº”ç”¨èƒ½å¤Ÿåœ¨ä»å¼€å‘åˆ°æµ‹è¯•ã€å†åˆ°ç”Ÿäº§çš„æ•´ä¸ªæµç¨‹ä¸­é¡ºåˆ©è¿è¡Œï¼Œè€Œä¸å‡ºç°ä»»ä½•ä¸è‰¯é—®é¢˜ã€‚è¿™æ ·å¯ä»¥é¿å…å±æœºï¼Œåšåˆ°çš†å¤§æ¬¢å–œã€‚ è™½ç„¶è¿™åªæ˜¯ç®€åŒ–çš„ç¤ºä¾‹ï¼Œä½†åœ¨éœ€è¦å¾ˆé«˜çš„å¯ç§»æ¤æ€§ã€å¯é…ç½®æ€§å’Œéš”ç¦»çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Linux å®¹å™¨é€šè¿‡å¾ˆå¤šæ–¹å¼è§£å†³éš¾é¢˜ã€‚ æ— è®ºåŸºç¡€æ¶æ„æ˜¯åœ¨ä¼ä¸šå†…éƒ¨è¿˜æ˜¯åœ¨äº‘ç«¯ï¼Œæˆ–è€…æ··åˆä½¿ç”¨ä¸¤è€…ï¼Œå®¹å™¨éƒ½èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚ 1.2. å®¹å™¨ä¸å°±æ˜¯è™šæ‹ŸåŒ–å—æ˜¯ï¼Œä½†ä¹Ÿä¸ç«Ÿç„¶ã€‚æˆ‘ä»¬ç”¨ä¸€ç§ç®€å•æ–¹å¼æ¥æ€è€ƒä¸€ä¸‹ï¼š è™šæ‹ŸåŒ–ä½¿å¾—è®¸å¤šæ“ä½œç³»ç»Ÿå¯åŒæ—¶åœ¨å•ä¸ªç³»ç»Ÿä¸Šè¿è¡Œã€‚ å®¹å™¨åˆ™å¯å…±äº«åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå°†åº”ç”¨è¿›ç¨‹ä¸ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†éš”ç¦»å¼€ã€‚ å›¾ - æ™®é€šè™šæ‹ŸåŒ–æŠ€æœ¯å’ŒDockerçš„å¯¹æ¯” è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿé¦–å…ˆï¼Œè®©å¤šä¸ªæ“ä½œç³»ç»Ÿåœ¨å•ä¸ªè™šæ‹Ÿæœºç›‘æ§ç¨‹åºä¸Šè¿è¡Œä»¥å®ç°è™šæ‹ŸåŒ–ï¼Œå¹¶ä¸èƒ½è¾¾æˆå’Œä½¿ç”¨å®¹å™¨åŒç­‰çš„è½»é‡çº§æ•ˆæœã€‚ äº‹å®ä¸Šï¼Œåœ¨ä»…æ‹¥æœ‰å®¹é‡æœ‰é™çš„æœ‰é™èµ„æºæ—¶ï¼Œæ‚¨éœ€è¦èƒ½å¤Ÿå¯ä»¥è¿›è¡Œå¯†é›†éƒ¨ç½²çš„è½»é‡çº§åº”ç”¨ã€‚ Linux å®¹å™¨å¯ä»å•ä¸ªæ“ä½œç³»ç»Ÿè¿è¡Œï¼Œåœ¨æ‰€æœ‰å®¹å™¨ä¸­å…±äº«è¯¥æ“ä½œç³»ç»Ÿï¼Œå› æ­¤åº”ç”¨å’ŒæœåŠ¡èƒ½å¤Ÿä¿æŒè½»é‡çº§ï¼Œå¹¶è¡Œå¿«é€Ÿè¿è¡Œã€‚ 1.3. å®¹å™¨å‘å±•ç®€å² æˆ‘ä»¬ç°åœ¨ç§°ä¸ºå®¹å™¨æŠ€æœ¯çš„æ¦‚å¿µæœ€åˆå‡ºç°åœ¨ 2000 å¹´ï¼Œå½“æ—¶ç§°ä¸º FreeBSD jailï¼Œè¿™ç§æŠ€æœ¯å¯å°† FreeBSD ç³»ç»Ÿåˆ†åŒºä¸ºå¤šä¸ªå­ç³»ç»Ÿï¼ˆä¹Ÿç§°ä¸º Jailï¼‰ã€‚ Jail æ˜¯ä½œä¸ºå®‰å…¨ç¯å¢ƒè€Œå¼€å‘çš„ï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯ä¸ä¼ä¸šå†…éƒ¨æˆ–å¤–éƒ¨çš„å¤šä¸ªç”¨æˆ·å…±äº«è¿™äº› Jailã€‚ Jail çš„ç›®çš„æ˜¯è®©è¿›ç¨‹åœ¨ç»è¿‡ä¿®æ”¹çš„ chroot ç¯å¢ƒä¸­åˆ›å»ºï¼Œè€Œä¸ä¼šè„±ç¦»å’Œå½±å“æ•´ä¸ªç³»ç»Ÿ â€” åœ¨ chroot ç¯å¢ƒä¸­ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå’Œç”¨æˆ·çš„è®¿é—®éƒ½å®ç°äº†è™šæ‹ŸåŒ–ã€‚ å°½ç®¡ Jail åœ¨å®æ–½æ–¹é¢å­˜åœ¨å±€é™æ€§ï¼Œä½†æœ€ç»ˆäººä»¬æ‰¾åˆ°äº†è„±ç¦»è¿™ç§éš”ç¦»ç¯å¢ƒçš„æ–¹æ³•ã€‚ ä½†è¿™ä¸ªæ¦‚å¿µéå¸¸æœ‰å¸å¼•åŠ›ã€‚ 2001 å¹´ï¼Œé€šè¿‡ Jacques GÃ©linas çš„ VServer é¡¹ç›®ï¼Œéš”ç¦»ç¯å¢ƒçš„å®æ–½è¿›å…¥äº† Linux é¢†åŸŸã€‚ æ­£å¦‚ GÃ©linas æ‰€è¯´ï¼Œè¿™é¡¹å·¥ä½œçš„ç›®çš„æ˜¯â€œåœ¨é«˜åº¦ç‹¬ç«‹ä¸”å®‰å…¨çš„å•ä¸€ç¯å¢ƒä¸­è¿è¡Œå¤šä¸ªé€šç”¨ Linux æœåŠ¡å™¨ [sic]ã€‚â€ åœ¨å®Œæˆäº†è¿™é¡¹é’ˆå¯¹ Linux ä¸­å¤šä¸ªå—æ§åˆ¶ç”¨æˆ·ç©ºé—´çš„åŸºç¡€æ€§å·¥ä½œåï¼ŒLinux å®¹å™¨å¼€å§‹é€æ¸æˆå½¢å¹¶æœ€ç»ˆå‘å±•æˆäº†ç°åœ¨çš„æ¨¡æ ·ã€‚ 2. ä»€ä¹ˆæ˜¯ Dockerï¼Ÿâ€œDockerâ€ ä¸€è¯æŒ‡ä»£å¤šç§äº‹ç‰©ï¼ŒåŒ…æ‹¬å¼€æºç¤¾åŒºé¡¹ç›®ã€å¼€æºé¡¹ç›®ä½¿ç”¨çš„å·¥å…·ã€ä¸»å¯¼æ”¯æŒæ­¤ç±»é¡¹ç›®çš„å…¬å¸ Docker Inc. ä»¥åŠè¯¥å…¬å¸å®˜æ–¹æ”¯æŒçš„å·¥å…·ã€‚æŠ€æœ¯äº§å“å’Œå…¬å¸ä½¿ç”¨åŒä¸€åç§°ï¼Œçš„ç¡®è®©äººæœ‰ç‚¹å›°æƒ‘ã€‚ ğŸ IT è½¯ä»¶ä¸­æ‰€è¯´çš„ â€œDockerâ€ ï¼Œæ˜¯æŒ‡å®¹å™¨åŒ–æŠ€æœ¯ï¼Œç”¨äºæ”¯æŒåˆ›å»ºå’Œä½¿ç”¨ Linux å®¹å™¨ã€‚ ğŸ å¼€æº Docker ç¤¾åŒºè‡´åŠ›äºæ”¹è¿›è¿™ç±»æŠ€æœ¯ï¼Œå¹¶å…è´¹æä¾›ç»™æ‰€æœ‰ç”¨æˆ·ï¼Œä½¿ä¹‹è·ç›Šã€‚ ğŸ Docker Inc. å…¬å¸å‡­å€Ÿ Docker ç¤¾åŒºäº§å“èµ·å®¶ï¼Œå®ƒä¸»è¦è´Ÿè´£æå‡ç¤¾åŒºç‰ˆæœ¬çš„å®‰å…¨æ€§ï¼Œå¹¶å°†æ”¹è¿›åçš„ç‰ˆæœ¬ä¸æ›´å¹¿æ³›çš„æŠ€æœ¯ç¤¾åŒºåˆ†äº«ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜ä¸“é—¨å¯¹è¿™äº›æŠ€æœ¯äº§å“è¿›è¡Œå®Œå–„å’Œå®‰å…¨å›ºåŒ–ï¼Œä»¥æœåŠ¡äºä¼ä¸šå®¢æˆ·ã€‚ å€ŸåŠ© Docker ï¼Œæ‚¨å¯å°†å®¹å™¨å½“åšé‡é‡è½»ã€æ¨¡å—åŒ–çš„è™šæ‹Ÿæœºä½¿ç”¨ã€‚åŒæ—¶ï¼Œæ‚¨è¿˜å°†è·å¾—é«˜åº¦çš„çµæ´»æ€§ï¼Œä»è€Œå®ç°å¯¹å®¹å™¨çš„é«˜æ•ˆåˆ›å»ºã€éƒ¨ç½²åŠå¤åˆ¶ï¼Œå¹¶èƒ½å°†å…¶ä»ä¸€ä¸ªç¯å¢ƒé¡ºåˆ©è¿ç§»è‡³å¦ä¸€ä¸ªç¯å¢ƒã€‚ 2.1. Docker å¦‚ä½•å·¥ä½œï¼ŸDocker æŠ€æœ¯ä½¿ç”¨ Linux å†…æ ¸å’Œå†…æ ¸åŠŸèƒ½ï¼ˆä¾‹å¦‚ Cgroups å’Œ namespacesï¼‰æ¥åˆ†éš”è¿›ç¨‹ï¼Œä»¥ä¾¿å„è¿›ç¨‹ç›¸äº’ç‹¬ç«‹è¿è¡Œã€‚ è¿™ç§ç‹¬ç«‹æ€§æ­£æ˜¯é‡‡ç”¨å®¹å™¨çš„ç›®çš„æ‰€åœ¨ï¼›å®ƒå¯ä»¥ç‹¬ç«‹è¿è¡Œå¤šç§è¿›ç¨‹ã€å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œæ›´åŠ å……åˆ†åœ°å‘æŒ¥åŸºç¡€è®¾æ–½çš„ä½œç”¨ï¼ŒåŒæ—¶ä¿æŒå„ä¸ªç‹¬ç«‹ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚ å®¹å™¨å·¥å…·ï¼ˆåŒ…æ‹¬ Dockerï¼‰å¯æä¾›åŸºäºé•œåƒçš„éƒ¨ç½²æ¨¡å¼ã€‚è¿™ä½¿å¾—å®ƒèƒ½å¤Ÿè½»æ¾è·¨å¤šç§ç¯å¢ƒï¼Œä¸å…¶ä¾èµ–ç¨‹åºå…±äº«åº”ç”¨æˆ–æœåŠ¡ç»„ã€‚Docker è¿˜å¯åœ¨è¿™ä¸€å®¹å™¨ç¯å¢ƒä¸­è‡ªåŠ¨éƒ¨ç½²åº”ç”¨ç¨‹åºï¼ˆæˆ–è€…åˆå¹¶å¤šç§æµç¨‹ï¼Œä»¥æ„å»ºå•ä¸ªåº”ç”¨ç¨‹åºï¼‰ã€‚ æ­¤å¤–ï¼Œç”±äºè¿™äº›å·¥å…·åŸºäº Linux å®¹å™¨æ„å»ºï¼Œä½¿å¾— Docker æ—¢æ˜“äºä½¿ç”¨ï¼Œåˆåˆ«å…·ä¸€æ ¼ â€”â€” å®ƒå¯ä¸ºç”¨æˆ·æä¾›å‰æ‰€æœªæœ‰çš„é«˜åº¦åº”ç”¨ç¨‹è®¿é—®æƒé™ã€å¿«é€Ÿéƒ¨ç½²ä»¥åŠç‰ˆæœ¬æ§åˆ¶å’Œåˆ†å‘èƒ½åŠ›ã€‚ 2.2. Docker æŠ€æœ¯æ˜¯å¦ä¸ä¼ ç»Ÿçš„ Linux å®¹å™¨ç›¸åŒï¼Ÿå¦ã€‚Docker æŠ€æœ¯æœ€åˆæ˜¯åŸºäº LXC æŠ€æœ¯æ„å»ºï¼ˆå¤§å¤šæ•°äººéƒ½ä¼šå°†è¿™ä¸€æŠ€æœ¯ä¸â€œä¼ ç»Ÿçš„â€ Linux å®¹å™¨è”ç³»åœ¨ä¸€èµ·ï¼‰ï¼Œä½†åæ¥å®ƒé€æ¸æ‘†è„±äº†å¯¹è¿™ç§æŠ€æœ¯çš„ä¾èµ–ã€‚ å°±è½»é‡çº§ è™šæ‹ŸåŒ– è¿™ä¸€åŠŸèƒ½æ¥çœ‹ï¼ŒLXC éå¸¸æœ‰ç”¨ï¼Œä½†å®ƒæ— æ³•æä¾›å‡ºè‰²çš„å¼€å‘äººå‘˜æˆ–ç”¨æˆ·ä½“éªŒã€‚é™¤äº†è¿è¡Œå®¹å™¨ä¹‹å¤–ï¼ŒDocker æŠ€æœ¯è¿˜å…·å¤‡å…¶ä»–å¤šé¡¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç®€åŒ–ç”¨äºæ„å»ºå®¹å™¨ã€ä¼ è¾“é•œåƒä»¥åŠæ§åˆ¶é•œåƒç‰ˆæœ¬çš„æµç¨‹ã€‚ ä¼ ç»Ÿçš„ Linux å®¹å™¨ä½¿ç”¨ init ç³»ç»Ÿæ¥ç®¡ç†å¤šç§è¿›ç¨‹ã€‚è¿™æ„å‘³ç€ï¼Œæ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿è¡Œã€‚ä¸æ­¤ç›¸åï¼ŒDocker æŠ€æœ¯é¼“åŠ±åº”ç”¨ç¨‹åºå„è‡ªç‹¬ç«‹è¿è¡Œå…¶è¿›ç¨‹ï¼Œå¹¶æä¾›ç›¸åº”å·¥å…·ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚è¿™ç§ç²¾ç»†åŒ–è¿ä½œæ¨¡å¼è‡ªæœ‰å…¶ä¼˜åŠ¿ã€‚ 2.3. dockerçš„ç›®æ ‡dockerçš„ä¸»è¦ç›®æ ‡æ˜¯â€Build,Ship and Run any App,Angwhereâ€,æ„å»ºï¼Œè¿è¾“ï¼Œå¤„å¤„è¿è¡Œ æ„å»ºï¼šåšä¸€ä¸ªdockeré•œåƒ è¿è¾“ï¼šdocker pull è¿è¡Œï¼šå¯åŠ¨ä¸€ä¸ªå®¹å™¨ æ¯ä¸€ä¸ªå®¹å™¨ï¼Œä»–éƒ½æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿrootfs. 3. å®‰è£…Dockerç¯å¢ƒè¯´æ˜ 123456789# éœ€è¦ä¸¤å°å‡ ç‚¹è¿›è¡Œå®‰è£…[root@docker01 ~]# cat /etc/redhat-release CentOS Linux release 7.2.1511 (Core) [root@docker01 ~]# uname -r 3.10.0-327.el7.x86_64[root@docker01 ~]# hostname -I10.0.0.100 172.16.1.100 [root@docker02 ~]# hostname -I10.0.0.101 172.16.1.101 åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è¿›è¡Œæ“ä½œ 123wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.reposed -i &#x27;s#download.docker.com#mirrors.ustc.edu.cn/docker-ce#g&#x27; /etc/yum.repos.d/docker-ce.repoyum install docker-ce -y ä¿®æ”¹åœ¨docker01é…ç½®ï¼š 1234567# ä¿®æ”¹å¯åŠ¨æ–‡ä»¶ï¼Œç›‘å¬è¿œç¨‹ç«¯å£vim /usr/lib/systemd/system/docker.serviceExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://10.0.0.100:2375systemctl daemon-reloadsystemctl enable docker.service systemctl restart docker.service# ps -efæ£€æŸ¥è¿›è¡Œï¼Œæ˜¯å¦å¯åŠ¨ åœ¨docker02æµ‹è¯• 123456789[root@docker02 ~]# docker -H 10.0.0.100 infoContainers: 0 Running: 0 Paused: 0 Stopped: 0Images: 0Server Version: 17.12.0-ceStorage Driver: devicemapperÂ·Â·Â· 3.1. DockeråŸºç¡€å‘½ä»¤æ“ä½œæŸ¥çœ‹dockerç›¸å…³ä¿¡æ¯ 1234567891011121314151617[root@docker01 ~]# docker version Client: Version: 17.12.0-ce API version: 1.35 Go version: go1.9.2 Git commit: c97c6d6 Built: Wed Dec 27 20:10:14 2017 OS/Arch: linux/amd64Server: Engine: Version: 17.12.0-ce API version: 1.35 (minimum version 1.12) Go version: go1.9.2 Git commit: c97c6d6 Built: Wed Dec 27 20:12:46 2017 OS/Arch: linux/amd64 Experimental: false é…ç½®dockeré•œåƒåŠ é€Ÿ 1234vi /etc/docker/daemon.json&#123; &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;]&#125; 3.2. å¯åŠ¨ç¬¬ä¸€ä¸ªå®¹å™¨12345678910[root@docker01 ~]# docker run -d -p 80:80 nginxUnable to find image &#x27;nginx:latest&#x27; locallylatest: Pulling from library/nginxe7bb522d92ff: Pull complete 6edc05228666: Pull complete cd866a17e81f: Pull complete Digest: sha256:285b49d42c703fdf257d1e2422765c4ba9d3e37768d6ea83d7fe2043dad6e63dStatus: Downloaded newer image for nginx:latest8d8f81da12b5c10af6ba1a5d07f4abc041cb95b01f3d632c3d638922800b0b4d# å®¹å™¨å¯åŠ¨åï¼Œåœ¨æµè§ˆå™¨è¿›è¡Œè®¿é—®æµ‹è¯• å‚æ•°è¯´æ˜ 3.3. Dockeré•œåƒç”Ÿå‘½å‘¨æœŸ 4. Dockeré•œåƒç›¸å…³æ“ä½œ4.1. æœç´¢å®˜æ–¹ä»“åº“é•œåƒ1234[root@docker01 ~]# docker search centosNAME DESCRIPTION STARS OFFICIAL AUTOMATEDcentos The official build of CentOS. 3992 [OK] ansible/centos7-ansible Ansible on Centos7 105 [OK] åˆ—è¡¨è¯´æ˜ 4.2. è·å–é•œåƒæ ¹æ®é•œåƒåç§°æ‹‰å–é•œåƒ 1234[root@docker01 ~]# docker pull centosUsing default tag: latestlatest: Pulling from library/centosaf4b0a2388c6: Downloading 34.65MB/73.67MB æŸ¥çœ‹å½“å‰ä¸»æœºé•œåƒåˆ—è¡¨ 1234[root@docker01 ~]# docker image list REPOSITORY TAG IMAGE ID CREATED SIZEcentos latest ff426288ea90 3 weeks ago 207MBnginx latest 3f8a4339aadd 5 weeks ago 108MB æ‹‰ç¬¬ä¸‰æ–¹é•œåƒæ–¹æ³• 1docker pull index.tenxcloud.com/tenxcloud/httpd 4.3. å¯¼å‡ºé•œåƒ123456[root@docker01 ~]# docker image list REPOSITORY TAG IMAGE ID CREATED SIZEcentos latest ff426288ea90 3 weeks ago 207MBnginx latest 3f8a4339aadd 5 weeks ago 108MB# å¯¼å‡º[root@docker01 ~]# docker image save centos &gt; docker-centos.tar.gz 4.4. åˆ é™¤é•œåƒ1234[root@docker01 ~]# docker image rm centos:latest[root@docker01 ~]# docker image list REPOSITORY TAG IMAGE ID CREATED SIZEnginx latest 3f8a4339aadd 5 weeks ago 108MB 4.5. å¯¼å…¥é•œåƒ1234567[root@docker01 ~]# docker image load -i docker-centos.tar.gz e15afa4858b6: Loading layer 215.8MB/215.8MBLoaded image: centos:latest[root@docker01 ~]# docker image list REPOSITORY TAG IMAGE ID CREATED SIZEcentos latest ff426288ea90 3 weeks ago 207MBnginx latest 3f8a4339aadd 5 weeks ago 108MB 4.6. æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯1[root@docker01 ~]# docker image inspect centos 5. å®¹å™¨çš„æ—¥å¸¸ç®¡ç†5.1. å®¹å™¨çš„èµ·&#x2F;åœæœ€ç®€å•çš„è¿è¡Œä¸€ä¸ªå®¹å™¨ 1[root@docker01 ~]# docker run nginx åˆ›å»ºå®¹å™¨ï¼Œä¸¤æ­¥èµ°ï¼ˆä¸å¸¸ç”¨ï¼‰ 1234[root@docker01 ~]# docker create centos:latest /bin/bashbb7f32368ecf0492adb59e20032ab2e6cf6a563a0e6751e58930ee5f7aaef204[root@docker01 ~]# docker start stupefied_nobelstupefied_nobel å¿«é€Ÿå¯åŠ¨å®¹å™¨æ–¹æ³• 1[root@docker01 ~]# docker run centos:latest /usr/bin/sleep 20; å®¹å™¨å†…çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹å¿…é¡»ä¸€ç›´å¤„äºè¿è¡Œçš„çŠ¶æ€ï¼Œå¦åˆ™è¿™ä¸ªå®¹å™¨ï¼Œå°±ä¼šå¤„äºé€€å‡ºçŠ¶æ€ï¼ æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ 12345[root@docker01 ~]# docker container ls æˆ–[root@docker01 ~]# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES8708e93fd767 nginx &quot;nginx -g &#x27;daemon ofâ€¦&quot; 6 seconds ago Up 4 seconds 80/tcp keen_lewin æŸ¥çœ‹ä½ å®¹å™¨è¯¦ç»†ä¿¡æ¯&#x2F;ip 1[root@docker01 ~]# docker container inspect å®¹å™¨åç§°/id æŸ¥çœ‹ä½ æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬æœªè¿è¡Œçš„ï¼‰ 12345[root@docker01 ~]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES8708e93fd767 nginx &quot;nginx -g &#x27;daemon ofâ€¦&quot; 4 minutes ago Exited (0) 59 seconds ago keen_lewinf9f3e6af7508 nginx &quot;nginx -g &#x27;daemon ofâ€¦&quot; 5 minutes ago Exited (0) 5 minutes ago optimistic_haibt8d8f81da12b5 nginx &quot;nginx -g &#x27;daemon ofâ€¦&quot; 3 hours ago Exited (0) 3 hours ago lucid_bohr åœæ­¢å®¹å™¨ 123[root@docker01 ~]# docker stop å®¹å™¨åç§°/id æˆ–[root@docker01 ~]# docker container kill å®¹å™¨åç§°/id 5.2. è¿›å…¥å®¹å™¨æ–¹æ³•å¯åŠ¨æ—¶è¿›å»æ–¹æ³• 123[root@docker01 ~]# docker run -it #å‚æ•°ï¼š-it å¯äº¤äº’ç»ˆç«¯[root@docker01 ~]# docker run -it nginx:latest /bin/bashroot@79241093859e:/# é€€å‡º&#x2F;ç¦»å¼€å®¹å™¨ 1ctrl+p &amp; ctrl+q å¯åŠ¨åè¿›å…¥å®¹å™¨çš„æ–¹æ³• å¯åŠ¨ä¸€ä¸ªdocker 12345[root@docker01 ~]# docker run -it centos:latest [root@1bf0f43c4d2f /]# ps -ef UID PID PPID C STIME TTY TIME CMDroot 1 0 0 15:47 pts/0 00:00:00 /bin/bashroot 13 1 0 15:47 pts/0 00:00:00 ps -ef attachè¿›å…¥å®¹å™¨ï¼Œä½¿ç”¨pts&#x2F;0 ï¼Œä¼šè®©æ‰€ç”¨é€šè¿‡æ­¤æ–¹æ³•è¿›å¦‚æ”¾å…¥ç”¨æˆ·çœ‹åˆ°åŒæ ·çš„æ“ä½œã€‚ 12345[root@docker01 ~]# docker attach 1bf0f43c4d2f[root@1bf0f43c4d2f /]# ps -ef UID PID PPID C STIME TTY TIME CMDroot 1 0 0 15:47 pts/0 00:00:00 /bin/bashroot 14 1 0 15:49 pts/0 00:00:00 ps -ef è‡ªå‘½åå¯åŠ¨ä¸€ä¸ªå®¹å™¨ â€“name 12345[root@docker01 ~]# docker attach 1bf0f43c4d2f[root@1bf0f43c4d2f /]# ps -ef UID PID PPID C STIME TTY TIME CMDroot 1 0 0 15:47 pts/0 00:00:00 /bin/bashroot 14 1 0 15:49 pts/0 00:00:00 ps -ef exec è¿›å…¥å®¹å™¨æ–¹æ³•ï¼ˆæ¨èä½¿ç”¨ï¼‰ 1234567[root@docker01 ~]# docker exec -it clsn1 /bin/bash [root@b20fa75b4b40 /]# é‡æ–°åˆ†é…ä¸€ä¸ªç»ˆç«¯[root@b20fa75b4b40 /]# ps -ef UID PID PPID C STIME TTY TIME CMDroot 1 0 0 16:11 pts/0 00:00:00 /bin/bashroot 13 0 0 16:14 pts/1 00:00:00 /bin/bashroot 26 13 0 16:14 pts/1 00:00:00 ps -ef 5.3. åˆ é™¤æ‰€æœ‰å®¹å™¨12[root@docker01 ~]# docker rm -f `docker ps -a -q`# -f å¼ºåˆ¶åˆ é™¤ 5.4. å¯åŠ¨æ—¶è¿›è¡Œç«¯å£æ˜ å°„-på‚æ•°ç«¯å£æ˜ å°„ 12[root@docker01 ~]# docker run -d -p 8888:80 nginx:latest 287bec5c60263166c03e1fc5b0b8262fe76507be3dfae4ce5cd2ee2d1e8a89a9 ä¸åŒæŒ‡å®šæ˜ å°„æ–¹æ³• éšæœºæ˜ å°„ 1docker run -P ï¼ˆå¤§Pï¼‰# éœ€è¦é•œåƒæ”¯æŒ 6. Docker æ•°æ®å·çš„ç®¡ç†6.1. æŒ‚è½½æ—¶åˆ›å»ºå·æŒ‚è½½å· 12[root@docker01 ~]# docker run -d -p 80:80 -v /data:/usr/share/nginx/html nginx:latest079786c1e297b5c5031e7a841160c74e91d4ad06516505043c60dbb78a259d09 å®¹å™¨å†…ç«™ç‚¹ç›®å½•: &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html åœ¨å®¿ä¸»æœºå†™å…¥æ•°æ®ï¼ŒæŸ¥çœ‹ 123[root@docker01 ~]# echo &quot;http://www.nmtui.com&quot; &gt;/data/index.html[root@docker01 ~]# curl 10.0.0.100http://www.nmtui.com è®¾ç½®å…±äº«å·ï¼Œä½¿ç”¨åŒä¸€ä¸ªå·å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ 1234[root@docker01 ~]# docker run -d -p 8080:80 -v /data:/usr/share/nginx/html nginx:latest 351f0bd78d273604bd0971b186979aa0f3cbf45247274493d2490527babb4e42[root@docker01 ~]# curl 10.0.0.100:8080http://www.nmtui.com æŸ¥çœ‹å·åˆ—è¡¨ 12[root@docker01 ~]# docker volume lsDRIVER VOLUME NAME 6.2. åˆ›å»ºå·åæŒ‚è½½åˆ›å»ºä¸€ä¸ªå· 12345[root@docker01 ~]# docker volume create f3b95f7bd17da220e63d4e70850b8d7fb3e20f8ad02043423a39fdd072b83521[root@docker01 ~]# docker volume ls DRIVER VOLUME NAMElocal f3b95f7bd17da220e63d4e70850b8d7fb3e20f8ad02043423a39fdd072b83521 æŒ‡å®šå·å 1234[root@docker01 ~]# docker volume ls DRIVER VOLUME NAMElocal clsnlocal f3b95f7bd17da220e63d4e70850b8d7fb3e20f8ad02043423a39fdd072b83521 æŸ¥çœ‹å·è·¯å¾„ 123456789101112[root@docker01 ~]# docker volume inspect clsn [ &#123; &quot;CreatedAt&quot;: &quot;2018-02-01T00:39:25+08:00&quot;, &quot;Driver&quot;: &quot;local&quot;, &quot;Labels&quot;: &#123;&#125;, &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/clsn/_data&quot;, &quot;Name&quot;: &quot;clsn&quot;, &quot;Options&quot;: &#123;&#125;, &quot;Scope&quot;: &quot;local&quot; &#125;] ä½¿ç”¨å·åˆ›å»º 123456[root@docker01 ~]# docker run -d -p 9000:80 -v clsn:/usr/share/nginx/html nginx:latest 1434559cff996162da7ce71820ed8f5937fb7c02113bbc84e965845c219d3503# å®¿ä¸»æœºæµ‹è¯•[root@docker01 ~]# echo &#x27;blog.nmtui.com&#x27; &gt;/var/lib/docker/volumes/clsn/_data/index.html [root@docker01 ~]# curl 10.0.0.100:9000blog.nmtui.com è®¾ç½®å· 12[root@docker01 ~]# docker run -d -P --volumes-from 079786c1e297 nginx:latest b54b9c9930b417ab3257c6e4a8280b54fae57043c0b76b9dc60b4788e92369fb æŸ¥çœ‹ä½¿ç”¨çš„ç«¯å£ 123456789101112[root@docker01 ~]# netstat -lntup Active Internet connections (only servers)Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 1400/sshd tcp 0 0 10.0.0.100:2375 0.0.0.0:* LISTEN 26218/dockerd tcp6 0 0 :::9000 :::* LISTEN 32015/docker-proxy tcp6 0 0 :::8080 :::* LISTEN 31853/docker-proxy tcp6 0 0 :::80 :::* LISTEN 31752/docker-proxy tcp6 0 0 :::22 :::* LISTEN 1400/sshd tcp6 0 0 :::32769 :::* LISTEN 32300/docker-proxy [root@docker01 ~]# curl 10.0.0.100:32769http://www.nmtui.com 6.3. æ‰‹åŠ¨å°†å®¹å™¨ä¿å­˜ä¸ºé•œåƒæœ¬æ¬¡æ˜¯åŸºäºdockerå®˜æ–¹centos 6.8 é•œåƒåˆ›å»º å®˜æ–¹é•œåƒåˆ—è¡¨ï¼š https://hub.docker.com/explore/ å¯åŠ¨ä¸€ä¸ªcentos6.8çš„é•œåƒ 123456[root@docker01 ~]# docker pull centos:6.8[root@docker01 ~]# docker run -it -p 1022:22 centos:6.8 /bin/bash# åœ¨å®¹å™¨ç§å®‰è£…sshdæœåŠ¡ï¼Œå¹¶ä¿®æ”¹ç³»ç»Ÿå¯†ç [root@582051b2b92b ~]# yum install openssh-server -y [root@582051b2b92b ~]# echo &quot;root:123456&quot; |chpasswd[root@582051b2b92b ~]# /etc/init.d/sshd start å¯åŠ¨å®Œæˆåé•œåƒsshè¿æ¥æµ‹è¯• å°†å®¹å™¨æäº¤ä¸ºé•œåƒ 1[root@docker01 ~]# docker commit brave_mcclintock centos6-ssh ä½¿ç”¨æ–°çš„é•œåƒå¯åŠ¨å®¹å™¨ 12[root@docker01 ~]# docker run -d -p 1122:22 centos6-ssh:latest /usr/sbin/sshd -D 5b8161fda2a9f2c39c196c67e2eb9274977e7723fe51c4f08a0190217ae93094 åœ¨å®¹å™¨å®‰è£…httpdæœåŠ¡ 1[root@5b8161fda2a9 /]# yum install httpd -y ç¼–å†™å¯åŠ¨è„šæœ¬è„šæœ¬ 123456[root@5b8161fda2a9 /]# cat init.sh #!/bin/bash /etc/init.d/httpd start /usr/sbin/sshd -D[root@5b8161fda2a9 /]# chmod +x init.sh # æ³¨æ„æ‰§è¡Œæƒé™ å†æ¬¡æäº¤ä¸ºæ–°çš„é•œåƒ 12[root@docker01 ~]# docker commit 5b8161fda2a9 centos6-httpd sha256:705d67a786cac040800b8485cf046fd57b1828b805c515377fc3e9cea3a481c1 å¯åŠ¨é•œåƒï¼Œåšå¥½ç«¯å£æ˜ å°„ã€‚å¹¶åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•è®¿é—® 12[root@docker01 ~]# docker run -d -p 1222:22 -p 80:80 centos6-httpd /init.sh 46fa6a06644e31701dc019fb3a8c3b6ef008d4c2c10d46662a97664f838d8c2c 7. Dockerfileè‡ªåŠ¨æ„å»ºdockeré•œåƒå®˜æ–¹æ„å»ºdockerffileæ–‡ä»¶å‚è€ƒ https://github.com/CentOS/CentOS-Dockerfiles 7.1. DockerfileæŒ‡ä»¤é›†dockerfileä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š åŸºç¡€é•œåƒä¿¡æ¯ FROM centos:6.8 åˆ¶ä½œé•œåƒæ“ä½œæŒ‡ä»¤RUN yum insatll openssh-server -y å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡ŒæŒ‡ä»¤ CMD [â€œ&#x2F;bin&#x2F;bashâ€] dockerfileå¸¸ç”¨æŒ‡ä»¤ï¼š FROM è¿™ä¸ªé•œåƒçš„å¦ˆå¦ˆæ˜¯è°ï¼Ÿï¼ˆæŒ‡å®šåŸºç¡€é•œåƒï¼‰ MAINTAINER å‘Šè¯‰åˆ«äººï¼Œè°è´Ÿè´£å…»å®ƒï¼Ÿï¼ˆæŒ‡å®šç»´æŠ¤è€…ä¿¡æ¯ï¼Œå¯ä»¥æ²¡æœ‰ï¼‰ RUN ä½ æƒ³è®©å®ƒå¹²å•¥ï¼ˆåœ¨å‘½ä»¤å‰é¢åŠ ä¸ŠRUNå³å¯ï¼‰ ADD ç»™å®ƒç‚¹åˆ›ä¸šèµ„é‡‘ï¼ˆCOPYæ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨è§£å‹ï¼‰ WORKDIR æˆ‘æ˜¯cd,ä»Šå¤©åˆšåŒ–äº†å¦†ï¼ˆè®¾ç½®å½“å‰å·¥ä½œç›®å½•ï¼‰ VOLUME ç»™å®ƒä¸€ä¸ªå­˜æ”¾è¡Œæçš„åœ°æ–¹ï¼ˆè®¾ç½®å·ï¼ŒæŒ‚è½½ä¸»æœºç›®å½•ï¼‰ EXPOSE å®ƒè¦æ‰“å¼€çš„é—¨æ˜¯å•¥ï¼ˆæŒ‡å®šå¯¹å¤–çš„ç«¯å£ï¼‰ CMD å¥”è·‘å§ï¼Œå…„å¼Ÿï¼ï¼ˆæŒ‡å®šå®¹å™¨å¯åŠ¨åçš„è¦å¹²çš„äº‹æƒ…ï¼‰ dockerfileå…¶ä»–æŒ‡ä»¤ï¼š COPY å¤åˆ¶æ–‡ä»¶ ENV ç¯å¢ƒå˜é‡ ENTRYPOINT å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ 7.2. åˆ›å»ºä¸€ä¸ªDockerfileåˆ›å»ºç¬¬ä¸€ä¸ªDockerfileæ–‡ä»¶ 123456789# åˆ›å»ºç›®å½•[root@docker01 base]# cd /opt/base# åˆ›å»ºDcokerfileæ–‡ä»¶ï¼Œæ³¨æ„å¤§å°å†™[root@docker01 base]# vim DockerfileFROM centos:6.8RUN yum install openssh-server -y RUN echo &quot;root:123456&quot; |chpasswdRUN /etc/init.d/sshd start CMD [&quot;/usr/sbin/sshd&quot;,&quot;-D&quot;] ä½¿ç”¨è‡ªæ„å»ºçš„é•œåƒå¯åŠ¨ 12[root@docker01 base]# docker image build -t centos6.8-ssh . -t ä¸ºé•œåƒæ ‡ç­¾æ‰“æ ‡ç­¾ . è¡¨ç¤ºå½“å‰è·¯å¾„ ä½¿ç”¨è‡ªæ„å»ºçš„é•œåƒå¯åŠ¨ 12[root@docker01 base]# docker run -d -p 2022:22 centos6.8-ssh-b dc3027d3c15dac881e8e2aeff80724216f3ac725f142daa66484f7cb5d074e7a 7.3. ä½¿ç”¨Dcokerfileå®‰è£…kodexplorerDockerfileæ–‡ä»¶å†…å®¹ 12345678FROM centos:6.8RUN yum install wget unzip php php-gd php-mbstring -y &amp;&amp; yum clean all# è®¾ç½®å·¥ä½œç›®å½•ï¼Œä¹‹åçš„æ“ä½œéƒ½åœ¨è¿™ä¸ªç›®å½•ä¸­WORKDIR /var/www/html/RUN wget -c http://static.kodcloud.com/update/download/kodexplorer4.25.zipRUN unzip kodexplorer4.25.zip &amp;&amp; rm -f kodexplorer4.25.zipRUN chown -R apache.apache .CMD [&quot;/usr/sbin/apachectl&quot;,&quot;-D&quot;,&quot;FOREGROUND&quot;] æ›´å¤šçš„Dockerfileå¯ä»¥å‚è€ƒå®˜æ–¹æ–¹æ³•ã€‚ 8. Dockerä¸­çš„é•œåƒåˆ†å±‚å‚è€ƒæ–‡æ¡£ï¼š http://www.maiziedu.com/wiki/cloud/dockerimage/ Docker æ”¯æŒé€šè¿‡æ‰©å±•ç°æœ‰é•œåƒï¼Œåˆ›å»ºæ–°çš„é•œåƒã€‚å®é™…ä¸Šï¼ŒDocker Hub ä¸­ 99% çš„é•œåƒéƒ½æ˜¯é€šè¿‡åœ¨ base é•œåƒä¸­å®‰è£…å’Œé…ç½®éœ€è¦çš„è½¯ä»¶æ„å»ºå‡ºæ¥çš„ã€‚ ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ–°é•œåƒæ˜¯ä» base é•œåƒä¸€å±‚ä¸€å±‚å åŠ ç”Ÿæˆçš„ã€‚æ¯å®‰è£…ä¸€ä¸ªè½¯ä»¶ï¼Œå°±åœ¨ç°æœ‰é•œåƒçš„åŸºç¡€ä¸Šå¢åŠ ä¸€å±‚ã€‚ 8.1. Docker é•œåƒä¸ºä»€ä¹ˆåˆ†å±‚é•œåƒåˆ†å±‚æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯å…±äº«èµ„æºã€‚ æ¯”å¦‚è¯´æœ‰å¤šä¸ªé•œåƒéƒ½ä»ç›¸åŒçš„ base é•œåƒæ„å»ºè€Œæ¥ï¼Œé‚£ä¹ˆ Docker Host åªéœ€åœ¨ç£ç›˜ä¸Šä¿å­˜ä¸€ä»½ base é•œåƒï¼›åŒæ—¶å†…å­˜ä¸­ä¹Ÿåªéœ€åŠ è½½ä¸€ä»½ base é•œåƒï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰å®¹å™¨æœåŠ¡äº†ã€‚è€Œä¸”é•œåƒçš„æ¯ä¸€å±‚éƒ½å¯ä»¥è¢«å…±äº«ã€‚ å¦‚æœå¤šä¸ªå®¹å™¨å…±äº«ä¸€ä»½åŸºç¡€é•œåƒï¼Œå½“æŸä¸ªå®¹å™¨ä¿®æ”¹äº†åŸºç¡€é•œåƒçš„å†…å®¹ï¼Œæ¯”å¦‚ &#x2F;etc ä¸‹çš„æ–‡ä»¶ï¼Œè¿™æ—¶å…¶ä»–å®¹å™¨çš„ &#x2F;etc æ˜¯ä¸ä¼šè¢«ä¿®æ”¹çš„ï¼Œä¿®æ”¹åªä¼šè¢«é™åˆ¶åœ¨å•ä¸ªå®¹å™¨å†…ã€‚è¿™å°±æ˜¯å®¹å™¨ Copy-on-Write ç‰¹æ€§ã€‚ 8.2. å¯å†™çš„å®¹å™¨å±‚å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¸€ä¸ªæ–°çš„å¯å†™å±‚è¢«åŠ è½½åˆ°é•œåƒçš„é¡¶éƒ¨ã€‚è¿™ä¸€å±‚é€šå¸¸è¢«ç§°ä½œâ€œå®¹å™¨å±‚â€ï¼Œâ€œå®¹å™¨å±‚â€ä¹‹ä¸‹çš„éƒ½å«â€œé•œåƒå±‚â€ã€‚ æ‰€æœ‰å¯¹å®¹å™¨çš„æ”¹åŠ¨ - æ— è®ºæ·»åŠ ã€åˆ é™¤ã€è¿˜æ˜¯ä¿®æ”¹æ–‡ä»¶éƒ½åªä¼šå‘ç”Ÿåœ¨å®¹å™¨å±‚ä¸­ã€‚åªæœ‰å®¹å™¨å±‚æ˜¯å¯å†™çš„ï¼Œå®¹å™¨å±‚ä¸‹é¢çš„æ‰€æœ‰é•œåƒå±‚éƒ½æ˜¯åªè¯»çš„ã€‚ 8.3. å®¹å™¨å±‚çš„ç»†èŠ‚è¯´æ˜é•œåƒå±‚æ•°é‡å¯èƒ½ä¼šå¾ˆå¤šï¼Œæ‰€æœ‰é•œåƒå±‚ä¼šè”åˆåœ¨ä¸€èµ·ç»„æˆä¸€ä¸ªç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿã€‚å¦‚æœä¸åŒå±‚ä¸­æœ‰ä¸€ä¸ªç›¸åŒè·¯å¾„çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ &#x2F;aï¼Œä¸Šå±‚çš„ &#x2F;a ä¼šè¦†ç›–ä¸‹å±‚çš„ &#x2F;aï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·åªèƒ½è®¿é—®åˆ°ä¸Šå±‚ä¸­çš„æ–‡ä»¶ &#x2F;aã€‚åœ¨å®¹å™¨å±‚ä¸­ï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªå åŠ ä¹‹åçš„æ–‡ä»¶ç³»ç»Ÿã€‚ æ–‡ä»¶æ“ä½œçš„ åªæœ‰å½“éœ€è¦ä¿®æ”¹æ—¶æ‰å¤åˆ¶ä¸€ä»½æ•°æ®ï¼Œè¿™ç§ç‰¹æ€§è¢«ç§°ä½œ Copy-on-Writeã€‚å¯è§ï¼Œå®¹å™¨å±‚ä¿å­˜çš„æ˜¯é•œåƒå˜åŒ–çš„éƒ¨åˆ†ï¼Œä¸ä¼šå¯¹é•œåƒæœ¬èº«è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚ è¿™æ ·å°±è§£é‡Šäº†æˆ‘ä»¬å‰é¢æå‡ºçš„é—®é¢˜ï¼šå®¹å™¨å±‚è®°å½•å¯¹é•œåƒçš„ä¿®æ”¹ï¼Œæ‰€æœ‰é•œåƒå±‚éƒ½æ˜¯åªè¯»çš„ï¼Œä¸ä¼šè¢«å®¹å™¨ä¿®æ”¹ï¼Œæ‰€ä»¥é•œåƒå¯ä»¥è¢«å¤šä¸ªå®¹å™¨å…±äº«ã€‚ 9. ä½¿ç”¨dockerè¿è¡Œzabbix-server9.1. å®¹å™¨é—´çš„äº’è”åœ¨è¿è¡Œzabbixä¹‹å‰åŠ¡å¿…è¦äº†è§£å®¹å™¨é—´äº’è”çš„æ–¹æ³• 123456# åˆ›å»ºä¸€ä¸ªnginxå®¹å™¨docker run -d -p 80:80 nginx# åˆ›å»ºå®¹å™¨ï¼Œåšlinkï¼Œå¹¶è¿›å…¥å®¹å™¨ä¸­docker run -it --link quirky_brown:web01 centos-ssh /bin/bash# åœ¨å®¹å™¨ä¸­è®¿é—®nginxå®¹å™¨å¯ä»¥pingé€šping web01 å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ 12345678910111213141516171819# å¯åŠ¨apacheå®¹å™¨[root@docker01 ~]# docker run -d httpd:2.4 3f1f7fc554720424327286bd2b04aeab1b084a3fb011a785b0deab6a34e56955^[[A[root@docker01 docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES3f1f7fc55472 httpd:2.4 &quot;httpd-foreground&quot; 6 seconds ago Up 5 seconds 80/tcp determined_clarke# æ‹‰å–ä¸€ä¸ªbusybox é•œåƒ[root@docker01 ~]# docker pull busybox # å¯åŠ¨å®¹å™¨[root@docker01 ~]# docker run -it --link determined_clarke:web busybox:latest /bin/sh / # # ä½¿ç”¨æ–°çš„å®¹å™¨è®¿é—®æœ€åˆçš„webå®¹å™¨/ # ping web PING web (172.17.0.2): 56 data bytes64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.058 ms^C--- web ping statistics ---1 packets transmitted, 1 packets received, 0% packet lossround-trip min/avg/max = 0.058/0.058/0.058 ms 9.2. å¯åŠ¨zabbixå®¹å™¨1ã€å¯åŠ¨ä¸€ä¸ªmysqlçš„å®¹å™¨ 1234567docker run --name mysql-server -t \\ -e MYSQL_DATABASE=&quot;zabbix&quot; \\ -e MYSQL_USER=&quot;zabbix&quot; \\ -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \\ -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \\ -d mysql:5.7 \\ --character-set-server=utf8 --collation-server=utf8_bin 2ã€å¯åŠ¨java-gatewayå®¹å™¨ç›‘æ§javaæœåŠ¡ 12docker run --name zabbix-java-gateway -t \\ -d zabbix/zabbix-java-gateway:latest 3ã€å¯åŠ¨zabbix-mysqlå®¹å™¨ä½¿ç”¨linkè¿æ¥mysqlä¸java-gatewayã€‚ 1234567891011docker run --name zabbix-server-mysql -t \\ -e DB_SERVER_HOST=&quot;mysql-server&quot; \\ -e MYSQL_DATABASE=&quot;zabbix&quot; \\ -e MYSQL_USER=&quot;zabbix&quot; \\ -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \\ -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \\ -e ZBX_JAVAGATEWAY=&quot;zabbix-java-gateway&quot; \\ --link mysql-server:mysql \\ --link zabbix-java-gateway:zabbix-java-gateway \\ -p 10051:10051 \\ -d zabbix/zabbix-server-mysql:latest 4ã€å¯åŠ¨zabbix webæ˜¾ç¤ºï¼Œä½¿ç”¨linkè¿æ¥zabbix-mysqlä¸mysqlã€‚ 12345678910docker run --name zabbix-web-nginx-mysql -t \\ -e DB_SERVER_HOST=&quot;mysql-server&quot; \\ -e MYSQL_DATABASE=&quot;zabbix&quot; \\ -e MYSQL_USER=&quot;zabbix&quot; \\ -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \\ -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \\ --link mysql-server:mysql \\ --link zabbix-server-mysql:zabbix-server \\ -p 80:80 \\ -d zabbix/zabbix-web-nginx-mysql:latest 9.3. å…³äºzabbix APIå…³äºzabbix APIå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š https://www.zabbix.com/documentation/3.4/zh/manual/api 1ã€è·å–tokenæ–¹æ³• 123456789101112# è·å–token[root@docker02 ~]# curl -s -X POST -H &#x27;Content-Type:application/json&#x27; -d &#x27;&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;,&quot;method&quot;: &quot;user.login&quot;,&quot;params&quot;: &#123;&quot;user&quot;: &quot;Admin&quot;,&quot;password&quot;: &quot;zabbix&quot;&#125;,&quot;id&quot;: 1&#125;&#x27; http://10.0.0.100/api_jsonrpc.php&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;d3be707f9e866ec5d0d1c242292cbebd&quot;,&quot;id&quot;:1&#125; 10. docker ä»“åº“ï¼ˆregistryï¼‰10.1. åˆ›å»ºä¸€ä¸ªæ™®é€šä»“åº“1ã€åˆ›å»ºä»“åº“ 1docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry 2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½¿ä¹‹æ”¯æŒhttp 12345[root@docker01 ~]# cat /etc/docker/daemon.json &#123; &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;], &quot;insecure-registries&quot;: [&quot;10.0.0.100:5000&quot;]&#125; é‡å¯dockerè®©ä¿®æ”¹ç”Ÿæ•ˆ 1[root@docker01 ~]# systemctl restart docker.service 3ã€ä¿®æ”¹é•œåƒæ ‡ç­¾ 123456[root@docker01 ~]# docker tag busybox:latest 10.0.0.100:5000/clsn/busybox:1.0[root@docker01 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEcentos6-ssh latest 3c2b1e57a0f5 18 hours ago 393MBhttpd 2.4 2e202f453940 6 days ago 179MB10.0.0.100:5000/clsn/busybox 1.0 5b0d59026729 8 days ago 1.15MB 4ã€å°†æ–°æ‰“æ ‡ç­¾çš„é•œåƒä¸Šä¼ é•œåƒåˆ°ä»“åº“ 1[root@docker01 ~]# docker push 10.0.0.100:5000/clsn/busybox 10.2. å¸¦basicè®¤è¯çš„ä»“åº“1ã€å®‰è£…åŠ å¯†å·¥å…· 1[root@docker01 clsn]# yum install httpd-tools -y 2ã€è®¾ç½®è®¤è¯å¯†ç  12mkdir /opt/registry-var/auth/ -phtpasswd -Bbn clsn 123456 &gt; /opt/registry-var/auth/htpasswd 3ã€å¯åŠ¨å®¹å™¨ï¼Œåœ¨å¯åŠ¨æ—¶ä¼ å…¥è®¤è¯å‚æ•° 1docker run -d -p 5000:5000 -v /opt/registry-var/auth/:/auth/ -e &quot;REGISTRY_AUTH=htpasswd&quot; -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd registry 4ã€ä½¿ç”¨éªŒè¯ç”¨æˆ·æµ‹è¯• 12345678910111213141516171819202122232425# ç™»é™†ç”¨æˆ·[root@docker01 ~]# docker login 10.0.0.100:5000 Username: clsn Password: 123456Login Succeeded# æ¨é€é•œåƒåˆ°ä»“åº“[root@docker01 ~]# docker push 10.0.0.100:5000/clsn/busybox The push refers to repository [10.0.0.100:5000/clsn/busybox]4febd3792a1f: Pushed 1.0: digest: sha256:4cee1979ba0bf7db9fc5d28fb7b798ca69ae95a47c5fecf46327720df4ff352d size: 527#è®¤è¯æ–‡ä»¶çš„ä¿å­˜ä½ç½®[root@docker01 ~]# cat .docker/config.json &#123; &quot;auths&quot;: &#123; &quot;10.0.0.100:5000&quot;: &#123; &quot;auth&quot;: &quot;Y2xzbjoxMjM0NTY=&quot; &#125;, &quot;https://index.docker.io/v1/&quot;: &#123; &quot;auth&quot;: &quot;Y2xzbjpIenNAMTk5Ng==&quot; &#125; &#125;, &quot;HttpHeaders&quot;: &#123; &quot;User-Agent&quot;: &quot;Docker-Client/17.12.0-ce (linux)&quot; &#125;&#125; è‡³æ­¤ï¼Œä¸€ä¸ªç®€å•çš„dockeré•œåƒä»“åº“æ­å»ºå®Œæˆ 11. docker-composeç¼–æ’å·¥å…·11.1. å®‰è£…docker-compose1234# ä¸‹è½½pipè½¯ä»¶yum install -y python2-pip# ä¸‹è½½ docker-composepip install docker-compose å›½å†…å¼€å¯pip ä¸‹è½½åŠ é€Ÿï¼š http://mirrors.aliyun.com/help/pypi 1234567mkdir ~/.pip/cat &gt; ~/.pip/pip.conf &lt;&lt;&#x27;EOF&#x27;[global]index-url = https://mirrors.aliyun.com/pypi/simple/[install]trusted-host=mirrors.aliyun.comEOF 11.2. ç¼–æ’å¯åŠ¨é•œåƒ1ã€åˆ›å»ºæ–‡ä»¶ç›®å½• 12[root@docker01 ~]# mkdir /opt/my_wordpress/[root@docker01 ~]# cd /opt/my_wordpress/ 2ã€ç¼–å†™ç¼–æ’æ–‡ä»¶ 1234567891011121314151617181920212223242526[root@docker01 my_wordpress]# vim docker-compose.ymlversion: &#x27;3&#x27;services: db: image: mysql:5.7 volumes: - /data/db_data:/var/lib/mysql restart: always environment: MYSQL_ROOT_PASSWORD: somewordpress MYSQL_DATABASE: wordpress MYSQL_USER: wordpress MYSQL_PASSWORD: wordpress wordpress: depends_on: - db image: wordpress:latest volumes: - /data/web_data:/var/www/html ports: - &quot;8000:80&quot; restart: always environment: WORDPRESS_DB_HOST: db:3306 WORDPRESS_DB_USER: wordpress WORDPRESS_DB_PASSWORD: wordpress 3ã€å¯åŠ¨ 123[root@docker01 my_wordpress]# docker-compose up #å¯åŠ¨æ–¹æ³•ï¼šdocker-compose up #åå°å¯åŠ¨æ–¹æ³•ï¼šdocker-compose up -d 4ã€æµè§ˆå™¨ä¸Šè®¿é—®http://10.0.0.100:8000 è¿›è¡Œwordpressçš„å®‰è£…å³å¯ 11.3. haproxyä»£ç†åç«¯dockerå®¹å™¨1ã€ä¿®æ”¹ç¼–æ’è„šæœ¬ 1234567891011121314151617181920212223242526[root@docker01 my_wordpress]# cat docker-compose.yml version: &#x27;3&#x27;services: db: image: mysql:5.7 volumes: - /data/db_data:/var/lib/mysql restart: always environment: MYSQL_ROOT_PASSWORD: somewordpress MYSQL_DATABASE: wordpress MYSQL_USER: wordpress MYSQL_PASSWORD: wordpress wordpress: depends_on: - db image: wordpress:latest volumes: - /data/web_data:/var/www/html ports: - &quot;80&quot; restart: always environment: WORDPRESS_DB_HOST: db:3306 WORDPRESS_DB_USER: wordpress WORDPRESS_DB_PASSWORD: wordpress 2ã€åŒæ—¶å¯åŠ¨ä¸¤å°wordpress 1234[root@docker01 my_wordpress]# docker-compose scale wordpress=2 WARNING: The scale command is deprecated. Use the up command with the --scale flag instead.Starting mywordpress_wordpress_1 ... doneCreating mywordpress_wordpress_2 ... done 3ã€å®‰è£…haproxy 1[root@docker01 ~]# yum install haproxy -y 4ã€ä¿®æ”¹haproxyé…ç½®æ–‡ä»¶ å…³äºé…ç½®æ–‡ä»¶çš„è¯¦ç»†è¯´æ˜ï¼Œå‚è€ƒï¼š https://www.cnblogs.com/MacoLee/p/5853413.html 12345678910111213141516171819202122232425262728293031323334353637383940414243444546[root@docker01 ~]#cp /etc/haproxy/haproxy.cfg&#123;,.bak&#125;[root@docker01 ~]# vim /etc/haproxy/haproxy.cfgglobal log 127.0.0.1 local2 chroot /var/lib/haproxy pidfile /var/run/haproxy.pid maxconn 4000 user haproxy group haproxy daemon stats socket /var/lib/haproxy/stats level admin #æ”¯æŒå‘½ä»¤è¡Œæ§åˆ¶defaults mode http log global option httplog option dontlognull option http-server-close option forwardfor except 127.0.0.0/8 option redispatch retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 3000listen stats mode http bind 0.0.0.0:8888 stats enable stats uri /haproxy-status stats auth admin:123456frontend frontend_www_example_com bind 10.0.0.100:8000 mode http option httplog log global default_backend backend_www_example_combackend backend_www_example_com option forwardfor header X-REAL-IP option httpchk HEAD / HTTP/1.0 balance roundrobin server web-node1 10.0.0.100:32768 check inter 2000 rise 30 fall 15 server web-node2 10.0.0.100:32769 check inter 2000 rise 30 fall 15 5ã€å¯åŠ¨haproxy 12systemctl start haproxysystemctl enable haproxy 6ã€ä½¿ç”¨æµè§ˆå™¨è®¿é—®hapeoxyç›‘å¬çš„8000ç«¯å£å¯ä»¥çœ‹åˆ°è´Ÿè½½çš„æƒ…å†µ 7ã€ä½¿ç”¨æµè§ˆå™¨è®¿é—® http://10.0.0.100:8888/haproxy-status å¯ä»¥çœ‹åˆ°åç«¯èŠ‚ç‚¹çš„ç›‘æ§çŠ¶å†µï¼Œ 11.4. å®‰è£…socat ç›´æ¥æ“ä½œsocketæ§åˆ¶haproxy1ã€å®‰è£…è½¯ä»¶ 1yum install socat.x86_64 -y 2ã€æŸ¥çœ‹å¸®åŠ© 1[root@docker01 web_data]# echo &quot;help&quot;|socat stdio /var/lib/haproxy/stats 3ã€ä¸‹çº¿åç«¯èŠ‚ç‚¹ 1echo &quot;disable server backend_www_example_com/web-node2&quot;|socat stdio /var/lib/haproxy/stats 4ã€ä¸Šçº¿åç«¯èŠ‚ç‚¹ 1echo &quot;enable server backend_www_example_com/web-node3&quot;|socat stdio /var/lib/haproxy/stats 5ã€ç¼–å†™phpæµ‹è¯•é¡µï¼Œæ”¾åˆ°&#x2F;data&#x2F;web_dataä¸‹ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®å¯ä»¥æŸ¥çœ‹å½“å‰çš„èŠ‚ç‚¹ 123456789101112[root@docker01 web_data]# vim check.php&lt;html&gt; &lt;head&gt; &lt;title&gt;PHPæµ‹è¯•&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;?php echo &#x27;&lt;p&gt;Hello World &lt;/p&gt;&#x27;; ?&gt; &lt;?php echo &quot;è®¿é—®çš„æœåŠ¡å™¨åœ°å€æ˜¯:&quot;.&quot;&lt;fontcolor=red&gt;&quot;.$_SERVER[&#x27;SERVER_ADDR&#x27;].&quot;&lt;/font&gt;&quot;.&quot;&lt;br&gt;&quot;; echo&quot;è®¿é—®çš„æœåŠ¡å™¨åŸŸåæ˜¯:&quot;.&quot;&lt;fontcolor=red&gt;&quot;.$_SERVER[&#x27;SERVER_NAME&#x27;].&quot;&lt;/font&gt;&quot;.&quot;&lt;br&gt;&quot;; ?&gt; &lt;/body&gt;&lt;/html&gt; 12. é‡å¯dockeræœåŠ¡ï¼Œå®¹å™¨å…¨éƒ¨é€€å‡ºçš„è§£å†³åŠæ³•12.1. åœ¨å¯åŠ¨æ˜¯æŒ‡å®šè‡ªåŠ¨é‡å¯1docker run --restart=always 12.1. ä¿®æ”¹dockeré»˜è®¤é…ç½®æ–‡ä»¶12# æ·»åŠ ä¸Šä¸‹é¢è¿™è¡Œ&quot;live-restore&quot;: true docker serveré…ç½®æ–‡ä»¶ &#x2F;etc&#x2F;docker&#x2F;daemon.json å‚è€ƒ 1234567[root@docker02 ~]# cat /etc/docker/daemon.json &#123; &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;], &quot;graph&quot;: &quot;/opt/mydocker&quot;, # ä¿®æ”¹æ•°æ®çš„å­˜æ”¾ç›®å½•åˆ°/opt/mydocker/ï¼ŒåŸ/var/lib/docker/ &quot;insecure-registries&quot;: [&quot;10.0.0.100:5000&quot;], &quot;live-restore&quot;: true&#125; é‡å¯ç”Ÿæ•ˆï¼Œåªå¯¹åœ¨æ­¤ä¹‹åå¯åŠ¨çš„å®¹å™¨ç”Ÿæ•ˆ 1[root@docker01 ~]# systemctl restart docker.service 13. Dockerç½‘ç»œç±»å‹ 13.1. dockerçš„ç½‘ç»œç±»å‹ Bridgeé»˜è®¤dockerç½‘ç»œéš”ç¦»åŸºäºç½‘ç»œå‘½åç©ºé—´ï¼Œåœ¨ç‰©ç†æœºä¸Šåˆ›å»ºdockerå®¹å™¨æ—¶ä¼šä¸ºæ¯ä¸€ä¸ªdockerå®¹å™¨åˆ†é…ç½‘ç»œå‘½åç©ºé—´ï¼Œå¹¶ä¸”æŠŠå®¹å™¨IPæ¡¥æ¥åˆ°ç‰©ç†æœºçš„è™šæ‹Ÿç½‘æ¡¥ä¸Šã€‚ 13.2. ä¸ä¸ºå®¹å™¨é…ç½®ç½‘ç»œåŠŸèƒ½æ­¤æ¨¡å¼ä¸‹åˆ›å»ºå®¹å™¨æ˜¯ä¸ä¼šä¸ºå®¹å™¨é…ç½®ä»»ä½•ç½‘ç»œå‚æ•°çš„ï¼Œå¦‚ï¼šå®¹å™¨ç½‘å¡ã€IPã€é€šä¿¡è·¯ç”±ç­‰ï¼Œå…¨éƒ¨éœ€è¦è‡ªå·±å»é…ç½®ã€‚ 123456[root@docker01 ~]# docker run -it --network none busybox:latest /bin/sh / # ip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 13.3. ä¸å…¶ä»–å®¹å™¨å…±äº«ç½‘ç»œé…ç½®(Containerï¼‰æ­¤æ¨¡å¼å’Œhostæ¨¡å¼å¾ˆç±»ä¼¼ï¼Œåªæ˜¯æ­¤æ¨¡å¼åˆ›å»ºå®¹å™¨å…±äº«çš„æ˜¯å…¶ä»–å®¹å™¨çš„IPå’Œç«¯å£è€Œä¸æ˜¯ç‰©ç†æœºï¼Œæ­¤æ¨¡å¼å®¹å™¨è‡ªèº«æ˜¯ä¸ä¼šé…ç½®ç½‘ç»œå’Œç«¯å£ï¼Œåˆ›å»ºæ­¤æ¨¡å¼å®¹å™¨è¿›å»åï¼Œä½ ä¼šå‘ç°é‡Œè¾¹çš„IPæ˜¯ä½ æ‰€æŒ‡å®šçš„é‚£ä¸ªå®¹å™¨IPå¹¶ä¸”ç«¯å£ä¹Ÿæ˜¯å…±äº«çš„ï¼Œè€Œä¸”å…¶å®ƒè¿˜æ˜¯äº’ç›¸éš”ç¦»çš„ï¼Œå¦‚è¿›ç¨‹ç­‰ã€‚ 12345678910[root@docker01 ~]# docker run -it --network container:mywordpress_db_1 busybox:latest /bin/sh / # ip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever105: eth0@if106: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff inet 172.18.0.3/16 brd 172.18.255.255 scope global eth0 valid_lft forever preferred_lft forever 13.4. ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œæ­¤æ¨¡å¼åˆ›å»ºçš„å®¹å™¨æ²¡æœ‰è‡ªå·±ç‹¬ç«‹çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œæ˜¯å’Œç‰©ç†æœºå…±äº«ä¸€ä¸ªNetwork Namespaceï¼Œå¹¶ä¸”å…±äº«ç‰©ç†æœºçš„æ‰€æœ‰ç«¯å£ä¸IPï¼Œå¹¶ä¸”è¿™ä¸ªæ¨¡å¼è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ã€‚ 1[root@docker01 ~]# docker run -it --network host busybox:latest /bin/shshell 13.5. æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨123456[root@docker01 ~]# docker network list NETWORK ID NAME DRIVER SCOPEb15e8a720d3b bridge bridge local345d65b4c2a0 host host localbc5e2a32bb55 mywordpress_default bridge localebf76eea91bb none null local ç”¨PIPEWORKä¸ºdockerå®¹å™¨é…ç½®ç‹¬ç«‹IP å‚è€ƒæ–‡æ¡£ï¼š blog.csdn.net&#x2F;design321&#x2F;article&#x2F;details&#x2F;48264825 å®˜æ–¹ç½‘ç«™ï¼š github.com&#x2F;jpetazzo&#x2F;pipework å®¿ä¸»ç¯å¢ƒï¼šcentos7.2 1ã€å®‰è£…pipework 1234wget https://github.com/jpetazzo/pipework/archive/master.zipunzip master.zip cp pipework-master/pipework /usr/local/bin/chmod +x /usr/local/bin/pipework 2ã€é…ç½®æ¡¥æ¥ç½‘å¡ å®‰è£…æ¡¥æ¥å·¥å…· 1yum install bridge-utils.x86_64 -y ä¿®æ”¹ç½‘å¡é…ç½®ï¼Œå®ç°æ¡¥æ¥ 1234567891011121314151617181920# ä¿®æ”¹eth0é…ç½®ï¼Œè®©br0å®ç°æ¡¥æ¥[root@docker01 ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0 TYPE=EthernetBOOTPROTO=staticNAME=eth0DEVICE=eth0ONBOOT=yesBRIDGE=br0[root@docker01 ~]# cat /etc/sysconfig/network-scripts/ifcfg-br0 TYPE=BridgeBOOTPROTO=staticNAME=br0DEVICE=br0ONBOOT=yesIPADDR=10.0.0.100NETMASK=255.255.255.0GATEWAY=10.0.0.254DNS1=223.5.5.5# é‡å¯ç½‘ç»œ[root@docker01 ~]# /etc/init.d/network restart 3ã€è¿è¡Œä¸€ä¸ªå®¹å™¨é•œåƒæµ‹è¯•ï¼š 1pipework br0 $(docker run -d -it -p 6880:80 --name httpd_pw httpd) 10.0.0.220/24@10.0.0.254 åœ¨å…¶ä»–ä¸»æœºä¸Šæµ‹è¯•ç«¯å£åŠè¿é€šæ€§ 12345[root@docker01 ~]# curl 10.0.0.220&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;[root@docker01 ~]# ping 10.0.0.220 -c 1PING 10.0.0.220 (10.0.0.220) 56(84) bytes of data.64 bytes from 10.0.0.220: icmp_seq=1 ttl=64 time=0.043 ms 4ã€å†è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œè®¾ç½®ç½‘è·¯ç±»å‹ä¸ºnoneï¼š 1pipework br0 $(docker run -d -it --net=none --name test httpd:2.4) 10.0.0.221/24@10.0.0.254 è¿›è¡Œè®¿é—®æµ‹è¯• 12[root@docker01 ~]# curl 10.0.0.221&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt; 5ã€é‡å¯å®¹å™¨åéœ€è¦å†æ¬¡æŒ‡å®šï¼š 12pipework br0 testduliip 172.16.146.113/24@172.16.146.1pipework br0 testduliip01 172.16.146.112/24@172.16.146.1 Dcokerè·¨ä¸»æœºé€šä¿¡ä¹‹overlayå¯ä»¥å‚è€ƒï¼š cnblogs.com&#x2F;CloudMan6&#x2F;p&#x2F;7270551.html 13.6. Dockerè·¨ä¸»æœºé€šä¿¡ä¹‹macvlanåˆ›å»ºç½‘ç»œ 12[root@docker01 ~]# docker network create --driver macvlan --subnet 10.1.0.0/24 --gateway 10.1.0.254 -o parent=eth0 macvlan_133a1f41dcc074f91b5bd45e7dfedabfb2b8ec82db16542f05213839a119b62ca è®¾ç½®ç½‘å¡ä¸ºæ··æ‚æ¨¡å¼ 1ip link set eth0 promisc on åˆ›å»ºä½¿ç”¨macvlanç½‘ç»œå®¹å™¨ 1[root@docker02 ~]# docker run -it --network macvlan_1 --ip=10.1.0.222 busybox /b 14. dockerä¼ä¸šçº§é•œåƒä»“åº“harborå®¹å™¨ç®¡ç† 123[root@docker01 harbor]# pwd/opt/harbor[root@docker01 harbor]# docker-compose stop 1ã€å®‰è£…dockerã€docker-compose ä¸‹è½½ harbor 12cd /opt &amp;&amp; https://storage.googleapis.com/harbor-releases/harbor-offline-installer-v1.3.0.tgztar xf harbor-offline-installer-v1.3.0.tgz 2ã€ä¿®æ”¹ä¸»æœºåŠwebç•Œé¢å¯†ç  12345[root@docker01 harbor]# vim harbor.cfg Â·Â·Â· hostname = 10.0.0.100 harbor_admin_password = Harbor12345 Â·Â·Â· 3ã€æ‰§è¡Œå®‰è£…è„šæœ¬ 1[root@docker01 harbor]# ./install.sh æµè§ˆå™¨è®¿é—® http://10.0.0.11 æ·»åŠ ä¸€ä¸ªé¡¹ç›® 4ã€é•œåƒæ¨é€åˆ°ä»“åº“çš„æŒ‡å®šé¡¹ç›® 1234567891011[root@docker02 ~]# docker tag centos:6.8 10.0.0.100/clsn/centos6.8:1.0[root@docker02 ~]# [root@docker02 ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZEbusybox latest 5b0d59026729 8 days ago 1.15MB10.0.0.100/clsn/centos6.8 1.0 6704d778b3ba 2 months ago 195MBcentos 6.8 6704d778b3ba 2 months ago 195MB[root@docker02 ~]# docker login 10.0.0.100Username: adminPassword: Login Succeeded 5ã€æ¨é€é•œåƒ 123[root@docker02 ~]# docker push 10.0.0.100/clsn/centos6.8 The push refers to repository [10.0.0.100/clsn/centos6.8]e00c9229b481: Pushing 13.53MB/194.5MB 6ã€åœ¨webç•Œé¢é‡ŒæŸ¥çœ‹ 14.1. ä½¿ç”¨å®¹å™¨çš„å»ºè®® ä¸è¦ä»¥æ‹†åˆ†æ–¹å¼è¿›è¡Œåº”ç”¨ç¨‹åºå‘å¸ƒ ä¸è¦åˆ›å»ºå¤§å‹é•œåƒ ä¸è¦åœ¨å•ä¸ªå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªè¿›ç¨‹ ä¸è¦å†é•œåƒå†…ä¿å­˜å‡­è¯ï¼Œä¸è¦ä¾èµ–IPåœ°å€ ä»¥érootç”¨æˆ·è¿è¡Œè¿›ç¨‹ ä¸è¦ä½¿ç”¨â€œæœ€æ–°â€æ ‡ç­¾ ä¸è¦åˆ©ç”¨è¿è¡Œä¸­çš„å®¹å™¨åˆ›å»ºé•œåƒ ä¸è¦ä½¿ç”¨å•å±‚é•œåƒ ä¸è¦å°†æ•°æ®å­˜æ”¾åœ¨å®¹å™¨å†… 14.2. å…³äºDockerå®¹å™¨çš„ç›‘æ§å®¹å™¨çš„åŸºæœ¬ä¿¡æ¯ åŒ…æ‹¬å®¹å™¨çš„æ•°é‡ã€IDã€åç§°ã€é•œåƒã€å¯åŠ¨å‘½ä»¤ã€ç«¯å£ç­‰ä¿¡æ¯ å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ ç»Ÿè®¡å„çŠ¶æ€çš„å®¹å™¨çš„æ•°é‡ï¼ŒåŒ…æ‹¬è¿è¡Œä¸­ã€æš‚åœã€åœæ­¢åŠå¼‚å¸¸é€€å‡º å®¹å™¨çš„ç”¨é‡ä¿¡æ¯ ç»Ÿè®¡å®¹å™¨çš„CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€å—è®¾å¤‡I&#x2F;Oä½¿ç”¨é‡ã€ç½‘ç»œä½¿ç”¨æƒ…å†µç­‰èµ„æºçš„ä½¿ç”¨æƒ…å†µ å‚è€ƒæ–‡çŒ® redhat.com&#x2F;zh&#x2F;topics&#x2F;containers&#x2F;whats-a-linux-container redhat.com&#x2F;zh&#x2F;topics&#x2F;containers&#x2F;what-is-docker blog.51cto.com&#x2F;dihaifeng&#x2F;1713512 cnblogs.com&#x2F;Bourbon-tian&#x2F;p&#x2F;6867796.html cnblogs.com&#x2F;CloudMan6&#x2F;p&#x2F;6806193.html","tags":["å¼€å‘å·¥å…·","Docker"],"categories":["å¼€å‘å·¥å…·"]},{"title":"MySQLå¤§è¡¨ä¼˜åŒ–æ–¹æ¡ˆ","path":"/2023/12/24/MySQLå¤§è¡¨ä¼˜åŒ–æ–¹æ¡ˆ/","content":"å½“MySQLå•è¡¨è®°å½•æ•°è¿‡å¤§æ—¶ï¼Œå¢åˆ æ”¹æŸ¥æ€§èƒ½éƒ½ä¼šæ€¥å‰§ä¸‹é™ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ­¥éª¤æ¥ä¼˜åŒ–ï¼š å•è¡¨ä¼˜åŒ–é™¤éå•è¡¨æ•°æ®æœªæ¥ä¼šä¸€ç›´ä¸æ–­ä¸Šæ¶¨ï¼Œå¦åˆ™ä¸è¦ä¸€å¼€å§‹å°±è€ƒè™‘æ‹†åˆ†ï¼Œæ‹†åˆ†ä¼šå¸¦æ¥é€»è¾‘ã€éƒ¨ç½²ã€è¿ç»´çš„å„ç§å¤æ‚åº¦ï¼Œä¸€èˆ¬ä»¥æ•´å‹å€¼ä¸ºä¸»çš„è¡¨åœ¨åƒä¸‡çº§ä»¥ä¸‹ï¼Œå­—ç¬¦ä¸²ä¸ºä¸»çš„è¡¨åœ¨äº”ç™¾ä¸‡ä»¥ä¸‹æ˜¯æ²¡æœ‰å¤ªå¤§é—®é¢˜çš„ã€‚è€Œäº‹å®ä¸Šå¾ˆå¤šæ—¶å€™MySQLå•è¡¨çš„æ€§èƒ½ä¾ç„¶æœ‰ä¸å°‘ä¼˜åŒ–ç©ºé—´ï¼Œç”šè‡³èƒ½æ­£å¸¸æ”¯æ’‘åƒä¸‡çº§ä»¥ä¸Šçš„æ•°æ®é‡ï¼š å­—æ®µ å°½é‡ä½¿ç”¨TINYINTã€SMALLINTã€MEDIUM_INTä½œä¸ºæ•´æ•°ç±»å‹è€ŒéINTï¼Œå¦‚æœéè´Ÿåˆ™åŠ ä¸ŠUNSIGNED VARCHARçš„é•¿åº¦åªåˆ†é…çœŸæ­£éœ€è¦çš„ç©ºé—´ ä½¿ç”¨æšä¸¾æˆ–æ•´æ•°ä»£æ›¿å­—ç¬¦ä¸²ç±»å‹ å°½é‡ä½¿ç”¨TIMESTAMPè€ŒéDATETIMEï¼Œ å•è¡¨ä¸è¦æœ‰å¤ªå¤šå­—æ®µï¼Œå»ºè®®åœ¨20ä»¥å†… é¿å…ä½¿ç”¨NULLå­—æ®µï¼Œå¾ˆéš¾æŸ¥è¯¢ä¼˜åŒ–ä¸”å ç”¨é¢å¤–ç´¢å¼•ç©ºé—´ ç”¨æ•´å‹æ¥å­˜IP ç´¢å¼• ç´¢å¼•å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®æŸ¥è¯¢æœ‰é’ˆå¯¹æ€§çš„åˆ›å»ºï¼Œè€ƒè™‘åœ¨WHEREå’ŒORDER BYå‘½ä»¤ä¸Šæ¶‰åŠçš„åˆ—å»ºç«‹ç´¢å¼•ï¼Œå¯æ ¹æ®EXPLAINæ¥æŸ¥çœ‹æ˜¯å¦ç”¨äº†ç´¢å¼•è¿˜æ˜¯å…¨è¡¨æ‰«æ åº”å°½é‡é¿å…åœ¨WHEREå­å¥ä¸­å¯¹å­—æ®µè¿›è¡ŒNULLå€¼åˆ¤æ–­ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æ å€¼åˆ†å¸ƒå¾ˆç¨€å°‘çš„å­—æ®µä¸é€‚åˆå»ºç´¢å¼•ï¼Œä¾‹å¦‚â€æ€§åˆ«â€è¿™ç§åªæœ‰ä¸¤ä¸‰ä¸ªå€¼çš„å­—æ®µ å­—ç¬¦å­—æ®µåªå»ºå‰ç¼€ç´¢å¼• å­—ç¬¦å­—æ®µæœ€å¥½ä¸è¦åšä¸»é”® ä¸ç”¨å¤–é”®ï¼Œç”±ç¨‹åºä¿è¯çº¦æŸ å°½é‡ä¸ç”¨UNIQUEï¼Œç”±ç¨‹åºä¿è¯çº¦æŸ ä½¿ç”¨å¤šåˆ—ç´¢å¼•æ—¶ä¸»æ„é¡ºåºå’ŒæŸ¥è¯¢æ¡ä»¶ä¿æŒä¸€è‡´ï¼ŒåŒæ—¶åˆ é™¤ä¸å¿…è¦çš„å•åˆ—ç´¢å¼• æŸ¥è¯¢SQL å¯é€šè¿‡å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—æ¥æ‰¾å‡ºè¾ƒæ…¢çš„SQL ä¸åšåˆ—è¿ç®—ï¼šSELECT id WHERE age + 1 &#x3D; 10ï¼Œä»»ä½•å¯¹åˆ—çš„æ“ä½œéƒ½å°†å¯¼è‡´è¡¨æ‰«æï¼Œå®ƒåŒ…æ‹¬æ•°æ®åº“æ•™ç¨‹å‡½æ•°ã€è®¡ç®—è¡¨è¾¾å¼ç­‰ç­‰ï¼ŒæŸ¥è¯¢æ—¶è¦å°½å¯èƒ½å°†æ“ä½œç§»è‡³ç­‰å·å³è¾¹ sqlè¯­å¥å°½å¯èƒ½ç®€å•ï¼šä¸€æ¡sqlåªèƒ½åœ¨ä¸€ä¸ªcpuè¿ç®—ï¼›å¤§è¯­å¥æ‹†å°è¯­å¥ï¼Œå‡å°‘é”æ—¶é—´ï¼›ä¸€æ¡å¤§sqlå¯ä»¥å µæ­»æ•´ä¸ªåº“ ä¸ç”¨SELECT * ORæ”¹å†™æˆINï¼šORçš„æ•ˆç‡æ˜¯nçº§åˆ«ï¼ŒINçš„æ•ˆç‡æ˜¯log(n)çº§åˆ«ï¼Œinçš„ä¸ªæ•°å»ºè®®æ§åˆ¶åœ¨200ä»¥å†… ä¸ç”¨å‡½æ•°å’Œè§¦å‘å™¨ï¼Œåœ¨åº”ç”¨ç¨‹åºå®ç° é¿å…%xxxå¼æŸ¥è¯¢ å°‘ç”¨JOIN ä½¿ç”¨åŒç±»å‹è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”å¦‚ç”¨â€™123â€™å’Œâ€™123â€™æ¯”ï¼Œ123å’Œ123æ¯” å°½é‡é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨!&#x3D;æˆ–&lt;&gt;æ“ä½œç¬¦ï¼Œå¦åˆ™å°†å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æ å¯¹äºè¿ç»­æ•°å€¼ï¼Œä½¿ç”¨BETWEENä¸ç”¨INï¼šSELECT id FROM t WHERE num BETWEEN 1 AND 5 åˆ—è¡¨æ•°æ®ä¸è¦æ‹¿å…¨è¡¨ï¼Œè¦ä½¿ç”¨LIMITæ¥åˆ†é¡µï¼Œæ¯é¡µæ•°é‡ä¹Ÿä¸è¦å¤ªå¤§ å¼•æ“ç›®å‰å¹¿æ³›ä½¿ç”¨çš„æ˜¯MyISAMå’ŒInnoDBä¸¤ç§å¼•æ“ï¼š MyISAMMyISAMå¼•æ“æ˜¯MySQL 5.1åŠä¹‹å‰ç‰ˆæœ¬çš„é»˜è®¤å¼•æ“ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯ï¼š ä¸æ”¯æŒè¡Œé”ï¼Œè¯»å–æ—¶å¯¹éœ€è¦è¯»åˆ°çš„æ‰€æœ‰è¡¨åŠ é”ï¼Œå†™å…¥æ—¶åˆ™å¯¹è¡¨åŠ æ’å®ƒé” ä¸æ”¯æŒäº‹åŠ¡ ä¸æ”¯æŒå¤–é”® ä¸æ”¯æŒå´©æºƒåçš„å®‰å…¨æ¢å¤ åœ¨è¡¨æœ‰è¯»å–æŸ¥è¯¢çš„åŒæ—¶ï¼Œæ”¯æŒå¾€è¡¨ä¸­æ’å…¥æ–°çºªå½• æ”¯æŒBLOBå’ŒTEXTçš„å‰500ä¸ªå­—ç¬¦ç´¢å¼•ï¼Œæ”¯æŒå…¨æ–‡ç´¢å¼• æ”¯æŒå»¶è¿Ÿæ›´æ–°ç´¢å¼•ï¼Œæå¤§æå‡å†™å…¥æ€§èƒ½ å¯¹äºä¸ä¼šè¿›è¡Œä¿®æ”¹çš„è¡¨ï¼Œæ”¯æŒå‹ç¼©è¡¨ï¼Œæå¤§å‡å°‘ç£ç›˜ç©ºé—´å ç”¨ InnoDBInnoDBåœ¨MySQL 5.5åæˆä¸ºé»˜è®¤ç´¢å¼•ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯ï¼š æ”¯æŒè¡Œé”ï¼Œé‡‡ç”¨MVCCæ¥æ”¯æŒé«˜å¹¶å‘ æ”¯æŒäº‹åŠ¡ æ”¯æŒå¤–é”® æ”¯æŒå´©æºƒåçš„å®‰å…¨æ¢å¤ ä¸æ”¯æŒå…¨æ–‡ç´¢å¼• æ€»ä½“æ¥è®²ï¼ŒMyISAMé€‚åˆSELECTå¯†é›†å‹çš„è¡¨ï¼Œè€ŒInnoDBé€‚åˆINSERTå’ŒUPDATEå¯†é›†å‹çš„è¡¨ ç³»ç»Ÿè°ƒä¼˜å‚æ•°å¯ä»¥ä½¿ç”¨ä¸‹é¢å‡ ä¸ªå·¥å…·æ¥åšåŸºå‡†æµ‹è¯•ï¼š sysbenchï¼šä¸€ä¸ªæ¨¡å—åŒ–ï¼Œè·¨å¹³å°ä»¥åŠå¤šçº¿ç¨‹çš„æ€§èƒ½æµ‹è¯•å·¥å…· iibench-mysqlï¼šåŸºäº Java çš„ MySQL&#x2F;Percona&#x2F;MariaDB ç´¢å¼•è¿›è¡Œæ’å…¥æ€§èƒ½æµ‹è¯•å·¥å…· tpcc-mysqlï¼šPerconaå¼€å‘çš„TPC-Cæµ‹è¯•å·¥å…· å…·ä½“çš„è°ƒä¼˜å‚æ•°å†…å®¹è¾ƒå¤šï¼Œå…·ä½“å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œè¿™é‡Œä»‹ç»ä¸€äº›æ¯”è¾ƒé‡è¦çš„å‚æ•°ï¼š back_logï¼šback_logå€¼æŒ‡å‡ºåœ¨MySQLæš‚æ—¶åœæ­¢å›ç­”æ–°è¯·æ±‚ä¹‹å‰çš„çŸ­æ—¶é—´å†…å¤šå°‘ä¸ªè¯·æ±‚å¯ä»¥è¢«å­˜åœ¨å †æ ˆä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœMySqlçš„è¿æ¥æ•°æ®è¾¾åˆ°max_connectionsæ—¶ï¼Œæ–°æ¥çš„è¯·æ±‚å°†ä¼šè¢«å­˜åœ¨å †æ ˆä¸­ï¼Œä»¥ç­‰å¾…æŸä¸€è¿æ¥é‡Šæ”¾èµ„æºï¼Œè¯¥å †æ ˆçš„æ•°é‡å³back_logï¼Œå¦‚æœç­‰å¾…è¿æ¥çš„æ•°é‡è¶…è¿‡back_logï¼Œå°†ä¸è¢«æˆäºˆè¿æ¥èµ„æºã€‚å¯ä»¥ä»é»˜è®¤çš„50å‡è‡³500 wait_timeoutï¼šæ•°æ®åº“è¿æ¥é—²ç½®æ—¶é—´ï¼Œé—²ç½®è¿æ¥ä¼šå ç”¨å†…å­˜èµ„æºã€‚å¯ä»¥ä»é»˜è®¤çš„8å°æ—¶å‡åˆ°åŠå°æ—¶ max_user_connection: æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º0æ— ä¸Šé™ï¼Œæœ€å¥½è®¾ä¸€ä¸ªåˆç†ä¸Šé™ thread_concurrencyï¼šå¹¶å‘çº¿ç¨‹æ•°ï¼Œè®¾ä¸ºCPUæ ¸æ•°çš„ä¸¤å€ skip_name_resolveï¼šç¦æ­¢å¯¹å¤–éƒ¨è¿æ¥è¿›è¡ŒDNSè§£æï¼Œæ¶ˆé™¤DNSè§£ææ—¶é—´ï¼Œä½†éœ€è¦æ‰€æœ‰è¿œç¨‹ä¸»æœºç”¨IPè®¿é—® key_buffer_sizeï¼šç´¢å¼•å—çš„ç¼“å­˜å¤§å°ï¼Œå¢åŠ ä¼šæå‡ç´¢å¼•å¤„ç†é€Ÿåº¦ï¼Œå¯¹MyISAMè¡¨æ€§èƒ½å½±å“æœ€å¤§ã€‚å¯¹äºå†…å­˜4Gå·¦å³ï¼Œå¯è®¾ä¸º256Mæˆ–384Mï¼Œé€šè¿‡æŸ¥è¯¢show status like â€˜key_read%â€™ï¼Œä¿è¯key_reads &#x2F; key_read_requestsåœ¨0.1%ä»¥ä¸‹æœ€å¥½ innodb_buffer_pool_sizeï¼šç¼“å­˜æ•°æ®å—å’Œç´¢å¼•å—ï¼Œå¯¹InnoDBè¡¨æ€§èƒ½å½±å“æœ€å¤§ã€‚é€šè¿‡æŸ¥è¯¢show status like â€˜Innodb_buffer_pool_read%â€™ï¼Œä¿è¯ (Innodb_buffer_pool_read_requests â€“ Innodb_buffer_pool_reads) &#x2F; Innodb_buffer_pool_read_requestsè¶Šé«˜è¶Šå¥½ innodb_additional_mem_pool_sizeï¼šInnoDBå­˜å‚¨å¼•æ“ç”¨æ¥å­˜æ”¾æ•°æ®å­—å…¸ä¿¡æ¯ä»¥åŠä¸€äº›å†…éƒ¨æ•°æ®ç»“æ„çš„å†…å­˜ç©ºé—´å¤§å°ï¼Œå½“æ•°æ®åº“å¯¹è±¡éå¸¸å¤šçš„æ—¶å€™ï¼Œé€‚å½“è°ƒæ•´è¯¥å‚æ•°çš„å¤§å°ä»¥ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½èƒ½å­˜æ”¾åœ¨å†…å­˜ä¸­æé«˜è®¿é—®æ•ˆç‡ï¼Œå½“è¿‡å°çš„æ—¶å€™ï¼ŒMySQLä¼šè®°å½•Warningä¿¡æ¯åˆ°æ•°æ®åº“çš„é”™è¯¯æ—¥å¿—ä¸­ï¼Œè¿™æ—¶å°±éœ€è¦è¯¥è°ƒæ•´è¿™ä¸ªå‚æ•°å¤§å° innodb_log_buffer_sizeï¼šInnoDBå­˜å‚¨å¼•æ“çš„äº‹åŠ¡æ—¥å¿—æ‰€ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œä¸€èˆ¬æ¥è¯´ä¸å»ºè®®è¶…è¿‡32MB query_cache_sizeï¼šç¼“å­˜MySQLä¸­çš„ResultSetï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡SQLè¯­å¥æ‰§è¡Œçš„ç»“æœé›†ï¼Œæ‰€ä»¥ä»…ä»…åªèƒ½é’ˆå¯¹selectè¯­å¥ã€‚å½“æŸä¸ªè¡¨çš„æ•°æ®æœ‰ä»»ä½•ä»»ä½•å˜åŒ–ï¼Œéƒ½ä¼šå¯¼è‡´æ‰€æœ‰å¼•ç”¨äº†è¯¥è¡¨çš„selectè¯­å¥åœ¨Query Cacheä¸­çš„ç¼“å­˜æ•°æ®å¤±æ•ˆã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬çš„æ•°æ®å˜åŒ–éå¸¸é¢‘ç¹çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨Query Cacheå¯èƒ½ä¼šå¾—ä¸å¿å¤±ã€‚æ ¹æ®å‘½ä¸­ç‡(Qcache_hits&#x2F;(Qcache_hits+Qcache_inserts)*100))è¿›è¡Œè°ƒæ•´ï¼Œä¸€èˆ¬ä¸å»ºè®®å¤ªå¤§ï¼Œ256MBå¯èƒ½å·²ç»å·®ä¸å¤šäº†ï¼Œå¤§å‹çš„é…ç½®å‹é™æ€æ•°æ®å¯é€‚å½“è°ƒå¤§.å¯ä»¥é€šè¿‡å‘½ä»¤show status like â€˜Qcache_%â€™æŸ¥çœ‹ç›®å‰ç³»ç»ŸQuery catchä½¿ç”¨å¤§å° read_buffer_sizeï¼šMySqlè¯»å…¥ç¼“å†²åŒºå¤§å°ã€‚å¯¹è¡¨è¿›è¡Œé¡ºåºæ‰«æçš„è¯·æ±‚å°†åˆ†é…ä¸€ä¸ªè¯»å…¥ç¼“å†²åŒºï¼ŒMySqlä¼šä¸ºå®ƒåˆ†é…ä¸€æ®µå†…å­˜ç¼“å†²åŒºã€‚å¦‚æœå¯¹è¡¨çš„é¡ºåºæ‰«æè¯·æ±‚éå¸¸é¢‘ç¹ï¼Œå¯ä»¥é€šè¿‡å¢åŠ è¯¥å˜é‡å€¼ä»¥åŠå†…å­˜ç¼“å†²åŒºå¤§å°æé«˜å…¶æ€§èƒ½ sort_buffer_sizeï¼šMySqlæ‰§è¡Œæ’åºä½¿ç”¨çš„ç¼“å†²å¤§å°ã€‚å¦‚æœæƒ³è¦å¢åŠ ORDER BYçš„é€Ÿåº¦ï¼Œé¦–å…ˆçœ‹æ˜¯å¦å¯ä»¥è®©MySQLä½¿ç”¨ç´¢å¼•è€Œä¸æ˜¯é¢å¤–çš„æ’åºé˜¶æ®µã€‚å¦‚æœä¸èƒ½ï¼Œå¯ä»¥å°è¯•å¢åŠ sort_buffer_sizeå˜é‡çš„å¤§å° read_rnd_buffer_sizeï¼šMySqlçš„éšæœºè¯»ç¼“å†²åŒºå¤§å°ã€‚å½“æŒ‰ä»»æ„é¡ºåºè¯»å–è¡Œæ—¶(ä¾‹å¦‚ï¼ŒæŒ‰ç…§æ’åºé¡ºåº)ï¼Œå°†åˆ†é…ä¸€ä¸ªéšæœºè¯»ç¼“å­˜åŒºã€‚è¿›è¡Œæ’åºæŸ¥è¯¢æ—¶ï¼ŒMySqlä¼šé¦–å…ˆæ‰«æä¸€éè¯¥ç¼“å†²ï¼Œä»¥é¿å…ç£ç›˜æœç´¢ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå¦‚æœéœ€è¦æ’åºå¤§é‡æ•°æ®ï¼Œå¯é€‚å½“è°ƒé«˜è¯¥å€¼ã€‚ä½†MySqlä¼šä¸ºæ¯ä¸ªå®¢æˆ·è¿æ¥å‘æ”¾è¯¥ç¼“å†²ç©ºé—´ï¼Œæ‰€ä»¥åº”å°½é‡é€‚å½“è®¾ç½®è¯¥å€¼ï¼Œä»¥é¿å…å†…å­˜å¼€é”€è¿‡å¤§ã€‚ record_bufferï¼šæ¯ä¸ªè¿›è¡Œä¸€ä¸ªé¡ºåºæ‰«æçš„çº¿ç¨‹ä¸ºå…¶æ‰«æçš„æ¯å¼ è¡¨åˆ†é…è¿™ä¸ªå¤§å°çš„ä¸€ä¸ªç¼“å†²åŒºã€‚å¦‚æœä½ åšå¾ˆå¤šé¡ºåºæ‰«æï¼Œå¯èƒ½æƒ³è¦å¢åŠ è¯¥å€¼ thread_cache_sizeï¼šä¿å­˜å½“å‰æ²¡æœ‰ä¸è¿æ¥å…³è”ä½†æ˜¯å‡†å¤‡ä¸ºåé¢æ–°çš„è¿æ¥æœåŠ¡çš„çº¿ç¨‹ï¼Œå¯ä»¥å¿«é€Ÿå“åº”è¿æ¥çš„çº¿ç¨‹è¯·æ±‚è€Œæ— éœ€åˆ›å»ºæ–°çš„ table_cacheï¼šç±»ä¼¼äºthread_cache_sizeï¼Œä½†ç”¨æ¥ç¼“å­˜è¡¨æ–‡ä»¶ï¼Œå¯¹InnoDBæ•ˆæœä¸å¤§ï¼Œä¸»è¦ç”¨äºMyISAM å‡çº§ç¡¬ä»¶Scale upï¼Œè¿™ä¸ªä¸å¤šè¯´äº†ï¼Œæ ¹æ®MySQLæ˜¯CPUå¯†é›†å‹è¿˜æ˜¯I&#x2F;Oå¯†é›†å‹ï¼Œé€šè¿‡æå‡CPUå’Œå†…å­˜ã€ä½¿ç”¨SSDï¼Œéƒ½èƒ½æ˜¾è‘—æå‡MySQLæ€§èƒ½ è¯»å†™åˆ†ç¦»ä¹Ÿæ˜¯ç›®å‰å¸¸ç”¨çš„ä¼˜åŒ–ï¼Œä»åº“è¯»ä¸»åº“å†™ï¼Œä¸€èˆ¬ä¸è¦é‡‡ç”¨åŒä¸»æˆ–å¤šä¸»å¼•å…¥å¾ˆå¤šå¤æ‚æ€§ï¼Œå°½é‡é‡‡ç”¨æ–‡ä¸­çš„å…¶ä»–æ–¹æ¡ˆæ¥æé«˜æ€§èƒ½ã€‚åŒæ—¶ç›®å‰å¾ˆå¤šæ‹†åˆ†çš„è§£å†³æ–¹æ¡ˆåŒæ—¶ä¹Ÿå…¼é¡¾è€ƒè™‘äº†è¯»å†™åˆ†ç¦» ç¼“å­˜ç¼“å­˜å¯ä»¥å‘ç”Ÿåœ¨è¿™äº›å±‚æ¬¡ï¼š MySQLå†…éƒ¨ï¼šåœ¨ç³»ç»Ÿè°ƒä¼˜å‚æ•°ä»‹ç»äº†ç›¸å…³è®¾ç½® æ•°æ®è®¿é—®å±‚ï¼šæ¯”å¦‚MyBatisé’ˆå¯¹SQLè¯­å¥åšç¼“å­˜ï¼Œè€ŒHibernateå¯ä»¥ç²¾ç¡®åˆ°å•ä¸ªè®°å½•ï¼Œè¿™é‡Œç¼“å­˜çš„å¯¹è±¡ä¸»è¦æ˜¯æŒä¹…åŒ–å¯¹è±¡Persistence Object åº”ç”¨æœåŠ¡å±‚ï¼šè¿™é‡Œå¯ä»¥é€šè¿‡ç¼–ç¨‹æ‰‹æ®µå¯¹ç¼“å­˜åšåˆ°æ›´ç²¾å‡†çš„æ§åˆ¶å’Œæ›´å¤šçš„å®ç°ç­–ç•¥ï¼Œè¿™é‡Œç¼“å­˜çš„å¯¹è±¡æ˜¯æ•°æ®ä¼ è¾“å¯¹è±¡Data Transfer Object Webå±‚ï¼šé’ˆå¯¹webé¡µé¢åšç¼“å­˜ æµè§ˆå™¨å®¢æˆ·ç«¯ï¼šç”¨æˆ·ç«¯çš„ç¼“å­˜ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µåœ¨ä¸€ä¸ªå±‚æ¬¡æˆ–å¤šä¸ªå±‚æ¬¡ç»“åˆåŠ å…¥ç¼“å­˜ã€‚è¿™é‡Œé‡ç‚¹ä»‹ç»ä¸‹æœåŠ¡å±‚çš„ç¼“å­˜å®ç°ï¼Œç›®å‰ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š ç›´å†™å¼ï¼ˆWrite Throughï¼‰ï¼šåœ¨æ•°æ®å†™å…¥æ•°æ®åº“åï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜ï¼Œç»´æŒæ•°æ®åº“ä¸ç¼“å­˜çš„ä¸€è‡´æ€§ã€‚è¿™ä¹Ÿæ˜¯å½“å‰å¤§å¤šæ•°åº”ç”¨ç¼“å­˜æ¡†æ¶å¦‚Spring Cacheçš„å·¥ä½œæ–¹å¼ã€‚è¿™ç§å®ç°éå¸¸ç®€å•ï¼ŒåŒæ­¥å¥½ï¼Œä½†æ•ˆç‡ä¸€èˆ¬ã€‚ å›å†™å¼ï¼ˆWrite Backï¼‰ï¼šå½“æœ‰æ•°æ®è¦å†™å…¥æ•°æ®åº“æ—¶ï¼Œåªä¼šæ›´æ–°ç¼“å­˜ï¼Œç„¶åå¼‚æ­¥æ‰¹é‡çš„å°†ç¼“å­˜æ•°æ®åŒæ­¥åˆ°æ•°æ®åº“ä¸Šã€‚è¿™ç§å®ç°æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦è¾ƒå¤šçš„åº”ç”¨é€»è¾‘ï¼ŒåŒæ—¶å¯èƒ½ä¼šäº§ç”Ÿæ•°æ®åº“ä¸ç¼“å­˜çš„ä¸åŒæ­¥ï¼Œä½†æ•ˆç‡éå¸¸é«˜ã€‚ è¡¨åˆ†åŒºMySQLåœ¨5.1ç‰ˆå¼•å…¥çš„åˆ†åŒºæ˜¯ä¸€ç§ç®€å•çš„æ°´å¹³æ‹†åˆ†ï¼Œç”¨æˆ·éœ€è¦åœ¨å»ºè¡¨çš„æ—¶å€™åŠ ä¸Šåˆ†åŒºå‚æ•°ï¼Œå¯¹åº”ç”¨æ˜¯é€æ˜çš„æ— éœ€ä¿®æ”¹ä»£ç  å¯¹ç”¨æˆ·æ¥è¯´ï¼Œåˆ†åŒºè¡¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘è¡¨ï¼Œä½†æ˜¯åº•å±‚ç”±å¤šä¸ªç‰©ç†å­è¡¨ç»„æˆï¼Œå®ç°åˆ†åŒºçš„ä»£ç å®é™…ä¸Šæ˜¯é€šè¿‡å¯¹ä¸€ç»„åº•å±‚è¡¨çš„å¯¹è±¡å°è£…ï¼Œä½†å¯¹SQLå±‚æ¥è¯´æ˜¯ä¸€ä¸ªå®Œå…¨å°è£…åº•å±‚çš„é»‘ç›’å­ã€‚MySQLå®ç°åˆ†åŒºçš„æ–¹å¼ä¹Ÿæ„å‘³ç€ç´¢å¼•ä¹Ÿæ˜¯æŒ‰ç…§åˆ†åŒºçš„å­è¡¨å®šä¹‰ï¼Œæ²¡æœ‰å…¨å±€ç´¢å¼• ç”¨æˆ·çš„SQLè¯­å¥æ˜¯éœ€è¦é’ˆå¯¹åˆ†åŒºè¡¨åšä¼˜åŒ–ï¼ŒSQLæ¡ä»¶ä¸­è¦å¸¦ä¸Šåˆ†åŒºæ¡ä»¶çš„åˆ—ï¼Œä»è€Œä½¿æŸ¥è¯¢å®šä½åˆ°å°‘é‡çš„åˆ†åŒºä¸Šï¼Œå¦åˆ™å°±ä¼šæ‰«æå…¨éƒ¨åˆ†åŒºï¼Œå¯ä»¥é€šè¿‡EXPLAIN PARTITIONSæ¥æŸ¥çœ‹æŸæ¡SQLè¯­å¥ä¼šè½åœ¨é‚£äº›åˆ†åŒºä¸Šï¼Œä»è€Œè¿›è¡ŒSQLä¼˜åŒ–ï¼Œå¦‚ä¸‹å›¾5æ¡è®°å½•è½åœ¨ä¸¤ä¸ªåˆ†åŒºä¸Šï¼š 12345678mysql&gt; explain partitions select count(1) from user_partition where id in (1,2,3,4,5);+----+-------------+----------------+------------+-------+---------------+---------+---------+------+------+--------------------------+| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | Extra |+----+-------------+----------------+------------+-------+---------------+---------+---------+------+------+--------------------------+| 1 | SIMPLE | user_partition | p1,p4 | range | PRIMARY | PRIMARY | 8 | NULL | 5 | Using where; Using index |+----+-------------+----------------+------------+-------+---------------+---------+---------+------+------+--------------------------+1 row in set (0.00 sec) åˆ†åŒºçš„å¥½å¤„æ˜¯ï¼š å¯ä»¥è®©å•è¡¨å­˜å‚¨æ›´å¤šçš„æ•°æ® åˆ†åŒºè¡¨çš„æ•°æ®æ›´å®¹æ˜“ç»´æŠ¤ï¼Œå¯ä»¥é€šè¿‡æ¸…æ¥šæ•´ä¸ªåˆ†åŒºæ‰¹é‡åˆ é™¤å¤§é‡æ•°æ®ï¼Œä¹Ÿå¯ä»¥å¢åŠ æ–°çš„åˆ†åŒºæ¥æ”¯æŒæ–°æ’å…¥çš„æ•°æ®ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥å¯¹ä¸€ä¸ªç‹¬ç«‹åˆ†åŒºè¿›è¡Œä¼˜åŒ–ã€æ£€æŸ¥ã€ä¿®å¤ç­‰æ“ä½œ éƒ¨åˆ†æŸ¥è¯¢èƒ½å¤Ÿä»æŸ¥è¯¢æ¡ä»¶ç¡®å®šåªè½åœ¨å°‘æ•°åˆ†åŒºä¸Šï¼Œé€Ÿåº¦ä¼šå¾ˆå¿« åˆ†åŒºè¡¨çš„æ•°æ®è¿˜å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„ç‰©ç†è®¾å¤‡ä¸Šï¼Œä»è€Œæç¬‘åˆ©ç”¨å¤šä¸ªç¡¬ä»¶è®¾å¤‡ å¯ä»¥ä½¿ç”¨åˆ†åŒºè¡¨èµ–é¿å…æŸäº›ç‰¹æ®Šç“¶é¢ˆï¼Œä¾‹å¦‚InnoDBå•ä¸ªç´¢å¼•çš„äº’æ–¥è®¿é—®ã€ext3æ–‡ä»¶ç³»ç»Ÿçš„inodeé”ç«äº‰ å¯ä»¥å¤‡ä»½å’Œæ¢å¤å•ä¸ªåˆ†åŒº åˆ†åŒºçš„é™åˆ¶å’Œç¼ºç‚¹ï¼š ä¸€ä¸ªè¡¨æœ€å¤šåªèƒ½æœ‰1024ä¸ªåˆ†åŒº å¦‚æœåˆ†åŒºå­—æ®µä¸­æœ‰ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•çš„åˆ—ï¼Œé‚£ä¹ˆæ‰€æœ‰ä¸»é”®åˆ—å’Œå”¯ä¸€ç´¢å¼•åˆ—éƒ½å¿…é¡»åŒ…å«è¿›æ¥ åˆ†åŒºè¡¨æ— æ³•ä½¿ç”¨å¤–é”®çº¦æŸ NULLå€¼ä¼šä½¿åˆ†åŒºè¿‡æ»¤æ— æ•ˆ æ‰€æœ‰åˆ†åŒºå¿…é¡»ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“ åˆ†åŒºçš„ç±»å‹ï¼š RANGEåˆ†åŒºï¼šåŸºäºå±äºä¸€ä¸ªç»™å®šè¿ç»­åŒºé—´çš„åˆ—å€¼ï¼ŒæŠŠå¤šè¡Œåˆ†é…ç»™åˆ†åŒº LISTåˆ†åŒºï¼šç±»ä¼¼äºæŒ‰RANGEåˆ†åŒºï¼ŒåŒºåˆ«åœ¨äºLISTåˆ†åŒºæ˜¯åŸºäºåˆ—å€¼åŒ¹é…ä¸€ä¸ªç¦»æ•£å€¼é›†åˆä¸­çš„æŸä¸ªå€¼æ¥è¿›è¡Œé€‰æ‹© HASHåˆ†åŒºï¼šåŸºäºç”¨æˆ·å®šä¹‰çš„è¡¨è¾¾å¼çš„è¿”å›å€¼æ¥è¿›è¡Œé€‰æ‹©çš„åˆ†åŒºï¼Œè¯¥è¡¨è¾¾å¼ä½¿ç”¨å°†è¦æ’å…¥åˆ°è¡¨ä¸­çš„è¿™äº›è¡Œçš„åˆ—å€¼è¿›è¡Œè®¡ç®—ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥åŒ…å«MySQLä¸­æœ‰æ•ˆçš„ã€äº§ç”Ÿéè´Ÿæ•´æ•°å€¼çš„ä»»ä½•è¡¨è¾¾å¼ KEYåˆ†åŒºï¼šç±»ä¼¼äºæŒ‰HASHåˆ†åŒºï¼ŒåŒºåˆ«åœ¨äºKEYåˆ†åŒºåªæ”¯æŒè®¡ç®—ä¸€åˆ—æˆ–å¤šåˆ—ï¼Œä¸”MySQLæœåŠ¡å™¨æä¾›å…¶è‡ªèº«çš„å“ˆå¸Œå‡½æ•°ã€‚å¿…é¡»æœ‰ä¸€åˆ—æˆ–å¤šåˆ—åŒ…å«æ•´æ•°å€¼ åˆ†åŒºé€‚åˆçš„åœºæ™¯æœ‰ï¼š æœ€é€‚åˆçš„åœºæ™¯æ•°æ®çš„æ—¶é—´åºåˆ—æ€§æ¯”è¾ƒå¼ºï¼Œåˆ™å¯ä»¥æŒ‰æ—¶é—´æ¥åˆ†åŒºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234567891011121314CREATE TABLE members ( firstname VARCHAR(25) NOT NULL, lastname VARCHAR(25) NOT NULL, username VARCHAR(16) NOT NULL, email VARCHAR(35), joined DATE NOT NULL)PARTITION BY RANGE( YEAR(joined) ) ( PARTITION p0 VALUES LESS THAN (1960), PARTITION p1 VALUES LESS THAN (1970), PARTITION p2 VALUES LESS THAN (1980), PARTITION p3 VALUES LESS THAN (1990), PARTITION p4 VALUES LESS THAN MAXVALUE); æŸ¥è¯¢æ—¶åŠ ä¸Šæ—¶é—´èŒƒå›´æ¡ä»¶æ•ˆç‡ä¼šéå¸¸é«˜ï¼ŒåŒæ—¶å¯¹äºä¸éœ€è¦çš„å†å²æ•°æ®èƒ½å¾ˆå®¹çš„æ‰¹é‡åˆ é™¤ã€‚ å¦‚æœæ•°æ®æœ‰æ˜æ˜¾çš„çƒ­ç‚¹ï¼Œè€Œä¸”é™¤äº†è¿™éƒ¨åˆ†æ•°æ®ï¼Œå…¶ä»–æ•°æ®å¾ˆå°‘è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å°†çƒ­ç‚¹æ•°æ®å•ç‹¬æ”¾åœ¨ä¸€ä¸ªåˆ†åŒºï¼Œè®©è¿™ä¸ªåˆ†åŒºçš„æ•°æ®èƒ½å¤Ÿæœ‰æœºä¼šéƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼ŒæŸ¥è¯¢æ—¶åªè®¿é—®ä¸€ä¸ªå¾ˆå°çš„åˆ†åŒºè¡¨ï¼Œèƒ½å¤Ÿæœ‰æ•ˆä½¿ç”¨ç´¢å¼•å’Œç¼“å­˜ å¦å¤–MySQLæœ‰ä¸€ç§æ—©æœŸçš„ç®€å•çš„åˆ†åŒºå®ç° - åˆå¹¶è¡¨ï¼ˆmerge tableï¼‰ï¼Œé™åˆ¶è¾ƒå¤šä¸”ç¼ºä¹ä¼˜åŒ–ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œåº”è¯¥ç”¨æ–°çš„åˆ†åŒºæœºåˆ¶æ¥æ›¿ä»£ å‚ç›´æ‹†åˆ†å‚ç›´åˆ†åº“æ˜¯æ ¹æ®æ•°æ®åº“é‡Œé¢çš„æ•°æ®è¡¨çš„ç›¸å…³æ€§è¿›è¡Œæ‹†åˆ†ï¼Œæ¯”å¦‚ï¼šä¸€ä¸ªæ•°æ®åº“é‡Œé¢æ—¢å­˜åœ¨ç”¨æˆ·æ•°æ®ï¼Œåˆå­˜åœ¨è®¢å•æ•°æ®ï¼Œé‚£ä¹ˆå‚ç›´æ‹†åˆ†å¯ä»¥æŠŠç”¨æˆ·æ•°æ®æ”¾åˆ°ç”¨æˆ·åº“ã€æŠŠè®¢å•æ•°æ®æ”¾åˆ°è®¢å•åº“ã€‚å‚ç›´åˆ†è¡¨æ˜¯å¯¹æ•°æ®è¡¨è¿›è¡Œå‚ç›´æ‹†åˆ†çš„ä¸€ç§æ–¹å¼ï¼Œå¸¸è§çš„æ˜¯æŠŠä¸€ä¸ªå¤šå­—æ®µçš„å¤§è¡¨æŒ‰å¸¸ç”¨å­—æ®µå’Œéå¸¸ç”¨å­—æ®µè¿›è¡Œæ‹†åˆ†ï¼Œæ¯ä¸ªè¡¨é‡Œé¢çš„æ•°æ®è®°å½•æ•°ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯å­—æ®µä¸ä¸€æ ·ï¼Œä½¿ç”¨ä¸»é”®å…³è” æ¯”å¦‚åŸå§‹çš„ç”¨æˆ·è¡¨æ˜¯ï¼š å‚ç›´æ‹†åˆ†åæ˜¯ï¼š å‚ç›´æ‹†åˆ†çš„ä¼˜ç‚¹æ˜¯ï¼š å¯ä»¥ä½¿å¾—è¡Œæ•°æ®å˜å°ï¼Œä¸€ä¸ªæ•°æ®å—(Block)å°±èƒ½å­˜æ”¾æ›´å¤šçš„æ•°æ®ï¼Œåœ¨æŸ¥è¯¢æ—¶å°±ä¼šå‡å°‘I&#x2F;Oæ¬¡æ•°(æ¯æ¬¡æŸ¥è¯¢æ—¶è¯»å–çš„Block å°±å°‘) å¯ä»¥è¾¾åˆ°æœ€å¤§åŒ–åˆ©ç”¨Cacheçš„ç›®çš„ï¼Œå…·ä½“åœ¨å‚ç›´æ‹†åˆ†çš„æ—¶å€™å¯ä»¥å°†ä¸å¸¸å˜çš„å­—æ®µæ”¾ä¸€èµ·ï¼Œå°†ç»å¸¸æ”¹å˜çš„æ”¾ä¸€èµ· æ•°æ®ç»´æŠ¤ç®€å• ç¼ºç‚¹æ˜¯ï¼š ä¸»é”®å‡ºç°å†—ä½™ï¼Œéœ€è¦ç®¡ç†å†—ä½™åˆ— ä¼šå¼•èµ·è¡¨è¿æ¥JOINæ“ä½œï¼ˆå¢åŠ CPUå¼€é”€ï¼‰å¯ä»¥é€šè¿‡åœ¨ä¸šåŠ¡æœåŠ¡å™¨ä¸Šè¿›è¡Œjoinæ¥å‡å°‘æ•°æ®åº“å‹åŠ› ä¾ç„¶å­˜åœ¨å•è¡¨æ•°æ®é‡è¿‡å¤§çš„é—®é¢˜ï¼ˆéœ€è¦æ°´å¹³æ‹†åˆ†ï¼‰ äº‹åŠ¡å¤„ç†å¤æ‚ æ°´å¹³æ‹†åˆ†æ¦‚è¿°æ°´å¹³æ‹†åˆ†æ˜¯é€šè¿‡æŸç§ç­–ç•¥å°†æ•°æ®åˆ†ç‰‡æ¥å­˜å‚¨ï¼Œåˆ†åº“å†…åˆ†è¡¨å’Œåˆ†åº“ä¸¤éƒ¨åˆ†ï¼Œæ¯ç‰‡æ•°æ®ä¼šåˆ†æ•£åˆ°ä¸åŒçš„MySQLè¡¨æˆ–åº“ï¼Œè¾¾åˆ°åˆ†å¸ƒå¼çš„æ•ˆæœï¼Œèƒ½å¤Ÿæ”¯æŒéå¸¸å¤§çš„æ•°æ®é‡ã€‚ å‰é¢çš„è¡¨åˆ†åŒºæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„åº“å†…åˆ†è¡¨ åº“å†…åˆ†è¡¨ï¼Œä»…ä»…æ˜¯å•çº¯çš„è§£å†³äº†å•ä¸€è¡¨æ•°æ®è¿‡å¤§çš„é—®é¢˜ï¼Œç”±äºæ²¡æœ‰æŠŠè¡¨çš„æ•°æ®åˆ†å¸ƒåˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œå› æ­¤å¯¹äºå‡è½»MySQLæœåŠ¡å™¨çš„å‹åŠ›æ¥è¯´ï¼Œå¹¶æ²¡æœ‰å¤ªå¤§çš„ä½œç”¨ï¼Œå¤§å®¶è¿˜æ˜¯ç«äº‰åŒä¸€ä¸ªç‰©ç†æœºä¸Šçš„IOã€CPUã€ç½‘ç»œï¼Œè¿™ä¸ªå°±è¦é€šè¿‡åˆ†åº“æ¥è§£å†³ å‰é¢å‚ç›´æ‹†åˆ†çš„ç”¨æˆ·è¡¨å¦‚æœè¿›è¡Œæ°´å¹³æ‹†åˆ†ï¼Œç»“æœæ˜¯ï¼š å®é™…æƒ…å†µä¸­å¾€å¾€ä¼šæ˜¯å‚ç›´æ‹†åˆ†å’Œæ°´å¹³æ‹†åˆ†çš„ç»“åˆï¼Œå³å°†Users_A_Må’ŒUsers_N_Zå†æ‹†æˆUserså’ŒUserExtrasï¼Œè¿™æ ·ä¸€å…±å››å¼ è¡¨ æ°´å¹³æ‹†åˆ†çš„ä¼˜ç‚¹æ˜¯: ä¸å­˜åœ¨å•åº“å¤§æ•°æ®å’Œé«˜å¹¶å‘çš„æ€§èƒ½ç“¶é¢ˆ åº”ç”¨ç«¯æ”¹é€ è¾ƒå°‘ æé«˜äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œè´Ÿè½½èƒ½åŠ› ç¼ºç‚¹æ˜¯ï¼š åˆ†ç‰‡äº‹åŠ¡ä¸€è‡´æ€§éš¾ä»¥è§£å†³ è·¨èŠ‚ç‚¹Joinæ€§èƒ½å·®ï¼Œé€»è¾‘å¤æ‚ æ•°æ®å¤šæ¬¡æ‰©å±•éš¾åº¦è·Ÿç»´æŠ¤é‡æå¤§ åˆ†ç‰‡åŸåˆ™ èƒ½ä¸åˆ†å°±ä¸åˆ†ï¼Œå‚è€ƒå•è¡¨ä¼˜åŒ– åˆ†ç‰‡æ•°é‡å°½é‡å°‘ï¼Œåˆ†ç‰‡å°½é‡å‡åŒ€åˆ†å¸ƒåœ¨å¤šä¸ªæ•°æ®ç»“ç‚¹ä¸Šï¼Œå› ä¸ºä¸€ä¸ªæŸ¥è¯¢SQLè·¨åˆ†ç‰‡è¶Šå¤šï¼Œåˆ™æ€»ä½“æ€§èƒ½è¶Šå·®ï¼Œè™½ç„¶è¦å¥½äºæ‰€æœ‰æ•°æ®åœ¨ä¸€ä¸ªåˆ†ç‰‡çš„ç»“æœï¼Œåªåœ¨å¿…è¦çš„æ—¶å€™è¿›è¡Œæ‰©å®¹ï¼Œå¢åŠ åˆ†ç‰‡æ•°é‡ åˆ†ç‰‡è§„åˆ™éœ€è¦æ…é‡é€‰æ‹©åšå¥½æå‰è§„åˆ’ï¼Œåˆ†ç‰‡è§„åˆ™çš„é€‰æ‹©ï¼Œéœ€è¦è€ƒè™‘æ•°æ®çš„å¢é•¿æ¨¡å¼ï¼Œæ•°æ®çš„è®¿é—®æ¨¡å¼ï¼Œåˆ†ç‰‡å…³è”æ€§é—®é¢˜ï¼Œä»¥åŠåˆ†ç‰‡æ‰©å®¹é—®é¢˜ï¼Œæœ€è¿‘çš„åˆ†ç‰‡ç­–ç•¥ä¸ºèŒƒå›´åˆ†ç‰‡ï¼Œæšä¸¾åˆ†ç‰‡ï¼Œä¸€è‡´æ€§Hashåˆ†ç‰‡ï¼Œè¿™å‡ ç§åˆ†ç‰‡éƒ½æœ‰åˆ©äºæ‰©å®¹ å°½é‡ä¸è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­çš„SQLè·¨è¶Šå¤šä¸ªåˆ†ç‰‡ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸€ç›´æ˜¯ä¸ªä¸å¥½å¤„ç†çš„é—®é¢˜ æŸ¥è¯¢æ¡ä»¶å°½é‡ä¼˜åŒ–ï¼Œå°½é‡é¿å…Select * çš„æ–¹å¼ï¼Œå¤§é‡æ•°æ®ç»“æœé›†ä¸‹ï¼Œä¼šæ¶ˆè€—å¤§é‡å¸¦å®½å’ŒCPUèµ„æºï¼ŒæŸ¥è¯¢å°½é‡é¿å…è¿”å›å¤§é‡ç»“æœé›†ï¼Œå¹¶ä¸”å°½é‡ä¸ºé¢‘ç¹ä½¿ç”¨çš„æŸ¥è¯¢è¯­å¥å»ºç«‹ç´¢å¼•ã€‚ é€šè¿‡æ•°æ®å†—ä½™å’Œè¡¨åˆ†åŒºèµ–é™ä½è·¨åº“Joinçš„å¯èƒ½ è¿™é‡Œç‰¹åˆ«å¼ºè°ƒä¸€ä¸‹åˆ†ç‰‡è§„åˆ™çš„é€‰æ‹©é—®é¢˜ï¼Œå¦‚æœæŸä¸ªè¡¨çš„æ•°æ®æœ‰æ˜æ˜¾çš„æ—¶é—´ç‰¹å¾ï¼Œæ¯”å¦‚è®¢å•ã€äº¤æ˜“è®°å½•ç­‰ï¼Œåˆ™ä»–ä»¬é€šå¸¸æ¯”è¾ƒåˆé€‚ç”¨æ—¶é—´èŒƒå›´åˆ†ç‰‡ï¼Œå› ä¸ºå…·æœ‰æ—¶æ•ˆæ€§çš„æ•°æ®ï¼Œæˆ‘ä»¬å¾€å¾€å…³æ³¨å…¶è¿‘æœŸçš„æ•°æ®ï¼ŒæŸ¥è¯¢æ¡ä»¶ä¸­å¾€å¾€å¸¦æœ‰æ—¶é—´å­—æ®µè¿›è¡Œè¿‡æ»¤ï¼Œæ¯”è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯ï¼Œå½“å‰æ´»è·ƒçš„æ•°æ®ï¼Œé‡‡ç”¨è·¨åº¦æ¯”è¾ƒçŸ­çš„æ—¶é—´æ®µè¿›è¡Œåˆ†ç‰‡ï¼Œè€Œå†å²æ€§çš„æ•°æ®ï¼Œåˆ™é‡‡ç”¨æ¯”è¾ƒé•¿çš„è·¨åº¦å­˜å‚¨ã€‚ æ€»ä½“ä¸Šæ¥è¯´ï¼Œåˆ†ç‰‡çš„é€‰æ‹©æ˜¯å–å†³äºæœ€é¢‘ç¹çš„æŸ¥è¯¢SQLçš„æ¡ä»¶ï¼Œå› ä¸ºä¸å¸¦ä»»ä½•Whereè¯­å¥çš„æŸ¥è¯¢SQLï¼Œä¼šéå†æ‰€æœ‰çš„åˆ†ç‰‡ï¼Œæ€§èƒ½ç›¸å¯¹æœ€å·®ï¼Œå› æ­¤è¿™ç§SQLè¶Šå¤šï¼Œå¯¹ç³»ç»Ÿçš„å½±å“è¶Šå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°½é‡é¿å…è¿™ç§SQLçš„äº§ç”Ÿã€‚ è§£å†³æ–¹æ¡ˆç”±äºæ°´å¹³æ‹†åˆ†ç‰µæ¶‰çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå½“å‰ä¹Ÿæœ‰äº†ä¸å°‘æ¯”è¾ƒæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆã€‚è¿™äº›æ–¹æ¡ˆåˆ†ä¸ºä¸¤å¤§ç±»ï¼šå®¢æˆ·ç«¯æ¶æ„å’Œä»£ç†æ¶æ„ã€‚ å®¢æˆ·ç«¯æ¶æ„é€šè¿‡ä¿®æ”¹æ•°æ®è®¿é—®å±‚ï¼Œå¦‚JDBCã€Data Sourceã€MyBatisï¼Œé€šè¿‡é…ç½®æ¥ç®¡ç†å¤šä¸ªæ•°æ®æºï¼Œç›´è¿æ•°æ®åº“ï¼Œå¹¶åœ¨æ¨¡å—å†…å®Œæˆæ•°æ®çš„åˆ†ç‰‡æ•´åˆï¼Œä¸€èˆ¬ä»¥JaråŒ…çš„æ–¹å¼å‘ˆç° è¿™æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯æ¶æ„çš„ä¾‹å­ï¼š å¯ä»¥çœ‹åˆ°åˆ†ç‰‡çš„å®ç°æ˜¯å’Œåº”ç”¨æœåŠ¡å™¨åœ¨ä¸€èµ·çš„ï¼Œé€šè¿‡ä¿®æ”¹Spring JDBCå±‚æ¥å®ç° å®¢æˆ·ç«¯æ¶æ„çš„ä¼˜ç‚¹æ˜¯ï¼š åº”ç”¨ç›´è¿æ•°æ®åº“ï¼Œé™ä½å¤–å›´ç³»ç»Ÿä¾èµ–æ‰€å¸¦æ¥çš„å®•æœºé£é™© é›†æˆæˆæœ¬ä½ï¼Œæ— éœ€é¢å¤–è¿ç»´çš„ç»„ä»¶ ç¼ºç‚¹æ˜¯ï¼š é™äºåªèƒ½åœ¨æ•°æ®åº“è®¿é—®å±‚ä¸Šåšæ–‡ç« ï¼Œæ‰©å±•æ€§ä¸€èˆ¬ï¼Œå¯¹äºæ¯”è¾ƒå¤æ‚çš„ç³»ç»Ÿå¯èƒ½ä¼šåŠ›ä¸ä»å¿ƒ å°†åˆ†ç‰‡é€»è¾‘çš„å‹åŠ›æ”¾åœ¨åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œé€ æˆé¢å¤–é£é™© ä»£ç†æ¶æ„é€šè¿‡ç‹¬ç«‹çš„ä¸­é—´ä»¶æ¥ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®æºå’Œæ•°æ®åˆ†ç‰‡æ•´åˆï¼Œåç«¯æ•°æ®åº“é›†ç¾¤å¯¹å‰ç«¯åº”ç”¨ç¨‹åºé€æ˜ï¼Œéœ€è¦ç‹¬ç«‹éƒ¨ç½²å’Œè¿ç»´ä»£ç†ç»„ä»¶ è¿™æ˜¯ä¸€ä¸ªä»£ç†æ¶æ„çš„ä¾‹å­ï¼š ä»£ç†ç»„ä»¶ä¸ºäº†åˆ†æµå’Œé˜²æ­¢å•ç‚¹ï¼Œä¸€èˆ¬ä»¥é›†ç¾¤å½¢å¼å­˜åœ¨ï¼ŒåŒæ—¶å¯èƒ½éœ€è¦Zookeeperä¹‹ç±»çš„æœåŠ¡ç»„ä»¶æ¥ç®¡ç† ä»£ç†æ¶æ„çš„ä¼˜ç‚¹æ˜¯ï¼š èƒ½å¤Ÿå¤„ç†éå¸¸å¤æ‚çš„éœ€æ±‚ï¼Œä¸å—æ•°æ®åº“è®¿é—®å±‚åŸæ¥å®ç°çš„é™åˆ¶ï¼Œæ‰©å±•æ€§å¼º å¯¹äºåº”ç”¨æœåŠ¡å™¨é€æ˜ä¸”æ²¡æœ‰å¢åŠ ä»»ä½•é¢å¤–è´Ÿè½½ ç¼ºç‚¹æ˜¯ï¼š éœ€éƒ¨ç½²å’Œè¿ç»´ç‹¬ç«‹çš„ä»£ç†ä¸­é—´ä»¶ï¼Œæˆæœ¬é«˜ åº”ç”¨éœ€ç»è¿‡ä»£ç†æ¥è¿æ¥æ•°æ®åº“ï¼Œç½‘ç»œä¸Šå¤šäº†ä¸€è·³ï¼Œæ€§èƒ½æœ‰æŸå¤±ä¸”æœ‰é¢å¤–é£é™© å„æ–¹æ¡ˆæ¯”è¾ƒ å‡ºå“æ–¹ æ¶æ„æ¨¡å‹ æ”¯æŒæ•°æ®åº“ åˆ†åº“ åˆ†è¡¨ è¯»å†™åˆ†ç¦» å¤–éƒ¨ä¾èµ– æ˜¯å¦å¼€æº å®ç°è¯­è¨€ æ”¯æŒè¯­è¨€ æœ€åæ›´æ–° Githubæ˜Ÿæ•° MySQL Fabric MySQLå®˜æ–¹ ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ python æ— é™åˆ¶ 4ä¸ªæœˆå‰ 35 Cobar é˜¿é‡Œå·´å·´ ä»£ç†æ¶æ„ MySQL æœ‰ æ—  æ—  æ—  æ˜¯ Java æ— é™åˆ¶ ä¸¤å¹´å‰ 1287 Cobar Client é˜¿é‡Œå·´å·´ å®¢æˆ·ç«¯æ¶æ„ MySQL æœ‰ æ—  æ—  æ—  æ˜¯ Java Java ä¸‰å¹´å‰ 344 TDDL æ·˜å® å®¢æˆ·ç«¯æ¶æ„ æ— é™åˆ¶ æœ‰ æœ‰ æœ‰ Diamond åªå¼€æºéƒ¨åˆ† Java Java æœªçŸ¥ 519 Atlas å¥‡è™360 ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ C æ— é™åˆ¶ 10ä¸ªæœˆå‰ 1941 Heisenberg ç™¾åº¦ç†Šç…§ ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ Java æ— é™åˆ¶ 2ä¸ªæœˆå‰ 197 TribeDB ä¸ªäºº ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ NodeJS æ— é™åˆ¶ 3ä¸ªæœˆå‰ 126 ShardingJDBC å½“å½“ å®¢æˆ·ç«¯æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ Java Java å½“å¤© 1144 Shark ä¸ªäºº å®¢æˆ·ç«¯æ¶æ„ MySQL æœ‰ æœ‰ æ—  æ—  æ˜¯ Java Java ä¸¤å¤©å‰ 84 KingShard ä¸ªäºº ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ Golang æ— é™åˆ¶ ä¸¤å¤©å‰ 1836 OneProxy å¹³æ°‘è½¯ä»¶ ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  å¦ æœªçŸ¥ æ— é™åˆ¶ æœªçŸ¥ æœªçŸ¥ MyCat ç¤¾åŒº ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ Java æ— é™åˆ¶ ä¸¤å¤©å‰ 1270 Vitess Youtube ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æœ‰ æ—  æ˜¯ Golang æ— é™åˆ¶ å½“å¤© 3636 Mixer ä¸ªäºº ä»£ç†æ¶æ„ MySQL æœ‰ æœ‰ æ—  æ—  æ˜¯ Golang æ— é™åˆ¶ 9ä¸ªæœˆå‰ 472 JetPants Tumblr å®¢æˆ·ç«¯æ¶æ„ MySQL æœ‰ æœ‰ æ—  æ—  æ˜¯ Ruby Ruby 10ä¸ªæœˆå‰ 957 HibernateShard Hibernate å®¢æˆ·ç«¯æ¶æ„ æ— é™åˆ¶ æœ‰ æœ‰ æ—  æ—  æ˜¯ Java Java 4å¹´å‰ 57 MybatisShard MakerSoft å®¢æˆ·ç«¯æ¶æ„ æ— é™åˆ¶ æœ‰ æœ‰ æ—  æ—  æ˜¯ Java Java 11ä¸ªæœˆå‰ 119 Gizzard Twitter ä»£ç†æ¶æ„ æ— é™åˆ¶ æœ‰ æœ‰ æ—  æ—  æ˜¯ Java æ— é™åˆ¶ 3å¹´å‰ 2087 å¦‚æ­¤å¤šçš„æ–¹æ¡ˆï¼Œå¦‚ä½•è¿›è¡Œé€‰æ‹©ï¼Ÿå¯ä»¥æŒ‰ä»¥ä¸‹æ€è·¯æ¥è€ƒè™‘ï¼š ç¡®å®šæ˜¯ä½¿ç”¨ä»£ç†æ¶æ„è¿˜æ˜¯å®¢æˆ·ç«¯æ¶æ„ã€‚ä¸­å°å‹è§„æ¨¡æˆ–æ˜¯æ¯”è¾ƒç®€å•çš„åœºæ™¯å€¾å‘äºé€‰æ‹©å®¢æˆ·ç«¯æ¶æ„ï¼Œå¤æ‚åœºæ™¯æˆ–å¤§è§„æ¨¡ç³»ç»Ÿå€¾å‘é€‰æ‹©ä»£ç†æ¶æ„ å…·ä½“åŠŸèƒ½æ˜¯å¦æ»¡è¶³ï¼Œæ¯”å¦‚éœ€è¦è·¨èŠ‚ç‚¹ORDER BYï¼Œé‚£ä¹ˆæ”¯æŒè¯¥åŠŸèƒ½çš„ä¼˜å…ˆè€ƒè™‘ ä¸è€ƒè™‘ä¸€å¹´å†…æ²¡æœ‰æ›´æ–°çš„äº§å“ï¼Œè¯´æ˜å¼€å‘åœæ»ï¼Œç”šè‡³æ— äººç»´æŠ¤å’ŒæŠ€æœ¯æ”¯æŒ æœ€å¥½æŒ‰å¤§å…¬å¸-&gt;ç¤¾åŒº-&gt;å°å…¬å¸-&gt;ä¸ªäººè¿™æ ·çš„å‡ºå“æ–¹é¡ºåºæ¥é€‰æ‹© é€‰æ‹©å£ç¢‘è¾ƒå¥½çš„ï¼Œæ¯”å¦‚githubæ˜Ÿæ•°ã€ä½¿ç”¨è€…æ•°é‡è´¨é‡å’Œä½¿ç”¨è€…åé¦ˆ å¼€æºçš„ä¼˜å…ˆï¼Œå¾€å¾€é¡¹ç›®æœ‰ç‰¹æ®Šéœ€æ±‚å¯èƒ½éœ€è¦æ”¹åŠ¨æºä»£ç  æŒ‰ç…§ä¸Šè¿°æ€è·¯ï¼Œæ¨èä»¥ä¸‹é€‰æ‹©ï¼š å®¢æˆ·ç«¯æ¶æ„ï¼šShardingJDBC ä»£ç†æ¶æ„ï¼šMyCatæˆ–è€…Atlas å…¼å®¹MySQLä¸”å¯æ°´å¹³æ‰©å±•çš„æ•°æ®åº“ç›®å‰ä¹Ÿæœ‰ä¸€äº›å¼€æºæ•°æ®åº“å…¼å®¹MySQLåè®®ï¼Œå¦‚ï¼š TiDB Cubrid ä½†å…¶å·¥ä¸šå“è´¨å’ŒMySQLå°šæœ‰å·®è·ï¼Œä¸”éœ€è¦è¾ƒå¤§çš„è¿ç»´æŠ•å…¥ï¼Œå¦‚æœæƒ³å°†åŸå§‹çš„MySQLè¿ç§»åˆ°å¯æ°´å¹³æ‰©å±•çš„æ–°æ•°æ®åº“ä¸­ï¼Œå¯ä»¥è€ƒè™‘ä¸€äº›äº‘æ•°æ®åº“ï¼š é˜¿é‡Œäº‘PetaData é˜¿é‡Œäº‘OceanBase è…¾è®¯äº‘DCDB NoSQLåœ¨MySQLä¸ŠåšShardingæ˜¯ä¸€ç§æˆ´ç€é•£é“çš„è·³èˆï¼Œäº‹å®ä¸Šå¾ˆå¤šå¤§è¡¨æœ¬èº«å¯¹MySQLè¿™ç§RDBMSçš„éœ€æ±‚å¹¶ä¸å¤§ï¼Œå¹¶ä¸è¦æ±‚ACIDï¼Œå¯ä»¥è€ƒè™‘å°†è¿™äº›è¡¨è¿ç§»åˆ°NoSQLï¼Œå½»åº•è§£å†³æ°´å¹³æ‰©å±•é—®é¢˜ï¼Œä¾‹å¦‚ï¼š æ—¥å¿—ç±»ã€ç›‘æ§ç±»ã€ç»Ÿè®¡ç±»æ•°æ® éç»“æ„åŒ–æˆ–å¼±ç»“æ„åŒ–æ•°æ® å¯¹äº‹åŠ¡è¦æ±‚ä¸å¼ºï¼Œä¸”æ— å¤ªå¤šå…³è”æ“ä½œçš„æ•°æ®","tags":["MySQL","DataBase","SQLä¼˜åŒ–"],"categories":["DataBase"]},{"title":"MyBatis çš„æ‰§è¡Œæµç¨‹","path":"/2023/12/24/MyBatis-çš„æ‰§è¡Œæµç¨‹ï¼/","content":"æ¦‚è¦åœ¨MyBatisä¸­ï¼Œåˆ©ç”¨ç¼–ç¨‹å¼è¿›è¡Œæ•°æ®æŸ¥è¯¢ï¼Œä¸»è¦å°±æ˜¯ä¸‹é¢å‡ è¡Œä»£ç ï¼š 123SqlSession session = sqlSessionFactory.openSession();UserMapper userMapper = session.getMapper(UserMapper.class);List&lt;LwUser&gt; userList = userMapper.listUserByUserName(&quot;å­¤ç‹¼1å·&quot;); ç¬¬ä¸€è¡Œæ˜¯è·å–ä¸€ä¸ªSqlSessionå¯¹è±¡åœ¨ä¸Šä¸€ç¯‡æ–‡ç« åˆ†æè¿‡äº†ï¼Œç¬¬äºŒè¡Œå°±æ˜¯è·å–UserMapperæ¥å£ï¼Œç¬¬ä¸‰è¡Œä¸€è¡Œä»£ç å°±å®ç°äº†æ•´ä¸ªæŸ¥è¯¢è¯­å¥çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ä»”ç»†åˆ†æä¸€ä¸‹ç¬¬äºŒå’Œç¬¬ä¸‰æ­¥ã€‚ è·å–Mapperæ¥å£(getMapper)ç¬¬äºŒæ­¥æ˜¯é€šè¿‡SqlSessionå¯¹è±¡æ˜¯è·å–ä¸€ä¸ªMapperæ¥å£ï¼Œè¿™ä¸ªæµç¨‹è¿˜æ˜¯ç›¸å¯¹ç®€å•çš„ï¼Œä¸‹é¢å°±æ˜¯æˆ‘ä»¬è°ƒç”¨session.getMapperæ–¹æ³•ä¹‹åçš„è¿è¡Œæ—¶åºå›¾ï¼š 1ã€åœ¨è°ƒç”¨getMapperä¹‹åï¼Œä¼šå»Configurationå¯¹è±¡ä¸­è·å–Mapperå¯¹è±¡ï¼Œå› ä¸ºåœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™å°±ä¼šæŠŠMapperæ¥å£åŠ è½½å¹¶è§£æå­˜å‚¨åˆ°Configurationå¯¹è±¡ 2ã€é€šè¿‡Configurationå¯¹è±¡ä¸­çš„MapperRegistryå¯¹è±¡å±æ€§ï¼Œç»§ç»­è°ƒç”¨getMapperæ–¹æ³• 3ã€æ ¹æ®typeç±»å‹ï¼Œä»MapperRegistryå¯¹è±¡ä¸­çš„knownMappersè·å–åˆ°å½“å‰ç±»å‹å¯¹åº”çš„ä»£ç†å·¥å‚ç±»ï¼Œç„¶åé€šè¿‡ä»£ç†å·¥å‚ç±»ç”Ÿæˆå¯¹åº”Mapperçš„ä»£ç†ç±» 4ã€æœ€ç»ˆè·å–åˆ°æˆ‘ä»¬æ¥å£å¯¹åº”çš„ä»£ç†ç±»MapperProxyå¯¹è±¡ è€ŒMapperProxyå¯ä»¥çœ‹åˆ°å®ç°äº†InvocationHandlerï¼Œä½¿ç”¨çš„å°±æ˜¯JDKåŠ¨æ€ä»£ç†ã€‚ è‡³æ­¤è·å–Mapperæµç¨‹ç»“æŸäº†ï¼Œé‚£ä¹ˆå°±æœ‰ä¸€ä¸ªé—®é¢˜äº†MapperRegistryå¯¹è±¡å†…çš„HashMapå±æ€§knownMappersä¸­çš„æ•°æ®æ˜¯ä»€ä¹ˆæ—¶å€™å­˜è¿›å»çš„å‘¢ï¼Ÿ Mapperæ¥å£å’Œæ˜ å°„æ–‡ä»¶æ˜¯ä½•æ—¶å…³è”çš„Mapperæ¥å£åŠå…¶æ˜ å°„æ–‡ä»¶æ˜¯åœ¨åŠ è½½mybatis-configé…ç½®æ–‡ä»¶çš„æ—¶å€™å­˜å‚¨è¿›å»çš„ï¼Œä¸‹é¢å°±æ˜¯æ—¶åºå›¾ï¼š 1ã€é¦–å…ˆæˆ‘ä»¬ä¼šæ‰‹åŠ¨è°ƒç”¨SqlSessionFactoryBuilderæ–¹æ³•ä¸­çš„build()æ–¹æ³•ï¼š 2ã€ç„¶åä¼šæ„é€ ä¸€ä¸ªXMLConfigBuilderå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶parseæ–¹æ³•ï¼š 3ã€ç„¶åä¼šç»§ç»­è°ƒç”¨è‡ªå·±çš„parseConfigurationæ¥è§£æé…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œé¢å°±ä¼šåˆ†åˆ«å»è§£æå…¨å±€é…ç½®æ–‡ä»¶çš„é¡¶çº§èŠ‚ç‚¹ï¼Œå…¶ä»–çš„æˆ‘ä»¬å…ˆä¸çœ‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹æœ€åè§£æmappersèŠ‚ç‚¹ 4ã€ç»§ç»­è°ƒç”¨è‡ªå·±çš„mapperElementæ¥è§£æmappersæ–‡ä»¶ï¼ˆè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œä¸ºäº†æ–¹ä¾¿æˆªå›¾å®Œæ•´ï¼Œæ‰€ä»¥æŠŠå­—ä½“ç¼©å°äº†1å·ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œé¢åˆ†äº†å››ç§æ–¹å¼æ¥è§£æmappersèŠ‚ç‚¹çš„é…ç½®ï¼Œå¯¹åº”äº†4ç§mapperé…ç½®æ–¹å¼ï¼Œè€Œå…¶ä¸­çº¢æ¡†å†…çš„ä¸¤ç§æ–¹å¼æ˜¯ç›´æ¥é…ç½®çš„xmlæ˜ å°„æ–‡ä»¶ï¼Œè“æ¡†å†…çš„ä¸¤ç§æ–¹å¼æ˜¯è§£æç›´æ¥é…ç½®Mapperæ¥å£çš„æ–¹å¼ï¼Œä»è¿™é‡Œä¹Ÿå¯ä»¥è¯´æ˜ï¼Œä¸è®ºé…ç½®å“ªç§æ–¹å¼ï¼Œæœ€ç»ˆMyBatiséƒ½ä¼šå°†xmlæ˜ å°„æ–‡ä»¶å’ŒMapperæ¥å£è¿›è¡Œå…³è”ã€‚ 5ã€æˆ‘ä»¬å…ˆçœ‹ç¬¬2ç§å’Œç¬¬3ä¸­ï¼ˆç›´æ¥é…ç½®xmlæ˜ å°„æ–‡ä»¶çš„è§£ææ–¹å¼ï¼‰ï¼Œä¼šæ„å»ºä¸€ä¸ªXMLMapperBuilderå¯¹è±¡å¹¶è°ƒç”¨å…¶parseæ–¹æ³•ã€‚ å½“ç„¶ï¼Œè¿™ä¸ªè¿˜æ˜¯ä¼šè¢«è§£æçš„ï¼Œåé¢æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™ä¼šå†æ¬¡é€šè¿‡ä¸æ–­éå†å»å…¨éƒ¨è§£æå®Œæ¯•ï¼Œä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œäº’ç›¸å¼•ç”¨è¿™ç§æ˜¯ä¼šå¯¼è‡´è§£æå¤±è´¥æŠ¥é”™çš„ï¼Œæ‰€ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬åº”è¯¥é¿å…å¾ªç¯ä¾èµ–çš„äº§ç”Ÿã€‚ 6ã€è§£æå®Œæ˜ å°„æ–‡ä»¶ä¹‹åï¼Œè°ƒç”¨è‡ªèº«æ–¹æ³•bindMapperForNamespaceï¼Œå¼€å§‹ç»‘å®šMapperæ¥å£å’Œæ˜ å°„æ–‡ä»¶ï¼š 7ã€è°ƒç”¨Configurationå¯¹è±¡çš„addMapper 8ã€è°ƒç”¨Configurationå¯¹è±¡çš„å±æ€§MapperRegistryå†…çš„addMapperæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ­£å¼å°†Mapperæ¥å£æ·»åŠ åˆ°knownMappersï¼Œæ‰€ä»¥ä¸Šé¢getMapperå¯ä»¥ç›´æ¥è·å–ï¼š åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†Mapperæ¥å£å’Œxmlæ˜ å°„æ–‡ä»¶çš„ç»‘å®š 9ã€æ³¨æ„ä¸Šé¢çº¢æ¡†é‡Œé¢çš„ä»£ç ï¼Œåˆè°ƒç”¨äº†ä¸€æ¬¡parseæ–¹æ³•ï¼Œè¿™ä¸ªparseæ–¹æ³•ä¸»è¦æ˜¯è§£ææ³¨è§£ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¯­å¥ï¼š 12@Select(&quot;select * from lw_user&quot;)List&lt;LwUser&gt; listAllUser(); æ‰€ä»¥è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¼šå»è§£æ@Selectç­‰æ³¨è§£ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œparseæ–¹æ³•é‡Œé¢ä¼šåŒæ—¶å†è§£æä¸€æ¬¡xmlæ˜ å°„æ–‡ä»¶ï¼Œå› ä¸ºä¸Šé¢æˆ‘ä»¬æåˆ°äº†mappersèŠ‚ç‚¹æœ‰4ç§é…ç½®æ–¹å¼ï¼Œå…¶ä¸­ä¸¤ç§é…ç½®çš„æ˜¯Mapperæ¥å£ï¼Œè€Œé…ç½®Mapperæ¥å£ä¼šç›´æ¥å…ˆè°ƒç”¨addMapperæ¥å£ï¼Œå¹¶æ²¡æœ‰è§£ææ˜ å°„æ–‡ä»¶ï¼Œæ‰€ä»¥è¿›å…¥æ³¨è§£è§£ææ–¹æ³•parseä¹‹ä¸­ä¼šéœ€è¦å†å°è¯•è§£æä¸€æ¬¡XMLæ˜ å°„æ–‡ä»¶ã€‚ è§£æå®Œæˆä¹‹åï¼Œè¿˜ä¼šå¯¹Mapperæ¥å£ä¸­çš„æ–¹æ³•è¿›è¡Œè§£æï¼Œå¹¶å°†æ¯ä¸ªæ–¹æ³•çš„å…¨é™å®šç±»åä½œä¸ºkeyå­˜å…¥å­˜å…¥Configurationä¸­çš„mappedStatementså±æ€§ã€‚ éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œè¿™é‡Œå­˜å‚¨çš„æ—¶å€™ï¼ŒåŒä¸€ä¸ªvalueä¼šå­˜å‚¨2æ¬¡ï¼Œ**ä¸€ä¸ªå…¨é™å®šåä½œä¸ºkeyï¼Œå¦ä¸€ä¸ªå°±æ˜¯åªç”¨æ–¹æ³•å(sqlè¯­å¥çš„id)æ¥ä½œä¸ºkey**ï¼š æ‰€ä»¥æœ€ç»ˆmappedStatementsä¼šæ˜¯ä¸‹é¢çš„æƒ…å†µï¼š äº‹å®ä¸Šå¦‚æœæˆ‘ä»¬é€šè¿‡æ¥å£çš„æ–¹å¼æ¥ç¼–ç¨‹çš„è¯ï¼Œæœ€åæ¥getStatementçš„æ—¶å€™ï¼Œéƒ½æ˜¯æ ¹æ®å…¨é™å®šåæ¥å–çš„ï¼Œæ‰€ä»¥å³ä½¿æœ‰é‡åå¯¹æˆ‘ä»¬ä¹Ÿæ²¡æœ‰å½±å“ï¼Œè€Œä¹‹æ‰€ä»¥è¦è¿™ä¹ˆåšçš„åŸå› å…¶å®è¿˜æ˜¯ä¸ºäº†å…¼å®¹æ—©æœŸç‰ˆæœ¬çš„ç”¨æ³•ï¼Œé‚£å°±æ˜¯ä¸é€šè¿‡æ¥å£ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡æ–¹æ³•åçš„æ–¹å¼æ¥è¿›è¡ŒæŸ¥è¯¢ï¼š 1session.selectList(&quot;com.lonelyWolf.mybatis.mapper.UserMapper.listAllUser&quot;); è¿™é‡Œå¦‚æœshortNameæ²¡æœ‰é‡å¤çš„è¯ï¼Œæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ç®€å†™æ¥æŸ¥è¯¢çš„ï¼š 1session.selectList(&quot;listAllUser&quot;); ä½†æ˜¯é€šè¿‡ç®€å†™æ¥æŸ¥è¯¢ä¸€æ—¦shortNameé‡å¤äº†å°±ä¼šæŠ›å‡ºä»¥ä¸‹å¼‚å¸¸ï¼š è¿™é‡Œçš„å¼‚å¸¸å…¶å®å°±æ˜¯StrickMapçš„getæ–¹æ³•æŠ›å‡ºæ¥çš„ï¼š sqlæ‰§è¡Œæµç¨‹åˆ†æä¸Šé¢æˆ‘ä»¬è®²åˆ°äº†ï¼Œè·å–åˆ°çš„Mapperæ¥å£å®é™…ä¸Šè¢«åŒ…è£…æˆä¸ºäº†ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰§è¡ŒæŸ¥è¯¢è¯­å¥è‚¯å®šæ˜¯æ‰§è¡Œçš„ä»£ç†å¯¹è±¡æ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»¥Mapperæ¥å£çš„ä»£ç†å¯¹è±¡MapperProxyæ¥åˆ†æä¸€ä¸‹æŸ¥è¯¢æµç¨‹ã€‚ æ•´ä¸ªsqlæ‰§è¡Œæµç¨‹å¯ä»¥åˆ†ä¸ºä¸¤å¤§æ­¥éª¤ï¼š ä¸€ã€å¯»æ‰¾sql äºŒã€æ‰§è¡Œsqlè¯­å¥ å¯»æ‰¾sqlé¦–å…ˆè¿˜æ˜¯æ¥çœ‹ä¸€ä¸‹å¯»æ‰¾sqlè¯­å¥çš„æ—¶åºå›¾ï¼š 1ã€äº†è§£ä»£ç†æ¨¡å¼çš„åº”è¯¥éƒ½çŸ¥é“ï¼Œè°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•ä¹‹åå®é™…ä¸Šæ‰§è¡Œçš„å°±æ˜¯ä»£ç†å¯¹è±¡çš„invokeæ–¹æ³• 2ã€å› ä¸ºæˆ‘ä»¬è¿™é‡Œå¹¶æ²¡æœ‰è°ƒç”¨Objectç±»ä¸­çš„æ–¹æ³•ï¼Œæ‰€ä»¥è‚¯å®šèµ°çš„elseã€‚elseä¸­ä¼šç»§ç»­è°ƒç”¨MapperProxyå†…éƒ¨ç±»MapperMethodInvokerä¸­çš„æ–¹æ³•cachedInvokerï¼Œè¿™é‡Œé¢ä¼šæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œåˆ¤æ–­ä¸€ä¸‹æˆ‘ä»¬æ˜¯ä¸æ˜¯defaultæ–¹æ³•ï¼Œå› ä¸ºJdk1.8ä¸­æ¥å£ä¸­å¯ä»¥æ–°å¢defaultæ–¹æ³•ï¼Œè€Œdefaultæ–¹æ³•æ˜¯å¹¶ä¸æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆåˆšå¼€å§‹ä¼šä»ç¼“å­˜é‡Œé¢å–ï¼Œç¼“å­˜ç›¸å…³çŸ¥è¯†æˆ‘ä»¬è¿™é‡Œå…ˆä¸è®²ï¼Œåé¢ä¼šå•ç‹¬å†™ä¸€ç¯‡æ¥åˆ†æä¸€ä¸‹ç¼“å­˜)ï¼‰ã€‚ 3ã€æ¥ä¸‹æ¥ï¼Œæ˜¯æ„é€ ä¸€ä¸ªMapperMethodå¯¹è±¡,è¿™ä¸ªå¯¹è±¡å°è£…äº†Mapperæ¥å£ä¸­å¯¹åº”çš„æ–¹æ³•ä¿¡æ¯ä»¥åŠå¯¹åº”çš„sqlè¯­å¥ä¿¡æ¯ï¼š è¿™é‡Œé¢å°±ä¼šæŠŠè¦æ‰§è¡Œçš„sqlè¯­å¥ï¼Œè¯·æ±‚å‚æ•°ï¼Œæ–¹æ³•è¿”å›å€¼å…¨éƒ¨è§£æå°è£…æˆMapperMethodå¯¹è±¡ï¼Œç„¶ååé¢å°±å¯ä»¥å¼€å§‹å‡†å¤‡æ‰§è¡Œsqlè¯­å¥äº† æ‰§è¡Œsqlè¯­å¥è¿˜æ˜¯å…ˆæ¥çœ‹ä¸€ä¸‹æ‰§è¡ŒSqlè¯­å¥çš„æ—¶åºå›¾ï¼š 1ã€æˆ‘ä»¬ç»§ç»­ä¸Šé¢çš„æµç¨‹è¿›å…¥executeæ–¹æ³•ï¼š 2ã€è¿™é‡Œé¢ä¼šæ ¹æ®è¯­å¥ç±»å‹ä»¥åŠè¿”å›å€¼ç±»å‹æ¥å†³å®šå¦‚ä½•æ‰§è¡Œï¼Œæœ¬äººè¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ªé›†åˆï¼Œæ•…è€Œæˆ‘ä»¬è¿›å…¥executeForManyæ–¹æ³•ï¼š 3ã€è¿™é‡Œé¢é¦–å…ˆä¼šå°†å‰é¢å­˜å¥½çš„å‚æ•°è¿›è¡Œä¸€æ¬¡è½¬æ¢ï¼Œç„¶åç»•äº†è¿™ä¹ˆä¸€åœˆï¼Œå›åˆ°äº†èµ·ç‚¹SqlSessionå¯¹è±¡ï¼Œç»§ç»­è°ƒç”¨selectListæ–¹æ³•ï¼š 3ã€æ¥ä¸‹æ¥åˆè®²æµç¨‹å§”æ´¾ç»™äº†Executeå»æ‰§è¡Œqueryæ–¹æ³•ï¼Œæœ€ç»ˆåˆä¼šå»è°ƒç”¨queryFromDatabaseæ–¹æ³•ï¼š 4ã€åˆ°è¿™é‡Œä¹‹åï¼Œç»ˆäºè¦è¿›å…¥æ­£é¢˜äº†ï¼Œä¸€èˆ¬å¸¦äº†è¿™ç§doå¼€å¤´çš„æ–¹æ³•å°±æ˜¯çœŸæ­£åšäº‹çš„ï¼ŒSpringä¸­å¾ˆå¤šåœ°æ–¹ä¹Ÿæ˜¯é‡‡ç”¨çš„è¿™ç§å‘½åæ–¹å¼ï¼š æ³¨æ„ï¼Œå‰é¢æˆ‘ä»¬çš„sqlè¯­å¥è¿˜æ˜¯å ä½ç¬¦çš„æ–¹å¼ï¼Œå¹¶æ²¡æœ‰å°†å‚æ•°è®¾ç½®è¿›å»ï¼Œæ‰€ä»¥è¿™é‡Œåœ¨returnä¸Šé¢ä¸€è¡Œè°ƒç”¨prepareStatementæ–¹æ³•åˆ›å»ºStatementå¯¹è±¡çš„æ—¶å€™ä¼šå»è®¾ç½®å‚æ•°ï¼Œæ›¿æ¢å ä½ç¬¦ã€‚å‚æ•°å¦‚ä½•è®¾ç½®æˆ‘ä»¬å…ˆè·³è¿‡ï¼Œç­‰æŠŠæµç¨‹æ‰§è¡Œå®Œäº†æˆ‘ä»¬åœ¨å•ç‹¬åˆ†æå‚æ•°æ˜ å°„å’Œç»“æœé›†æ˜ å°„ã€‚ 5ã€ç»§ç»­è¿›å…¥PreparedStatementHandlerå¯¹è±¡çš„queryæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸€æ­¥å°±æ˜¯è°ƒç”¨äº†jdbcæ“ä½œå¯¹è±¡PreparedStatementä¸­çš„executeæ–¹æ³•ï¼Œæœ€åä¸€æ­¥å°±æ˜¯è½¬æ¢ç»“æœé›†ç„¶åè¿”å›ã€‚ åˆ°è¿™é‡Œï¼Œæ•´ä¸ªSQLè¯­å¥æ‰§è¡Œæµç¨‹åˆ†æå°±ç»“æŸäº†ï¼Œä¸­é€”æœ‰ä¸€äº›å‚æ•°çš„å­˜å‚¨ä»¥åŠè½¬æ¢å¹¶æ²¡æœ‰æ·±å…¥è¿›å»ï¼Œå› ä¸ºå‚æ•°çš„è½¬æ¢å¹¶ä¸æ˜¯æ ¸å¿ƒï¼Œåªè¦æ¸…æ¥šæ•´ä¸ªæ•°æ®çš„æµè½¬æµç¨‹ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„å®ç°æ–¹å¼ï¼Œåªè¦å­˜èµ·æ¥æœ€åæˆ‘ä»¬èƒ½é‡æ–°è§£æè¯»å‡ºæ¥å°±è¡Œã€‚ å‚æ•°æ˜ å°„ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸Šé¢åœ¨æ‰§è¡ŒæŸ¥è¯¢ä¹‹å‰å‚æ•°æ˜¯å¦‚ä½•è¿›è¡Œè®¾ç½®çš„ï¼Œæˆ‘ä»¬å…ˆè¿›å…¥prepareStatementæ–¹æ³•ï¼š æˆ‘ä»¬å‘ç°ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨äº†StatementHandlerä¸­çš„parameterizeè¿›è¡Œå‚æ•°è®¾ç½®ï¼Œæ¥ä¸‹æ¥è¿™é‡Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæˆ‘ä»¬ä¸ä¼šä¸€æ­¥æ­¥ç‚¹è¿›å»ï¼Œç›´æ¥è¿›å…¥è®¾ç½®å‚æ•°çš„æ–¹æ³•ï¼š ä¸Šé¢çš„BaseTypeHandleræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒsetNonNullParameterå¹¶æ²¡æœ‰å®ç°ï¼Œéƒ½æ˜¯äº¤ç»™å­ç±»å»å®ç°ï¼Œè€Œæ¯ä¸€ä¸ªå­ç±»å°±æ˜¯å¯¹åº”äº†æ•°æ®åº“çš„ä¸€ç§ç±»å‹ã€‚ä¸‹å›¾ä¸­å°±æ˜¯é»˜è®¤çš„ä¸€ä¸ªå­ç±»StringTypeHandlerï¼Œé‡Œé¢æ²¡ä»€ä¹ˆå…¶ä»–é€»è¾‘ï¼Œå°±æ˜¯è®¾ç½®å‚æ•°ã€‚ å¯ä»¥çœ‹åˆ°Stringé‡Œé¢è°ƒç”¨äº†jdbcä¸­çš„setStringæ–¹æ³•ï¼Œè€Œå¦‚æœæ˜¯intä¹Ÿä¼šè°ƒç”¨setIntæ–¹æ³•ã€‚çœ‹åˆ°è¿™äº›å­ç±»å¦‚æœå¤§å®¶ä¹‹å‰é˜…è¯»è¿‡æˆ‘å‰é¢è®²çš„MyBatiså‚æ•°é…ç½®ï¼Œåº”è¯¥å°±å¾ˆæ˜æ˜¾å¯ä»¥çŸ¥é“ï¼Œè¿™äº›å­ç±»å°±æ˜¯ç³»ç»Ÿé»˜è®¤æä¾›çš„ä¸€äº›typeHandlerã€‚è€Œè¿™äº›é»˜è®¤çš„typeHandlerä¼šé»˜è®¤è¢«æ³¨å†Œå¹¶å’ŒJavaå¯¹è±¡è¿›è¡Œç»‘å®šï¼š æ­£æ˜¯å› ä¸ºMyBatisä¸­é»˜è®¤æä¾›äº†å¸¸ç”¨æ•°æ®ç±»å‹çš„æ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬å†™Sqlçš„æ—¶å€™æ‰å¯ä»¥çœç•¥å‚æ•°æ˜ å°„å…³ç³»ï¼Œå¯ä»¥ç›´æ¥é‡‡ç”¨ä¸‹é¢çš„æ–¹å¼ï¼Œç³»ç»Ÿå¯ä»¥æ ¹æ®æˆ‘ä»¬å‚æ•°çš„ç±»å‹ï¼Œè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„typeHanderè¿›è¡Œæ˜ å°„ï¼š 1select user_id,user_name from lw_user where user_name=#&#123;userName&#125; ä¸Šé¢è¿™æ¡è¯­å¥å®é™…ä¸Šå’Œä¸‹é¢è¿™æ¡æ˜¯ç­‰ä»·çš„ï¼š 1select user_id,user_name from lw_user where user_name=#&#123;userName,jdbcType=VARCHAR&#125; æˆ–è€…è¯´æˆ‘ä»¬å¯ä»¥ç›´æ¥æŒ‡å®štypeHandlerï¼š 1select user_id,user_name from lw_user where user_name = #&#123;userName,jdbcType=VARCHAR,typeHandler=org.apache.ibatis.type.IntegerTypeHandler&#125; è¿™é‡Œå› ä¸ºæˆ‘ä»¬é…ç½®äº†typeHandlerï¼Œæ‰€ä»¥ä¼šä¼˜å…ˆä»¥é…ç½®çš„typeHandlerä¸ºä¸»ä¸ä¼šå†å»è¯»å–é»˜è®¤çš„æ˜ å°„ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…å°±ä¼šç›´æ¥æŠ¥é”™äº†ï¼š çœ‹åˆ°è¿™é‡Œå¾ˆå¤šäººåº”è¯¥å°±çŸ¥é“äº†ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå·±è‡ªå®šä¹‰ä¸€ä¸ªtypeHandlerï¼Œç„¶åå°±å¯ä»¥é…ç½®æˆæˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰ç±»ã€‚æ‰€ä»¥æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªtypeHandler è‡ªå®šä¹‰typeHandlerè‡ªå®šä¹‰typeHandleréœ€è¦å®ç°BaseTypeHandleræ¥å£ï¼ŒBaseTypeHandleræœ‰4ä¸ªæ–¹æ³•ï¼ŒåŒ…æ‹¬ç»“æœé›†æ˜ å°„ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œä»£ç æ²¡æœ‰å†™ä¸Šæ¥ï¼š 1234567891011121314151617package com.lonelyWolf.mybatis.typeHandler;import org.apache.ibatis.type.BaseTypeHandler;import org.apache.ibatis.type.JdbcType;import java.sql.CallableStatement;import java.sql.PreparedStatement;import java.sql.ResultSet;import java.sql.SQLException;public class MyTypeHandler extends BaseTypeHandler&lt;String&gt; &#123; @Override public void setNonNullParameter(PreparedStatement preparedStatement, int index, String param, JdbcType jdbcType) throws SQLException &#123; System.out.println(&quot;è‡ªå®šä¹‰typeHandlerç”Ÿæ•ˆäº†&quot;); preparedStatement.setString(index,param); &#125; ç„¶åæˆ‘ä»¬æ”¹å†™ä¸€ä¸‹ä¸Šé¢çš„æŸ¥è¯¢è¯­å¥ï¼š 1select user_id,user_name from lw_user where user_name=#&#123;userName,jdbcType=VARCHAR,typeHandler=com.lonelyWolf.mybatis.typeHandler.MyTypeHandler&#125; ç„¶åæ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè‡ªå®šä¹‰çš„typeHandlerç”Ÿæ•ˆäº†ï¼š ç»“æœé›†æ˜ å°„æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹ç»“æœé›†çš„æ˜ å°„ï¼Œå›åˆ°ä¸Šé¢æ‰§è¡Œsqlæµç¨‹çš„æœ€åä¸€ä¸ªæ–¹æ³•ï¼š 1resultSetHandler.handleResultSets(ps) ç»“æœé›†æ˜ å°„é‡Œé¢çš„é€»è¾‘ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œå› ä¸ºè¦è€ƒè™‘åˆ°éå¸¸å¤šçš„æƒ…å†µï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸ä¼šå»æ·±ç©¶æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œç›´æ¥è¿›å…¥åˆ°æ­£å¼è§£æç»“æœé›†çš„ä»£ç ï¼Œä¸‹é¢çš„5ä¸ªä»£ç ç‰‡æ®µå°±æ˜¯ä¸€ä¸ªç®€å•çš„ä½†æ˜¯å®Œæ•´çš„è§£ææµç¨‹ï¼š ä»ä¸Šé¢çš„ä»£ç ç‰‡æ®µæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šè§£æç»“æœé›†è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼Œå°±å¦‚æˆ‘ä»¬ä¸Šä¸€ç¯‡ä»‹ç»çš„å¤æ‚æŸ¥è¯¢ä¸€æ ·ï¼Œä¸€ä¸ªæŸ¥è¯¢å¯ä»¥ä¸æ–­åµŒå¥—å…¶ä»–æŸ¥è¯¢ï¼Œè¿˜æœ‰å»¶è¿ŸåŠ è½½ç­‰ç­‰ä¸€äº›å¤æ‚çš„ç‰¹æ€§çš„å¤„ç†ï¼Œæ‰€ä»¥é€»è¾‘åˆ†æ”¯æ˜¯æœ‰å¾ˆå¤šï¼Œä½†æ˜¯ä¸ç®¡æ€ä¹ˆå¤„ç†ï¼Œæœ€åçš„æ ¸å¿ƒè¿˜æ˜¯ä¸Šé¢çš„ä¸€å¥—æµç¨‹ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨typeHandleræ¥è·å–æŸ¥è¯¢åˆ°çš„ç»“æœã€‚ æ˜¯çš„ï¼Œä½ æ²¡çŒœé”™ï¼Œè¿™ä¸ªå°±æ˜¯ä¸Šé¢æˆ‘ä»¬æ˜ å°„å‚æ•°çš„typeHandlerï¼Œå› ä¸ºtypeHandleré‡Œé¢ä¸åªæ˜¯ä¸€ä¸ªè®¾ç½®å‚æ•°æ–¹æ³•ï¼Œè¿˜æœ‰è·å–ç»“æœé›†æ–¹æ³•(ä¸Šé¢è®¾ç½®å‚æ•°çš„æ—¶å€™çœç•¥äº†)ã€‚ è‡ªå®šä¹‰typeHandlerç»“æœé›†æ‰€ä»¥è¯´æˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸Šé¢é‚£ä¸ªMyTypeHandler ä¾‹å­æ¥é‡å†™ä¸€ä¸‹å–å€¼æ–¹æ³•(çœç•¥äº†è®¾ç½®å‚æ•°æ–¹æ³•)ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.lonelyWolf.mybatis.typeHandler;import org.apache.ibatis.type.BaseTypeHandler;import org.apache.ibatis.type.JdbcType;import java.sql.CallableStatement;import java.sql.PreparedStatement;import java.sql.ResultSet;import java.sql.SQLException;public class MyTypeHandler extends BaseTypeHandler&lt;String&gt; &#123; /** * è®¾ç½®å‚æ•° */ @Override public void setNonNullParameter(PreparedStatement preparedStatement, int index, String param, JdbcType jdbcType) throws SQLException &#123; System.out.println(&quot;è®¾ç½®å‚æ•°-&gt;è‡ªå®šä¹‰typeHandlerç”Ÿæ•ˆäº†&quot;); preparedStatement.setString(index,param); &#125; /** * æ ¹æ®åˆ—åè·å–ç»“æœ */ @Override public String getNullableResult(ResultSet resultSet, String columnName) throws SQLException &#123; System.out.println(&quot;æ ¹æ®columnNameè·å–ç»“æœ-&gt;è‡ªå®šä¹‰typeHandlerç”Ÿæ•ˆäº†&quot;); return resultSet.getString(columnName); &#125; /** * æ ¹æ®åˆ—çš„ä¸‹æ ‡æ¥è·å–ç»“æœ */ @Override public String getNullableResult(ResultSet resultSet, int columnIndex) throws SQLException &#123; System.out.println(&quot;æ ¹æ®columnIndexè·å–ç»“æœ-&gt;è‡ªå®šä¹‰typeHandlerç”Ÿæ•ˆäº†&quot;); return resultSet.getString(columnIndex); &#125; /** * å¤„ç†å­˜å‚¨è¿‡ç¨‹çš„ç»“æœé›† */ @Override public String getNullableResult(CallableStatement callableStatement, int columnIndex) throws SQLException &#123; return callableStatement.getString(columnIndex); &#125;&#125; æ”¹å†™Mapperæ˜ å°„æ–‡ä»¶é…ç½®ï¼š 12345678&lt;resultMap id=&quot;MyUserResultMap&quot; type=&quot;lwUser&quot;&gt; &lt;result column=&quot;user_id&quot; property=&quot;userId&quot; jdbcType=&quot;VARCHAR&quot; typeHandler=&quot;com.lonelyWolf.mybatis.typeHandler.MyTypeHandler&quot; /&gt; &lt;result column=&quot;user_name&quot; property=&quot;userName&quot; jdbcType=&quot;VARCHAR&quot; /&gt;&lt;/resultMap&gt;&lt;select id=&quot;listUserByUserName&quot; parameterType=&quot;String&quot; resultMap=&quot;MyUserResultMap&quot;&gt; select user_id,user_name from lw_user where user_name=#&#123;userName,jdbcType=VARCHAR,typeHandler=com.lonelyWolf.mybatis.typeHandler.MyTypeHandler&#125;&lt;/select&gt; æ‰§è¡Œä¹‹åè¾“å‡ºå¦‚ä¸‹ï¼š å› ä¸ºæˆ‘ä»¬å±æ€§ä¸Šé¢åªé…ç½®äº†ä¸€ä¸ªå±æ€§ï¼Œæ‰€ä»¥åªè¾“å‡ºäº†ä¸€æ¬¡ã€‚ å·¥ä½œæµç¨‹å›¾ä¸Šé¢ä»‹ç»äº†ä»£ç çš„æµè½¬ï¼Œå¯èƒ½ç»•æ¥ç»•å»æœ‰ç‚¹æ™•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç”»ä¸€ä¸ªä¸»è¦çš„å¯¹è±¡ä¹‹é—´æµç¨‹å›¾æ¥æ›´åŠ æ¸…æ™°çš„å±•ç¤ºä¸€ä¸‹MyBatisä¸»è¦å·¥ä½œæµç¨‹ï¼š ä»ä¸Šé¢çš„å·¥ä½œæµç¨‹å›¾ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒSqlSessionä¸‹é¢è¿˜æœ‰4å¤§å¯¹è±¡ï¼Œè¿™4å¤§å¯¹è±¡ä¹Ÿå¾ˆé‡è¦ï¼Œåé¢å­¦ä¹ æ‹¦æˆªå™¨çš„æ—¶å€™å°±æ˜¯é’ˆå¯¹è¿™4å¤§å¯¹è±¡è¿›è¡Œçš„æ‹¦æˆªï¼Œå…³äºè¿™4å¤§å¯¹è±¡çš„å…·ä½“è¯¦æƒ…ï¼Œæˆ‘ä»¬ä¸‹ä¸€ç¯‡æ–‡ç« å†å±•å¼€åˆ†æã€‚ æ€»ç»“æœ¬æ–‡ä¸»è¦åˆ†æäº†MyBatisçš„SQLæ‰§è¡Œæµç¨‹ã€‚åœ¨åˆ†ææµç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¸¾ä¾‹è®ºè¯äº†å¦‚ä½•è‡ªå®šä¹‰typeHandleræ¥å®ç°è‡ªå®šä¹‰çš„å‚æ•°æ˜ å°„å’Œç»“æœé›†æ˜ å°„ï¼Œä¸è¿‡MyBatisä¸­æä¾›çš„é»˜è®¤æ˜ å°„å…¶å®å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†çš„éœ€æ±‚ï¼Œå¦‚æœæˆ‘ä»¬å¯¹æŸäº›å±æ€§éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé‚£ä¹ˆå°±å¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰çš„typeHandleræ¥å®ç°ï¼Œç›¸ä¿¡å¦‚æœæœ¬æ–‡å¦‚æœè¯»æ‡‚äº†ï¼Œä»¥ä¸‹å‡ ç‚¹å¤§å®¶åº”è¯¥è‡³å°‘ä¼šæœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ï¼š 1ã€Mapperæ¥å£å’Œæ˜ å°„æ–‡ä»¶æ˜¯å¦‚ä½•è¿›è¡Œç»‘å®šçš„ 2ã€MyBatisä¸­SQLè¯­å¥çš„æ‰§è¡Œæµç¨‹ 3ã€è‡ªå®šä¹‰MyBatisä¸­çš„å‚æ•°è®¾ç½®å¤„ç†å™¨typeHandler 4ã€è‡ªå®šä¹‰MyBatisä¸­ç»“æœé›†å¤„ç†å™¨typeHandler å½“ç„¶ï¼Œå…¶ä¸­å¾ˆå¤šç»†èŠ‚å¹¶æ²¡æœ‰æåˆ°ï¼Œè€Œçœ‹æºç æˆ‘ä»¬ä¹Ÿå¹¶ä¸éœ€è¦è¿½æ±‚æ¯ä¸€è¡Œä»£ç éƒ½èƒ½çœ‹æ‡‚ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œå³ä½¿æˆ‘ä»¬æ˜¯é¡¹ç›®å¼€å‘è€…å¦‚æœæŸä¸€ä¸ªæ¨¡å—ä¸æ˜¯æœ¬äººè´Ÿè´£çš„ï¼Œææ€•ä¹Ÿå¾ˆéš¾ææ¸…æ¥šæ¯ä¸€è¡Œä»£ç çš„å«ä¹‰ã€‚æ‰€ä»¥å¯¹äºMyBatisåŠå…¶ä»–æ¡†æ¶çš„æºç ä¸­ä¹Ÿæ˜¯ä¸€æ ·ï¼Œé¦–å…ˆåº”è¯¥ä»å¤§å±€å…¥æ‰‹ï¼ŒæŒæ¡æ•´ä½“æµç¨‹å’Œè®¾è®¡æ€æƒ³ï¼Œç„¶åå¦‚æœå¯¹æŸäº›å®ç°ç»†èŠ‚æ„Ÿå…´è¶£ï¼Œå†æ·±å…¥è¿›è¡Œäº†è§£ã€‚","tags":["MyBatis","æ¡†æ¶"],"categories":["æ¡†æ¶"]},{"title":"ç”¨â€œçŠ¶æ€æ¨¡å¼â€ä»£æ›¿if-else","path":"/2023/12/24/ç”¨â€œçŠ¶æ€æ¨¡å¼â€ä»£æ›¿if-else/","content":"ç®€ä»‹ çŠ¶æ€æ¨¡å¼æ˜¯è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼çš„ä¸€ç§ã€‚å…¶è®¾è®¡ç†å¿µæ˜¯å½“å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œéšä¹‹æ”¹å˜å…¶è¡Œä¸ºã€‚çŠ¶æ€å’Œè¡Œä¸ºä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ è¯¥æ¨¡å¼ä¸»è¦ç”¨äºï¼Œå¯¹è±¡çš„è¡Œä¸ºä¾èµ–äºå®ƒçš„çŠ¶æ€ï¼Œå¹¶ä¸”å…¶è¡Œä¸ºæ˜¯éšç€çŠ¶æ€çš„æ”¹å˜è€Œåˆ‡æ¢æ—¶ã€‚ çŠ¶æ€æ¨¡å¼UMLç±»å›¾ç±»å›¾è®²è§£ Stateï¼šæŠ½è±¡çŠ¶æ€æ¥å£ï¼ˆä¹Ÿå¯ä»¥å®šä¹‰æˆæŠ½è±¡ç±»ï¼‰ï¼Œè¯¥æ¥å£å°è£…äº†æ‰€æœ‰çŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºã€‚ConcreteStateA&#x2F;Bï¼šå…·ä½“çŠ¶æ€ç±»ï¼Œè¯¥ç±»å®ç°äº†æŠ½è±¡çŠ¶æ€æ¥å£ï¼Œä¼šæ ¹æ®è‡ªèº«å¯¹åº”çš„çŠ¶æ€æ¥å®ç°æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯æŒ‡æ˜å¦‚ä½•è¿‡æ¸¡åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚Contextï¼šç¯å¢ƒï¼ˆä¸Šä¸‹æ–‡ï¼‰è§’è‰²ï¼Œè¯¥ç±»è´Ÿè´£çŠ¶æ€çš„åˆ‡æ¢ï¼Œè¿˜æŒæœ‰ä¸€ä¸ªStateå®ä¾‹ï¼Œä»£è¡¨å½“å‰ç¯å¢ƒæ‰€å¤„çŠ¶æ€ã€‚ æ¡ˆä¾‹è®²è§£æ¡ˆä¾‹ï¼šé€šè¿‡çŠ¶æ€æ¨¡å¼æ¥å®ç°è‡ªåŠ©å”®å–æœºçš„åŠŸèƒ½ã€‚ çŠ¶æ€æ¥å£12345678public interface State &#123; // æŒ‘é€‰å•†å“ void choose(); // ä»˜æ¬¾ boolean payment(); // åˆ†å‘å•†å“ void dispenseCommodity();&#125; æŒ‘é€‰å•†å“çŠ¶æ€ç±»123456789101112131415161718192021222324252627282930public class ChooseGoods implements State &#123; VendingMachine machine; public ChooseGoods(VendingMachine machine) &#123; this.machine = machine; &#125; @Override public void choose() &#123; if (machine.getCount() &gt; 0) &#123; System.out.println(&quot;å•†å“æŒ‘é€‰æˆåŠŸï¼Œè¯·åŠæ—¶ä»˜æ¬¾ï¼&quot;); machine.setState(machine.getPaymentState()); &#125; else &#123; System.out.println(&quot;å¾ˆé—æ†¾ï¼Œå•†å“å”®ç½„äº†ï¼&quot;); machine.setState(machine.getEmptyState()); &#125; &#125; @Override public boolean payment() &#123; System.out.println(&quot;è¯·å…ˆæŒ‘é€‰å•†å“ï¼&quot;); return false; &#125; @Override public void dispenseCommodity() &#123; System.out.println(&quot;è¯·å…ˆæŒ‘é€‰å•†å“ï¼&quot;); &#125;&#125; ä»˜æ¬¾çŠ¶æ€ç±»12345678910111213141516171819202122232425262728293031public class PaymentState implements State &#123; VendingMachine machine; public PaymentState(VendingMachine machine) &#123; this.machine = machine; &#125; @Override public void choose() &#123; System.out.println(&quot;å•†å“å·²é€‰è´­å®Œæˆè¯·å‹¿é‡å¤æŒ‘é€‰&quot;); &#125; @Override public boolean payment() &#123; Random random = new Random(); int num = random.nextInt(10); if(num % 2 == 0)&#123; System.out.println(&quot;ä»˜æ¬¾æˆåŠŸï¼&quot;); machine.setState(machine.getDispenseCommodityState()); return true; &#125; System.out.println(&quot;ä»˜æ¬¾å¤±è´¥ï¼Œè¯·é‡æ–°æ”¯ä»˜ï¼&quot;); return false; &#125; @Override public void dispenseCommodity() &#123; System.out.println(&quot;è¯·å…ˆå®Œæˆæ”¯ä»˜ï¼&quot;); &#125;&#125; å•†å“å”®ç½„çŠ¶æ€ç±»123456789101112131415161718192021222324public class EmptyState implements State &#123; VendingMachine machine; public EmptyState(VendingMachine machine) &#123; this.machine = machine; &#125; @Override public void choose() &#123; System.out.println(&quot;å¯¹ä¸èµ·å•†å“å·²å”®ç½„ï¼&quot;); &#125; @Override public boolean payment() &#123; System.out.println(&quot;å¯¹ä¸èµ·å•†å“å·²å”®ç½„ï¼&quot;); return false; &#125; @Override public void dispenseCommodity() &#123; System.out.println(&quot;å¯¹ä¸èµ·å•†å“å·²å”®ç½„ï¼&quot;); &#125;&#125; åˆ†å‘å•†å“çŠ¶æ€ç±»12345678910111213141516171819202122232425public class DispenseCommodityState implements State &#123; VendingMachine machine; public DispenseCommodityState(VendingMachine machine) &#123; this.machine = machine; &#125; @Override public void choose() &#123; System.out.println(&quot;è¯·åŠæ—¶å–èµ°æ‚¨çš„å•†å“ï¼&quot;); &#125; @Override public boolean payment() &#123; System.out.println(&quot;è¯·åŠæ—¶å–èµ°æ‚¨çš„å•†å“ï¼&quot;); return false; &#125; @Override public void dispenseCommodity() &#123; System.out.println(&quot;è¯·åŠæ—¶å–èµ°æ‚¨çš„å•†å“ï¼&quot;); machine.setState(machine.getChooseGoods()); &#125;&#125; è‡ªåŠ¨å”®è´§æœº &#x3D;&gt; Contextè§’è‰²123456789101112131415161718192021222324252627282930313233public class VendingMachine &#123; // è¡¨ç¤ºå½“å‰çŠ¶æ€ private State state = null; // å•†å“æ•°é‡ private int count = 0; private State chooseGoods = new ChooseGoods(this); private State paymentState = new PaymentState(this); private State dispenseCommodityState = new DispenseCommodityState(this); private State emptyState = new EmptyState(this); public VendingMachine(int count) &#123; this.count = count; this.state = this.getChooseGoods(); &#125; // è´­ä¹°å•†å“ public void purchase() &#123; // æŒ‘é€‰å•†å“ state.choose(); // æ”¯ä»˜æˆåŠŸ if (state.payment()) &#123; // åˆ†å‘å•†å“ state.dispenseCommodity(); &#125; &#125; // è·å–å•†å“åå°†å•†å“å‡ä¸€ public int getCount() &#123; return count--; &#125; // getå’Œsetæ–¹æ³• ... &#125; å®¢æˆ·ç«¯æµ‹è¯•ç±»12345678910public class Client &#123; public static void main(String[] args) &#123; VendingMachine machine = new VendingMachine(1); for (int i = 1; i &lt; 4; i++) &#123; System.out.println(&quot;ç¬¬&quot; + i + &quot;æ¬¡è´­ä¹°ã€‚&quot;); machine.purchase(); &#125; &#125;&#125; æ‰§è¡Œç»“æœæ€»ç»“1ã€çŠ¶æ€æ¨¡å¼å°†æ¯ä¸ªçŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºå°è£…åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œå¤§å¤§æé«˜äº†ä»£ç çš„å¯è¯»æ€§ã€‚å¹¶ä¸”é€šè¿‡è¿™æ ·çš„è®¾è®¡è¿˜å¯ä»¥æ¶ˆé™¤å¤šä½™çš„if-elseè¯­å¥ï¼Œæ–¹ä¾¿ä»£ç çš„ç»´æŠ¤ã€‚ 2ã€çŠ¶æ€æ¨¡å¼ç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ï¼Œå®¹æ˜“å¢åŠ å’Œåˆ é™¤çŠ¶æ€ã€‚ 3ã€ä»»ä½•äº‹æƒ…éƒ½æœ‰åˆ©å¼Šï¼ŒçŠ¶æ€æ¨¡å¼ä¹Ÿä¸ä¾‹å¤–ã€‚å…¶æœ€æ˜¾è‘—çš„é—®é¢˜æ˜¯ï¼Œæ¯ä¸ªçŠ¶æ€éƒ½è¦å¯¹åº”ä¸€ä¸ªç±»ï¼Œå½“çŠ¶æ€è¿‡å¤šæ—¶ä¼šäº§ç”Ÿå¤§é‡çš„ç±»ï¼Œä»è€ŒåŠ å¤§ç»´æŠ¤æˆæœ¬ã€‚ 4ã€åº”ç”¨åœºæ™¯ï¼šå½“ä¸€ä¸ªéœ€æ±‚æœ‰å¾ˆå¤šçŠ¶æ€ï¼Œå¹¶ä¸”çŠ¶æ€ä¹‹é—´ä¼šè¿›è¡Œè½¬æ¢ï¼Œä¸åŒçŠ¶æ€è¿˜å¯¹åº”ä¸åŒçš„è¡Œä¸ºæ—¶å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨â€œçŠ¶æ€æ¨¡å¼â€ã€‚","tags":["è®¾è®¡æ¨¡å¼"],"categories":["è®¾è®¡æ¨¡å¼"]},{"title":"Google å¼€æºçš„ Guava å·¥å…·åº“","path":"/2023/12/24/Google-å¼€æºçš„-Guava-å·¥å…·åº“/","content":"ç›®å‰Google Guavaåœ¨å®é™…åº”ç”¨ä¸­éå¸¸å¹¿æ³›ï¼Œæœ¬ç¯‡åšå®¢å°†ä»¥åšä¸»å¯¹Guavaä½¿ç”¨çš„è®¤è¯†ä»¥åŠåœ¨é¡¹ç›®ä¸­çš„ç»éªŒæ¥ç»™å¤§å®¶åˆ†äº«ï¼æ­£å¦‚æ ‡é¢˜æ‰€è¨€ï¼Œå­¦ä¹ ä½¿ç”¨Google Guavaå¯ä»¥è®©ä½ å¿«ä¹ç¼–ç¨‹ï¼Œå†™å‡ºä¼˜é›…çš„JAVAä»£ç ï¼ ä»¥é¢å‘å¯¹è±¡æ€æƒ³å¤„ç†å­—ç¬¦ä¸²:Joiner&#x2F;Splitter&#x2F;CharMatcher JDKæä¾›çš„Stringè¿˜ä¸å¤Ÿå¥½ä¹ˆï¼Ÿ ä¹Ÿè®¸è¿˜ä¸å¤Ÿå‹å¥½ï¼Œè‡³å°‘è®©æˆ‘ä»¬ç”¨èµ·æ¥è¿˜ä¸å¤Ÿçˆ½ï¼Œè¿˜å¾—æ“å¿ƒï¼ ä¸¾ä¸ªæ —å­ï¼Œæ¯”å¦‚Stringæä¾›çš„splitæ–¹æ³•ï¼Œæˆ‘ä»¬å¾—å…³å¿ƒç©ºå­—ç¬¦ä¸²å§ï¼Œè¿˜å¾—è€ƒè™‘è¿”å›çš„ç»“æœä¸­å­˜åœ¨nullå…ƒç´ å§ï¼Œåªæä¾›äº†å‰åtrimçš„æ–¹æ³•ï¼ˆå¦‚æœæˆ‘æƒ³å¯¹ä¸­é—´å…ƒç´ è¿›è¡Œtrimå‘¢ï¼‰ã€‚ é‚£ä¹ˆï¼Œçœ‹ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ï¼Œguavaè®©ä½ ä¸å¿…åœ¨æ“å¿ƒè¿™äº›ï¼š 123456789101112131415// è¿æ¥å™¨private static final Joiner joiner = Joiner.on(&quot;,&quot;).skipNulls();// åˆ†å‰²å™¨private static final Splitter splitter = Splitter.on(&quot;,&quot;).trimResults().omitEmptyStrings();public static void main(String[] args) &#123; // æŠŠé›†åˆ/æ•°ç»„ä¸­çš„å…ƒç´  join åœ¨ä¸€èµ· String join = joiner.join(Lists.newArrayList(&quot;a&quot;, null, &quot;b&quot;)); System.out.println(&quot;join=&quot; + join); for(String tmp : splitter.split(&quot;a, ,b,,&quot;)) &#123; System.out.println(&quot;|&quot; + tmp + &quot;|&quot;); &#125;&#125; Joiner&#x2F;Splitter Joineræ˜¯è¿æ¥å™¨ï¼ŒSplitteræ˜¯åˆ†å‰²å™¨ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šæŠŠå®ƒä»¬å®šä¹‰ä¸ºstatic finalï¼Œåˆ©ç”¨onç”Ÿæˆå¯¹è±¡ååœ¨åº”ç”¨åˆ°Stringè¿›è¡Œå¤„ç†ï¼Œè¿™æ˜¯å¯ä»¥å¤ç”¨çš„ã€‚è¦çŸ¥é“apache commons StringUtilsæä¾›çš„éƒ½æ˜¯static methodã€‚ æ›´åŠ é‡è¦çš„æ˜¯ï¼Œguavaæä¾›çš„Joiner&#x2F;Splitteræ˜¯ç»è¿‡å……åˆ†æµ‹è¯•ï¼Œå®ƒçš„ç¨³å®šæ€§å’Œæ•ˆç‡è¦æ¯”apacheé«˜å‡ºä¸å°‘ï¼Œè¿™ä¸ªä½ å¯ä»¥è‡ªè¡Œæµ‹è¯•ä¸‹~ å‘ç°æ²¡æœ‰æˆ‘ä»¬æƒ³å¯¹Stringåšä»€ä¹ˆæ“ä½œï¼Œå°±æ˜¯ç”Ÿæˆè‡ªå·±å®šåˆ¶åŒ–çš„Joiner&#x2F;Splitterï¼Œå¤šä¹ˆç›´ç™½ï¼Œç®€å•ï¼Œæµç•…çš„APIï¼ å¯¹äºJoinerï¼Œå¸¸ç”¨çš„æ–¹æ³•æ˜¯ è·³è¿‡NULLå…ƒç´ ï¼šskipNulls() &#x2F; å¯¹äºNULLå…ƒç´ ä½¿ç”¨å…¶ä»–æ›¿ä»£ï¼šuseForNull(String) å¯¹äºSplitterï¼Œå¸¸ç”¨çš„æ–¹æ³•æ˜¯ï¼štrimResults()&#x2F;omitEmptyStrings()ã€‚æ³¨æ„æ‹†åˆ†çš„æ–¹å¼ï¼Œæœ‰å­—ç¬¦ä¸²ï¼Œè¿˜æœ‰æ­£åˆ™ï¼Œè¿˜æœ‰å›ºå®šé•¿åº¦åˆ†å‰²ï¼ˆå¤ªè´´å¿ƒäº†ï¼ï¼‰ å…¶å®é™¤äº†Joiner&#x2F;Splitterå¤–ï¼Œguavaè¿˜æä¾›äº†å­—ç¬¦ä¸²åŒ¹é…å™¨ï¼šCharMatcher 123456789101112private static final CharMatcher charMatcherDigit = CharMatcher.DIGIT;private static final Charmatcher charMatcherAny = CharMatcher.ANY;public static void main(String[] args) &#123; // åªä¿ç•™åŒ¹é…çš„å­—ç¬¦ï¼Œå…¶ä»–ç§»é™¤ System.out.println(charMatcherDigit.retainFrom(&quot;abc2def134f~&quot;)); // ç§»é™¤åŒ¹é…çš„å­—ç¬¦ System.out.println(charMatcherDigit.removeFrom(&quot;yes,i love you 1314&quot;)); System.out.println(charMatcherAny.inRange(&#x27;a&#x27;, &#x27;f&#x27;).or(charMatcherAny.is(&#x27;a&#x27;)).replaceFrom(&quot;abcdefg&quot;,&quot;*&quot;));&#125; CharMatcher CharMatcherï¼Œå°†å­—ç¬¦çš„åŒ¹é…å’Œå¤„ç†è§£è€¦ï¼Œå¹¶æä¾›ä¸°å¯Œçš„æ–¹æ³•ä¾›ä½ ä½¿ç”¨ï¼ å¯¹åŸºæœ¬ç±»å‹è¿›è¡Œæ”¯æŒ guavaå¯¹JDKæä¾›çš„åŸç”Ÿç±»å‹æ“ä½œè¿›è¡Œäº†æ‰©å±•ï¼Œä½¿å¾—åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼ 1234567891011121314151617// å¿«é€Ÿå®Œæˆåˆ°é›†åˆçš„è½¬æ¢List&lt;Integer&gt; list = Ints.asList(1, 3, 5, 7, 9);System.out.println(Ints.join(&quot;,&quot;, 1, 3, 1, 4));// åŸç”Ÿç±»å‹æ•°æ®å¿«é€Ÿåˆå¹¶int[] newIntArray = Ints.concat(new int[]&#123;1, 2&#125;, new int[]&#123;2, 3, 4&#125;);System.out.println(newIntArray.length);// æœ€å¤§/æœ€å°System.out.println(Ints.max(newIntArray) + &quot;,&quot; + Ints.min(newIntArray));// æ˜¯å¦åŒ…å«System.out.println(Ints.contains(newArray, 6));// é›†åˆåˆ°æ•°ç»„çš„è½¬æ¢int[] someArray = Ints.toArray(list); Ints guavaæä¾›äº† Bytes&#x2F;Shorts&#x2F;Ints&#x2F;Iongs&#x2F;Floats&#x2F;Doubles&#x2F;Chars&#x2F;Booleans è¿™äº›åŸºæœ¬æ•°æ®ç±»å‹çš„æ‰©å±•æ”¯æŒï¼Œåªæœ‰ä½ æƒ³ä¸åˆ°çš„ï¼Œæ²¡æœ‰å®ƒæ²¡æœ‰çš„ï¼ å¯¹JDKé›†åˆçš„æœ‰æ•ˆè¡¥å……ç°è‰²åœ°å¸¦:Multiset JDKçš„é›†åˆï¼Œæä¾›äº†æœ‰åºä¸”å¯ä»¥é‡å¤çš„Listï¼Œæ— åºä¸”ä¸å¯ä»¥é‡å¤çš„Setã€‚é‚£è¿™é‡Œå…¶å®å¯¹äºé›†åˆæ¶‰åŠåˆ°äº†2ä¸ªæ¦‚å¿µï¼Œä¸€ä¸ªorderï¼Œä¸€ä¸ªdupsã€‚é‚£ä¹ˆList vs Setï¼Œand then some ? Multiset Multisetæ˜¯ä»€ä¹ˆï¼Œæˆ‘æƒ³ä¸Šé¢çš„å›¾ï¼Œä½ åº”è¯¥äº†è§£å®ƒçš„æ¦‚å¿µäº†ã€‚Multisetå°±æ˜¯æ— åºçš„ï¼Œä½†æ˜¯å¯ä»¥é‡å¤çš„é›†åˆï¼Œå®ƒå°±æ˜¯æ¸¸ç¦»åœ¨List&#x2F;Setä¹‹é—´çš„â€œç°è‰²åœ°å¸¦â€ï¼ï¼ˆè‡³äºæœ‰åºçš„ï¼Œä¸å…è®¸é‡å¤çš„é›†åˆå˜›ï¼Œguavaè¿˜æ²¡æœ‰æä¾›ï¼Œå½“ç„¶åœ¨æœªæ¥åº”è¯¥ä¼šæä¾›UniqueListï¼Œæˆ‘çŒœçš„ï¼Œå“ˆå“ˆï¼‰ æ¥çœ‹ä¸€ä¸ªMultisetçš„ç¤ºä¾‹ï¼š 12345678910Multiset&lt;String&gt; multiset = HashMultiset.create();multiset.add(&quot;a&quot;);multiset.add(&quot;a&quot;);multiset.add(&quot;b&quot;);multiset.add(&quot;c&quot;);multiset.add(&quot;b&quot;);System.out.println(multiset.size());System.out.println(multiset.count(&quot;a&quot;)); Multiset Code Multisetè‡ªå¸¦ä¸€ä¸ªæœ‰ç”¨çš„åŠŸèƒ½ï¼Œå°±æ˜¯å¯ä»¥è·Ÿè¸ªæ¯ä¸ªå¯¹è±¡çš„æ•°é‡ã€‚ Immutable vs unmodifiableæ¥æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªunmodifiableçš„ä¾‹å­ï¼š 1234567891011121314// List çš„ä¸å¯å˜è®¾ç½®List&lt;String&gt; list = new ArrayList&lt;String&gt;();list.add(&quot;a&quot;);list.add(&quot;b&quot;);// è¿™ç§è§†å›¾ï¼Œä¸å¤Ÿå®‰å…¨ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å¿«ç…§ï¼Œæ€ä¹ˆèƒ½éšç€è€Œå˜åŒ–å‘¢ï¼ŸList&lt;String&gt; readOnlyList = Collections.unmodifiableList(list);// readOnlyList.add(&quot;c&quot;);// æŠ›å¼‚å¸¸ï¼šjava.lang.UnsupportedOperationExceptionlist.acc(&quot;c&quot;);System.out.println(reaOnlyList.size()); // 3 unmodifiable ä½ çœ‹åˆ°JDKæä¾›çš„unmodifiableçš„ç¼ºé™·äº†å—ï¼Ÿ å®é™…ä¸Šï¼ŒCollections.unmodifiableXxxæ‰€è¿”å›çš„é›†åˆå’Œæºé›†åˆæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œåªä¸è¿‡å¯ä»¥å¯¹é›†åˆåšå‡ºæ”¹å˜çš„APIéƒ½è¢«overrideï¼Œä¼šæŠ›å‡ºUnsupportedOperationExceptionã€‚ ä¹Ÿå³æ˜¯è¯´æˆ‘ä»¬æ”¹å˜æºé›†åˆï¼Œå¯¼è‡´ä¸å¯å˜è§†å›¾ï¼ˆunmodifiable Viewï¼‰ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œoh my god! å½“ç„¶ï¼Œåœ¨ä¸ä½¿ç”¨guavaçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯æ€ä¹ˆé¿å…ä¸Šé¢çš„é—®é¢˜çš„å‘¢ï¼Ÿ 1234567// List çš„ä¸å¯å˜æ€§è®¾ç½®List&lt;String&gt; list = new ArrayList&lt;~&gt;();list.add(&quot;a&quot;);list.add(&quot;b&quot;);// new Object ; CopyList&lt;String&gt; readOnList = Collections.unmodifiableList(new ArrayList&lt;String&gt;(list)); defensive copies ä¸Šé¢æ­ç¤ºäº†ä¸€ä¸ªæ¦‚å¿µï¼šDefensive Copiesï¼Œä¿æŠ¤æ€§æ‹·è´ã€‚ OKï¼Œunmodifiableçœ‹ä¸Šå»æ²¡æœ‰é—®é¢˜å‘¢ï¼Œä½†æ˜¯guavaä¾ç„¶è§‰å¾—å¯ä»¥æ”¹è¿›ï¼Œäºæ˜¯æå‡ºäº†Immutableçš„æ¦‚å¿µï¼Œæ¥çœ‹ï¼š 12345678910// guava æ˜¯å¦‚ä½•åšçš„å‘¢ï¼ŸList&lt;String&gt; immutable = ImmutabeList.of(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;);// immutable.add(&quot;d&quot;);// æŠ›å¼‚å¸¸ï¼šjava.lang.UnsupportedOperationExceptionList&lt;String&gt; immutable2 = ImmutableList.copyOf(list);list.add(&quot;d&quot;);// è§†å›¾ä¸éšç€æºè€Œæ”¹å˜ guava åªè¯»è®¾ç½®å®‰å…¨å¯é  ç®€å•æ˜“ç”¨System.out.println(&quot;list size:&quot; + list.size() + &quot; immutable2.size:&quot; + immutables.size()); Immutable å°±ä¸€ä¸ªcopyOfï¼Œä½ ä¸ä¼šå¿˜è®°ï¼Œå¦‚æ­¤cheap~ ç”¨Googleå®˜æ–¹çš„è¯´æ³•æ˜¯ï¼šweâ€™re using just one class,just say exactly what we meanï¼Œå¾ˆäº†ä¸èµ·å—ï¼ˆä¸ä»…ä»…æ˜¯ä¸ªæ¦‚å¿µï¼ŒImmutableåœ¨COPYé˜¶æ®µè¿˜è€ƒè™‘äº†çº¿ç¨‹çš„å¹¶å‘æ€§ç­‰ï¼Œå¾ˆæ™ºèƒ½çš„ï¼ï¼‰ï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~ guavaæä¾›äº†å¾ˆå¤šImmutableé›†åˆï¼Œæ¯”å¦‚ ImmutableList&#x2F;ImmutableSet&#x2F;ImmutableSortedSet&#x2F;ImmutableMap&#x2F;â€¦â€¦ çœ‹ä¸€ä¸ªImmutableMapçš„ä¾‹å­ï¼š 123ImmutableMap&lt;String, String&gt; immutableMap = ImmutableMap.of(&quot;name&quot;, &quot;hubert&quot;, &quot;sex&quot;, &quot;man&quot;);immutableMap.put(&quot;wife&quot;, &quot;no...&quot;); // UnsupportedOperationException ImmutableMap å¯ä¸å¯ä»¥ä¸€å¯¹å¤šï¼šMultimap JDKæä¾›ç»™æˆ‘ä»¬çš„Mapæ˜¯ä¸€ä¸ªé”®ï¼Œä¸€ä¸ªå€¼ï¼Œä¸€å¯¹ä¸€çš„ï¼Œé‚£ä¹ˆåœ¨å®é™…å¼€å‘ä¸­ï¼Œæ˜¾ç„¶å­˜åœ¨ä¸€ä¸ªKEYå¤šä¸ªVALUEçš„æƒ…å†µï¼ˆæ¯”å¦‚ä¸€ä¸ªåˆ†ç±»ä¸‹çš„ä¹¦æœ¬ï¼‰ï¼Œæˆ‘ä»¬å¾€å¾€è¿™æ ·è¡¨è¾¾ï¼šMap&lt;k,List&lt;v&gt;&gt;ï¼Œå¥½åƒæœ‰ç‚¹è‡ƒè‚¿ï¼è‡ƒè‚¿ä¹Ÿå°±ç®—äº†ï¼Œæ›´åŠ ä¸çˆ½çš„äº‹ï¼Œæˆ‘ä»¬è¿˜å¾—åˆ¤æ–­KEYæ˜¯å¦å­˜åœ¨æ¥å†³å®šæ˜¯å¦new ä¸€ä¸ªLISTå‡ºæ¥ï¼Œæœ‰ç‚¹éº»çƒ¦ï¼æ›´åŠ éº»çƒ¦çš„äº‹æƒ…è¿˜åœ¨åå¤´ï¼Œæ¯”å¦‚éå†ï¼Œæ¯”å¦‚åˆ é™¤ï¼Œso hardâ€¦â€¦ æ¥çœ‹guavaå¦‚ä½•æ›¿ä½ è§£å†³è¿™ä¸ªå¤§éº»çƒ¦çš„ï¼š 1234567Multimap&lt;String, String&gt; multiMap = ArrayListMultimap.create();multiMap.put(&quot;hubert&quot;, &quot;man&quot;);multiMap.put(&quot;hubert&quot;, &quot;yes&quot;);multiMap.put(&quot;lucy&quot;, &quot;woman&quot;);System.out.println(multiMap.get(&quot;hubert&quot;)); //collection Multimap å‹æƒ…æç¤ºä¸‹ï¼Œguavaæ‰€æœ‰çš„é›†åˆéƒ½æœ‰createæ–¹æ³•ï¼Œè¿™æ ·çš„å¥½å¤„åœ¨äºç®€å•ï¼Œè€Œä¸”æˆ‘ä»¬ä¸å¿…åœ¨é‡å¤æ³›å‹ä¿¡æ¯äº†ã€‚ get()&#x2F;keys()&#x2F;keySet()&#x2F;values()&#x2F;entries()&#x2F;asMap()éƒ½æ˜¯éå¸¸æœ‰ç”¨çš„è¿”å›view collectionçš„æ–¹æ³•ã€‚ Multimapçš„å®ç°ç±»æœ‰ï¼š ArrayListMultimap&#x2F;HashMultimap&#x2F;LinkedHashMultimap&#x2F;TreeMultimap&#x2F;ImmutableMultimap&#x2F;â€¦â€¦ å¯ä¸å¯ä»¥åŒå‘ï¼šBiMap JDKæä¾›çš„MAPè®©æˆ‘ä»¬å¯ä»¥find value by keyï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½é€šè¿‡find key by valueå‘¢ï¼Œèƒ½ä¸èƒ½KEYå’ŒVALUEéƒ½æ˜¯å”¯ä¸€çš„å‘¢ã€‚è¿™æ˜¯ä¸€ä¸ªåŒå‘çš„æ¦‚å¿µï¼Œå³forward+backwardã€‚ åœ¨å®é™…åœºæ™¯ä¸­æœ‰è¿™æ ·çš„éœ€æ±‚å—ï¼Ÿæ¯”å¦‚é€šè¿‡ç”¨æˆ·IDæ‰¾åˆ°mailï¼Œä¹Ÿéœ€è¦é€šè¿‡mailæ‰¾å›ç”¨æˆ·åã€‚æ²¡æœ‰guavaçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦create forward map AND create backward mapï¼Œand now just let guava do that for you. 12345678910111213BiMap&lt;String, String&gt; biMap = HashBiMap.create();biMap.put(&quot;name&quot;, &quot;hubert&quot;);// java.lang.IllegaArgumentException: value already present: hubert// value é‡å¤ä¼šæŠ¥é”™biMap.put(&quot;nick&quot;, &quot;hubert&quot;);// å¼ºåˆ¶è¦†ç›– name:hubertbiMap.forcePut(&quot;nick&quot;, &quot;hubert&quot;);biMap.put(&quot;123&quot;, &quot;hubertwongcn@163.com&quot;);System.out.println(biMap.inverse().get(&quot;hubertwongcn@163.com&quot;)); // 123 BiMap biMap &#x2F; biMap.inverse() &#x2F; biMap.inverse().inverse() å®ƒä»¬æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ ä½ å¯ä»¥ç¨å¾®çœ‹ä¸€ä¸‹BiMapçš„æºç å®ç°ï¼Œå®é™…ä¸Šï¼Œå½“ä½ åˆ›å»ºBiMapçš„æ—¶å€™ï¼Œåœ¨å†…éƒ¨ç»´æŠ¤äº†2ä¸ªmapï¼Œä¸€ä¸ªforward mapï¼Œä¸€ä¸ªbackward mapï¼Œå¹¶ä¸”è®¾ç½®äº†å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚ å› æ­¤ï¼ŒbiMap.inverse() !&#x3D; biMap ï¼›biMap.inverse().inverse() &#x3D;&#x3D; biMap å¯ä¸å¯ä»¥å¤šä¸ªKEYï¼šTable æˆ‘ä»¬çŸ¥é“æ•°æ®åº“é™¤äº†ä¸»é”®å¤–ï¼Œè¿˜æä¾›äº†å¤åˆç´¢å¼•ï¼Œè€Œä¸”å®é™…ä¸­è¿™æ ·çš„å¤šçº§å…³ç³»æŸ¥æ‰¾ä¹Ÿæ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åµŒå¥—çš„Mapæ¥å®ç°ï¼šMap&lt;k1,Map&lt;k2,v2&gt;&gt;ã€‚ä¸ºäº†è®©æˆ‘ä»¬çš„ä»£ç çœ‹èµ·æ¥ä¸é‚£ä¹ˆä¸‘é™‹ï¼Œguavaä¸ºæˆ‘ä»¬æä¾›äº†Tableã€‚ 1234567Table&lt;String, String, Integer&gt; table = HashBaseTable.create();table.put(&quot;å¼ ä¸‰&quot;, &quot;è®¡ç®—æœº&quot;, 80);table.put(&quot;å¼ ä¸‰&quot;, &quot;æ•°å­¦&quot;, 90);table.put(&quot;å¼ ä¸‰&quot;, &quot;è¯­æ–‡&quot;, 70);table.put(&quot;æå››&quot;, &quot;è®¡ç®—æœº&quot;, 70);table.put(&quot;æå››&quot;, &quot;æ•°å­¦&quot;, 60);table.put(&quot;æå››&quot;, &quot;è¯­æ–‡&quot;, 100); Table Tableæ¶‰åŠåˆ°3ä¸ªæ¦‚å¿µï¼šrowKey,columnKey,valueï¼Œå¹¶æä¾›äº†å¤šç§è§†å›¾ä»¥åŠæ“ä½œæ–¹æ³•è®©ä½ æ›´åŠ è½»æ¾çš„å¤„ç†å¤šä¸ªKEYçš„åœºæ™¯ã€‚ å‡½æ•°å¼ç¼–ç¨‹ï¼šFunctions12345678910111213141516171819202122List&lt;String&gt; list = Lists.newArrayList(&quot;hello world&quot;, &quot;yes&quot;, &quot;hubert&quot;);Function&lt;String, String&gt; f1 = new Function&lt;String, String&gt;() &#123; @Override public String apply(String s) &#123; return s.length() &lt;= 5 ? s : s.substring(0, 5); &#125;&#125;;Function&lt;String, String&gt; f2 = new Function&lt;String, String&gt;() &#123; @Override public String apply(String s) &#123; return s.toUpperCase(); &#125;&#125;;Function&lt;String, String&gt; f3 = Functions.compose(f1, f2);Collection&lt;String&gt; collection = Collections2.transform(list, f3);for(String s : collection) &#123; System.out.println(s);&#125; Functions ä¸Šé¢çš„ä»£ç æ˜¯ä¸ºäº†å®Œæˆå°†Listé›†åˆä¸­çš„å…ƒç´ ï¼Œå…ˆæˆªå–5ä¸ªé•¿åº¦ï¼Œç„¶åè½¬æˆå¤§å†™ã€‚ å‡½æ•°å¼ç¼–ç¨‹çš„å¥½å¤„åœ¨äºåœ¨é›†åˆéå†æ“ä½œä¸­æä¾›è‡ªå®šä¹‰Functionçš„æ“ä½œï¼Œæ¯”å¦‚transformè½¬æ¢ã€‚æˆ‘ä»¬å†ä¹Ÿä¸éœ€è¦ä¸€ééçš„éå†é›†åˆï¼Œæ˜¾è‘—çš„ç®€åŒ–äº†ä»£ç ï¼ 12345678910Iterables.transform(Iterable, Function);Iterators.transform(Iterator, Function);Collections2.transform(Collection, Function);Lists.transform(List, Function);Maps.transformValues(Map, Function);Multimaps.transformValues(Multimap, Function);Multimaps.transformValues(ListMultimap, Funtion);Tables.transformValues(Table, Function);Maps.transformEntries(Map, EntryTransformer);// ... å¯¹é›†åˆçš„transformæ“ä½œå¯ä»¥é€šè¿‡Functionå®Œæˆ æ–­è¨€ï¼šPredicate12345678910111213List&lt;String&gt; list = Lists.newArrayList(&quot;moom&quot;, &quot;dad&quot;, &quot;refer&quot;, &quot;yes&quot;);Collection&lt;String&gt; collection = Collections2.filter(list, new Predicate&lt;String&gt;)) &#123; @Override public boolean apply(String s) &#123; // ä¸šåŠ¡é€»è¾‘ return new StringBuilder(s).reverse().toString().equals(s); &#125;&#125;;for(String s : collection) &#123; System.out.println(s);&#125; Predicateæœ€å¸¸ç”¨çš„åŠŸèƒ½å°±æ˜¯è¿ç”¨åœ¨é›†åˆçš„è¿‡æ»¤å½“ä¸­ï¼ 12345678Iterables.filter(Iterable, Predicate);Iterators.filter(Iterator, Predicate);Collectios2.filter(Collection, Predicate);Sets.filter(Set, Predicate);Sets.filter(SortedSet, Predicate);Maps.filterKeys(Map, Predicate);Multimaps.filterKeys(Multimap, Predicate);// ... filter éœ€è¦æ³¨æ„çš„æ˜¯Listså¹¶æ²¡æœ‰æä¾›filteræ–¹æ³•ï¼Œä¸è¿‡ä½ å¯ä»¥ä½¿ç”¨Collections2.filterå®Œæˆï¼ check null and otherï¼šOptionalã€Preconditionsåœ¨guavaä¸­ï¼Œå¯¹äºnullçš„å¤„ç†æ‰‹æ®µæ˜¯å¿«é€Ÿå¤±è´¥ï¼Œä½ å¯ä»¥çœ‹çœ‹guavaçš„æºç ï¼Œå¾ˆå¤šæ–¹æ³•çš„ç¬¬ä¸€è¡Œå°±æ˜¯ï¼šPreconditions.checkNotNull(elements); è¦çŸ¥é“nullæ˜¯æ¨¡ç³Šçš„æ¦‚å¿µï¼Œæ˜¯æˆåŠŸå‘¢ï¼Œè¿˜æ˜¯å¤±è´¥å‘¢ï¼Œè¿˜æ˜¯åˆ«çš„ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿ 12345678910111213public static void test(String name, int age, Map&lt;String, String&gt; extInfo) &#123; Preconditions.checkNotNull(name, &quot;name must be given!&quot;); Preconditions.checkArgument(age &gt;= 18, &quot;the game you can not play it, your age is under 18!&quot;); Map&lt;String, String&gt; defaulExtInfo = Maps.newHashMap(); defaultExtInfo.put(&quot;sex&quot;, &quot;man&quot;); extInfo = Optional.fromNullable(extInfo).or(defaultExtInfo); for(Map.Entry&lt;String, Stirng&gt; entry : extInfo.entrySet())) &#123; System.out.println(entry.getKey() + &quot;:&quot; + entry.getValue()); &#125;&#125; Preconditions&#x2F;Optional Cache is king å¯¹äºå¤§å¤šæ•°äº’è”ç½‘é¡¹ç›®è€Œè¨€ï¼Œç¼“å­˜çš„é‡è¦æ€§ï¼Œä¸è¨€è€Œå–»ï¼ å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ç³»ç»Ÿï¼Œå¹¶ä¸æƒ³ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹ç¼“å­˜ç»„ä»¶ï¼ˆå¦‚redisï¼‰ï¼Œæˆ‘ä»¬ä»…ä»…æƒ³åœ¨æœ¬åœ°æœ‰ä¸€ä¸ªåŠŸèƒ½è¶³å¤Ÿå¼ºå¤§çš„ç¼“å­˜ï¼Œå¾ˆå¯æƒœJDKæä¾›çš„é‚£äº›SET&#x2F;MAPè¿˜ä¸è¡Œï¼ 12345678910111213141516171819202122232425// å®šä¹‰ç¼“å­˜çš„å®ç°private static final CacheLoader&lt;Long, User&gt; userCacheLoader = new CacheLoader&lt;Long, User&gt;() &#123; @Override public User load(Long along) throws Exception &#123; // æ¨¡æ‹Ÿä»æ•°æ®åº“/Redis/ç¼“å­˜ä¸­åŠ è½½æ•°æ® User user = new User(); user.setId(along); user.setName(Thread.currentThread().getName() + &quot;-&quot; new SimpleDateFormat(&quot;yyyy-MM-dd hh:mm:ss&quot;).format(new Date()) + &quot;-&quot; + along); System.out.println(&quot;load:&quot; + user); return user; &#125;&#125;;// å®šä¹‰ç¼“å­˜çš„ç­–ç•¥ï¼Œæä¾›å¯¹å¤–è®¿é—®ç¼“å­˜private static final LoadingCache&lt;Long, User&gt; userCacheData = CacheBuilder.newBuilder() .expireAfterAccess(2, TimeUnit.SECONDS) .expireAfterWrite(2, TimeUnit.SECONDS) .refreshAfterWrite(3, TimeUnit.SECONS) .maximumSize(10000L) .bulid(userCacheLoader); CacheLoader é¦–å…ˆï¼Œè¿™æ˜¯ä¸€ä¸ªæœ¬åœ°ç¼“å­˜ï¼Œguavaæä¾›çš„cacheæ˜¯ä¸€ä¸ªç®€æ´ã€é«˜æ•ˆï¼Œæ˜“äºç»´æŠ¤çš„ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿå› ä¸ºå¹¶æ²¡æœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ç”¨äºåˆ·æ–° OR æ¸…ç†cacheï¼Œå¯¹äºcacheçš„æ“ä½œï¼Œéƒ½æ˜¯é€šè¿‡è®¿é—®&#x2F;è¯»å†™å¸¦æ¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¯»å†™ä¸­å®Œæˆç¼“å­˜çš„åˆ·æ–°æ“ä½œï¼ å…¶æ¬¡ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ï¼Œæˆ‘ä»¬éå¸¸é€šä¿—çš„å‘Šè¯‰cacheï¼Œæˆ‘ä»¬çš„ç¼“å­˜ç­–ç•¥æ˜¯ä»€ä¹ˆï¼ŒSO EASYï¼åœ¨å¦‚æ­¤ç®€å•çš„èƒŒåï¼Œæ˜¯guavaå¸®åŠ©æˆ‘ä»¬åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚çº¿ç¨‹å®‰å…¨ã€‚ è®©å¼‚æ­¥å›è°ƒæ›´åŠ ç®€å• JDKä¸­æä¾›äº†Future&#x2F;FutureTask&#x2F;Callableæ¥å¯¹å¼‚æ­¥å›è°ƒè¿›è¡Œæ”¯æŒï¼Œä½†æ˜¯è¿˜æ˜¯çœ‹ä¸Šå»æŒºå¤æ‚çš„ï¼Œèƒ½ä¸èƒ½æ›´åŠ ç®€å•å‘¢ï¼Ÿæ¯”å¦‚æ³¨å†Œä¸€ä¸ªç›‘å¬å›è°ƒã€‚ 12345678910111213141516171819202122232425262728// JDK æ‰€æä¾›çš„çº¿ç¨‹æ± ExecutorService es = Executors.newFixedThreadPool(3);// ç»è¿‡guavaå°è£…çš„å¸¦æœ‰ç›‘å¬å›è°ƒåŠŸèƒ½çš„çº¿ç¨‹æ± ListeningExecutorService listeningExecutorService = MoreExecutors.listeningDecorator(es);ListenableFuture listenableFuture = listeningExecutorService.submit(new Callable&lt;Integer&gt;() &#123; @Override public Integer call() throws Exception &#123; if (new Random().nextInt(3) == 2) &#123; throw new NullPointerException(); &#125; return 1; &#125;&#125;);FutureCallback futureCallback = new FutureCallback&lt;Integer&gt; &#123; @Override public void onSuccess(final Integer o) &#123; System.out.println(&quot;------&quot; + o); &#125; @Override public void onFailure(final Throwable throwable) &#123; System.out.println(&quot;======&quot; + throwable.getMessage()); &#125;&#125;;Futures.addCallback(listenableFuture, futureCallback); å¼‚æ­¥å›è°ƒ æˆ‘ä»¬å¯ä»¥é€šè¿‡guavaå¯¹JDKæä¾›çš„çº¿ç¨‹æ± è¿›è¡Œè£…é¥°ï¼Œè®©å…¶å…·æœ‰å¼‚æ­¥å›è°ƒç›‘å¬åŠŸèƒ½ï¼Œç„¶ååœ¨è®¾ç½®ç›‘å¬å™¨å³å¯ï¼ Summaryåˆ°è¿™é‡Œï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿåªä»‹ç»äº†guavaçš„å†°å±±ä¸€è§’ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šå†…å®¹ï¼š guava package æ¯”å¦‚åå°„ã€æ³¨è§£ã€ç½‘ç»œã€å¹¶å‘ã€IOç­‰ç­‰","tags":["å·¥å…·","å¼€æº","Google"],"categories":["å·¥å…·"]}]